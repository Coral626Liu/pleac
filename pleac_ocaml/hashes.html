<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN""http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>Hashes</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="PLEAC-Objective CAML "
HREF="index.html"><LINK
REL="PREVIOUS"
TITLE="Arrays"
HREF="arrays.html"><LINK
REL="NEXT"
TITLE="Pattern Matching"
HREF="patternmatching.html"><style type="text/css">td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
pre { line-height: 125%; }

  </style></head
><BODY TEXT="#cecece" BGCOLOR="#4f6f6f" LINK="#f5deb3" VLINK="#d5ae83"
CLASS="SECT1"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>PLEAC-Objective CAML </TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="arrays.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
></TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="patternmatching.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="HASHES"
>5. Hashes</A
></H1
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN232"
>Introduction</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(*-----------------------------*)</span>
<span class="c">(* build an hash table element by element *)</span>
<span class="k">let</span> <span class="n">age</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">3</span> <span class="o">;;</span>  <span class="c">(* 3 is the supposed average size for the</span>
<span class="c">                                  hash table *)</span>
<span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">age</span> <span class="s2">&quot;Nat&quot;</span> <span class="mi">24</span> <span class="o">;</span>
<span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">age</span> <span class="s2">&quot;Jules&quot;</span> <span class="mi">25</span> <span class="o">;</span>
<span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">age</span> <span class="s2">&quot;Josh&quot;</span> <span class="mi">17</span> <span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="n">assoc_list2hashtbl</span> <span class="n">assoc_list</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">h</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">k</span><span class="o">,</span><span class="n">v</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">h</span> <span class="n">k</span> <span class="n">v</span><span class="o">)</span> <span class="n">assoc_list</span> <span class="o">;</span>
  <span class="n">h</span>

<span class="k">let</span> <span class="n">food_color</span> <span class="o">=</span> <span class="n">assoc_list2hashtbl</span>
    <span class="o">[</span> <span class="s2">&quot;Apple&quot;</span><span class="o">,</span> <span class="s2">&quot;red&quot;</span> <span class="o">;</span>
      <span class="s2">&quot;Banana&quot;</span><span class="o">,</span> <span class="s2">&quot;yellow&quot;</span> <span class="o">;</span>
      <span class="s2">&quot;Lemon&quot;</span><span class="o">,</span> <span class="s2">&quot;yellow&quot;</span> <span class="o">;</span>
      <span class="s2">&quot;Carrot&quot;</span><span class="o">,</span> <span class="s2">&quot;orange&quot;</span> <span class="o">;</span>
    <span class="o">]</span> <span class="o">;;</span>
<span class="c">(*-----------------------------*)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN235"
>Adding an Element to a Hash</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(*-----------------------------*)</span>
<span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">tbl</span> <span class="n">key</span> <span class="k">value</span> <span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="c">(* food_color defined per the introduction *)</span>
<span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">food_color</span> <span class="s2">&quot;Raspberry&quot;</span> <span class="s2">&quot;pink&quot;</span> <span class="o">;;</span>


<span class="k">let</span> <span class="n">hashtbl_keys</span> <span class="n">h</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">fold</span> <span class="o">(</span><span class="k">fun</span> <span class="n">key</span> <span class="o">_</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">key</span> <span class="o">::</span> <span class="n">l</span><span class="o">)</span> <span class="n">h</span> <span class="bp">[]</span>
<span class="k">let</span> <span class="n">hashtbl_values</span> <span class="n">h</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">fold</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="k">value</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="k">value</span> <span class="o">::</span> <span class="n">l</span><span class="o">)</span> <span class="n">h</span> <span class="bp">[]</span>
<span class="k">let</span> <span class="n">hashtbl2assoc_list</span> <span class="n">h</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">fold</span> <span class="o">(</span><span class="k">fun</span> <span class="n">key</span> <span class="k">value</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="k">value</span><span class="o">)</span> <span class="o">::</span> <span class="n">l</span><span class="o">)</span> <span class="n">h</span> <span class="bp">[]</span>
<span class="o">;;</span>
<span class="n">print_string</span> <span class="s2">&quot;Known_foods:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">;</span>
<span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">food</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">print_endline</span> <span class="n">food</span><span class="o">)</span> <span class="n">food_color</span> <span class="o">;</span>
<span class="n">print_string</span> <span class="s2">&quot;Known_foods:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">;</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="n">print_endline</span> <span class="o">(</span><span class="n">hashtbl_keys</span> <span class="n">food_color</span><span class="o">)</span> <span class="o">;;</span>
<span class="c">(*</span>
<span class="c">&gt; Known_foods:</span>
<span class="c">&gt; Banana</span>
<span class="c">&gt; Raspberry</span>
<span class="c">&gt; Apple</span>
<span class="c">&gt; Carrot</span>
<span class="c">&gt; Lemon</span>
<span class="c">*)</span>
<span class="c">(*-----------------------------*)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN238"
>Testing for the Presence of a Key in a Hash</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(*-----------------------------*)</span>
<span class="c">(* does %HASH have a value for $KEY ?  *)</span>
<span class="k">if</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">mem</span> <span class="n">hash</span> <span class="n">key</span><span class="o">)</span> <span class="k">then</span>
  <span class="c">(* it exists *)</span>
<span class="k">else</span>
  <span class="c">(* id doesn&#39;t exists *)</span>
 <span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="c">(* food_color defined per the introduction *)</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">name</span> <span class="o">-&gt;</span>
  <span class="k">let</span> <span class="n">kind</span> <span class="o">=</span> <span class="k">if</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">mem</span> <span class="n">food_color</span> <span class="n">name</span> <span class="k">then</span> <span class="s2">&quot;food&quot;</span> <span class="k">else</span> <span class="s2">&quot;drink&quot;</span> <span class="k">in</span>
  <span class="n">printf</span> <span class="s2">&quot;%s is a %s.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">name</span> <span class="n">kind</span>
<span class="o">)</span> <span class="o">[</span><span class="s2">&quot;Banana&quot;</span><span class="o">;</span> <span class="s2">&quot;Martini&quot;</span><span class="o">]</span> <span class="o">;;</span>
<span class="c">(*</span>
<span class="c">&gt; Banana is a food.</span>
<span class="c">&gt; Martini is a drink.</span>
<span class="c">*)</span>
<span class="c">(*-----------------------------*)</span>
<span class="c">(* there&#39;s no such thing called &quot;undef&quot;, &quot;nil&quot; or &quot;null&quot; in Caml</span>
<span class="c">   if you really want such a value, use type &quot;option&quot; as shown below *)</span>
<span class="k">let</span> <span class="n">age</span> <span class="o">=</span> <span class="n">assoc_list2hashtbl</span>
    <span class="o">[</span> <span class="s2">&quot;Toddler&quot;</span><span class="o">,</span> <span class="mi">3</span> <span class="o">;</span> <span class="s2">&quot;Unborn&quot;</span><span class="o">,</span> <span class="mi">0</span> <span class="o">]</span> <span class="o">;;</span>
<span class="c">(*&gt; val age : (string, int) Hashtbl.t = &lt;abstr&gt; *)</span>

<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">thing</span> <span class="o">-&gt;</span>
  <span class="n">printf</span> <span class="s2">&quot;%s: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">thing</span>
    <span class="o">(</span><span class="k">try</span> <span class="k">match</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">age</span> <span class="n">thing</span> <span class="k">with</span>
    <span class="o">|</span> <span class="mi">0</span> <span class="o">-&gt;</span> <span class="s2">&quot;Exists&quot;</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="s2">&quot;Exists NonNull&quot;</span>
    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="s2">&quot;&quot;</span><span class="o">)</span>
<span class="o">)</span> <span class="o">[</span><span class="s2">&quot;Toddler&quot;</span> <span class="o">;</span> <span class="s2">&quot;Unborn&quot;</span> <span class="o">;</span> <span class="s2">&quot;Phantasm&quot;</span> <span class="o">;</span> <span class="s2">&quot;Relic&quot;</span> <span class="o">]</span>

<span class="k">let</span> <span class="n">age</span> <span class="o">=</span> <span class="n">assoc_list2hashtbl</span>
    <span class="o">[</span> <span class="s2">&quot;Toddler&quot;</span><span class="o">,</span> <span class="nc">Some</span> <span class="mi">3</span> <span class="o">;</span> <span class="s2">&quot;Unborn&quot;</span><span class="o">,</span> <span class="nc">Some</span> <span class="mi">0</span> <span class="o">;</span> <span class="s2">&quot;Phantasm&quot;</span><span class="o">,</span> <span class="nc">None</span> <span class="o">]</span> <span class="o">;;</span>
<span class="c">(*&gt; val age : (string, int option) Hashtbl.t = &lt;abstr&gt; *)</span>

<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">thing</span> <span class="o">-&gt;</span>
  <span class="n">printf</span> <span class="s2">&quot;%s: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">thing</span>
    <span class="o">(</span><span class="k">try</span> <span class="k">match</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">age</span> <span class="n">thing</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="s2">&quot;Exists&quot;</span>
    <span class="o">|</span> <span class="nc">Some</span> <span class="mi">0</span> <span class="o">-&gt;</span> <span class="s2">&quot;Exists Defined&quot;</span>
    <span class="o">|</span> <span class="nc">Some</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="s2">&quot;Exists Defined NonNull&quot;</span>
    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="s2">&quot;&quot;</span><span class="o">)</span>
<span class="o">)</span> <span class="o">[</span><span class="s2">&quot;Toddler&quot;</span> <span class="o">;</span> <span class="s2">&quot;Unborn&quot;</span> <span class="o">;</span> <span class="s2">&quot;Phantasm&quot;</span> <span class="o">;</span> <span class="s2">&quot;Relic&quot;</span> <span class="o">]</span>
<span class="c">(*</span>
<span class="c">&gt; Toddler: Exists Defined NonNull</span>
<span class="c">&gt; Unborn: Exists Defined</span>
<span class="c">&gt; Phantasm: Exists</span>
<span class="c">&gt; Relic:</span>
<span class="c">*)</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="n">size</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">20</span> <span class="k">in</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">f</span> <span class="o">-&gt;</span>
  <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">mem</span> <span class="n">size</span> <span class="n">f</span><span class="o">)</span> <span class="k">then</span>
    <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">size</span> <span class="n">f</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">stat</span> <span class="n">f</span><span class="o">).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">st_size</span><span class="o">;</span>
<span class="o">)</span> <span class="o">(</span><span class="n">readlines</span> <span class="n">stdin</span><span class="o">);</span>
<span class="c">(*-----------------------------*)</span>
<span class="c">(* here is a more complete solution which does stat 2 times the same file (to</span>
<span class="c">be mimic perl&#39;s version) *)</span>
<span class="k">let</span> <span class="n">size</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">20</span> <span class="k">in</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">f</span> <span class="o">-&gt;</span>
  <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">mem</span> <span class="n">size</span> <span class="n">f</span><span class="o">)</span> <span class="k">then</span>
    <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">size</span> <span class="n">f</span> <span class="o">(</span><span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">stat</span> <span class="n">f</span><span class="o">).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">st_size</span> <span class="k">with</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nc">None</span><span class="o">)</span>
<span class="o">)</span> <span class="o">(</span><span class="n">readlines</span> <span class="n">stdin</span><span class="o">);</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN241"
>Deleting from a Hash</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(*-----------------------------*)</span>
<span class="c">(* remove $KEY and its value from %HASH *)</span>
<span class="nn">Hashtbl</span><span class="p">.</span><span class="n">remove</span> <span class="n">hash</span> <span class="n">key</span> <span class="o">;</span>
<span class="c">(*-----------------------------*)</span>
<span class="c">(* food_color as per Introduction *)</span>
<span class="k">open</span> <span class="nc">Printf</span>

<span class="k">let</span> <span class="n">print_foods</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">printf</span> <span class="s2">&quot;Keys: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot; &quot;</span> <span class="o">(</span><span class="n">hashtbl_keys</span> <span class="n">food_color</span><span class="o">))</span> <span class="o">;</span>
  <span class="n">printf</span> <span class="s2">&quot;Values: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot; &quot;</span> <span class="o">(</span><span class="n">hashtbl_values</span> <span class="n">food_color</span><span class="o">))</span>
<span class="o">;;</span>
<span class="n">print_string</span> <span class="s2">&quot;Initially:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
<span class="n">print_foods</span> <span class="bp">()</span><span class="o">;</span>

<span class="n">print_string</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">With Banana deleted</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
<span class="nn">Hashtbl</span><span class="p">.</span><span class="n">remove</span> <span class="n">food_color</span> <span class="s2">&quot;Banana&quot;</span><span class="o">;</span>
<span class="n">print_foods</span> <span class="bp">()</span>
<span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="nn">Hashtbl</span><span class="p">.</span><span class="n">clear</span> <span class="n">food_color</span> <span class="o">;;</span>
<span class="c">(*-----------------------------*)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN244"
>Traversing a Hash</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(*-----------------------------*)</span>
<span class="c">(* in this section consider opened the Printf module using: *)</span>
<span class="k">open</span> <span class="nc">Printf</span><span class="o">;;</span>

<span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">key</span> <span class="k">value</span> <span class="o">-&gt;</span>
    <span class="c">(*</span>
<span class="c">      do something with key and value</span>
<span class="c">    *)</span>
  <span class="o">)</span>
  <span class="n">hash</span>
<span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">key</span> <span class="o">-&gt;</span>
  <span class="k">let</span> <span class="k">value</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">hash</span> <span class="n">key</span> <span class="k">in</span>
    <span class="c">(*</span>
<span class="c">      do something with key and value</span>
<span class="c">    *)</span>
<span class="o">)</span> <span class="o">(</span><span class="n">hashtbl_keys</span> <span class="n">hash</span><span class="o">)</span>
<span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="c">(* food_color as defined in the introduction *)</span>
<span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="n">printf</span> <span class="s2">&quot;%s is %s.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span> <span class="n">food_color</span><span class="o">;</span>
<span class="c">(*</span>
<span class="c">&gt; Lemon is yellow.</span>
<span class="c">&gt; Apple is red.</span>
<span class="c">&gt; Carrot is orange.</span>
<span class="c">&gt; Banana is yellow.</span>
<span class="c">*)</span>
<span class="c">(* but beware of: *)</span>
<span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="n">printf</span> <span class="s2">&quot;food_color: %s is %s.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span> <span class="n">food_color</span><span class="o">;</span>
<span class="c">(*</span>
<span class="c">&gt; food_color: Lemon is yellow.</span>
<span class="c">&gt; Apple is red.</span>
<span class="c">&gt; Carrot is orange.</span>
<span class="c">&gt; Banana is yellow.</span>
<span class="c">*)</span>
<span class="c">(* write this instead:</span>
<span class="c">  (more on it at http://caml.inria.fr/ocaml/htmlman/manual055.html) *)</span>
<span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">k</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">printf</span> <span class="s2">&quot;food_color: %s is %s.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">k</span> <span class="n">v</span><span class="o">)</span> <span class="n">food_color</span><span class="o">;</span>
<span class="c">(*</span>
<span class="c">&gt; food_color: Lemon is yellow.</span>
<span class="c">&gt; food_color: Apple is red.</span>
<span class="c">&gt; food_color: Carrot is orange.</span>
<span class="c">&gt; food_color: Banana is yellow.</span>
<span class="c">*)</span>

<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">key</span> <span class="o">-&gt;</span>
  <span class="k">let</span> <span class="k">value</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">food_color</span> <span class="n">key</span> <span class="k">in</span>
  <span class="n">printf</span> <span class="s2">&quot;%s is %s.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">key</span> <span class="k">value</span>
<span class="o">)</span> <span class="o">(</span><span class="n">hashtbl_keys</span> <span class="n">food_color</span><span class="o">)</span> <span class="o">;</span>
<span class="c">(*</span>
<span class="c">&gt; Lemon is yellow.</span>
<span class="c">&gt; Apple is red.</span>
<span class="c">&gt; Carrot is orange.</span>
<span class="c">&gt; Banana is yellow.</span>
<span class="c">*)</span>

<span class="c">(*-----------------------------*)</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">key</span> <span class="o">-&gt;</span>
    <span class="n">printf</span> <span class="s2">&quot;%s is %s.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">key</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">food_color</span> <span class="n">key</span><span class="o">)</span>
  <span class="o">)</span>
  <span class="o">(</span><span class="n">sort_</span> <span class="o">(</span><span class="n">hashtbl_keys</span> <span class="n">food_color</span><span class="o">))</span>
<span class="o">;;</span>

<span class="c">(*</span>
<span class="c">&gt; Apple is red.</span>
<span class="c">&gt; Banana is yellow.</span>
<span class="c">&gt; Carrot is orange.</span>
<span class="c">&gt; Lemon is yellow.</span>
<span class="c">*)</span>

<span class="c">(*-----------------------------*)</span>
<span class="c">(* Ocaml is safe in loop, so you can&#39;t reset the hash iterator as in</span>
<span class="c">Perl and you don&#39;t risk infinite loops using, say, List.iter or</span>
<span class="c">Hashtbl.iter, but if you really want to infinite loop on the first key</span>
<span class="c">you get ... *)</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">key</span> <span class="o">-&gt;</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="n">printf</span> <span class="s2">&quot;Processing %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">key</span>
    <span class="k">done</span>
  <span class="o">)</span>
  <span class="o">(</span><span class="n">hashtbl_keys</span> <span class="n">food_color</span><span class="o">)</span>
<span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="c">(* countfrom - count number of messages from each sender *)</span>
<span class="k">let</span> <span class="n">main</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">file</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">files</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
    <span class="nn">Arg</span><span class="p">.</span><span class="n">parse</span> <span class="bp">[]</span> <span class="o">(</span><span class="k">fun</span> <span class="n">file</span> <span class="o">-&gt;</span> <span class="n">files</span> <span class="o">:=</span> <span class="o">!</span><span class="n">files</span> <span class="o">@</span> <span class="o">[</span><span class="n">file</span><span class="o">])</span> <span class="s2">&quot;&quot;</span><span class="o">;</span>
    <span class="k">try</span>
      <span class="n">open_in</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">hd</span> <span class="o">!</span><span class="n">files</span><span class="o">)</span>
    <span class="k">with</span> <span class="nc">Failure</span> <span class="s2">&quot;hd&quot;</span> <span class="o">-&gt;</span> <span class="n">stdin</span>
  <span class="k">in</span>
  <span class="k">let</span> <span class="n">from</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">50</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">add_from</span> <span class="n">address</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">old_count</span> <span class="o">=</span>
      <span class="k">try</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">from</span> <span class="n">address</span>
      <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="mi">0</span>
    <span class="k">in</span>
    <span class="k">let</span> <span class="n">new_count</span> <span class="o">=</span> <span class="n">old_count</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">in</span>
    <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">from</span> <span class="n">address</span> <span class="n">new_count</span><span class="o">;</span>
  <span class="k">in</span>
  <span class="k">let</span> <span class="n">extractfrom</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;^From: </span><span class="err">\</span><span class="s2">(.*</span><span class="err">\</span><span class="s2">)&quot;</span> <span class="k">in</span>

  <span class="n">iter_lines</span> <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span>
    <span class="k">if</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">extractfrom</span> <span class="n">line</span> <span class="mi">0</span><span class="o">)</span> <span class="k">then</span>
      <span class="n">add_from</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">1</span> <span class="n">line</span><span class="o">)</span>
    <span class="k">else</span> <span class="bp">()</span>
  <span class="o">)</span> <span class="n">file</span><span class="o">;</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="n">printf</span> <span class="s2">&quot;%s: %d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span> <span class="n">from</span>
<span class="o">;;</span>
<span class="n">main</span><span class="bp">()</span> <span class="o">;</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN247"
>Printing a Hash</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(*-----------------------------*)</span>
<span class="c">(* note that OCaml does not have a native polymorphic print function, so</span>
<span class="c">examples in this section work for hashes that map string keys to string</span>
<span class="c">values *)</span>
<span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="n">printf</span> <span class="s2">&quot;%s =&gt; %s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span> <span class="n">hash</span> <span class="o">;</span>
<span class="c">(*-----------------------------*)</span>

<span class="c">(* map in ocaml maps a function on a list, rather that evaluate an</span>
<span class="c">expression in turn on a list as Perl does *)</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">key</span> <span class="o">-&gt;</span>
    <span class="n">printf</span> <span class="s2">&quot;%s =&gt; %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">key</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">hash</span> <span class="n">key</span><span class="o">)</span>
  <span class="o">)</span>
  <span class="o">(</span><span class="n">hashtbl_keys</span> <span class="n">hash</span><span class="o">)</span> <span class="o">;</span>
<span class="c">(*-----------------------------*)</span>

<span class="c">(* build a list from an hash table, note that this is possibile only if</span>
<span class="c">the type of key and value are the same *)</span>
<span class="k">let</span> <span class="n">hashtbl2list</span> <span class="n">hash</span> <span class="o">=</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">fold</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">key</span> <span class="k">value</span> <span class="n">init</span> <span class="o">-&gt;</span> <span class="n">key</span> <span class="o">::</span> <span class="k">value</span> <span class="o">::</span> <span class="n">init</span><span class="o">)</span>
    <span class="n">hash</span>
    <span class="bp">[]</span>
<span class="o">;;</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="n">printf</span> <span class="s2">&quot;%s &quot;</span><span class="o">)</span> <span class="o">(</span><span class="n">hashtbl2list</span> <span class="n">hash</span><span class="o">)</span> <span class="o">;</span>
<span class="c">(* or *)</span>
<span class="n">print_endline</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot; &quot;</span> <span class="o">(</span><span class="n">hashtbl2list</span> <span class="n">hash</span><span class="o">))</span> <span class="o">;</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN250"
>Retrieving from a Hash in Insertion Order</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(*-----------------------------*)</span>
<span class="c">(* In OCaml one usually use association lists which really is a list of</span>
<span class="c">(key,value). Note that insertion and lookup is O(n) (!!!) *)</span>

<span class="c">(* initialization *)</span>
<span class="k">let</span> <span class="n">empty_food_color</span> <span class="o">=</span> <span class="bp">[]</span>
<span class="k">let</span> <span class="n">food_color</span> <span class="o">=</span>
    <span class="o">[</span> <span class="s2">&quot;Banana&quot;</span><span class="o">,</span> <span class="s2">&quot;Yellow&quot;</span> <span class="o">;</span>
      <span class="s2">&quot;Apple&quot;</span><span class="o">,</span> <span class="s2">&quot;Green&quot;</span> <span class="o">;</span>
      <span class="s2">&quot;Lemon&quot;</span><span class="o">,</span> <span class="s2">&quot;Yellow&quot;</span> <span class="o">;</span>
    <span class="o">]</span>
<span class="c">(* adding *)</span>
<span class="k">let</span> <span class="n">food_color&#39;</span> <span class="o">=</span> <span class="n">food_color</span> <span class="o">@</span> <span class="o">[</span> <span class="s2">&quot;Carrot&quot;</span><span class="o">,</span> <span class="s2">&quot;orange&quot;</span> <span class="o">]</span>
<span class="o">;;</span>
<span class="c">(* output entries in insertion order *)</span>
<span class="n">print_endline</span> <span class="s2">&quot;In insertion order, the foods are:&quot;</span><span class="o">;</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="n">printf</span> <span class="s2">&quot;%s is colored %s.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span> <span class="n">food_color</span><span class="o">;</span>
<span class="c">(*</span>
<span class="c">&gt; Banana is colored Yellow.</span>
<span class="c">&gt; Apple is colored Green.</span>
<span class="c">&gt; Lemon is colored Yellow.</span>
<span class="c">*)</span>
<span class="c">(* is it a key? *)</span>
<span class="k">let</span> <span class="n">has_food</span> <span class="n">food</span> <span class="o">=</span> <span class="n">mem_assoc</span> <span class="n">food</span> <span class="n">food_color</span>
<span class="c">(* remove a key *)</span>
<span class="k">let</span> <span class="n">remove_food</span> <span class="n">food</span> <span class="o">=</span> <span class="n">remove_assoc</span> <span class="n">food</span> <span class="n">food_color</span>
<span class="c">(* searching *)</span>
<span class="k">let</span> <span class="n">what_color</span> <span class="n">food</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">let</span> <span class="n">color</span> <span class="o">=</span> <span class="n">assoc</span> <span class="n">food</span> <span class="n">food_color</span> <span class="k">in</span>
    <span class="n">printf</span> <span class="s2">&quot;%s is colored %s.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">food</span> <span class="n">color</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="n">printf</span> <span class="s2">&quot;i don&#39;t know the color of %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">food</span>
<span class="o">;;</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN253"
>Hashes with Multiple Values Per Key</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="n">re</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;^</span><span class="err">\</span><span class="s2">([^ ]*</span><span class="err">\</span><span class="s2">) *</span><span class="err">\</span><span class="s2">([^ ]*</span><span class="err">\</span><span class="s2">)&quot;</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">readlines</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_in</span> <span class="s2">&quot;who&quot;</span><span class="o">)</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">ttys</span> <span class="o">=</span> <span class="n">filter_some</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span>
  <span class="k">if</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">re</span> <span class="n">line</span> <span class="mi">0</span><span class="o">)</span> <span class="k">then</span>
    <span class="nc">Some</span><span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">1</span> <span class="n">line</span><span class="o">,</span> <span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">2</span> <span class="n">line</span><span class="o">)</span>
  <span class="k">else</span> <span class="nc">None</span><span class="o">)</span> <span class="n">lines</span><span class="o">)</span> <span class="k">in</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">user</span> <span class="o">-&gt;</span>
    <span class="n">printf</span> <span class="s2">&quot;%s: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">user</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot; &quot;</span> <span class="o">(</span><span class="n">all_assoc</span> <span class="n">user</span> <span class="n">ttys</span><span class="o">))</span>
  <span class="o">)</span> <span class="o">(</span><span class="n">sort_</span> <span class="o">(</span><span class="n">uniq</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">fst</span> <span class="n">ttys</span><span class="o">)))</span>
<span class="o">;</span>
<span class="c">(*-----------------------------*)</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">user</span> <span class="o">-&gt;</span>
    <span class="k">let</span> <span class="n">ttylist</span> <span class="o">=</span> <span class="n">all_assoc</span> <span class="n">user</span> <span class="n">ttys</span> <span class="k">in</span>
    <span class="n">printf</span> <span class="s2">&quot;%s: %d ttys.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">user</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">length</span> <span class="n">ttylist</span><span class="o">);</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
      <span class="o">(</span><span class="k">fun</span> <span class="n">tty</span> <span class="o">-&gt;</span>
        <span class="k">let</span> <span class="n">uname</span> <span class="o">=</span>
          <span class="k">try</span>
            <span class="k">let</span> <span class="n">uid</span> <span class="o">=</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">stat</span> <span class="o">(</span><span class="s2">&quot;/dev/&quot;</span> <span class="o">^</span> <span class="n">tty</span><span class="o">)).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">st_uid</span> <span class="k">in</span>
            <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">getpwuid</span> <span class="n">uid</span><span class="o">).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">pw_name</span>
          <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="s2">&quot;(not available)&quot;</span>
        <span class="k">in</span>
        <span class="n">printf</span> <span class="s2">&quot;%s (owned by %s)</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">tty</span> <span class="n">uname</span>
      <span class="o">)</span> <span class="n">ttylist</span>
  <span class="o">)</span> <span class="o">(</span><span class="n">sort_</span> <span class="o">(</span><span class="n">uniq</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">fst</span> <span class="n">ttys</span><span class="o">)))</span>
<span class="c">(*-----------------------------*)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN256"
>Inverting a Hash</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(*-----------------------------*)</span>

<span class="k">open</span> <span class="nc">Hashtbl</span>

<span class="c">(* size of an hash, i.e. number of bindings *)</span>
<span class="k">let</span> <span class="n">hashtbl_size</span> <span class="n">h</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">length</span> <span class="o">(</span><span class="n">hashtbl_keys</span> <span class="n">h</span><span class="o">);;</span>

<span class="c">(* in OCaml does not exists a builtin function like &quot;reverse&quot;, here is</span>
<span class="c">an equivalent one: *)</span>
<span class="k">let</span> <span class="n">hashtbl_reverse</span> <span class="n">h</span> <span class="o">=</span>
  <span class="n">assoc_list2hashtbl</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">combine</span> <span class="o">(</span><span class="n">hashtbl_values</span> <span class="n">h</span><span class="o">)</span> <span class="o">(</span><span class="n">hashtbl_keys</span> <span class="n">h</span><span class="o">))</span>
<span class="c">(* or *)</span>
<span class="k">let</span> <span class="n">hashtbl_reverse</span> <span class="n">h</span> <span class="o">=</span>
  <span class="n">assoc_list2hashtbl</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">a</span><span class="o">,</span><span class="n">b</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">b</span><span class="o">,</span><span class="n">a</span><span class="o">))</span> <span class="o">(</span><span class="n">hashtbl2assoc_list</span> <span class="n">h</span><span class="o">))</span>
<span class="o">;;</span>
<span class="c">(* or *)</span>
<span class="k">let</span> <span class="n">hashtbl_reverse_multi</span> <span class="n">h</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">newhash</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="o">(</span><span class="n">hashtbl_size</span> <span class="n">h</span><span class="o">)</span> <span class="k">in</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">add</span> <span class="n">newhash</span> <span class="o">(</span><span class="n">find</span> <span class="n">h</span> <span class="n">v</span><span class="o">)</span> <span class="n">v</span><span class="o">)</span>
    <span class="o">(</span><span class="n">hashtbl_keys</span> <span class="n">h</span><span class="o">);</span>
  <span class="n">newhash</span>
<span class="c">(* note that the last  implementation maintain also multiple binding for the</span>
<span class="c">same key, see Hashtbl.add in the standard OCaml library for more info *)</span>

<span class="c">(*-----------------------------*)</span>
<span class="c">(* example of hashtbl_reverse *)</span>

<span class="k">let</span> <span class="n">reverse</span> <span class="o">=</span> <span class="n">hashtbl_reverse</span> <span class="n">lookup</span><span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="n">surname</span> <span class="o">=</span> <span class="n">assoc_list2hashtbl</span> <span class="o">[</span><span class="s2">&quot;Mickey&quot;</span><span class="o">,</span> <span class="s2">&quot;Mantle&quot;</span><span class="o">;</span> <span class="s2">&quot;Babe&quot;</span><span class="o">,</span> <span class="s2">&quot;Ruth&quot;</span><span class="o">]</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">firstname</span> <span class="o">=</span> <span class="n">hashtbl_reverse</span> <span class="n">surname</span> <span class="k">in</span>
<span class="n">print_endline</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">firstname</span> <span class="s2">&quot;Mantle&quot;</span><span class="o">);;</span>
<span class="c">(*</span>
<span class="c">&gt; Mickey</span>
<span class="c">*)</span>

<span class="c">(*-----------------------------*)</span>
<span class="c">(* foodfind - find match for food or color *)</span>

<span class="k">let</span> <span class="n">given</span> <span class="o">=</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">color</span> <span class="o">=</span> <span class="n">assoc_list2hashtbl</span>
  <span class="o">[</span><span class="s2">&quot;Apple&quot;</span><span class="o">,</span> <span class="s2">&quot;red&quot;</span><span class="o">;</span>
   <span class="s2">&quot;Banana&quot;</span><span class="o">,</span> <span class="s2">&quot;yellow&quot;</span><span class="o">;</span>
   <span class="s2">&quot;Lemon&quot;</span><span class="o">,</span> <span class="s2">&quot;yellow&quot;</span><span class="o">;</span>
   <span class="s2">&quot;Carrot&quot;</span><span class="o">,</span> <span class="s2">&quot;orange&quot;</span><span class="o">]</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">food</span> <span class="o">=</span> <span class="n">hashtbl_reverse</span> <span class="n">color</span> <span class="k">in</span>
<span class="o">(</span><span class="k">try</span>
  <span class="n">printf</span> <span class="s2">&quot;%s is a food with color %s.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">given</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">color</span> <span class="n">given</span><span class="o">);</span>
<span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">);</span>
<span class="o">(</span><span class="k">try</span>
  <span class="n">printf</span> <span class="s2">&quot;%s is a food with color %s.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">food</span> <span class="n">given</span><span class="o">)</span> <span class="n">given</span>
<span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">)</span>
<span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="c">(* food_color defined as previous *)</span>

<span class="k">let</span> <span class="n">foods_with_color</span> <span class="o">=</span> <span class="n">hashtbl_reverse</span> <span class="n">food_color</span> <span class="k">in</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="n">printf</span> <span class="s2">&quot;%s &quot;</span><span class="o">)</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find_all</span> <span class="n">foods_with_color</span> <span class="s2">&quot;yellow&quot;</span><span class="o">);</span>
<span class="n">print_endline</span> <span class="s2">&quot;were yellow foods.&quot;</span>
<span class="o">;;</span>
<span class="c">(*-----------------------------*)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN259"
>Sorting a Hash</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(*-----------------------------*)</span>

<span class="c">(* you may define your own compare function to be used in sorting *)</span>
<span class="k">let</span> <span class="n">keys</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">sort</span> <span class="n">compare_function</span> <span class="o">(</span><span class="n">hashtbl_keys</span> <span class="n">hash</span><span class="o">)</span> <span class="k">in</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">key</span> <span class="o">-&gt;</span>
    <span class="k">let</span> <span class="k">value</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">hash</span> <span class="n">key</span> <span class="k">in</span>
    <span class="c">(* do something with key and value *)</span>
    <span class="bp">()</span>
  <span class="o">)</span>
  <span class="n">keys</span> <span class="o">;</span>
<span class="c">(* or use this one if you want to compare not only on keys *)</span>
<span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span>
  <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="k">value</span><span class="o">)</span> <span class="o">-&gt;</span>
    <span class="c">(* do something with key and value *)</span>
    <span class="bp">()</span>
  <span class="o">)</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">sort</span> <span class="n">compare_function</span> <span class="o">(</span><span class="n">hashtbl2assoc_list</span> <span class="n">hash</span><span class="o">))</span> <span class="o">;</span>
<span class="c">(*-----------------------------*)</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">food</span> <span class="o">-&gt;</span>
    <span class="n">printf</span> <span class="s2">&quot;%s is %s.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">food</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">food_color</span> <span class="n">food</span><span class="o">)</span>
  <span class="o">)</span>
  <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">sort</span> <span class="o">(</span><span class="n">hashtbl_keys</span> <span class="n">food_color</span><span class="o">))</span>
<span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="c">(* examples of &quot;compare_function&quot;: *)</span>

<span class="c">(* alphabetical sort on the hash value *)</span>
<span class="k">let</span> <span class="n">compare_function</span> <span class="o">(_,</span><span class="n">color1</span><span class="o">)</span> <span class="o">(_,</span><span class="n">color2</span><span class="o">)</span> <span class="o">=</span> <span class="n">compare</span> <span class="n">color1</span> <span class="n">color2</span>

<span class="c">(* length sort on the hash value *)</span>
<span class="k">let</span> <span class="n">compare_function</span> <span class="o">(_,</span><span class="n">color1</span><span class="o">)</span> <span class="o">(_,</span><span class="n">color2</span><span class="o">)</span> <span class="o">=</span> <span class="n">compare</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">color1</span><span class="o">)</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">color2</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN262"
>Merging Hashes</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(*-----------------------------*)</span>
<span class="c">(* definition of merge function on hashes: *)</span>
<span class="k">let</span> <span class="n">hashtbl_merge</span> <span class="n">h1</span> <span class="n">h2</span> <span class="o">=</span> <span class="n">assoc_list2hashtbl</span> <span class="o">(</span><span class="n">hashtbl2assoc_list</span> <span class="n">h1</span> <span class="o">@</span> <span class="n">hashtbl2assoc_list</span> <span class="n">h2</span><span class="o">)</span>

<span class="c">(* usage: *)</span>
<span class="k">let</span> <span class="n">merged</span> <span class="o">=</span> <span class="n">hashtbl_merge</span> <span class="n">a</span> <span class="n">b</span><span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="n">merged</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span> <span class="k">in</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
  <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">k</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">add</span> <span class="n">merged</span> <span class="n">k</span> <span class="n">v</span><span class="o">))</span>
  <span class="o">[</span><span class="n">a</span><span class="o">;</span><span class="n">b</span><span class="o">]</span>
<span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="n">drink_color</span> <span class="o">=</span> <span class="n">assoc_list2hashtbl</span>
    <span class="o">[</span><span class="s2">&quot;Galliano&quot;</span><span class="o">,</span> <span class="s2">&quot;yellow&quot;</span><span class="o">;</span>
     <span class="s2">&quot;Mai Tai&quot;</span><span class="o">,</span> <span class="s2">&quot;blue&quot;</span><span class="o">]</span>
<span class="o">;;</span>

<span class="k">let</span> <span class="n">ingested_color</span> <span class="o">=</span> <span class="n">hashtbl_merge</span> <span class="n">drink_color</span> <span class="n">food_color</span><span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="n">substance_color</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span> <span class="k">in</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
  <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">k</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">add</span> <span class="n">merged</span> <span class="n">k</span> <span class="n">v</span><span class="o">))</span>
  <span class="o">[</span><span class="n">food_color</span><span class="o">;</span> <span class="n">drink_color</span><span class="o">]</span>
<span class="o">;;</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN265"
>Finding Common or Different Keys in Two Hashes</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="n">common</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">filter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">key</span> <span class="o">-&gt;</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">mem</span> <span class="n">hash2</span> <span class="n">key</span><span class="o">)</span>
    <span class="o">(</span><span class="n">hashtbl_keys</span> <span class="n">hash1</span><span class="o">)</span>
<span class="o">;;</span>
<span class="c">(* common now contains commne keys, note that a key may appear multiple</span>
<span class="c">times in this list due tu multiple bindings allowed in Hashtbl</span>
<span class="c">implementation *)</span>

<span class="k">let</span> <span class="n">this_not_that</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">filter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">key</span> <span class="o">-&gt;</span> <span class="n">not</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">mem</span> <span class="n">hash2</span> <span class="n">key</span><span class="o">))</span>
    <span class="o">(</span><span class="n">hashtbl_keys</span> <span class="n">hash1</span><span class="o">)</span>
<span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="n">citrus_color</span> <span class="o">=</span> <span class="n">assoc_list2hashtbl</span>
                      <span class="o">[</span><span class="s2">&quot;Lemon&quot;</span><span class="o">,</span> <span class="s2">&quot;yellow&quot;</span><span class="o">;</span>
                       <span class="s2">&quot;Orange&quot;</span><span class="o">,</span> <span class="s2">&quot;orange&quot;</span><span class="o">;</span>
                       <span class="s2">&quot;Lime&quot;</span><span class="o">,</span> <span class="s2">&quot;green&quot;</span><span class="o">]</span>
<span class="k">in</span>
<span class="k">let</span> <span class="n">non_citrus</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">3</span> <span class="k">in</span>
<span class="nn">List</span><span class="p">.</span><span class="n">filter</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">key</span> <span class="o">-&gt;</span> <span class="n">not</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">mem</span> <span class="n">citrus_color</span> <span class="n">key</span><span class="o">))</span>
  <span class="o">(</span><span class="n">hashtbl_keys</span> <span class="n">food_color</span><span class="o">)</span>
<span class="o">;;</span>

<span class="c">(*-----------------------------*)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN268"
>Hashing References</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(*-----------------------------*)</span>
<span class="k">open</span> <span class="nc">Unix</span><span class="o">;;</span>
<span class="k">open</span> <span class="nc">Printf</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">filenames</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;/etc/printcap&quot;</span><span class="o">;</span> <span class="s2">&quot;/vmlinuz&quot;</span><span class="o">;</span> <span class="s2">&quot;/bin/cat&quot;</span><span class="o">]</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">openfiles</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">3</span> <span class="k">in</span>
<span class="n">print_newline</span><span class="bp">()</span><span class="o">;</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">fname</span> <span class="o">-&gt;</span>
    <span class="n">printf</span> <span class="s2">&quot;%s is %d bytes long.</span><span class="se">\n</span><span class="s2">&quot;</span>
      <span class="n">fname</span>
      <span class="o">(</span><span class="n">stat</span> <span class="n">fname</span><span class="o">).</span><span class="n">st_size</span>
  <span class="o">)</span>
  <span class="n">filenames</span>
<span class="o">;;</span>

<span class="c">(*-----------------------------*)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN271"
>Presizing a Hash</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(*-----------------------------*)</span>

<span class="c">(* presize hash to num elements *)</span>
<span class="k">let</span> <span class="n">hash</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="n">num</span><span class="o">;;</span>
<span class="c">(* other examples of initial size on hashes *)</span>
<span class="k">let</span> <span class="n">hash</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">512</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">hash</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">1000</span><span class="o">;;</span>

<span class="c">(*-----------------------------*)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN274"
>Finding the Most Common Anything</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(*-----------------------------*)</span>

<span class="c">(* size of an array named &quot;a&quot; *)</span>
<span class="k">let</span> <span class="n">count</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">a</span><span class="o">;;</span>

<span class="c">(* size of a list named &quot;l&quot; *)</span>
<span class="k">let</span> <span class="n">count</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">length</span> <span class="n">l</span><span class="o">;;</span>

<span class="c">(*-----------------------------*)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN277"
>Representing Relationships Between Data</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(*-----------------------------*)</span>

<span class="k">open</span> <span class="nc">Printf</span><span class="o">;;</span>
<span class="k">open</span> <span class="nc">Hashtbl</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">father</span> <span class="o">=</span> <span class="n">assoc_list2hashtbl</span>
  <span class="o">[</span> <span class="s2">&quot;Cain&quot;</span><span class="o">,</span> <span class="s2">&quot;Adam&quot;</span><span class="o">;</span>
    <span class="s2">&quot;Abel&quot;</span><span class="o">,</span> <span class="s2">&quot;Adam&quot;</span><span class="o">;</span>
    <span class="s2">&quot;Seth&quot;</span><span class="o">,</span> <span class="s2">&quot;Adam&quot;</span><span class="o">;</span>
    <span class="s2">&quot;Enoch&quot;</span><span class="o">,</span> <span class="s2">&quot;Cain&quot;</span><span class="o">;</span>
    <span class="s2">&quot;Irad&quot;</span><span class="o">,</span> <span class="s2">&quot;Enoch&quot;</span><span class="o">;</span>
    <span class="s2">&quot;Mehujael&quot;</span><span class="o">,</span> <span class="s2">&quot;Irad&quot;</span><span class="o">;</span>
    <span class="s2">&quot;Methusael&quot;</span><span class="o">,</span> <span class="s2">&quot;Mehujael&quot;</span><span class="o">;</span>
    <span class="s2">&quot;Lamech&quot;</span><span class="o">,</span> <span class="s2">&quot;Methusael&quot;</span><span class="o">;</span>
    <span class="s2">&quot;Jabal&quot;</span><span class="o">,</span> <span class="s2">&quot;Lamech&quot;</span><span class="o">;</span>
    <span class="s2">&quot;Jubal&quot;</span><span class="o">,</span> <span class="s2">&quot;Lamech&quot;</span><span class="o">;</span>
    <span class="s2">&quot;Tubalcain&quot;</span><span class="o">,</span> <span class="s2">&quot;Lamech&quot;</span><span class="o">;</span>
    <span class="s2">&quot;Enos&quot;</span><span class="o">,</span> <span class="s2">&quot;Seth&quot;</span><span class="o">]</span> <span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="c">(* recursively print all parents of a given name *)</span>
<span class="k">let</span> <span class="k">rec</span> <span class="n">parents</span> <span class="n">s</span> <span class="o">=</span>
  <span class="n">printf</span> <span class="s2">&quot;%s &quot;</span> <span class="n">s</span><span class="o">;</span>
  <span class="k">if</span> <span class="n">mem</span> <span class="n">father</span> <span class="n">s</span> <span class="k">then</span>
    <span class="n">parents</span> <span class="o">(</span><span class="n">find</span> <span class="n">father</span> <span class="n">s</span><span class="o">)</span>
  <span class="k">else</span>
    <span class="n">printf</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="k">in</span>
  <span class="n">iter_lines</span> <span class="n">parents</span> <span class="n">stdin</span>
<span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="n">children</span> <span class="o">=</span> <span class="n">hashtbl_reverse_multi</span> <span class="n">father</span> <span class="k">in</span>
<span class="n">iter_lines</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="n">printf</span> <span class="s2">&quot;%s &quot;</span><span class="o">)</span> <span class="o">(</span><span class="n">find_all</span> <span class="n">children</span> <span class="n">line</span><span class="o">);</span>
    <span class="n">print_newline</span><span class="bp">()</span>
  <span class="o">)</span>
  <span class="n">stdin</span><span class="o">;</span>
<span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="c">(* build an hash that map filename to list of included file *)</span>
<span class="k">open</span> <span class="nc">Hashtbl</span><span class="o">;;</span>
<span class="k">open</span> <span class="nc">Str</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">includes</span> <span class="o">=</span> <span class="n">create</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">length</span> <span class="n">files</span><span class="o">);;</span>
<span class="k">let</span> <span class="n">includeRE</span> <span class="o">=</span> <span class="n">regexp</span> <span class="s2">&quot;^#include &lt;</span><span class="err">\</span><span class="s2">([a-zA-Z0-9.]+</span><span class="err">\</span><span class="s2">)&gt;&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">isincludeline</span> <span class="n">l</span> <span class="o">=</span> <span class="n">string_match</span> <span class="n">includeRE</span> <span class="n">l</span> <span class="mi">0</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">getincludes</span> <span class="n">fname</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">includelines</span> <span class="o">=</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">filter</span> <span class="n">isincludeline</span> <span class="o">(</span><span class="n">readlines</span> <span class="o">(</span><span class="n">open_in</span> <span class="n">fname</span><span class="o">))</span>
  <span class="k">in</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="n">replace_first</span> <span class="n">includeRE</span> <span class="s2">&quot;</span><span class="err">\</span><span class="s2">1&quot;</span><span class="o">)</span> <span class="n">includelines</span>
<span class="o">;;</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">fname</span> <span class="o">-&gt;</span> <span class="n">add</span> <span class="n">includes</span> <span class="n">fname</span> <span class="o">(</span><span class="n">getincludes</span> <span class="n">fname</span><span class="o">))</span> <span class="n">files</span><span class="o">;;</span>

<span class="c">(*-----------------------------*)</span>
<span class="c">(* build a list of files that does not include system headers *)</span>
<span class="k">let</span> <span class="n">hasnoinclude</span> <span class="n">fname</span> <span class="o">=</span> <span class="o">(</span><span class="n">find</span> <span class="n">includes</span> <span class="n">fname</span> <span class="o">=</span> <span class="bp">[]</span><span class="o">)</span> <span class="k">in</span>
<span class="nn">List</span><span class="p">.</span><span class="n">filter</span> <span class="n">hasnoinclude</span> <span class="o">(</span><span class="n">uniq</span> <span class="o">(</span><span class="n">hashtbl_keys</span> <span class="n">includes</span><span class="o">));;</span>

<span class="c">(*-----------------------------*)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN280"
>Program: dutree</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(*-----------------------------*)</span>

<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* dutree - print sorted indented rendition of du output *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">dirsize</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span>
<span class="k">let</span> <span class="n">kids</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span>

<span class="c">(* run du, read in input, save sizes and kids *)</span>
<span class="c">(* return last directory (file?) read *)</span>
<span class="k">let</span> <span class="n">input</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">last_name</span> <span class="o">=</span> <span class="n">ref</span> <span class="s2">&quot;&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">last_push</span> <span class="o">=</span> <span class="n">ref</span> <span class="nc">None</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">argv</span> <span class="o">=</span> <span class="s2">&quot;du&quot;</span> <span class="o">::</span> <span class="nn">List</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">ch</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_in</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot; &quot;</span> <span class="n">argv</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">begin</span>
    <span class="k">try</span>
      <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
        <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">ch</span> <span class="k">in</span>
        <span class="k">match</span> <span class="nn">Str</span><span class="p">.</span><span class="n">bounded_split</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[ </span><span class="se">\t</span><span class="s2">]+&quot;</span><span class="o">)</span> <span class="n">line</span> <span class="mi">2</span> <span class="k">with</span>
          <span class="o">|</span> <span class="o">[</span><span class="n">size</span><span class="o">;</span> <span class="n">name</span><span class="o">]</span> <span class="o">-&gt;</span>
              <span class="k">let</span> <span class="n">size</span> <span class="o">=</span> <span class="n">int_of_string</span> <span class="n">size</span> <span class="k">in</span>
              <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">dirsize</span> <span class="n">name</span> <span class="n">size</span><span class="o">;</span>
              <span class="k">let</span> <span class="n">parent</span> <span class="o">=</span>
                <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;/[^/]+$&quot;</span><span class="o">)</span> <span class="s2">&quot;&quot;</span> <span class="n">name</span> <span class="k">in</span>
              <span class="n">last_name</span> <span class="o">:=</span> <span class="n">name</span><span class="o">;</span>
              <span class="n">last_push</span> <span class="o">:=</span>
                <span class="nc">Some</span> <span class="o">(</span><span class="n">parent</span><span class="o">,</span>
                      <span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">kids</span> <span class="n">parent</span><span class="o">)</span>
                      <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="nc">None</span><span class="o">);</span>
              <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">kids</span> <span class="n">parent</span>
                <span class="o">(</span><span class="n">name</span> <span class="o">::</span>
                   <span class="o">(</span><span class="k">try</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">kids</span> <span class="n">parent</span>
                    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">[]</span><span class="o">))</span>
          <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="n">line</span>
      <span class="k">done</span>
    <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
      <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_in</span> <span class="n">ch</span><span class="o">)</span>
  <span class="k">end</span><span class="o">;</span>
  <span class="k">begin</span>
    <span class="k">match</span> <span class="o">!</span><span class="n">last_push</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="bp">()</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">parent</span><span class="o">,</span> <span class="nc">None</span><span class="o">)</span> <span class="o">-&gt;</span>
          <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">remove</span> <span class="n">kids</span> <span class="n">parent</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">parent</span><span class="o">,</span> <span class="nc">Some</span> <span class="n">previous</span><span class="o">)</span> <span class="o">-&gt;</span>
          <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">kids</span> <span class="n">parent</span> <span class="n">previous</span>
  <span class="k">end</span><span class="o">;</span>
  <span class="o">!</span><span class="n">last_name</span>

<span class="c">(* figure out how much is taken up in each directory *)</span>
<span class="c">(* that isn&#39;t stored in subdirectories.  add a new *)</span>
<span class="c">(* fake kid called &quot;.&quot; containing that much. *)</span>
<span class="k">let</span> <span class="k">rec</span> <span class="n">getdots</span> <span class="n">root</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">size</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">dirsize</span> <span class="n">root</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">cursize</span> <span class="o">=</span> <span class="n">ref</span> <span class="n">size</span> <span class="k">in</span>
  <span class="k">if</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">mem</span> <span class="n">kids</span> <span class="n">root</span>
  <span class="k">then</span>
    <span class="k">begin</span>
      <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
        <span class="o">(</span><span class="k">fun</span> <span class="n">kid</span> <span class="o">-&gt;</span>
           <span class="n">cursize</span> <span class="o">:=</span> <span class="o">!</span><span class="n">cursize</span> <span class="o">-</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">dirsize</span> <span class="n">kid</span><span class="o">;</span>
           <span class="n">getdots</span> <span class="n">kid</span><span class="o">)</span>
        <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">kids</span> <span class="n">root</span><span class="o">)</span>
    <span class="k">end</span><span class="o">;</span>
  <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;&gt;</span> <span class="o">!</span><span class="n">cursize</span>
  <span class="k">then</span>
    <span class="k">begin</span>
      <span class="k">let</span> <span class="n">dot</span> <span class="o">=</span> <span class="n">root</span> <span class="o">^</span> <span class="s2">&quot;/.&quot;</span> <span class="k">in</span>
      <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">dirsize</span> <span class="n">dot</span> <span class="o">!</span><span class="n">cursize</span><span class="o">;</span>
      <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">kids</span> <span class="n">root</span>
        <span class="o">(</span><span class="n">dot</span> <span class="o">::</span>
           <span class="o">(</span><span class="k">try</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">kids</span> <span class="n">root</span>
            <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">[]</span><span class="o">))</span>
    <span class="k">end</span>

<span class="c">(* recursively output everything, *)</span>
<span class="c">(* passing padding and number width in as well *)</span>
<span class="c">(* on recursive calls *)</span>
<span class="k">let</span> <span class="k">rec</span> <span class="n">output</span> <span class="o">?(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="o">?(</span><span class="n">width</span><span class="o">=</span><span class="mi">0</span><span class="o">)</span> <span class="n">root</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">path</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;.*/&quot;</span><span class="o">)</span> <span class="s2">&quot;&quot;</span> <span class="n">root</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">size</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">dirsize</span> <span class="n">root</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;%*d %s&quot;</span> <span class="n">width</span> <span class="n">size</span> <span class="n">path</span> <span class="k">in</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">prefix</span> <span class="n">line</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">prefix</span> <span class="o">=</span>
    <span class="nn">Str</span><span class="p">.</span><span class="n">global_replace</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[^|]&quot;</span><span class="o">)</span> <span class="s2">&quot; &quot;</span>
      <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[0-9] &quot;</span><span class="o">)</span> <span class="s2">&quot;| &quot;</span>
         <span class="o">(</span><span class="n">prefix</span> <span class="o">^</span> <span class="n">line</span><span class="o">))</span> <span class="k">in</span>
  <span class="k">if</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">mem</span> <span class="n">kids</span> <span class="n">root</span>
  <span class="k">then</span>
    <span class="k">begin</span>
      <span class="k">let</span> <span class="n">kids</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">kids</span> <span class="n">root</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">kids</span> <span class="o">=</span>
        <span class="nn">List</span><span class="p">.</span><span class="n">rev_map</span>
          <span class="o">(</span><span class="k">fun</span> <span class="n">kid</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">dirsize</span> <span class="n">kid</span><span class="o">,</span> <span class="n">kid</span><span class="o">))</span> <span class="n">kids</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">kids</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">sort</span> <span class="n">compare</span> <span class="n">kids</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">kids</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">rev_map</span> <span class="o">(</span><span class="k">fun</span> <span class="o">(_,</span> <span class="n">kid</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">kid</span><span class="o">)</span> <span class="n">kids</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">width</span> <span class="o">=</span>
        <span class="nn">String</span><span class="p">.</span><span class="n">length</span>
          <span class="o">(</span><span class="n">string_of_int</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">dirsize</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">hd</span> <span class="n">kids</span><span class="o">)))</span> <span class="k">in</span>
      <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="n">output</span> <span class="o">~</span><span class="n">prefix</span> <span class="o">~</span><span class="n">width</span><span class="o">)</span> <span class="n">kids</span>
    <span class="k">end</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">topdir</span> <span class="o">=</span> <span class="n">input</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="n">getdots</span> <span class="n">topdir</span><span class="o">;</span>
  <span class="n">output</span> <span class="n">topdir</span></PRE
></TD
></TR
></TABLE
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="arrays.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="patternmatching.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Arrays</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
>&nbsp;</TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Pattern Matching</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>
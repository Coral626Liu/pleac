<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN""http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>References and Records</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="PLEAC-Objective CAML "
HREF="index.html"><LINK
REL="PREVIOUS"
TITLE="Subroutines"
HREF="subroutines.html"><LINK
REL="NEXT"
TITLE="Packages, Libraries, and Modules"
HREF="packagesetc.html"><style type="text/css">td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
pre { line-height: 125%; }

  </style></head
><BODY TEXT="#cecece" BGCOLOR="#4f6f6f" LINK="#f5deb3" VLINK="#d5ae83"
CLASS="SECT1"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>PLEAC-Objective CAML </TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="subroutines.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
></TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="packagesetc.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="REFERENCESANDRECORDS"
>11. References and Records</A
></H1
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN592"
>Introduction</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* Create a reference to an integer *)</span>
<span class="k">let</span> <span class="n">aref</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* Assign to aref&#39;s contents *)</span>
  <span class="n">aref</span> <span class="o">:=</span> <span class="mi">3</span><span class="o">;</span>

  <span class="c">(* Print the value that the reference &quot;aref&quot; refers to *)</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">!</span><span class="n">aref</span><span class="o">;</span>

  <span class="c">(* Since references are just records with a single field, &quot;contents&quot;,</span>
<span class="c">     the following operations have the same effect as above *)</span>
  <span class="n">aref</span><span class="o">.</span><span class="n">contents</span> <span class="o">&lt;-</span> <span class="mi">3</span><span class="o">;</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">aref</span><span class="o">.</span><span class="n">contents</span><span class="o">;</span>

  <span class="c">(* Fast increment and decrement operations are available for int refs *)</span>
  <span class="n">incr</span> <span class="n">aref</span><span class="o">;</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;after incr: %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">!</span><span class="n">aref</span><span class="o">;</span>
  <span class="n">decr</span> <span class="n">aref</span><span class="o">;</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;after decr: %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">!</span><span class="n">aref</span>

<span class="c">(* Create a type for &quot;person&quot; records *)</span>
<span class="k">type</span> <span class="n">person</span> <span class="o">=</span> <span class="o">{</span> <span class="n">name</span> <span class="o">:</span> <span class="kt">string</span><span class="o">;</span>
                <span class="n">address</span> <span class="o">:</span> <span class="kt">string</span><span class="o">;</span>
                <span class="n">birthday</span> <span class="o">:</span> <span class="kt">int</span><span class="o">;</span>
              <span class="o">}</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* Create a &quot;person&quot; record *)</span>
  <span class="k">let</span> <span class="n">nat</span> <span class="o">=</span> <span class="o">{</span> <span class="n">name</span>     <span class="o">=</span> <span class="s2">&quot;Leonhard Euler&quot;</span><span class="o">;</span>
              <span class="n">address</span>  <span class="o">=</span> <span class="s2">&quot;1729 Ramunjan Lane</span><span class="se">\n</span><span class="s2">Mathword, PI 31416&quot;</span><span class="o">;</span>
              <span class="n">birthday</span> <span class="o">=</span> <span class="mh">0x5bb5580</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">in</span>

  <span class="c">(* Display the person&#39;s name and address *)</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">name: %s</span><span class="se">\n</span><span class="s2">address: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">nat</span><span class="o">.</span><span class="n">name</span> <span class="n">nat</span><span class="o">.</span><span class="n">address</span><span class="o">;</span>

  <span class="c">(* Same as above, using pattern-matching *)</span>
  <span class="k">let</span> <span class="o">{</span><span class="n">name</span><span class="o">=</span><span class="n">n</span><span class="o">;</span> <span class="n">address</span><span class="o">=</span><span class="n">a</span><span class="o">}</span> <span class="o">=</span> <span class="n">nat</span> <span class="k">in</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">name: %s</span><span class="se">\n</span><span class="s2">address: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">n</span> <span class="n">a</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN595"
>Taking References to Arrays</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* The following two sections use lists instead of arrays since</span>
<span class="c">   list refs can be enlarged and copied easily. Also, arrays are</span>
<span class="c">   mutable in OCaml, whereas lists are immutable. *)</span>

<span class="c">(* Create a reference to a list *)</span>
<span class="k">let</span> <span class="n">lref</span>      <span class="o">=</span> <span class="n">ref</span> <span class="kt">list</span>
<span class="k">let</span> <span class="n">anon_list</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">[</span><span class="mi">9</span><span class="o">;</span> <span class="mi">7</span><span class="o">;</span> <span class="mi">5</span><span class="o">;</span> <span class="mi">3</span><span class="o">;</span> <span class="mi">1</span><span class="o">]</span>
<span class="k">let</span> <span class="n">anon_copy</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">!</span><span class="n">anon_list</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* Add an item to the list *)</span>
  <span class="n">anon_list</span> <span class="o">:=</span> <span class="mi">11</span> <span class="o">::</span> <span class="o">!</span><span class="n">anon_list</span><span class="o">;</span>

  <span class="c">(* Get the number of items from the list ref *)</span>
  <span class="k">let</span> <span class="n">num_items</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">length</span> <span class="o">!</span><span class="n">anon_list</span> <span class="k">in</span>

  <span class="c">(* Print original data *)</span>
  <span class="n">print_endline</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;, &quot;</span>
                   <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">string_of_int</span> <span class="n">i</span><span class="o">)</span> <span class="o">!</span><span class="n">anon_list</span><span class="o">));</span>

  <span class="c">(* Sort it *)</span>
  <span class="n">anon_list</span> <span class="o">:=</span> <span class="nn">List</span><span class="p">.</span><span class="n">sort</span> <span class="n">compare</span> <span class="o">!</span><span class="n">anon_list</span><span class="o">;</span>

  <span class="c">(* Print sorted data *)</span>
  <span class="n">print_endline</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;, &quot;</span>
                   <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">string_of_int</span> <span class="n">i</span><span class="o">)</span> <span class="o">!</span><span class="n">anon_list</span><span class="o">));</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN598"
>Making Hashes of Arrays</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* Create a hash that maps strings to string lists *)</span>
<span class="k">let</span> <span class="o">(</span><span class="n">hash</span> <span class="o">:</span> <span class="o">(</span><span class="kt">string</span><span class="o">,</span> <span class="kt">string</span> <span class="kt">list</span><span class="o">)</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">t</span><span class="o">)</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span>

<span class="c">(* Define a function to add a string to the string list associated</span>
<span class="c">   with a key in the hash creating the string list if necessary *)</span>
<span class="k">let</span> <span class="n">add</span> <span class="n">hash</span> <span class="n">key</span> <span class="k">value</span> <span class="o">=</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">hash</span> <span class="n">key</span>
    <span class="o">(</span><span class="k">try</span> <span class="k">value</span> <span class="o">::</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">hash</span> <span class="n">key</span>
     <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="o">[</span><span class="k">value</span><span class="o">])</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* Populate the hash with some data *)</span>
  <span class="n">add</span> <span class="n">hash</span> <span class="s2">&quot;fruit&quot;</span> <span class="s2">&quot;apple&quot;</span><span class="o">;</span>
  <span class="n">add</span> <span class="n">hash</span> <span class="s2">&quot;fruit&quot;</span> <span class="s2">&quot;banana&quot;</span><span class="o">;</span>
  <span class="n">add</span> <span class="n">hash</span> <span class="s2">&quot;wine&quot;</span> <span class="s2">&quot;merlot&quot;</span><span class="o">;</span>
  <span class="n">add</span> <span class="n">hash</span> <span class="s2">&quot;cheese&quot;</span> <span class="s2">&quot;cheddar&quot;</span><span class="o">;</span>
  <span class="n">add</span> <span class="n">hash</span> <span class="s2">&quot;cheese&quot;</span> <span class="s2">&quot;brie&quot;</span><span class="o">;</span>
  <span class="n">add</span> <span class="n">hash</span> <span class="s2">&quot;cheese&quot;</span> <span class="s2">&quot;havarti&quot;</span><span class="o">;</span>

  <span class="c">(* Iterate and print out the hash&#39;s contents *)</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">key</span> <span class="n">values</span> <span class="o">-&gt;</span>
       <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">key</span>
         <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;, &quot;</span> <span class="n">values</span><span class="o">))</span>
    <span class="n">hash</span>

<span class="c">(* Hashtbl is somewhat unusual in that it allows multiple values for</span>
<span class="c">   a given key. By using Hashtbl.add instead of Hashtbl.replace, and</span>
<span class="c">   using strings as values instead of string lists, we can save some</span>
<span class="c">   memory *)</span>
<span class="k">let</span> <span class="o">(</span><span class="n">hash</span> <span class="o">:</span> <span class="o">(</span><span class="kt">string</span><span class="o">,</span> <span class="kt">string</span><span class="o">)</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">t</span><span class="o">)</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">add</span> <span class="n">hash</span> <span class="s2">&quot;foo&quot;</span> <span class="s2">&quot;bar&quot;</span><span class="o">;</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">add</span> <span class="n">hash</span> <span class="s2">&quot;foo&quot;</span> <span class="s2">&quot;baz&quot;</span><span class="o">;</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">add</span> <span class="n">hash</span> <span class="s2">&quot;goo&quot;</span> <span class="s2">&quot;arc&quot;</span><span class="o">;</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s =&gt; %s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span> <span class="n">hash</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN601"
>Taking References to Hashes</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* Hashtbls are mutable, so creating a reference to a hash is usually</span>
<span class="c">   not necessary; it creates an *additional* level of indirection. *)</span>
<span class="k">let</span> <span class="n">href</span> <span class="o">=</span> <span class="n">ref</span> <span class="n">hash</span>
<span class="k">let</span> <span class="n">anon_hash</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span><span class="o">)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* Have some fun with locally-defined operators *)</span>
  <span class="k">let</span> <span class="o">(</span> <span class="o">=&gt;</span> <span class="o">)</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="o">!</span><span class="n">anon_hash</span> <span class="k">in</span>
  <span class="o">(</span> <span class="s2">&quot;key1&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;value1&quot;</span><span class="o">;</span> <span class="s2">&quot;key2&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;value2&quot;</span> <span class="o">)</span>
<span class="k">let</span> <span class="n">anon_hash_copy</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">copy</span> <span class="o">!</span><span class="n">href</span><span class="o">)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN604"
>Taking References to Functions</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* Create a reference to a function *)</span>
<span class="k">let</span> <span class="n">fref</span> <span class="o">=</span> <span class="n">ref</span> <span class="n">func</span>
<span class="k">let</span> <span class="n">fref</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="c">(* ... *)</span> <span class="bp">()</span><span class="o">)</span>

<span class="c">(* Call the referent function *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="o">!</span><span class="n">fref</span> <span class="bp">()</span>

<span class="c">(* Create a reference to an association list with function values. *)</span>
<span class="k">let</span> <span class="n">commands</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="o">(</span> <span class="o">=&gt;</span> <span class="o">)</span> <span class="n">name</span> <span class="n">func</span> <span class="o">=</span> <span class="n">commands</span> <span class="o">:=</span> <span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">func</span><span class="o">)</span> <span class="o">::</span> <span class="o">!</span><span class="n">commands</span> <span class="k">in</span>
  <span class="o">(</span>
    <span class="s2">&quot;happy&quot;</span> <span class="o">=&gt;</span> <span class="n">joy</span><span class="o">;</span>
    <span class="s2">&quot;sad&quot;</span>   <span class="o">=&gt;</span> <span class="n">sullen</span><span class="o">;</span>
    <span class="s2">&quot;done&quot;</span>  <span class="o">=&gt;</span> <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="n">print_endline</span> <span class="s2">&quot;See ya!&quot;</span><span class="o">;</span> <span class="n">exit</span> <span class="mi">0</span><span class="o">);</span>
    <span class="s2">&quot;mad&quot;</span>   <span class="o">=&gt;</span> <span class="n">angry</span><span class="o">;</span>
  <span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
    <span class="n">print_string</span> <span class="s2">&quot;How are you? &quot;</span><span class="o">;</span>
    <span class="k">let</span> <span class="kt">string</span> <span class="o">=</span> <span class="n">read_line</span> <span class="bp">()</span> <span class="k">in</span>
    <span class="k">try</span>
      <span class="k">let</span> <span class="n">command</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">assoc</span> <span class="kt">string</span> <span class="o">!</span><span class="n">commands</span> <span class="k">in</span>
      <span class="n">command</span> <span class="bp">()</span>
    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;No such command: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="kt">string</span>
  <span class="k">done</span>

<span class="c">(* Use closures to generate functions that count. *)</span>

<span class="k">let</span> <span class="n">counter_maker</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">start</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span>                             <span class="c">(* this is a closure *)</span>
    <span class="k">let</span> <span class="n">result</span> <span class="o">=</span> <span class="o">!</span><span class="n">start</span> <span class="k">in</span>              <span class="c">(* lexical from enclosing scope *)</span>
    <span class="n">incr</span> <span class="n">start</span><span class="o">;</span> <span class="n">result</span>

<span class="k">let</span> <span class="n">counter1</span> <span class="o">=</span> <span class="n">counter_maker</span> <span class="bp">()</span>
<span class="k">let</span> <span class="n">counter2</span> <span class="o">=</span> <span class="n">counter_maker</span> <span class="bp">()</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">to</span> <span class="mi">4</span> <span class="k">do</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">counter1</span> <span class="bp">()</span><span class="o">)</span>
  <span class="k">done</span><span class="o">;</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%d %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">counter1</span> <span class="bp">()</span><span class="o">)</span> <span class="o">(</span><span class="n">counter2</span> <span class="bp">()</span><span class="o">)</span>
  <span class="c">(*</span>
<span class="c">    0</span>
<span class="c">    1</span>
<span class="c">    2</span>
<span class="c">    3</span>
<span class="c">    4</span>
<span class="c">    5 0</span>
<span class="c">  *)</span>

<span class="c">(* Use closures to generate functions that keep track of time.</span>
<span class="c">   Note that this example does not need references, since</span>
<span class="c">   since functions are just ordinary values in OCaml. *)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">timestamp</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">start_time</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">time</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="n">int_of_float</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">time</span> <span class="bp">()</span> <span class="o">-.</span> <span class="n">start_time</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">early</span> <span class="o">=</span> <span class="n">timestamp</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">sleep</span> <span class="mi">20</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">later</span> <span class="o">=</span> <span class="n">timestamp</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">sleep</span> <span class="mi">10</span><span class="o">;</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;It&#39;s been %d seconds since early.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">early</span> <span class="bp">()</span><span class="o">);</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;It&#39;s been %d seconds since later.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">later</span> <span class="bp">()</span><span class="o">);</span>
  <span class="c">(*</span>
<span class="c">    It&#39;s been 30 seconds since early.</span>
<span class="c">    It&#39;s been 10 seconds since later.</span>
<span class="c">  *)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN607"
>Taking References to Scalars</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* Environments are immutable in OCaml; there is no way to get a</span>
<span class="c">   reference to a value. If you need a mutable cell, use &quot;ref&quot; as</span>
<span class="c">   described in the introduction. If you need to refer to values</span>
<span class="c">   by name strings, use a Hashtbl.t or similar data structure. *)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN610"
>Creating Arrays of Scalar References</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* Create a couple of integer references *)</span>
<span class="k">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>
<span class="k">let</span> <span class="n">b</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>

<span class="c">(* Create an array of the references *)</span>
<span class="k">let</span> <span class="n">array_of_refs</span> <span class="o">=</span> <span class="o">[|</span> <span class="n">a</span><span class="o">;</span> <span class="n">b</span> <span class="o">|]</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* Set the value of an element *)</span>
  <span class="n">array_of_refs</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span> <span class="o">:=</span> <span class="mi">12</span><span class="o">;</span>              <span class="c">(* b := 12 *)</span>

  <span class="c">(* Note that this is *not* the same as array mutation! If we were to do:</span>
<span class="c">       array_of_refs.(1) &lt;- ref 12</span>
<span class="c">     (or drop the refs altogether) then we would no longer be aliasing &quot;b&quot;.</span>
<span class="c">  *)</span>

  <span class="c">(* Get the value of an element *)</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%d %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">!(</span><span class="n">array_of_refs</span><span class="o">.(</span><span class="mi">1</span><span class="o">))</span> <span class="o">!</span><span class="n">b</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">c</span><span class="o">,</span> <span class="n">d</span><span class="o">)</span> <span class="o">=</span> <span class="o">(</span><span class="n">ref</span> <span class="mi">1</span><span class="o">,</span> <span class="n">ref</span> <span class="mi">2</span><span class="o">,</span> <span class="n">ref</span> <span class="mi">3</span><span class="o">,</span> <span class="n">ref</span> <span class="mi">4</span><span class="o">)</span> <span class="k">in</span> <span class="c">(* initialize *)</span>
  <span class="k">let</span> <span class="kt">array</span> <span class="o">=</span> <span class="o">[|</span> <span class="n">a</span><span class="o">;</span> <span class="n">b</span><span class="o">;</span> <span class="n">c</span><span class="o">;</span> <span class="n">d</span> <span class="o">|]</span> <span class="k">in</span>                    <span class="c">(* refs to each value *)</span>

  <span class="kt">array</span><span class="o">.(</span><span class="mi">2</span><span class="o">)</span> <span class="o">:=</span> <span class="o">!(</span><span class="kt">array</span><span class="o">.(</span><span class="mi">2</span><span class="o">))</span> <span class="o">+</span> <span class="mi">9</span><span class="o">;</span>        <span class="c">(* !c is now 12 *)</span>

  <span class="k">let</span> <span class="n">tmp</span> <span class="o">=</span> <span class="kt">array</span><span class="o">.(</span><span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="kt">array</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="k">in</span>
  <span class="n">tmp</span> <span class="o">:=</span> <span class="o">!</span><span class="n">tmp</span> <span class="o">*</span> <span class="mi">5</span><span class="o">;</span>                      <span class="c">(* !d is now 20 *)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN613"
>Using Closures Instead of Objects</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* Since record field names must be unique to their enclosing module,</span>
<span class="c">   define a module to encapsulate the fields of the record type that</span>
<span class="c">   will contain the &quot;methods&quot;. *)</span>
<span class="k">module</span> <span class="nc">Counter</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">type</span> <span class="n">t</span> <span class="o">=</span> <span class="o">{</span> <span class="n">next</span>  <span class="o">:</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">int</span><span class="o">;</span>
             <span class="n">prev</span>  <span class="o">:</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">int</span><span class="o">;</span>
             <span class="n">last</span>  <span class="o">:</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">int</span><span class="o">;</span>
             <span class="n">get</span>   <span class="o">:</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">int</span><span class="o">;</span>
             <span class="n">set</span>   <span class="o">:</span> <span class="kt">int</span>  <span class="o">-&gt;</span> <span class="kt">unit</span><span class="o">;</span>
             <span class="n">bump</span>  <span class="o">:</span> <span class="kt">int</span>  <span class="o">-&gt;</span> <span class="kt">unit</span><span class="o">;</span>
             <span class="n">reset</span> <span class="o">:</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">int</span> <span class="o">}</span>

  <span class="k">let</span> <span class="n">make</span> <span class="n">count</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">start</span> <span class="o">=</span> <span class="n">count</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ref</span> <span class="n">start</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">prev</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">decr</span> <span class="n">count</span><span class="o">;</span> <span class="o">!</span><span class="n">count</span> <span class="k">in</span>
    <span class="o">{</span> <span class="n">next</span>  <span class="o">=</span> <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="n">incr</span> <span class="n">count</span><span class="o">;</span> <span class="o">!</span><span class="n">count</span><span class="o">);</span>
      <span class="n">prev</span>  <span class="o">=</span> <span class="n">prev</span><span class="o">;</span> <span class="n">last</span> <span class="o">=</span> <span class="n">prev</span><span class="o">;</span>
      <span class="n">get</span>   <span class="o">=</span> <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="o">!</span><span class="n">count</span><span class="o">);</span>
      <span class="n">set</span>   <span class="o">=</span> <span class="o">(</span><span class="k">fun</span> <span class="n">count&#39;</span> <span class="o">-&gt;</span> <span class="n">count</span> <span class="o">:=</span> <span class="n">count&#39;</span><span class="o">);</span>
      <span class="n">bump</span>  <span class="o">=</span> <span class="o">(</span><span class="k">fun</span> <span class="n">count&#39;</span> <span class="o">-&gt;</span> <span class="n">count</span> <span class="o">:=</span> <span class="o">!</span><span class="n">count</span> <span class="o">+</span> <span class="n">count&#39;</span><span class="o">);</span>
      <span class="n">reset</span> <span class="o">=</span> <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="n">count</span> <span class="o">:=</span> <span class="n">start</span><span class="o">;</span> <span class="o">!</span><span class="n">count</span><span class="o">)</span>
    <span class="o">}</span>
<span class="k">end</span>

<span class="c">(* Create and use a couple of counters. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">c1</span> <span class="o">=</span> <span class="nn">Counter</span><span class="p">.</span><span class="n">make</span> <span class="mi">20</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">c2</span> <span class="o">=</span> <span class="nn">Counter</span><span class="p">.</span><span class="n">make</span> <span class="mi">77</span> <span class="k">in</span>

  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;next c1: %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">c1</span><span class="o">.</span><span class="nn">Counter</span><span class="p">.</span><span class="n">next</span> <span class="bp">()</span><span class="o">);</span> <span class="c">(* 21 *)</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;next c2: %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">c2</span><span class="o">.</span><span class="nn">Counter</span><span class="p">.</span><span class="n">next</span> <span class="bp">()</span><span class="o">);</span> <span class="c">(* 78 *)</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;next c1: %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">c1</span><span class="o">.</span><span class="nn">Counter</span><span class="p">.</span><span class="n">next</span> <span class="bp">()</span><span class="o">);</span> <span class="c">(* 22 *)</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;last c1: %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">c1</span><span class="o">.</span><span class="nn">Counter</span><span class="p">.</span><span class="n">prev</span> <span class="bp">()</span><span class="o">);</span> <span class="c">(* 21 *)</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;old  c2: %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">c2</span><span class="o">.</span><span class="nn">Counter</span><span class="p">.</span><span class="n">reset</span> <span class="bp">()</span><span class="o">)</span> <span class="c">(* 77 *)</span>

<span class="c">(* Same as above, but using a &quot;local open&quot; to temporarily expose</span>
<span class="c">   the record fields for convenience. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">c1</span> <span class="o">=</span> <span class="nn">Counter</span><span class="p">.</span><span class="n">make</span> <span class="mi">20</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">c2</span> <span class="o">=</span> <span class="nn">Counter</span><span class="p">.</span><span class="n">make</span> <span class="mi">77</span> <span class="k">in</span>
  <span class="k">let</span> <span class="k">module</span> <span class="nc">Local</span> <span class="o">=</span> <span class="k">struct</span>
    <span class="k">open</span> <span class="nc">Counter</span>
    <span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;next c1: %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">c1</span><span class="o">.</span><span class="n">next</span> <span class="bp">()</span><span class="o">);</span> <span class="c">(* 21 *)</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;next c2: %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">c2</span><span class="o">.</span><span class="n">next</span> <span class="bp">()</span><span class="o">);</span> <span class="c">(* 78 *)</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;next c1: %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">c1</span><span class="o">.</span><span class="n">next</span> <span class="bp">()</span><span class="o">);</span> <span class="c">(* 22 *)</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;last c1: %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">c1</span><span class="o">.</span><span class="n">prev</span> <span class="bp">()</span><span class="o">);</span> <span class="c">(* 21 *)</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;old  c2: %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">c2</span><span class="o">.</span><span class="n">reset</span> <span class="bp">()</span><span class="o">)</span> <span class="c">(* 77 *)</span>
  <span class="k">end</span> <span class="k">in</span> <span class="bp">()</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN616"
>Creating References to Methods</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* There is no need to use references just to have a function that</span>
<span class="c">   calls a method. Either write a lambda: *)</span>

<span class="k">let</span> <span class="n">mref</span> <span class="o">=</span> <span class="k">fun</span> <span class="n">x</span> <span class="n">y</span> <span class="n">z</span> <span class="o">-&gt;</span> <span class="n">obj</span><span class="o">#</span><span class="n">meth</span> <span class="n">x</span> <span class="n">y</span> <span class="n">z</span>

<span class="c">(* Or, just refer to the method directly: *)</span>

<span class="k">let</span> <span class="n">mref</span> <span class="o">=</span> <span class="n">obj</span><span class="o">#</span><span class="n">meth</span>

<span class="c">(* Later... *)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">mref</span> <span class="s2">&quot;args&quot;</span> <span class="s2">&quot;go&quot;</span> <span class="s2">&quot;here&quot;</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN619"
>Constructing Records</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="k">type</span> <span class="n">record</span> <span class="o">=</span> <span class="o">{</span> <span class="n">name</span> <span class="o">:</span> <span class="kt">string</span><span class="o">;</span>
                <span class="n">empno</span> <span class="o">:</span> <span class="kt">int</span><span class="o">;</span>
                <span class="k">mutable</span> <span class="n">title</span> <span class="o">:</span> <span class="kt">string</span><span class="o">;</span>
                <span class="k">mutable</span> <span class="n">age</span> <span class="o">:</span> <span class="kt">int</span><span class="o">;</span>
                <span class="k">mutable</span> <span class="n">salary</span> <span class="o">:</span> <span class="kt">float</span><span class="o">;</span>
                <span class="k">mutable</span> <span class="n">pals</span> <span class="o">:</span> <span class="kt">string</span> <span class="kt">list</span><span class="o">;</span>
              <span class="o">}</span>

<span class="k">let</span> <span class="n">record</span> <span class="o">=</span> <span class="o">{</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Jason&quot;</span><span class="o">;</span>
               <span class="n">empno</span> <span class="o">=</span> <span class="mi">132</span><span class="o">;</span>
               <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;deputy peon&quot;</span><span class="o">;</span>
               <span class="n">age</span> <span class="o">=</span> <span class="mi">23</span><span class="o">;</span>
               <span class="n">salary</span> <span class="o">=</span> <span class="mi">37000</span><span class="o">.</span><span class="mi">00</span><span class="o">;</span>
               <span class="n">pals</span> <span class="o">=</span> <span class="o">[</span> <span class="s2">&quot;Norbert&quot;</span><span class="o">;</span> <span class="s2">&quot;Rhys&quot;</span><span class="o">;</span> <span class="s2">&quot;Phineas&quot;</span> <span class="o">]</span>
             <span class="o">}</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;I am %s, and my pals are %s.</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">record</span><span class="o">.</span><span class="n">name</span>
    <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;, &quot;</span> <span class="n">record</span><span class="o">.</span><span class="n">pals</span><span class="o">)</span>

<span class="k">let</span> <span class="n">byname</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* store record *)</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">byname</span> <span class="n">record</span><span class="o">.</span><span class="n">name</span> <span class="n">record</span><span class="o">;</span>

  <span class="c">(* later on, look up by name *)</span>
  <span class="k">begin</span>
    <span class="k">try</span>
      <span class="k">let</span> <span class="n">rp</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">byname</span> <span class="s2">&quot;Aron&quot;</span> <span class="k">in</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Aron is employee %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">rp</span><span class="o">.</span><span class="n">empno</span>
    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
      <span class="c">(* raised if missing *)</span>
      <span class="bp">()</span>
  <span class="k">end</span><span class="o">;</span>

  <span class="c">(* give jason a new pal *)</span>
  <span class="k">let</span> <span class="n">jason</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">byname</span> <span class="s2">&quot;Jason&quot;</span> <span class="k">in</span>
  <span class="n">jason</span><span class="o">.</span><span class="n">pals</span> <span class="o">&lt;-</span> <span class="s2">&quot;Theodore&quot;</span> <span class="o">::</span> <span class="n">jason</span><span class="o">.</span><span class="n">pals</span><span class="o">;</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Jason now has %d pals</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">length</span> <span class="n">jason</span><span class="o">.</span><span class="n">pals</span><span class="o">);</span>

  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">name</span> <span class="n">record</span> <span class="o">-&gt;</span>
       <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s is employee number %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">name</span> <span class="n">record</span><span class="o">.</span><span class="n">empno</span><span class="o">)</span>
    <span class="n">byname</span>

<span class="k">let</span> <span class="n">employees</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* store record *)</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">employees</span> <span class="n">record</span><span class="o">.</span><span class="n">empno</span> <span class="n">record</span><span class="o">;</span>

  <span class="c">(* lookup by id *)</span>
  <span class="k">begin</span>
    <span class="k">try</span>
      <span class="k">let</span> <span class="n">rp</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">employees</span> <span class="mi">132</span> <span class="k">in</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;employee number 132 is %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">rp</span><span class="o">.</span><span class="n">name</span>
    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
      <span class="bp">()</span>
  <span class="k">end</span><span class="o">;</span>

  <span class="k">let</span> <span class="n">jason</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">byname</span> <span class="s2">&quot;Jason&quot;</span> <span class="k">in</span>
  <span class="n">jason</span><span class="o">.</span><span class="n">salary</span> <span class="o">&lt;-</span> <span class="n">jason</span><span class="o">.</span><span class="n">salary</span> <span class="o">*.</span> <span class="mi">1</span><span class="o">.</span><span class="mi">035</span>

<span class="c">(* Return true if the string s contains the given substring. *)</span>
<span class="k">let</span> <span class="n">contains</span> <span class="n">s</span> <span class="n">substring</span> <span class="o">=</span>
  <span class="k">try</span> <span class="n">ignore</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp_string</span> <span class="n">substring</span><span class="o">)</span> <span class="n">s</span> <span class="mi">0</span><span class="o">);</span> <span class="bp">true</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">false</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* A filter function for hash tables, written as a fold. *)</span>
  <span class="k">let</span> <span class="n">grep</span> <span class="n">f</span> <span class="n">hash</span> <span class="o">=</span>
    <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">fold</span>
      <span class="o">(</span><span class="k">fun</span> <span class="n">key</span> <span class="k">value</span> <span class="n">result</span> <span class="o">-&gt;</span>
         <span class="k">if</span> <span class="n">f</span> <span class="k">value</span> <span class="k">then</span> <span class="k">value</span> <span class="o">::</span> <span class="n">result</span> <span class="k">else</span> <span class="n">result</span><span class="o">)</span>
      <span class="n">hash</span> <span class="bp">[]</span> <span class="k">in</span>

  <span class="c">(* Select records matching criteria. *)</span>
  <span class="k">let</span> <span class="n">peons</span> <span class="o">=</span>
    <span class="n">grep</span> <span class="o">(</span><span class="k">fun</span> <span class="n">employee</span> <span class="o">-&gt;</span> <span class="n">contains</span> <span class="n">employee</span><span class="o">.</span><span class="n">title</span> <span class="s2">&quot;peon&quot;</span><span class="o">)</span> <span class="n">employees</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">tsevens</span> <span class="o">=</span>
    <span class="n">grep</span> <span class="o">(</span><span class="k">fun</span> <span class="n">employee</span> <span class="o">-&gt;</span> <span class="n">employee</span><span class="o">.</span><span class="n">age</span> <span class="o">=</span> <span class="mi">27</span><span class="o">)</span> <span class="n">employees</span> <span class="k">in</span>

  <span class="c">(* Go through all records. *)</span>
  <span class="k">let</span> <span class="n">records</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">fold</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="n">v</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">v</span> <span class="o">::</span> <span class="n">a</span><span class="o">)</span> <span class="n">employees</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">rp</span> <span class="o">-&gt;</span>
       <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s is age %d.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">rp</span><span class="o">.</span><span class="n">name</span> <span class="n">rp</span><span class="o">.</span><span class="n">age</span><span class="o">)</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">sort</span> <span class="o">(</span><span class="k">fun</span> <span class="n">r1</span> <span class="n">r2</span> <span class="o">-&gt;</span> <span class="n">compare</span> <span class="n">r1</span><span class="o">.</span><span class="n">age</span> <span class="n">r2</span><span class="o">.</span><span class="n">age</span><span class="o">)</span> <span class="n">records</span><span class="o">)</span>

<span class="c">(* Create an array of lists of records by age. *)</span>
<span class="k">let</span> <span class="n">byage</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">create</span> <span class="mi">150</span> <span class="bp">[]</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="n">employee</span> <span class="o">-&gt;</span>
       <span class="n">byage</span><span class="o">.(</span><span class="n">employee</span><span class="o">.</span><span class="n">age</span><span class="o">)</span> <span class="o">&lt;-</span> <span class="n">employee</span> <span class="o">::</span> <span class="n">byage</span><span class="o">.(</span><span class="n">employee</span><span class="o">.</span><span class="n">age</span><span class="o">))</span>
    <span class="n">employees</span>

<span class="c">(* Print all employees by age. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">iteri</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">age</span> <span class="n">emps</span> <span class="o">-&gt;</span>
       <span class="k">match</span> <span class="n">emps</span> <span class="k">with</span>
         <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="bp">()</span>
         <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span>
             <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Age %d: &quot;</span> <span class="n">age</span><span class="o">;</span>
             <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">emp</span> <span class="o">-&gt;</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s &quot;</span> <span class="n">emp</span><span class="o">.</span><span class="n">name</span><span class="o">)</span> <span class="n">emps</span><span class="o">;</span>
             <span class="n">print_newline</span> <span class="bp">()</span><span class="o">)</span>
    <span class="n">byage</span>

<span class="c">(* Similar approach using List.map and String.concat. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">iteri</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">age</span> <span class="n">emps</span> <span class="o">-&gt;</span>
       <span class="k">match</span> <span class="n">emps</span> <span class="k">with</span>
         <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="bp">()</span>
         <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span>
             <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Age %d: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">age</span>
               <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;, &quot;</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">r</span> <span class="o">-&gt;</span> <span class="n">r</span><span class="o">.</span><span class="n">name</span><span class="o">)</span> <span class="n">emps</span><span class="o">)))</span>
    <span class="n">byage</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN622"
>Reading and Writing Hash Records to Text Files</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="c">(* Define a list reference to contain our data. *)</span>
<span class="k">let</span> <span class="o">(</span><span class="n">list_of_records</span> <span class="o">:</span> <span class="o">(</span><span class="kt">string</span><span class="o">,</span> <span class="kt">string</span><span class="o">)</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">t</span> <span class="kt">list</span> <span class="n">ref</span><span class="o">)</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span>

<span class="c">(* Read records from standard input. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">([^:]+</span><span class="se">\\</span><span class="s2">):[ </span><span class="se">\t</span><span class="s2">]*</span><span class="se">\\</span><span class="s2">(.*</span><span class="se">\\</span><span class="s2">)&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">record</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">begin</span>
    <span class="k">try</span>
      <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
        <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">read_line</span> <span class="bp">()</span> <span class="k">in</span>
        <span class="k">if</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">regexp</span> <span class="n">line</span> <span class="mi">0</span>
        <span class="k">then</span>
          <span class="k">let</span> <span class="n">field</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">1</span> <span class="n">line</span> <span class="k">in</span>
          <span class="k">let</span> <span class="k">value</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">2</span> <span class="n">line</span> <span class="k">in</span>
          <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="o">!</span><span class="n">record</span> <span class="n">field</span> <span class="k">value</span>
        <span class="k">else</span>
          <span class="o">(</span><span class="n">list_of_records</span> <span class="o">:=</span> <span class="o">!</span><span class="n">record</span> <span class="o">::</span> <span class="o">!</span><span class="n">list_of_records</span><span class="o">;</span>
           <span class="n">record</span> <span class="o">:=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span><span class="o">)</span>
      <span class="k">done</span>
    <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
      <span class="k">if</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">length</span> <span class="o">!</span><span class="n">record</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="k">then</span> <span class="n">list_of_records</span> <span class="o">:=</span> <span class="o">!</span><span class="n">record</span> <span class="o">::</span> <span class="o">!</span><span class="n">list_of_records</span>
  <span class="k">end</span>

<span class="c">(* Write records to standard output. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">record</span> <span class="o">-&gt;</span>
       <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span>
         <span class="o">(</span><span class="k">fun</span> <span class="n">field</span> <span class="k">value</span> <span class="o">-&gt;</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">field</span> <span class="k">value</span><span class="o">)</span>
         <span class="n">record</span><span class="o">;</span>
       <span class="n">print_newline</span> <span class="bp">()</span><span class="o">)</span>
    <span class="o">!</span><span class="n">list_of_records</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN625"
>Printing Data Structures</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* If you are in the OCaml toplevel, simply enter an expression to</span>
<span class="c">   view its type and value. *)</span>
<span class="o">#</span> <span class="k">let</span> <span class="n">reference</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span> <span class="o">[</span> <span class="s2">&quot;foo&quot;</span><span class="o">,</span> <span class="s2">&quot;bar&quot;</span> <span class="o">],</span>
                        <span class="mi">3</span><span class="o">,</span>
                        <span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="n">print_endline</span> <span class="s2">&quot;hello, world&quot;</span> <span class="o">);;</span>
<span class="k">val</span> <span class="n">reference</span> <span class="o">:</span> <span class="o">((</span><span class="kt">string</span> <span class="o">*</span> <span class="kt">string</span><span class="o">)</span> <span class="kt">list</span> <span class="o">*</span> <span class="kt">int</span> <span class="o">*</span> <span class="o">(</span><span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">unit</span><span class="o">))</span> <span class="n">ref</span> <span class="o">=</span>
  <span class="o">{</span><span class="n">contents</span> <span class="o">=</span> <span class="o">([(</span><span class="s2">&quot;foo&quot;</span><span class="o">,</span> <span class="s2">&quot;bar&quot;</span><span class="o">)],</span> <span class="mi">3</span><span class="o">,</span> <span class="o">&lt;</span><span class="k">fun</span><span class="o">&gt;)}</span>

<span class="c">(* From within your own programs, use the Std.print and Std.dump</span>
<span class="c">   functions from the Extlib library, available at</span>
<span class="c">   http://ocaml-lib.sourceforge.net/ *)</span>
<span class="o">#</span> <span class="nn">Std</span><span class="p">.</span><span class="n">print</span> <span class="n">reference</span><span class="o">;;</span>
<span class="o">(([(</span><span class="s2">&quot;foo&quot;</span><span class="o">,</span> <span class="s2">&quot;bar&quot;</span><span class="o">)],</span> <span class="mi">3</span><span class="o">,</span> <span class="o">&lt;</span><span class="n">closure</span><span class="o">&gt;))</span>
<span class="o">-</span> <span class="o">:</span> <span class="kt">unit</span> <span class="o">=</span> <span class="bp">()</span>
<span class="o">#</span> <span class="nn">Std</span><span class="p">.</span><span class="n">dump</span> <span class="n">reference</span><span class="o">;;</span>
<span class="o">-</span> <span class="o">:</span> <span class="kt">string</span> <span class="o">=</span> <span class="s2">&quot;(([(</span><span class="se">\&quot;</span><span class="s2">foo</span><span class="se">\&quot;</span><span class="s2">, </span><span class="se">\&quot;</span><span class="s2">bar</span><span class="se">\&quot;</span><span class="s2">)], 3, &lt;closure&gt;))&quot;</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN628"
>Copying Data Structures</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* Immutable data structures such as int, char, float, tuple, list, Set,</span>
<span class="c">   and Map can be copied by assignment. *)</span>
<span class="k">let</span> <span class="n">v2</span> <span class="o">=</span> <span class="n">v1</span>
<span class="k">let</span> <span class="n">r2</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">!</span><span class="n">r1</span>

<span class="c">(* Objects can be shallow-copied using Oo.copy. *)</span>
<span class="k">let</span> <span class="n">o2</span> <span class="o">=</span> <span class="nn">Oo</span><span class="p">.</span><span class="n">copy</span> <span class="n">o1</span>

<span class="c">(* Several built-in types include copy functions. *)</span>
<span class="k">let</span> <span class="n">a2</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">copy</span> <span class="n">a1</span>
<span class="k">let</span> <span class="n">h2</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">copy</span> <span class="n">h1</span>
<span class="k">let</span> <span class="n">s2</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">copy</span> <span class="n">s1</span>

<span class="c">(* Any data structure can be deep-copied by running it through Marshal,</span>
<span class="c">   though this is not very efficient. *)</span>
<span class="k">let</span> <span class="o">(</span><span class="n">copy</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">fun</span> <span class="k">value</span> <span class="o">-&gt;</span>
    <span class="nn">Marshal</span><span class="p">.</span><span class="n">from_string</span>
      <span class="o">(</span><span class="nn">Marshal</span><span class="p">.</span><span class="n">to_string</span> <span class="k">value</span> <span class="o">[</span><span class="nn">Marshal</span><span class="p">.</span><span class="nc">Closures</span><span class="o">])</span>
      <span class="mi">0</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN631"
>Storing Data Structures to Disk</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* Store a data structure to disk. *)</span>
  <span class="k">let</span> <span class="n">out_channel</span> <span class="o">=</span> <span class="n">open_out_bin</span> <span class="s2">&quot;filename&quot;</span> <span class="k">in</span>
  <span class="nn">Marshal</span><span class="p">.</span><span class="n">to_channel</span> <span class="n">out_channel</span> <span class="n">data</span> <span class="bp">[]</span><span class="o">;</span>
  <span class="n">close_out</span> <span class="n">out_channel</span><span class="o">;</span>

  <span class="c">(* Load a data structure from disk. *)</span>
  <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span> <span class="n">open_in_bin</span> <span class="s2">&quot;filename&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">data</span> <span class="o">=</span> <span class="nn">Marshal</span><span class="p">.</span><span class="n">from_channel</span> <span class="n">in_channel</span> <span class="k">in</span>
  <span class="c">(* ... *)</span>
  <span class="bp">()</span><span class="o">;;</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* Store a data structure to disk, with exclusive locking. *)</span>
  <span class="k">let</span> <span class="n">out_channel</span> <span class="o">=</span> <span class="n">open_out_bin</span> <span class="s2">&quot;filename&quot;</span> <span class="k">in</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">lockf</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">descr_of_out_channel</span> <span class="n">out_channel</span><span class="o">)</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">F_LOCK</span> <span class="mi">0</span><span class="o">;</span>
  <span class="nn">Marshal</span><span class="p">.</span><span class="n">to_channel</span> <span class="n">out_channel</span> <span class="n">data</span> <span class="bp">[]</span><span class="o">;</span>
  <span class="n">close_out</span> <span class="n">out_channel</span><span class="o">;</span>

  <span class="c">(* Load a data structure from disk, with shared locking. *)</span>
  <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span> <span class="n">open_in_bin</span> <span class="s2">&quot;filename&quot;</span> <span class="k">in</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">lockf</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">descr_of_in_channel</span> <span class="n">in_channel</span><span class="o">)</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">F_RLOCK</span> <span class="mi">0</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">data</span> <span class="o">=</span> <span class="nn">Marshal</span><span class="p">.</span><span class="n">from_channel</span> <span class="n">in_channel</span> <span class="k">in</span>
  <span class="c">(* ... *)</span>
  <span class="bp">()</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN634"
>Transparently Persistent Data Structures</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* See recipes 14.8 and 14.9 for examples of (mostly) transparent</span>
<span class="c">   persistence using DBM and Marshal in a type-safe manner. *)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN637"
>Program: Binary Trees</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* bintree - binary tree demo program *)</span>

<span class="k">type</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">tree</span> <span class="o">=</span> <span class="o">{</span> <span class="k">value</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span><span class="o">;</span>
                 <span class="n">left</span>  <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">tree</span> <span class="n">option</span><span class="o">;</span>
                 <span class="n">right</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">tree</span> <span class="n">option</span> <span class="o">}</span>

<span class="k">let</span> <span class="k">rec</span> <span class="n">string_of_tree</span> <span class="n">tree</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;{ value = %d; left = %s; right = %s }&quot;</span>
    <span class="n">tree</span><span class="o">.</span><span class="k">value</span>
    <span class="o">(</span><span class="k">match</span> <span class="n">tree</span><span class="o">.</span><span class="n">left</span> <span class="k">with</span>
       <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="s2">&quot;None&quot;</span>
       <span class="o">|</span> <span class="nc">Some</span> <span class="n">tree</span> <span class="o">-&gt;</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;Some (%s)&quot;</span> <span class="o">(</span><span class="n">string_of_tree</span> <span class="n">tree</span><span class="o">))</span>
    <span class="o">(</span><span class="k">match</span> <span class="n">tree</span><span class="o">.</span><span class="n">right</span> <span class="k">with</span>
       <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="s2">&quot;None&quot;</span>
       <span class="o">|</span> <span class="nc">Some</span> <span class="n">tree</span> <span class="o">-&gt;</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;Some (%s)&quot;</span> <span class="o">(</span><span class="n">string_of_tree</span> <span class="n">tree</span><span class="o">))</span>

<span class="c">(* insert given value into proper point of</span>
<span class="c">   provided tree.  If no tree provided,</span>
<span class="c">   fill one in for our caller. *)</span>
<span class="k">let</span> <span class="k">rec</span> <span class="n">insert</span> <span class="n">tree</span> <span class="k">value</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">tree</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="o">{</span> <span class="k">value</span> <span class="o">=</span> <span class="k">value</span><span class="o">;</span> <span class="n">left</span> <span class="o">=</span> <span class="nc">None</span><span class="o">;</span> <span class="n">right</span> <span class="o">=</span> <span class="nc">None</span> <span class="o">}</span>
    <span class="o">|</span> <span class="nc">Some</span> <span class="n">tree</span> <span class="o">-&gt;</span>
        <span class="k">if</span> <span class="n">tree</span><span class="o">.</span><span class="k">value</span> <span class="o">&gt;</span> <span class="k">value</span>
        <span class="k">then</span> <span class="o">{</span> <span class="k">value</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="k">value</span><span class="o">;</span>
               <span class="n">left</span>  <span class="o">=</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">insert</span> <span class="n">tree</span><span class="o">.</span><span class="n">left</span> <span class="k">value</span><span class="o">);</span>
               <span class="n">right</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">right</span> <span class="o">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="n">tree</span><span class="o">.</span><span class="k">value</span> <span class="o">&lt;</span> <span class="k">value</span>
        <span class="k">then</span> <span class="o">{</span> <span class="k">value</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="k">value</span><span class="o">;</span>
               <span class="n">left</span>  <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">left</span><span class="o">;</span>
               <span class="n">right</span> <span class="o">=</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">insert</span> <span class="n">tree</span><span class="o">.</span><span class="n">right</span> <span class="k">value</span><span class="o">)</span> <span class="o">}</span>
        <span class="k">else</span> <span class="n">tree</span>

<span class="c">(* recurse on left child,</span>
<span class="c">   then show current value,</span>
<span class="c">   then recurse on right child. *)</span>
<span class="k">let</span> <span class="k">rec</span> <span class="n">in_order</span> <span class="n">tree</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">tree</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="bp">()</span>
    <span class="o">|</span> <span class="nc">Some</span> <span class="n">tree</span> <span class="o">-&gt;</span>
        <span class="n">in_order</span> <span class="n">tree</span><span class="o">.</span><span class="n">left</span><span class="o">;</span>
        <span class="n">print_int</span> <span class="n">tree</span><span class="o">.</span><span class="k">value</span><span class="o">;</span>
        <span class="n">print_string</span> <span class="s2">&quot; &quot;</span><span class="o">;</span>
        <span class="n">in_order</span> <span class="n">tree</span><span class="o">.</span><span class="n">right</span>

<span class="c">(* show current value,</span>
<span class="c">   then recurse on left child,</span>
<span class="c">   then recurse on right child. *)</span>
<span class="k">let</span> <span class="k">rec</span> <span class="n">pre_order</span> <span class="n">tree</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">tree</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="bp">()</span>
    <span class="o">|</span> <span class="nc">Some</span> <span class="n">tree</span> <span class="o">-&gt;</span>
        <span class="n">print_int</span> <span class="n">tree</span><span class="o">.</span><span class="k">value</span><span class="o">;</span>
        <span class="n">print_string</span> <span class="s2">&quot; &quot;</span><span class="o">;</span>
        <span class="n">pre_order</span> <span class="n">tree</span><span class="o">.</span><span class="n">left</span><span class="o">;</span>
        <span class="n">pre_order</span> <span class="n">tree</span><span class="o">.</span><span class="n">right</span>

<span class="c">(* recurse on left child,</span>
<span class="c">   then recurse on right child,</span>
<span class="c">   then show current value. *)</span>
<span class="k">let</span> <span class="k">rec</span> <span class="n">post_order</span> <span class="n">tree</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">tree</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="bp">()</span>
    <span class="o">|</span> <span class="nc">Some</span> <span class="n">tree</span> <span class="o">-&gt;</span>
        <span class="n">post_order</span> <span class="n">tree</span><span class="o">.</span><span class="n">left</span><span class="o">;</span>
        <span class="n">post_order</span> <span class="n">tree</span><span class="o">.</span><span class="n">right</span><span class="o">;</span>
        <span class="n">print_int</span> <span class="n">tree</span><span class="o">.</span><span class="k">value</span><span class="o">;</span>
        <span class="n">print_string</span> <span class="s2">&quot; &quot;</span>

<span class="c">(* find out whether provided value is in the tree.</span>
<span class="c">   if so, return the node at which the value was found.</span>
<span class="c">   cut down search time by only looking in the correct</span>
<span class="c">   branch, based on current value. *)</span>
<span class="k">let</span> <span class="k">rec</span> <span class="n">search</span> <span class="n">tree</span> <span class="k">value</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">tree</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">Some</span> <span class="n">tree</span> <span class="o">-&gt;</span>
        <span class="k">if</span> <span class="n">tree</span><span class="o">.</span><span class="k">value</span> <span class="o">=</span> <span class="k">value</span>
        <span class="k">then</span> <span class="nc">Some</span> <span class="n">tree</span>
        <span class="k">else</span> <span class="n">search</span> <span class="o">(</span><span class="k">if</span> <span class="k">value</span> <span class="o">&lt;</span> <span class="n">tree</span><span class="o">.</span><span class="k">value</span> <span class="k">then</span> <span class="n">tree</span><span class="o">.</span><span class="n">left</span> <span class="k">else</span> <span class="n">tree</span><span class="o">.</span><span class="n">right</span><span class="o">)</span> <span class="k">value</span>
    <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="nc">None</span>

<span class="c">(* reference to the root of the tree *)</span>
<span class="k">let</span> <span class="n">root</span> <span class="o">=</span> <span class="n">ref</span> <span class="nc">None</span>

<span class="c">(* first generate 20 random inserts *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Random</span><span class="p">.</span><span class="n">self_init</span> <span class="bp">()</span><span class="o">;</span>
  <span class="k">for</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">to</span> <span class="mi">19</span> <span class="k">do</span>
    <span class="n">root</span> <span class="o">:=</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">insert</span> <span class="o">!</span><span class="n">root</span> <span class="o">(</span><span class="nn">Random</span><span class="p">.</span><span class="n">int</span> <span class="mi">1000</span><span class="o">))</span>
  <span class="k">done</span>

<span class="c">(* now dump out the tree all three ways *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">print_string</span> <span class="s2">&quot;Pre order: &quot;</span><span class="o">;</span> <span class="n">pre_order</span> <span class="o">!</span><span class="n">root</span><span class="o">;</span> <span class="n">print_newline</span> <span class="bp">()</span><span class="o">;</span>
  <span class="n">print_string</span> <span class="s2">&quot;In order: &quot;</span><span class="o">;</span> <span class="n">in_order</span> <span class="o">!</span><span class="n">root</span><span class="o">;</span> <span class="n">print_newline</span> <span class="bp">()</span><span class="o">;</span>
  <span class="n">print_string</span> <span class="s2">&quot;Post order: &quot;</span><span class="o">;</span> <span class="n">post_order</span> <span class="o">!</span><span class="n">root</span><span class="o">;</span> <span class="n">print_newline</span> <span class="bp">()</span>

<span class="c">(* prompt until EOF *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">read_line</span> <span class="bp">()</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">num</span> <span class="o">=</span> <span class="n">int_of_string</span> <span class="n">line</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">found</span> <span class="o">=</span> <span class="n">search</span> <span class="o">!</span><span class="n">root</span> <span class="n">num</span> <span class="k">in</span>
      <span class="k">match</span> <span class="n">found</span> <span class="k">with</span>
        <span class="o">|</span> <span class="nc">Some</span> <span class="n">tree</span> <span class="o">-&gt;</span>
            <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Found %d at %s, %d</span><span class="se">\n</span><span class="s2">&quot;</span>
              <span class="n">num</span>
              <span class="o">(</span><span class="n">string_of_tree</span> <span class="n">tree</span><span class="o">)</span>
              <span class="n">tree</span><span class="o">.</span><span class="k">value</span>
        <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span>
            <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;No %d in the tree</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">num</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
    <span class="bp">()</span></PRE
></TD
></TR
></TABLE
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="subroutines.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="packagesetc.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Subroutines</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
>&nbsp;</TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Packages, Libraries, and Modules</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>
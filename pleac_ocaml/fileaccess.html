<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN""http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>File Access</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="PLEAC-Objective CAML "
HREF="index.html"><LINK
REL="PREVIOUS"
TITLE="Pattern Matching"
HREF="patternmatching.html"><LINK
REL="NEXT"
TITLE="File Contents"
HREF="filecontents.html"><style type="text/css">td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
pre { line-height: 125%; }

  </style></head
><BODY TEXT="#cecece" BGCOLOR="#4f6f6f" LINK="#f5deb3" VLINK="#d5ae83"
CLASS="SECT1"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>PLEAC-Objective CAML </TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="patternmatching.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
></TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="filecontents.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="FILEACCESS"
>7. File Access</A
></H1
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN359"
>Introduction</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="c">(* Print all lines that contain the word &quot;blue&quot; in the input file</span>
<span class="c">   /usr/local/widgets/data to stdout. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span> <span class="n">open_in</span> <span class="s2">&quot;/usr/local/widgets/data&quot;</span> <span class="k">in</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">in_channel</span> <span class="k">in</span>
      <span class="k">try</span>
        <span class="n">ignore</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp_string</span> <span class="s2">&quot;blue&quot;</span><span class="o">)</span> <span class="n">line</span> <span class="mi">0</span><span class="o">);</span>
        <span class="n">print_endline</span> <span class="n">line</span>
      <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">()</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
    <span class="n">close_in</span> <span class="n">in_channel</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;.*[0-9]&quot;</span> <span class="k">in</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="c">(* reads from stdin *)</span>
      <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">stdin</span> <span class="k">in</span>
      <span class="c">(* writes to stderr *)</span>
      <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">regexp</span> <span class="n">line</span> <span class="mi">0</span><span class="o">)</span>
      <span class="k">then</span> <span class="n">prerr_endline</span> <span class="s2">&quot;No digit found.&quot;</span><span class="o">;</span>
      <span class="c">(* writes to stdout *)</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Read: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">line</span><span class="o">;</span>
      <span class="n">flush</span> <span class="n">stdout</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
    <span class="n">close_out</span> <span class="n">stdout</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Write to an output file the usual way. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">logfile</span> <span class="o">=</span> <span class="n">open_out</span> <span class="s2">&quot;/tmp/log&quot;</span> <span class="k">in</span>
  <span class="n">output_string</span> <span class="n">logfile</span> <span class="s2">&quot;Countdown initiated...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
  <span class="n">close_out</span> <span class="n">logfile</span><span class="o">;</span>
  <span class="n">print_endline</span> <span class="s2">&quot;You have 30 seconds to reach minimum safety distance.&quot;</span>

<span class="c">(* Write to an output file using redirection. *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">logfile</span> <span class="o">=</span> <span class="n">open_out</span> <span class="s2">&quot;/tmp/log&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">old_descr</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">dup</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdout</span> <span class="k">in</span>
  <span class="c">(* switch to logfile for output *)</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">dup2</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">descr_of_out_channel</span> <span class="n">logfile</span><span class="o">)</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdout</span><span class="o">;</span>
  <span class="n">print_endline</span> <span class="s2">&quot;Countdown initiated...&quot;</span><span class="o">;</span>
  <span class="c">(* return to original output *)</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">dup2</span> <span class="n">old_descr</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdout</span><span class="o">;</span>
  <span class="n">print_endline</span> <span class="s2">&quot;You have 30 seconds to reach minimum safety distance.&quot;</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN362"
>Opening a File</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* open file &quot;path&quot; for reading only *)</span>
<span class="k">let</span> <span class="n">source</span> <span class="o">=</span>
  <span class="k">try</span> <span class="n">open_in</span> <span class="n">path</span>
  <span class="k">with</span> <span class="nc">Sys_error</span> <span class="n">msg</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="o">(</span><span class="s2">&quot;Couldn&#39;t read from &quot;</span> <span class="o">^</span> <span class="n">msg</span><span class="o">)</span>

<span class="c">(* open file &quot;path&quot; for writing only *)</span>
<span class="k">let</span> <span class="n">sink</span> <span class="o">=</span>
  <span class="k">try</span> <span class="n">open_out</span> <span class="n">path</span>
  <span class="k">with</span> <span class="nc">Sys_error</span> <span class="n">msg</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="o">(</span><span class="s2">&quot;Couldn&#39;t write to &quot;</span> <span class="o">^</span> <span class="n">msg</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="c">(* open file &quot;path&quot; for reading only *)</span>
<span class="k">let</span> <span class="n">source</span> <span class="o">=</span>
  <span class="k">try</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">openfile</span> <span class="n">path</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">O_RDONLY</span><span class="o">]</span> <span class="mo">0o644</span>
  <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="n">code</span><span class="o">,</span> <span class="n">func</span><span class="o">,</span> <span class="n">param</span><span class="o">)</span> <span class="o">-&gt;</span>
    <span class="n">failwith</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;Couldn&#39;t open %s for reading: %s&quot;</span>
                <span class="n">path</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">error_message</span> <span class="n">code</span><span class="o">))</span>

<span class="c">(* open file &quot;path&quot; for writing only *)</span>
<span class="k">let</span> <span class="n">sink</span> <span class="o">=</span>
  <span class="k">try</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">openfile</span> <span class="n">path</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">O_WRONLY</span><span class="o">;</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">O_CREAT</span><span class="o">]</span> <span class="mo">0o644</span>
  <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="n">code</span><span class="o">,</span> <span class="n">func</span><span class="o">,</span> <span class="n">param</span><span class="o">)</span> <span class="o">-&gt;</span>
    <span class="n">failwith</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;Couldn&#39;t open %s for writing: %s&quot;</span>
                <span class="n">path</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">error_message</span> <span class="n">code</span><span class="o">))</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* open file &quot;path&quot; for reading and writing *)</span>
<span class="k">let</span> <span class="n">fh</span> <span class="o">=</span>
  <span class="k">try</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">openfile</span> <span class="n">filename</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">O_RDWR</span><span class="o">]</span> <span class="mo">0o644</span>
  <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="n">code</span><span class="o">,</span> <span class="n">func</span><span class="o">,</span> <span class="n">param</span><span class="o">)</span> <span class="o">-&gt;</span>
    <span class="n">failwith</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;Couldn&#39;t open %s for read and write: %s&quot;</span>
                <span class="n">filename</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">error_message</span> <span class="n">code</span><span class="o">))</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* open file &quot;path&quot; read only *)</span>
<span class="k">let</span> <span class="n">fh</span> <span class="o">=</span> <span class="n">open_in</span> <span class="n">path</span>
<span class="k">let</span> <span class="n">fh</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">openfile</span> <span class="n">path</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">O_RDONLY</span><span class="o">]</span> <span class="mo">0o644</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* open file &quot;path&quot; write only, create it if it does not exist *)</span>
<span class="k">let</span> <span class="n">fh</span> <span class="o">=</span> <span class="n">open_out</span> <span class="n">path</span>
<span class="k">let</span> <span class="n">fh</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">openfile</span> <span class="n">path</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">O_WRONLY</span><span class="o">;</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">O_TRUNC</span><span class="o">;</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">O_CREAT</span><span class="o">]</span> <span class="mo">0o600</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* open file &quot;path&quot; write only, fails if file exists *)</span>
<span class="k">let</span> <span class="n">fh</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">openfile</span> <span class="n">path</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">O_WRONLY</span><span class="o">;</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">O_EXCL</span><span class="o">;</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">O_CREAT</span><span class="o">]</span> <span class="mo">0o600</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* open file &quot;path&quot; for appending *)</span>
<span class="k">let</span> <span class="n">fh</span> <span class="o">=</span>
  <span class="n">open_out_gen</span> <span class="o">[</span><span class="nc">Open_wronly</span><span class="o">;</span> <span class="nc">Open_append</span><span class="o">;</span> <span class="nc">Open_creat</span><span class="o">]</span> <span class="mo">0o600</span> <span class="n">path</span>
<span class="k">let</span> <span class="n">fh</span> <span class="o">=</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">openfile</span> <span class="n">path</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">O_WRONLY</span><span class="o">;</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">O_APPEND</span><span class="o">;</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">O_CREAT</span><span class="o">]</span> <span class="mo">0o600</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* open file &quot;path&quot; for appending only when file exists *)</span>
<span class="k">let</span> <span class="n">fh</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">openfile</span> <span class="n">path</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">O_WRONLY</span><span class="o">;</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">O_APPEND</span><span class="o">]</span> <span class="mo">0o600</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* open file &quot;path&quot; for reading and writing *)</span>
<span class="k">let</span> <span class="n">fh</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">openfile</span> <span class="n">path</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">O_RDWR</span><span class="o">]</span> <span class="mo">0o600</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* open file &quot;path&quot; for reading and writing,</span>
<span class="c">   create a new file if it does not exist *)</span>
<span class="k">let</span> <span class="n">fh</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">openfile</span> <span class="n">path</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">O_RDWR</span><span class="o">;</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">O_CREAT</span><span class="o">]</span> <span class="mo">0o600</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* open file &quot;path&quot; for reading and writing, fails if file exists *)</span>
<span class="k">let</span> <span class="n">fh</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">openfile</span> <span class="n">path</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">O_RDWR</span><span class="o">;</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">O_EXCL</span><span class="o">;</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">O_CREAT</span><span class="o">]</span> <span class="mo">0o600</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN365"
>Opening Files with Unusual Filenames</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* Nothing different needs to be done with OCaml *)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN368"
>Expanding Tildes in Filenames</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">expanduser</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;^~</span><span class="se">\\</span><span class="s2">([^/]*</span><span class="se">\\</span><span class="s2">)&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">replace</span> <span class="n">s</span> <span class="o">=</span>
    <span class="k">match</span> <span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">1</span> <span class="n">s</span> <span class="k">with</span>
      <span class="o">|</span> <span class="s2">&quot;&quot;</span> <span class="o">-&gt;</span>
          <span class="o">(</span><span class="k">try</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">getenv</span> <span class="s2">&quot;HOME&quot;</span>
           <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
             <span class="o">(</span><span class="k">try</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">getenv</span> <span class="s2">&quot;LOGDIR&quot;</span>
              <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
                <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">getpwuid</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">getuid</span> <span class="bp">()</span><span class="o">)).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">pw_dir</span><span class="o">))</span>
      <span class="o">|</span> <span class="n">user</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">getpwnam</span> <span class="n">user</span><span class="o">).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">pw_dir</span> <span class="k">in</span>
  <span class="nn">Str</span><span class="p">.</span><span class="n">substitute_first</span> <span class="n">regexp</span> <span class="n">replace</span>

<span class="c">(*-----------------------------*)</span>

    <span class="o">~</span><span class="n">user</span>
    <span class="o">~</span><span class="n">user</span><span class="o">/</span><span class="n">blah</span>
    <span class="o">~</span>
    <span class="o">~/</span><span class="n">blah</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN371"
>Making Perl Report Filenames in Errors</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">open</span> <span class="nc">Unix</span>

<span class="c">(* Raises an exception on failure. *)</span>
<span class="k">let</span> <span class="n">file</span> <span class="o">=</span> <span class="n">openfile</span> <span class="n">filename</span> <span class="o">[</span> <span class="nc">O_RDONLY</span> <span class="o">]</span> <span class="mo">0o640</span>

<span class="k">exception</span> <span class="nc">ErrString</span> <span class="k">of</span> <span class="kt">string</span>

<span class="k">let</span> <span class="n">file</span> <span class="o">=</span>
  <span class="k">try</span> <span class="n">openfile</span> <span class="n">filename</span> <span class="o">[</span> <span class="nc">O_RDONLY</span> <span class="o">]</span> <span class="mo">0o640</span>
  <span class="k">with</span> <span class="nc">Unix_error</span> <span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">n</span><span class="o">)</span> <span class="o">-&gt;</span>
    <span class="k">raise</span> <span class="o">(</span><span class="nc">ErrString</span>
             <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;Could not open %s for read: %s&quot;</span>
                <span class="n">n</span> <span class="o">(</span><span class="n">error_message</span> <span class="n">e</span><span class="o">)))</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN374"
>Creating Temporary Files</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* Open a new temporary file for writing. Filename.open_temp_file</span>
<span class="c">   safeguards against race conditions and returns both the filename</span>
<span class="c">   and an output channel. *)</span>
<span class="k">let</span> <span class="n">name</span><span class="o">,</span> <span class="n">out_channel</span> <span class="o">=</span> <span class="nn">Filename</span><span class="p">.</span><span class="n">open_temp_file</span> <span class="s2">&quot;prefix-&quot;</span> <span class="s2">&quot;.suffix&quot;</span>

<span class="c">(* Install an at_exit handler to remove the temporary file when this</span>
<span class="c">   program exits. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">at_exit</span> <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">remove</span> <span class="n">name</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* Open a temporary file for reading and writing. *)</span>
  <span class="k">let</span> <span class="n">name</span> <span class="o">=</span> <span class="nn">Filename</span><span class="p">.</span><span class="n">temp_file</span> <span class="s2">&quot;prefix-&quot;</span> <span class="s2">&quot;.suffix&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">descr</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">openfile</span> <span class="n">name</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">O_RDWR</span><span class="o">]</span> <span class="mo">0o600</span> <span class="k">in</span>

  <span class="c">(* Write ten lines of output. *)</span>
  <span class="k">let</span> <span class="n">out_channel</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">out_channel_of_descr</span> <span class="n">descr</span> <span class="k">in</span>
  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">to</span> <span class="mi">10</span> <span class="k">do</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">fprintf</span> <span class="n">out_channel</span> <span class="s2">&quot;%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">i</span>
  <span class="k">done</span><span class="o">;</span>
  <span class="n">flush</span> <span class="n">out_channel</span><span class="o">;</span>

  <span class="c">(* Seek to the beginning and read the lines back in. *)</span>
  <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">in_channel_of_descr</span> <span class="n">descr</span> <span class="k">in</span>
  <span class="n">seek_in</span> <span class="n">in_channel</span> <span class="mi">0</span><span class="o">;</span>
  <span class="n">print_endline</span> <span class="s2">&quot;Tmp file has:&quot;</span><span class="o">;</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span> <span class="bp">()</span> <span class="o">=</span>
    <span class="n">print_endline</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">in_channel</span><span class="o">);</span>
    <span class="n">loop</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="k">try</span> <span class="n">loop</span><span class="bp">()</span> <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">;</span>

  <span class="c">(* Close the underlying file descriptor and remove the file. *)</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="n">descr</span><span class="o">;</span>
  <span class="nn">Sys</span><span class="p">.</span><span class="n">remove</span> <span class="n">name</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN377"
>Storing Files Inside Your Program Text</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">main</span> <span class="n">data</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span>
       <span class="c">(* process the line *)</span>
       <span class="bp">()</span><span class="o">)</span>
    <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">split</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span> <span class="n">data</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">main</span> <span class="s2">&quot;\</span>
<span class="s2">your data goes here</span>
<span class="s2">&quot;</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN380"
>Writing a Filter</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">parse_args</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">match</span> <span class="nn">List</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">)</span> <span class="k">with</span>
    <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="o">[</span><span class="s2">&quot;-&quot;</span><span class="o">]</span>
    <span class="o">|</span> <span class="n">args</span> <span class="o">-&gt;</span> <span class="n">args</span>

<span class="k">let</span> <span class="n">run_filter</span> <span class="n">func</span> <span class="n">args</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">arg</span> <span class="o">-&gt;</span>
       <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span>
         <span class="k">match</span> <span class="n">arg</span> <span class="k">with</span>
           <span class="o">|</span> <span class="s2">&quot;-&quot;</span> <span class="o">-&gt;</span> <span class="n">stdin</span>
           <span class="o">|</span> <span class="n">arg</span> <span class="o">-&gt;</span> <span class="n">open_in</span> <span class="n">arg</span> <span class="k">in</span>
       <span class="k">try</span>
         <span class="k">begin</span>
           <span class="k">try</span>
             <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
               <span class="n">func</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">in_channel</span><span class="o">)</span>
             <span class="k">done</span>
           <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span>
         <span class="k">end</span><span class="o">;</span>
         <span class="n">close_in</span> <span class="n">in_channel</span>
       <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span>
         <span class="n">close_in</span> <span class="n">in_channel</span><span class="o">;</span>
         <span class="k">raise</span> <span class="n">e</span><span class="o">)</span>
    <span class="n">args</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">run_filter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span>
       <span class="c">(* do something with the line *)</span>
       <span class="bp">()</span><span class="o">)</span>
    <span class="o">(</span><span class="n">parse_args</span> <span class="bp">()</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* arg demo 1: Process optional -c flag *)</span>
<span class="k">let</span> <span class="n">chop_first</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span>
<span class="k">let</span> <span class="n">args</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">parse_args</span> <span class="bp">()</span> <span class="k">with</span>
    <span class="o">|</span> <span class="s2">&quot;-c&quot;</span> <span class="o">::</span> <span class="n">rest</span> <span class="o">-&gt;</span> <span class="n">chop_first</span> <span class="o">:=</span> <span class="bp">true</span><span class="o">;</span> <span class="n">rest</span>
    <span class="o">|</span> <span class="n">args</span> <span class="o">-&gt;</span> <span class="n">args</span>

<span class="c">(* arg demo 2: Process optional -NUMBER flag *)</span>
<span class="k">let</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">ref</span> <span class="nc">None</span>
<span class="k">let</span> <span class="n">args</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">parse_args</span> <span class="bp">()</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">arg</span> <span class="o">::</span> <span class="n">rest</span>
      <span class="k">when</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;^-</span><span class="se">\\</span><span class="s2">([0-9]+</span><span class="se">\\</span><span class="s2">)$&quot;</span><span class="o">)</span> <span class="n">arg</span> <span class="mi">0</span> <span class="o">-&gt;</span>
        <span class="n">columns</span> <span class="o">:=</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">int_of_string</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">1</span> <span class="n">arg</span><span class="o">));</span>
        <span class="n">rest</span>
    <span class="o">|</span> <span class="n">args</span> <span class="o">-&gt;</span> <span class="n">args</span>

<span class="c">(* arg demo 3: Process clustering -a, -i, -n, or -u flags *)</span>
<span class="k">let</span> <span class="n">append</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span>
<span class="k">let</span> <span class="n">ignore_ints</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span>
<span class="k">let</span> <span class="n">nostdout</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span>
<span class="k">let</span> <span class="n">unbuffer</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span>
<span class="k">let</span> <span class="n">args</span> <span class="o">=</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">parse_flags</span> <span class="o">=</span> <span class="k">function</span>
    <span class="o">|</span> <span class="s2">&quot;&quot;</span> <span class="o">-&gt;</span> <span class="bp">()</span>
    <span class="o">|</span> <span class="n">s</span> <span class="o">-&gt;</span>
        <span class="o">(</span><span class="k">match</span> <span class="n">s</span><span class="o">.[</span><span class="mi">0</span><span class="o">]</span> <span class="k">with</span>
           <span class="o">|</span> <span class="sc">&#39;a&#39;</span> <span class="o">-&gt;</span> <span class="n">append</span>      <span class="o">:=</span> <span class="bp">true</span>
           <span class="o">|</span> <span class="sc">&#39;i&#39;</span> <span class="o">-&gt;</span> <span class="n">ignore_ints</span> <span class="o">:=</span> <span class="bp">true</span>
           <span class="o">|</span> <span class="sc">&#39;n&#39;</span> <span class="o">-&gt;</span> <span class="n">nostdout</span>    <span class="o">:=</span> <span class="bp">true</span>
           <span class="o">|</span> <span class="sc">&#39;u&#39;</span> <span class="o">-&gt;</span> <span class="n">unbuffer</span>    <span class="o">:=</span> <span class="bp">true</span>
           <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span>
               <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;usage: %s [-ainu] [filenames] ...</span><span class="se">\n</span><span class="s2">&quot;</span>
                 <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">);</span>
               <span class="n">flush</span> <span class="n">stderr</span><span class="o">;</span>
               <span class="n">exit</span> <span class="mi">255</span><span class="o">);</span>
        <span class="n">parse_flags</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">s</span> <span class="mi">1</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span> <span class="o">-</span> <span class="mi">1</span><span class="o">))</span> <span class="k">in</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">rev</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">fold_left</span>
       <span class="o">(</span><span class="k">fun</span> <span class="n">acc</span> <span class="o">-&gt;</span>
          <span class="k">function</span>
            <span class="o">|</span> <span class="s2">&quot;&quot;</span> <span class="o">-&gt;</span> <span class="n">acc</span>
            <span class="o">|</span> <span class="n">s</span> <span class="k">when</span> <span class="n">s</span><span class="o">.[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="sc">&#39;-&#39;</span> <span class="o">-&gt;</span>
                <span class="n">parse_flags</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">s</span> <span class="mi">1</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span> <span class="o">-</span> <span class="mi">1</span><span class="o">));</span>
                <span class="n">acc</span>
            <span class="o">|</span> <span class="n">arg</span> <span class="o">-&gt;</span> <span class="n">arg</span> <span class="o">::</span> <span class="n">acc</span><span class="o">)</span>
       <span class="bp">[]</span>
       <span class="o">(</span><span class="n">parse_args</span> <span class="bp">()</span><span class="o">))</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* findlogin - print all lines containing the string &quot;login&quot; *)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">run_filter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span>
       <span class="k">if</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;.*login.*&quot;</span><span class="o">)</span> <span class="n">line</span> <span class="mi">0</span>
       <span class="k">then</span> <span class="n">print_endline</span> <span class="n">line</span><span class="o">)</span>
    <span class="o">(</span><span class="n">parse_args</span> <span class="bp">()</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* lowercase - turn all lines into lowercase *)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">run_filter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span> <span class="n">print_endline</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">lowercase</span> <span class="n">line</span><span class="o">))</span>
    <span class="o">(</span><span class="n">parse_args</span> <span class="bp">()</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* countchunks - count how many words are used *)</span>

<span class="k">let</span> <span class="n">chunks</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">run_filter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span>
       <span class="k">if</span> <span class="n">line</span> <span class="o">&lt;&gt;</span> <span class="s2">&quot;&quot;</span> <span class="o">&amp;&amp;</span> <span class="n">line</span><span class="o">.[</span><span class="mi">0</span><span class="o">]</span> <span class="o">==</span> <span class="sc">&#39;#&#39;</span>
       <span class="k">then</span> <span class="bp">()</span>
       <span class="k">else</span> <span class="n">chunks</span> <span class="o">:=</span> <span class="o">!</span><span class="n">chunks</span>
         <span class="o">+</span> <span class="nn">List</span><span class="p">.</span><span class="n">length</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">split</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[ </span><span class="se">\t</span><span class="s2">]+&quot;</span><span class="o">)</span> <span class="n">line</span><span class="o">))</span>
    <span class="o">(</span><span class="n">parse_args</span> <span class="bp">()</span><span class="o">);</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Found %d chunks</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">!</span><span class="n">chunks</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN383"
>Modifying a File in Place with Temporary File</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* Modify a file in place. *)</span>
<span class="k">let</span> <span class="n">modify</span> <span class="n">func</span> <span class="n">old</span> <span class="k">new&#39;</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">old_in</span> <span class="o">=</span> <span class="n">open_in</span> <span class="n">old</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">new_out</span> <span class="o">=</span> <span class="n">open_out</span> <span class="k">new&#39;</span> <span class="k">in</span>
  <span class="k">begin</span>
    <span class="k">try</span>
      <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
        <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">old_in</span> <span class="k">in</span>
        <span class="n">func</span> <span class="n">new_out</span> <span class="n">line</span>
      <span class="k">done</span>
    <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span>
  <span class="k">end</span><span class="o">;</span>
  <span class="n">close_in</span> <span class="n">old_in</span><span class="o">;</span>
  <span class="n">close_out</span> <span class="n">new_out</span><span class="o">;</span>
  <span class="nn">Sys</span><span class="p">.</span><span class="n">rename</span> <span class="n">old</span> <span class="o">(</span><span class="n">old</span> <span class="o">^</span> <span class="s2">&quot;.orig&quot;</span><span class="o">);</span>
  <span class="nn">Sys</span><span class="p">.</span><span class="n">rename</span> <span class="k">new&#39;</span> <span class="n">old</span>

<span class="c">(* Insert lines at line 20. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="n">modify</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">out</span> <span class="n">line</span> <span class="o">-&gt;</span>
       <span class="n">incr</span> <span class="n">count</span><span class="o">;</span>
       <span class="k">if</span> <span class="o">!</span><span class="n">count</span> <span class="o">=</span> <span class="mi">20</span>
       <span class="k">then</span> <span class="o">(</span><span class="n">output_string</span> <span class="n">out</span> <span class="s2">&quot;Extra line 1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
             <span class="n">output_string</span> <span class="n">out</span> <span class="s2">&quot;Extra line 2</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">);</span>
       <span class="n">output_string</span> <span class="n">out</span> <span class="n">line</span><span class="o">;</span>
       <span class="n">output_string</span> <span class="n">out</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span>
    <span class="n">old</span> <span class="k">new&#39;</span>

<span class="c">(* Delete lines 20..30. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="n">modify</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">out</span> <span class="n">line</span> <span class="o">-&gt;</span>
       <span class="n">incr</span> <span class="n">count</span><span class="o">;</span>
       <span class="k">if</span> <span class="o">!</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">20</span> <span class="o">||</span> <span class="o">!</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">30</span>
       <span class="k">then</span> <span class="o">(</span><span class="n">output_string</span> <span class="n">out</span> <span class="n">line</span><span class="o">;</span>
             <span class="n">output_string</span> <span class="n">out</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">))</span>
    <span class="n">old</span> <span class="k">new&#39;</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN386"
>Modifying a File in Place with -i Switch</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* An equivalent of Perl&#39;s -i switch does not exist in OCaml. *)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN389"
>Modifying a File in Place Without a Temporary File</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="c">(* Modify a file in place. *)</span>
<span class="k">let</span> <span class="n">modify</span> <span class="n">func</span> <span class="n">file</span> <span class="o">=</span>
  <span class="k">let</span> <span class="k">in&#39;</span> <span class="o">=</span> <span class="n">open_in</span> <span class="n">file</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="k">begin</span>
    <span class="k">try</span>
      <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
        <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="k">in&#39;</span> <span class="k">in</span>
        <span class="n">lines</span> <span class="o">:=</span> <span class="n">func</span> <span class="n">line</span> <span class="o">::</span> <span class="o">!</span><span class="n">lines</span>
      <span class="k">done</span>
    <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span>
  <span class="k">end</span><span class="o">;</span>
  <span class="n">close_in</span> <span class="k">in&#39;</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="o">!</span><span class="n">lines</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">out</span> <span class="o">=</span> <span class="n">open_out</span> <span class="n">file</span> <span class="k">in</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span>
       <span class="n">output_string</span> <span class="n">out</span> <span class="n">line</span><span class="o">;</span>
       <span class="n">output_string</span> <span class="n">out</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span>
    <span class="n">lines</span><span class="o">;</span>
  <span class="n">close_out</span> <span class="n">out</span>

<span class="c">(* Replace DATE with the current date. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">tm</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">localtime</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">time</span> <span class="bp">()</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">date</span> <span class="o">=</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;%02d/%02d/%04d&quot;</span>
    <span class="o">(</span><span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_mon</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span>
    <span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_mday</span>
    <span class="o">(</span><span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_year</span> <span class="o">+</span> <span class="mi">1900</span><span class="o">)</span> <span class="k">in</span>
  <span class="n">modify</span>
    <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">global_replace</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;DATE&quot;</span><span class="o">)</span> <span class="n">date</span><span class="o">)</span>
    <span class="n">infile</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN392"
>Locking a File</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">descr</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">openfile</span> <span class="n">path</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">O_RDWR</span><span class="o">]</span> <span class="mo">0o664</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">lockf</span> <span class="n">descr</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">F_LOCK</span> <span class="mi">0</span><span class="o">;</span>
  <span class="c">(* update file, then ... *)</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="n">descr</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">lockf</span> <span class="n">descr</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">F_TLOCK</span> <span class="mi">0</span>
  <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="n">error</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span>
      <span class="s2">&quot;can&#39;t immediately write-lock the file (%s), blocking ...</span><span class="se">\n</span><span class="s2">&quot;</span>
      <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">error_message</span> <span class="n">error</span><span class="o">);</span>
    <span class="n">flush</span> <span class="n">stderr</span><span class="o">;</span>
    <span class="nn">Unix</span><span class="p">.</span><span class="n">lockf</span> <span class="n">descr</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">F_LOCK</span> <span class="mi">0</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">descr</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">openfile</span> <span class="s2">&quot;numfile&quot;</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">O_RDWR</span><span class="o">;</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">O_CREAT</span><span class="o">]</span> <span class="mo">0o664</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">lockf</span> <span class="n">descr</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">F_LOCK</span> <span class="mi">0</span><span class="o">;</span>
  <span class="c">(* Now we have acquired the lock, it&#39;s safe for I/O *)</span>
  <span class="k">let</span> <span class="n">num</span> <span class="o">=</span>
    <span class="k">try</span> <span class="n">int_of_string</span> <span class="o">(</span><span class="n">input_line</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">in_channel_of_descr</span> <span class="n">descr</span><span class="o">))</span>
    <span class="k">with</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">lseek</span> <span class="n">descr</span> <span class="mi">0</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">SEEK_SET</span><span class="o">);</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">ftruncate</span> <span class="n">descr</span> <span class="mi">0</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">out</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">out_channel_of_descr</span> <span class="n">descr</span> <span class="k">in</span>
  <span class="n">output_string</span> <span class="n">out</span> <span class="o">(</span><span class="n">string_of_int</span> <span class="o">(</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="o">));</span>
  <span class="n">output_string</span> <span class="n">out</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
  <span class="n">flush</span> <span class="n">out</span><span class="o">;</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="n">descr</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN395"
>Flushing Output</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* OCaml automatically flushes after calling these functions: *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">print_endline</span> <span class="s2">&quot;I get flushed.&quot;</span><span class="o">;</span>
  <span class="n">print_newline</span> <span class="bp">()</span><span class="o">;</span> <span class="c">(* Me too! *)</span>
  <span class="n">prerr_endline</span> <span class="s2">&quot;So do I.&quot;</span><span class="o">;</span>
  <span class="n">prerr_newline</span> <span class="bp">()</span> <span class="c">(* As do I. *)</span>

<span class="c">(* The Printf functions allow a format specifier of &quot;%!&quot; to trigger</span>
<span class="c">   an immediate flush. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;I flush %s%! and %s!</span><span class="se">\n</span><span class="s2">%!&quot;</span> <span class="s2">&quot;here&quot;</span> <span class="s2">&quot;there&quot;</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* seeme - demo stdio output buffering *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">output_string</span> <span class="n">stdout</span> <span class="s2">&quot;Now you don&#39;t see it...&quot;</span><span class="o">;</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">sleep</span> <span class="mi">2</span><span class="o">;</span>
  <span class="n">print_endline</span> <span class="s2">&quot;now you do&quot;</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* A channel can be explicitly flushed: *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">flush</span> <span class="n">stderr</span>

<span class="c">(* All channels can be flushed at once (errors are ignored): *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">flush_all</span> <span class="bp">()</span>

<span class="c">(* Closing a channel flushes automatically: *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">output_string</span> <span class="n">stdout</span> <span class="s2">&quot;I get written.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
  <span class="n">close_out</span> <span class="n">stdout</span>

<span class="c">(* Calls to exit result in a flush_all, and exit is always called at</span>
<span class="c">   termination even if an error occurs. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">output_string</span> <span class="n">stderr</span> <span class="s2">&quot;Bye!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
  <span class="n">exit</span> <span class="mi">0</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN398"
>Reading from Many Filehandles Without Blocking</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* list all file descriptors to poll *)</span>
  <span class="k">let</span> <span class="n">readers</span> <span class="o">=</span> <span class="o">[</span><span class="n">file_descr1</span><span class="o">;</span> <span class="n">file_descr2</span><span class="o">;</span> <span class="n">file_descr3</span><span class="o">]</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">ready</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">select</span> <span class="n">readers</span> <span class="bp">[]</span> <span class="bp">[]</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span> <span class="k">in</span>
  <span class="c">(* input waiting on the filehandles in &quot;ready&quot; *)</span>
  <span class="bp">()</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">in_channel_of_descr</span> <span class="n">file_descr</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">found</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">select</span> <span class="o">[</span><span class="n">file_descr</span><span class="o">]</span> <span class="bp">[]</span> <span class="bp">[]</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span> <span class="c">(* just check *)</span> <span class="k">in</span>
  <span class="k">match</span> <span class="n">found</span> <span class="k">with</span>
    <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="bp">()</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span>
        <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">in_channel</span> <span class="k">in</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;I read %s</span><span class="se">\n</span><span class="s2">%!&quot;</span> <span class="n">line</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN401"
>Doing Non-Blocking I/O</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="c">(* Pass the O_NONBLOCK flag when calling Unix.openfile. *)</span>
<span class="k">let</span> <span class="n">file_descr</span> <span class="o">=</span>
  <span class="k">try</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">openfile</span> <span class="s2">&quot;/dev/cua0&quot;</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">O_RDWR</span><span class="o">;</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">O_NONBLOCK</span><span class="o">]</span> <span class="mo">0o666</span>
  <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="n">code</span><span class="o">,</span> <span class="n">func</span><span class="o">,</span> <span class="n">param</span><span class="o">)</span> <span class="o">-&gt;</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Can&#39;t open modem: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">error_message</span> <span class="n">code</span><span class="o">);</span>
    <span class="n">exit</span> <span class="mi">2</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* If the file descriptor already exists, use Unix.set_nonblock. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">set_nonblock</span> <span class="n">file_descr</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* In non-blocking mode, calls that would block throw exceptions. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">chars_written</span> <span class="o">=</span>
    <span class="k">try</span>
      <span class="nc">Some</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">single_write</span> <span class="n">file_descr</span> <span class="n">buffer</span> <span class="mi">0</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">buffer</span><span class="o">))</span>
    <span class="k">with</span>
      <span class="o">|</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">EAGAIN</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span>
      <span class="o">|</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">EWOULDBLOCK</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="o">-&gt;</span> <span class="nc">None</span> <span class="k">in</span>
  <span class="k">match</span> <span class="n">chars_written</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">Some</span> <span class="n">n</span> <span class="k">when</span> <span class="n">n</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">buffer</span> <span class="o">-&gt;</span>
        <span class="c">(* successfully wrote *)</span>
        <span class="bp">()</span>
    <span class="o">|</span> <span class="nc">Some</span> <span class="n">n</span> <span class="o">-&gt;</span>
        <span class="c">(* incomplete write *)</span>
        <span class="bp">()</span>
    <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span>
        <span class="c">(* would block *)</span>
        <span class="bp">()</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">chars_read</span> <span class="o">=</span>
    <span class="k">try</span>
      <span class="nc">Some</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">read</span> <span class="n">file_descr</span> <span class="n">buffer</span> <span class="mi">0</span> <span class="n">buffer_size</span><span class="o">)</span>
    <span class="k">with</span>
      <span class="o">|</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">EAGAIN</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span>
      <span class="o">|</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">EWOULDBLOCK</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="o">-&gt;</span> <span class="nc">None</span> <span class="k">in</span>
  <span class="k">match</span> <span class="n">chars_read</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">Some</span> <span class="n">n</span> <span class="o">-&gt;</span>
        <span class="c">(* successfully read n bytes from file_descr *)</span>
        <span class="bp">()</span>
    <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span>
        <span class="c">(* would block *)</span>
        <span class="bp">()</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN404"
>Determining the Number of Bytes to Read</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="c">(* OCaml does not expose the FIONREAD ioctl call. It&#39;s better to use</span>
<span class="c">   non-blocking reads anyway. There is the following function in</span>
<span class="c">   Pervasives which gives you the length of an input channel, but it</span>
<span class="c">   works by doing a seek so it only works on regular files: *)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">length</span> <span class="o">=</span> <span class="n">in_channel_length</span> <span class="n">in_channel</span> <span class="k">in</span>
  <span class="c">(* ... *)</span>
  <span class="bp">()</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN407"
>Storing Filehandles in Variables</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* Channels and file descriptors are ordinary, first-class values in</span>
<span class="c">   OCaml. No special contortions are necessary to store them in data</span>
<span class="c">   structures, pass them as arguments, etc. *)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN410"
>Caching Open Output Filehandles</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="k">module</span> <span class="nc">FileCache</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">let</span> <span class="n">isopen</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span>
  <span class="k">let</span> <span class="n">maxopen</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">16</span>

  <span class="k">let</span> <span class="n">resize</span> <span class="bp">()</span> <span class="o">=</span>
    <span class="k">if</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">length</span> <span class="n">isopen</span> <span class="o">&gt;=</span> <span class="o">!</span><span class="n">maxopen</span>
    <span class="k">then</span>
      <span class="k">begin</span>
        <span class="k">let</span> <span class="n">newlen</span> <span class="o">=</span> <span class="o">!</span><span class="n">maxopen</span> <span class="o">/</span> <span class="mi">3</span> <span class="k">in</span>
        <span class="k">let</span> <span class="n">items</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
        <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span>
          <span class="o">(</span><span class="k">fun</span> <span class="n">filename</span> <span class="o">(</span><span class="n">chan</span><span class="o">,</span> <span class="n">count</span><span class="o">)</span> <span class="o">-&gt;</span>
             <span class="n">items</span> <span class="o">:=</span> <span class="o">(</span><span class="n">count</span><span class="o">,</span> <span class="n">filename</span><span class="o">,</span> <span class="n">chan</span><span class="o">)</span> <span class="o">::</span> <span class="o">!</span><span class="n">items</span><span class="o">)</span>
          <span class="n">isopen</span><span class="o">;</span>
        <span class="k">let</span> <span class="n">items</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">of_list</span> <span class="o">!</span><span class="n">items</span> <span class="k">in</span>
        <span class="nn">Array</span><span class="p">.</span><span class="n">sort</span> <span class="n">compare</span> <span class="n">items</span><span class="o">;</span>
        <span class="k">let</span> <span class="n">pivot</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">items</span> <span class="o">-</span> <span class="n">newlen</span> <span class="k">in</span>
        <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">to</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">items</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">do</span>
          <span class="k">let</span> <span class="o">(</span><span class="n">count</span><span class="o">,</span> <span class="n">filename</span><span class="o">,</span> <span class="n">chan</span><span class="o">)</span> <span class="o">=</span> <span class="n">items</span><span class="o">.(</span><span class="n">i</span><span class="o">)</span> <span class="k">in</span>
          <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pivot</span>
          <span class="k">then</span> <span class="o">(</span><span class="n">close_out</span> <span class="n">chan</span><span class="o">;</span>
                <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">remove</span> <span class="n">isopen</span> <span class="n">filename</span><span class="o">)</span>
          <span class="k">else</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">isopen</span> <span class="n">filename</span> <span class="o">(</span><span class="n">chan</span><span class="o">,</span> <span class="mi">0</span><span class="o">))</span>
        <span class="k">done</span>
      <span class="k">end</span>

  <span class="k">let</span> <span class="n">output</span> <span class="o">?(</span><span class="n">mode</span><span class="o">=[</span><span class="nc">Open_creat</span><span class="o">;</span> <span class="nc">Open_append</span><span class="o">])</span> <span class="o">?(</span><span class="n">perm</span><span class="o">=</span><span class="mo">0o640</span><span class="o">)</span> <span class="n">filename</span> <span class="n">data</span> <span class="o">=</span>
    <span class="k">let</span> <span class="o">(</span><span class="n">chan</span><span class="o">,</span> <span class="n">count</span><span class="o">)</span> <span class="o">=</span>
      <span class="k">try</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">isopen</span> <span class="n">filename</span>
      <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
        <span class="n">resize</span> <span class="bp">()</span><span class="o">;</span>
        <span class="o">(</span><span class="n">open_out_gen</span> <span class="n">mode</span> <span class="n">perm</span> <span class="n">filename</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span> <span class="k">in</span>
    <span class="n">output_string</span> <span class="n">chan</span> <span class="n">data</span><span class="o">;</span>
    <span class="n">flush</span> <span class="n">chan</span><span class="o">;</span>
    <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">isopen</span> <span class="n">filename</span> <span class="o">(</span><span class="n">chan</span><span class="o">,</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span>

  <span class="k">let</span> <span class="n">close</span> <span class="n">filename</span> <span class="o">=</span>
    <span class="k">try</span>
      <span class="k">match</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">isopen</span> <span class="n">filename</span> <span class="k">with</span> <span class="o">(</span><span class="n">chan</span><span class="o">,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
        <span class="n">close_out</span> <span class="n">chan</span><span class="o">;</span>
        <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">remove</span> <span class="n">isopen</span> <span class="n">filename</span>
    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">()</span>
<span class="k">end</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* splitwulog - split wuftpd log by authenticated user *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">outdir</span> <span class="o">=</span> <span class="s2">&quot;/var/log/ftp/by-user&quot;</span>
<span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot; &quot;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">stdin</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">chunks</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">of_list</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">split</span> <span class="n">regexp</span> <span class="n">line</span><span class="o">)</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">user</span> <span class="o">=</span> <span class="n">chunks</span><span class="o">.(</span><span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">chunks</span> <span class="o">-</span> <span class="mi">5</span><span class="o">)</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">path</span> <span class="o">=</span> <span class="nn">Filename</span><span class="p">.</span><span class="n">concat</span> <span class="n">outdir</span> <span class="n">user</span> <span class="k">in</span>
      <span class="nn">FileCache</span><span class="p">.</span><span class="n">output</span> <span class="n">path</span> <span class="o">(</span><span class="n">line</span> <span class="o">^</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN413"
>Printing to Many Filehandles Simultaneously</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* Save your channels in a list and iterate through them normally. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">channel</span> <span class="o">-&gt;</span>
       <span class="n">output_string</span> <span class="n">channel</span> <span class="n">stuff_to_print</span><span class="o">)</span>
    <span class="n">channels</span>

<span class="c">(* For convenience, you can define a helper function and use currying. *)</span>
<span class="k">let</span> <span class="n">write</span> <span class="n">data</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">output_string</span> <span class="n">channel</span> <span class="n">data</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="n">write</span> <span class="n">stuff_to_print</span><span class="o">)</span> <span class="n">channels</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Open a pipe to &quot;tee&quot;. Requires a Unix environment. *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">channel</span> <span class="o">=</span>
    <span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_out</span> <span class="s2">&quot;tee file1 file2 file3 &gt;/dev/null&quot;</span> <span class="k">in</span>
  <span class="n">output_string</span> <span class="n">channel</span> <span class="s2">&quot;whatever</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_out</span> <span class="n">channel</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Redirect standard output to a tee. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">reader</span><span class="o">,</span> <span class="n">writer</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">pipe</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="k">match</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">fork</span> <span class="bp">()</span> <span class="k">with</span>
    <span class="o">|</span> <span class="mi">0</span> <span class="o">-&gt;</span>
        <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="n">writer</span><span class="o">;</span>
        <span class="nn">Unix</span><span class="p">.</span><span class="n">dup2</span> <span class="n">reader</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span><span class="o">;</span>
        <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="n">reader</span><span class="o">;</span>
        <span class="nn">Unix</span><span class="p">.</span><span class="n">execvp</span> <span class="s2">&quot;tee&quot;</span> <span class="o">[|</span> <span class="s2">&quot;tee&quot;</span><span class="o">;</span> <span class="s2">&quot;file1&quot;</span><span class="o">;</span> <span class="s2">&quot;file2&quot;</span><span class="o">;</span> <span class="s2">&quot;file3&quot;</span> <span class="o">|]</span>
    <span class="o">|</span> <span class="n">pid</span> <span class="o">-&gt;</span>
        <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="n">reader</span><span class="o">;</span>
        <span class="nn">Unix</span><span class="p">.</span><span class="n">dup2</span> <span class="n">writer</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdout</span><span class="o">;</span>
        <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="n">writer</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">print_endline</span> <span class="s2">&quot;whatever&quot;</span><span class="o">;</span>
  <span class="n">close_out</span> <span class="n">stdout</span><span class="o">;</span>
  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">wait</span> <span class="bp">()</span><span class="o">)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN416"
>Opening and Closing File Descriptors by Number</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* An abstraction barrier exists between file descriptor numbers and</span>
<span class="c">   file_descr values, but Ocamlnet provides functions in the Netsys</span>
<span class="c">   module to map between the two. *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+netsys&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;netsys.cma&quot;</span><span class="o">;;</span>

<span class="c">(* Open the descriptor itself. *)</span>
<span class="k">let</span> <span class="n">file_descr</span> <span class="o">=</span> <span class="nn">Netsys</span><span class="p">.</span><span class="n">file_descr_of_int</span> <span class="n">fdnum</span>
<span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">in_channel_of_descr</span> <span class="n">file_descr</span>

<span class="c">(* Open a copy of the descriptor. *)</span>
<span class="k">let</span> <span class="n">file_descr</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">dup</span> <span class="o">(</span><span class="nn">Netsys</span><span class="p">.</span><span class="n">file_descr_of_int</span> <span class="n">fdnum</span><span class="o">)</span>
<span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">in_channel_of_descr</span> <span class="n">file_descr</span>

<span class="c">(* After processing... *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">close_in</span> <span class="n">in_channel</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN419"
>Copying Filehandles</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* Take copies of the file descriptors. *)</span>
  <span class="k">let</span> <span class="n">oldout</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">dup</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdout</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">olderr</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">dup</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stderr</span> <span class="k">in</span>

  <span class="c">(* Redirect stdout and stderr. *)</span>
  <span class="k">let</span> <span class="n">output</span> <span class="o">=</span>
    <span class="nn">Unix</span><span class="p">.</span><span class="n">openfile</span>
      <span class="s2">&quot;/tmp/program.out&quot;</span>
      <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">O_WRONLY</span><span class="o">;</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">O_CREAT</span><span class="o">;</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">O_TRUNC</span><span class="o">]</span>
      <span class="mo">0o666</span> <span class="k">in</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">dup2</span> <span class="n">output</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdout</span><span class="o">;</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="n">output</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">copy</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">dup</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdout</span> <span class="k">in</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">dup2</span> <span class="n">copy</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stderr</span><span class="o">;</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="n">copy</span><span class="o">;</span>

  <span class="c">(* Run the program. *)</span>
  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">system</span> <span class="n">joe_random_process</span><span class="o">);</span>

  <span class="c">(* Close the redirected file handles. *)</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdout</span><span class="o">;</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stderr</span><span class="o">;</span>

  <span class="c">(* Restore stdout and stderr. *)</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">dup2</span> <span class="n">oldout</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdout</span><span class="o">;</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">dup2</span> <span class="n">olderr</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stderr</span><span class="o">;</span>

  <span class="c">(* Avoid leaks by closing the independent copies. *)</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="n">oldout</span><span class="o">;</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="n">olderr</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN422"
>Program: netlock</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="n">drivelock</span><span class="o">.</span><span class="n">ml</span><span class="o">:</span>

<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* drivelock - demo LockDir module *)</span>
<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;netlock.ml&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">die</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">prerr_endline</span> <span class="n">msg</span><span class="o">;</span> <span class="n">exit</span> <span class="mi">1</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Sys</span><span class="p">.</span><span class="n">set_signal</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigint</span>
    <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="nc">Signal_handle</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">die</span> <span class="s2">&quot;outta here&quot;</span><span class="o">));</span>
  <span class="nn">LockDir</span><span class="p">.</span><span class="n">debug</span> <span class="o">:=</span> <span class="bp">true</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">path</span> <span class="o">=</span>
    <span class="k">try</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span>
    <span class="k">with</span> <span class="nc">Invalid_argument</span> <span class="o">_</span> <span class="o">-&gt;</span>
      <span class="n">die</span> <span class="o">(</span><span class="s2">&quot;usage: &quot;</span> <span class="o">^</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span> <span class="o">^</span> <span class="s2">&quot; &lt;path&gt;&quot;</span><span class="o">)</span> <span class="k">in</span>
  <span class="o">(</span><span class="k">try</span> <span class="nn">LockDir</span><span class="p">.</span><span class="n">nflock</span> <span class="o">~</span><span class="n">naptime</span><span class="o">:</span><span class="mi">2</span> <span class="n">path</span>
   <span class="k">with</span> <span class="nn">LockDir</span><span class="p">.</span><span class="nc">Error</span> <span class="o">_</span> <span class="o">-&gt;</span>
     <span class="n">die</span> <span class="o">(</span><span class="s2">&quot;couldn&#39;t lock &quot;</span> <span class="o">^</span> <span class="n">path</span> <span class="o">^</span> <span class="s2">&quot; in 2 seconds&quot;</span><span class="o">));</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">sleep</span> <span class="mi">100</span><span class="o">;</span>
  <span class="nn">LockDir</span><span class="p">.</span><span class="n">nunflock</span> <span class="n">path</span>

<span class="c">(*-----------------------------*)</span>

<span class="n">netlock</span><span class="o">.</span><span class="n">ml</span><span class="o">:</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="c">(* module to provide very basic filename-level *)</span>
<span class="c">(* locks.  No fancy systems calls.  In theory, *)</span>
<span class="c">(* directory info is sync&#39;d over NFS.  Not *)</span>
<span class="c">(* stress tested. *)</span>

<span class="k">module</span> <span class="nc">LockDir</span> <span class="o">:</span>
<span class="k">sig</span>

  <span class="k">exception</span> <span class="nc">Error</span> <span class="k">of</span> <span class="kt">string</span>

  <span class="k">val</span> <span class="n">debug</span> <span class="o">:</span> <span class="kt">bool</span> <span class="n">ref</span>
  <span class="k">val</span> <span class="n">check</span> <span class="o">:</span> <span class="kt">int</span> <span class="n">ref</span>
  <span class="k">val</span> <span class="n">nflock</span> <span class="o">:</span> <span class="o">?</span><span class="n">naptime</span><span class="o">:</span><span class="kt">int</span> <span class="o">-&gt;</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="kt">unit</span>
  <span class="k">val</span> <span class="n">nunflock</span> <span class="o">:</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="kt">unit</span>

<span class="k">end</span> <span class="o">=</span> <span class="k">struct</span>

  <span class="k">exception</span> <span class="nc">Error</span> <span class="k">of</span> <span class="kt">string</span>

  <span class="k">let</span> <span class="n">debug</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span>
  <span class="k">let</span> <span class="n">check</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">1</span>

  <span class="k">module</span> <span class="nc">StringSet</span> <span class="o">=</span> <span class="nn">Set</span><span class="p">.</span><span class="nc">Make</span><span class="o">(</span><span class="nc">String</span><span class="o">)</span>
  <span class="k">let</span> <span class="n">locked_files</span> <span class="o">=</span> <span class="n">ref</span> <span class="nn">StringSet</span><span class="p">.</span><span class="n">empty</span>

  <span class="c">(* helper function *)</span>
  <span class="k">let</span> <span class="n">name2lock</span> <span class="n">pathname</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">dir</span> <span class="o">=</span> <span class="nn">Filename</span><span class="p">.</span><span class="n">dirname</span> <span class="n">pathname</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">file</span> <span class="o">=</span> <span class="nn">Filename</span><span class="p">.</span><span class="n">basename</span> <span class="n">pathname</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">dir</span> <span class="o">=</span> <span class="k">if</span> <span class="n">dir</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span> <span class="k">then</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">getcwd</span> <span class="bp">()</span> <span class="k">else</span> <span class="n">dir</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">lockname</span> <span class="o">=</span> <span class="nn">Filename</span><span class="p">.</span><span class="n">concat</span> <span class="n">dir</span> <span class="o">(</span><span class="n">file</span> <span class="o">^</span> <span class="s2">&quot;.LOCKDIR&quot;</span><span class="o">)</span> <span class="k">in</span>
    <span class="n">lockname</span>

  <span class="k">let</span> <span class="n">nflock</span> <span class="o">?(</span><span class="n">naptime</span><span class="o">=</span><span class="mi">0</span><span class="o">)</span> <span class="n">pathname</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">lockname</span> <span class="o">=</span> <span class="n">name2lock</span> <span class="n">pathname</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">whosegot</span> <span class="o">=</span> <span class="nn">Filename</span><span class="p">.</span><span class="n">concat</span> <span class="n">lockname</span> <span class="s2">&quot;owner&quot;</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">start</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">time</span> <span class="bp">()</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">missed</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>

    <span class="c">(* if locking what I&#39;ve already locked, raise exception *)</span>
    <span class="k">if</span> <span class="nn">StringSet</span><span class="p">.</span><span class="n">mem</span> <span class="n">pathname</span> <span class="o">!</span><span class="n">locked_files</span>
    <span class="k">then</span> <span class="k">raise</span> <span class="o">(</span><span class="nc">Error</span> <span class="o">(</span><span class="n">pathname</span> <span class="o">^</span> <span class="s2">&quot; already locked&quot;</span><span class="o">));</span>

    <span class="nn">Unix</span><span class="p">.</span><span class="n">access</span> <span class="o">(</span><span class="nn">Filename</span><span class="p">.</span><span class="n">dirname</span> <span class="n">pathname</span><span class="o">)</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">W_OK</span><span class="o">];</span>

    <span class="k">begin</span>
      <span class="k">try</span>
        <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
          <span class="k">try</span>
            <span class="nn">Unix</span><span class="p">.</span><span class="n">mkdir</span> <span class="n">lockname</span> <span class="mo">0o777</span><span class="o">;</span>
            <span class="k">raise</span> <span class="nc">Exit</span>
          <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
            <span class="n">incr</span> <span class="n">missed</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">!</span><span class="n">missed</span> <span class="o">&gt;</span> <span class="mi">10</span>
            <span class="k">then</span> <span class="k">raise</span> <span class="o">(</span><span class="nc">Error</span>
                          <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;can&#39;t get %s: %s&quot;</span>
                             <span class="n">lockname</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">error_message</span> <span class="n">e</span><span class="o">)));</span>
            <span class="k">if</span> <span class="o">!</span><span class="n">debug</span>
            <span class="k">then</span>
              <span class="k">begin</span>
                <span class="k">let</span> <span class="n">owner</span> <span class="o">=</span> <span class="n">open_in</span> <span class="n">whosegot</span> <span class="k">in</span>
                <span class="k">let</span> <span class="n">lockee</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">owner</span> <span class="k">in</span>
                <span class="n">close_in</span> <span class="n">owner</span><span class="o">;</span>
                <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s[%d]: lock on %s held by %s</span><span class="se">\n</span><span class="s2">%!&quot;</span>
                  <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">getpid</span> <span class="bp">()</span><span class="o">)</span> <span class="n">pathname</span> <span class="n">lockee</span>
              <span class="k">end</span><span class="o">;</span>
            <span class="nn">Unix</span><span class="p">.</span><span class="n">sleep</span> <span class="o">!</span><span class="n">check</span><span class="o">;</span>
            <span class="k">if</span> <span class="n">naptime</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">time</span> <span class="bp">()</span> <span class="o">&gt;</span> <span class="n">start</span> <span class="o">+.</span> <span class="kt">float</span> <span class="n">naptime</span>
            <span class="k">then</span> <span class="k">raise</span> <span class="nc">Exit</span>
        <span class="k">done</span>
      <span class="k">with</span> <span class="nc">Exit</span> <span class="o">-&gt;</span> <span class="bp">()</span>
    <span class="k">end</span><span class="o">;</span>

    <span class="k">let</span> <span class="n">owner</span> <span class="o">=</span>
      <span class="k">try</span>
        <span class="n">open_out_gen</span> <span class="o">[</span><span class="nc">Open_wronly</span><span class="o">;</span> <span class="nc">Open_creat</span><span class="o">;</span> <span class="nc">Open_excl</span><span class="o">]</span> <span class="mo">0o666</span> <span class="n">whosegot</span>
      <span class="k">with</span> <span class="nc">Sys_error</span> <span class="n">e</span> <span class="o">-&gt;</span>
        <span class="k">raise</span> <span class="o">(</span><span class="nc">Error</span> <span class="o">(</span><span class="s2">&quot;can&#39;t create &quot;</span> <span class="o">^</span> <span class="n">e</span><span class="o">))</span> <span class="k">in</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">fprintf</span> <span class="n">owner</span> <span class="s2">&quot;%s[%d] on %s</span><span class="se">\n</span><span class="s2">&quot;</span>
      <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">getpid</span> <span class="bp">()</span><span class="o">)</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">gethostname</span> <span class="bp">()</span><span class="o">);</span>
    <span class="n">close_out</span> <span class="n">owner</span><span class="o">;</span>
    <span class="n">locked_files</span> <span class="o">:=</span> <span class="nn">StringSet</span><span class="p">.</span><span class="n">add</span> <span class="n">pathname</span> <span class="o">!</span><span class="n">locked_files</span>

  <span class="c">(* free the locked file *)</span>
  <span class="k">let</span> <span class="n">nunflock</span> <span class="n">pathname</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">lockname</span> <span class="o">=</span> <span class="n">name2lock</span> <span class="n">pathname</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">whosegot</span> <span class="o">=</span> <span class="nn">Filename</span><span class="p">.</span><span class="n">concat</span> <span class="n">lockname</span> <span class="s2">&quot;owner&quot;</span> <span class="k">in</span>
    <span class="nn">Unix</span><span class="p">.</span><span class="n">unlink</span> <span class="n">whosegot</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">!</span><span class="n">debug</span> <span class="k">then</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;releasing lock on %s</span><span class="se">\n</span><span class="s2">%!&quot;</span> <span class="n">lockname</span><span class="o">;</span>
    <span class="n">locked_files</span> <span class="o">:=</span> <span class="nn">StringSet</span><span class="p">.</span><span class="n">remove</span> <span class="n">pathname</span> <span class="o">!</span><span class="n">locked_files</span><span class="o">;</span>
    <span class="nn">Unix</span><span class="p">.</span><span class="n">rmdir</span> <span class="n">lockname</span>

  <span class="c">(* anything forgotten? *)</span>
  <span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
    <span class="n">at_exit</span>
      <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span>
         <span class="nn">StringSet</span><span class="p">.</span><span class="n">iter</span>
           <span class="o">(</span><span class="k">fun</span> <span class="n">pathname</span> <span class="o">-&gt;</span>
              <span class="k">let</span> <span class="n">lockname</span> <span class="o">=</span> <span class="n">name2lock</span> <span class="n">pathname</span> <span class="k">in</span>
              <span class="k">let</span> <span class="n">whosegot</span> <span class="o">=</span> <span class="nn">Filename</span><span class="p">.</span><span class="n">concat</span> <span class="n">lockname</span> <span class="s2">&quot;owner&quot;</span> <span class="k">in</span>
              <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;releasing forgotten %s</span><span class="se">\n</span><span class="s2">%!&quot;</span> <span class="n">lockname</span><span class="o">;</span>
              <span class="nn">Unix</span><span class="p">.</span><span class="n">unlink</span> <span class="n">whosegot</span><span class="o">;</span>
              <span class="nn">Unix</span><span class="p">.</span><span class="n">rmdir</span> <span class="n">lockname</span><span class="o">)</span>
           <span class="o">!</span><span class="n">locked_files</span><span class="o">)</span>
<span class="k">end</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN425"
>Program: lockarea</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* The &quot;fcntl&quot; system call is not available in the OCaml standard library.</span>
<span class="c">   You would have to drop down to C in order to lock regions of a file as</span>
<span class="c">   described in the original Perl recipe. *)</span></PRE
></TD
></TR
></TABLE
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="patternmatching.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="filecontents.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Pattern Matching</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
>&nbsp;</TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>File Contents</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN""http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>File Contents</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="PLEAC-Objective CAML "
HREF="index.html"><LINK
REL="PREVIOUS"
TITLE="File Access"
HREF="fileaccess.html"><LINK
REL="NEXT"
TITLE="Directories"
HREF="directories.html"><style type="text/css">td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
pre { line-height: 125%; }

  </style></head
><BODY TEXT="#cecece" BGCOLOR="#4f6f6f" LINK="#f5deb3" VLINK="#d5ae83"
CLASS="SECT1"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>PLEAC-Objective CAML </TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="fileaccess.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
></TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="directories.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="FILECONTENTS"
>8. File Contents</A
></H1
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN430"
>Introduction</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">datafile</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">size</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">line</span> <span class="k">in</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">size</span>             <span class="c">(* output size of line *)</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">line_stream_of_channel</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">channel</span><span class="o">)</span> <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="nc">None</span><span class="o">)</span>

<span class="k">let</span> <span class="n">output_size</span> <span class="n">line</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">line</span><span class="o">)</span> <span class="c">(* output size of line *)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">iter</span> <span class="n">output_size</span> <span class="o">(</span><span class="n">line_stream_of_channel</span> <span class="n">datafile</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">lines</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">xs</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">xs</span> <span class="o">:=</span> <span class="n">x</span> <span class="o">::</span> <span class="o">!</span><span class="n">xs</span><span class="o">)</span>
    <span class="o">(</span><span class="n">line_stream_of_channel</span> <span class="n">datafile</span><span class="o">);</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="o">!</span><span class="n">xs</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">slurp_channel</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">buffer_size</span> <span class="o">=</span> <span class="mi">4096</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">create</span> <span class="n">buffer_size</span> <span class="k">in</span>
  <span class="k">let</span> <span class="kt">string</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">create</span> <span class="n">buffer_size</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">chars_read</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">1</span> <span class="k">in</span>
  <span class="k">while</span> <span class="o">!</span><span class="n">chars_read</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="k">do</span>
    <span class="n">chars_read</span> <span class="o">:=</span> <span class="n">input</span> <span class="n">channel</span> <span class="kt">string</span> <span class="mi">0</span> <span class="n">buffer_size</span><span class="o">;</span>
    <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_substring</span> <span class="n">buffer</span> <span class="kt">string</span> <span class="mi">0</span> <span class="o">!</span><span class="n">chars_read</span>
  <span class="k">done</span><span class="o">;</span>
  <span class="nn">Buffer</span><span class="p">.</span><span class="n">contents</span> <span class="n">buffer</span>

<span class="k">let</span> <span class="n">slurp_file</span> <span class="n">filename</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">open_in_bin</span> <span class="n">filename</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">result</span> <span class="o">=</span>
    <span class="k">try</span> <span class="n">slurp_channel</span> <span class="n">channel</span>
    <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">close_in</span> <span class="n">channel</span><span class="o">;</span> <span class="k">raise</span> <span class="n">e</span> <span class="k">in</span>
  <span class="n">close_in</span> <span class="n">channel</span><span class="o">;</span>
  <span class="n">result</span>

<span class="k">let</span> <span class="n">whole_file</span> <span class="o">=</span> <span class="n">slurp_file</span> <span class="n">filename</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* Onetwothree *)</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="n">output_string</span> <span class="n">handle</span><span class="o">)</span> <span class="o">[</span><span class="s2">&quot;One&quot;</span><span class="o">;</span> <span class="s2">&quot;two&quot;</span><span class="o">;</span> <span class="s2">&quot;three&quot;</span><span class="o">];</span>

  <span class="c">(* Sent to default output handle *)</span>
  <span class="n">print_string</span> <span class="s2">&quot;Baa baa black sheep</span><span class="se">\n</span><span class="s2">&quot;</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="mi">4096</span> <span class="sc">&#39;\000&#39;</span>
<span class="k">let</span> <span class="n">rv</span> <span class="o">=</span> <span class="n">input</span> <span class="n">handle</span> <span class="n">buffer</span> <span class="mi">0</span> <span class="mi">4096</span>
<span class="c">(* rv is the number of bytes read, *)</span>
<span class="c">(* buffer holds the data read *)</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">ftruncate</span> <span class="n">descr</span> <span class="n">length</span><span class="o">;</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">truncate</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;/tmp/%d.pid&quot;</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">getpid</span> <span class="bp">()</span><span class="o">))</span> <span class="n">length</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">pos_in</span> <span class="n">datafile</span> <span class="k">in</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;I&#39;m %d bytes from the start of datafile.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">pos</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">seek_in</span> <span class="n">in_channel</span> <span class="n">pos</span><span class="o">;</span>
  <span class="n">seek_out</span> <span class="n">out_channel</span> <span class="n">pos</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">lseek</span> <span class="n">descr</span> <span class="mi">0</span>     <span class="nn">Unix</span><span class="p">.</span><span class="nc">SEEK_END</span><span class="o">;</span> <span class="c">(* seek to the end    *)</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">lseek</span> <span class="n">descr</span> <span class="n">pos</span>   <span class="nn">Unix</span><span class="p">.</span><span class="nc">SEEK_SET</span><span class="o">;</span> <span class="c">(* seek to pos        *)</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">lseek</span> <span class="n">descr</span> <span class="o">(-</span><span class="mi">20</span><span class="o">)</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">SEEK_CUR</span><span class="o">;</span> <span class="c">(* seek back 20 bytes *)</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">written</span> <span class="o">=</span>
    <span class="nn">Unix</span><span class="p">.</span><span class="n">write</span> <span class="n">datafile</span> <span class="n">mystring</span> <span class="mi">0</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">mystring</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">read</span> <span class="o">=</span>
    <span class="nn">Unix</span><span class="p">.</span><span class="n">read</span> <span class="n">datafile</span> <span class="n">mystring</span> <span class="mi">5</span> <span class="mi">256</span> <span class="k">in</span>
  <span class="k">if</span> <span class="n">read</span> <span class="o">&lt;&gt;</span> <span class="mi">256</span> <span class="k">then</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;only read %d bytes, not 256</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">read</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* don&#39;t change position *)</span>
  <span class="k">let</span> <span class="n">pos</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">lseek</span> <span class="n">handle</span> <span class="mi">0</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">SEEK_CUR</span> <span class="k">in</span>
  <span class="c">(* ... *)</span>
  <span class="bp">()</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN433"
>Reading Lines with Continuation Characters</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">create</span> <span class="mi">16</span> <span class="k">in</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span> <span class="bp">()</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">chan</span> <span class="k">in</span>
    <span class="k">if</span> <span class="n">line</span> <span class="o">&lt;&gt;</span> <span class="s2">&quot;&quot;</span> <span class="o">&amp;&amp;</span> <span class="n">line</span><span class="o">.[</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">line</span> <span class="o">-</span> <span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="sc">&#39;\\&#39;</span>
    <span class="k">then</span> <span class="o">(</span><span class="nn">Buffer</span><span class="p">.</span><span class="n">add_string</span>
            <span class="n">buffer</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">line</span> <span class="mi">0</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">line</span> <span class="o">-</span> <span class="mi">1</span><span class="o">));</span>
          <span class="n">loop</span> <span class="bp">()</span><span class="o">)</span>
    <span class="k">else</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_string</span> <span class="n">buffer</span> <span class="n">line</span><span class="o">;</span>
    <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">contents</span> <span class="n">buffer</span> <span class="k">in</span>
    <span class="nn">Buffer</span><span class="p">.</span><span class="n">clear</span> <span class="n">buffer</span><span class="o">;</span>
    <span class="c">(* process full record in line here *)</span>
    <span class="n">loop</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="k">try</span> <span class="n">loop</span> <span class="bp">()</span> <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN436"
>Counting Lines (or Paragraphs or Records) in a File</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">proc</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_in</span> <span class="o">(</span><span class="s2">&quot;wc -l &lt; &quot;</span> <span class="o">^</span> <span class="n">file</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">count</span> <span class="o">=</span> <span class="n">int_of_string</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">proc</span><span class="o">)</span> <span class="k">in</span>
  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_in</span> <span class="n">proc</span><span class="o">);</span>
  <span class="c">(* count now holds the number of lines read *)</span>
  <span class="bp">()</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">open_in</span> <span class="n">file</span> <span class="k">in</span>
  <span class="o">(</span><span class="k">try</span>
     <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
       <span class="n">ignore</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">chan</span><span class="o">);</span>
       <span class="n">incr</span> <span class="n">count</span>
     <span class="k">done</span>
   <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="n">close_in</span> <span class="n">chan</span><span class="o">);</span>
  <span class="c">(* !count now holds the number of lines read *)</span>
  <span class="bp">()</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">delim</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[ </span><span class="se">\n\r\t</span><span class="s2">]*$&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">in_para</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">open_in</span> <span class="n">file</span> <span class="k">in</span>
  <span class="o">(</span><span class="k">try</span>
     <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
       <span class="k">if</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">delim</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">chan</span><span class="o">)</span> <span class="mi">0</span>
       <span class="k">then</span> <span class="n">in_para</span> <span class="o">:=</span> <span class="bp">false</span>
       <span class="k">else</span> <span class="k">begin</span>
         <span class="k">if</span> <span class="n">not</span> <span class="o">!</span><span class="n">in_para</span> <span class="k">then</span> <span class="n">incr</span> <span class="n">count</span><span class="o">;</span>
         <span class="n">in_para</span> <span class="o">:=</span> <span class="bp">true</span>
       <span class="k">end</span>
     <span class="k">done</span>
   <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="n">close_in</span> <span class="n">chan</span><span class="o">);</span>
  <span class="c">(* !count now holds the number of paragraphs read *)</span>
  <span class="bp">()</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN439"
>Processing Every Word in a File</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="k">let</span> <span class="n">word_stream_of_channel</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="c">(* Thanks to Mac Mason for figuring this out. *)</span>
  <span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="o">(</span><span class="nn">Scanf</span><span class="p">.</span><span class="nn">Scanning</span><span class="p">.</span><span class="n">from_channel</span> <span class="n">channel</span><span class="o">)</span> <span class="k">in</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">count</span> <span class="o">-&gt;</span>
       <span class="k">try</span>
         <span class="k">match</span> <span class="nn">Scanf</span><span class="p">.</span><span class="n">bscanf</span> <span class="n">buffer</span> <span class="s2">&quot; %s &quot;</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">)</span> <span class="k">with</span>
           <span class="o">|</span> <span class="s2">&quot;&quot;</span> <span class="o">-&gt;</span> <span class="nc">None</span>
           <span class="o">|</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="nc">Some</span> <span class="n">s</span>
       <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
         <span class="nc">None</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">chunk</span> <span class="o">-&gt;</span>
       <span class="c">(* do something with chunk *)</span>
       <span class="bp">()</span><span class="o">)</span>
    <span class="o">(</span><span class="n">word_stream_of_channel</span> <span class="n">stdin</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Make a word frequency count *)</span>
<span class="k">let</span> <span class="n">seen</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">word</span> <span class="o">-&gt;</span>
       <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">seen</span> <span class="n">word</span>
         <span class="o">(</span><span class="k">try</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">seen</span> <span class="n">word</span> <span class="o">+</span> <span class="mi">1</span>
          <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="mi">1</span><span class="o">))</span>
    <span class="o">(</span><span class="n">word_stream_of_channel</span> <span class="n">stdin</span><span class="o">)</span>

<span class="c">(* output hash in a descending numeric sort of its values *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">words</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">word</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">words</span> <span class="o">:=</span> <span class="n">word</span> <span class="o">::</span> <span class="o">!</span><span class="n">words</span><span class="o">)</span> <span class="n">seen</span><span class="o">;</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">word</span> <span class="o">-&gt;</span>
       <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%5d %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">seen</span> <span class="n">word</span><span class="o">)</span> <span class="n">word</span><span class="o">)</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">sort</span>
       <span class="o">(</span><span class="k">fun</span> <span class="n">a</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">compare</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">seen</span> <span class="n">b</span><span class="o">)</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">seen</span> <span class="n">a</span><span class="o">))</span>
       <span class="o">!</span><span class="n">words</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Line frequency count *)</span>

<span class="k">let</span> <span class="n">line_stream_of_channel</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">channel</span><span class="o">)</span> <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="nc">None</span><span class="o">)</span>

<span class="k">let</span> <span class="n">seen</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span>
       <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">seen</span> <span class="n">line</span>
         <span class="o">(</span><span class="k">try</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">seen</span> <span class="n">line</span> <span class="o">+</span> <span class="mi">1</span>
          <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="mi">1</span><span class="o">))</span>
    <span class="o">(</span><span class="n">line_stream_of_channel</span> <span class="n">stdin</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">lines</span> <span class="o">:=</span> <span class="n">line</span> <span class="o">::</span> <span class="o">!</span><span class="n">lines</span><span class="o">)</span> <span class="n">seen</span><span class="o">;</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span>
       <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%5d %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">seen</span> <span class="n">line</span><span class="o">)</span> <span class="n">line</span><span class="o">)</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">sort</span>
       <span class="o">(</span><span class="k">fun</span> <span class="n">a</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">compare</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">seen</span> <span class="n">b</span><span class="o">)</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">seen</span> <span class="n">a</span><span class="o">))</span>
       <span class="o">!</span><span class="n">lines</span><span class="o">)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN442"
>Reading a File Backwards by Line or Paragraph</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="n">lines</span> <span class="o">:=</span> <span class="n">input_line</span> <span class="n">chan</span> <span class="o">::</span> <span class="o">!</span><span class="n">lines</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span>
       <span class="c">(* do something with line *)</span>
       <span class="bp">()</span><span class="o">)</span>
    <span class="o">!</span><span class="n">lines</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN445"
>Trailing a Growing File</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">sometime</span> <span class="o">=</span> <span class="mi">1</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">open_in</span> <span class="n">file</span> <span class="k">in</span>
  <span class="k">while</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">file_exists</span> <span class="n">file</span> <span class="k">do</span>
    <span class="o">(</span><span class="k">try</span>
       <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">chan</span> <span class="k">in</span>
       <span class="c">(* ... *)</span>
       <span class="bp">()</span>
     <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
       <span class="nn">Unix</span><span class="p">.</span><span class="n">sleep</span> <span class="n">sometime</span><span class="o">)</span>
  <span class="k">done</span><span class="o">;</span>
  <span class="n">close_in</span> <span class="n">chan</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN448"
>Picking a Random Line from a File</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Random</span><span class="p">.</span><span class="n">self_init</span> <span class="bp">()</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">1</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">ref</span> <span class="s2">&quot;&quot;</span> <span class="k">in</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="k">let</span> <span class="n">next</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">stdin</span> <span class="k">in</span>
      <span class="k">if</span> <span class="nn">Random</span><span class="p">.</span><span class="n">int</span> <span class="o">!</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="k">then</span> <span class="n">line</span> <span class="o">:=</span> <span class="n">next</span><span class="o">;</span>
      <span class="n">incr</span> <span class="n">count</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
    <span class="c">(* !line is the random line *)</span>
    <span class="bp">()</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN451"
>Randomizing All Lines</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* assumes the fisher_yates_shuffle function from Chapter 4 *)</span>
<span class="k">let</span> <span class="n">shuffle</span> <span class="kt">list</span> <span class="o">=</span>
  <span class="k">let</span> <span class="kt">array</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">of_list</span> <span class="kt">list</span> <span class="k">in</span>
  <span class="n">fisher_yates_shuffle</span> <span class="kt">array</span><span class="o">;</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="kt">array</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Random</span><span class="p">.</span><span class="n">self_init</span> <span class="bp">()</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="o">(</span><span class="k">try</span>
     <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
       <span class="n">lines</span> <span class="o">:=</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">input</span><span class="o">)</span> <span class="o">::</span> <span class="o">!</span><span class="n">lines</span>
     <span class="k">done</span>
   <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">);</span>
  <span class="k">let</span> <span class="n">reordered</span> <span class="o">=</span> <span class="n">shuffle</span> <span class="o">!</span><span class="n">lines</span> <span class="k">in</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span>
       <span class="n">output_string</span> <span class="n">output</span> <span class="n">line</span><span class="o">;</span>
       <span class="n">output_char</span> <span class="n">output</span> <span class="sc">&#39;\n&#39;</span><span class="o">)</span>
    <span class="n">reordered</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN454"
>Reading a Particular Line in a File</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* Read lines until the desired line number is found. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">ref</span> <span class="s2">&quot;&quot;</span> <span class="k">in</span>
  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">to</span> <span class="n">desired_line_number</span> <span class="k">do</span> <span class="n">line</span> <span class="o">:=</span> <span class="n">input_line</span> <span class="n">handle</span> <span class="k">done</span><span class="o">;</span>
  <span class="n">print_endline</span> <span class="o">!</span><span class="n">line</span>

<span class="c">(* Read lines into an array. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="o">(</span><span class="k">try</span> <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span> <span class="n">lines</span> <span class="o">:=</span> <span class="n">input_line</span> <span class="n">handle</span> <span class="o">::</span> <span class="o">!</span><span class="n">lines</span> <span class="k">done</span>
   <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">);</span>
  <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">of_list</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="o">!</span><span class="n">lines</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.(</span><span class="n">desired_line_number</span><span class="o">)</span> <span class="k">in</span>
  <span class="n">print_endline</span> <span class="n">line</span>

<span class="c">(* Build an index file containing line offsets. *)</span>
<span class="k">let</span> <span class="n">build_index</span> <span class="n">data_file</span> <span class="n">index_file</span> <span class="o">=</span>
  <span class="n">set_binary_mode_out</span> <span class="n">index_file</span> <span class="bp">true</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="n">ignore</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">data_file</span><span class="o">);</span>
      <span class="n">output_binary_int</span> <span class="n">index_file</span> <span class="o">!</span><span class="n">offset</span><span class="o">;</span>
      <span class="n">offset</span> <span class="o">:=</span> <span class="n">pos_in</span> <span class="n">data_file</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
    <span class="n">flush</span> <span class="n">index_file</span>

<span class="c">(* Read a line using the index file. *)</span>
<span class="k">let</span> <span class="n">line_with_index</span> <span class="n">data_file</span> <span class="n">index_file</span> <span class="n">line_number</span> <span class="o">=</span>
  <span class="n">set_binary_mode_in</span> <span class="n">index_file</span> <span class="bp">true</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">4</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">i_offset</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="o">(</span><span class="n">line_number</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="k">in</span>
  <span class="n">seek_in</span> <span class="n">index_file</span> <span class="n">i_offset</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">d_offset</span> <span class="o">=</span> <span class="n">input_binary_int</span> <span class="n">index_file</span> <span class="k">in</span>
  <span class="n">seek_in</span> <span class="n">data_file</span> <span class="n">d_offset</span><span class="o">;</span>
  <span class="n">input_line</span> <span class="n">data_file</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* print_line-v1 - linear style *)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="o">&lt;&gt;</span> <span class="mi">3</span>
  <span class="k">then</span> <span class="o">(</span><span class="n">prerr_endline</span> <span class="s2">&quot;usage: print_line FILENAME LINE_NUMBER&quot;</span><span class="o">;</span> <span class="n">exit</span> <span class="mi">255</span><span class="o">);</span>

  <span class="k">let</span> <span class="n">filename</span> <span class="o">=</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">line_number</span> <span class="o">=</span> <span class="n">int_of_string</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">2</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">infile</span> <span class="o">=</span>
    <span class="k">try</span> <span class="n">open_in</span> <span class="n">filename</span>
    <span class="k">with</span> <span class="nc">Sys_error</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">prerr_endline</span> <span class="n">e</span><span class="o">;</span> <span class="n">exit</span> <span class="mi">255</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">ref</span> <span class="s2">&quot;&quot;</span> <span class="k">in</span>
  <span class="k">begin</span>
    <span class="k">try</span>
      <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">to</span> <span class="n">line_number</span> <span class="k">do</span> <span class="n">line</span> <span class="o">:=</span> <span class="n">input_line</span> <span class="n">infile</span> <span class="k">done</span>
    <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Didn&#39;t find line %d in %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">line_number</span> <span class="n">filename</span><span class="o">;</span>
      <span class="n">exit</span> <span class="mi">255</span>
  <span class="k">end</span><span class="o">;</span>
  <span class="n">print_endline</span> <span class="o">!</span><span class="n">line</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* print_line-v2 - index style *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>
<span class="c">(* build_index and line_with_index from above *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="o">&lt;&gt;</span> <span class="mi">3</span>
  <span class="k">then</span> <span class="o">(</span><span class="n">prerr_endline</span> <span class="s2">&quot;usage: print_line FILENAME LINE_NUMBER&quot;</span><span class="o">;</span> <span class="n">exit</span> <span class="mi">255</span><span class="o">);</span>

  <span class="k">let</span> <span class="n">filename</span> <span class="o">=</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">line_number</span> <span class="o">=</span> <span class="n">int_of_string</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">2</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">orig</span> <span class="o">=</span>
    <span class="k">try</span> <span class="n">open_in</span> <span class="n">filename</span>
    <span class="k">with</span> <span class="nc">Sys_error</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">prerr_endline</span> <span class="n">e</span><span class="o">;</span> <span class="n">exit</span> <span class="mi">255</span><span class="o">)</span> <span class="k">in</span>

  <span class="c">(* open the index and build it if necessary *)</span>
  <span class="c">(* there&#39;s a race condition here: two copies of this *)</span>
  <span class="c">(* program can notice there&#39;s no index for the file and *)</span>
  <span class="c">(* try to build one.  This would be easily solved with *)</span>
  <span class="c">(* locking *)</span>
  <span class="k">let</span> <span class="n">indexname</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">^</span> <span class="s2">&quot;.index&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">idx</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">openfile</span> <span class="n">indexname</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">O_CREAT</span><span class="o">;</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">O_RDWR</span><span class="o">]</span> <span class="mo">0o666</span> <span class="k">in</span>
  <span class="n">build_index</span> <span class="n">orig</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">out_channel_of_descr</span> <span class="n">idx</span><span class="o">);</span>

  <span class="k">let</span> <span class="n">line</span> <span class="o">=</span>
    <span class="k">try</span>
      <span class="n">line_with_index</span> <span class="n">orig</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">in_channel_of_descr</span> <span class="n">idx</span><span class="o">)</span> <span class="n">line_number</span>
    <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Didn&#39;t find line %d in %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">line_number</span> <span class="n">filename</span><span class="o">;</span>
      <span class="n">exit</span> <span class="mi">255</span> <span class="k">in</span>
  <span class="n">print_endline</span> <span class="n">line</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN457"
>Processing Variable-Length Text Fields</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* given &quot;record&quot; with field separated by &quot;pattern&quot;,</span>
<span class="c">   extract &quot;fields&quot;. *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="n">pattern</span>
<span class="k">let</span> <span class="n">fields</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">split_delim</span> <span class="n">regexp</span> <span class="n">record</span>

<span class="c">(* same as above using PCRE library, available at:</span>
<span class="c">   http://www.ocaml.info/home/ocaml_sources.html#pcre-ocaml *)</span>
<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+pcre&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;pcre.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">fields</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">split</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="n">pattern</span> <span class="n">record</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#</span> <span class="nn">Str</span><span class="p">.</span><span class="n">full_split</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[+-]&quot;</span><span class="o">)</span> <span class="s2">&quot;3+5-2&quot;</span><span class="o">;;</span>
<span class="o">-</span> <span class="o">:</span> <span class="nn">Str</span><span class="p">.</span><span class="n">split_result</span> <span class="kt">list</span> <span class="o">=</span>
<span class="o">[</span><span class="nn">Str</span><span class="p">.</span><span class="nc">Text</span> <span class="s2">&quot;3&quot;</span><span class="o">;</span> <span class="nn">Str</span><span class="p">.</span><span class="nc">Delim</span> <span class="s2">&quot;+&quot;</span><span class="o">;</span> <span class="nn">Str</span><span class="p">.</span><span class="nc">Text</span> <span class="s2">&quot;5&quot;</span><span class="o">;</span> <span class="nn">Str</span><span class="p">.</span><span class="nc">Delim</span> <span class="s2">&quot;-&quot;</span><span class="o">;</span> <span class="nn">Str</span><span class="p">.</span><span class="nc">Text</span> <span class="s2">&quot;2&quot;</span><span class="o">]</span>

<span class="o">#</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">split</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;([+-])&quot;</span> <span class="s2">&quot;3+5-2&quot;</span><span class="o">;;</span>
<span class="o">-</span> <span class="o">:</span> <span class="kt">string</span> <span class="kt">list</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;3&quot;</span><span class="o">;</span> <span class="s2">&quot;+&quot;</span><span class="o">;</span> <span class="s2">&quot;5&quot;</span><span class="o">;</span> <span class="s2">&quot;-&quot;</span><span class="o">;</span> <span class="s2">&quot;2&quot;</span><span class="o">]</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">fields</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">split_delim</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;:&quot;</span><span class="o">)</span> <span class="n">record</span>
<span class="k">let</span> <span class="n">fields</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">split_delim</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[ </span><span class="se">\n\r\t</span><span class="s2">]+&quot;</span><span class="o">)</span> <span class="n">record</span>
<span class="k">let</span> <span class="n">fields</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">split_delim</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot; &quot;</span><span class="o">)</span> <span class="n">record</span>

<span class="k">let</span> <span class="n">fields</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">split</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;:&quot;</span> <span class="n">record</span>
<span class="k">let</span> <span class="n">fields</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">split</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">s+&quot;</span> <span class="n">record</span>
<span class="k">let</span> <span class="n">fields</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">split</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot; &quot;</span> <span class="n">record</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN460"
>Removing the Last Line of a File</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">descr</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">openfile</span> <span class="n">file</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">O_RDWR</span><span class="o">]</span> <span class="mo">0o666</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">in_channel_of_descr</span> <span class="n">descr</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">position</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">last_position</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="k">begin</span>
    <span class="k">try</span>
      <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
        <span class="n">ignore</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">in_channel</span><span class="o">);</span>
        <span class="n">last_position</span> <span class="o">:=</span> <span class="o">!</span><span class="n">position</span><span class="o">;</span>
        <span class="n">position</span> <span class="o">:=</span> <span class="n">pos_in</span> <span class="n">in_channel</span><span class="o">;</span>
      <span class="k">done</span>
    <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span>
  <span class="k">end</span><span class="o">;</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">ftruncate</span> <span class="n">descr</span> <span class="o">!</span><span class="n">last_position</span><span class="o">;</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="n">descr</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN463"
>Processing Binary Files</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="n">set_binary_mode_in</span> <span class="n">in_channel</span> <span class="bp">true</span>
<span class="n">set_binary_mode_out</span> <span class="n">out_channel</span> <span class="bp">true</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">gifname</span> <span class="o">=</span> <span class="s2">&quot;picture.gif&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">gif</span> <span class="o">=</span> <span class="n">open_in</span> <span class="n">gifname</span> <span class="k">in</span>
  <span class="n">set_binary_mode_in</span> <span class="n">gif</span> <span class="bp">true</span><span class="o">;</span>
  <span class="c">(* now DOS won&#39;t mangle binary input from &quot;gif&quot; *)</span>
  <span class="n">set_binary_mode_out</span> <span class="n">stdout</span> <span class="bp">true</span><span class="o">;</span>
  <span class="c">(* now DOS won&#39;t mangle binary output to &quot;stdout&quot; *)</span>
  <span class="k">let</span> <span class="n">buff</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="mi">8192</span> <span class="sc">&#39;\000&#39;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">len</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(-</span><span class="mi">1</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">while</span> <span class="o">!</span><span class="n">len</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="k">do</span>
    <span class="n">len</span> <span class="o">:=</span> <span class="n">input</span> <span class="n">gif</span> <span class="n">buff</span> <span class="mi">0</span> <span class="mi">8192</span><span class="o">;</span>
    <span class="n">output</span> <span class="n">stdout</span> <span class="n">buff</span> <span class="mi">0</span> <span class="o">!</span><span class="n">len</span>
  <span class="k">done</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN466"
>Using Random-Access I/O</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">address</span> <span class="o">=</span> <span class="n">recsize</span> <span class="o">*</span> <span class="n">recno</span> <span class="k">in</span>
  <span class="n">seek_in</span> <span class="n">fh</span> <span class="n">address</span><span class="o">;</span>
  <span class="n">really_input</span> <span class="n">fh</span> <span class="n">buffer</span> <span class="mi">0</span> <span class="n">recsize</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">address</span> <span class="o">=</span> <span class="n">recsize</span> <span class="o">*</span> <span class="o">(</span><span class="n">recno</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="k">in</span>
  <span class="c">(* ... *)</span>
  <span class="bp">()</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN469"
>Updating a Random-Access File</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">address</span> <span class="o">=</span> <span class="n">recsize</span> <span class="o">*</span> <span class="n">recno</span> <span class="k">in</span>
  <span class="n">seek_in</span> <span class="n">in_channel</span> <span class="n">address</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">create</span> <span class="n">recsize</span> <span class="k">in</span>
  <span class="n">really_input</span> <span class="n">in_channel</span> <span class="n">buffer</span> <span class="mi">0</span> <span class="n">recsize</span><span class="o">;</span>
  <span class="n">close_in</span> <span class="n">in_channel</span><span class="o">;</span>
  <span class="c">(* update fields, then *)</span>
  <span class="n">seek_out</span> <span class="n">out_channel</span> <span class="n">address</span><span class="o">;</span>
  <span class="n">output_string</span> <span class="n">out_channel</span> <span class="n">buffer</span><span class="o">;</span>
  <span class="n">close_out</span> <span class="n">out_channel</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* weekearly -- set someone&#39;s login date back a week *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">sizeof</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">+</span> <span class="mi">16</span>
<span class="k">let</span> <span class="n">user</span> <span class="o">=</span>
  <span class="k">if</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="o">&gt;</span> <span class="mi">1</span>
  <span class="k">then</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span>
  <span class="k">else</span> <span class="o">(</span><span class="k">try</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">getenv</span> <span class="s2">&quot;USER&quot;</span>
        <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">getenv</span> <span class="s2">&quot;LOGNAME&quot;</span><span class="o">)</span>

<span class="k">let</span> <span class="n">address</span> <span class="o">=</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">getpwnam</span> <span class="n">user</span><span class="o">).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">pw_uid</span> <span class="o">*</span> <span class="n">sizeof</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">lastlog</span> <span class="o">=</span> <span class="n">open_in</span> <span class="s2">&quot;/var/log/lastlog&quot;</span> <span class="k">in</span>
  <span class="n">seek_in</span> <span class="n">lastlog</span> <span class="n">address</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="mi">12</span> <span class="sc">&#39; &#39;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">host</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="mi">16</span> <span class="sc">&#39; &#39;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">time</span> <span class="o">=</span> <span class="n">input_binary_int</span> <span class="n">lastlog</span> <span class="k">in</span>
  <span class="n">really_input</span> <span class="n">lastlog</span> <span class="n">line</span> <span class="mi">0</span> <span class="mi">12</span><span class="o">;</span>
  <span class="n">really_input</span> <span class="n">lastlog</span> <span class="n">host</span> <span class="mi">0</span> <span class="mi">16</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">create</span> <span class="n">sizeof</span> <span class="k">in</span>
  <span class="n">really_input</span> <span class="n">lastlog</span> <span class="n">buffer</span> <span class="mi">0</span> <span class="n">sizeof</span><span class="o">;</span>
  <span class="n">close_in</span> <span class="n">lastlog</span><span class="o">;</span>

  <span class="k">let</span> <span class="n">time</span> <span class="o">=</span> <span class="n">time</span> <span class="o">-</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">7</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="k">in</span> <span class="c">(* back-date a week *)</span>

  <span class="k">let</span> <span class="n">lastlog</span> <span class="o">=</span> <span class="n">open_out_gen</span> <span class="o">[</span><span class="nc">Open_wronly</span><span class="o">]</span> <span class="mo">0o666</span> <span class="s2">&quot;/var/log/lastlog&quot;</span> <span class="k">in</span>
  <span class="n">seek_out</span> <span class="n">lastlog</span> <span class="n">address</span><span class="o">;</span>
  <span class="n">output_binary_int</span> <span class="n">lastlog</span> <span class="n">time</span><span class="o">;</span>
  <span class="n">close_out</span> <span class="n">lastlog</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN472"
>Reading a String from a Binary File</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span> <span class="n">open_in_bin</span> <span class="n">file</span> <span class="k">in</span>
  <span class="n">seek_in</span> <span class="n">in_channel</span> <span class="n">addr</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="n">input_char</span> <span class="n">in_channel</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">while</span> <span class="o">!</span><span class="n">ch</span> <span class="o">&lt;&gt;</span> <span class="sc">&#39;\000&#39;</span> <span class="k">do</span>
    <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_char</span> <span class="n">buffer</span> <span class="o">!</span><span class="n">ch</span><span class="o">;</span>
    <span class="n">ch</span> <span class="o">:=</span> <span class="n">input_char</span> <span class="n">in_channel</span><span class="o">;</span>
  <span class="k">done</span><span class="o">;</span>
  <span class="n">close_in</span> <span class="n">in_channel</span><span class="o">;</span>
  <span class="k">let</span> <span class="kt">string</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">contents</span> <span class="n">buffer</span> <span class="k">in</span>
  <span class="n">print_endline</span> <span class="kt">string</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* bgets - get a string from an address in a binary file *)</span>
<span class="k">open</span> <span class="nc">Printf</span>

<span class="k">let</span> <span class="n">file</span><span class="o">,</span> <span class="n">addrs</span> <span class="o">=</span>
  <span class="k">match</span> <span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="k">with</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">::</span> <span class="n">file</span> <span class="o">::</span> <span class="n">addrs</span> <span class="k">when</span> <span class="nn">List</span><span class="p">.</span><span class="n">length</span> <span class="n">addrs</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">-&gt;</span> <span class="n">file</span><span class="o">,</span> <span class="n">addrs</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">eprintf</span> <span class="s2">&quot;usage: %s file addr ...</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">);</span> <span class="n">exit</span> <span class="mi">0</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span> <span class="n">open_in_bin</span> <span class="n">file</span> <span class="k">in</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">addr</span> <span class="o">-&gt;</span>
       <span class="k">let</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">int_of_string</span> <span class="n">addr</span> <span class="k">in</span>
       <span class="n">seek_in</span> <span class="n">in_channel</span> <span class="n">addr</span><span class="o">;</span>
       <span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span> <span class="k">in</span>
       <span class="k">let</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="n">input_char</span> <span class="n">in_channel</span><span class="o">)</span> <span class="k">in</span>
       <span class="k">while</span> <span class="o">!</span><span class="n">ch</span> <span class="o">&lt;&gt;</span> <span class="sc">&#39;\000&#39;</span> <span class="k">do</span>
         <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_char</span> <span class="n">buffer</span> <span class="o">!</span><span class="n">ch</span><span class="o">;</span>
         <span class="n">ch</span> <span class="o">:=</span> <span class="n">input_char</span> <span class="n">in_channel</span><span class="o">;</span>
       <span class="k">done</span><span class="o">;</span>
       <span class="n">printf</span> <span class="s2">&quot;%#x %#o %d </span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span>
         <span class="n">addr</span> <span class="n">addr</span> <span class="n">addr</span> <span class="o">(</span><span class="nn">Buffer</span><span class="p">.</span><span class="n">contents</span> <span class="n">buffer</span><span class="o">))</span>
    <span class="n">addrs</span><span class="o">;</span>
  <span class="n">close_in</span> <span class="n">in_channel</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* strings - pull strings out of a binary file *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">find_strings</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">pat</span> <span class="o">=</span> <span class="s2">&quot;[</span><span class="se">\040</span><span class="s2">-</span><span class="se">\176\r\n\t</span><span class="s2"> ]&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="o">(</span><span class="n">pat</span> <span class="o">^</span> <span class="n">pat</span> <span class="o">^</span> <span class="n">pat</span> <span class="o">^</span> <span class="n">pat</span> <span class="o">^</span> <span class="s2">&quot;+&quot;</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">fun</span> <span class="n">f</span> <span class="n">input</span> <span class="o">-&gt;</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
      <span class="o">(</span><span class="k">function</span> <span class="nn">Str</span><span class="p">.</span><span class="nc">Delim</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="kt">string</span> <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">)</span>
      <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">full_split</span> <span class="n">regexp</span> <span class="n">input</span><span class="o">)</span>

<span class="k">let</span> <span class="n">file</span> <span class="o">=</span>
  <span class="k">try</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span>
  <span class="k">with</span> <span class="nc">Invalid_argument</span> <span class="o">_</span> <span class="o">-&gt;</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;usage: %s file</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">);</span>
    <span class="n">exit</span> <span class="mi">0</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span> <span class="n">open_in_bin</span> <span class="n">file</span> <span class="k">in</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="n">input_char</span> <span class="n">in_channel</span><span class="o">)</span> <span class="k">in</span>
      <span class="k">while</span> <span class="o">!</span><span class="n">ch</span> <span class="o">&lt;&gt;</span> <span class="sc">&#39;\000&#39;</span> <span class="k">do</span>
        <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_char</span> <span class="n">buffer</span> <span class="o">!</span><span class="n">ch</span><span class="o">;</span>
        <span class="n">ch</span> <span class="o">:=</span> <span class="n">input_char</span> <span class="n">in_channel</span><span class="o">;</span>
      <span class="k">done</span><span class="o">;</span>
      <span class="n">find_strings</span> <span class="n">print_endline</span> <span class="o">(</span><span class="nn">Buffer</span><span class="p">.</span><span class="n">contents</span> <span class="n">buffer</span><span class="o">)</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
    <span class="n">close_in</span> <span class="n">in_channel</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN475"
>Reading Fixed-Length Records</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* Using the Bitstring library by Richard W.M. Jones.</span>
<span class="c">   http://code.google.com/p/bitstring/ *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="k">let</span> <span class="n">bitstring</span> <span class="o">=</span> <span class="nn">Bitstring</span><span class="p">.</span><span class="n">bitstring_of_chan_max</span> <span class="n">file</span> <span class="n">recordsize</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">fields</span> <span class="o">=</span> <span class="n">unpack</span> <span class="n">bitstring</span> <span class="k">in</span>
      <span class="c">(* ... *)</span>
      <span class="bp">()</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">Match_failure</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Layout based on /usr/include/bits/utmp.h for a Linux system. *)</span>
<span class="k">let</span> <span class="n">recordsize</span> <span class="o">=</span> <span class="mi">384</span>
<span class="k">let</span> <span class="n">unpack</span> <span class="n">bits</span> <span class="o">=</span>
  <span class="n">bitmatch</span> <span class="n">bits</span> <span class="k">with</span>
    <span class="o">|</span> <span class="o">{</span> <span class="n">ut_type</span> <span class="o">:</span> <span class="mi">16</span> <span class="o">:</span> <span class="n">littleendian</span><span class="o">;</span>
        <span class="o">_</span> <span class="o">:</span> <span class="mi">16</span><span class="o">;</span> <span class="c">(* padding *)</span>
        <span class="n">ut_pid</span> <span class="o">:</span> <span class="mi">32</span> <span class="o">:</span> <span class="n">littleendian</span><span class="o">;</span>
        <span class="n">ut_line</span> <span class="o">:</span> <span class="mi">256</span> <span class="o">:</span> <span class="kt">string</span><span class="o">;</span>
        <span class="n">ut_id</span> <span class="o">:</span> <span class="mi">32</span> <span class="o">:</span> <span class="n">littleendian</span><span class="o">;</span>
        <span class="n">ut_user</span> <span class="o">:</span> <span class="mi">256</span> <span class="o">:</span> <span class="kt">string</span><span class="o">;</span>
        <span class="n">ut_host</span> <span class="o">:</span> <span class="mi">2048</span> <span class="o">:</span> <span class="kt">string</span><span class="o">;</span>
        <span class="n">ut_exit</span> <span class="o">:</span> <span class="mi">32</span> <span class="o">:</span> <span class="n">littleendian</span><span class="o">;</span>
        <span class="n">ut_session</span> <span class="o">:</span> <span class="mi">32</span> <span class="o">:</span> <span class="n">littleendian</span><span class="o">;</span>
        <span class="n">ut_tv_sec</span> <span class="o">:</span> <span class="mi">32</span> <span class="o">:</span> <span class="n">littleendian</span><span class="o">;</span>
        <span class="n">ut_tv_usec</span> <span class="o">:</span> <span class="mi">32</span> <span class="o">:</span> <span class="n">littleendian</span><span class="o">;</span>
        <span class="n">ut_addr_v6</span> <span class="o">:</span> <span class="mi">128</span> <span class="o">:</span> <span class="kt">string</span> <span class="o">}</span> <span class="o">-&gt;</span>
        <span class="o">(</span><span class="n">ut_type</span><span class="o">,</span> <span class="n">ut_pid</span><span class="o">,</span> <span class="n">ut_line</span><span class="o">,</span> <span class="n">ut_id</span><span class="o">,</span> <span class="n">ut_user</span><span class="o">,</span> <span class="n">ut_host</span><span class="o">,</span>
         <span class="n">ut_exit</span><span class="o">,</span> <span class="n">ut_session</span><span class="o">,</span> <span class="n">ut_tv_sec</span><span class="o">,</span> <span class="n">ut_tv_usec</span><span class="o">,</span> <span class="n">ut_addr_v6</span><span class="o">)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN478"
>Reading Configuration Files</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">user_preferences</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">comments</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;#.*&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">leading_white</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;^[ </span><span class="se">\t</span><span class="s2">]+&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">trailing_white</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[ </span><span class="se">\t</span><span class="s2">]+$&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">equals_delim</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[ </span><span class="se">\t</span><span class="s2">]*=[ </span><span class="se">\t</span><span class="s2">]*&quot;</span> <span class="k">in</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">s</span> <span class="o">-&gt;</span>
       <span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span> <span class="n">comments</span> <span class="s2">&quot;&quot;</span> <span class="n">s</span> <span class="k">in</span>
       <span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span> <span class="n">leading_white</span> <span class="s2">&quot;&quot;</span> <span class="n">s</span> <span class="k">in</span>
       <span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span> <span class="n">trailing_white</span> <span class="s2">&quot;&quot;</span> <span class="n">s</span> <span class="k">in</span>
       <span class="c">(* anything left? *)</span>
       <span class="k">if</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">then</span>
         <span class="k">match</span> <span class="nn">Str</span><span class="p">.</span><span class="n">bounded_split_delim</span> <span class="n">equals_delim</span> <span class="n">s</span> <span class="mi">2</span> <span class="k">with</span>
           <span class="o">|</span> <span class="o">[</span><span class="n">var</span><span class="o">;</span> <span class="k">value</span><span class="o">]</span> <span class="o">-&gt;</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">user_preferences</span> <span class="n">var</span> <span class="k">value</span>
           <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="n">s</span><span class="o">)</span>
    <span class="c">(* defined in this chapter&#39;s introduction *)</span>
    <span class="o">(</span><span class="n">line_stream_of_channel</span> <span class="n">config</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* load variables from ocaml source - toplevel scripts only *)</span>
<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;.progrc&quot;</span><span class="o">;;</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN481"
>Testing a File for Trustworthiness</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">let</span> <span class="o">{</span><span class="nn">Unix</span><span class="p">.</span><span class="n">st_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">;</span>
         <span class="n">st_ino</span> <span class="o">=</span> <span class="n">ino</span><span class="o">;</span>
         <span class="n">st_kind</span> <span class="o">=</span> <span class="n">kind</span><span class="o">;</span>
         <span class="n">st_perm</span> <span class="o">=</span> <span class="n">perm</span><span class="o">;</span>
         <span class="n">st_nlink</span> <span class="o">=</span> <span class="n">nlink</span><span class="o">;</span>
         <span class="n">st_uid</span> <span class="o">=</span> <span class="n">uid</span><span class="o">;</span>
         <span class="n">st_gid</span> <span class="o">=</span> <span class="n">gid</span><span class="o">;</span>
         <span class="n">st_rdev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">;</span>
         <span class="n">st_size</span> <span class="o">=</span> <span class="n">size</span><span class="o">;</span>
         <span class="n">st_atime</span> <span class="o">=</span> <span class="n">atime</span><span class="o">;</span>
         <span class="n">st_mtime</span> <span class="o">=</span> <span class="n">mtime</span><span class="o">;</span>
         <span class="n">st_ctime</span> <span class="o">=</span> <span class="n">ctime</span><span class="o">}</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stat</span> <span class="n">filename</span> <span class="k">in</span>
    <span class="c">(* ... *)</span>
    <span class="bp">()</span>
  <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;no %s: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">filename</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">error_message</span> <span class="n">e</span><span class="o">);</span>
    <span class="n">exit</span> <span class="mi">0</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">info</span> <span class="o">=</span>
    <span class="k">try</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stat</span> <span class="n">filename</span>
    <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;no %s: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">filename</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">error_message</span> <span class="n">e</span><span class="o">);</span>
      <span class="n">exit</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">st_uid</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">then</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Superuser owns %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">filename</span><span class="o">;</span>
  <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">st_atime</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">st_mtime</span>
  <span class="k">then</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s has been read since it was written.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">filename</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">is_safe</span> <span class="n">path</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">info</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stat</span> <span class="n">path</span> <span class="k">in</span>
  <span class="c">(* owner neither superuser nor me *)</span>
  <span class="c">(* the real uid can be retrieved with Unix.getuid () *)</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">info</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">st_uid</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">info</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">st_uid</span> <span class="o">&lt;&gt;</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">getuid</span> <span class="bp">()</span><span class="o">)</span>
  <span class="k">then</span> <span class="bp">false</span>
  <span class="k">else</span>
    <span class="c">(* check whether the group or other can write file. *)</span>
    <span class="c">(* use 0o066 to detect either reading or writing *)</span>
    <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">st_perm</span> <span class="ow">land</span> <span class="mo">0o022</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">then</span> <span class="bp">true</span>  <span class="c">(* no one else can write this *)</span>
    <span class="k">else</span> <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">st_kind</span> <span class="o">&lt;&gt;</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">S_DIR</span>
    <span class="k">then</span> <span class="bp">false</span> <span class="c">(* non-directories aren&#39;t safe *)</span>
    <span class="k">else</span> <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">st_perm</span> <span class="ow">land</span> <span class="mo">0o1000</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span>
    <span class="k">then</span> <span class="bp">true</span>  <span class="c">(* but directories with the sticky bit (0o1000) are *)</span>
    <span class="k">else</span> <span class="bp">false</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">is_verysafe</span> <span class="n">path</span> <span class="o">=</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span> <span class="n">path</span> <span class="n">parent</span> <span class="o">=</span>
    <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="n">is_safe</span> <span class="n">path</span><span class="o">)</span>
    <span class="k">then</span> <span class="bp">false</span>
    <span class="k">else</span> <span class="k">if</span> <span class="n">path</span> <span class="o">&lt;&gt;</span> <span class="n">parent</span>
    <span class="k">then</span> <span class="n">loop</span> <span class="n">parent</span> <span class="o">(</span><span class="nn">Filename</span><span class="p">.</span><span class="n">dirname</span> <span class="n">parent</span><span class="o">)</span>
    <span class="k">else</span> <span class="bp">true</span> <span class="k">in</span>
  <span class="n">loop</span> <span class="n">path</span> <span class="o">(</span><span class="nn">Filename</span><span class="p">.</span><span class="n">dirname</span> <span class="n">path</span><span class="o">)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN484"
>Program: tailwtmp</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(*pp camlp4o -I /path/to/bitstring bitstring.cma pa_bitstring.cmo *)</span>

<span class="c">(* tailwtmp - watch for logins and logouts; *)</span>
<span class="c">(* uses linux utmp structure, from utmp(5)  *)</span>

<span class="k">let</span> <span class="n">days</span> <span class="o">=</span> <span class="o">[|</span> <span class="s2">&quot;Sun&quot;</span><span class="o">;</span> <span class="s2">&quot;Mon&quot;</span><span class="o">;</span> <span class="s2">&quot;Tue&quot;</span><span class="o">;</span> <span class="s2">&quot;Wed&quot;</span><span class="o">;</span> <span class="s2">&quot;Thu&quot;</span><span class="o">;</span> <span class="s2">&quot;Fri&quot;</span><span class="o">;</span> <span class="s2">&quot;Sat&quot;</span> <span class="o">|]</span>
<span class="k">let</span> <span class="n">months</span> <span class="o">=</span> <span class="o">[|</span> <span class="s2">&quot;Jan&quot;</span><span class="o">;</span> <span class="s2">&quot;Feb&quot;</span><span class="o">;</span> <span class="s2">&quot;Mar&quot;</span><span class="o">;</span> <span class="s2">&quot;Apr&quot;</span><span class="o">;</span> <span class="s2">&quot;May&quot;</span><span class="o">;</span> <span class="s2">&quot;Jun&quot;</span><span class="o">;</span>
                <span class="s2">&quot;Jul&quot;</span><span class="o">;</span> <span class="s2">&quot;Aug&quot;</span><span class="o">;</span> <span class="s2">&quot;Sep&quot;</span><span class="o">;</span> <span class="s2">&quot;Oct&quot;</span><span class="o">;</span> <span class="s2">&quot;Nov&quot;</span><span class="o">;</span> <span class="s2">&quot;Dec&quot;</span> <span class="o">|]</span>

<span class="k">let</span> <span class="n">string_of_tm</span> <span class="n">tm</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;%s %s %2d %02d:%02d:%02d %04d&quot;</span>
    <span class="n">days</span><span class="o">.(</span><span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_wday</span><span class="o">)</span>
    <span class="n">months</span><span class="o">.(</span><span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_mon</span><span class="o">)</span>
    <span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_mday</span>
    <span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_hour</span>
    <span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_min</span>
    <span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_sec</span>
    <span class="o">(</span><span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_year</span> <span class="o">+</span> <span class="mi">1900</span><span class="o">)</span>

<span class="k">let</span> <span class="n">trim_asciiz</span> <span class="n">s</span> <span class="o">=</span>
  <span class="k">try</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">s</span> <span class="mi">0</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">index</span> <span class="n">s</span> <span class="sc">&#39;\000&#39;</span><span class="o">)</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="n">s</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">sizeof</span> <span class="o">=</span> <span class="mi">384</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">wtmp</span> <span class="o">=</span> <span class="n">open_in</span> <span class="s2">&quot;/var/log/wtmp&quot;</span> <span class="k">in</span>
  <span class="n">seek_in</span> <span class="n">wtmp</span> <span class="o">(</span><span class="n">in_channel_length</span> <span class="n">wtmp</span><span class="o">);</span>
  <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">Bitstring</span><span class="p">.</span><span class="n">bitstring_of_chan_max</span> <span class="n">wtmp</span> <span class="n">sizeof</span> <span class="k">in</span>
    <span class="o">(</span><span class="n">bitmatch</span> <span class="n">buffer</span> <span class="k">with</span>
       <span class="o">|</span> <span class="o">{</span> <span class="n">ut_type</span> <span class="o">:</span> <span class="mi">16</span> <span class="o">:</span> <span class="n">littleendian</span><span class="o">;</span>
           <span class="o">_</span> <span class="o">:</span> <span class="mi">16</span><span class="o">;</span> <span class="c">(* padding *)</span>
           <span class="n">ut_pid</span> <span class="o">:</span> <span class="mi">32</span> <span class="o">:</span> <span class="n">littleendian</span><span class="o">;</span>
           <span class="n">ut_line</span> <span class="o">:</span> <span class="mi">256</span> <span class="o">:</span> <span class="kt">string</span><span class="o">;</span>
           <span class="n">ut_id</span> <span class="o">:</span> <span class="mi">32</span> <span class="o">:</span> <span class="n">littleendian</span><span class="o">;</span>
           <span class="n">ut_user</span> <span class="o">:</span> <span class="mi">256</span> <span class="o">:</span> <span class="kt">string</span><span class="o">;</span>
           <span class="n">ut_host</span> <span class="o">:</span> <span class="mi">2048</span> <span class="o">:</span> <span class="kt">string</span><span class="o">;</span>
           <span class="n">ut_exit</span> <span class="o">:</span> <span class="mi">32</span> <span class="o">:</span> <span class="n">littleendian</span><span class="o">;</span>
           <span class="n">ut_session</span> <span class="o">:</span> <span class="mi">32</span> <span class="o">:</span> <span class="n">littleendian</span><span class="o">;</span>
           <span class="n">ut_tv_sec</span> <span class="o">:</span> <span class="mi">32</span> <span class="o">:</span> <span class="n">littleendian</span><span class="o">;</span>
           <span class="n">ut_tv_usec</span> <span class="o">:</span> <span class="mi">32</span> <span class="o">:</span> <span class="n">littleendian</span><span class="o">;</span>
           <span class="n">ut_addr_v6</span> <span class="o">:</span> <span class="mi">128</span> <span class="o">:</span> <span class="kt">string</span> <span class="o">}</span> <span class="o">-&gt;</span>
           <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%1d %-8s %-12s %10ld %-24s %-16s %5ld %-32s</span><span class="se">\n</span><span class="s2">%!&quot;</span>
             <span class="n">ut_type</span> <span class="o">(</span><span class="n">trim_asciiz</span> <span class="n">ut_user</span><span class="o">)</span> <span class="o">(</span><span class="n">trim_asciiz</span> <span class="n">ut_line</span><span class="o">)</span> <span class="n">ut_id</span>
             <span class="o">(</span><span class="n">string_of_tm</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">localtime</span> <span class="o">(</span><span class="nn">Int32</span><span class="p">.</span><span class="n">to_float</span> <span class="n">ut_tv_sec</span><span class="o">)))</span>
             <span class="o">(</span><span class="n">trim_asciiz</span> <span class="n">ut_host</span><span class="o">)</span> <span class="n">ut_pid</span> <span class="o">(</span><span class="nn">Digest</span><span class="p">.</span><span class="n">to_hex</span> <span class="n">ut_addr_v6</span><span class="o">)</span>
       <span class="o">|</span> <span class="o">{</span> <span class="o">_</span> <span class="o">}</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">);</span>
    <span class="k">if</span> <span class="n">pos_in</span> <span class="n">wtmp</span> <span class="o">=</span> <span class="n">in_channel_length</span> <span class="n">wtmp</span>
    <span class="k">then</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">sleep</span> <span class="mi">1</span>
  <span class="k">done</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN487"
>Program: tctee</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* tctee - clone that groks process tees *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">ignore_ints</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span>
<span class="k">let</span> <span class="n">append</span>      <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span>
<span class="k">let</span> <span class="n">unbuffer</span>    <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span>
<span class="k">let</span> <span class="n">nostdout</span>    <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span>
<span class="k">let</span> <span class="n">names</span>       <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Arg</span><span class="p">.</span><span class="n">parse</span>
    <span class="o">[</span>
      <span class="s2">&quot;-a&quot;</span><span class="o">,</span> <span class="nn">Arg</span><span class="p">.</span><span class="nc">Set</span> <span class="n">append</span><span class="o">,</span>      <span class="s2">&quot;Append to output files&quot;</span><span class="o">;</span>
      <span class="s2">&quot;-i&quot;</span><span class="o">,</span> <span class="nn">Arg</span><span class="p">.</span><span class="nc">Set</span> <span class="n">ignore_ints</span><span class="o">,</span> <span class="s2">&quot;Ignore interrupts&quot;</span><span class="o">;</span>
      <span class="s2">&quot;-u&quot;</span><span class="o">,</span> <span class="nn">Arg</span><span class="p">.</span><span class="nc">Set</span> <span class="n">unbuffer</span><span class="o">,</span>    <span class="s2">&quot;Unbuffered output&quot;</span><span class="o">;</span>
      <span class="s2">&quot;-n&quot;</span><span class="o">,</span> <span class="nn">Arg</span><span class="p">.</span><span class="nc">Set</span> <span class="n">nostdout</span><span class="o">,</span>    <span class="s2">&quot;No standard output&quot;</span><span class="o">;</span>
    <span class="o">]</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">name</span> <span class="o">-&gt;</span> <span class="n">names</span> <span class="o">:=</span> <span class="n">name</span> <span class="o">::</span> <span class="o">!</span><span class="n">names</span><span class="o">)</span>
    <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;Usage: %s [-a] [-i] [-u] [-n] [filenames] ...&quot;</span>
       <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">));</span>
  <span class="n">names</span> <span class="o">:=</span> <span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="o">!</span><span class="n">names</span>

<span class="k">let</span> <span class="n">fhs</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span>
<span class="k">let</span> <span class="n">status</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">not</span> <span class="o">!</span><span class="n">nostdout</span> <span class="k">then</span>
    <span class="c">(* always go to stdout *)</span>
    <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">fhs</span> <span class="n">stdout</span> <span class="s2">&quot;standard output&quot;</span><span class="o">;</span>

  <span class="k">if</span> <span class="o">!</span><span class="n">ignore_ints</span>
  <span class="k">then</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
      <span class="o">(</span><span class="k">fun</span> <span class="n">signal</span> <span class="o">-&gt;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">set_signal</span> <span class="n">signal</span> <span class="nn">Sys</span><span class="p">.</span><span class="nc">Signal_ignore</span><span class="o">)</span>
      <span class="o">[</span><span class="nn">Sys</span><span class="p">.</span><span class="n">sigint</span><span class="o">;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigterm</span><span class="o">;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sighup</span><span class="o">;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigquit</span><span class="o">];</span>

  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">name</span> <span class="o">-&gt;</span>
       <span class="k">if</span> <span class="n">name</span><span class="o">.[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="sc">&#39;|&#39;</span>
       <span class="k">then</span>
         <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">fhs</span>
           <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_out</span>
              <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">name</span> <span class="mi">1</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">name</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)))</span>
           <span class="n">name</span>
       <span class="k">else</span>
         <span class="k">begin</span>
           <span class="k">let</span> <span class="n">mode</span> <span class="o">=</span>
             <span class="k">if</span> <span class="o">!</span><span class="n">append</span>
             <span class="k">then</span> <span class="o">[</span><span class="nc">Open_wronly</span><span class="o">;</span> <span class="nc">Open_creat</span><span class="o">;</span> <span class="nc">Open_append</span><span class="o">]</span>
             <span class="k">else</span> <span class="o">[</span><span class="nc">Open_wronly</span><span class="o">;</span> <span class="nc">Open_creat</span><span class="o">;</span> <span class="nc">Open_trunc</span><span class="o">]</span> <span class="k">in</span>
           <span class="k">try</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">fhs</span> <span class="o">(</span><span class="n">open_out_gen</span> <span class="n">mode</span> <span class="mo">0o666</span> <span class="n">name</span><span class="o">)</span> <span class="n">name</span>
           <span class="k">with</span> <span class="nc">Sys_error</span> <span class="n">e</span> <span class="o">-&gt;</span>
             <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s: couldn&#39;t open %s: %s</span><span class="se">\n</span><span class="s2">%!&quot;</span>
               <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span> <span class="n">name</span> <span class="n">e</span><span class="o">;</span>
             <span class="n">incr</span> <span class="n">status</span>
         <span class="k">end</span><span class="o">)</span>
    <span class="o">!</span><span class="n">names</span><span class="o">;</span>

  <span class="k">begin</span>
    <span class="k">try</span>
      <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
        <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">stdin</span> <span class="k">in</span>
        <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span>
          <span class="o">(</span><span class="k">fun</span> <span class="n">fh</span> <span class="n">name</span> <span class="o">-&gt;</span>
             <span class="k">try</span>
               <span class="n">output_string</span> <span class="n">fh</span> <span class="n">line</span><span class="o">;</span>
               <span class="n">output_string</span> <span class="n">fh</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
               <span class="k">if</span> <span class="o">!</span><span class="n">unbuffer</span> <span class="k">then</span> <span class="n">flush</span> <span class="n">fh</span>
             <span class="k">with</span> <span class="nc">Sys_error</span> <span class="n">e</span> <span class="o">-&gt;</span>
               <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s: couldn&#39;t write to %s: %s</span><span class="se">\n</span><span class="s2">%!&quot;</span>
                 <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span> <span class="n">name</span> <span class="n">e</span><span class="o">;</span>
               <span class="n">incr</span> <span class="n">status</span><span class="o">)</span>
          <span class="n">fhs</span>
      <span class="k">done</span>
    <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span>
  <span class="k">end</span><span class="o">;</span>

  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">fh</span> <span class="n">name</span> <span class="o">-&gt;</span>
       <span class="k">let</span> <span class="n">close</span> <span class="o">=</span>
         <span class="k">if</span> <span class="n">name</span><span class="o">.[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="sc">&#39;|&#39;</span>
         <span class="k">then</span> <span class="k">fun</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_out</span> <span class="n">p</span><span class="o">)</span>
         <span class="k">else</span> <span class="n">close_out</span> <span class="k">in</span>
       <span class="k">try</span> <span class="n">close</span> <span class="n">fh</span>
       <span class="k">with</span> <span class="nc">Sys_error</span> <span class="n">e</span> <span class="o">-&gt;</span>
         <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s: couldn&#39;t close %s: %s</span><span class="se">\n</span><span class="s2">%!&quot;</span>
           <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span> <span class="n">name</span> <span class="n">e</span><span class="o">;</span>
         <span class="n">incr</span> <span class="n">status</span><span class="o">)</span>
    <span class="n">fhs</span><span class="o">;</span>

  <span class="n">exit</span> <span class="o">!</span><span class="n">status</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN490"
>Program: laston</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* laston - find out when a given user last logged on *)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">open</span> <span class="nc">Printf</span>
<span class="k">open</span> <span class="nc">Unix</span>

<span class="k">let</span> <span class="n">lastlog</span> <span class="o">=</span> <span class="n">open_in</span> <span class="s2">&quot;/var/log/lastlog&quot;</span>
<span class="k">let</span> <span class="n">sizeof</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">+</span> <span class="mi">16</span>
<span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="mi">12</span> <span class="sc">&#39; &#39;</span>
<span class="k">let</span> <span class="n">host</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="mi">16</span> <span class="sc">&#39; &#39;</span>

<span class="k">let</span> <span class="n">days</span> <span class="o">=</span> <span class="o">[|</span> <span class="s2">&quot;Sun&quot;</span><span class="o">;</span> <span class="s2">&quot;Mon&quot;</span><span class="o">;</span> <span class="s2">&quot;Tue&quot;</span><span class="o">;</span> <span class="s2">&quot;Wed&quot;</span><span class="o">;</span> <span class="s2">&quot;Thu&quot;</span><span class="o">;</span> <span class="s2">&quot;Fri&quot;</span><span class="o">;</span> <span class="s2">&quot;Sat&quot;</span> <span class="o">|]</span>
<span class="k">let</span> <span class="n">months</span> <span class="o">=</span> <span class="o">[|</span> <span class="s2">&quot;Jan&quot;</span><span class="o">;</span> <span class="s2">&quot;Feb&quot;</span><span class="o">;</span> <span class="s2">&quot;Mar&quot;</span><span class="o">;</span> <span class="s2">&quot;Apr&quot;</span><span class="o">;</span> <span class="s2">&quot;May&quot;</span><span class="o">;</span> <span class="s2">&quot;Jun&quot;</span><span class="o">;</span>
                <span class="s2">&quot;Jul&quot;</span><span class="o">;</span> <span class="s2">&quot;Aug&quot;</span><span class="o">;</span> <span class="s2">&quot;Sep&quot;</span><span class="o">;</span> <span class="s2">&quot;Oct&quot;</span><span class="o">;</span> <span class="s2">&quot;Nov&quot;</span><span class="o">;</span> <span class="s2">&quot;Dec&quot;</span> <span class="o">|]</span>

<span class="k">let</span> <span class="n">format_time</span> <span class="n">time</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">tm</span> <span class="o">=</span> <span class="n">localtime</span> <span class="n">time</span> <span class="k">in</span>
  <span class="n">sprintf</span> <span class="s2">&quot;%s %s %2d %02d:%02d:%02d %04d&quot;</span>
    <span class="n">days</span><span class="o">.(</span><span class="n">tm</span><span class="o">.</span><span class="n">tm_wday</span><span class="o">)</span>
    <span class="n">months</span><span class="o">.(</span><span class="n">tm</span><span class="o">.</span><span class="n">tm_mon</span><span class="o">)</span>
    <span class="n">tm</span><span class="o">.</span><span class="n">tm_mday</span>
    <span class="n">tm</span><span class="o">.</span><span class="n">tm_hour</span>
    <span class="n">tm</span><span class="o">.</span><span class="n">tm_min</span>
    <span class="n">tm</span><span class="o">.</span><span class="n">tm_sec</span>
    <span class="o">(</span><span class="n">tm</span><span class="o">.</span><span class="n">tm_year</span> <span class="o">+</span> <span class="mi">1900</span><span class="o">)</span>

<span class="k">let</span> <span class="n">trim_asciiz</span> <span class="n">s</span> <span class="o">=</span>
  <span class="k">try</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">s</span> <span class="mi">0</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">index</span> <span class="n">s</span> <span class="sc">&#39;\000&#39;</span><span class="o">)</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="n">s</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">user</span> <span class="o">-&gt;</span>
       <span class="k">try</span>
         <span class="k">let</span> <span class="n">u</span> <span class="o">=</span>
           <span class="k">try</span> <span class="n">getpwuid</span> <span class="o">(</span><span class="n">int_of_string</span> <span class="n">user</span><span class="o">)</span>
           <span class="k">with</span> <span class="nc">Failure</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">getpwnam</span> <span class="n">user</span> <span class="k">in</span>
         <span class="n">seek_in</span> <span class="n">lastlog</span> <span class="o">(</span><span class="n">u</span><span class="o">.</span><span class="n">pw_uid</span> <span class="o">*</span> <span class="n">sizeof</span><span class="o">);</span>
         <span class="k">let</span> <span class="n">time</span> <span class="o">=</span> <span class="n">input_binary_int</span> <span class="n">lastlog</span> <span class="k">in</span>
         <span class="n">really_input</span> <span class="n">lastlog</span> <span class="n">line</span> <span class="mi">0</span> <span class="mi">12</span><span class="o">;</span>
         <span class="n">really_input</span> <span class="n">lastlog</span> <span class="n">host</span> <span class="mi">0</span> <span class="mi">16</span><span class="o">;</span>
         <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">trim_asciiz</span> <span class="n">line</span> <span class="k">in</span>
         <span class="k">let</span> <span class="n">host</span> <span class="o">=</span> <span class="n">trim_asciiz</span> <span class="n">host</span> <span class="k">in</span>
         <span class="n">printf</span> <span class="s2">&quot;%-8s UID %5d %s%s%s</span><span class="se">\n</span><span class="s2">&quot;</span>
           <span class="n">u</span><span class="o">.</span><span class="n">pw_name</span>
           <span class="n">u</span><span class="o">.</span><span class="n">pw_uid</span>
           <span class="o">(</span><span class="k">if</span> <span class="n">time</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span>
            <span class="k">then</span> <span class="n">format_time</span> <span class="o">(</span><span class="n">float_of_int</span> <span class="n">time</span><span class="o">)</span>
            <span class="k">else</span> <span class="s2">&quot;never logged in&quot;</span><span class="o">)</span>
           <span class="o">(</span><span class="k">if</span> <span class="n">line</span> <span class="o">&lt;&gt;</span> <span class="s2">&quot;&quot;</span> <span class="k">then</span> <span class="s2">&quot; on &quot;</span> <span class="o">^</span> <span class="n">line</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="o">)</span>
           <span class="o">(</span><span class="k">if</span> <span class="n">host</span> <span class="o">&lt;&gt;</span> <span class="s2">&quot;&quot;</span> <span class="k">then</span> <span class="s2">&quot; from &quot;</span> <span class="o">^</span> <span class="n">host</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="o">)</span>
       <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
         <span class="n">printf</span> <span class="s2">&quot;no such uid %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">user</span><span class="o">)</span>
    <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">sub</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="mi">1</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="o">-</span> <span class="mi">1</span><span class="o">))</span></PRE
></TD
></TR
></TABLE
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="fileaccess.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="directories.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>File Access</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
>&nbsp;</TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Directories</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN""http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>Dates and Times</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="PLEAC-Objective CAML "
HREF="index.html"><LINK
REL="PREVIOUS"
TITLE="Numbers"
HREF="numbers.html"><LINK
REL="NEXT"
TITLE="Arrays"
HREF="arrays.html"><style type="text/css">td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
pre { line-height: 125%; }

  </style></head
><BODY TEXT="#cecece" BGCOLOR="#4f6f6f" LINK="#f5deb3" VLINK="#d5ae83"
CLASS="SECT1"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>PLEAC-Objective CAML </TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="numbers.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
></TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="arrays.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="DATESANDTIMES"
>3. Dates and Times</A
></H1
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN132"
>Introduction</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(*-----------------------------*)</span>

<span class="c">(* The unix module acts as a thin wrapper around the standard C</span>
<span class="c">** Posix API. It comes standard with the Ocaml compiler but is</span>
<span class="c">** not automatcially linked.</span>
<span class="c">** If you are not using the command line interpreter, delete the</span>
<span class="c">** the &quot;#load&quot; line</span>
<span class="c">*)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span> <span class="o">;;</span>
<span class="k">open</span> <span class="nc">Unix</span> <span class="o">;;</span>
<span class="k">let</span> <span class="n">t</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">localtime</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">time</span> <span class="bp">()</span><span class="o">);;</span>

<span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Today is day %d of the current year.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">t</span><span class="o">.</span><span class="n">tm_yday</span> <span class="o">;;</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN135"
>Finding Today's Date</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(*-----------------------------*)</span>
<span class="c">(* Finding todays date *)</span>

<span class="k">let</span> <span class="o">(</span><span class="n">day</span><span class="o">,</span> <span class="n">month</span><span class="o">,</span> <span class="n">year</span><span class="o">)</span> <span class="o">=</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="n">tm_mday</span><span class="o">,</span> <span class="n">t</span><span class="o">.</span><span class="n">tm_mon</span><span class="o">,</span> <span class="n">t</span><span class="o">.</span><span class="n">tm_year</span><span class="o">)</span> <span class="o">;;</span>
<span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;The current date is %04d-%02d-%02d</span><span class="se">\n</span><span class="s2">&quot;</span>
  <span class="o">(</span><span class="mi">1900</span> <span class="o">+</span> <span class="n">year</span><span class="o">)</span> <span class="o">(</span><span class="n">month</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">day</span> <span class="o">;;</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN138"
>Converting DMYHMS to Epoch Seconds</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(*-----------------------------*)</span>
<span class="c">(*</span>
<span class="c">** Converting DMYHMS to Epoch Seconds</span>
<span class="c">** Again, use the Unix module.</span>
<span class="c">*)</span>

<span class="c">(* For the local timezone *)</span>
<span class="k">let</span> <span class="n">ttup</span> <span class="o">=</span> <span class="n">mktime</span> <span class="o">(</span><span class="n">localtime</span> <span class="o">(</span><span class="n">time</span> <span class="bp">()</span><span class="o">))</span> <span class="o">;;</span>
<span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Epoch Seconds (local): %.0f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">fst</span> <span class="n">ttup</span><span class="o">)</span> <span class="o">;;</span>

<span class="c">(* For UTC *)</span>
<span class="k">let</span> <span class="n">ttup</span> <span class="o">=</span> <span class="n">mktime</span> <span class="o">(</span><span class="n">gmtime</span> <span class="o">(</span><span class="n">time</span> <span class="bp">()</span><span class="o">))</span> <span class="o">;;</span>
<span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Epoch Seconds (UTC): %.0f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">fst</span> <span class="n">ttup</span><span class="o">)</span> <span class="o">;;</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN141"
>Converting Epoch Seconds to DMYHMS</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">time</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">time</span> <span class="bp">()</span>

<span class="k">let</span> <span class="o">{</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_sec</span><span class="o">=</span><span class="n">seconds</span><span class="o">;</span> <span class="n">tm_min</span><span class="o">=</span><span class="n">minutes</span><span class="o">;</span> <span class="n">tm_hour</span><span class="o">=</span><span class="n">hours</span><span class="o">;</span>
     <span class="n">tm_mday</span><span class="o">=</span><span class="n">day_of_month</span><span class="o">;</span> <span class="n">tm_mon</span><span class="o">=</span><span class="n">month</span><span class="o">;</span> <span class="n">tm_year</span><span class="o">=</span><span class="n">year</span><span class="o">;</span>
     <span class="n">tm_wday</span><span class="o">=</span><span class="n">wday</span><span class="o">;</span> <span class="n">tm_yday</span><span class="o">=</span><span class="n">yday</span><span class="o">;</span> <span class="n">tm_isdst</span><span class="o">=</span><span class="n">isdst</span><span class="o">}</span> <span class="o">=</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">localtime</span> <span class="n">time</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Dateline: %02d:%02d:%02d-%04d/%02d/%02d</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">hours</span> <span class="n">minutes</span> <span class="n">seconds</span> <span class="o">(</span><span class="n">year</span> <span class="o">+</span> <span class="mi">1900</span><span class="o">)</span> <span class="o">(</span><span class="n">month</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">day_of_month</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN144"
>Adding to or Subtracting from a Date</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="k">let</span> <span class="n">birthtime</span> <span class="o">=</span> <span class="mi">96176750</span><span class="o">.</span>                     <span class="c">(* 18/Jan/1973, 3:45:50 am *)</span>
<span class="k">let</span> <span class="n">interval</span> <span class="o">=</span> <span class="mi">5</span><span class="o">.</span> <span class="o">+.</span>                          <span class="c">(* 5 seconds *)</span>
               <span class="mi">17</span><span class="o">.</span> <span class="o">*.</span> <span class="mi">60</span><span class="o">.</span> <span class="o">+.</span>                  <span class="c">(* 17 minutes *)</span>
               <span class="mi">2</span><span class="o">.</span>  <span class="o">*.</span> <span class="mi">60</span><span class="o">.</span> <span class="o">*.</span> <span class="mi">60</span><span class="o">.</span> <span class="o">+.</span>           <span class="c">(* 2 hours *)</span>
               <span class="mi">55</span><span class="o">.</span> <span class="o">*.</span> <span class="mi">60</span><span class="o">.</span> <span class="o">*.</span> <span class="mi">60</span><span class="o">.</span> <span class="o">*.</span> <span class="mi">24</span><span class="o">.</span>       <span class="c">(* and 55 days *)</span>
<span class="k">let</span> <span class="k">then&#39;</span> <span class="o">=</span> <span class="n">birthtime</span> <span class="o">+.</span> <span class="n">interval</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* format_time is defined in section 3.8. *)</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Then is %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">format_time</span> <span class="k">then&#39;</span><span class="o">);</span>
  <span class="c">(* Then is Tue Mar 13 23:02:55 1973 *)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN147"
>Difference of Two Dates</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="k">let</span> <span class="n">bree</span> <span class="o">=</span> <span class="mi">361535725</span><span class="o">.</span>                   <span class="c">(* 16 Jun 1981, 4:35:25 *)</span>
<span class="k">let</span> <span class="n">nat</span>  <span class="o">=</span>  <span class="mi">96201950</span><span class="o">.</span>                   <span class="c">(* 18 Jan 1973, 3:45:50 *)</span>

<span class="k">let</span> <span class="n">difference</span> <span class="o">=</span> <span class="n">bree</span> <span class="o">-.</span> <span class="n">nat</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;There were %.f seconds between Nat and Bree</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">difference</span>
  <span class="c">(* There were 265333775 seconds between Nat and Bree *)</span>

<span class="k">let</span> <span class="n">seconds</span>    <span class="o">=</span>  <span class="n">mod_float</span> <span class="n">difference</span> <span class="mi">60</span><span class="o">.</span>
<span class="k">let</span> <span class="n">difference</span> <span class="o">=</span> <span class="o">(</span><span class="n">difference</span> <span class="o">-.</span> <span class="n">seconds</span><span class="o">)</span> <span class="o">/.</span> <span class="mi">60</span><span class="o">.</span>
<span class="k">let</span> <span class="n">minutes</span>    <span class="o">=</span>  <span class="n">mod_float</span> <span class="n">difference</span> <span class="mi">60</span><span class="o">.</span>
<span class="k">let</span> <span class="n">difference</span> <span class="o">=</span> <span class="o">(</span><span class="n">difference</span> <span class="o">-.</span> <span class="n">minutes</span><span class="o">)</span> <span class="o">/.</span> <span class="mi">60</span><span class="o">.</span>
<span class="k">let</span> <span class="n">hours</span>      <span class="o">=</span>  <span class="n">mod_float</span> <span class="n">difference</span> <span class="mi">24</span><span class="o">.</span>
<span class="k">let</span> <span class="n">difference</span> <span class="o">=</span> <span class="o">(</span><span class="n">difference</span> <span class="o">-.</span> <span class="n">hours</span><span class="o">)</span>   <span class="o">/.</span> <span class="mi">24</span><span class="o">.</span>
<span class="k">let</span> <span class="n">days</span>       <span class="o">=</span>  <span class="n">mod_float</span> <span class="n">difference</span> <span class="mi">7</span><span class="o">.</span>
<span class="k">let</span> <span class="n">weeks</span>      <span class="o">=</span> <span class="o">(</span><span class="n">difference</span> <span class="o">-.</span> <span class="n">days</span><span class="o">)</span>    <span class="o">/.</span>  <span class="mi">7</span><span class="o">.</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;(%.f weeks, %.f days, %.f:%.f:%.f)</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">weeks</span> <span class="n">days</span> <span class="n">hours</span> <span class="n">minutes</span> <span class="n">seconds</span>
  <span class="c">(* (438 weeks, 4 days, 23:49:35) *)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN150"
>Day in a Week/Month/Year or Week Number</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="o">{</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_mday</span><span class="o">=</span><span class="n">monthday</span><span class="o">;</span> <span class="n">tm_wday</span><span class="o">=</span><span class="n">weekday</span><span class="o">;</span> <span class="n">tm_yday</span><span class="o">=</span><span class="n">yearday</span><span class="o">}</span> <span class="o">=</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">localtime</span> <span class="n">date</span>
<span class="k">let</span> <span class="n">weeknum</span> <span class="o">=</span> <span class="n">yearday</span> <span class="o">/</span> <span class="mi">7</span> <span class="o">+</span> <span class="mi">1</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN153"
>Parsing Dates and Times from Strings</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">epoch_seconds</span> <span class="n">date</span> <span class="o">=</span>
  <span class="nn">Scanf</span><span class="p">.</span><span class="n">sscanf</span> <span class="n">date</span> <span class="s2">&quot;%04d-%02d-%02d&quot;</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">yyyy</span> <span class="n">mm</span> <span class="n">dd</span> <span class="o">-&gt;</span>
       <span class="n">fst</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">mktime</span> <span class="o">{</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_sec</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">tm_min</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">tm_hour</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span>
                         <span class="n">tm_mday</span><span class="o">=</span><span class="n">dd</span><span class="o">;</span> <span class="n">tm_mon</span><span class="o">=</span><span class="n">mm</span><span class="o">-</span><span class="mi">1</span><span class="o">;</span> <span class="n">tm_year</span><span class="o">=</span><span class="n">yyyy</span><span class="o">-</span><span class="mi">1900</span><span class="o">;</span>
                         <span class="n">tm_wday</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">tm_yday</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">tm_isdst</span><span class="o">=</span><span class="bp">false</span><span class="o">}))</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">read_line</span> <span class="bp">()</span> <span class="k">in</span>
    <span class="k">try</span>
      <span class="k">let</span> <span class="n">date</span> <span class="o">=</span> <span class="n">epoch_seconds</span> <span class="n">line</span> <span class="k">in</span>
      <span class="k">let</span> <span class="o">{</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_mday</span><span class="o">=</span><span class="n">day</span><span class="o">;</span> <span class="n">tm_mon</span><span class="o">=</span><span class="n">month</span><span class="o">;</span> <span class="n">tm_year</span><span class="o">=</span><span class="n">year</span><span class="o">}</span> <span class="o">=</span>
        <span class="nn">Unix</span><span class="p">.</span><span class="n">localtime</span> <span class="n">date</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">month</span> <span class="o">=</span> <span class="n">month</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">year</span> <span class="o">=</span> <span class="n">year</span> <span class="o">+</span> <span class="mi">1900</span> <span class="k">in</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Date was %d/%d/%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">month</span> <span class="n">day</span> <span class="n">year</span>
    <span class="k">with</span>
      <span class="o">|</span> <span class="nn">Scanf</span><span class="p">.</span><span class="nc">Scan_failure</span> <span class="o">_</span>
      <span class="o">|</span> <span class="nc">End_of_file</span>
      <span class="o">|</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">ERANGE</span><span class="o">,</span> <span class="s2">&quot;mktime&quot;</span><span class="o">,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
          <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Bad date string: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">line</span>
  <span class="k">done</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN156"
>Printing a Date</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">open</span> <span class="nc">Unix</span>
<span class="k">open</span> <span class="nc">Printf</span>

<span class="k">let</span> <span class="n">days</span> <span class="o">=</span> <span class="o">[|</span> <span class="s2">&quot;Sun&quot;</span><span class="o">;</span> <span class="s2">&quot;Mon&quot;</span><span class="o">;</span> <span class="s2">&quot;Tue&quot;</span><span class="o">;</span> <span class="s2">&quot;Wed&quot;</span><span class="o">;</span> <span class="s2">&quot;Thu&quot;</span><span class="o">;</span> <span class="s2">&quot;Fri&quot;</span><span class="o">;</span> <span class="s2">&quot;Sat&quot;</span> <span class="o">|]</span>
<span class="k">let</span> <span class="n">months</span> <span class="o">=</span> <span class="o">[|</span> <span class="s2">&quot;Jan&quot;</span><span class="o">;</span> <span class="s2">&quot;Feb&quot;</span><span class="o">;</span> <span class="s2">&quot;Mar&quot;</span><span class="o">;</span> <span class="s2">&quot;Apr&quot;</span><span class="o">;</span> <span class="s2">&quot;May&quot;</span><span class="o">;</span> <span class="s2">&quot;Jun&quot;</span><span class="o">;</span>
                <span class="s2">&quot;Jul&quot;</span><span class="o">;</span> <span class="s2">&quot;Aug&quot;</span><span class="o">;</span> <span class="s2">&quot;Sep&quot;</span><span class="o">;</span> <span class="s2">&quot;Oct&quot;</span><span class="o">;</span> <span class="s2">&quot;Nov&quot;</span><span class="o">;</span> <span class="s2">&quot;Dec&quot;</span> <span class="o">|]</span>

<span class="k">let</span> <span class="n">format_time</span> <span class="n">time</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">tm</span> <span class="o">=</span> <span class="n">localtime</span> <span class="n">time</span> <span class="k">in</span>
  <span class="n">sprintf</span> <span class="s2">&quot;%s %s %2d %02d:%02d:%02d %04d&quot;</span>
    <span class="n">days</span><span class="o">.(</span><span class="n">tm</span><span class="o">.</span><span class="n">tm_wday</span><span class="o">)</span>
    <span class="n">months</span><span class="o">.(</span><span class="n">tm</span><span class="o">.</span><span class="n">tm_mon</span><span class="o">)</span>
    <span class="n">tm</span><span class="o">.</span><span class="n">tm_mday</span>
    <span class="n">tm</span><span class="o">.</span><span class="n">tm_hour</span>
    <span class="n">tm</span><span class="o">.</span><span class="n">tm_min</span>
    <span class="n">tm</span><span class="o">.</span><span class="n">tm_sec</span>
    <span class="o">(</span><span class="n">tm</span><span class="o">.</span><span class="n">tm_year</span> <span class="o">+</span> <span class="mi">1900</span><span class="o">)</span>

<span class="k">let</span> <span class="n">time</span> <span class="o">=</span> <span class="n">fst</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">mktime</span> <span class="o">{</span><span class="n">tm_sec</span><span class="o">=</span><span class="mi">50</span><span class="o">;</span> <span class="n">tm_min</span><span class="o">=</span><span class="mi">45</span><span class="o">;</span> <span class="n">tm_hour</span><span class="o">=</span><span class="mi">3</span><span class="o">;</span>
                             <span class="n">tm_mday</span><span class="o">=</span><span class="mi">18</span><span class="o">;</span> <span class="n">tm_mon</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">tm_year</span><span class="o">=</span><span class="mi">73</span><span class="o">;</span>
                             <span class="n">tm_wday</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">tm_yday</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">tm_isdst</span><span class="o">=</span><span class="bp">false</span><span class="o">})</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">printf</span> <span class="s2">&quot;format_time gives: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">format_time</span> <span class="n">time</span><span class="o">)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN159"
>High-Resolution Timers</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">t0</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">gettimeofday</span> <span class="bp">()</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">print_string</span> <span class="s2">&quot;Press return when ready: &quot;</span><span class="o">;</span> <span class="n">ignore</span> <span class="o">(</span><span class="n">read_line</span> <span class="bp">()</span><span class="o">)</span>
<span class="k">let</span> <span class="n">t1</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">gettimeofday</span> <span class="bp">()</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;You took %f seconds.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">t1</span> <span class="o">-.</span> <span class="n">t0</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">500</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">number_of_times</span> <span class="o">=</span> <span class="mi">100</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">total_time</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span><span class="o">.</span> <span class="k">in</span>

<span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">to</span> <span class="n">number_of_times</span> <span class="k">do</span>
  <span class="k">let</span> <span class="kt">array</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">init</span> <span class="n">size</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nn">Random</span><span class="p">.</span><span class="n">bits</span><span class="bp">()</span><span class="o">)</span> <span class="k">in</span>

  <span class="k">let</span> <span class="n">before</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">gettimeofday</span><span class="bp">()</span> <span class="k">in</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">stable_sort</span> <span class="n">compare</span> <span class="kt">array</span> <span class="o">;</span>
  <span class="k">let</span> <span class="n">time</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">gettimeofday</span><span class="bp">()</span> <span class="o">-.</span> <span class="n">before</span> <span class="k">in</span>
  <span class="n">total_time</span> <span class="o">:=</span> <span class="o">!</span><span class="n">total_time</span> <span class="o">+.</span> <span class="n">time</span>
<span class="k">done</span> <span class="o">;</span>

<span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;On average, sorting %d random numbers takes %.5f seconds</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">size</span> <span class="o">(!</span><span class="n">total_time</span> <span class="o">/.</span> <span class="kt">float</span> <span class="n">number_of_times</span><span class="o">)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN162"
>Short Sleeps</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="k">let</span> <span class="n">usleep</span> <span class="n">time</span> <span class="o">=</span>
  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">select</span> <span class="bp">[]</span> <span class="bp">[]</span> <span class="bp">[]</span> <span class="n">time</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
    <span class="n">usleep</span> <span class="mi">0</span><span class="o">.</span><span class="mi">25</span><span class="o">;</span>
    <span class="n">print_newline</span> <span class="bp">()</span><span class="o">;</span>
  <span class="k">done</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN165"
>Program: hopdelta</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* hopdelta - feed mail header, produce lines</span>
<span class="c">              showing delay at each hop. *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="c">(* Modify this function to tweak the format of results. *)</span>
<span class="k">let</span> <span class="n">print_result</span> <span class="n">sender</span> <span class="n">recipient</span> <span class="n">time</span> <span class="n">delta</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%-30s %-30s %-20s   %s</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">sender</span> <span class="n">recipient</span> <span class="n">time</span> <span class="n">delta</span>

<span class="c">(* Produce a stream of lines from an input channel. *)</span>
<span class="k">let</span> <span class="n">line_stream_of_channel</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">channel</span><span class="o">)</span> <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="nc">None</span><span class="o">)</span>

<span class="c">(* Turn a stream of lines into a stream of paragraphs, where each</span>
<span class="c">   paragraph is a stream of lines. Paragraphs are delimited by one</span>
<span class="c">   or more empty lines. *)</span>
<span class="k">let</span> <span class="n">paragraphs</span> <span class="n">lines</span> <span class="o">=</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">next</span> <span class="n">para_lines</span> <span class="n">i</span> <span class="o">=</span>
    <span class="k">match</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">peek</span> <span class="n">lines</span><span class="o">,</span> <span class="n">para_lines</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">None</span><span class="o">,</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="nc">None</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="s2">&quot;&quot;</span><span class="o">,</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">lines</span><span class="o">;</span> <span class="n">next</span> <span class="n">para_lines</span> <span class="n">i</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="s2">&quot;&quot;</span><span class="o">,</span> <span class="o">_</span> <span class="o">|</span> <span class="nc">None</span><span class="o">,</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nc">Some</span> <span class="o">(</span><span class="nn">Stream</span><span class="p">.</span><span class="n">of_list</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="n">para_lines</span><span class="o">))</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">line</span><span class="o">,</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">lines</span><span class="o">;</span> <span class="n">next</span> <span class="o">(</span><span class="n">line</span> <span class="o">::</span> <span class="n">para_lines</span><span class="o">)</span> <span class="n">i</span> <span class="k">in</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span> <span class="o">(</span><span class="n">next</span> <span class="bp">[]</span><span class="o">)</span>

<span class="c">(* Find blocks of email headers in a stream of paragraphs. Headers</span>
<span class="c">   are all assumed to have a first line starting with &quot;From&quot; and</span>
<span class="c">   containing a &#39;@&#39; character. This is not very robust. *)</span>
<span class="k">let</span> <span class="n">header_blocks</span> <span class="n">paras</span> <span class="o">=</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">next</span> <span class="n">i</span> <span class="o">=</span>
    <span class="k">match</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">peek</span> <span class="n">paras</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">lines</span> <span class="o">-&gt;</span>
          <span class="k">if</span> <span class="o">(</span><span class="k">match</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">peek</span> <span class="n">lines</span> <span class="k">with</span>
                <span class="o">|</span> <span class="nc">Some</span> <span class="n">line</span> <span class="o">-&gt;</span>
                    <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">line</span> <span class="o">&gt;=</span> <span class="mi">5</span>
                     <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">line</span> <span class="mi">0</span> <span class="mi">5</span> <span class="o">=</span> <span class="s2">&quot;From &quot;</span><span class="o">)</span>
                     <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">contains</span> <span class="n">line</span> <span class="sc">&#39;@&#39;</span><span class="o">))</span>
                <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="bp">false</span><span class="o">)</span>
          <span class="k">then</span> <span class="nc">Some</span> <span class="o">(</span><span class="nn">Stream</span><span class="p">.</span><span class="n">next</span> <span class="n">paras</span><span class="o">)</span>
          <span class="k">else</span> <span class="o">(</span><span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">paras</span><span class="o">;</span> <span class="n">next</span> <span class="n">i</span><span class="o">)</span>
      <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="nc">None</span> <span class="k">in</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span> <span class="n">next</span>

<span class="c">(* Pattern to detect continuation lines. *)</span>
<span class="k">let</span> <span class="n">continuation_regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;^[</span><span class="se">\t</span><span class="s2"> ]+&quot;</span>

<span class="c">(* Transform a stream of lines such that continuation lines are joined</span>
<span class="c">   with previous lines by a single space. *)</span>
<span class="k">let</span> <span class="n">join_continuations</span> <span class="n">lines</span> <span class="o">=</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">continuations</span> <span class="bp">()</span> <span class="o">=</span>
    <span class="k">match</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">peek</span> <span class="n">lines</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">line</span> <span class="o">-&gt;</span>
          <span class="k">let</span> <span class="n">found</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span> <span class="k">in</span>
          <span class="k">let</span> <span class="n">trimmed</span> <span class="o">=</span>
            <span class="nn">Str</span><span class="p">.</span><span class="n">substitute_first</span>
              <span class="n">continuation_regexp</span>
              <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">found</span> <span class="o">:=</span> <span class="bp">true</span><span class="o">;</span> <span class="s2">&quot;&quot;</span><span class="o">)</span>
              <span class="n">line</span> <span class="k">in</span>
          <span class="k">if</span> <span class="o">!</span><span class="n">found</span>
          <span class="k">then</span> <span class="o">(</span><span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">lines</span><span class="o">;</span> <span class="s2">&quot; &quot;</span> <span class="o">^</span> <span class="n">trimmed</span> <span class="o">^</span> <span class="n">continuations</span> <span class="bp">()</span><span class="o">)</span>
          <span class="k">else</span> <span class="s2">&quot;&quot;</span>
      <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="s2">&quot;&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">next</span> <span class="n">i</span> <span class="o">=</span>
    <span class="k">match</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">peek</span> <span class="n">lines</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">line</span> <span class="o">-&gt;</span>
          <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">lines</span><span class="o">;</span>
          <span class="nc">Some</span> <span class="o">(</span><span class="n">line</span> <span class="o">^</span> <span class="n">continuations</span> <span class="bp">()</span><span class="o">)</span>
      <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="nc">None</span> <span class="k">in</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span> <span class="n">next</span>

<span class="c">(* A type for headers, where &quot;from&quot; contains the text of the &quot;From&quot;</span>
<span class="c">   line, and the rest of the headers are parsed into a (key, value)</span>
<span class="c">   list called &quot;params&quot;. *)</span>
<span class="k">type</span> <span class="n">header</span> <span class="o">=</span> <span class="o">{</span> <span class="n">from</span> <span class="o">:</span> <span class="kt">string</span><span class="o">;</span>
                <span class="n">params</span> <span class="o">:</span> <span class="o">(</span><span class="kt">string</span> <span class="o">*</span> <span class="kt">string</span><span class="o">)</span> <span class="kt">list</span> <span class="o">}</span>

<span class="c">(* Given a stream of header blocks, produce a stream of values of the</span>
<span class="c">   above &quot;header&quot; type. *)</span>
<span class="k">let</span> <span class="n">headers</span> <span class="n">blocks</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">parse_from</span> <span class="n">line</span> <span class="o">=</span>
    <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">line</span> <span class="mi">5</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">line</span> <span class="o">-</span> <span class="mi">5</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">parse_param</span> <span class="n">params</span> <span class="n">line</span> <span class="o">=</span>
    <span class="k">try</span>
      <span class="k">let</span> <span class="n">index</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">index</span> <span class="n">line</span> <span class="sc">&#39;:&#39;</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">key</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">line</span> <span class="mi">0</span> <span class="n">index</span> <span class="k">in</span>
      <span class="k">let</span> <span class="k">value</span> <span class="o">=</span>
        <span class="k">if</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">line</span> <span class="o">&gt;</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">2</span>
        <span class="k">then</span>
          <span class="nn">String</span><span class="p">.</span><span class="n">sub</span>
            <span class="n">line</span>
            <span class="o">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">2</span><span class="o">)</span>
            <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">line</span> <span class="o">-</span> <span class="n">index</span> <span class="o">-</span> <span class="mi">2</span><span class="o">)</span>
        <span class="k">else</span> <span class="s2">&quot;&quot;</span> <span class="k">in</span>
      <span class="n">params</span> <span class="o">:=</span> <span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="k">value</span><span class="o">)</span> <span class="o">::</span> <span class="o">!</span><span class="n">params</span>
    <span class="k">with</span>
      <span class="o">|</span> <span class="nc">Not_found</span>
      <span class="o">|</span> <span class="nc">Invalid_argument</span> <span class="s2">&quot;String.sub&quot;</span> <span class="o">-&gt;</span>
          <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Unable to parse header: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">line</span><span class="o">;</span>
          <span class="bp">()</span> <span class="k">in</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">next</span> <span class="n">i</span> <span class="o">=</span>
    <span class="k">try</span>
      <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">next</span> <span class="n">blocks</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">join_continuations</span> <span class="n">lines</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">from</span> <span class="o">=</span> <span class="n">parse_from</span> <span class="o">(</span><span class="nn">Stream</span><span class="p">.</span><span class="n">next</span> <span class="n">lines</span><span class="o">)</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">params</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
      <span class="nn">Stream</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="n">parse_param</span> <span class="n">params</span><span class="o">)</span> <span class="n">lines</span><span class="o">;</span>
      <span class="nc">Some</span> <span class="o">{</span> <span class="n">from</span> <span class="o">=</span> <span class="n">from</span><span class="o">;</span> <span class="n">params</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="o">!</span><span class="n">params</span> <span class="o">}</span>
    <span class="k">with</span> <span class="nn">Stream</span><span class="p">.</span><span class="nc">Failure</span> <span class="o">-&gt;</span>
      <span class="nc">None</span> <span class="k">in</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span> <span class="n">next</span>

<span class="c">(* Combine the above stream transformers to produce a function from</span>
<span class="c">   input channels to streams of headers. *)</span>
<span class="k">let</span> <span class="n">header_stream_of_channel</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="n">headers</span>
    <span class="o">(</span><span class="n">header_blocks</span>
       <span class="o">(</span><span class="n">paragraphs</span>
          <span class="o">(</span><span class="n">line_stream_of_channel</span> <span class="n">channel</span><span class="o">)))</span>

<span class="c">(* Association list mapping month abbreviations to 0-based month</span>
<span class="c">   numbers as required by Unix.mktime. *)</span>
<span class="k">let</span> <span class="n">months</span> <span class="o">=</span>
  <span class="o">[</span><span class="s2">&quot;Jan&quot;</span><span class="o">,</span> <span class="mi">0</span><span class="o">;</span> <span class="s2">&quot;Feb&quot;</span><span class="o">,</span> <span class="mi">1</span><span class="o">;</span> <span class="s2">&quot;Mar&quot;</span><span class="o">,</span> <span class="mi">2</span><span class="o">;</span> <span class="s2">&quot;Apr&quot;</span><span class="o">,</span> <span class="mi">3</span><span class="o">;</span> <span class="s2">&quot;May&quot;</span><span class="o">,</span> <span class="mi">4</span><span class="o">;</span> <span class="s2">&quot;Jun&quot;</span><span class="o">,</span> <span class="mi">5</span><span class="o">;</span>
   <span class="s2">&quot;Jul&quot;</span><span class="o">,</span> <span class="mi">6</span><span class="o">;</span> <span class="s2">&quot;Aug&quot;</span><span class="o">,</span> <span class="mi">7</span><span class="o">;</span> <span class="s2">&quot;Sep&quot;</span><span class="o">,</span> <span class="mi">8</span><span class="o">;</span> <span class="s2">&quot;Oct&quot;</span><span class="o">,</span> <span class="mi">9</span><span class="o">;</span> <span class="s2">&quot;Nov&quot;</span><span class="o">,</span> <span class="mi">10</span><span class="o">;</span> <span class="s2">&quot;Dec&quot;</span><span class="o">,</span> <span class="mi">11</span><span class="o">]</span>

<span class="c">(* Turn a time zone into an offset in minutes. Not exhaustive. *)</span>
<span class="k">let</span> <span class="n">parse_tz</span> <span class="o">=</span> <span class="k">function</span>
  <span class="o">|</span> <span class="s2">&quot;&quot;</span> <span class="o">|</span> <span class="s2">&quot;Z&quot;</span> <span class="o">|</span> <span class="s2">&quot;GMT&quot;</span> <span class="o">|</span> <span class="s2">&quot;UTC&quot;</span> <span class="o">|</span> <span class="s2">&quot;UT&quot;</span> <span class="o">-&gt;</span> <span class="mi">0</span>
  <span class="o">|</span> <span class="s2">&quot;PST&quot;</span> <span class="o">-&gt;</span> <span class="o">-</span><span class="mi">480</span>
  <span class="o">|</span> <span class="s2">&quot;MST&quot;</span> <span class="o">|</span> <span class="s2">&quot;PDT&quot;</span> <span class="o">-&gt;</span> <span class="o">-</span><span class="mi">420</span>
  <span class="o">|</span> <span class="s2">&quot;CST&quot;</span> <span class="o">|</span> <span class="s2">&quot;MDT&quot;</span> <span class="o">-&gt;</span> <span class="o">-</span><span class="mi">360</span>
  <span class="o">|</span> <span class="s2">&quot;EST&quot;</span> <span class="o">|</span> <span class="s2">&quot;CDT&quot;</span> <span class="o">-&gt;</span> <span class="o">-</span><span class="mi">300</span>
  <span class="o">|</span> <span class="s2">&quot;EDT&quot;</span> <span class="o">-&gt;</span> <span class="o">-</span><span class="mi">240</span>
  <span class="o">|</span> <span class="kt">string</span> <span class="o">-&gt;</span>
      <span class="nn">Scanf</span><span class="p">.</span><span class="n">sscanf</span> <span class="kt">string</span> <span class="s2">&quot;%c%02d%_[:]%02d&quot;</span>
        <span class="o">(</span><span class="k">fun</span> <span class="n">sign</span> <span class="n">hour</span> <span class="n">min</span> <span class="o">-&gt;</span>
           <span class="n">min</span> <span class="o">+</span> <span class="n">hour</span> <span class="o">*</span> <span class="o">(</span><span class="k">if</span> <span class="n">sign</span> <span class="o">=</span> <span class="sc">&#39;-&#39;</span> <span class="k">then</span> <span class="o">-</span><span class="mi">60</span> <span class="k">else</span> <span class="mi">60</span><span class="o">))</span>

<span class="c">(* List of date-parsing functions from strings to epoch seconds. *)</span>
<span class="k">let</span> <span class="n">date_parsers</span> <span class="o">=</span>
  <span class="o">[</span>
    <span class="o">(</span><span class="k">fun</span> <span class="kt">string</span> <span class="o">-&gt;</span>
       <span class="nn">Scanf</span><span class="p">.</span><span class="n">sscanf</span> <span class="kt">string</span> <span class="s2">&quot;%d %s %d %d:%d:%d %s&quot;</span>
         <span class="o">(</span><span class="k">fun</span> <span class="n">mday</span> <span class="n">mon</span> <span class="n">year</span> <span class="n">hour</span> <span class="n">min</span> <span class="n">sec</span> <span class="n">tz</span> <span class="o">-&gt;</span>
            <span class="k">let</span> <span class="n">mon</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">assoc</span> <span class="n">mon</span> <span class="n">months</span> <span class="k">in</span>
            <span class="n">fst</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">mktime</span>
                   <span class="o">{</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_sec</span><span class="o">=</span><span class="n">sec</span><span class="o">;</span> <span class="n">tm_min</span><span class="o">=</span><span class="n">min</span><span class="o">;</span> <span class="n">tm_hour</span><span class="o">=</span><span class="n">hour</span><span class="o">;</span>
                    <span class="n">tm_mday</span><span class="o">=</span><span class="n">mday</span><span class="o">;</span> <span class="n">tm_mon</span><span class="o">=</span><span class="n">mon</span><span class="o">;</span> <span class="n">tm_year</span><span class="o">=</span><span class="n">year</span><span class="o">-</span><span class="mi">1900</span><span class="o">;</span>
                    <span class="n">tm_wday</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">tm_yday</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">tm_isdst</span><span class="o">=</span><span class="bp">false</span><span class="o">})</span>
            <span class="o">-.</span> <span class="o">(</span><span class="kt">float</span> <span class="o">(</span><span class="n">parse_tz</span> <span class="n">tz</span><span class="o">)</span> <span class="o">*.</span> <span class="mi">60</span><span class="o">.</span><span class="mi">0</span><span class="o">)));</span>
    <span class="o">(</span><span class="k">fun</span> <span class="kt">string</span> <span class="o">-&gt;</span>
       <span class="nn">Scanf</span><span class="p">.</span><span class="n">sscanf</span> <span class="kt">string</span> <span class="s2">&quot;%3s, %d %s %4d %d:%d:%d %s&quot;</span>
         <span class="o">(</span><span class="k">fun</span> <span class="n">wday</span> <span class="n">mday</span> <span class="n">mon</span> <span class="n">year</span> <span class="n">hour</span> <span class="n">min</span> <span class="n">sec</span> <span class="n">tz</span> <span class="o">-&gt;</span>
            <span class="k">let</span> <span class="n">mon</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">assoc</span> <span class="n">mon</span> <span class="n">months</span> <span class="k">in</span>
            <span class="n">fst</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">mktime</span>
                   <span class="o">{</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_sec</span><span class="o">=</span><span class="n">sec</span><span class="o">;</span> <span class="n">tm_min</span><span class="o">=</span><span class="n">min</span><span class="o">;</span> <span class="n">tm_hour</span><span class="o">=</span><span class="n">hour</span><span class="o">;</span>
                    <span class="n">tm_mday</span><span class="o">=</span><span class="n">mday</span><span class="o">;</span> <span class="n">tm_mon</span><span class="o">=</span><span class="n">mon</span><span class="o">;</span> <span class="n">tm_year</span><span class="o">=</span><span class="n">year</span><span class="o">-</span><span class="mi">1900</span><span class="o">;</span>
                    <span class="n">tm_wday</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">tm_yday</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">tm_isdst</span><span class="o">=</span><span class="bp">false</span><span class="o">})</span>
            <span class="o">-.</span> <span class="o">(</span><span class="kt">float</span> <span class="o">(</span><span class="n">parse_tz</span> <span class="n">tz</span><span class="o">)</span> <span class="o">*.</span> <span class="mi">60</span><span class="o">.</span><span class="mi">0</span><span class="o">)));</span>
    <span class="o">(</span><span class="k">fun</span> <span class="kt">string</span> <span class="o">-&gt;</span>
       <span class="nn">Scanf</span><span class="p">.</span><span class="n">sscanf</span> <span class="kt">string</span> <span class="s2">&quot;%3s, %d %s %2d %d:%d:%d %s&quot;</span>
         <span class="o">(</span><span class="k">fun</span> <span class="n">wday</span> <span class="n">mday</span> <span class="n">mon</span> <span class="n">year</span> <span class="n">hour</span> <span class="n">min</span> <span class="n">sec</span> <span class="n">tz</span> <span class="o">-&gt;</span>
            <span class="k">let</span> <span class="n">mon</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">assoc</span> <span class="n">mon</span> <span class="n">months</span> <span class="k">in</span>
            <span class="n">fst</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">mktime</span>
                   <span class="o">{</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_sec</span><span class="o">=</span><span class="n">sec</span><span class="o">;</span> <span class="n">tm_min</span><span class="o">=</span><span class="n">min</span><span class="o">;</span> <span class="n">tm_hour</span><span class="o">=</span><span class="n">hour</span><span class="o">;</span>
                    <span class="n">tm_mday</span><span class="o">=</span><span class="n">mday</span><span class="o">;</span> <span class="n">tm_mon</span><span class="o">=</span><span class="n">mon</span><span class="o">;</span> <span class="n">tm_year</span><span class="o">=</span><span class="n">year</span><span class="o">;</span>
                    <span class="n">tm_wday</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">tm_yday</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">tm_isdst</span><span class="o">=</span><span class="bp">false</span><span class="o">})</span>
            <span class="o">-.</span> <span class="o">(</span><span class="kt">float</span> <span class="o">(</span><span class="n">parse_tz</span> <span class="n">tz</span><span class="o">)</span> <span class="o">*.</span> <span class="mi">60</span><span class="o">.</span><span class="mi">0</span><span class="o">)));</span>
  <span class="o">]</span>

<span class="c">(* Tries each of the above date parsers, one at a time, until one</span>
<span class="c">   of them doesn&#39;t throw an exception. If they all fail, returns</span>
<span class="c">   a value of 0.0. *)</span>
<span class="k">let</span> <span class="n">getdate</span> <span class="kt">string</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">result</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">parsers</span> <span class="o">=</span> <span class="n">ref</span> <span class="n">date_parsers</span> <span class="k">in</span>
  <span class="k">while</span> <span class="o">!</span><span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">parsers</span> <span class="o">&lt;&gt;</span> <span class="bp">[]</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">parse</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">hd</span> <span class="o">!</span><span class="n">parsers</span> <span class="k">in</span>
    <span class="n">parsers</span> <span class="o">:=</span> <span class="nn">List</span><span class="p">.</span><span class="n">tl</span> <span class="o">!</span><span class="n">parsers</span><span class="o">;</span>
    <span class="k">try</span> <span class="n">result</span> <span class="o">:=</span> <span class="n">parse</span> <span class="kt">string</span> <span class="k">with</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span>
  <span class="k">done</span><span class="o">;</span>
  <span class="o">!</span><span class="n">result</span>

<span class="c">(* Formats a date given in epoch seconds for display. *)</span>
<span class="k">let</span> <span class="n">fmtdate</span> <span class="n">epoch</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">tm</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">localtime</span> <span class="n">epoch</span> <span class="k">in</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;%02d:%02d:%02d %04d/%02d/%02d&quot;</span>
    <span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_hour</span> <span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_min</span> <span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_sec</span>
    <span class="o">(</span><span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_year</span> <span class="o">+</span> <span class="mi">1900</span><span class="o">)</span> <span class="o">(</span><span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_mon</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_mday</span>

<span class="c">(* Formats the difference between two epoch times for display. *)</span>
<span class="k">let</span> <span class="n">fmtdelta</span> <span class="n">delta</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">sign</span>    <span class="o">=</span> <span class="k">if</span> <span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span> <span class="k">then</span> <span class="sc">&#39;-&#39;</span> <span class="k">else</span> <span class="sc">&#39; &#39;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">delta</span>   <span class="o">=</span> <span class="n">abs_float</span> <span class="n">delta</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">seconds</span> <span class="o">=</span> <span class="n">mod_float</span> <span class="n">delta</span> <span class="mi">60</span><span class="o">.</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">delta</span>   <span class="o">=</span> <span class="o">(</span><span class="n">delta</span> <span class="o">-.</span> <span class="n">seconds</span><span class="o">)</span> <span class="o">/.</span> <span class="mi">60</span><span class="o">.</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">minutes</span> <span class="o">=</span> <span class="n">mod_float</span> <span class="n">delta</span> <span class="mi">60</span><span class="o">.</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">delta</span>   <span class="o">=</span> <span class="o">(</span><span class="n">delta</span> <span class="o">-.</span> <span class="n">minutes</span><span class="o">)</span> <span class="o">/.</span> <span class="mi">60</span><span class="o">.</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">hours</span>   <span class="o">=</span> <span class="n">mod_float</span> <span class="n">delta</span> <span class="mi">24</span><span class="o">.</span> <span class="k">in</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;%c%02.f:%02.f:%02.f&quot;</span> <span class="n">sign</span> <span class="n">hours</span> <span class="n">minutes</span> <span class="n">seconds</span>

<span class="c">(* Process the header for a single email. *)</span>
<span class="k">let</span> <span class="n">process_header</span> <span class="n">header</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">start_from</span> <span class="o">=</span>
    <span class="k">try</span> <span class="nn">List</span><span class="p">.</span><span class="n">assoc</span> <span class="s2">&quot;From&quot;</span> <span class="n">header</span><span class="o">.</span><span class="n">params</span>
    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="n">header</span><span class="o">.</span><span class="n">from</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">start_from</span> <span class="o">=</span>
    <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span>
      <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;.*@</span><span class="se">\\</span><span class="s2">([^ &gt;]*</span><span class="se">\\</span><span class="s2">).*&quot;</span><span class="o">)</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">1&quot;</span> <span class="n">start_from</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">start_date</span> <span class="o">=</span>
    <span class="k">try</span> <span class="nn">List</span><span class="p">.</span><span class="n">assoc</span> <span class="s2">&quot;Date&quot;</span> <span class="n">header</span><span class="o">.</span><span class="n">params</span>
    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="s2">&quot;&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">start_date</span> <span class="o">=</span>
    <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span>
      <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot; +(.*$&quot;</span><span class="o">)</span> <span class="s2">&quot;&quot;</span> <span class="n">start_date</span> <span class="k">in</span>
  <span class="k">let</span> <span class="k">then&#39;</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="n">getdate</span> <span class="n">start_date</span><span class="o">)</span> <span class="k">in</span>
  <span class="n">print_result</span> <span class="s2">&quot;Sender&quot;</span> <span class="s2">&quot;Recipient&quot;</span> <span class="s2">&quot;Time&quot;</span> <span class="s2">&quot; Delta&quot;</span><span class="o">;</span>
  <span class="n">print_result</span> <span class="s2">&quot;Start&quot;</span> <span class="n">start_from</span> <span class="o">(</span><span class="n">fmtdate</span> <span class="o">!</span><span class="k">then&#39;</span><span class="o">)</span> <span class="s2">&quot;&quot;</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">prevfrom</span> <span class="o">=</span> <span class="n">ref</span> <span class="n">start_from</span> <span class="k">in</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="k">value</span><span class="o">)</span> <span class="o">-&gt;</span>
       <span class="k">if</span> <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;Received&quot;</span>
       <span class="k">then</span>
         <span class="k">begin</span>
           <span class="k">let</span> <span class="k">when&#39;</span> <span class="o">=</span>
             <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span>
               <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;.*; +</span><span class="se">\\</span><span class="s2">(.*</span><span class="se">\\</span><span class="s2">)$&quot;</span><span class="o">)</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">1&quot;</span> <span class="k">value</span> <span class="k">in</span>
           <span class="k">let</span> <span class="k">when&#39;</span> <span class="o">=</span>
             <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span>
               <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot; +(.*$&quot;</span><span class="o">)</span> <span class="s2">&quot;&quot;</span> <span class="k">when&#39;</span> <span class="k">in</span>
           <span class="k">let</span> <span class="n">from&#39;</span> <span class="o">=</span>
             <span class="k">try</span>
               <span class="n">ignore</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span>
                         <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;from +</span><span class="se">\\</span><span class="s2">([^ )]+</span><span class="se">\\</span><span class="s2">)&quot;</span><span class="o">)</span> <span class="k">value</span> <span class="mi">0</span><span class="o">);</span>
               <span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">1</span> <span class="k">value</span>
             <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
               <span class="k">try</span>
                 <span class="n">ignore</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span>
                           <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;(</span><span class="se">\\</span><span class="s2">([^)]*</span><span class="se">\\</span><span class="s2">))&quot;</span><span class="o">)</span> <span class="k">value</span> <span class="mi">0</span><span class="o">);</span>
                 <span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">1</span> <span class="k">value</span>
               <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="s2">&quot;&quot;</span> <span class="k">in</span>
           <span class="k">let</span> <span class="n">from&#39;</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;)$&quot;</span><span class="o">)</span> <span class="s2">&quot;&quot;</span> <span class="n">from&#39;</span> <span class="k">in</span>
           <span class="k">let</span> <span class="n">by&#39;</span> <span class="o">=</span>
             <span class="k">try</span>
               <span class="n">ignore</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span>
                         <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;by +</span><span class="se">\\</span><span class="s2">([^ ]+</span><span class="se">\\</span><span class="s2">.[^ ]+</span><span class="se">\\</span><span class="s2">)&quot;</span><span class="o">)</span> <span class="k">value</span> <span class="mi">0</span><span class="o">);</span>
               <span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">1</span> <span class="k">value</span>
             <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="s2">&quot;&quot;</span> <span class="k">in</span>
           <span class="k">let</span> <span class="n">now</span> <span class="o">=</span> <span class="n">getdate</span> <span class="k">when&#39;</span> <span class="k">in</span>
           <span class="k">let</span> <span class="n">delta</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-.</span> <span class="o">!</span><span class="k">then&#39;</span> <span class="k">in</span>
           <span class="n">print_result</span>
             <span class="o">(</span><span class="k">if</span> <span class="o">!</span><span class="n">prevfrom</span> <span class="o">&lt;&gt;</span> <span class="s2">&quot;&quot;</span> <span class="k">then</span> <span class="o">!</span><span class="n">prevfrom</span> <span class="k">else</span> <span class="n">from&#39;</span><span class="o">)</span>
             <span class="n">by&#39;</span>
             <span class="o">(</span><span class="n">fmtdate</span> <span class="n">now</span><span class="o">)</span>
             <span class="o">(</span><span class="n">fmtdelta</span> <span class="n">delta</span><span class="o">);</span>
           <span class="k">then&#39;</span> <span class="o">:=</span> <span class="n">now</span><span class="o">;</span>
           <span class="n">prevfrom</span> <span class="o">:=</span> <span class="n">by&#39;</span><span class="o">;</span>
         <span class="k">end</span><span class="o">)</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="n">header</span><span class="o">.</span><span class="n">params</span><span class="o">);</span>
  <span class="n">print_newline</span> <span class="bp">()</span><span class="o">;</span>
  <span class="n">flush</span> <span class="n">stdout</span>

<span class="c">(* Process all emails from standard input. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">iter</span> <span class="n">process_header</span> <span class="o">(</span><span class="n">header_stream_of_channel</span> <span class="n">stdin</span><span class="o">)</span></PRE
></TD
></TR
></TABLE
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="numbers.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="arrays.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Numbers</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
>&nbsp;</TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Arrays</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>
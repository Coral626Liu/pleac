<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN""http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>Internet Services</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="PLEAC-Objective CAML "
HREF="index.html"><LINK
REL="PREVIOUS"
TITLE="Sockets"
HREF="sockets.html"><LINK
REL="NEXT"
TITLE="CGI Programming"
HREF="cgiprogramming.html"><style type="text/css">td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
pre { line-height: 125%; }

  </style></head
><BODY TEXT="#cecece" BGCOLOR="#4f6f6f" LINK="#f5deb3" VLINK="#d5ae83"
CLASS="SECT1"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>PLEAC-Objective CAML </TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="sockets.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
></TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="cgiprogramming.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="INTERNETSERVICES"
>18. Internet Services</A
></H1
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN978"
>Simple DNS Lookups</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">let</span> <span class="n">addresses</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">gethostbyname</span> <span class="n">name</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">addresses</span> <span class="o">=</span>
      <span class="nn">Array</span><span class="p">.</span><span class="n">map</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">string_of_inet_addr</span> <span class="n">addresses</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">h_addr_list</span> <span class="k">in</span>
    <span class="c">(* addresses is an array of IP addresses *)</span>
    <span class="nn">Array</span><span class="p">.</span><span class="n">iter</span> <span class="n">print_endline</span> <span class="n">addresses</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Can&#39;t resolve %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">name</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">let</span> <span class="n">host</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">gethostbyaddr</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">inet_addr_of_string</span> <span class="n">address</span><span class="o">)</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">name</span> <span class="o">=</span> <span class="n">host</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">h_name</span> <span class="k">in</span>
    <span class="c">(* name is the hostname (&quot;www.perl.com&quot;) *)</span>
    <span class="n">print_endline</span> <span class="n">name</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Can&#39;t resolve %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">address</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">let</span> <span class="n">host</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">gethostbyaddr</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">inet_addr_of_string</span> <span class="n">address</span><span class="o">)</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">name</span> <span class="o">=</span> <span class="n">host</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">h_name</span> <span class="k">in</span>
    <span class="k">try</span>
      <span class="k">let</span> <span class="n">addresses</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">gethostbyname</span> <span class="n">name</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">addresses</span> <span class="o">=</span>
        <span class="nn">Array</span><span class="p">.</span><span class="n">map</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">string_of_inet_addr</span> <span class="n">addresses</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">h_addr_list</span> <span class="k">in</span>
      <span class="nn">Array</span><span class="p">.</span><span class="n">iter</span> <span class="n">print_endline</span> <span class="n">addresses</span><span class="o">;</span>
      <span class="k">let</span> <span class="n">found</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">mem</span> <span class="n">address</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="n">addresses</span><span class="o">)</span> <span class="k">in</span>
      <span class="n">print_endline</span> <span class="o">(</span><span class="k">if</span> <span class="n">found</span> <span class="k">then</span> <span class="s2">&quot;found&quot;</span> <span class="k">else</span> <span class="s2">&quot;not found&quot;</span><span class="o">)</span>
    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Can&#39;t look up %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">name</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Can&#39;t look up %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">address</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* mxhost - find mx exchangers for a host *)</span>

<span class="c">(* Though there is an experimental new DNS resolver for OCaml called</span>
<span class="c">   Netdns, it does not yet support resolving MX records. For now, we&#39;ll</span>
<span class="c">   use Net::DNS through perl4caml until a better solution is available.</span>
<span class="c">*)</span>
<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+perl&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;perl4caml.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="nn">Perl</span><span class="p">.</span><span class="n">eval</span> <span class="s2">&quot;use Net::DNS&quot;</span>

<span class="k">let</span> <span class="n">host</span> <span class="o">=</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span>
<span class="k">let</span> <span class="n">res</span> <span class="o">=</span> <span class="nn">Perl</span><span class="p">.</span><span class="n">call_class_method</span> <span class="s2">&quot;Net::DNS::Resolver&quot;</span> <span class="s2">&quot;new&quot;</span> <span class="bp">[]</span>
<span class="k">let</span> <span class="n">mx</span> <span class="o">=</span> <span class="nn">Perl</span><span class="p">.</span><span class="n">call_array</span> <span class="o">~</span><span class="n">fn</span><span class="o">:</span><span class="s2">&quot;mx&quot;</span> <span class="o">[</span><span class="n">res</span><span class="o">;</span> <span class="nn">Perl</span><span class="p">.</span><span class="n">sv_of_string</span> <span class="n">host</span><span class="o">]</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">mx</span> <span class="o">=</span> <span class="bp">[]</span> <span class="k">then</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Can&#39;t find MX records for %s (%s)</span><span class="se">\n</span><span class="s2">&quot;</span>
      <span class="n">host</span> <span class="o">(</span><span class="nn">Perl</span><span class="p">.</span><span class="n">string_of_sv</span> <span class="o">(</span><span class="nn">Perl</span><span class="p">.</span><span class="n">call_method</span> <span class="n">res</span> <span class="s2">&quot;errorstring&quot;</span> <span class="bp">[]</span><span class="o">))</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">record</span> <span class="o">-&gt;</span>
       <span class="k">let</span> <span class="n">preference</span> <span class="o">=</span> <span class="nn">Perl</span><span class="p">.</span><span class="n">call_method</span> <span class="n">record</span> <span class="s2">&quot;preference&quot;</span> <span class="bp">[]</span> <span class="k">in</span>
       <span class="k">let</span> <span class="n">exchange</span> <span class="o">=</span> <span class="nn">Perl</span><span class="p">.</span><span class="n">call_method</span> <span class="n">record</span> <span class="s2">&quot;exchange&quot;</span> <span class="bp">[]</span> <span class="k">in</span>
       <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s %s</span><span class="se">\n</span><span class="s2">&quot;</span>
         <span class="o">(</span><span class="nn">Perl</span><span class="p">.</span><span class="n">string_of_sv</span> <span class="n">preference</span><span class="o">)</span>
         <span class="o">(</span><span class="nn">Perl</span><span class="p">.</span><span class="n">string_of_sv</span> <span class="n">exchange</span><span class="o">))</span>
    <span class="n">mx</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* hostaddrs - canonize name and show addresses *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">name</span> <span class="o">=</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span>
<span class="k">let</span> <span class="n">hent</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">gethostbyname</span> <span class="n">name</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s =&gt; %s</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">hent</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">h_name</span>    <span class="c">(* in case different *)</span>
    <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot; &quot;</span>
       <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span>
          <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">map</span>
             <span class="nn">Unix</span><span class="p">.</span><span class="n">string_of_inet_addr</span>
             <span class="n">hent</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">h_addr_list</span><span class="o">)))</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN981"
>Being an FTP Client</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* The Netclient package from Ocamlnet provides an event-driven</span>
<span class="c">   FTP client. This client does not currently support uploading.</span>

<span class="c">   Ocamlnet is available here:</span>
<span class="c">   http://projects.camlcity.org/projects/ocamlnet.html</span>

<span class="c">   This recipe assumes it has been installed with findlib. *)</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netclient&quot;</span><span class="o">;;</span>

<span class="c">(* Create an FTP client instance. *)</span>
<span class="k">let</span> <span class="n">ftp</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Ftp_client</span><span class="p">.</span><span class="n">ftp_client</span> <span class="bp">()</span>

<span class="c">(* Build and execute a chain of FTP methods. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">ftp</span><span class="o">#</span><span class="n">add</span> <span class="o">(</span><span class="k">new</span> <span class="nn">Ftp_client</span><span class="p">.</span><span class="n">connect_method</span> <span class="o">~</span><span class="n">host</span><span class="o">:</span><span class="s2">&quot;127.0.0.1&quot;</span> <span class="bp">()</span><span class="o">);</span>
  <span class="n">ftp</span><span class="o">#</span><span class="n">add</span> <span class="o">(</span><span class="k">new</span> <span class="nn">Ftp_client</span><span class="p">.</span><span class="n">login_method</span>
             <span class="o">~</span><span class="n">user</span><span class="o">:</span><span class="s2">&quot;anonymous&quot;</span>
             <span class="o">~</span><span class="n">get_password</span><span class="o">:(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="s2">&quot;user@example.com&quot;</span><span class="o">)</span>
             <span class="o">~</span><span class="n">get_account</span><span class="o">:(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="s2">&quot;anonymous&quot;</span><span class="o">)</span> <span class="bp">()</span><span class="o">);</span>
  <span class="n">ftp</span><span class="o">#</span><span class="n">add</span> <span class="o">(</span><span class="k">new</span> <span class="nn">Ftp_client</span><span class="p">.</span><span class="n">walk_method</span> <span class="o">(`</span><span class="nc">Dir</span> <span class="s2">&quot;/pub&quot;</span><span class="o">));</span>
  <span class="k">let</span> <span class="n">ch</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">output_channel</span> <span class="o">(</span><span class="n">open_out</span> <span class="s2">&quot;output.txt&quot;</span><span class="o">)</span> <span class="k">in</span>
  <span class="n">ftp</span><span class="o">#</span><span class="n">add</span> <span class="o">(</span><span class="k">new</span> <span class="nn">Ftp_client</span><span class="p">.</span><span class="n">get_method</span>
             <span class="o">~</span><span class="n">file</span><span class="o">:(`</span><span class="nc">Verbatim</span> <span class="s2">&quot;index.txt&quot;</span><span class="o">)</span>
             <span class="o">~</span><span class="n">representation</span><span class="o">:`</span><span class="nc">Image</span>
             <span class="o">~</span><span class="n">store</span><span class="o">:(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="o">`</span><span class="nc">File_structure</span> <span class="n">ch</span><span class="o">)</span> <span class="bp">()</span><span class="o">);</span>
  <span class="n">ftp</span><span class="o">#</span><span class="n">run</span> <span class="bp">()</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* If an error occurs, it will be exposed by the &quot;state&quot; property. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">ftp</span><span class="o">#</span><span class="n">state</span> <span class="k">with</span>
    <span class="o">|</span> <span class="o">`</span><span class="nc">Error</span> <span class="o">(</span><span class="nn">Ftp_client</span><span class="p">.</span><span class="nc">FTP_error</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)))</span> <span class="o">-&gt;</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Error: %s</span><span class="se">\n</span><span class="s2">%!&quot;</span>
          <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">error_message</span> <span class="n">e</span><span class="o">)</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* To determine the current working directory, send invoke the `PWD</span>
<span class="c">   command and inspect the result in a callback. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">ftp</span><span class="o">#</span><span class="n">add</span> <span class="o">(</span><span class="k">new</span> <span class="nn">Ftp_client</span><span class="p">.</span><span class="n">invoke_method</span>
             <span class="o">~</span><span class="n">command</span><span class="o">:`</span><span class="nc">PWD</span>
             <span class="o">~</span><span class="n">process_result</span><span class="o">:(</span><span class="k">fun</span> <span class="n">state</span> <span class="o">(</span><span class="n">code</span><span class="o">,</span> <span class="n">message</span><span class="o">)</span> <span class="o">-&gt;</span>
                                <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span>
                                  <span class="s2">&quot;I&#39;m in the directory %s</span><span class="se">\n</span><span class="s2">%!&quot;</span>
                                  <span class="n">message</span><span class="o">)</span> <span class="bp">()</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Use mkdir_method and rmdir_method to make and remove directories from</span>
<span class="c">   the remote server. Use the optional ~onerror argument to specify an</span>
<span class="c">   error handler. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">ftp</span><span class="o">#</span><span class="n">add</span>
    <span class="o">~</span><span class="n">onerror</span><span class="o">:(</span><span class="k">fun</span> <span class="n">e</span> <span class="o">-&gt;</span>
                <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Can&#39;t create /ocaml: %s</span><span class="se">\n</span><span class="s2">%!&quot;</span>
                  <span class="o">(</span><span class="nn">Printexc</span><span class="p">.</span><span class="n">to_string</span> <span class="n">e</span><span class="o">))</span>
    <span class="o">(</span><span class="k">new</span> <span class="nn">Ftp_client</span><span class="p">.</span><span class="n">mkdir_method</span> <span class="o">(`</span><span class="nc">Verbatim</span> <span class="s2">&quot;/pub/ocaml&quot;</span><span class="o">))</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Use a list_method to get a list of files in a remote directory. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">create</span> <span class="mi">256</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">ch</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">output_buffer</span> <span class="n">buffer</span> <span class="k">in</span>
  <span class="n">ftp</span><span class="o">#</span><span class="n">add</span>
    <span class="o">~</span><span class="n">onsuccess</span><span class="o">:(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="n">print_endline</span> <span class="o">(</span><span class="nn">Buffer</span><span class="p">.</span><span class="n">contents</span> <span class="n">buffer</span><span class="o">))</span>
    <span class="o">~</span><span class="n">onerror</span><span class="o">:(</span><span class="k">fun</span> <span class="n">e</span> <span class="o">-&gt;</span>
                <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Can&#39;t get a list of files in /pub: %s</span><span class="se">\n</span><span class="s2">%!&quot;</span>
                  <span class="o">(</span><span class="nn">Printexc</span><span class="p">.</span><span class="n">to_string</span> <span class="n">e</span><span class="o">))</span>
    <span class="o">(</span><span class="k">new</span> <span class="nn">Ftp_client</span><span class="p">.</span><span class="n">list_method</span>
       <span class="o">~</span><span class="n">dir</span><span class="o">:(`</span><span class="nc">Verbatim</span> <span class="s2">&quot;/pub&quot;</span><span class="o">)</span>
       <span class="o">~</span><span class="n">representation</span><span class="o">:`</span><span class="nc">Image</span>
       <span class="o">~</span><span class="n">store</span><span class="o">:(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="o">`</span><span class="nc">File_structure</span> <span class="n">ch</span><span class="o">)</span> <span class="bp">()</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Use `QUIT followed by ftp#abort to close the connection and exit</span>
<span class="c">   the event loop. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">ftp</span><span class="o">#</span><span class="n">add</span> <span class="o">(</span><span class="k">new</span> <span class="nn">Ftp_client</span><span class="p">.</span><span class="n">invoke_method</span>
             <span class="o">~</span><span class="n">command</span><span class="o">:`</span><span class="nc">QUIT</span>
             <span class="o">~</span><span class="n">process_result</span><span class="o">:(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">ftp</span><span class="o">#</span><span class="n">abort</span> <span class="bp">()</span><span class="o">)</span> <span class="bp">()</span><span class="o">)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN984"
>Sending Mail</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* Use Netsendmail, part of the Netstring package that comes with</span>
<span class="c">   Ocamlnet, to send mail through a command-line mailer program. *)</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netstring&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Netsendmail</span><span class="p">.</span><span class="n">sendmail</span>
    <span class="o">~</span><span class="n">mailer</span><span class="o">:</span><span class="s2">&quot;/usr/sbin/sendmail&quot;</span>  <span class="c">(* defaults to &quot;/usr/lib/sendmail&quot; *)</span>
    <span class="o">(</span><span class="nn">Netsendmail</span><span class="p">.</span><span class="n">compose</span>
       <span class="o">~</span><span class="n">from_addr</span><span class="o">:(</span><span class="n">from_name</span><span class="o">,</span> <span class="n">from_address</span><span class="o">)</span>
       <span class="o">~</span><span class="n">to_addrs</span><span class="o">:[(</span><span class="n">to_name</span><span class="o">,</span> <span class="n">to_address</span><span class="o">)]</span>
       <span class="o">~</span><span class="n">subject</span><span class="o">:</span><span class="n">subject</span>
       <span class="n">body</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* You can also open a pipe directly to sendmail. *)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">sendmail</span> <span class="o">=</span>
    <span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_out</span> <span class="s2">&quot;/usr/lib/sendmail -oi -t -odq&quot;</span> <span class="k">in</span>
  <span class="n">output_string</span> <span class="n">sendmail</span> <span class="s2">&quot;\</span>
<span class="s2">From: User Originating Mail &lt;me@host&gt;</span>
<span class="s2">To: Final Destination &lt;you@otherhost&gt;</span>
<span class="s2">Subject: A relevant subject line</span>

<span class="s2">Body of the message goes here, in as many lines as you like.</span>
<span class="s2">&quot;</span><span class="o">;</span>
  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_out</span> <span class="n">sendmail</span><span class="o">)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN987"
>Reading and Posting Usenet News Messages</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* There is no NNTP library available for OCaml. With a little</span>
<span class="c">   preparation, we can easily use the one that comes with Perl</span>
<span class="c">   using perl4caml (http://merjis.com/developers/perl4caml) *)</span>

<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+perl&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;perl4caml.cma&quot;</span><span class="o">;;</span>

<span class="k">module</span> <span class="nc">NNTP</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">open</span> <span class="nc">Perl</span>
  <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">eval</span> <span class="s2">&quot;use Net::NNTP&quot;</span>

  <span class="c">(* Returned by &quot;list&quot; method so that newsgroups stay sorted. *)</span>
  <span class="k">module</span> <span class="nc">GroupMap</span> <span class="o">=</span> <span class="nn">Map</span><span class="p">.</span><span class="nc">Make</span><span class="o">(</span><span class="nc">String</span><span class="o">)</span>

  <span class="c">(* Wrapper for Net::NNTP class. *)</span>
  <span class="k">class</span> <span class="n">nntp</span> <span class="n">host</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">nntp</span> <span class="o">=</span>
      <span class="n">call_class_method</span> <span class="s2">&quot;Net::NNTP&quot;</span> <span class="s2">&quot;new&quot;</span> <span class="o">[</span><span class="n">sv_of_string</span> <span class="n">host</span><span class="o">]</span> <span class="k">in</span>

    <span class="c">(* Raise a Failure exception if we couldn&#39;t connect. *)</span>
    <span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
      <span class="k">if</span> <span class="n">sv_is_undef</span> <span class="n">nntp</span>
      <span class="k">then</span> <span class="n">failwith</span> <span class="o">(</span><span class="n">string_of_sv</span> <span class="o">(</span><span class="n">eval</span> <span class="s2">&quot;$!&quot;</span><span class="o">))</span> <span class="k">in</span>

    <span class="c">(* Helper function to transform nullable string arrays to OCaml. *)</span>
    <span class="k">let</span> <span class="n">maybe_string_list</span> <span class="n">sv</span> <span class="o">=</span>
      <span class="k">if</span> <span class="n">sv_is_undef</span> <span class="n">sv</span>
      <span class="k">then</span> <span class="k">raise</span> <span class="nc">Not_found</span>
      <span class="k">else</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">string_of_sv</span> <span class="o">(</span><span class="n">list_of_av</span> <span class="o">(</span><span class="n">deref_array</span> <span class="n">sv</span><span class="o">))</span> <span class="k">in</span>

  <span class="k">object</span> <span class="o">(</span><span class="n">self</span><span class="o">)</span>
    <span class="k">val</span> <span class="n">nntp</span> <span class="o">=</span> <span class="n">nntp</span>

    <span class="k">method</span> <span class="n">group</span> <span class="n">name</span> <span class="o">=</span>
      <span class="k">match</span> <span class="n">call_method_array</span> <span class="n">nntp</span> <span class="s2">&quot;group&quot;</span> <span class="o">[</span><span class="n">sv_of_string</span> <span class="n">name</span><span class="o">]</span> <span class="k">with</span>
        <span class="o">|</span> <span class="o">[</span><span class="n">narticles</span><span class="o">;</span> <span class="n">first</span><span class="o">;</span> <span class="n">last</span><span class="o">;</span> <span class="n">name</span><span class="o">]</span> <span class="o">-&gt;</span>
            <span class="o">(</span><span class="n">int_of_sv</span> <span class="n">narticles</span><span class="o">,</span> <span class="n">int_of_sv</span> <span class="n">first</span><span class="o">,</span>
             <span class="n">int_of_sv</span> <span class="n">last</span><span class="o">,</span> <span class="n">string_of_sv</span> <span class="n">name</span><span class="o">)</span>
        <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">raise</span> <span class="nc">Not_found</span>

    <span class="k">method</span> <span class="n">head</span> <span class="n">msgid</span> <span class="o">=</span>
      <span class="n">maybe_string_list</span> <span class="o">(</span><span class="n">call_method</span> <span class="n">nntp</span> <span class="s2">&quot;head&quot;</span> <span class="o">[</span><span class="n">sv_of_int</span> <span class="n">msgid</span><span class="o">])</span>

    <span class="k">method</span> <span class="n">body</span> <span class="n">msgid</span> <span class="o">=</span>
      <span class="n">maybe_string_list</span> <span class="o">(</span><span class="n">call_method</span> <span class="n">nntp</span> <span class="s2">&quot;body&quot;</span> <span class="o">[</span><span class="n">sv_of_int</span> <span class="n">msgid</span><span class="o">])</span>

    <span class="k">method</span> <span class="n">article</span> <span class="n">msgid</span> <span class="o">=</span>
      <span class="n">maybe_string_list</span> <span class="o">(</span><span class="n">call_method</span> <span class="n">nntp</span> <span class="s2">&quot;article&quot;</span> <span class="o">[</span><span class="n">sv_of_int</span> <span class="n">msgid</span><span class="o">])</span>

    <span class="k">method</span> <span class="n">postok</span> <span class="bp">()</span> <span class="o">=</span>
      <span class="n">bool_of_sv</span> <span class="o">(</span><span class="n">call_method</span> <span class="n">nntp</span> <span class="s2">&quot;postok&quot;</span> <span class="bp">[]</span><span class="o">)</span>

    <span class="k">method</span> <span class="n">post</span> <span class="n">lines</span> <span class="o">=</span>
      <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">sv_of_string</span> <span class="n">lines</span> <span class="k">in</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">sv_is_undef</span> <span class="o">(</span><span class="n">call_method</span> <span class="n">nntp</span> <span class="s2">&quot;post&quot;</span> <span class="n">lines</span><span class="o">))</span>
      <span class="k">then</span> <span class="n">failwith</span> <span class="o">(</span><span class="n">string_of_sv</span> <span class="o">(</span><span class="n">eval</span> <span class="s2">&quot;$!&quot;</span><span class="o">))</span>

    <span class="k">method</span> <span class="kt">list</span> <span class="bp">()</span> <span class="o">=</span>
      <span class="k">let</span> <span class="n">hv</span> <span class="o">=</span> <span class="n">deref_hash</span> <span class="o">(</span><span class="n">call_method</span> <span class="n">nntp</span> <span class="s2">&quot;list&quot;</span> <span class="bp">[]</span><span class="o">)</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">map</span> <span class="o">=</span> <span class="n">ref</span> <span class="nn">GroupMap</span><span class="p">.</span><span class="n">empty</span> <span class="k">in</span>
      <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
        <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">info</span><span class="o">)</span> <span class="o">-&gt;</span>
           <span class="n">map</span> <span class="o">:=</span>
             <span class="nn">GroupMap</span><span class="p">.</span><span class="n">add</span>
               <span class="n">name</span>
               <span class="o">(</span><span class="k">match</span> <span class="n">list_of_av</span> <span class="o">(</span><span class="n">deref_array</span> <span class="n">info</span><span class="o">)</span> <span class="k">with</span>
                  <span class="o">|</span> <span class="o">[</span><span class="n">last</span><span class="o">;</span> <span class="n">first</span><span class="o">;</span> <span class="n">flags</span><span class="o">]</span> <span class="o">-&gt;</span>
                      <span class="o">(</span><span class="n">int_of_sv</span> <span class="n">last</span><span class="o">,</span> <span class="n">int_of_sv</span> <span class="n">first</span><span class="o">,</span>
                       <span class="n">string_of_sv</span> <span class="n">flags</span><span class="o">)</span>
                  <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">assert</span> <span class="bp">false</span><span class="o">)</span>
               <span class="o">!</span><span class="n">map</span><span class="o">)</span>
        <span class="o">(</span><span class="n">assoc_of_hv</span> <span class="n">hv</span><span class="o">);</span>
      <span class="o">!</span><span class="n">map</span>

    <span class="k">method</span> <span class="n">quit</span> <span class="bp">()</span> <span class="o">=</span>
      <span class="n">ignore</span> <span class="o">(</span><span class="n">call_method</span> <span class="n">nntp</span> <span class="s2">&quot;quit&quot;</span> <span class="bp">[]</span><span class="o">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Connect to an NNTP server by creating an &quot;nntp&quot; object. *)</span>
<span class="k">let</span> <span class="n">server</span> <span class="o">=</span>
  <span class="k">try</span> <span class="k">new</span> <span class="nn">NNTP</span><span class="p">.</span><span class="n">nntp</span> <span class="s2">&quot;news.west.cox.net&quot;</span>
  <span class="k">with</span> <span class="nc">Failure</span> <span class="n">s</span> <span class="o">-&gt;</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Can&#39;t connect to news server: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">s</span><span class="o">;</span>
    <span class="n">exit</span> <span class="mi">1</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Select a newsgroup and retrieve its stats. *)</span>
<span class="k">let</span> <span class="o">(</span><span class="n">narticles</span><span class="o">,</span> <span class="n">first</span><span class="o">,</span> <span class="n">last</span><span class="o">,</span> <span class="n">name</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">try</span> <span class="n">server</span><span class="o">#</span><span class="n">group</span> <span class="s2">&quot;misc.test&quot;</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Can&#39;t select misc.test</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
    <span class="n">exit</span> <span class="mi">1</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Get the headers from the last article. *)</span>
<span class="k">let</span> <span class="n">headers</span> <span class="o">=</span>
  <span class="k">try</span> <span class="n">server</span><span class="o">#</span><span class="n">head</span> <span class="n">last</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Can&#39;t get headers from article %d in %s</span><span class="se">\n</span><span class="s2">&quot;</span>
      <span class="n">last</span> <span class="n">name</span><span class="o">;</span>
    <span class="n">exit</span> <span class="mi">1</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Get the body from the last article. *)</span>
<span class="k">let</span> <span class="n">body</span> <span class="o">=</span>
  <span class="k">try</span> <span class="n">server</span><span class="o">#</span><span class="n">head</span> <span class="n">last</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Can&#39;t get body from article %d in %s</span><span class="se">\n</span><span class="s2">&quot;</span>
      <span class="n">last</span> <span class="n">name</span><span class="o">;</span>
    <span class="n">exit</span> <span class="mi">1</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Get the headers and body from the last article. *)</span>
<span class="k">let</span> <span class="n">article</span> <span class="o">=</span>
  <span class="k">try</span> <span class="n">server</span><span class="o">#</span><span class="n">head</span> <span class="n">last</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Can&#39;t get article from article %d in %s</span><span class="se">\n</span><span class="s2">&quot;</span>
      <span class="n">last</span> <span class="n">name</span><span class="o">;</span>
    <span class="n">exit</span> <span class="mi">1</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Determine if posting is allowed with this server. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="n">server</span><span class="o">#</span><span class="n">postok</span> <span class="bp">()</span><span class="o">)</span>
  <span class="k">then</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Server didn&#39;t tell me I could post.</span><span class="se">\n</span><span class="s2">&quot;</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Post a message. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">begin</span>
    <span class="k">try</span> <span class="n">server</span><span class="o">#</span><span class="n">post</span> <span class="n">lines</span>
    <span class="k">with</span> <span class="nc">Failure</span> <span class="n">s</span> <span class="o">-&gt;</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Can&#39;t post: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">s</span><span class="o">;</span>
      <span class="n">exit</span> <span class="mi">1</span>
  <span class="k">end</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Get the complete list of newsgroups. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">groupmap</span> <span class="o">=</span> <span class="n">server</span><span class="o">#</span><span class="kt">list</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="nn">NNTP</span><span class="p">.</span><span class="nn">GroupMap</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">group</span> <span class="o">(</span><span class="n">last</span><span class="o">,</span> <span class="n">first</span><span class="o">,</span> <span class="n">flags</span><span class="o">)</span> <span class="o">-&gt;</span>
       <span class="k">if</span> <span class="n">flags</span> <span class="o">=</span> <span class="s2">&quot;y&quot;</span>
       <span class="k">then</span> <span class="c">(* I can post to [group] *)</span> <span class="bp">()</span><span class="o">)</span>
    <span class="n">groupmap</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN990"
>Reading Mail with POP3</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* Use Netpop, which is part of Ocamlnet. *)</span>
<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;pop&quot;</span><span class="o">;;</span>

<span class="c">(* To create a Netpop client, you need to look up the server address</span>
<span class="c">   and build a network connection first. Netpop uses wrappers called</span>
<span class="c">   Netchannels to abstract the input and output channels. *)</span>
<span class="k">let</span> <span class="n">inet_addr</span> <span class="o">=</span>
  <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">gethostbyname</span> <span class="n">mail_server</span><span class="o">).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">h_addr_list</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span>
<span class="k">let</span> <span class="n">addr</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">ADDR_INET</span> <span class="o">(</span><span class="n">inet_addr</span><span class="o">,</span> <span class="nn">Netpop</span><span class="p">.</span><span class="n">tcp_port</span><span class="o">)</span>
<span class="k">let</span> <span class="n">ic</span><span class="o">,</span> <span class="n">oc</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">open_connection</span> <span class="n">addr</span>
<span class="k">let</span> <span class="n">pop</span> <span class="o">=</span>
  <span class="k">new</span> <span class="nn">Netpop</span><span class="p">.</span><span class="n">client</span>
    <span class="o">(</span><span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">input_channel</span> <span class="n">ic</span><span class="o">)</span>
    <span class="o">(</span><span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">output_channel</span> <span class="n">oc</span><span class="o">)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">pop</span><span class="o">#</span><span class="n">user</span> <span class="n">username</span><span class="o">;</span>
  <span class="n">pop</span><span class="o">#</span><span class="n">pass</span> <span class="n">password</span>

<span class="c">(* Messages are retreived as a hashtable from message IDs to tuples,</span>
<span class="c">   each tuple containing the message size in bytes and a string of</span>
<span class="c">   server-specific extension data. *)</span>
<span class="k">let</span> <span class="n">messages</span> <span class="o">=</span> <span class="n">pop</span><span class="o">#</span><span class="kt">list</span> <span class="bp">()</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">msgid</span> <span class="o">(</span><span class="n">size</span><span class="o">,</span> <span class="n">ext</span><span class="o">)</span> <span class="o">-&gt;</span>
       <span class="k">let</span> <span class="n">message</span> <span class="o">=</span> <span class="n">pop</span><span class="o">#</span><span class="n">retr</span> <span class="n">msgid</span> <span class="k">in</span>
       <span class="c">(* message is a Netchannels.in_obj_channel *)</span>
       <span class="n">pop</span><span class="o">#</span><span class="n">dele</span> <span class="n">msgid</span><span class="o">)</span>
    <span class="n">messages</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Use pop#apop instead of pop#user/pop#pass to avoid sending passwords</span>
<span class="c">   in plaintext across the network. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">pop</span><span class="o">#</span><span class="n">apop</span> <span class="n">username</span> <span class="n">password</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Get a message by number and print it to the console. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Retrieving %d : %!&quot;</span> <span class="n">msgnum</span><span class="o">;</span>
  <span class="k">try</span>
    <span class="k">let</span> <span class="n">message</span> <span class="o">=</span> <span class="n">pop</span><span class="o">#</span><span class="n">retr</span> <span class="n">msgnum</span> <span class="k">in</span>
    <span class="n">print_newline</span> <span class="bp">()</span><span class="o">;</span>
    <span class="n">print_endline</span>
      <span class="o">(</span><span class="nn">Netchannels</span><span class="p">.</span><span class="n">string_of_in_obj_channel</span> <span class="n">message</span><span class="o">)</span>
  <span class="k">with</span> <span class="nn">Netpop</span><span class="p">.</span><span class="nc">Err_status</span> <span class="n">e</span> <span class="o">-&gt;</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;failed (%s)</span><span class="se">\n</span><span class="s2">%!&quot;</span> <span class="n">e</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Gracefully tear down the connection. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">pop</span><span class="o">#</span><span class="n">quit</span> <span class="bp">()</span><span class="o">;</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">shutdown_connection</span> <span class="n">ic</span><span class="o">;</span>
  <span class="n">close_out</span> <span class="n">oc</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN993"
>Simulating Telnet from a Program</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* To simulate a Telnet client with OCaml, you can use the</span>
<span class="c">   Telnet_client module from Ocamlnet&#39;s &quot;netclient&quot; package.</span>

<span class="c">   This module is written in an asynchronous style, so you</span>
<span class="c">   will need to create event handlers to process the Telnet</span>
<span class="c">   events that occur: data, end of file, timeout, and the</span>
<span class="c">   sending and receiving of options (also known as &quot;do&quot;,</span>
<span class="c">   &quot;don&#39;t&quot;, &quot;will&quot;, and &quot;won&#39;t&quot;. *)</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netclient&quot;</span><span class="o">;;</span>

<span class="k">open</span> <span class="nc">Telnet_client</span>

<span class="c">(* This class wraps the Telnet session for convenience in</span>
<span class="c">   defining event handlers and chaining them together. *)</span>
<span class="k">class</span> <span class="n">session</span> <span class="o">~</span><span class="n">host</span> <span class="o">~</span><span class="n">port</span> <span class="o">~</span><span class="n">username</span> <span class="o">~</span><span class="n">password</span> <span class="o">~</span><span class="n">prompt</span> <span class="o">~</span><span class="n">timeout</span> <span class="o">=</span>
<span class="k">object</span> <span class="o">(</span><span class="n">self</span><span class="o">)</span>
  <span class="c">(* Telnet_client.telnet_session instance to wrap. *)</span>
  <span class="k">val</span> <span class="n">telnet</span> <span class="o">=</span> <span class="k">new</span> <span class="n">telnet_session</span>

  <span class="c">(* Initial on-data handler, which will be redefined later. *)</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">process</span> <span class="o">=</span> <span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span>

  <span class="c">(* Initialize the Telnet session. *)</span>
  <span class="k">initializer</span>
    <span class="n">telnet</span><span class="o">#</span><span class="n">set_connection</span> <span class="o">(</span><span class="nc">Telnet_connect</span> <span class="o">(</span><span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">));</span>
    <span class="n">telnet</span><span class="o">#</span><span class="n">set_options</span> <span class="o">{</span><span class="n">connection_timeout</span><span class="o">=</span><span class="n">timeout</span><span class="o">;</span>
                        <span class="n">verbose_connection</span><span class="o">=</span><span class="bp">false</span><span class="o">;</span>
                        <span class="n">verbose_input</span><span class="o">=</span><span class="bp">false</span><span class="o">;</span>
                        <span class="n">verbose_output</span><span class="o">=</span><span class="bp">false</span><span class="o">};</span>
    <span class="n">telnet</span><span class="o">#</span><span class="n">set_callback</span> <span class="n">self</span><span class="o">#</span><span class="n">on_input</span><span class="o">;</span>
    <span class="n">telnet</span><span class="o">#</span><span class="n">set_exception_handler</span> <span class="n">self</span><span class="o">#</span><span class="n">on_exception</span><span class="o">;</span>
    <span class="n">telnet</span><span class="o">#</span><span class="n">attach</span> <span class="bp">()</span><span class="o">;</span>
    <span class="n">process</span> <span class="o">&lt;-</span> <span class="n">self</span><span class="o">#</span><span class="n">start</span>

  <span class="c">(* Build an input callback that checks for a regular</span>
<span class="c">     expression match in the input and calls a callback</span>
<span class="c">     function if the match is positive. *)</span>
  <span class="k">method</span> <span class="n">waitfor</span> <span class="n">pat</span> <span class="n">cb</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">rex</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="n">pat</span> <span class="k">in</span>
    <span class="k">fun</span> <span class="n">data</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span> <span class="o">~</span><span class="n">rex</span> <span class="n">data</span> <span class="k">then</span> <span class="n">cb</span> <span class="n">data</span>

  <span class="c">(* Enqueue a line of data and flush the output queue. *)</span>
  <span class="k">method</span> <span class="n">write</span> <span class="n">data</span> <span class="o">=</span>
    <span class="nn">Queue</span><span class="p">.</span><span class="n">add</span> <span class="o">(</span><span class="nc">Telnet_data</span> <span class="n">data</span><span class="o">)</span> <span class="n">telnet</span><span class="o">#</span><span class="n">output_queue</span><span class="o">;</span>
    <span class="nn">Queue</span><span class="p">.</span><span class="n">add</span> <span class="o">(</span><span class="nc">Telnet_data</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span> <span class="n">telnet</span><span class="o">#</span><span class="n">output_queue</span><span class="o">;</span>
    <span class="n">telnet</span><span class="o">#</span><span class="n">update</span> <span class="bp">()</span>

  <span class="c">(* Handle first input: wait for a login prompt and then</span>
<span class="c">     invoke self#send_username to send the username. *)</span>
  <span class="k">method</span> <span class="n">start</span> <span class="o">=</span>
    <span class="n">self</span><span class="o">#</span><span class="n">waitfor</span> <span class="s2">&quot;ogin:&quot;</span> <span class="n">self</span><span class="o">#</span><span class="n">send_username</span>

  <span class="c">(* Send the username and wait for the password prompt. *)</span>
  <span class="k">method</span> <span class="n">send_username</span> <span class="n">data</span> <span class="o">=</span>
    <span class="n">self</span><span class="o">#</span><span class="n">write</span> <span class="n">username</span><span class="o">;</span>
    <span class="n">process</span> <span class="o">&lt;-</span> <span class="n">self</span><span class="o">#</span><span class="n">waitfor</span> <span class="s2">&quot;assword:&quot;</span> <span class="n">self</span><span class="o">#</span><span class="n">send_password</span>

  <span class="c">(* Send the password and wait to see if we succeeded. *)</span>
  <span class="k">method</span> <span class="n">send_password</span> <span class="n">data</span> <span class="o">=</span>
    <span class="n">self</span><span class="o">#</span><span class="n">write</span> <span class="n">password</span><span class="o">;</span>
    <span class="n">process</span> <span class="o">&lt;-</span> <span class="n">self</span><span class="o">#</span><span class="n">verify_login</span>

  <span class="c">(* Determine if the login was a success or a failure.</span>
<span class="c">     Abort with an exception on failure; call self#logged_in</span>
<span class="c">     on success. *)</span>
  <span class="k">method</span> <span class="n">verify_login</span> <span class="n">data</span> <span class="o">=</span>
    <span class="k">if</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;incorrect&quot;</span> <span class="n">data</span>
    <span class="k">then</span> <span class="n">failwith</span> <span class="s2">&quot;Login failed&quot;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;^</span><span class="se">\\</span><span class="s2">s*$&quot;</span> <span class="n">data</span>
    <span class="k">then</span> <span class="bp">()</span> <span class="c">(* ignore blank lines *)</span>
    <span class="k">else</span> <span class="n">self</span><span class="o">#</span><span class="n">logged_in</span> <span class="n">data</span>

  <span class="c">(* Logged in successfully. Wait for a prompt if necessary</span>
<span class="c">     and call self#run_ls to send the first command. *)</span>
  <span class="k">method</span> <span class="n">logged_in</span> <span class="n">data</span> <span class="o">=</span>
    <span class="n">process</span> <span class="o">&lt;-</span> <span class="n">self</span><span class="o">#</span><span class="n">waitfor</span> <span class="n">prompt</span> <span class="n">self</span><span class="o">#</span><span class="n">run_ls</span><span class="o">;</span>
    <span class="n">self</span><span class="o">#</span><span class="n">waitfor</span> <span class="n">prompt</span> <span class="n">self</span><span class="o">#</span><span class="n">run_ls</span> <span class="n">data</span>

  <span class="c">(* Do a directory listing and wait for results. *)</span>
  <span class="k">method</span> <span class="n">run_ls</span> <span class="n">data</span> <span class="o">=</span>
    <span class="n">self</span><span class="o">#</span><span class="n">write</span> <span class="s2">&quot;/bin/ls -1&quot;</span><span class="o">;</span>
    <span class="n">process</span> <span class="o">&lt;-</span> <span class="n">self</span><span class="o">#</span><span class="n">gather_files</span>

  <span class="c">(* This variable will buffer the results of the &quot;ls&quot; command. *)</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">files</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

  <span class="c">(* Buffer the filenames printed out from the &quot;ls&quot; command and</span>
<span class="c">     print them out once we get a prompt. *)</span>
  <span class="k">method</span> <span class="n">gather_files</span> <span class="n">data</span> <span class="o">=</span>
    <span class="k">if</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="n">prompt</span> <span class="n">data</span>
    <span class="k">then</span>
      <span class="k">begin</span>
        <span class="n">files</span> <span class="o">&lt;-</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">replace</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;^/bin/ls -1</span><span class="se">\\</span><span class="s2">s*&quot;</span> <span class="n">files</span><span class="o">;</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span>
          <span class="s2">&quot;Files: %s</span><span class="se">\n</span><span class="s2">%!&quot;</span>
          <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;, &quot;</span>
             <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">split</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">s+&quot;</span> <span class="n">files</span><span class="o">));</span>
        <span class="n">self</span><span class="o">#</span><span class="n">run_top</span> <span class="n">data</span>
      <span class="k">end</span>
    <span class="k">else</span> <span class="n">files</span> <span class="o">&lt;-</span> <span class="n">files</span> <span class="o">^</span> <span class="n">data</span>

  <span class="c">(* Run another command until we get a prompt and then call</span>
<span class="c">     self#close to close the connection. *)</span>
  <span class="k">method</span> <span class="n">run_top</span> <span class="n">data</span> <span class="o">=</span>
    <span class="n">self</span><span class="o">#</span><span class="n">write</span> <span class="s2">&quot;top -n1 -b&quot;</span><span class="o">;</span>
    <span class="n">process</span> <span class="o">&lt;-</span> <span class="n">self</span><span class="o">#</span><span class="n">waitfor</span> <span class="n">prompt</span> <span class="n">self</span><span class="o">#</span><span class="n">close</span>

  <span class="c">(* Close the connection by sending an EOF. *)</span>
  <span class="k">method</span> <span class="n">close</span> <span class="n">data</span> <span class="o">=</span>
    <span class="nn">Queue</span><span class="p">.</span><span class="n">add</span> <span class="nc">Telnet_eof</span> <span class="n">telnet</span><span class="o">#</span><span class="n">output_queue</span>

  <span class="c">(* When we receive an EOF, exit the program. *)</span>
  <span class="k">method</span> <span class="n">on_eof</span> <span class="bp">()</span> <span class="o">=</span>
    <span class="n">prerr_endline</span> <span class="s2">&quot;EOF&quot;</span><span class="o">;</span>
    <span class="n">exit</span> <span class="mi">0</span>

  <span class="c">(* If a timeout event is received, exit with an error code. *)</span>
  <span class="k">method</span> <span class="n">on_timeout</span> <span class="bp">()</span> <span class="o">=</span>
    <span class="n">prerr_endline</span> <span class="s2">&quot;Timeout&quot;</span><span class="o">;</span>
    <span class="n">exit</span> <span class="mi">1</span>

  <span class="c">(* Print any thrown exceptions to standard error. *)</span>
  <span class="k">method</span> <span class="n">on_exception</span> <span class="n">exn</span> <span class="o">=</span>
    <span class="n">prerr_endline</span> <span class="o">(</span><span class="nn">Printexc</span><span class="p">.</span><span class="n">to_string</span> <span class="n">exn</span><span class="o">)</span>

  <span class="c">(* This is the main error handler, which dispatches on</span>
<span class="c">     Telnet_client events. *)</span>
  <span class="k">method</span> <span class="n">on_input</span> <span class="n">got_synch</span> <span class="o">=</span>
    <span class="k">while</span> <span class="n">not</span> <span class="o">(</span><span class="nn">Queue</span><span class="p">.</span><span class="n">is_empty</span> <span class="n">telnet</span><span class="o">#</span><span class="n">input_queue</span><span class="o">)</span> <span class="k">do</span>
      <span class="k">let</span> <span class="n">tc</span> <span class="o">=</span> <span class="nn">Queue</span><span class="p">.</span><span class="n">take</span> <span class="n">telnet</span><span class="o">#</span><span class="n">input_queue</span> <span class="k">in</span>
      <span class="k">match</span> <span class="n">tc</span> <span class="k">with</span>
        <span class="o">|</span> <span class="nc">Telnet_data</span> <span class="n">data</span> <span class="o">-&gt;</span> <span class="n">process</span> <span class="n">data</span>
	    <span class="o">|</span> <span class="nc">Telnet_eof</span> <span class="o">-&gt;</span> <span class="n">self</span><span class="o">#</span><span class="n">on_eof</span> <span class="bp">()</span>
	    <span class="o">|</span> <span class="nc">Telnet_timeout</span> <span class="o">-&gt;</span> <span class="n">self</span><span class="o">#</span><span class="n">on_timeout</span> <span class="bp">()</span>
        <span class="o">|</span> <span class="nc">Telnet_will</span> <span class="o">_</span>
        <span class="o">|</span> <span class="nc">Telnet_wont</span> <span class="o">_</span>
        <span class="o">|</span> <span class="nc">Telnet_do</span> <span class="o">_</span>
        <span class="o">|</span> <span class="nc">Telnet_dont</span> <span class="o">_</span> <span class="o">-&gt;</span>
            <span class="c">(* The telnet_session handles these events.</span>
<span class="c">               Calling this method is necessary. *)</span>
            <span class="n">telnet</span><span class="o">#</span><span class="n">process_option_command</span> <span class="n">tc</span>
	    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span>
    <span class="k">done</span>

  <span class="c">(* Run the Telnet session by calling the &quot;run&quot; method on</span>
<span class="c">     the underling telnet_session instance. *)</span>
  <span class="k">method</span> <span class="n">run</span> <span class="o">=</span> <span class="n">telnet</span><span class="o">#</span><span class="n">run</span>
<span class="k">end</span>

<span class="c">(* Create an instance of our custom session class. *)</span>
<span class="k">let</span> <span class="n">session</span> <span class="o">=</span>
  <span class="k">new</span> <span class="n">session</span>
    <span class="o">~</span><span class="n">host</span><span class="o">:</span><span class="s2">&quot;localhost&quot;</span>
    <span class="o">~</span><span class="n">port</span><span class="o">:</span><span class="mi">23</span>
    <span class="o">~</span><span class="n">username</span><span class="o">:</span><span class="s2">&quot;test&quot;</span>
    <span class="o">~</span><span class="n">password</span><span class="o">:</span><span class="s2">&quot;pleac&quot;</span>
    <span class="o">~</span><span class="n">prompt</span><span class="o">:</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">$ $&quot;</span>
    <span class="o">~</span><span class="n">timeout</span><span class="o">:</span><span class="mi">10</span><span class="o">.</span>

<span class="c">(* Start the session. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">session</span><span class="o">#</span><span class="n">run</span> <span class="bp">()</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN996"
>Pinging a Machine</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* ping - send and receive ICMP echo packets *)</span>

<span class="c">(* There do not appear to be any libraries available for pinging</span>
<span class="c">   servers from OCaml, ICMP or otherwise. In this recipe, we will</span>
<span class="c">   make a diversion from the Perl recipe, which simply determines</span>
<span class="c">   if a host is up, and instead write a lookalike for the &quot;ping&quot;</span>
<span class="c">   shell command. We might as well, if we&#39;re going to all the</span>
<span class="c">   trouble of building ICMP packets directly. *)</span>

<span class="c">(* Import Unix and enable threads using findlib for convenience. *)</span>
<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;unix&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">thread</span><span class="o">;;</span>

<span class="c">(* The Packet module defines a data type and operations for building,</span>
<span class="c">   parsing, and checking the integrity of ICMP packets. *)</span>
<span class="k">module</span> <span class="nc">Packet</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">exception</span> <span class="nc">Invalid_length</span> <span class="k">of</span> <span class="kt">int</span>
  <span class="k">exception</span> <span class="nc">Invalid_checksum</span> <span class="k">of</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">int</span>

  <span class="c">(* type&#39; and code define the ICMP message type. An echo message</span>
<span class="c">     has type&#39;=8, code=0, and an echo reply has type&#39;=0, code=0.</span>
<span class="c">     The id is a unique identifier for the current process to help</span>
<span class="c">     distinguish between replies for other processes. seq is the</span>
<span class="c">     sequence number, which is usually incremented with each message.</span>
<span class="c">     data is the message body whose contents depend on the type of</span>
<span class="c">     message. *)</span>
  <span class="k">type</span> <span class="n">t</span> <span class="o">=</span> <span class="o">{</span> <span class="k">type&#39;</span> <span class="o">:</span> <span class="kt">int</span><span class="o">;</span>
             <span class="n">code</span> <span class="o">:</span> <span class="kt">int</span><span class="o">;</span>
             <span class="n">id</span> <span class="o">:</span> <span class="kt">int</span><span class="o">;</span>
             <span class="n">seq</span> <span class="o">:</span> <span class="kt">int</span><span class="o">;</span>
             <span class="n">data</span> <span class="o">:</span> <span class="kt">string</span> <span class="o">}</span>

  <span class="c">(* Define a convenience function for constructing packets. *)</span>
  <span class="k">let</span> <span class="n">make</span> <span class="o">?(</span><span class="k">type&#39;</span><span class="o">=</span><span class="mi">8</span><span class="o">)</span> <span class="o">?(</span><span class="n">code</span><span class="o">=</span><span class="mi">0</span><span class="o">)</span> <span class="o">~</span><span class="n">id</span> <span class="o">~</span><span class="n">seq</span> <span class="n">data</span> <span class="o">=</span>
    <span class="o">{</span><span class="k">type&#39;</span><span class="o">=</span><span class="k">type&#39;</span><span class="o">;</span> <span class="n">code</span><span class="o">=</span><span class="n">code</span><span class="o">;</span> <span class="n">id</span><span class="o">=</span><span class="n">id</span><span class="o">;</span> <span class="n">seq</span><span class="o">=</span><span class="n">seq</span><span class="o">;</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="o">}</span>

  <span class="c">(* Calculate a checksum for a message by adding its contents, two</span>
<span class="c">     bytes at a time, folding the high order bits into the low order</span>
<span class="c">     bits, and taking the logical complement. The result will be an</span>
<span class="c">     int with 16-bit precision. *)</span>
  <span class="k">let</span> <span class="n">checksum</span> <span class="n">s</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">num_bytes</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">num_shorts</span> <span class="o">=</span> <span class="n">num_bytes</span> <span class="o">/</span> <span class="mi">2</span> <span class="k">in</span>
    <span class="k">let</span> <span class="k">rec</span> <span class="n">sum_shorts</span> <span class="n">i</span> <span class="n">sum</span> <span class="o">=</span>
      <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_shorts</span> <span class="k">then</span>
        <span class="k">let</span> <span class="n">short</span> <span class="o">=</span> <span class="nn">Int32</span><span class="p">.</span><span class="n">of_int</span> <span class="o">(</span><span class="n">int_of_char</span> <span class="n">s</span><span class="o">.[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="o">]</span> <span class="ow">lsl</span> <span class="mi">8</span>
                                  <span class="o">+</span> <span class="n">int_of_char</span> <span class="n">s</span><span class="o">.[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="o">])</span> <span class="k">in</span>
        <span class="n">sum_shorts</span> <span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">(</span><span class="nn">Int32</span><span class="p">.</span><span class="n">add</span> <span class="n">sum</span> <span class="n">short</span><span class="o">)</span>
      <span class="k">else</span> <span class="n">sum</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">sum_shorts</span> <span class="mi">0</span> <span class="mi">0</span><span class="n">l</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">sum</span> <span class="o">=</span>
      <span class="k">if</span> <span class="n">num_bytes</span> <span class="ow">mod</span> <span class="mi">2</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">then</span>
        <span class="nn">Int32</span><span class="p">.</span><span class="n">add</span> <span class="n">sum</span>
          <span class="o">(</span><span class="nn">Int32</span><span class="p">.</span><span class="n">of_int</span> <span class="o">(</span><span class="n">int_of_char</span> <span class="n">s</span><span class="o">.[</span><span class="n">num_bytes</span> <span class="o">-</span> <span class="mi">1</span><span class="o">]</span> <span class="ow">lsl</span> <span class="mi">8</span><span class="o">))</span>
      <span class="k">else</span> <span class="n">sum</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">sum</span> <span class="o">=</span>
      <span class="nn">Int32</span><span class="p">.</span><span class="n">add</span>
        <span class="o">(</span><span class="nn">Int32</span><span class="p">.</span><span class="n">shift_right</span> <span class="n">sum</span> <span class="mi">16</span><span class="o">)</span>
        <span class="o">(</span><span class="nn">Int32</span><span class="p">.</span><span class="n">logand</span> <span class="n">sum</span> <span class="mh">0xffff</span><span class="n">l</span><span class="o">)</span> <span class="k">in</span>
    <span class="nn">Int32</span><span class="p">.</span><span class="n">to_int</span>
      <span class="o">(</span><span class="nn">Int32</span><span class="p">.</span><span class="n">logand</span>
         <span class="o">(</span><span class="nn">Int32</span><span class="p">.</span><span class="n">lognot</span> <span class="o">(</span><span class="nn">Int32</span><span class="p">.</span><span class="n">add</span> <span class="o">(</span><span class="nn">Int32</span><span class="p">.</span><span class="n">shift_right</span> <span class="n">sum</span> <span class="mi">16</span><span class="o">)</span> <span class="n">sum</span><span class="o">))</span>
         <span class="mh">0xffff</span><span class="n">l</span><span class="o">)</span>

  <span class="c">(* Convert a packet to a string that can be sent over a socket. *)</span>
  <span class="k">let</span> <span class="n">to_string</span> <span class="o">{</span><span class="k">type&#39;</span><span class="o">=</span><span class="k">type&#39;</span><span class="o">;</span> <span class="n">code</span><span class="o">=</span><span class="n">code</span><span class="o">;</span> <span class="n">id</span><span class="o">=</span><span class="n">id</span><span class="o">;</span> <span class="n">seq</span><span class="o">=</span><span class="n">seq</span><span class="o">;</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="o">}</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">b</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">create</span> <span class="mi">20</span> <span class="k">in</span>
    <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_char</span> <span class="n">b</span> <span class="o">(</span><span class="n">char_of_int</span> <span class="k">type&#39;</span><span class="o">);</span>
    <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_char</span> <span class="n">b</span> <span class="o">(</span><span class="n">char_of_int</span> <span class="n">code</span><span class="o">);</span>
    <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_char</span> <span class="n">b</span> <span class="sc">&#39;\000&#39;</span><span class="o">;</span>  <span class="c">(* checksum hi *)</span>
    <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_char</span> <span class="n">b</span> <span class="sc">&#39;\000&#39;</span><span class="o">;</span>  <span class="c">(* checksum lo *)</span>
    <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_char</span> <span class="n">b</span> <span class="o">(</span><span class="n">char_of_int</span> <span class="o">(</span><span class="n">id</span> <span class="n">lsr</span> <span class="mi">8</span> <span class="ow">land</span> <span class="mh">0xff</span><span class="o">));</span>
    <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_char</span> <span class="n">b</span> <span class="o">(</span><span class="n">char_of_int</span> <span class="o">(</span><span class="n">id</span> <span class="ow">land</span> <span class="mh">0xff</span><span class="o">));</span>
    <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_char</span> <span class="n">b</span> <span class="o">(</span><span class="n">char_of_int</span> <span class="o">(</span><span class="n">seq</span> <span class="n">lsr</span> <span class="mi">8</span> <span class="ow">land</span> <span class="mh">0xff</span><span class="o">));</span>
    <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_char</span> <span class="n">b</span> <span class="o">(</span><span class="n">char_of_int</span> <span class="o">(</span><span class="n">seq</span> <span class="ow">land</span> <span class="mh">0xff</span><span class="o">));</span>
    <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_string</span> <span class="n">b</span> <span class="n">data</span><span class="o">;</span>
    <span class="k">let</span> <span class="n">packet</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">contents</span> <span class="n">b</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">checksum</span> <span class="n">packet</span> <span class="k">in</span>
    <span class="n">packet</span><span class="o">.[</span><span class="mi">2</span><span class="o">]</span> <span class="o">&lt;-</span> <span class="n">char_of_int</span> <span class="o">(</span><span class="n">sum</span> <span class="n">lsr</span> <span class="mi">8</span> <span class="ow">land</span> <span class="mh">0xff</span><span class="o">);</span>
    <span class="n">packet</span><span class="o">.[</span><span class="mi">3</span><span class="o">]</span> <span class="o">&lt;-</span> <span class="n">char_of_int</span> <span class="o">(</span><span class="n">sum</span> <span class="ow">land</span> <span class="mh">0xff</span><span class="o">);</span>
    <span class="n">packet</span>

  <span class="c">(* Parse a string into a packet structure. If the string is less than</span>
<span class="c">     8 bytes long, an Invalid_length exception will be raised. If the</span>
<span class="c">     checksum does not match the contents, an Invalid_checksum</span>
<span class="c">     exception will be raised. *)</span>
  <span class="k">let</span> <span class="n">of_string</span> <span class="n">s</span> <span class="o">=</span>
    <span class="k">if</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="k">then</span> <span class="k">raise</span> <span class="o">(</span><span class="nc">Invalid_length</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span><span class="o">));</span>
    <span class="k">let</span> <span class="n">s&#39;</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">copy</span> <span class="n">s</span> <span class="k">in</span>
    <span class="n">s&#39;</span><span class="o">.[</span><span class="mi">2</span><span class="o">]</span> <span class="o">&lt;-</span> <span class="sc">&#39;\000&#39;</span><span class="o">;</span>
    <span class="n">s&#39;</span><span class="o">.[</span><span class="mi">3</span><span class="o">]</span> <span class="o">&lt;-</span> <span class="sc">&#39;\000&#39;</span><span class="o">;</span>
    <span class="k">let</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">int_of_char</span> <span class="n">s</span><span class="o">.[</span><span class="mi">2</span><span class="o">]</span> <span class="ow">lsl</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">int_of_char</span> <span class="n">s</span><span class="o">.[</span><span class="mi">3</span><span class="o">]</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">sum&#39;</span> <span class="o">=</span> <span class="n">checksum</span> <span class="n">s&#39;</span> <span class="k">in</span>
    <span class="k">if</span> <span class="n">sum</span> <span class="o">&lt;&gt;</span> <span class="n">sum&#39;</span> <span class="k">then</span> <span class="k">raise</span> <span class="o">(</span><span class="nc">Invalid_checksum</span> <span class="o">(</span><span class="n">sum</span><span class="o">,</span> <span class="n">sum&#39;</span><span class="o">));</span>
    <span class="o">{</span><span class="k">type&#39;</span><span class="o">=</span><span class="n">int_of_char</span> <span class="n">s</span><span class="o">.[</span><span class="mi">0</span><span class="o">];</span>
     <span class="n">code</span><span class="o">=</span><span class="n">int_of_char</span> <span class="n">s</span><span class="o">.[</span><span class="mi">1</span><span class="o">];</span>
     <span class="n">id</span><span class="o">=</span><span class="n">int_of_char</span> <span class="n">s</span><span class="o">.[</span><span class="mi">4</span><span class="o">]</span> <span class="ow">lsl</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">int_of_char</span> <span class="n">s</span><span class="o">.[</span><span class="mi">5</span><span class="o">];</span>
     <span class="n">seq</span><span class="o">=</span><span class="n">int_of_char</span> <span class="n">s</span><span class="o">.[</span><span class="mi">6</span><span class="o">]</span> <span class="ow">lsl</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">int_of_char</span> <span class="n">s</span><span class="o">.[</span><span class="mi">7</span><span class="o">];</span>
     <span class="n">data</span><span class="o">=</span><span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">s</span> <span class="mi">8</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span> <span class="o">-</span> <span class="mi">8</span><span class="o">)}</span>
<span class="k">end</span>

<span class="c">(* Define a data structure for the message body of our echo requests. *)</span>
<span class="k">type</span> <span class="n">payload</span> <span class="o">=</span> <span class="o">{</span> <span class="n">timestamp</span> <span class="o">:</span> <span class="kt">float</span><span class="o">;</span> <span class="n">data</span> <span class="o">:</span> <span class="kt">string</span> <span class="o">}</span>

<span class="c">(* Send a single ICMP echo request to the given socket and address. *)</span>
<span class="k">let</span> <span class="n">ping</span> <span class="n">socket</span> <span class="n">sockaddr</span> <span class="n">id</span> <span class="n">seq</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">payload</span> <span class="o">=</span>
    <span class="nn">Marshal</span><span class="p">.</span><span class="n">to_string</span> <span class="o">{</span><span class="n">timestamp</span><span class="o">=</span><span class="nn">Unix</span><span class="p">.</span><span class="n">gettimeofday</span> <span class="bp">()</span><span class="o">;</span>
                       <span class="n">data</span><span class="o">=</span><span class="s2">&quot;abcdefghijklmnopqrstuvwxyz0123456&quot;</span><span class="o">}</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">message</span> <span class="o">=</span> <span class="nn">Packet</span><span class="p">.</span><span class="n">to_string</span> <span class="o">(</span><span class="nn">Packet</span><span class="p">.</span><span class="n">make</span> <span class="o">~</span><span class="n">id</span> <span class="o">~</span><span class="n">seq</span> <span class="n">payload</span><span class="o">)</span> <span class="k">in</span>
  <span class="n">ignore</span>
    <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">sendto</span> <span class="n">socket</span> <span class="n">message</span> <span class="mi">0</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">message</span><span class="o">)</span> <span class="bp">[]</span> <span class="n">sockaddr</span><span class="o">)</span>

<span class="c">(* Loop forever waiting for echo replies, printing them to the</span>
<span class="c">   console along with their hostname, IP, and round-trip time. *)</span>
<span class="k">let</span> <span class="n">pong</span> <span class="n">socket</span> <span class="n">id</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="mi">256</span> <span class="sc">&#39;\000&#39;</span> <span class="k">in</span>
  <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">length</span><span class="o">,</span> <span class="n">sockaddr</span> <span class="o">=</span>
      <span class="nn">Unix</span><span class="p">.</span><span class="n">recvfrom</span> <span class="n">socket</span> <span class="n">buffer</span> <span class="mi">0</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">buffer</span><span class="o">)</span> <span class="bp">[]</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">response</span> <span class="o">=</span>
      <span class="nn">Packet</span><span class="p">.</span><span class="n">of_string</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">buffer</span> <span class="mi">20</span> <span class="o">(</span><span class="n">length</span> <span class="o">-</span> <span class="mi">20</span><span class="o">))</span> <span class="k">in</span>
    <span class="k">match</span> <span class="n">sockaddr</span><span class="o">,</span> <span class="n">response</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">ADDR_INET</span> <span class="o">(</span><span class="n">addr</span><span class="o">,</span> <span class="n">port</span><span class="o">),</span>
        <span class="o">{</span><span class="nn">Packet</span><span class="p">.</span><span class="n">type&#39;</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">code</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">id</span><span class="o">=</span><span class="n">id&#39;</span><span class="o">;</span> <span class="n">seq</span><span class="o">=</span><span class="n">seq</span><span class="o">;</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="o">}</span>
          <span class="k">when</span> <span class="n">id</span> <span class="o">=</span> <span class="n">id&#39;</span> <span class="o">-&gt;</span>
          <span class="k">let</span> <span class="n">host_entry</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">gethostbyaddr</span> <span class="n">addr</span> <span class="k">in</span>
          <span class="k">let</span> <span class="n">payload</span> <span class="o">=</span> <span class="nn">Marshal</span><span class="p">.</span><span class="n">from_string</span> <span class="n">data</span> <span class="mi">0</span> <span class="k">in</span>
          <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span>
            <span class="s2">&quot;%d bytes from %s (%s): icmp_seq=%d time=%.3f ms</span><span class="se">\n</span><span class="s2">%!&quot;</span>
            <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">data</span><span class="o">)</span>
            <span class="n">host_entry</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">h_name</span>
            <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">string_of_inet_addr</span> <span class="n">addr</span><span class="o">)</span>
            <span class="n">seq</span>
            <span class="o">((</span><span class="nn">Unix</span><span class="p">.</span><span class="n">gettimeofday</span> <span class="bp">()</span> <span class="o">-.</span> <span class="n">payload</span><span class="o">.</span><span class="n">timestamp</span><span class="o">)</span> <span class="o">*.</span> <span class="mi">1000</span><span class="o">.)</span>
      <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span>
  <span class="k">done</span>

<span class="c">(* Read hostname from command line. *)</span>
<span class="k">let</span> <span class="n">host</span> <span class="o">=</span>
  <span class="k">if</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="o">&lt;&gt;</span> <span class="mi">2</span>
  <span class="k">then</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Usage: %s host</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">);</span> <span class="n">exit</span> <span class="mi">1</span><span class="o">)</span>
  <span class="k">else</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span>

<span class="c">(* Use DNS to find the IP address and canonical name. *)</span>
<span class="k">let</span> <span class="n">name</span><span class="o">,</span> <span class="n">addr</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">let</span> <span class="n">h</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">gethostbyname</span> <span class="n">host</span> <span class="k">in</span>
    <span class="n">h</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">h_name</span><span class="o">,</span> <span class="n">h</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">h_addr_list</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s: unknown host %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span> <span class="n">host</span><span class="o">;</span>
    <span class="n">exit</span> <span class="mi">2</span>

<span class="c">(* Make sure we are running as root, since this is required to</span>
<span class="c">   open a socket with SOCK_RAW and send ICMP packets. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">getuid</span> <span class="bp">()</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span>
  <span class="k">then</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s: icmp ping requires root privilege</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">);</span>
        <span class="n">exit</span> <span class="mi">3</span><span class="o">)</span>

<span class="c">(* Start the ping loop. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;PING %s (%s)</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">name</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">string_of_inet_addr</span> <span class="n">addr</span><span class="o">);</span>

  <span class="c">(* Build a socket and destination address. *)</span>
  <span class="k">let</span> <span class="n">proto</span> <span class="o">=</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">getprotobyname</span> <span class="s2">&quot;icmp&quot;</span><span class="o">).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">p_proto</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">socket</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">socket</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">PF_INET</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">SOCK_RAW</span> <span class="n">proto</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">sockaddr</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">ADDR_INET</span> <span class="o">(</span><span class="n">addr</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span> <span class="k">in</span>

  <span class="c">(* Use the PID as the ID for packets, and create a counter for</span>
<span class="c">     the sequence number. *)</span>
  <span class="k">let</span> <span class="n">id</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">getpid</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">seq</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>

  <span class="c">(* Start a background thread to print the echo replies. *)</span>
  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Thread</span><span class="p">.</span><span class="n">create</span> <span class="o">(</span><span class="n">pong</span> <span class="n">socket</span><span class="o">)</span> <span class="n">id</span><span class="o">);</span>

  <span class="c">(* Loop forever sending echo requests and sleeping. *)</span>
  <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
    <span class="n">incr</span> <span class="n">seq</span><span class="o">;</span>
    <span class="n">ping</span> <span class="n">socket</span> <span class="n">sockaddr</span> <span class="n">id</span> <span class="o">!</span><span class="n">seq</span><span class="o">;</span>
    <span class="nn">Unix</span><span class="p">.</span><span class="n">sleep</span> <span class="mi">1</span>
  <span class="k">done</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN999"
>Using Whois to Retrieve Information from the InterNIC</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* WHOIS servers depend on the TLD, and their output formats are</span>
<span class="c">   informal, inconsistent, and completely different from server</span>
<span class="c">   to server. This makes a general solution very large and ad-hoc.</span>
<span class="c">   The Net::Whois package, on which the original Perl recipe was</span>
<span class="c">   based, no longer works since WHOIS servers started redirecting</span>
<span class="c">   to other servers for most of the information.</span>

<span class="c">   Since no libraries are available for this task, we will do a</span>
<span class="c">   WHOIS lookup manually using sockets. This example shows how to</span>
<span class="c">   perform a WHOIS lookup for the &quot;sourceforge.net&quot; domain, and</span>
<span class="c">   probably will not work without modification for domains under</span>
<span class="c">   any other TLD. *)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">domain_name</span> <span class="o">=</span> <span class="s2">&quot;sourceforge.net&quot;</span>
<span class="k">let</span> <span class="n">whois_server</span> <span class="o">=</span> <span class="s2">&quot;whois.internic.net&quot;</span>
<span class="k">let</span> <span class="n">service</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">getservbyname</span> <span class="s2">&quot;whois&quot;</span> <span class="s2">&quot;tcp&quot;</span>

<span class="k">let</span> <span class="n">ltrim</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">re</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;^[ </span><span class="se">\r\n\t\x00\x0B</span><span class="s2">]*&quot;</span> <span class="k">in</span>
  <span class="nn">Str</span><span class="p">.</span><span class="n">global_replace</span> <span class="n">re</span> <span class="s2">&quot;&quot;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* Connect to the parent server to find the redirect. *)</span>

  <span class="k">let</span> <span class="n">host</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">gethostbyname</span> <span class="n">whois_server</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">socket_in</span><span class="o">,</span> <span class="n">socket_out</span> <span class="o">=</span>
    <span class="nn">Unix</span><span class="p">.</span><span class="n">open_connection</span>
      <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">ADDR_INET</span> <span class="o">(</span><span class="n">host</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">h_addr_list</span><span class="o">.(</span><span class="mi">0</span><span class="o">),</span>
                       <span class="n">service</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">s_port</span><span class="o">))</span> <span class="k">in</span>

  <span class="n">output_string</span> <span class="n">socket_out</span> <span class="n">domain_name</span><span class="o">;</span>
  <span class="n">output_string</span> <span class="n">socket_out</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
  <span class="n">flush</span> <span class="n">socket_out</span><span class="o">;</span>

  <span class="k">let</span> <span class="n">whois_redirect_regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;Whois Server: </span><span class="se">\\</span><span class="s2">(.*</span><span class="se">\\</span><span class="s2">)&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">whois_redirect</span> <span class="o">=</span> <span class="n">ref</span> <span class="s2">&quot;&quot;</span> <span class="k">in</span>

  <span class="k">begin</span>
    <span class="k">try</span>
      <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
        <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">ltrim</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">socket_in</span><span class="o">)</span> <span class="k">in</span>
        <span class="k">if</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">whois_redirect_regexp</span> <span class="n">line</span> <span class="mi">0</span>
        <span class="k">then</span> <span class="n">whois_redirect</span> <span class="o">:=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">1</span> <span class="n">line</span>
      <span class="k">done</span>
    <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
      <span class="nn">Unix</span><span class="p">.</span><span class="n">shutdown_connection</span> <span class="n">socket_in</span>
  <span class="k">end</span><span class="o">;</span>

  <span class="k">if</span> <span class="o">!</span><span class="n">whois_redirect</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
  <span class="k">then</span> <span class="n">failwith</span> <span class="s2">&quot;Couldn&#39;t find WHOIS redirect&quot;</span><span class="o">;</span>

  <span class="c">(* Connect to the real server and get the WHOIS data. *)</span>

  <span class="k">let</span> <span class="n">host</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">gethostbyname</span> <span class="o">!</span><span class="n">whois_redirect</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">socket_in</span><span class="o">,</span> <span class="n">socket_out</span> <span class="o">=</span>
    <span class="nn">Unix</span><span class="p">.</span><span class="n">open_connection</span>
      <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">ADDR_INET</span> <span class="o">(</span><span class="n">host</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">h_addr_list</span><span class="o">.(</span><span class="mi">0</span><span class="o">),</span>
                       <span class="n">service</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">s_port</span><span class="o">))</span> <span class="k">in</span>

  <span class="n">output_string</span> <span class="n">socket_out</span> <span class="n">domain_name</span><span class="o">;</span>
  <span class="n">output_string</span> <span class="n">socket_out</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
  <span class="n">flush</span> <span class="n">socket_out</span><span class="o">;</span>

  <span class="k">let</span> <span class="n">domain_name_regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;Domain name: </span><span class="se">\\</span><span class="s2">(.*</span><span class="se">\\</span><span class="s2">)&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">domain_name</span> <span class="o">=</span> <span class="n">ref</span> <span class="s2">&quot;&quot;</span> <span class="k">in</span>

  <span class="k">let</span> <span class="n">registrant_regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;Registrant:&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">registrant_name</span> <span class="o">=</span> <span class="n">ref</span> <span class="s2">&quot;&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">registrant_address</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">registrant_country</span> <span class="o">=</span> <span class="n">ref</span> <span class="s2">&quot;&quot;</span> <span class="k">in</span>

  <span class="k">let</span> <span class="n">contact_regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">(.*</span><span class="se">\\</span><span class="s2">) Contact:&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">contacts</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>

  <span class="k">begin</span>
    <span class="k">try</span>
      <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
        <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">ltrim</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">socket_in</span><span class="o">)</span> <span class="k">in</span>
        <span class="k">if</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">domain_name_regexp</span> <span class="n">line</span> <span class="mi">0</span>
        <span class="k">then</span> <span class="n">domain_name</span> <span class="o">:=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">1</span> <span class="n">line</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">registrant_regexp</span> <span class="n">line</span> <span class="mi">0</span>
        <span class="k">then</span>
          <span class="k">begin</span>
            <span class="c">(* Read registrant data. *)</span>
            <span class="n">registrant_name</span> <span class="o">:=</span> <span class="n">ltrim</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">socket_in</span><span class="o">);</span>
            <span class="k">let</span> <span class="n">finished</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span> <span class="k">in</span>
            <span class="k">while</span> <span class="n">not</span> <span class="o">!</span><span class="n">finished</span> <span class="k">do</span>
              <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">ltrim</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">socket_in</span><span class="o">)</span> <span class="k">in</span>
              <span class="k">if</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">line</span> <span class="o">&gt;</span> <span class="mi">2</span>
              <span class="k">then</span> <span class="n">registrant_address</span> <span class="o">:=</span> <span class="o">!</span><span class="n">registrant_address</span> <span class="o">@</span> <span class="o">[</span><span class="n">line</span><span class="o">]</span>
              <span class="k">else</span> <span class="k">if</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">line</span> <span class="o">=</span> <span class="mi">2</span>
              <span class="k">then</span> <span class="n">registrant_country</span> <span class="o">:=</span> <span class="n">line</span>
              <span class="k">else</span> <span class="n">finished</span> <span class="o">:=</span> <span class="bp">true</span>
            <span class="k">done</span>
          <span class="k">end</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">contact_regexp</span> <span class="n">line</span> <span class="mi">0</span>
        <span class="k">then</span>
          <span class="k">begin</span>
            <span class="c">(* Read contact data. *)</span>
            <span class="k">let</span> <span class="n">contact_type</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">1</span> <span class="n">line</span> <span class="k">in</span>
            <span class="k">let</span> <span class="n">contact_info</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
            <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">to</span> <span class="mi">6</span> <span class="k">do</span>
              <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">ltrim</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">socket_in</span><span class="o">)</span> <span class="k">in</span>
              <span class="n">contact_info</span> <span class="o">:=</span> <span class="o">!</span><span class="n">contact_info</span> <span class="o">@</span> <span class="o">[</span><span class="n">line</span><span class="o">]</span>
            <span class="k">done</span><span class="o">;</span>
            <span class="n">contacts</span> <span class="o">:=</span> <span class="o">(</span><span class="n">contact_type</span><span class="o">,</span> <span class="o">!</span><span class="n">contact_info</span><span class="o">)</span> <span class="o">::</span> <span class="o">!</span><span class="n">contacts</span>
          <span class="k">end</span>
      <span class="k">done</span>
    <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
      <span class="nn">Unix</span><span class="p">.</span><span class="n">shutdown_connection</span> <span class="n">socket_in</span>
  <span class="k">end</span><span class="o">;</span>

  <span class="c">(* Display the results. *)</span>

  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;The domain is called %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">!</span><span class="n">domain_name</span><span class="o">;</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Mail for %s should be sent to:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">!</span><span class="n">registrant_name</span><span class="o">;</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span> <span class="o">!</span><span class="n">registrant_address</span><span class="o">;</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">!</span><span class="n">registrant_country</span><span class="o">;</span>

  <span class="k">if</span> <span class="o">!</span><span class="n">contacts</span> <span class="o">=</span> <span class="bp">[]</span>
  <span class="k">then</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;No contact information.</span><span class="se">\n</span><span class="s2">&quot;</span>
  <span class="k">else</span>
    <span class="k">begin</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Contacts:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
      <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
        <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">contact_type</span><span class="o">,</span> <span class="n">contact_info</span><span class="o">)</span> <span class="o">-&gt;</span>
           <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;  %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">contact_type</span><span class="o">;</span>
           <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;    %s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span> <span class="n">contact_info</span><span class="o">)</span>
        <span class="o">!</span><span class="n">contacts</span>
    <span class="k">end</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1002"
>Program: expn and vrfy</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* expn -- convince smtp to divulge an alias expansion *)</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>                        <span class="c">(* Findlib *)</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;str&quot;</span><span class="o">;;</span>                        <span class="c">(* Stdlib *)</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;unix&quot;</span><span class="o">;;</span>                       <span class="c">(* Stdlib *)</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;perl&quot;</span><span class="o">;;</span>                       <span class="c">(* Perl4caml *)</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;smtp&quot;</span><span class="o">;;</span>                       <span class="c">(* Ocamlnet *)</span>
<span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="nn">Perl</span><span class="p">.</span><span class="n">eval</span> <span class="s2">&quot;use Net::DNS&quot;</span>        <span class="c">(* Net::DNS *)</span>

<span class="k">let</span> <span class="n">selfname</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">gethostname</span> <span class="bp">()</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="o">&lt;</span> <span class="mi">2</span>
  <span class="k">then</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;usage: %s address@host ...</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">);</span>
        <span class="n">exit</span> <span class="mi">1</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">combo</span> <span class="o">-&gt;</span>
       <span class="k">let</span> <span class="n">name</span><span class="o">,</span> <span class="n">host</span> <span class="o">=</span>
         <span class="k">match</span> <span class="nn">Str</span><span class="p">.</span><span class="n">bounded_split</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;@&quot;</span><span class="o">)</span> <span class="n">combo</span> <span class="mi">2</span> <span class="k">with</span>
           <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="s2">&quot;&quot;</span><span class="o">,</span> <span class="s2">&quot;&quot;</span>
           <span class="o">|</span> <span class="o">[</span><span class="n">name</span><span class="o">]</span> <span class="o">-&gt;</span> <span class="n">name</span><span class="o">,</span> <span class="s2">&quot;localhost&quot;</span>
           <span class="o">|</span> <span class="o">[</span><span class="n">name</span><span class="o">;</span> <span class="n">host</span><span class="o">]</span> <span class="o">-&gt;</span> <span class="n">name</span><span class="o">,</span> <span class="n">host</span>
           <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">assert</span> <span class="bp">false</span> <span class="k">in</span>
       <span class="k">let</span> <span class="n">hosts</span> <span class="o">=</span>
         <span class="nn">Perl</span><span class="p">.</span><span class="n">call_array</span> <span class="o">~</span><span class="n">fn</span><span class="o">:</span><span class="s2">&quot;mx&quot;</span> <span class="o">[</span><span class="nn">Perl</span><span class="p">.</span><span class="n">sv_of_string</span> <span class="n">host</span><span class="o">]</span> <span class="k">in</span>
       <span class="k">let</span> <span class="n">hosts</span> <span class="o">=</span>
         <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">mx</span> <span class="o">-&gt;</span> <span class="nn">Perl</span><span class="p">.</span><span class="n">call_method</span> <span class="n">mx</span> <span class="s2">&quot;exchange&quot;</span> <span class="bp">[]</span><span class="o">)</span> <span class="n">hosts</span> <span class="k">in</span>
       <span class="k">let</span> <span class="n">hosts</span> <span class="o">=</span>
         <span class="k">if</span> <span class="n">hosts</span> <span class="o">=</span> <span class="bp">[]</span> <span class="k">then</span> <span class="o">[</span><span class="nn">Perl</span><span class="p">.</span><span class="n">sv_of_string</span> <span class="n">host</span><span class="o">]</span> <span class="k">else</span> <span class="n">hosts</span> <span class="k">in</span>
       <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
         <span class="o">(</span><span class="k">fun</span> <span class="n">host</span> <span class="o">-&gt;</span>
            <span class="k">let</span> <span class="n">host</span> <span class="o">=</span> <span class="nn">Perl</span><span class="p">.</span><span class="n">string_of_sv</span> <span class="n">host</span> <span class="k">in</span>
            <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Expanding %s at %s (%s): %!&quot;</span>
              <span class="n">name</span> <span class="n">host</span> <span class="n">combo</span><span class="o">;</span>
            <span class="k">let</span> <span class="n">inet_addr</span> <span class="o">=</span>
              <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">gethostbyname</span> <span class="n">host</span><span class="o">).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">h_addr_list</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span> <span class="k">in</span>
            <span class="k">let</span> <span class="n">addr</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">ADDR_INET</span> <span class="o">(</span><span class="n">inet_addr</span><span class="o">,</span> <span class="nn">Netsmtp</span><span class="p">.</span><span class="n">tcp_port</span><span class="o">)</span> <span class="k">in</span>
            <span class="k">try</span>
              <span class="k">let</span> <span class="n">ic</span><span class="o">,</span> <span class="n">oc</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">open_connection</span> <span class="n">addr</span> <span class="k">in</span>
              <span class="k">let</span> <span class="n">smtp</span> <span class="o">=</span>
                <span class="k">new</span> <span class="nn">Netsmtp</span><span class="p">.</span><span class="n">client</span>
                  <span class="o">(</span><span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">input_channel</span> <span class="n">ic</span><span class="o">)</span>
                  <span class="o">(</span><span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">output_channel</span> <span class="n">oc</span><span class="o">)</span> <span class="k">in</span>
              <span class="n">ignore</span> <span class="o">(</span><span class="n">smtp</span><span class="o">#</span><span class="n">helo</span> <span class="o">~</span><span class="n">host</span><span class="o">:</span><span class="n">selfname</span> <span class="bp">()</span><span class="o">);</span>
              <span class="n">print_endline</span>
                <span class="o">(</span><span class="k">match</span> <span class="n">smtp</span><span class="o">#</span><span class="n">expn</span> <span class="n">name</span> <span class="k">with</span>
                   <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="s2">&quot;None&quot;</span>
                   <span class="o">|</span> <span class="nc">Some</span> <span class="n">results</span> <span class="o">-&gt;</span> <span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;, &quot;</span> <span class="n">results</span><span class="o">);</span>
              <span class="n">smtp</span><span class="o">#</span><span class="n">quit</span> <span class="bp">()</span><span class="o">;</span>
              <span class="nn">Unix</span><span class="p">.</span><span class="n">shutdown_connection</span> <span class="n">ic</span><span class="o">;</span>
              <span class="n">close_out</span> <span class="n">oc</span>
            <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">ECONNREFUSED</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
              <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;cannot connect to %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">host</span><span class="o">)</span>
         <span class="n">hosts</span><span class="o">)</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">))</span></PRE
></TD
></TR
></TABLE
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="sockets.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="cgiprogramming.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Sockets</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
>&nbsp;</TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>CGI Programming</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>
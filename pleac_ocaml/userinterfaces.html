<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN""http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>User Interfaces</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="PLEAC-Objective CAML "
HREF="index.html"><LINK
REL="PREVIOUS"
TITLE="Database Access"
HREF="dbaccess.html"><LINK
REL="NEXT"
TITLE="Process Management and Communication"
HREF="processmanagementetc.html"><style type="text/css">td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
pre { line-height: 125%; }

  </style></head
><BODY TEXT="#cecece" BGCOLOR="#4f6f6f" LINK="#f5deb3" VLINK="#d5ae83"
CLASS="SECT1"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>PLEAC-Objective CAML </TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="dbaccess.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
></TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="processmanagementetc.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="USERINTERFACES"
>15. User Interfaces</A
></H1
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN792"
>Parsing Program Arguments</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="k">let</span> <span class="n">verbose</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span>
<span class="k">let</span> <span class="n">debug</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span>
<span class="k">let</span> <span class="n">output</span> <span class="o">=</span> <span class="n">ref</span> <span class="s2">&quot;&quot;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Arg</span><span class="p">.</span><span class="n">parse</span>
    <span class="o">[</span>
      <span class="s2">&quot;-v&quot;</span><span class="o">,</span> <span class="nn">Arg</span><span class="p">.</span><span class="nc">Set</span> <span class="n">verbose</span><span class="o">,</span> <span class="s2">&quot;Verbose mode&quot;</span><span class="o">;</span>
      <span class="s2">&quot;-D&quot;</span><span class="o">,</span> <span class="nn">Arg</span><span class="p">.</span><span class="nc">Set</span> <span class="n">debug</span><span class="o">,</span> <span class="s2">&quot;Debug mode&quot;</span><span class="o">;</span>
      <span class="s2">&quot;-o&quot;</span><span class="o">,</span> <span class="nn">Arg</span><span class="p">.</span><span class="nc">Set_string</span> <span class="n">output</span><span class="o">,</span> <span class="s2">&quot;Specify output file&quot;</span><span class="o">;</span>
    <span class="o">]</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">s</span> <span class="o">-&gt;</span>
       <span class="k">raise</span> <span class="o">(</span><span class="nn">Arg</span><span class="p">.</span><span class="nc">Bad</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;unexpected argument `%s&#39;&quot;</span> <span class="n">s</span><span class="o">)))</span>
    <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;Usage: %s [-v] [-d] [-o file]&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">))</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">verbose</span> <span class="k">then</span> <span class="n">print_endline</span> <span class="s2">&quot;Verbose mode&quot;</span><span class="o">;</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">debug</span> <span class="k">then</span> <span class="n">print_endline</span> <span class="s2">&quot;Debug mode&quot;</span><span class="o">;</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">output</span> <span class="o">&lt;&gt;</span> <span class="s2">&quot;&quot;</span> <span class="k">then</span> <span class="n">print_endline</span> <span class="o">(</span><span class="s2">&quot;Writing output to &quot;</span> <span class="o">^</span> <span class="o">!</span><span class="n">output</span><span class="o">);</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN795"
>Testing Whether a Program Is Running Interactively</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">i_am_interactive</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">isatty</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span> <span class="o">&amp;&amp;</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">isatty</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdout</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="k">if</span> <span class="n">i_am_interactive</span> <span class="bp">()</span>
      <span class="k">then</span> <span class="n">print_string</span> <span class="s2">&quot;Prompt: &quot;</span><span class="o">;</span>
      <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">read_line</span> <span class="bp">()</span> <span class="k">in</span>
      <span class="k">if</span> <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">then</span> <span class="k">raise</span> <span class="nc">End_of_file</span><span class="o">;</span>
      <span class="c">(* do something with the line *)</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN798"
>Clearing the Screen</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="c">(* Run the clear command to clear the screen. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">ignore</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="n">command</span> <span class="s2">&quot;clear&quot;</span><span class="o">)</span>

<span class="c">(* Save the output to a string to avoid running a process each time. *)</span>
<span class="k">let</span> <span class="n">clear</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">let</span> <span class="n">proc</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_in</span> <span class="s2">&quot;clear&quot;</span> <span class="k">in</span>
    <span class="k">try</span>
      <span class="k">let</span> <span class="n">chars</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">proc</span> <span class="k">in</span>
      <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_in</span> <span class="n">proc</span><span class="o">);</span>
      <span class="n">chars</span>
    <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_in</span> <span class="n">proc</span><span class="o">);</span> <span class="s2">&quot;&quot;</span>
  <span class="k">with</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="s2">&quot;&quot;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">print_string</span> <span class="n">clear</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN801"
>Determining Terminal or Window Size</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="c">(* UNIX only, due to &quot;stty&quot;. *)</span>
<span class="k">let</span> <span class="n">get_terminal_size</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_in</span> <span class="s2">&quot;stty size&quot;</span> <span class="k">in</span>
  <span class="k">try</span>
    <span class="k">begin</span>
      <span class="k">try</span>
        <span class="nn">Scanf</span><span class="p">.</span><span class="n">fscanf</span> <span class="n">in_channel</span> <span class="s2">&quot;%d %d&quot;</span>
          <span class="o">(</span><span class="k">fun</span> <span class="n">rows</span> <span class="n">cols</span> <span class="o">-&gt;</span>
             <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_in</span> <span class="n">in_channel</span><span class="o">);</span>
             <span class="o">(</span><span class="n">rows</span><span class="o">,</span> <span class="n">cols</span><span class="o">))</span>
      <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
        <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_in</span> <span class="n">in_channel</span><span class="o">);</span>
        <span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span>
    <span class="k">end</span>
  <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span>
    <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_in</span> <span class="n">in_channel</span><span class="o">);</span>
    <span class="k">raise</span> <span class="n">e</span>

<span class="c">(* Display a textual bar chart as wide as the console. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="o">(</span><span class="n">height</span><span class="o">,</span> <span class="n">width</span><span class="o">)</span> <span class="o">=</span> <span class="n">get_terminal_size</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="k">if</span> <span class="n">width</span> <span class="o">&lt;</span> <span class="mi">10</span>
  <span class="k">then</span> <span class="o">(</span><span class="n">prerr_endline</span> <span class="s2">&quot;You must have at least 10 characters&quot;</span><span class="o">;</span>
        <span class="n">exit</span> <span class="mi">255</span><span class="o">);</span>
  <span class="k">let</span> <span class="n">max_value</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">fold_left</span> <span class="n">max</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span> <span class="n">values</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">ratio</span> <span class="o">=</span> <span class="o">(</span><span class="kt">float</span> <span class="n">width</span> <span class="o">-.</span> <span class="mi">10</span><span class="o">.</span><span class="mi">0</span><span class="o">)</span> <span class="o">/.</span> <span class="n">max_value</span> <span class="k">in</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="k">value</span> <span class="o">-&gt;</span>
       <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%8.1f %s</span><span class="se">\n</span><span class="s2">&quot;</span>
         <span class="k">value</span>
         <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="o">(</span><span class="n">int_of_float</span> <span class="o">(</span><span class="n">ratio</span> <span class="o">*.</span> <span class="k">value</span><span class="o">))</span> <span class="sc">&#39;*&#39;</span><span class="o">))</span>
    <span class="n">values</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN804"
>Changing Text Color</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* Requires the ANSITerminal library by Christophe Troestler,</span>
<span class="c">   available at http://math.umh.ac.be/an/software.php#x4-80007 *)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;ANSITerminal.cma&quot;</span><span class="o">;;</span>
<span class="k">open</span> <span class="nc">ANSITerminal</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">print_string</span> <span class="o">[</span><span class="n">red</span><span class="o">]</span> <span class="s2">&quot;Danger Will Robinson!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
  <span class="n">print_string</span> <span class="bp">[]</span> <span class="s2">&quot;This is just normal text.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
  <span class="n">print_string</span> <span class="o">[</span><span class="nc">Blink</span><span class="o">]</span> <span class="s2">&quot;&lt;BLINK&gt;Do you hurt yet?&lt;/BLINK&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">set_autoreset</span> <span class="bp">false</span><span class="o">;</span>
  <span class="c">(* rhyme for the deadly coral snake *)</span>
  <span class="n">print_string</span> <span class="o">[</span><span class="n">red</span><span class="o">;</span> <span class="n">on_black</span><span class="o">]</span> <span class="s2">&quot;venom lack</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
  <span class="n">print_string</span> <span class="o">[</span><span class="n">red</span><span class="o">;</span> <span class="n">on_yellow</span><span class="o">]</span> <span class="s2">&quot;kill that fellow</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
  <span class="n">print_string</span> <span class="o">[</span><span class="n">green</span><span class="o">;</span> <span class="n">on_cyan</span><span class="o">;</span> <span class="nc">Blink</span><span class="o">]</span> <span class="s2">&quot;garish!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
  <span class="n">print_string</span> <span class="o">[</span><span class="nc">Reset</span><span class="o">]</span> <span class="s2">&quot;&quot;</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">set_autoreset</span> <span class="bp">true</span><span class="o">;</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="n">print_string</span> <span class="o">[</span><span class="n">red</span><span class="o">;</span> <span class="n">on_white</span><span class="o">;</span> <span class="nc">Bold</span><span class="o">;</span> <span class="nc">Blink</span><span class="o">])</span>
    <span class="o">[</span><span class="s2">&quot;This way</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
     <span class="s2">&quot;each line</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
     <span class="s2">&quot;has its own</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
     <span class="s2">&quot;attribute set.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">]</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN807"
>Reading from the Keyboard</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">with_cbreak</span> <span class="n">f</span> <span class="n">x</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">term_init</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">tcgetattr</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">term_cbreak</span> <span class="o">=</span> <span class="o">{</span> <span class="n">term_init</span> <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">c_icanon</span> <span class="o">=</span> <span class="bp">false</span> <span class="o">}</span> <span class="k">in</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">tcsetattr</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">TCSANOW</span> <span class="n">term_cbreak</span><span class="o">;</span>
  <span class="k">try</span>
    <span class="k">let</span> <span class="n">result</span> <span class="o">=</span> <span class="n">f</span> <span class="n">x</span> <span class="k">in</span>
    <span class="nn">Unix</span><span class="p">.</span><span class="n">tcsetattr</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">TCSADRAIN</span> <span class="n">term_init</span><span class="o">;</span>
    <span class="n">result</span>
  <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span>
    <span class="nn">Unix</span><span class="p">.</span><span class="n">tcsetattr</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">TCSADRAIN</span> <span class="n">term_init</span><span class="o">;</span>
    <span class="k">raise</span> <span class="n">e</span>

<span class="k">let</span> <span class="n">key</span> <span class="o">=</span> <span class="n">with_cbreak</span> <span class="n">input_char</span> <span class="n">stdin</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* sascii - Show ASCII values for keypresses *)</span>
<span class="k">let</span> <span class="n">sascii</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
    <span class="k">let</span> <span class="kt">char</span> <span class="o">=</span> <span class="nn">Char</span><span class="p">.</span><span class="n">code</span> <span class="o">(</span><span class="n">input_char</span> <span class="n">stdin</span><span class="o">)</span> <span class="k">in</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot; Decimal: %d</span><span class="se">\t</span><span class="s2">Hex: %x</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="kt">char</span> <span class="kt">char</span><span class="o">;</span>
    <span class="n">flush</span> <span class="n">stdout</span>
  <span class="k">done</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">print_endline</span>
    <span class="s2">&quot;Press keys to see their ASCII values.  Use Ctrl-C to quit.&quot;</span><span class="o">;</span>
  <span class="n">with_cbreak</span> <span class="n">sascii</span> <span class="bp">()</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN810"
>Ringing the Terminal Bell</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* OCaml doesn&#39;t recognize &#39;\a&#39;; instead use &#39;\007&#39;. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">print_endline</span> <span class="s2">&quot;</span><span class="se">\007</span><span class="s2">Wake up!&quot;</span>

<span class="c">(* Use the &quot;tput&quot; command to produce a visual bell. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">ignore</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="n">command</span> <span class="s2">&quot;tput flash&quot;</span><span class="o">)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN813"
>Using POSIX termios</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* demo POSIX termios *)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">uncontrol</span> <span class="n">c</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;=</span> <span class="sc">&#39;\128&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">&#39;\255&#39;</span>
  <span class="k">then</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;M-%c&quot;</span> <span class="o">(</span><span class="nn">Char</span><span class="p">.</span><span class="n">chr</span> <span class="o">(</span><span class="nn">Char</span><span class="p">.</span><span class="n">code</span> <span class="n">c</span> <span class="ow">land</span> <span class="mi">127</span><span class="o">))</span>
  <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">&gt;=</span> <span class="sc">&#39;\000&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="sc">&#39;\031&#39;</span><span class="o">)</span> <span class="o">||</span> <span class="n">c</span> <span class="o">=</span> <span class="sc">&#39;\127&#39;</span>
  <span class="k">then</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;^%c&quot;</span> <span class="o">(</span><span class="nn">Char</span><span class="p">.</span><span class="n">chr</span> <span class="o">(</span><span class="nn">Char</span><span class="p">.</span><span class="n">code</span> <span class="n">c</span> <span class="ow">lxor</span> <span class="mi">64</span><span class="o">))</span>
  <span class="k">else</span> <span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="mi">1</span> <span class="n">c</span>

<span class="k">let</span> <span class="n">term</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">tcgetattr</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span>
<span class="k">let</span> <span class="n">erase</span> <span class="o">=</span> <span class="n">term</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">c_verase</span>
<span class="k">let</span> <span class="n">kill</span> <span class="o">=</span> <span class="n">term</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">c_vkill</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Erase is character %d, %s</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="o">(</span><span class="nn">Char</span><span class="p">.</span><span class="n">code</span> <span class="n">erase</span><span class="o">)</span>
    <span class="o">(</span><span class="n">uncontrol</span> <span class="n">erase</span><span class="o">);</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Kill is character %d, %s</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="o">(</span><span class="nn">Char</span><span class="p">.</span><span class="n">code</span> <span class="n">kill</span><span class="o">)</span>
    <span class="o">(</span><span class="n">uncontrol</span> <span class="n">kill</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">term</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">c_verase</span> <span class="o">&lt;-</span> <span class="sc">&#39;#&#39;</span><span class="o">;</span>
  <span class="n">term</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">c_vkill</span> <span class="o">&lt;-</span> <span class="sc">&#39;@&#39;</span><span class="o">;</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">tcsetattr</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">TCSANOW</span> <span class="n">term</span><span class="o">;</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;erase is #, kill is @; type something: %!&quot;</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">stdin</span> <span class="k">in</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;You typed: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">line</span><span class="o">;</span>
  <span class="n">term</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">c_verase</span> <span class="o">&lt;-</span> <span class="n">erase</span><span class="o">;</span>
  <span class="n">term</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">c_vkill</span> <span class="o">&lt;-</span> <span class="n">kill</span><span class="o">;</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">tcsetattr</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">TCSANOW</span> <span class="n">term</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">module</span> <span class="nc">HotKey</span> <span class="o">:</span>
<span class="k">sig</span>
  <span class="k">val</span> <span class="n">cbreak</span> <span class="o">:</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">unit</span>
  <span class="k">val</span> <span class="n">cooked</span> <span class="o">:</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">unit</span>
  <span class="k">val</span> <span class="n">readkey</span> <span class="o">:</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">char</span>
<span class="k">end</span> <span class="o">=</span>
<span class="k">struct</span>
  <span class="k">open</span> <span class="nc">Unix</span>

  <span class="k">let</span> <span class="n">oterm</span> <span class="o">=</span> <span class="o">{(</span><span class="n">tcgetattr</span> <span class="n">stdin</span><span class="o">)</span> <span class="k">with</span> <span class="n">c_vtime</span> <span class="o">=</span> <span class="mi">0</span><span class="o">}</span>
  <span class="k">let</span> <span class="n">noecho</span> <span class="o">=</span> <span class="o">{</span><span class="n">oterm</span> <span class="k">with</span>
                  <span class="n">c_vtime</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
                  <span class="n">c_echo</span> <span class="o">=</span> <span class="bp">false</span><span class="o">;</span>
                  <span class="n">c_echok</span> <span class="o">=</span> <span class="bp">false</span><span class="o">;</span>
                  <span class="n">c_icanon</span> <span class="o">=</span> <span class="bp">false</span><span class="o">}</span>

  <span class="k">let</span> <span class="n">cbreak</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">tcsetattr</span> <span class="n">stdin</span> <span class="nc">TCSANOW</span> <span class="n">noecho</span>
  <span class="k">let</span> <span class="n">cooked</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">tcsetattr</span> <span class="n">stdin</span> <span class="nc">TCSANOW</span> <span class="n">oterm</span>

  <span class="k">let</span> <span class="n">readkey</span> <span class="bp">()</span> <span class="o">=</span>
    <span class="n">cbreak</span> <span class="bp">()</span><span class="o">;</span>
    <span class="k">let</span> <span class="n">key</span> <span class="o">=</span> <span class="n">input_char</span> <span class="o">(</span><span class="nn">Pervasives</span><span class="p">.</span><span class="n">stdin</span><span class="o">)</span> <span class="k">in</span>
    <span class="n">cooked</span> <span class="bp">()</span><span class="o">;</span>
    <span class="n">key</span>

  <span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">cooked</span> <span class="bp">()</span>
<span class="k">end</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN816"
>Checking for Waiting Input</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">set_nonblock</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span><span class="o">;</span>
  <span class="k">try</span>
    <span class="k">let</span> <span class="kt">char</span> <span class="o">=</span> <span class="n">with_cbreak</span> <span class="n">input_char</span> <span class="n">stdin</span> <span class="k">in</span>
    <span class="c">(* input was waiting and it was char *)</span>
    <span class="bp">()</span>
  <span class="k">with</span> <span class="nc">Sys_blocked_io</span> <span class="o">-&gt;</span>
    <span class="c">(* no input was waiting *)</span>
    <span class="bp">()</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN819"
>Reading Passwords</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="c">(* Thanks to David Mentre, Remi Vanicat, and David Brown&#39;s posts on</span>
<span class="c">   caml-list. Works on Unix only, unfortunately, due to tcsetattr. *)</span>
<span class="k">let</span> <span class="n">read_password</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">term_init</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">tcgetattr</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">term_no_echo</span> <span class="o">=</span> <span class="o">{</span> <span class="n">term_init</span> <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">c_echo</span> <span class="o">=</span> <span class="bp">false</span> <span class="o">}</span> <span class="k">in</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">tcsetattr</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">TCSANOW</span> <span class="n">term_no_echo</span><span class="o">;</span>
  <span class="k">try</span>
    <span class="k">let</span> <span class="n">password</span> <span class="o">=</span> <span class="n">read_line</span> <span class="bp">()</span> <span class="k">in</span>
    <span class="n">print_newline</span> <span class="bp">()</span><span class="o">;</span>
    <span class="nn">Unix</span><span class="p">.</span><span class="n">tcsetattr</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">TCSAFLUSH</span> <span class="n">term_init</span><span class="o">;</span>
    <span class="n">password</span>
  <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span>
    <span class="nn">Unix</span><span class="p">.</span><span class="n">tcsetattr</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">TCSAFLUSH</span> <span class="n">term_init</span><span class="o">;</span>
    <span class="k">raise</span> <span class="n">e</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">print_string</span> <span class="s2">&quot;Enter your password: &quot;</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">password</span> <span class="o">=</span> <span class="n">read_password</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;You said: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">password</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN822"
>Editing Input</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* ledit is a pure-OCaml readline clone by Daniel de Rauglaudre.</span>
<span class="c">   Source is available here: http://pauillac.inria.fr/~ddr/ledit/</span>

<span class="c">   It is designed to be used as a command-line wrapper, but it</span>
<span class="c">   can also be embedded in another program by building it normally</span>
<span class="c">   and copying cursor.cmo, ledit.cmi, ledit.cmo, and ledit.mli into</span>
<span class="c">   your project.</span>

<span class="c">   A guide to compiling and embedding ledit can be found on the</span>
<span class="c">   OCaml Tutorial Wiki: http://www.ocaml-tutorial.org/ledit</span>
<span class="c">   At present, this guide applies to ledit 1.11. This recipe uses</span>
<span class="c">   ledit 1.15, which is slightly different due to the addition of</span>
<span class="c">   Unicode support (Ledit.input_char now returns a string instead</span>
<span class="c">   of a char). *)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;cursor.cmo&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;ledit.cmo&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">readline</span> <span class="n">prompt</span> <span class="o">=</span>
  <span class="nn">Ledit</span><span class="p">.</span><span class="n">set_prompt</span> <span class="n">prompt</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">create</span> <span class="mi">256</span> <span class="k">in</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span> <span class="o">=</span> <span class="k">function</span>
    <span class="o">|</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">-&gt;</span>
        <span class="nn">Buffer</span><span class="p">.</span><span class="n">contents</span> <span class="n">buffer</span>
    <span class="o">|</span> <span class="kt">string</span> <span class="o">-&gt;</span>
        <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_string</span> <span class="n">buffer</span> <span class="kt">string</span><span class="o">;</span>
        <span class="n">loop</span> <span class="o">(</span><span class="nn">Ledit</span><span class="p">.</span><span class="n">input_char</span> <span class="n">stdin</span><span class="o">)</span> <span class="k">in</span>
  <span class="n">loop</span> <span class="o">(</span><span class="nn">Ledit</span><span class="p">.</span><span class="n">input_char</span> <span class="n">stdin</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">prompt</span> <span class="o">=</span> <span class="s2">&quot;Prompt: &quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">readline</span> <span class="n">prompt</span> <span class="k">in</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;You said: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">line</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* If you would prefer to use the real GNU Readline library, you can use</span>
<span class="c">  camlidl to generate an interface to it. Here&#39;s a basic readline.idl: *)</span>

<span class="n">quote</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="s2">&quot;#include &lt;stdio.h&gt;&quot;</span><span class="o">);</span>
<span class="n">quote</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="s2">&quot;#include &lt;readline/readline.h&gt;&quot;</span><span class="o">);</span>
<span class="n">quote</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="s2">&quot;#include &lt;readline/history.h&gt;&quot;</span><span class="o">);</span>

<span class="o">[</span><span class="kt">string</span><span class="o">,</span> <span class="n">unique</span><span class="o">]</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">readline</span> <span class="o">([</span><span class="kt">string</span><span class="o">,</span> <span class="n">unique</span><span class="o">]</span> <span class="n">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prompt</span><span class="o">)</span>
    <span class="n">quote</span><span class="o">(</span><span class="n">dealloc</span><span class="o">,</span> <span class="s2">&quot;free(_res);&quot;</span><span class="o">);</span>

<span class="n">void</span> <span class="n">add_history</span> <span class="o">([</span><span class="kt">string</span><span class="o">]</span> <span class="n">const</span> <span class="kt">char</span> <span class="o">*</span><span class="kt">string</span><span class="o">);</span>

<span class="c">(* And here is a test program: *)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;You said: %s</span><span class="se">\n</span><span class="s2">%!&quot;</span>
      <span class="o">(</span><span class="k">match</span> <span class="nn">Readline</span><span class="p">.</span><span class="n">readline</span> <span class="o">(</span><span class="nc">Some</span> <span class="s2">&quot;Prompt: &quot;</span><span class="o">)</span> <span class="k">with</span>
         <span class="o">|</span> <span class="nc">Some</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="nn">Readline</span><span class="p">.</span><span class="n">add_history</span> <span class="n">s</span><span class="o">;</span> <span class="n">s</span>
         <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="n">exit</span> <span class="mi">0</span><span class="o">)</span>
  <span class="k">done</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* vbsh - very bad shell *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="k">let</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">readline</span> <span class="s2">&quot;$ &quot;</span> <span class="k">in</span>
      <span class="k">begin</span>
        <span class="k">match</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">system</span> <span class="n">cmd</span> <span class="k">with</span>
          <span class="o">|</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">WEXITED</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span>
          <span class="o">|</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">WSIGNALED</span> <span class="n">signal_num</span> <span class="o">-&gt;</span>
              <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Program killed by signal %d</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">signal_num</span>
          <span class="o">|</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">WSTOPPED</span> <span class="n">signal_num</span> <span class="o">-&gt;</span>
              <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Program stopped by signal %d</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">signal_num</span>
      <span class="k">end</span><span class="o">;</span>
      <span class="n">flush</span> <span class="n">stdout</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN825"
>Managing the Screen</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* rep - screen repeat command *)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="c">(* http://www.nongnu.org/ocaml-tmk/ *)</span>
<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+curses&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;curses.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">10</span><span class="o">.</span><span class="mi">0</span>

<span class="k">let</span> <span class="o">(</span><span class="n">timeout</span><span class="o">,</span> <span class="n">command</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">match</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="k">with</span>
    <span class="o">|</span> <span class="mi">0</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">timeout</span><span class="o">,</span> <span class="o">[|</span> <span class="o">|])</span>
    <span class="o">|</span> <span class="n">len</span> <span class="o">-&gt;</span>
        <span class="k">if</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span> <span class="o">&lt;&gt;</span> <span class="s2">&quot;&quot;</span> <span class="o">&amp;&amp;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">).[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="sc">&#39;-&#39;</span>
        <span class="k">then</span> <span class="o">(</span><span class="n">float_of_string</span>
                <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span>
                   <span class="mi">1</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)),</span>
              <span class="nn">Array</span><span class="p">.</span><span class="n">sub</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="mi">2</span> <span class="o">(</span><span class="n">len</span> <span class="o">-</span> <span class="mi">2</span><span class="o">))</span>
        <span class="k">else</span> <span class="o">(</span><span class="n">timeout</span><span class="o">,</span> <span class="nn">Array</span><span class="p">.</span><span class="n">sub</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="mi">1</span> <span class="o">(</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="o">))</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">command</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">then</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;usage: %s [ -timeout ] cmd args</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">);</span>
        <span class="n">exit</span> <span class="mi">255</span><span class="o">)</span>

<span class="k">let</span> <span class="n">window</span> <span class="o">=</span> <span class="nn">Curses</span><span class="p">.</span><span class="n">initscr</span> <span class="bp">()</span>          <span class="c">(* start screen *)</span>
<span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="nn">Curses</span><span class="p">.</span><span class="n">noecho</span> <span class="bp">()</span>
<span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="nn">Curses</span><span class="p">.</span><span class="n">cbreak</span> <span class="bp">()</span>
<span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="nn">Curses</span><span class="p">.</span><span class="n">nodelay</span> <span class="n">window</span> <span class="bp">true</span>      <span class="c">(* so getch() is non-blocking *)</span>

<span class="k">let</span> <span class="k">done&#39;</span> <span class="n">s</span> <span class="o">_</span> <span class="o">=</span> <span class="nn">Curses</span><span class="p">.</span><span class="n">endwin</span> <span class="bp">()</span><span class="o">;</span> <span class="n">print_endline</span> <span class="n">s</span><span class="o">;</span> <span class="n">exit</span> <span class="mi">0</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">set_signal</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigint</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="nc">Signal_handle</span> <span class="o">(</span><span class="k">done&#39;</span> <span class="s2">&quot;Ouch!&quot;</span><span class="o">))</span>

<span class="k">let</span> <span class="n">cols</span><span class="o">,</span> <span class="n">lines</span> <span class="o">=</span> <span class="nn">Curses</span><span class="p">.</span><span class="n">getmaxyx</span> <span class="n">window</span>

<span class="k">let</span> <span class="n">days</span> <span class="o">=</span> <span class="o">[|</span> <span class="s2">&quot;Sun&quot;</span><span class="o">;</span> <span class="s2">&quot;Mon&quot;</span><span class="o">;</span> <span class="s2">&quot;Tue&quot;</span><span class="o">;</span> <span class="s2">&quot;Wed&quot;</span><span class="o">;</span> <span class="s2">&quot;Thu&quot;</span><span class="o">;</span> <span class="s2">&quot;Fri&quot;</span><span class="o">;</span> <span class="s2">&quot;Sat&quot;</span> <span class="o">|]</span>
<span class="k">let</span> <span class="n">months</span> <span class="o">=</span> <span class="o">[|</span> <span class="s2">&quot;Jan&quot;</span><span class="o">;</span> <span class="s2">&quot;Feb&quot;</span><span class="o">;</span> <span class="s2">&quot;Mar&quot;</span><span class="o">;</span> <span class="s2">&quot;Apr&quot;</span><span class="o">;</span> <span class="s2">&quot;May&quot;</span><span class="o">;</span> <span class="s2">&quot;Jun&quot;</span><span class="o">;</span>
                <span class="s2">&quot;Jul&quot;</span><span class="o">;</span> <span class="s2">&quot;Aug&quot;</span><span class="o">;</span> <span class="s2">&quot;Sep&quot;</span><span class="o">;</span> <span class="s2">&quot;Oct&quot;</span><span class="o">;</span> <span class="s2">&quot;Nov&quot;</span><span class="o">;</span> <span class="s2">&quot;Dec&quot;</span> <span class="o">|]</span>

<span class="k">let</span> <span class="n">format_time</span> <span class="n">time</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">tm</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">localtime</span> <span class="n">time</span> <span class="k">in</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;%s %s %2d %02d:%02d:%02d %04d&quot;</span>
    <span class="n">days</span><span class="o">.(</span><span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_wday</span><span class="o">)</span>
    <span class="n">months</span><span class="o">.(</span><span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_mon</span><span class="o">)</span>
    <span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_mday</span>
    <span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_hour</span>
    <span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_min</span>
    <span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_sec</span>
    <span class="o">(</span><span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_year</span> <span class="o">+</span> <span class="mi">1900</span><span class="o">)</span>

<span class="k">let</span> <span class="n">time</span> <span class="o">=</span> <span class="n">fst</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">mktime</span> <span class="o">{</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_sec</span><span class="o">=</span><span class="mi">50</span><span class="o">;</span> <span class="n">tm_min</span><span class="o">=</span><span class="mi">45</span><span class="o">;</span> <span class="n">tm_hour</span><span class="o">=</span><span class="mi">3</span><span class="o">;</span>
                             <span class="n">tm_mday</span><span class="o">=</span><span class="mi">18</span><span class="o">;</span> <span class="n">tm_mon</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">tm_year</span><span class="o">=</span><span class="mi">73</span><span class="o">;</span>
                             <span class="n">tm_wday</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">tm_yday</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">tm_isdst</span><span class="o">=</span><span class="bp">false</span><span class="o">})</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">key</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(-</span><span class="mi">1</span><span class="o">)</span> <span class="k">in</span>
    <span class="k">while</span> <span class="n">key</span> <span class="o">:=</span> <span class="nn">Curses</span><span class="p">.</span><span class="n">getch</span> <span class="bp">()</span><span class="o">;</span> <span class="o">!</span><span class="n">key</span> <span class="o">&lt;&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="k">do</span>
      <span class="k">if</span> <span class="o">!</span><span class="n">key</span> <span class="o">=</span> <span class="nn">Char</span><span class="p">.</span><span class="n">code</span> <span class="sc">&#39;q&#39;</span> <span class="k">then</span> <span class="k">done&#39;</span> <span class="s2">&quot;See ya&quot;</span> <span class="bp">()</span>
    <span class="k">done</span><span class="o">;</span>

    <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span>
      <span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_in</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot; &quot;</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="n">command</span><span class="o">))</span> <span class="k">in</span>
    <span class="k">begin</span>
      <span class="k">try</span>
        <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">to</span> <span class="n">lines</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">do</span>
          <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">in_channel</span> <span class="k">in</span>
          <span class="n">ignore</span> <span class="o">(</span><span class="nn">Curses</span><span class="p">.</span><span class="n">mvaddstr</span> <span class="n">i</span> <span class="mi">0</span> <span class="n">line</span><span class="o">);</span>

          <span class="nn">Curses</span><span class="p">.</span><span class="n">standout</span> <span class="bp">()</span><span class="o">;</span>
          <span class="n">ignore</span> <span class="o">(</span><span class="nn">Curses</span><span class="p">.</span><span class="n">mvaddstr</span> <span class="o">(</span><span class="n">lines</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">(</span><span class="n">cols</span> <span class="o">-</span> <span class="mi">24</span><span class="o">)</span>
                    <span class="o">(</span><span class="n">format_time</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">time</span> <span class="bp">()</span><span class="o">)));</span>
          <span class="nn">Curses</span><span class="p">.</span><span class="n">standend</span> <span class="bp">()</span><span class="o">;</span>

          <span class="n">ignore</span> <span class="o">(</span><span class="nn">Curses</span><span class="p">.</span><span class="n">move</span> <span class="mi">0</span> <span class="mi">0</span><span class="o">);</span>
          <span class="n">ignore</span> <span class="o">(</span><span class="nn">Curses</span><span class="p">.</span><span class="n">refresh</span> <span class="bp">()</span><span class="o">);</span>
        <span class="k">done</span><span class="o">;</span>
        <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_in</span> <span class="n">in_channel</span><span class="o">)</span>
      <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
        <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_in</span> <span class="n">in_channel</span><span class="o">)</span>
    <span class="k">end</span><span class="o">;</span>

    <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">select</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span><span class="o">]</span> <span class="bp">[]</span> <span class="bp">[]</span> <span class="n">timeout</span><span class="o">)</span>
  <span class="k">done</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">err</span> <span class="o">=</span> <span class="nn">Curses</span><span class="p">.</span><span class="n">keypad</span> <span class="n">window</span> <span class="bp">true</span>     <span class="c">(* enable keypad mode *)</span>
<span class="k">let</span> <span class="n">key</span> <span class="o">=</span> <span class="nn">Curses</span><span class="p">.</span><span class="n">getch</span> <span class="bp">()</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">key</span> <span class="o">=</span> <span class="o">(</span><span class="nn">Char</span><span class="p">.</span><span class="n">code</span> <span class="sc">&#39;k&#39;</span><span class="o">)</span> <span class="o">||</span>          <span class="c">(* vi mode *)</span>
      <span class="n">key</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">||</span>                       <span class="c">(* emacs mode *)</span>
      <span class="n">key</span> <span class="o">=</span> <span class="nn">Curses</span><span class="p">.</span><span class="nn">Key</span><span class="p">.</span><span class="n">up</span><span class="o">)</span>              <span class="c">(* arrow mode *)</span>
  <span class="k">then</span>
    <span class="k">begin</span>
      <span class="c">(* do something *)</span>
    <span class="k">end</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN828"
>Controlling Another Program with Expect</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* Use perl4caml to integrate OCaml with Perl:</span>
<span class="c">   http://merjis.com/developers/perl4caml *)</span>
<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+perl&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;perl4caml.cma&quot;</span><span class="o">;;</span>

<span class="c">(* Wrap the needed functionality from CPAN&#39;s Expect module: *)</span>
<span class="k">module</span> <span class="nc">Expect</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">open</span> <span class="nc">Perl</span>
  <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">eval</span> <span class="s2">&quot;use Expect&quot;</span>

  <span class="k">exception</span> <span class="nc">Error</span> <span class="k">of</span> <span class="kt">string</span>

  <span class="k">type</span> <span class="n">match_pattern</span> <span class="o">=</span> <span class="nc">Ex</span> <span class="k">of</span> <span class="kt">string</span> <span class="o">|</span> <span class="nc">Re</span> <span class="k">of</span> <span class="kt">string</span>

  <span class="k">class</span> <span class="n">expect</span> <span class="bp">()</span> <span class="o">=</span> <span class="k">object</span> <span class="o">(</span><span class="n">self</span><span class="o">)</span>
    <span class="k">val</span> <span class="n">sv</span> <span class="o">=</span> <span class="n">call_class_method</span> <span class="s2">&quot;Expect&quot;</span> <span class="s2">&quot;new&quot;</span> <span class="bp">[]</span>

    <span class="k">method</span> <span class="n">log_stdout</span> <span class="o">=</span>
      <span class="n">bool_of_sv</span> <span class="o">(</span><span class="n">call_method</span> <span class="n">sv</span> <span class="s2">&quot;log_stdout&quot;</span> <span class="bp">[]</span><span class="o">)</span>

    <span class="k">method</span> <span class="n">set_log_stdout</span> <span class="kt">bool</span> <span class="o">=</span>
      <span class="n">ignore</span> <span class="o">(</span><span class="n">call_method</span> <span class="n">sv</span> <span class="s2">&quot;log_stdout&quot;</span> <span class="o">[</span><span class="n">sv_of_bool</span> <span class="kt">bool</span><span class="o">])</span>

    <span class="k">method</span> <span class="n">spawn</span> <span class="n">command</span> <span class="n">parameters</span> <span class="o">=</span>
      <span class="k">let</span> <span class="n">result</span> <span class="o">=</span>
        <span class="n">call_method</span> <span class="n">sv</span> <span class="s2">&quot;spawn&quot;</span>
          <span class="o">(</span><span class="n">sv_of_string</span> <span class="n">command</span> <span class="o">::</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">sv_of_string</span> <span class="n">parameters</span><span class="o">)</span> <span class="k">in</span>
      <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="n">bool_of_sv</span> <span class="n">result</span><span class="o">)</span>
      <span class="k">then</span> <span class="k">raise</span> <span class="o">(</span><span class="nc">Error</span> <span class="o">(</span><span class="n">string_of_sv</span> <span class="o">(</span><span class="n">eval</span> <span class="s2">&quot;$!&quot;</span><span class="o">)))</span>

    <span class="k">method</span> <span class="n">expect</span> <span class="n">timeout</span> <span class="n">match_patterns</span> <span class="o">=</span>
      <span class="k">let</span> <span class="n">svs_of_pattern</span> <span class="o">=</span> <span class="k">function</span>
        <span class="o">|</span> <span class="nc">Ex</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="o">[</span><span class="n">sv_of_string</span> <span class="s2">&quot;-ex&quot;</span><span class="o">;</span> <span class="n">sv_of_string</span> <span class="n">s</span><span class="o">]</span>
        <span class="o">|</span> <span class="nc">Re</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="o">[</span><span class="n">sv_of_string</span> <span class="s2">&quot;-re&quot;</span><span class="o">;</span> <span class="n">sv_of_string</span> <span class="n">s</span><span class="o">]</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">timeout</span> <span class="o">=</span>
        <span class="k">match</span> <span class="n">timeout</span> <span class="k">with</span>
          <span class="o">|</span> <span class="nc">Some</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">sv_of_int</span> <span class="n">i</span>
          <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="n">sv_undef</span> <span class="bp">()</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">result</span> <span class="o">=</span>
        <span class="n">call_method</span> <span class="n">sv</span> <span class="s2">&quot;expect&quot;</span>
          <span class="o">(</span><span class="n">timeout</span> <span class="o">::</span>
             <span class="nn">List</span><span class="p">.</span><span class="n">flatten</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">svs_of_pattern</span> <span class="n">match_patterns</span><span class="o">))</span> <span class="k">in</span>
      <span class="k">if</span> <span class="n">sv_is_undef</span> <span class="n">result</span>
      <span class="k">then</span> <span class="nc">None</span>
      <span class="k">else</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">int_of_sv</span> <span class="n">result</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span>

    <span class="k">method</span> <span class="n">send</span> <span class="kt">string</span> <span class="o">=</span>
      <span class="n">ignore</span> <span class="o">(</span><span class="n">call_method</span> <span class="n">sv</span> <span class="s2">&quot;send&quot;</span> <span class="o">[</span><span class="n">sv_of_string</span> <span class="kt">string</span><span class="o">])</span>

    <span class="k">method</span> <span class="n">soft_close</span> <span class="bp">()</span> <span class="o">=</span>
      <span class="n">ignore</span> <span class="o">(</span><span class="n">call_method</span> <span class="n">sv</span> <span class="s2">&quot;soft_close&quot;</span> <span class="bp">[]</span><span class="o">)</span>

    <span class="k">method</span> <span class="n">hard_close</span> <span class="bp">()</span> <span class="o">=</span>
      <span class="n">ignore</span> <span class="o">(</span><span class="n">call_method</span> <span class="n">sv</span> <span class="s2">&quot;hard_close&quot;</span> <span class="bp">[]</span><span class="o">)</span>
  <span class="k">end</span>

  <span class="k">let</span> <span class="n">spawn</span> <span class="n">command</span> <span class="n">parameters</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">exp</span> <span class="o">=</span> <span class="k">new</span> <span class="n">expect</span> <span class="bp">()</span> <span class="k">in</span>
    <span class="n">exp</span><span class="o">#</span><span class="n">spawn</span> <span class="n">command</span> <span class="n">parameters</span><span class="o">;</span>
    <span class="n">exp</span>
<span class="k">end</span>

<span class="c">(* start the program *)</span>
<span class="k">let</span> <span class="n">command</span> <span class="o">=</span>
  <span class="k">try</span> <span class="nn">Expect</span><span class="p">.</span><span class="n">spawn</span> <span class="s2">&quot;program to run&quot;</span> <span class="o">[</span><span class="s2">&quot;arg 1&quot;</span><span class="o">;</span> <span class="s2">&quot;arg 2&quot;</span><span class="o">]</span>
  <span class="k">with</span> <span class="nn">Expect</span><span class="p">.</span><span class="nc">Error</span> <span class="n">e</span> <span class="o">-&gt;</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Couldn&#39;t start program: %s</span><span class="se">\n</span><span class="s2">%!&quot;</span> <span class="n">e</span><span class="o">;</span>
    <span class="n">exit</span> <span class="mi">1</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* prevent the program&#39;s output from being shown on our stdout *)</span>
  <span class="n">command</span><span class="o">#</span><span class="n">set_log_stdout</span> <span class="bp">false</span><span class="o">;</span>

  <span class="c">(* wait 10 seconds for &quot;login:&quot; to appear *)</span>
  <span class="k">if</span> <span class="n">command</span><span class="o">#</span><span class="n">expect</span> <span class="o">(</span><span class="nc">Some</span> <span class="mi">10</span><span class="o">)</span> <span class="o">[</span><span class="nn">Expect</span><span class="p">.</span><span class="nc">Ex</span> <span class="s2">&quot;login&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="nc">None</span>
  <span class="k">then</span> <span class="n">failwith</span> <span class="s2">&quot;timed out&quot;</span><span class="o">;</span>

  <span class="c">(* wait 20 seconds for something that matches /[Pp]assword: ?/ *)</span>
  <span class="k">if</span> <span class="n">command</span><span class="o">#</span><span class="n">expect</span> <span class="o">(</span><span class="nc">Some</span> <span class="mi">20</span><span class="o">)</span> <span class="o">[</span><span class="nn">Expect</span><span class="p">.</span><span class="nc">Re</span> <span class="s2">&quot;[Pp]assword: ?&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="nc">None</span>
  <span class="k">then</span> <span class="n">failwith</span> <span class="s2">&quot;timed out&quot;</span><span class="o">;</span>

  <span class="c">(* wait forever for &quot;invalid&quot; to appear *)</span>
  <span class="k">if</span> <span class="n">command</span><span class="o">#</span><span class="n">expect</span> <span class="nc">None</span> <span class="o">[</span><span class="nn">Expect</span><span class="p">.</span><span class="nc">Ex</span> <span class="s2">&quot;invalid&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="nc">None</span>
  <span class="k">then</span> <span class="n">failwith</span> <span class="s2">&quot;error occurred; the program probably went away&quot;</span><span class="o">;</span>

  <span class="c">(* send &quot;Hello, world&quot; and a carriage return to the program *)</span>
  <span class="n">command</span><span class="o">#</span><span class="n">send</span> <span class="s2">&quot;Hello, world</span><span class="se">\r</span><span class="s2">&quot;</span><span class="o">;</span>

  <span class="c">(* if the program will terminate by itself, finish up with *)</span>
  <span class="n">command</span><span class="o">#</span><span class="n">soft_close</span> <span class="bp">()</span><span class="o">;</span>

  <span class="c">(* if the program must be explicitly killed, finish up with *)</span>
  <span class="n">command</span><span class="o">#</span><span class="n">hard_close</span> <span class="bp">()</span>

<span class="c">(* wait for multiple strings *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">command</span><span class="o">#</span><span class="n">expect</span> <span class="o">(</span><span class="nc">Some</span> <span class="mi">30</span><span class="o">)</span>
    <span class="o">[</span><span class="nn">Expect</span><span class="p">.</span><span class="nc">Ex</span> <span class="s2">&quot;invalid&quot;</span><span class="o">;</span> <span class="nn">Expect</span><span class="p">.</span><span class="nc">Ex</span> <span class="s2">&quot;succes&quot;</span><span class="o">;</span>
     <span class="nn">Expect</span><span class="p">.</span><span class="nc">Ex</span> <span class="s2">&quot;error&quot;</span><span class="o">;</span> <span class="nn">Expect</span><span class="p">.</span><span class="nc">Ex</span> <span class="s2">&quot;boom&quot;</span><span class="o">]</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">which</span> <span class="o">-&gt;</span>
          <span class="c">(* found one of those strings *)</span>
          <span class="bp">()</span>
      <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span>
          <span class="bp">()</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN831"
>Creating Menus with Tk</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* LablTk is included in the OCaml standard library. *)</span>
<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+labltk&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;labltk.cma&quot;</span><span class="o">;;</span>

<span class="k">open</span> <span class="nc">Tk</span>

<span class="k">let</span> <span class="n">main</span> <span class="o">=</span> <span class="n">openTk</span> <span class="bp">()</span>

<span class="c">(* Create a horizontal space at the top of the window for the</span>
<span class="c">   menu to live in. *)</span>
<span class="k">let</span> <span class="n">menubar</span> <span class="o">=</span> <span class="nn">Frame</span><span class="p">.</span><span class="n">create</span> <span class="o">~</span><span class="n">relief</span><span class="o">:`</span><span class="nc">Raised</span> <span class="o">~</span><span class="n">borderwidth</span><span class="o">:</span><span class="mi">2</span> <span class="n">main</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">pack</span> <span class="o">~</span><span class="n">anchor</span><span class="o">:`</span><span class="nc">Nw</span> <span class="o">~</span><span class="n">fill</span><span class="o">:`</span><span class="nc">X</span> <span class="o">[</span><span class="n">menubar</span><span class="o">]</span>

<span class="c">(* Create a button labeled &quot;File&quot; that brings up a menu *)</span>
<span class="k">let</span> <span class="n">file_menubutton</span> <span class="o">=</span> <span class="nn">Menubutton</span><span class="p">.</span><span class="n">create</span> <span class="o">~</span><span class="n">text</span><span class="o">:</span><span class="s2">&quot;File&quot;</span> <span class="o">~</span><span class="n">underline</span><span class="o">:</span><span class="mi">1</span> <span class="n">menubar</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">pack</span> <span class="o">~</span><span class="n">side</span><span class="o">:`</span><span class="nc">Left</span> <span class="o">[</span><span class="n">file_menubutton</span><span class="o">]</span>

<span class="c">(* Create entries in the &quot;File&quot; menu *)</span>
<span class="k">let</span> <span class="n">file_menu</span> <span class="o">=</span> <span class="nn">Menu</span><span class="p">.</span><span class="n">create</span> <span class="n">file_menubutton</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Menubutton</span><span class="p">.</span><span class="n">configure</span> <span class="o">~</span><span class="n">menu</span><span class="o">:</span><span class="n">file_menu</span> <span class="n">file_menubutton</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Menu</span><span class="p">.</span><span class="n">add_command</span> <span class="o">~</span><span class="n">label</span><span class="o">:</span><span class="s2">&quot;Print&quot;</span> <span class="o">~</span><span class="n">command</span><span class="o">:</span><span class="n">print</span> <span class="n">file_menu</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Menu</span><span class="p">.</span><span class="n">add_command</span> <span class="o">~</span><span class="n">label</span><span class="o">:</span><span class="s2">&quot;Save&quot;</span> <span class="o">~</span><span class="n">command</span><span class="o">:</span><span class="n">save</span> <span class="n">file_menu</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Create a menu item using an anonymous callback *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Menu</span><span class="p">.</span><span class="n">add_command</span>
    <span class="o">~</span><span class="n">label</span><span class="o">:</span><span class="s2">&quot;Quit Immediately&quot;</span>
    <span class="o">~</span><span class="n">command</span><span class="o">:(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="n">exit</span> <span class="mi">0</span><span class="o">)</span>
    <span class="n">file_menu</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Add a separator (a horizontal line) to the menu *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Menu</span><span class="p">.</span><span class="n">add_separator</span> <span class="n">file_menu</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Create a checkbutton menu item *)</span>
<span class="k">let</span> <span class="n">debug</span> <span class="o">=</span> <span class="nn">Textvariable</span><span class="p">.</span><span class="n">create</span> <span class="o">~</span><span class="n">on</span><span class="o">:</span><span class="n">options_menu</span> <span class="bp">()</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Menu</span><span class="p">.</span><span class="n">add_checkbutton</span>
    <span class="o">~</span><span class="n">label</span><span class="o">:</span><span class="s2">&quot;Create Debugging File&quot;</span>
    <span class="o">~</span><span class="n">variable</span><span class="o">:</span><span class="n">debug</span>
    <span class="o">~</span><span class="n">onvalue</span><span class="o">:</span><span class="s2">&quot;1&quot;</span>
    <span class="o">~</span><span class="n">offvalue</span><span class="o">:</span><span class="s2">&quot;0&quot;</span>
    <span class="n">options_menu</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Create radiobutton menu items *)</span>
<span class="k">let</span> <span class="n">log_level</span> <span class="o">=</span> <span class="nn">Textvariable</span><span class="p">.</span><span class="n">create</span> <span class="o">~</span><span class="n">on</span><span class="o">:</span><span class="n">options_menu</span> <span class="bp">()</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Menu</span><span class="p">.</span><span class="n">add_radiobutton</span>
    <span class="o">~</span><span class="n">label</span><span class="o">:</span><span class="s2">&quot;Level 1&quot;</span>
    <span class="o">~</span><span class="n">variable</span><span class="o">:</span><span class="n">log_level</span>
    <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="s2">&quot;1&quot;</span>
    <span class="n">debug_menu</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Menu</span><span class="p">.</span><span class="n">add_radiobutton</span>
    <span class="o">~</span><span class="n">label</span><span class="o">:</span><span class="s2">&quot;Level 2&quot;</span>
    <span class="o">~</span><span class="n">variable</span><span class="o">:</span><span class="n">log_level</span>
    <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="s2">&quot;2&quot;</span>
    <span class="n">debug_menu</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Menu</span><span class="p">.</span><span class="n">add_radiobutton</span>
    <span class="o">~</span><span class="n">label</span><span class="o">:</span><span class="s2">&quot;Level 3&quot;</span>
    <span class="o">~</span><span class="n">variable</span><span class="o">:</span><span class="n">log_level</span>
    <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="s2">&quot;3&quot;</span>
    <span class="n">debug_menu</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Create a nested menu *)</span>
<span class="k">let</span> <span class="n">font_menu</span> <span class="o">=</span> <span class="nn">Menu</span><span class="p">.</span><span class="n">create</span> <span class="n">format_menubutton</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Menu</span><span class="p">.</span><span class="n">add_cascade</span> <span class="o">~</span><span class="n">label</span><span class="o">:</span><span class="s2">&quot;Font&quot;</span> <span class="o">~</span><span class="n">menu</span><span class="o">:</span><span class="n">font_menu</span> <span class="n">format_menu</span>
<span class="k">let</span> <span class="n">font_name</span> <span class="o">=</span> <span class="nn">Textvariable</span><span class="p">.</span><span class="n">create</span> <span class="o">~</span><span class="n">on</span><span class="o">:</span><span class="n">font_menu</span> <span class="bp">()</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Menu</span><span class="p">.</span><span class="n">add_radiobutton</span>
    <span class="o">~</span><span class="n">label</span><span class="o">:</span><span class="s2">&quot;Courier&quot;</span>
    <span class="o">~</span><span class="n">variable</span><span class="o">:</span><span class="n">font_name</span>
    <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="s2">&quot;courier&quot;</span>
    <span class="n">font_menu</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Menu</span><span class="p">.</span><span class="n">add_radiobutton</span>
    <span class="o">~</span><span class="n">label</span><span class="o">:</span><span class="s2">&quot;Times Roman&quot;</span>
    <span class="o">~</span><span class="n">variable</span><span class="o">:</span><span class="n">font_name</span>
    <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="s2">&quot;times&quot;</span>
    <span class="n">font_menu</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* To disable tearoffs, use ~tearoff:false when calling Menu.create *)</span>
<span class="k">let</span> <span class="n">font_menu</span> <span class="o">=</span> <span class="nn">Menu</span><span class="p">.</span><span class="n">create</span> <span class="o">~</span><span class="n">tearoff</span><span class="o">:</span><span class="bp">false</span> <span class="n">format_menubutton</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Start the Tk event loop and display the interface *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Printexc</span><span class="p">.</span><span class="n">print</span> <span class="n">mainLoop</span> <span class="bp">()</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN834"
>Creating Dialog Boxes with Tk</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* Tk::DialogBox is a CPAN module that replaces Tk&#39;s standard Dialog</span>
<span class="c">   widget with one that can be customized with additional inputs. To</span>
<span class="c">   get this effect in OCaml would require translating the whole CPAN</span>
<span class="c">   module; instead, for this simple example, we will use the built-in</span>
<span class="c">   Dialog. *)</span>

<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+labltk&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;labltk.cma&quot;</span><span class="o">;;</span>

<span class="k">open</span> <span class="nc">Tk</span>

<span class="k">let</span> <span class="n">main</span> <span class="o">=</span> <span class="n">openTk</span> <span class="bp">()</span>

<span class="k">let</span> <span class="n">dialog</span> <span class="o">=</span>
  <span class="nn">Dialog</span><span class="p">.</span><span class="n">create</span>
    <span class="o">~</span><span class="n">title</span><span class="o">:</span><span class="s2">&quot;Register This Program&quot;</span>
    <span class="o">~</span><span class="n">buttons</span><span class="o">:[</span><span class="s2">&quot;Register&quot;</span><span class="o">;</span> <span class="s2">&quot;Cancel&quot;</span><span class="o">]</span>
    <span class="o">~</span><span class="n">parent</span><span class="o">:</span><span class="n">main</span>
    <span class="o">~</span><span class="n">message</span><span class="o">:</span><span class="s2">&quot;...&quot;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">dialog</span> <span class="bp">()</span> <span class="k">with</span>
    <span class="o">|</span> <span class="mi">0</span> <span class="o">-&gt;</span> <span class="n">print_endline</span> <span class="s2">&quot;Register&quot;</span>
    <span class="o">|</span> <span class="mi">1</span> <span class="o">-&gt;</span> <span class="n">print_endline</span> <span class="s2">&quot;Cancel&quot;</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">&quot;this shouldn&#39;t happen&quot;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Printexc</span><span class="p">.</span><span class="n">print</span> <span class="n">mainLoop</span> <span class="bp">()</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Normally, uncaught exceptions are printed to standard error. However,</span>
<span class="c">   by overriding the &quot;camlcb&quot; callback, a custom error handler can be</span>
<span class="c">   installed which creates dialogs instead. *)</span>

<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+labltk&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;labltk.cma&quot;</span><span class="o">;;</span>

<span class="k">open</span> <span class="nc">Tk</span>

<span class="k">let</span> <span class="n">main</span> <span class="o">=</span> <span class="n">openTk</span> <span class="bp">()</span>

<span class="k">let</span> <span class="n">show_error</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">dialog</span> <span class="o">=</span>
    <span class="nn">Dialog</span><span class="p">.</span><span class="n">create</span>
      <span class="o">~</span><span class="n">title</span><span class="o">:</span><span class="s2">&quot;Error&quot;</span>
      <span class="o">~</span><span class="n">buttons</span><span class="o">:[</span><span class="s2">&quot;Acknowledge&quot;</span><span class="o">]</span>
      <span class="o">~</span><span class="n">parent</span><span class="o">:</span><span class="n">main</span> <span class="k">in</span>
  <span class="k">fun</span> <span class="n">message</span> <span class="o">-&gt;</span> <span class="n">ignore</span> <span class="o">(</span><span class="n">dialog</span> <span class="o">~</span><span class="n">message</span> <span class="bp">()</span><span class="o">)</span>

<span class="c">(* Override the &quot;camlcb&quot; callback. Note that this is an undocumented</span>
<span class="c">   feature that relies on some internals of Labltk. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Callback</span><span class="p">.</span><span class="n">register</span> <span class="s2">&quot;camlcb&quot;</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">id</span> <span class="n">args</span> <span class="o">-&gt;</span>
       <span class="k">try</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="nn">Protocol</span><span class="p">.</span><span class="n">callback_naming_table</span> <span class="n">id</span><span class="o">)</span> <span class="n">args</span>
       <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">show_error</span> <span class="o">(</span><span class="nn">Printexc</span><span class="p">.</span><span class="n">to_string</span> <span class="n">e</span><span class="o">))</span>

<span class="k">let</span> <span class="n">make_error</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">failwith</span> <span class="s2">&quot;This is an error&quot;</span>

<span class="k">let</span> <span class="n">button1</span> <span class="o">=</span>
  <span class="nn">Button</span><span class="p">.</span><span class="n">create</span> <span class="o">~</span><span class="n">text</span><span class="o">:</span><span class="s2">&quot;Make An Error&quot;</span> <span class="o">~</span><span class="n">command</span><span class="o">:</span><span class="n">make_error</span> <span class="n">main</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">pack</span> <span class="o">~</span><span class="n">side</span><span class="o">:`</span><span class="nc">Left</span> <span class="o">[</span><span class="n">button1</span><span class="o">]</span>

<span class="k">let</span> <span class="n">button2</span> <span class="o">=</span>
  <span class="nn">Button</span><span class="p">.</span><span class="n">create</span> <span class="o">~</span><span class="n">text</span><span class="o">:</span><span class="s2">&quot;Quit&quot;</span> <span class="o">~</span><span class="n">command</span><span class="o">:(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="n">exit</span> <span class="mi">0</span><span class="o">)</span> <span class="n">main</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">pack</span> <span class="o">~</span><span class="n">side</span><span class="o">:`</span><span class="nc">Left</span> <span class="o">[</span><span class="n">button2</span><span class="o">]</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Printexc</span><span class="p">.</span><span class="n">print</span> <span class="n">mainLoop</span> <span class="bp">()</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN837"
>Responding to Tk Resize Events</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="k">open</span> <span class="nc">Tk</span>

<span class="k">let</span> <span class="n">main</span> <span class="o">=</span> <span class="n">openTk</span> <span class="bp">()</span>

<span class="c">(* Prevent the user from resizing the window. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">bind</span> <span class="n">main</span>
    <span class="o">~</span><span class="n">events</span><span class="o">:[`</span><span class="nc">Configure</span><span class="o">]</span>
    <span class="o">~</span><span class="n">action</span><span class="o">:(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span>
               <span class="k">let</span> <span class="n">width</span> <span class="o">=</span> <span class="nn">Winfo</span><span class="p">.</span><span class="n">width</span> <span class="n">main</span> <span class="k">in</span>
               <span class="k">let</span> <span class="n">height</span> <span class="o">=</span> <span class="nn">Winfo</span><span class="p">.</span><span class="n">height</span> <span class="n">main</span> <span class="k">in</span>
               <span class="nn">Wm</span><span class="p">.</span><span class="n">minsize_set</span> <span class="n">main</span> <span class="n">width</span> <span class="n">height</span><span class="o">;</span>
               <span class="nn">Wm</span><span class="p">.</span><span class="n">maxsize_set</span> <span class="n">main</span> <span class="n">width</span> <span class="n">height</span><span class="o">)</span>

<span class="c">(* Or, use pack to control how widgets are resized. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">pack</span> <span class="o">~</span><span class="n">fill</span><span class="o">:`</span><span class="nc">Both</span> <span class="o">~</span><span class="n">expand</span><span class="o">:</span><span class="bp">true</span> <span class="o">[</span><span class="n">widget</span><span class="o">]</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">pack</span> <span class="o">~</span><span class="n">fill</span><span class="o">:`</span><span class="nc">X</span> <span class="o">~</span><span class="n">expand</span><span class="o">:</span><span class="bp">true</span> <span class="o">[</span><span class="n">widget</span><span class="o">]</span>

<span class="c">(* Make the main area expand horizontally and vertically. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">pack</span> <span class="o">~</span><span class="n">fill</span><span class="o">:`</span><span class="nc">Both</span> <span class="o">~</span><span class="n">expand</span><span class="o">:</span><span class="bp">true</span> <span class="o">[</span><span class="n">mainarea</span><span class="o">]</span>

<span class="c">(* Make the menu bar only expand horizontally. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">pack</span> <span class="o">~</span><span class="n">fill</span><span class="o">:`</span><span class="nc">X</span> <span class="o">~</span><span class="n">expand</span><span class="o">:</span><span class="bp">true</span> <span class="o">[</span><span class="n">menubar</span><span class="o">]</span>

<span class="c">(* Anchor the menu bar to the top-left corner. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">pack</span> <span class="o">~</span><span class="n">fill</span><span class="o">:`</span><span class="nc">X</span> <span class="o">~</span><span class="n">expand</span><span class="o">:</span><span class="bp">true</span> <span class="o">~</span><span class="n">anchor</span><span class="o">:`</span><span class="nc">Nw</span> <span class="o">[</span><span class="n">menubar</span><span class="o">]</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN840"
>Removing the DOS Shell Window with Windows Perl/Tk</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* Use Harry Chomsky&#39;s mkwinapp.ml from the OCaml-Win32 project:</span>

<span class="c">   http://ocaml-win32.sourceforge.net/</span>

<span class="c">   Compile your program using the native compiler and run mkwinapp.exe</span>
<span class="c">   on the result. *)</span>

<span class="nc">C</span><span class="o">:</span><span class="err">\</span><span class="nc">MyProg</span><span class="o">&gt;</span> <span class="n">ocamlopt</span> <span class="n">myprog</span><span class="o">.</span><span class="n">ml</span> <span class="o">-</span><span class="n">o</span> <span class="n">myprog</span><span class="o">.</span><span class="n">exe</span>
<span class="nc">C</span><span class="o">:</span><span class="err">\</span><span class="nc">MyProg</span><span class="o">&gt;</span> <span class="n">ocamlopt</span> <span class="n">unix</span><span class="o">.</span><span class="n">cmxa</span> <span class="n">mkwinapp</span><span class="o">.</span><span class="n">ml</span> <span class="o">-</span><span class="n">o</span> <span class="n">mkwinapp</span><span class="o">.</span><span class="n">exe</span>
<span class="nc">C</span><span class="o">:</span><span class="err">\</span><span class="nc">MyProg</span><span class="o">&gt;</span> <span class="n">mkwinapp</span> <span class="n">myprog</span><span class="o">.</span><span class="n">exe</span>

<span class="c">(* Now you can run &quot;myprog&quot; and you won&#39;t get a console window. *)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN843"
>Program: Small termcap program</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>

<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+curses&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;curses.cma&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">delay</span> <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="mi">005</span>

<span class="c">(* Bounce lines around the screen until the user interrupts with</span>
<span class="c">   Ctrl-C. *)</span>
<span class="k">let</span> <span class="n">zip</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Curses</span><span class="p">.</span><span class="n">clear</span> <span class="bp">()</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">maxcol</span><span class="o">,</span> <span class="n">maxrow</span> <span class="o">=</span> <span class="nn">Curses</span><span class="p">.</span><span class="n">get_size</span> <span class="bp">()</span> <span class="k">in</span>

  <span class="k">let</span> <span class="n">chars</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">[</span><span class="sc">&#39;*&#39;</span><span class="o">;</span> <span class="sc">&#39;-&#39;</span><span class="o">;</span> <span class="sc">&#39;/&#39;</span><span class="o">;</span> <span class="sc">&#39;|&#39;</span><span class="o">;</span> <span class="sc">&#39;\\&#39;</span><span class="o">;</span> <span class="sc">&#39;_&#39;</span><span class="o">]</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">circle</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">chars</span> <span class="o">:=</span> <span class="nn">List</span><span class="p">.</span><span class="n">tl</span> <span class="o">!</span><span class="n">chars</span> <span class="o">@</span> <span class="o">[</span><span class="nn">List</span><span class="p">.</span><span class="n">hd</span> <span class="o">!</span><span class="n">chars</span><span class="o">]</span> <span class="k">in</span>

  <span class="k">let</span> <span class="n">row</span><span class="o">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span><span class="o">,</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">row_sign</span><span class="o">,</span> <span class="n">col_sign</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">1</span><span class="o">,</span> <span class="n">ref</span> <span class="mi">1</span> <span class="k">in</span>

  <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
    <span class="n">ignore</span> <span class="o">(</span><span class="nn">Curses</span><span class="p">.</span><span class="n">mvaddch</span> <span class="o">!</span><span class="n">col</span> <span class="o">!</span><span class="n">row</span> <span class="o">(</span><span class="nn">Char</span><span class="p">.</span><span class="n">code</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">hd</span> <span class="o">!</span><span class="n">chars</span><span class="o">)));</span>
    <span class="n">ignore</span> <span class="o">(</span><span class="nn">Curses</span><span class="p">.</span><span class="n">refresh</span> <span class="bp">()</span><span class="o">);</span>
    <span class="o">(</span><span class="k">try</span> <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">select</span> <span class="bp">[]</span> <span class="bp">[]</span> <span class="bp">[]</span> <span class="n">delay</span><span class="o">)</span> <span class="k">with</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">);</span>
    <span class="n">row</span> <span class="o">:=</span> <span class="o">!</span><span class="n">row</span> <span class="o">+</span> <span class="o">!</span><span class="n">row_sign</span><span class="o">;</span>
    <span class="n">col</span> <span class="o">:=</span> <span class="o">!</span><span class="n">col</span> <span class="o">+</span> <span class="o">!</span><span class="n">col_sign</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">!</span><span class="n">row</span> <span class="o">=</span> <span class="n">maxrow</span> <span class="k">then</span> <span class="o">(</span><span class="n">row_sign</span> <span class="o">:=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span> <span class="n">circle</span> <span class="bp">()</span><span class="o">)</span>
    <span class="k">else</span> <span class="k">if</span> <span class="o">!</span><span class="n">row</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">then</span> <span class="o">(</span><span class="n">row_sign</span> <span class="o">:=</span>  <span class="mi">1</span><span class="o">;</span> <span class="n">circle</span> <span class="bp">()</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">!</span><span class="n">col</span> <span class="o">=</span> <span class="n">maxcol</span> <span class="k">then</span> <span class="o">(</span><span class="n">col_sign</span> <span class="o">:=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span> <span class="n">circle</span> <span class="bp">()</span><span class="o">)</span>
    <span class="k">else</span> <span class="k">if</span> <span class="o">!</span><span class="n">col</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">then</span> <span class="o">(</span><span class="n">col_sign</span> <span class="o">:=</span>  <span class="mi">1</span><span class="o">;</span> <span class="n">circle</span> <span class="bp">()</span><span class="o">)</span>
  <span class="k">done</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Curses</span><span class="p">.</span><span class="n">initscr</span> <span class="bp">()</span><span class="o">);</span>
  <span class="n">at_exit</span> <span class="nn">Curses</span><span class="p">.</span><span class="n">endwin</span><span class="o">;</span>
  <span class="n">zip</span> <span class="bp">()</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN846"
>Program: tkshufflepod</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* tkshufflepod - reorder =head1 sections in a pod file *)</span>
<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+labltk&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;labltk.cma&quot;</span><span class="o">;;</span>

<span class="k">open</span> <span class="nc">Tk</span>

<span class="c">(* Custom text viewer widget. *)</span>

<span class="k">class</span> <span class="n">viewer</span> <span class="n">parent</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">toplevel</span> <span class="o">=</span> <span class="nn">Toplevel</span><span class="p">.</span><span class="n">create</span> <span class="n">parent</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">frame</span> <span class="o">=</span> <span class="nn">Frame</span><span class="p">.</span><span class="n">create</span> <span class="n">toplevel</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">text</span> <span class="o">=</span> <span class="nn">Text</span><span class="p">.</span><span class="n">create</span> <span class="o">~</span><span class="n">width</span><span class="o">:</span><span class="mi">80</span> <span class="o">~</span><span class="n">height</span><span class="o">:</span><span class="mi">30</span> <span class="o">~</span><span class="n">state</span><span class="o">:`</span><span class="nc">Disabled</span> <span class="n">frame</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">vscroll</span> <span class="o">=</span> <span class="nn">Scrollbar</span><span class="p">.</span><span class="n">create</span> <span class="o">~</span><span class="n">orient</span><span class="o">:`</span><span class="nc">Vertical</span> <span class="n">frame</span> <span class="k">in</span>

<span class="k">object</span> <span class="o">(</span><span class="n">self</span><span class="o">)</span>
  <span class="k">initializer</span>
    <span class="n">self</span><span class="o">#</span><span class="n">hide</span> <span class="bp">()</span><span class="o">;</span>
    <span class="nn">Text</span><span class="p">.</span><span class="n">configure</span> <span class="o">~</span><span class="n">yscrollcommand</span><span class="o">:(</span><span class="nn">Scrollbar</span><span class="p">.</span><span class="n">set</span> <span class="n">vscroll</span><span class="o">)</span> <span class="n">text</span><span class="o">;</span>
    <span class="nn">Scrollbar</span><span class="p">.</span><span class="n">configure</span> <span class="o">~</span><span class="n">command</span><span class="o">:(</span><span class="nn">Text</span><span class="p">.</span><span class="n">yview</span> <span class="n">text</span><span class="o">)</span> <span class="n">vscroll</span><span class="o">;</span>
    <span class="n">pack</span> <span class="o">~</span><span class="n">side</span><span class="o">:`</span><span class="nc">Right</span> <span class="o">~</span><span class="n">fill</span><span class="o">:`</span><span class="nc">Y</span> <span class="o">[</span><span class="n">vscroll</span><span class="o">];</span>
    <span class="n">pack</span> <span class="o">~</span><span class="n">side</span><span class="o">:`</span><span class="nc">Left</span> <span class="o">~</span><span class="n">fill</span><span class="o">:`</span><span class="nc">Both</span> <span class="o">~</span><span class="n">expand</span><span class="o">:</span><span class="bp">true</span> <span class="o">[</span><span class="n">text</span><span class="o">];</span>
    <span class="n">pack</span> <span class="o">~</span><span class="n">side</span><span class="o">:`</span><span class="nc">Right</span> <span class="o">~</span><span class="n">fill</span><span class="o">:`</span><span class="nc">Both</span> <span class="o">~</span><span class="n">expand</span><span class="o">:</span><span class="bp">true</span> <span class="o">[</span><span class="n">frame</span><span class="o">];</span>
    <span class="nn">Wm</span><span class="p">.</span><span class="n">protocol_set</span> <span class="n">toplevel</span> <span class="s2">&quot;WM_DELETE_WINDOW&quot;</span> <span class="n">self</span><span class="o">#</span><span class="n">hide</span>

  <span class="k">method</span> <span class="n">show</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Wm</span><span class="p">.</span><span class="n">deiconify</span> <span class="n">toplevel</span><span class="o">;</span> <span class="n">raise_window</span> <span class="n">toplevel</span>
  <span class="k">method</span> <span class="n">hide</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Wm</span><span class="p">.</span><span class="n">withdraw</span> <span class="n">toplevel</span>

  <span class="k">method</span> <span class="n">set_title</span> <span class="o">=</span> <span class="nn">Wm</span><span class="p">.</span><span class="n">title_set</span> <span class="n">toplevel</span>
  <span class="k">method</span> <span class="n">set_body</span> <span class="n">body</span> <span class="o">=</span>
    <span class="nn">Text</span><span class="p">.</span><span class="n">configure</span> <span class="o">~</span><span class="n">state</span><span class="o">:`</span><span class="nc">Normal</span> <span class="n">text</span><span class="o">;</span>
    <span class="nn">Text</span><span class="p">.</span><span class="n">delete</span> <span class="o">~</span><span class="n">start</span><span class="o">:(`</span><span class="nc">Atxy</span> <span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">),</span> <span class="bp">[]</span><span class="o">)</span> <span class="o">~</span><span class="n">stop</span><span class="o">:(`</span><span class="nc">End</span><span class="o">,</span> <span class="bp">[]</span><span class="o">)</span> <span class="n">text</span><span class="o">;</span>
    <span class="nn">Text</span><span class="p">.</span><span class="n">insert</span> <span class="o">~</span><span class="n">index</span><span class="o">:(`</span><span class="nc">End</span><span class="o">,</span> <span class="bp">[]</span><span class="o">)</span> <span class="o">~</span><span class="n">text</span><span class="o">:</span><span class="n">body</span> <span class="n">text</span><span class="o">;</span>
    <span class="nn">Text</span><span class="p">.</span><span class="n">configure</span> <span class="o">~</span><span class="n">state</span><span class="o">:`</span><span class="nc">Disabled</span> <span class="n">text</span>
<span class="k">end</span>

<span class="c">(* Give list references a similar interface to Tk</span>
<span class="c">   listbox widgets so we can keep the two in sync. *)</span>

<span class="k">let</span> <span class="n">listref_get</span> <span class="n">listref</span> <span class="n">index</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">index</span> <span class="k">with</span>
    <span class="o">|</span> <span class="o">`</span><span class="nc">Num</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">nth</span> <span class="o">!</span><span class="n">listref</span> <span class="n">i</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">&quot;listref_get&quot;</span>

<span class="k">let</span> <span class="n">listref_delete</span> <span class="n">listref</span> <span class="n">index</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">index</span> <span class="k">with</span>
    <span class="o">|</span> <span class="o">`</span><span class="nc">Num</span> <span class="n">i</span> <span class="o">-&gt;</span>
        <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span> <span class="n">current</span> <span class="kt">list</span> <span class="o">=</span>
          <span class="k">match</span> <span class="kt">list</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">head</span> <span class="o">::</span> <span class="n">tail</span> <span class="k">when</span> <span class="n">current</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="o">(</span><span class="n">current</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">tail</span>
            <span class="o">|</span> <span class="n">head</span> <span class="o">::</span> <span class="n">tail</span> <span class="o">-&gt;</span> <span class="n">head</span> <span class="o">::</span> <span class="n">loop</span> <span class="o">(</span><span class="n">current</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">tail</span>
            <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="bp">[]</span> <span class="k">in</span>
        <span class="n">listref</span> <span class="o">:=</span> <span class="n">loop</span> <span class="mi">0</span> <span class="o">!</span><span class="n">listref</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">&quot;listref_delete&quot;</span>

<span class="k">let</span> <span class="n">listref_insert</span> <span class="n">listref</span> <span class="n">index</span> <span class="n">elt</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">index</span> <span class="k">with</span>
    <span class="o">|</span> <span class="o">`</span><span class="nc">Num</span> <span class="n">i</span> <span class="o">-&gt;</span>
        <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span> <span class="n">current</span> <span class="kt">list</span> <span class="o">=</span>
          <span class="k">match</span> <span class="kt">list</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">head</span> <span class="o">::</span> <span class="n">tail</span> <span class="k">when</span> <span class="n">current</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-&gt;</span>
                <span class="n">elt</span> <span class="o">::</span> <span class="n">head</span> <span class="o">::</span> <span class="n">loop</span> <span class="o">(</span><span class="n">current</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">tail</span>
            <span class="o">|</span> <span class="n">head</span> <span class="o">::</span> <span class="bp">[]</span> <span class="k">when</span> <span class="n">current</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-&gt;</span> <span class="n">head</span> <span class="o">::</span> <span class="o">[</span><span class="n">elt</span><span class="o">]</span>
            <span class="o">|</span> <span class="n">head</span> <span class="o">::</span> <span class="n">tail</span> <span class="o">-&gt;</span> <span class="n">head</span> <span class="o">::</span> <span class="n">loop</span> <span class="o">(</span><span class="n">current</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">tail</span>
            <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="bp">[]</span> <span class="k">in</span>
        <span class="n">listref</span> <span class="o">:=</span> <span class="n">loop</span> <span class="mi">0</span> <span class="o">!</span><span class="n">listref</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">&quot;listref_insert&quot;</span>

<span class="c">(* Use a line stream to produce a stream of POD chunks. *)</span>

<span class="k">let</span> <span class="n">line_stream_of_channel</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">channel</span><span class="o">)</span> <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="nc">None</span><span class="o">)</span>

<span class="k">let</span> <span class="n">pod_stream_of_channel</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">line_stream_of_channel</span> <span class="n">channel</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">is_head</span> <span class="n">s</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span> <span class="o">&gt;=</span> <span class="mi">6</span> <span class="o">&amp;&amp;</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">s</span> <span class="mi">0</span> <span class="mi">6</span> <span class="o">=</span> <span class="s2">&quot;=head1&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">next</span> <span class="n">pod_head</span> <span class="n">pod_lines</span> <span class="n">i</span> <span class="o">=</span>
    <span class="k">match</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">peek</span> <span class="n">lines</span><span class="o">,</span> <span class="n">pod_head</span><span class="o">,</span> <span class="n">pod_lines</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">None</span><span class="o">,</span> <span class="s2">&quot;&quot;</span><span class="o">,</span> <span class="o">_</span> <span class="o">-&gt;</span>
          <span class="c">(* EOF, no POD found, return EOF *)</span>
          <span class="nc">None</span>
      <span class="o">|</span> <span class="nc">None</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_</span> <span class="o">-&gt;</span>
          <span class="c">(* EOF, POD found, return POD *)</span>
          <span class="nc">Some</span> <span class="o">(</span><span class="n">pod_head</span><span class="o">,</span> <span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="n">pod_lines</span><span class="o">)</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">head</span><span class="o">,</span> <span class="s2">&quot;&quot;</span><span class="o">,</span> <span class="o">_</span> <span class="k">when</span> <span class="n">is_head</span> <span class="n">head</span> <span class="o">-&gt;</span>
          <span class="c">(* Head found *)</span>
          <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">lines</span><span class="o">;</span>
          <span class="n">next</span> <span class="n">head</span> <span class="bp">[]</span> <span class="n">i</span>
      <span class="o">|</span> <span class="o">_,</span> <span class="s2">&quot;&quot;</span><span class="o">,</span> <span class="o">_</span> <span class="o">-&gt;</span>
          <span class="c">(* No head found, keep looking *)</span>
          <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">lines</span><span class="o">;</span>
          <span class="n">next</span> <span class="s2">&quot;&quot;</span> <span class="bp">[]</span> <span class="n">i</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">head</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_</span> <span class="k">when</span> <span class="n">is_head</span> <span class="n">head</span> <span class="o">-&gt;</span>
          <span class="c">(* Next head found, return POD *)</span>
          <span class="nc">Some</span> <span class="o">(</span><span class="n">pod_head</span><span class="o">,</span> <span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="n">pod_lines</span><span class="o">)</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">line</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_</span> <span class="o">-&gt;</span>
          <span class="c">(* Line found, buffer and continue reading *)</span>
          <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">lines</span><span class="o">;</span>
          <span class="n">next</span> <span class="n">pod_head</span> <span class="o">(</span><span class="n">line</span> <span class="o">::</span> <span class="n">pod_lines</span><span class="o">)</span> <span class="n">i</span> <span class="k">in</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span> <span class="o">(</span><span class="n">next</span> <span class="s2">&quot;&quot;</span> <span class="bp">[]</span><span class="o">)</span>

<span class="c">(* Read the POD file into memory, and split it into sections. *)</span>

<span class="k">let</span> <span class="n">podfile</span> <span class="o">=</span>
  <span class="k">if</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="o">&lt;</span> <span class="mi">2</span>
  <span class="k">then</span> <span class="s2">&quot;-&quot;</span>
  <span class="k">else</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span>

<span class="k">let</span> <span class="n">sections</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span>

<span class="c">(* Turn !sections into a list of (text, head) pairs. *)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">channel</span> <span class="o">=</span> <span class="k">if</span> <span class="n">podfile</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span> <span class="k">then</span> <span class="n">stdin</span> <span class="k">else</span> <span class="n">open_in</span> <span class="n">podfile</span> <span class="k">in</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">head</span><span class="o">,</span> <span class="n">lines</span><span class="o">)</span> <span class="o">-&gt;</span>
       <span class="n">sections</span> <span class="o">:=</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">lines</span><span class="o">,</span> <span class="n">head</span><span class="o">)</span> <span class="o">::</span> <span class="o">!</span><span class="n">sections</span><span class="o">)</span>
    <span class="o">(</span><span class="n">pod_stream_of_channel</span> <span class="n">channel</span><span class="o">);</span>
  <span class="n">sections</span> <span class="o">:=</span> <span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="o">!</span><span class="n">sections</span><span class="o">;</span>
  <span class="n">close_in</span> <span class="n">channel</span>

<span class="c">(* Fire up Tk and display the list of sections. *)</span>
<span class="k">let</span> <span class="n">main</span> <span class="o">=</span> <span class="n">openTk</span> <span class="bp">()</span>
<span class="k">let</span> <span class="n">listbox</span> <span class="o">=</span> <span class="nn">Listbox</span><span class="p">.</span><span class="n">create</span> <span class="o">~</span><span class="n">width</span><span class="o">:</span><span class="mi">60</span> <span class="n">main</span>
<span class="k">let</span> <span class="n">dragging</span> <span class="o">=</span> <span class="n">ref</span> <span class="nc">None</span>

<span class="c">(* Singleton viewer instance. *)</span>
<span class="k">let</span> <span class="n">viewer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">viewer</span> <span class="n">main</span>

<span class="c">(* Called when the user clicks on an item in the Listbox. *)</span>
<span class="k">let</span> <span class="n">down</span> <span class="n">event</span> <span class="o">=</span>
  <span class="n">dragging</span> <span class="o">:=</span> <span class="nc">Some</span> <span class="o">(</span><span class="nn">Listbox</span><span class="p">.</span><span class="n">nearest</span> <span class="n">listbox</span> <span class="n">event</span><span class="o">.</span><span class="n">ev_MouseY</span><span class="o">)</span>

<span class="c">(* Called when the user releases the mouse button in the Listbox. *)</span>
<span class="k">let</span> <span class="n">up</span> <span class="n">event</span> <span class="o">=</span>
  <span class="n">dragging</span> <span class="o">:=</span> <span class="nc">None</span>

<span class="c">(* Called when the user moves the mouse in the Listbox. *)</span>
<span class="k">let</span> <span class="n">move</span> <span class="n">event</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">dest</span> <span class="o">=</span> <span class="nn">Listbox</span><span class="p">.</span><span class="n">nearest</span> <span class="n">listbox</span> <span class="n">event</span><span class="o">.</span><span class="n">ev_MouseY</span> <span class="k">in</span>
  <span class="k">match</span> <span class="o">!</span><span class="n">dragging</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">Some</span> <span class="n">src</span> <span class="k">when</span> <span class="n">src</span> <span class="o">&lt;&gt;</span> <span class="n">dest</span> <span class="o">-&gt;</span>
        <span class="k">let</span> <span class="n">elt</span> <span class="o">=</span> <span class="n">listref_get</span> <span class="n">sections</span> <span class="n">src</span> <span class="k">in</span>
        <span class="n">listref_delete</span> <span class="n">sections</span> <span class="n">src</span><span class="o">;</span>
        <span class="n">listref_insert</span> <span class="n">sections</span> <span class="n">dest</span> <span class="n">elt</span><span class="o">;</span>
        <span class="k">let</span> <span class="n">elt</span> <span class="o">=</span> <span class="nn">Listbox</span><span class="p">.</span><span class="n">get</span> <span class="n">listbox</span> <span class="n">src</span> <span class="k">in</span>
        <span class="nn">Listbox</span><span class="p">.</span><span class="n">delete</span> <span class="n">listbox</span> <span class="o">~</span><span class="n">first</span><span class="o">:</span><span class="n">src</span> <span class="o">~</span><span class="n">last</span><span class="o">:</span><span class="n">src</span><span class="o">;</span>
        <span class="nn">Listbox</span><span class="p">.</span><span class="n">insert</span> <span class="n">listbox</span> <span class="o">~</span><span class="n">index</span><span class="o">:</span><span class="n">dest</span> <span class="o">~</span><span class="n">texts</span><span class="o">:[</span><span class="n">elt</span><span class="o">];</span>
        <span class="n">dragging</span> <span class="o">:=</span> <span class="nc">Some</span> <span class="n">dest</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span>

<span class="c">(* Called to save the list of sections. *)</span>
<span class="k">let</span> <span class="n">save</span> <span class="n">event</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">channel</span> <span class="o">=</span> <span class="k">if</span> <span class="n">podfile</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span> <span class="k">then</span> <span class="n">stdout</span> <span class="k">else</span> <span class="n">open_out</span> <span class="n">podfile</span> <span class="k">in</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">text</span><span class="o">,</span> <span class="n">head</span><span class="o">)</span> <span class="o">-&gt;</span>
       <span class="n">output_string</span> <span class="n">channel</span> <span class="n">head</span><span class="o">;</span>
       <span class="n">output_string</span> <span class="n">channel</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
       <span class="n">output_string</span> <span class="n">channel</span> <span class="n">text</span><span class="o">;</span>
       <span class="n">output_string</span> <span class="n">channel</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
       <span class="n">flush</span> <span class="n">channel</span><span class="o">)</span>
    <span class="o">!</span><span class="n">sections</span><span class="o">;</span>
  <span class="k">if</span> <span class="n">podfile</span> <span class="o">&lt;&gt;</span> <span class="s2">&quot;-&quot;</span> <span class="k">then</span> <span class="n">close_out</span> <span class="n">channel</span>

<span class="c">(* Called to display the widget.  Uses the viewer widget. *)</span>
<span class="k">let</span> <span class="n">view</span> <span class="n">event</span> <span class="o">=</span>
  <span class="n">dragging</span> <span class="o">:=</span> <span class="nc">None</span><span class="o">;</span> <span class="c">(* cancel drag *)</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">(`</span><span class="nc">Num</span> <span class="n">i</span><span class="o">)</span> <span class="o">-&gt;</span>
       <span class="k">let</span> <span class="o">(</span><span class="n">text</span><span class="o">,</span> <span class="n">head</span><span class="o">)</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">nth</span> <span class="o">!</span><span class="n">sections</span> <span class="n">i</span> <span class="k">in</span>
       <span class="n">viewer</span><span class="o">#</span><span class="n">set_title</span> <span class="n">head</span><span class="o">;</span>
       <span class="n">viewer</span><span class="o">#</span><span class="n">set_body</span> <span class="o">(</span><span class="n">head</span> <span class="o">^</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">^</span> <span class="n">text</span><span class="o">);</span>
       <span class="n">viewer</span><span class="o">#</span><span class="n">show</span> <span class="bp">()</span><span class="o">)</span>
    <span class="o">(</span><span class="nn">Listbox</span><span class="p">.</span><span class="n">curselection</span> <span class="n">listbox</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">pack</span> <span class="o">~</span><span class="n">expand</span><span class="o">:</span><span class="bp">true</span> <span class="o">~</span><span class="n">fill</span><span class="o">:`</span><span class="nc">Both</span> <span class="o">[</span><span class="n">listbox</span><span class="o">];</span>

  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">text</span><span class="o">,</span> <span class="n">title</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nn">Listbox</span><span class="p">.</span><span class="n">insert</span> <span class="n">listbox</span> <span class="o">`</span><span class="nc">End</span> <span class="o">[</span><span class="n">title</span><span class="o">])</span>
    <span class="o">!</span><span class="n">sections</span><span class="o">;</span>

  <span class="c">(* Permit dragging by binding to the Listbox widget. *)</span>
  <span class="n">bind</span> <span class="o">~</span><span class="n">events</span><span class="o">:[`</span><span class="nc">ButtonPress</span><span class="o">]</span> <span class="o">~</span><span class="n">fields</span><span class="o">:[`</span><span class="nc">MouseY</span><span class="o">]</span> <span class="o">~</span><span class="n">action</span><span class="o">:</span><span class="n">down</span> <span class="n">listbox</span><span class="o">;</span>
  <span class="n">bind</span> <span class="o">~</span><span class="n">events</span><span class="o">:[`</span><span class="nc">ButtonRelease</span><span class="o">]</span> <span class="o">~</span><span class="n">action</span><span class="o">:</span><span class="n">up</span> <span class="n">listbox</span><span class="o">;</span>
  <span class="n">bind</span> <span class="o">~</span><span class="n">events</span><span class="o">:[`</span><span class="nc">Motion</span><span class="o">]</span> <span class="o">~</span><span class="n">fields</span><span class="o">:[`</span><span class="nc">MouseY</span><span class="o">]</span> <span class="o">~</span><span class="n">action</span><span class="o">:</span><span class="n">move</span> <span class="n">listbox</span><span class="o">;</span>

  <span class="c">(* Permit viewing by binding double-click. *)</span>
  <span class="n">bind</span> <span class="o">~</span><span class="n">events</span><span class="o">:[`</span><span class="nc">Modified</span> <span class="o">([`</span><span class="nc">Double</span><span class="o">],</span> <span class="o">`</span><span class="nc">ButtonRelease</span><span class="o">)]</span> <span class="o">~</span><span class="n">action</span><span class="o">:</span><span class="n">view</span> <span class="n">listbox</span><span class="o">;</span>

  <span class="c">(* &#39;q&#39; quits and &#39;s&#39; saves *)</span>
  <span class="n">bind</span> <span class="o">~</span><span class="n">events</span><span class="o">:[`</span><span class="nc">KeyPressDetail</span> <span class="s2">&quot;s&quot;</span><span class="o">]</span> <span class="o">~</span><span class="n">action</span><span class="o">:</span><span class="n">save</span> <span class="n">main</span><span class="o">;</span>
  <span class="n">bind</span> <span class="o">~</span><span class="n">events</span><span class="o">:[`</span><span class="nc">KeyPressDetail</span> <span class="s2">&quot;q&quot;</span><span class="o">]</span> <span class="o">~</span><span class="n">action</span><span class="o">:(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">exit</span> <span class="mi">0</span><span class="o">)</span> <span class="n">main</span><span class="o">;</span>

  <span class="nn">Printexc</span><span class="p">.</span><span class="n">print</span> <span class="n">mainLoop</span> <span class="bp">()</span></PRE
></TD
></TR
></TABLE
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="dbaccess.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="processmanagementetc.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Database Access</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
>&nbsp;</TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Process Management and Communication</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>
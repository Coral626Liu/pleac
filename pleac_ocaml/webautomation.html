<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN""http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>Web Automation</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="PLEAC-Objective CAML "
HREF="index.html"><LINK
REL="PREVIOUS"
TITLE="CGI Programming"
HREF="cgiprogramming.html"><LINK
REL="NEXT"
TITLE="Helpers"
HREF="a1102.html"><style type="text/css">td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
pre { line-height: 125%; }

  </style></head
><BODY TEXT="#cecece" BGCOLOR="#4f6f6f" LINK="#f5deb3" VLINK="#d5ae83"
CLASS="SECT1"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>PLEAC-Objective CAML </TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="cgiprogramming.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
></TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="a1102.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="WEBAUTOMATION"
>20. Web Automation</A
></H1
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1054"
>Introduction</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* Libraries for HTTP clients and servers are listed at The Caml Hump: *)</span>
<span class="n">http</span><span class="o">://</span><span class="n">caml</span><span class="o">.</span><span class="n">inria</span><span class="o">.</span><span class="n">fr</span><span class="o">/</span><span class="n">cgi</span><span class="o">-</span><span class="n">bin</span><span class="o">/</span><span class="n">hump</span><span class="o">.</span><span class="n">en</span><span class="o">.</span><span class="n">cgi</span><span class="o">?</span><span class="n">browse</span><span class="o">=</span><span class="mi">40</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1057"
>Fetching a URL from a Perl Script</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* If you just want to read a URL as a string, Ocamlnet&#39;s &quot;Convenience&quot;</span>
<span class="c">   interface to Http_client is as easy as it gets. For the more powerful</span>
<span class="c">   general interface to Http_client, see the next example. *)</span>
<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netclient&quot;</span><span class="o">;;</span>
<span class="k">open</span> <span class="nn">Http_client</span><span class="p">.</span><span class="nc">Convenience</span>
<span class="k">let</span> <span class="n">content</span> <span class="o">=</span> <span class="n">http_get</span> <span class="n">url</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* titlebytes - find the title and size of documents  *)</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;str&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netclient&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">raw_url</span> <span class="o">=</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span>
<span class="k">let</span> <span class="n">url</span> <span class="o">=</span> <span class="nn">Neturl</span><span class="p">.</span><span class="n">parse_url</span> <span class="n">raw_url</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s =&gt;</span><span class="se">\n\t</span><span class="s2">%!&quot;</span> <span class="o">(</span><span class="nn">Neturl</span><span class="p">.</span><span class="n">string_of_url</span> <span class="n">url</span><span class="o">);</span>
  <span class="k">let</span> <span class="n">call</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Http_client</span><span class="p">.</span><span class="n">get</span> <span class="o">(</span><span class="nn">Neturl</span><span class="p">.</span><span class="n">string_of_url</span> <span class="n">url</span><span class="o">)</span> <span class="k">in</span>
  <span class="n">call</span><span class="o">#</span><span class="n">set_req_header</span> <span class="s2">&quot;User-Agent&quot;</span> <span class="s2">&quot;Schmozilla/v9.14 Platinum&quot;</span><span class="o">;</span>
  <span class="n">call</span><span class="o">#</span><span class="n">set_req_header</span> <span class="s2">&quot;Referer&quot;</span> <span class="s2">&quot;http://wizard.yellowbrick.oz&quot;</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Http_client</span><span class="p">.</span><span class="n">pipeline</span> <span class="k">in</span>
  <span class="n">pipeline</span><span class="o">#</span><span class="n">add</span> <span class="n">call</span><span class="o">;</span>
  <span class="n">pipeline</span><span class="o">#</span><span class="n">run</span> <span class="bp">()</span><span class="o">;</span>
  <span class="k">match</span> <span class="n">call</span><span class="o">#</span><span class="n">status</span> <span class="k">with</span>
    <span class="o">|</span> <span class="o">`</span><span class="nc">Successful</span> <span class="o">-&gt;</span>
        <span class="k">let</span> <span class="n">content</span> <span class="o">=</span> <span class="n">call</span><span class="o">#</span><span class="n">get_resp_body</span> <span class="bp">()</span> <span class="k">in</span>
        <span class="k">let</span> <span class="n">bytes</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">content</span> <span class="k">in</span>
        <span class="k">let</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
        <span class="nn">String</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">function</span> <span class="sc">&#39;\n&#39;</span> <span class="o">-&gt;</span> <span class="n">incr</span> <span class="n">count</span> <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">)</span> <span class="n">content</span><span class="o">;</span>
        <span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span>
          <span class="nn">Str</span><span class="p">.</span><span class="n">regexp_case_fold</span> <span class="s2">&quot;.*&lt;title&gt;</span><span class="se">\\</span><span class="s2">([^&lt;]*</span><span class="se">\\</span><span class="s2">)&lt;/title&gt;.*&quot;</span> <span class="k">in</span>
        <span class="k">let</span> <span class="n">title</span> <span class="o">=</span>
          <span class="k">try</span> <span class="o">(</span><span class="n">ignore</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span> <span class="n">regexp</span> <span class="n">content</span> <span class="mi">0</span><span class="o">);</span>
               <span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">1</span> <span class="n">content</span><span class="o">)</span>
          <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="s2">&quot;(untitled)&quot;</span> <span class="k">in</span>
        <span class="k">let</span> <span class="n">title</span> <span class="o">=</span>
          <span class="nn">Str</span><span class="p">.</span><span class="n">global_replace</span>
            <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">(^[</span><span class="se">\n\r\t</span><span class="s2"> ]+</span><span class="se">\\</span><span class="s2">)</span><span class="se">\\</span><span class="s2">|</span><span class="se">\\</span><span class="s2">([</span><span class="se">\n\r\t</span><span class="s2"> ]+$</span><span class="se">\\</span><span class="s2">)&quot;</span><span class="o">)</span> <span class="s2">&quot;&quot;</span>
            <span class="n">title</span> <span class="k">in</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s (%d lines, %d bytes)</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">title</span> <span class="o">!</span><span class="n">count</span> <span class="n">bytes</span>
    <span class="o">|</span> <span class="o">`</span><span class="nc">Client_error</span> <span class="o">-&gt;</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Client error: %d %s</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="n">call</span><span class="o">#</span><span class="n">response_status_code</span>
          <span class="n">call</span><span class="o">#</span><span class="n">response_status_text</span>
    <span class="o">|</span> <span class="o">`</span><span class="nc">Http_protocol_error</span> <span class="n">e</span> <span class="o">-&gt;</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;HTTP protocol error: %s</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="o">(</span><span class="nn">Printexc</span><span class="p">.</span><span class="n">to_string</span> <span class="n">e</span><span class="o">)</span>
    <span class="o">|</span> <span class="o">`</span><span class="nc">Redirection</span> <span class="o">-&gt;</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Redirection</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="o">|</span> <span class="o">`</span><span class="nc">Server_error</span> <span class="o">-&gt;</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Server error</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="o">|</span> <span class="o">`</span><span class="nc">Unserved</span> <span class="o">-&gt;</span>
        <span class="k">assert</span> <span class="bp">false</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1060"
>Automating Form Submission</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netclient&quot;</span><span class="o">;;</span>
<span class="k">open</span> <span class="nn">Http_client</span><span class="p">.</span><span class="nc">Convenience</span>

<span class="c">(* Submit a form using GET. *)</span>
<span class="k">let</span> <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://www.perl.com/cgi-bin/cpan_mod?module=DB_File&amp;readme=1&quot;</span>
<span class="k">let</span> <span class="n">content</span> <span class="o">=</span> <span class="n">http_get</span> <span class="n">url</span>

<span class="c">(* Submit a form using POST. Since we need to follow a redirect here,</span>
<span class="c">   we can&#39;t use the &quot;Convenience&quot; methods. *)</span>
<span class="k">let</span> <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://www.perl.com/cgi-bin/cpan_mod&quot;</span>
<span class="k">let</span> <span class="n">params</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;module&quot;</span><span class="o">,</span> <span class="s2">&quot;DB_File&quot;</span><span class="o">;</span> <span class="s2">&quot;readme&quot;</span><span class="o">,</span> <span class="s2">&quot;1&quot;</span><span class="o">]</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">call</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Http_client</span><span class="p">.</span><span class="n">post</span> <span class="n">url</span> <span class="n">params</span> <span class="k">in</span>
  <span class="n">call</span><span class="o">#</span><span class="n">set_redirect_mode</span> <span class="nn">Http_client</span><span class="p">.</span><span class="nc">Redirect</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Http_client</span><span class="p">.</span><span class="n">pipeline</span> <span class="k">in</span>
  <span class="n">pipeline</span><span class="o">#</span><span class="n">add</span> <span class="n">call</span><span class="o">;</span>
  <span class="n">pipeline</span><span class="o">#</span><span class="n">run</span> <span class="bp">()</span>
<span class="k">let</span> <span class="n">content</span> <span class="o">=</span> <span class="n">call</span><span class="o">#</span><span class="n">response_body</span><span class="o">#</span><span class="k">value</span>

<span class="c">(* GET parameters can be URL encoded with Netencoding.Url.encode. *)</span>
<span class="k">let</span> <span class="n">arg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">this isn&#39;t &lt;EASY&gt; &amp; &lt;FUN&gt;</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
<span class="nn">Netencoding</span><span class="p">.</span><span class="nn">Url</span><span class="p">.</span><span class="n">encode</span> <span class="n">arg</span>
<span class="c">(* - : string = &quot;%22this+isn%27t+%3CEASY%3E+%26+%3CFUN%3E%22&quot; *)</span>
<span class="nn">Netencoding</span><span class="p">.</span><span class="nn">Url</span><span class="p">.</span><span class="n">encode</span> <span class="o">~</span><span class="n">plus</span><span class="o">:</span><span class="bp">false</span> <span class="n">arg</span>
<span class="c">(* - : string = &quot;%22this%20isn%27t%20%3CEASY%3E%20%26%20%3CFUN%3E%22&quot; *)</span>

<span class="c">(* To use a proxy, either set the &quot;http_proxy&quot; environment variable and</span>
<span class="c">   call &quot;set_proxy_from_environment&quot; on the pipeline (done automatically</span>
<span class="c">   for the &quot;Convenience&quot; methods) or set the proxy host and port using</span>
<span class="c">   the &quot;set_proxy&quot; method: *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">#</span><span class="n">set_proxy</span> <span class="s2">&quot;localhost&quot;</span> <span class="mi">3128</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1063"
>Extracting URLs</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* The Nethtml library, part of Ocamlnet, can parse arbitrary HTML from</span>
<span class="c">   files and web pages. *)</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netstring&quot;</span><span class="o">;;</span>

<span class="k">open</span> <span class="nc">Nethtml</span>

<span class="c">(* Define a function to walk through all the elements in a document and</span>
<span class="c">   accumulate the results of a user-supplied function for each element.</span>
<span class="c">   This is known as a &quot;fold&quot; in functional programming. *)</span>
<span class="k">let</span> <span class="k">rec</span> <span class="n">fold_elements</span> <span class="n">f</span> <span class="n">accu</span> <span class="o">=</span> <span class="k">function</span>
  <span class="o">|</span> <span class="nc">Element</span> <span class="o">(_,</span> <span class="o">_,</span> <span class="n">children</span><span class="o">)</span> <span class="k">as</span> <span class="n">element</span> <span class="o">-&gt;</span>
      <span class="k">let</span> <span class="n">accu</span> <span class="o">=</span>
        <span class="nn">List</span><span class="p">.</span><span class="n">fold_right</span>
          <span class="o">(</span><span class="k">fun</span> <span class="n">child</span> <span class="n">accu</span> <span class="o">-&gt;</span>
             <span class="n">fold_elements</span> <span class="n">f</span> <span class="n">accu</span> <span class="n">child</span><span class="o">)</span>
          <span class="n">children</span>
          <span class="n">accu</span> <span class="k">in</span>
      <span class="n">f</span> <span class="n">accu</span> <span class="n">element</span>
  <span class="o">|</span> <span class="n">other</span> <span class="o">-&gt;</span> <span class="n">accu</span>

<span class="c">(* Define a type for links so we can tell anchors and images apart. *)</span>
<span class="k">type</span> <span class="n">link</span> <span class="o">=</span> <span class="nc">A</span> <span class="k">of</span> <span class="kt">string</span> <span class="o">|</span> <span class="nc">IMG</span> <span class="k">of</span> <span class="kt">string</span>

<span class="c">(* Using fold_elements, define a function that collects the URLs from</span>
<span class="c">   all the &quot;a&quot; and &quot;img&quot; tags. *)</span>
<span class="k">let</span> <span class="n">find_links</span> <span class="n">elements</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">flatten</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span>
       <span class="o">(</span><span class="n">fold_elements</span>
          <span class="o">(</span><span class="k">fun</span> <span class="n">accu</span> <span class="n">element</span> <span class="o">-&gt;</span>
             <span class="k">match</span> <span class="n">element</span> <span class="k">with</span>
               <span class="o">|</span> <span class="nc">Element</span> <span class="o">(</span><span class="s2">&quot;a&quot;</span><span class="o">,</span> <span class="n">attribs</span><span class="o">,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
                   <span class="o">(</span><span class="k">try</span> <span class="nc">A</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">assoc</span> <span class="s2">&quot;href&quot;</span> <span class="n">attribs</span><span class="o">)</span> <span class="o">::</span> <span class="n">accu</span>
                    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="n">accu</span><span class="o">)</span>
               <span class="o">|</span> <span class="nc">Element</span> <span class="o">(</span><span class="s2">&quot;img&quot;</span><span class="o">,</span> <span class="n">attribs</span><span class="o">,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
                   <span class="o">(</span><span class="k">try</span> <span class="nc">IMG</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">assoc</span> <span class="s2">&quot;src&quot;</span> <span class="n">attribs</span><span class="o">)</span> <span class="o">::</span> <span class="n">accu</span>
                    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="n">accu</span><span class="o">)</span>
               <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">accu</span><span class="o">)</span>
          <span class="bp">[]</span><span class="o">)</span>
       <span class="n">elements</span><span class="o">)</span>

<span class="c">(* Parse an HTML file. *)</span>
<span class="k">let</span> <span class="n">elements</span> <span class="o">=</span> <span class="n">parse</span> <span class="o">(</span><span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">input_channel</span> <span class="o">(</span><span class="n">open_in</span> <span class="n">filename</span><span class="o">))</span>

<span class="c">(* Print the links we found. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">function</span>
       <span class="o">|</span> <span class="nc">A</span> <span class="n">href</span> <span class="o">-&gt;</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;ANCHOR: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">href</span>
       <span class="o">|</span> <span class="nc">IMG</span> <span class="n">src</span> <span class="o">-&gt;</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;IMAGE: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">src</span><span class="o">)</span>
    <span class="o">(</span><span class="n">find_links</span> <span class="n">elements</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* xurl - extract unique, sorted list of links from URL *)</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netclient&quot;</span><span class="o">;;</span>

<span class="k">open</span> <span class="nn">Http_client</span><span class="p">.</span><span class="nc">Convenience</span>
<span class="k">open</span> <span class="nc">Nethtml</span>

<span class="k">let</span> <span class="k">rec</span> <span class="n">fold_elements</span> <span class="n">f</span> <span class="n">accu</span> <span class="o">=</span> <span class="k">function</span>
  <span class="o">|</span> <span class="nc">Element</span> <span class="o">(_,</span> <span class="o">_,</span> <span class="n">children</span><span class="o">)</span> <span class="k">as</span> <span class="n">element</span> <span class="o">-&gt;</span>
      <span class="k">let</span> <span class="n">accu</span> <span class="o">=</span>
        <span class="nn">List</span><span class="p">.</span><span class="n">fold_right</span>
          <span class="o">(</span><span class="k">fun</span> <span class="n">child</span> <span class="n">accu</span> <span class="o">-&gt;</span>
             <span class="n">fold_elements</span> <span class="n">f</span> <span class="n">accu</span> <span class="n">child</span><span class="o">)</span>
          <span class="n">children</span>
          <span class="n">accu</span> <span class="k">in</span>
      <span class="n">f</span> <span class="n">accu</span> <span class="n">element</span>
  <span class="o">|</span> <span class="n">other</span> <span class="o">-&gt;</span> <span class="n">accu</span>

<span class="k">type</span> <span class="n">link</span> <span class="o">=</span> <span class="nc">A</span> <span class="k">of</span> <span class="kt">string</span> <span class="o">|</span> <span class="nc">IMG</span> <span class="k">of</span> <span class="kt">string</span>

<span class="k">let</span> <span class="n">find_links</span> <span class="n">elements</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">flatten</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span>
       <span class="o">(</span><span class="n">fold_elements</span>
          <span class="o">(</span><span class="k">fun</span> <span class="n">accu</span> <span class="n">element</span> <span class="o">-&gt;</span>
             <span class="k">match</span> <span class="n">element</span> <span class="k">with</span>
               <span class="o">|</span> <span class="nc">Element</span> <span class="o">(</span><span class="s2">&quot;a&quot;</span><span class="o">,</span> <span class="n">attribs</span><span class="o">,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
                   <span class="o">(</span><span class="k">try</span> <span class="nc">A</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">assoc</span> <span class="s2">&quot;href&quot;</span> <span class="n">attribs</span><span class="o">)</span> <span class="o">::</span> <span class="n">accu</span>
                    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="n">accu</span><span class="o">)</span>
               <span class="o">|</span> <span class="nc">Element</span> <span class="o">(</span><span class="s2">&quot;img&quot;</span><span class="o">,</span> <span class="n">attribs</span><span class="o">,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
                   <span class="o">(</span><span class="k">try</span> <span class="nc">IMG</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">assoc</span> <span class="s2">&quot;src&quot;</span> <span class="n">attribs</span><span class="o">)</span> <span class="o">::</span> <span class="n">accu</span>
                    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="n">accu</span><span class="o">)</span>
               <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">accu</span><span class="o">)</span>
          <span class="bp">[]</span><span class="o">)</span>
       <span class="n">elements</span><span class="o">)</span>

<span class="k">let</span> <span class="n">base_url</span> <span class="o">=</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span>
<span class="k">let</span> <span class="n">elements</span> <span class="o">=</span> <span class="n">parse</span> <span class="o">(</span><span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">input_string</span> <span class="o">(</span><span class="n">http_get</span> <span class="n">base_url</span><span class="o">))</span>
<span class="k">let</span> <span class="n">url_syntax</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="nn">Neturl</span><span class="p">.</span><span class="n">common_url_syntax</span> <span class="s2">&quot;http&quot;</span>
<span class="k">let</span> <span class="n">url_syntax</span> <span class="o">=</span>
  <span class="o">{</span><span class="n">url_syntax</span> <span class="k">with</span>
     <span class="nn">Neturl</span><span class="p">.</span><span class="n">url_enable_fragment</span> <span class="o">=</span> <span class="nn">Neturl</span><span class="p">.</span><span class="nc">Url_part_allowed</span><span class="o">}</span>
<span class="k">let</span> <span class="n">url_syntax</span> <span class="o">=</span> <span class="nn">Neturl</span><span class="p">.</span><span class="n">partial_url_syntax</span> <span class="n">url_syntax</span>

<span class="k">module</span> <span class="nc">StringSet</span> <span class="o">=</span> <span class="nn">Set</span><span class="p">.</span><span class="nc">Make</span><span class="o">(</span><span class="nc">String</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">StringSet</span><span class="p">.</span><span class="n">iter</span> <span class="n">print_endline</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">fold_left</span>
       <span class="o">(</span><span class="k">fun</span> <span class="n">accu</span> <span class="n">s</span> <span class="o">-&gt;</span>
          <span class="k">try</span>
            <span class="nn">StringSet</span><span class="p">.</span><span class="n">add</span>
              <span class="o">(</span><span class="nn">Neturl</span><span class="p">.</span><span class="n">string_of_url</span>
                 <span class="o">(</span><span class="nn">Neturl</span><span class="p">.</span><span class="n">apply_relative_url</span>
                    <span class="o">(</span><span class="nn">Neturl</span><span class="p">.</span><span class="n">url_of_string</span> <span class="n">url_syntax</span> <span class="n">base_url</span><span class="o">)</span>
                    <span class="o">(</span><span class="nn">Neturl</span><span class="p">.</span><span class="n">url_of_string</span> <span class="n">url_syntax</span> <span class="n">s</span><span class="o">)))</span>
              <span class="n">accu</span>
          <span class="k">with</span> <span class="nn">Neturl</span><span class="p">.</span><span class="nc">Malformed_URL</span> <span class="o">-&gt;</span>
            <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Malformed URL: %s</span><span class="se">\n</span><span class="s2">%!&quot;</span> <span class="n">s</span><span class="o">;</span>
            <span class="n">accu</span><span class="o">)</span>
       <span class="nn">StringSet</span><span class="p">.</span><span class="n">empty</span>
       <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span>
          <span class="o">(</span><span class="k">function</span>
             <span class="o">|</span> <span class="nc">A</span> <span class="n">href</span> <span class="o">-&gt;</span> <span class="n">href</span>
             <span class="o">|</span> <span class="nc">IMG</span> <span class="n">src</span> <span class="o">-&gt;</span> <span class="n">src</span><span class="o">)</span>
          <span class="o">(</span><span class="n">find_links</span> <span class="n">elements</span><span class="o">)))</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1066"
>Converting ASCII to HTML</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* text2html - trivial html encoding of normal text *)</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;str&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netstring&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">line_stream_of_channel</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">channel</span><span class="o">)</span> <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="nc">None</span><span class="o">)</span>

<span class="k">let</span> <span class="n">paragraph_stream_of_channel</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">line_stream_of_channel</span> <span class="n">channel</span> <span class="k">in</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">next</span> <span class="n">para_lines</span> <span class="n">i</span> <span class="o">=</span>
    <span class="k">match</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">peek</span> <span class="n">lines</span><span class="o">,</span> <span class="n">para_lines</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">None</span><span class="o">,</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="nc">None</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="s2">&quot;&quot;</span><span class="o">,</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">lines</span><span class="o">;</span> <span class="n">next</span> <span class="n">para_lines</span> <span class="n">i</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="s2">&quot;&quot;</span><span class="o">,</span> <span class="o">_</span>
      <span class="o">|</span> <span class="nc">None</span><span class="o">,</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nc">Some</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="n">para_lines</span><span class="o">))</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">line</span><span class="o">,</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">lines</span><span class="o">;</span> <span class="n">next</span> <span class="o">(</span><span class="n">line</span> <span class="o">::</span> <span class="n">para_lines</span><span class="o">)</span> <span class="n">i</span> <span class="k">in</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span> <span class="o">(</span><span class="n">next</span> <span class="bp">[]</span><span class="o">)</span>

<span class="k">let</span> <span class="n">chop</span> <span class="n">s</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">then</span> <span class="n">s</span> <span class="k">else</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">s</span> <span class="mi">0</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);;</span>

<span class="k">let</span> <span class="n">substitutions</span> <span class="o">=</span>
  <span class="o">[</span>
    <span class="c">(* embedded URL (good) or guessed URL (bad) *)</span>
    <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">(&lt;URL:[^&gt;]+&gt;</span><span class="se">\\</span><span class="s2">)</span><span class="se">\\</span><span class="s2">|</span><span class="se">\\</span><span class="s2">(http:[^ </span><span class="se">\n\r\t</span><span class="s2">]+</span><span class="se">\\</span><span class="s2">)&quot;</span><span class="o">,</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">s</span> <span class="o">-&gt;</span>
       <span class="k">let</span> <span class="n">s</span> <span class="o">=</span>
         <span class="k">if</span> <span class="n">s</span><span class="o">.[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="sc">&#39;&lt;&#39;</span>
         <span class="k">then</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">s</span> <span class="mi">5</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span> <span class="o">-</span> <span class="mi">6</span><span class="o">)</span>
         <span class="k">else</span> <span class="n">s</span> <span class="k">in</span>
       <span class="o">[</span><span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span> <span class="o">(</span><span class="s2">&quot;a&quot;</span><span class="o">,</span> <span class="o">[</span><span class="s2">&quot;href&quot;</span><span class="o">,</span> <span class="n">s</span><span class="o">],</span> <span class="o">[</span><span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="n">s</span><span class="o">])]);</span>

    <span class="c">(* this is *bold* here *)</span>
    <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">*[^*]+</span><span class="se">\\</span><span class="s2">*&quot;</span><span class="o">,</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="o">[</span><span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span> <span class="o">(</span><span class="s2">&quot;strong&quot;</span><span class="o">,</span> <span class="bp">[]</span><span class="o">,</span> <span class="o">[</span><span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="n">s</span><span class="o">])]);</span>

    <span class="c">(* this is _italics_ here *)</span>
    <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;_[^ _]+_&quot;</span><span class="o">,</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="o">[</span><span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span> <span class="o">(</span><span class="s2">&quot;em&quot;</span><span class="o">,</span> <span class="bp">[]</span><span class="o">,</span> <span class="o">[</span><span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="n">s</span><span class="o">])]);</span>
  <span class="o">]</span>

<span class="k">let</span> <span class="n">substitute</span> <span class="n">regexp</span> <span class="n">func</span> <span class="n">data</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">flatten</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span>
       <span class="o">(</span><span class="k">function</span>
          <span class="o">|</span> <span class="nn">Str</span><span class="p">.</span><span class="nc">Text</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="o">[</span><span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="n">s</span><span class="o">]</span>
          <span class="o">|</span> <span class="nn">Str</span><span class="p">.</span><span class="nc">Delim</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">func</span> <span class="n">s</span><span class="o">)</span>
       <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">full_split</span> <span class="n">regexp</span> <span class="n">data</span><span class="o">))</span>

<span class="k">let</span> <span class="k">rec</span> <span class="n">map_data</span> <span class="n">f</span> <span class="kt">list</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">flatten</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span>
       <span class="o">(</span><span class="k">function</span>
          <span class="o">|</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="n">data</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">data</span>
          <span class="o">|</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span> <span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">attrs</span><span class="o">,</span> <span class="n">children</span><span class="o">)</span> <span class="o">-&gt;</span>
              <span class="o">[</span><span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span> <span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">attrs</span><span class="o">,</span> <span class="n">map_data</span> <span class="n">f</span> <span class="n">children</span><span class="o">)])</span>
       <span class="kt">list</span><span class="o">)</span>

<span class="k">let</span> <span class="n">text2html</span> <span class="n">text</span> <span class="o">=</span>
  <span class="c">(* Create the initial HTML tree. *)</span>
  <span class="k">let</span> <span class="n">html</span> <span class="o">=</span> <span class="o">[</span><span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="n">text</span><span class="o">]</span> <span class="k">in</span>

  <span class="c">(* Split text into lines. *)</span>
  <span class="k">let</span> <span class="n">html</span> <span class="o">=</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">flatten</span>
      <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span>
         <span class="o">(</span><span class="k">function</span>
            <span class="o">|</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="n">data</span> <span class="o">-&gt;</span>
                <span class="nn">List</span><span class="p">.</span><span class="n">map</span>
                  <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="o">(</span><span class="n">line</span> <span class="o">^</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">))</span>
                  <span class="o">(</span><span class="s2">&quot;&quot;</span> <span class="o">::</span> <span class="nn">Str</span><span class="p">.</span><span class="n">split</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span> <span class="n">data</span><span class="o">)</span>
            <span class="o">|</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span> <span class="o">_</span> <span class="k">as</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="o">[</span><span class="n">e</span><span class="o">])</span>
         <span class="n">html</span><span class="o">)</span> <span class="k">in</span>

  <span class="c">(* Perform inline substitutions. *)</span>
  <span class="k">let</span> <span class="n">html</span> <span class="o">=</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">fold_right</span>
      <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">regexp</span><span class="o">,</span> <span class="n">func</span><span class="o">)</span> <span class="o">-&gt;</span>
         <span class="n">map_data</span> <span class="o">(</span><span class="n">substitute</span> <span class="n">regexp</span> <span class="n">func</span><span class="o">))</span>
      <span class="n">substitutions</span>
      <span class="n">html</span> <span class="k">in</span>

  <span class="c">(* Add line breaks to quoted text. *)</span>
  <span class="k">let</span> <span class="n">html</span> <span class="o">=</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">flatten</span>
      <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span>
         <span class="o">(</span><span class="k">function</span>
            <span class="o">|</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="n">line</span> <span class="k">when</span> <span class="n">line</span><span class="o">.[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="sc">&#39;&gt;&#39;</span> <span class="o">-&gt;</span>
                <span class="o">[</span><span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="o">(</span><span class="n">chop</span> <span class="n">line</span><span class="o">);</span>
                 <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span> <span class="o">(</span><span class="s2">&quot;br&quot;</span><span class="o">,</span> <span class="bp">[]</span><span class="o">,</span> <span class="bp">[]</span><span class="o">);</span>
                 <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">]</span>
            <span class="o">|</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="n">line</span> <span class="o">-&gt;</span> <span class="o">[</span><span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="n">line</span><span class="o">]</span>
            <span class="o">|</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span> <span class="o">_</span> <span class="k">as</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="o">[</span><span class="n">e</span><span class="o">])</span>
         <span class="n">html</span><span class="o">)</span> <span class="k">in</span>

  <span class="c">(* Return the finished document. *)</span>
  <span class="n">html</span>

<span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span>
<span class="k">let</span> <span class="n">channel</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">output_buffer</span> <span class="n">buffer</span>
<span class="k">let</span> <span class="n">write</span> <span class="n">html</span> <span class="o">=</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="n">write</span> <span class="n">channel</span> <span class="o">(</span><span class="nn">Nethtml</span><span class="p">.</span><span class="n">encode</span> <span class="n">html</span><span class="o">)</span>
<span class="k">let</span> <span class="n">paragraphs</span> <span class="o">=</span> <span class="n">paragraph_stream_of_channel</span> <span class="n">stdin</span>

<span class="c">(* Main loop *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">first</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">true</span> <span class="k">in</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">para</span> <span class="o">-&gt;</span>
       <span class="k">if</span> <span class="o">!</span><span class="n">first</span> <span class="k">then</span> <span class="n">first</span> <span class="o">:=</span> <span class="bp">false</span>
       <span class="k">else</span> <span class="n">write</span> <span class="o">[</span><span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">];</span>
       <span class="c">(* Paragraphs beginning with whitespace are wrapped in &lt;pre&gt; *)</span>
       <span class="k">let</span> <span class="n">tag</span><span class="o">,</span> <span class="n">body</span> <span class="o">=</span>
         <span class="k">if</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">para</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nn">String</span><span class="p">.</span><span class="n">contains</span> <span class="s2">&quot; </span><span class="se">\t</span><span class="s2">&quot;</span> <span class="n">para</span><span class="o">.[</span><span class="mi">0</span><span class="o">]</span>
         <span class="k">then</span> <span class="s2">&quot;pre&quot;</span><span class="o">,</span> <span class="o">[</span><span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
                      <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="n">para</span><span class="o">;</span>  <span class="c">(* indented verbatim *)</span>
                      <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">]</span>
         <span class="k">else</span> <span class="s2">&quot;p&quot;</span><span class="o">,</span> <span class="n">text2html</span> <span class="n">para</span> <span class="k">in</span>      <span class="c">(* add paragraph tag *)</span>
       <span class="n">write</span> <span class="o">[</span><span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span> <span class="o">(</span><span class="n">tag</span><span class="o">,</span> <span class="bp">[]</span><span class="o">,</span> <span class="n">body</span><span class="o">)])</span>
    <span class="n">paragraphs</span><span class="o">;</span>
  <span class="n">print_endline</span> <span class="o">(</span><span class="nn">Buffer</span><span class="p">.</span><span class="n">contents</span> <span class="n">buffer</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* To format mail headers as a table, add the following just before</span>
<span class="c">   the main loop. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">colon_delim</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[ </span><span class="se">\t</span><span class="s2">]*:[ </span><span class="se">\t</span><span class="s2">]*&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">continuation</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[ </span><span class="se">\t</span><span class="s2">]+&quot;</span> <span class="k">in</span>
  <span class="k">try</span>
    <span class="k">let</span> <span class="n">headers</span> <span class="o">=</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">next</span> <span class="n">paragraphs</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">headers</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">global_replace</span> <span class="n">continuation</span> <span class="s2">&quot; &quot;</span> <span class="n">headers</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">split</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span> <span class="n">headers</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">rows</span> <span class="o">=</span>
      <span class="nn">List</span><span class="p">.</span><span class="n">flatten</span>
        <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span>
           <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span>
              <span class="c">(* parse heading *)</span>
              <span class="k">let</span> <span class="n">key</span><span class="o">,</span> <span class="k">value</span> <span class="o">=</span>
                <span class="k">match</span> <span class="nn">Str</span><span class="p">.</span><span class="n">bounded_split_delim</span> <span class="n">colon_delim</span> <span class="n">line</span> <span class="mi">2</span> <span class="k">with</span>
                  <span class="o">|</span> <span class="o">[</span><span class="n">key</span><span class="o">;</span> <span class="k">value</span><span class="o">]</span> <span class="o">-&gt;</span> <span class="n">key</span><span class="o">,</span> <span class="k">value</span>
                  <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="s2">&quot;&quot;</span><span class="o">,</span> <span class="n">line</span> <span class="k">in</span>
              <span class="o">[</span><span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span>
                 <span class="o">(</span><span class="s2">&quot;tr&quot;</span><span class="o">,</span> <span class="bp">[]</span><span class="o">,</span>
                  <span class="o">[</span><span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span>
                     <span class="o">(</span><span class="s2">&quot;th&quot;</span><span class="o">,</span> <span class="o">[</span><span class="s2">&quot;align&quot;</span><span class="o">,</span> <span class="s2">&quot;left&quot;</span><span class="o">],</span> <span class="o">[</span><span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="n">key</span><span class="o">]);</span>
                   <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span>
                     <span class="o">(</span><span class="s2">&quot;td&quot;</span><span class="o">,</span> <span class="bp">[]</span><span class="o">,</span> <span class="o">[</span><span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="k">value</span><span class="o">])]);</span>
               <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">])</span>
           <span class="n">lines</span><span class="o">)</span> <span class="k">in</span>
    <span class="n">write</span> <span class="o">[</span><span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span> <span class="o">(</span><span class="s2">&quot;table&quot;</span><span class="o">,</span> <span class="bp">[]</span><span class="o">,</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="n">encode</span> <span class="n">rows</span><span class="o">);</span>
           <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span> <span class="o">(</span><span class="s2">&quot;hr&quot;</span><span class="o">,</span> <span class="bp">[]</span><span class="o">,</span> <span class="bp">[]</span><span class="o">);</span>
           <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">]</span>
  <span class="k">with</span> <span class="nn">Stream</span><span class="p">.</span><span class="nc">Failure</span> <span class="o">-&gt;</span> <span class="bp">()</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1069"
>Converting HTML to ASCII</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">slurp_channel</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">buffer_size</span> <span class="o">=</span> <span class="mi">4096</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">create</span> <span class="n">buffer_size</span> <span class="k">in</span>
  <span class="k">let</span> <span class="kt">string</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">create</span> <span class="n">buffer_size</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">chars_read</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">1</span> <span class="k">in</span>
  <span class="k">while</span> <span class="o">!</span><span class="n">chars_read</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="k">do</span>
    <span class="n">chars_read</span> <span class="o">:=</span> <span class="n">input</span> <span class="n">channel</span> <span class="kt">string</span> <span class="mi">0</span> <span class="n">buffer_size</span><span class="o">;</span>
    <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_substring</span> <span class="n">buffer</span> <span class="kt">string</span> <span class="mi">0</span> <span class="o">!</span><span class="n">chars_read</span>
  <span class="k">done</span><span class="o">;</span>
  <span class="nn">Buffer</span><span class="p">.</span><span class="n">contents</span> <span class="n">buffer</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">process</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_in</span> <span class="o">(</span><span class="s2">&quot;lynx -dump &quot;</span> <span class="o">^</span> <span class="n">filename</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">ascii</span> <span class="o">=</span> <span class="n">slurp_channel</span> <span class="n">process</span> <span class="k">in</span>
  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_in</span> <span class="n">process</span><span class="o">);</span>
  <span class="c">(* ... *)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1072"
>Extracting or Removing HTML Tags</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* Nethtml can be used to safely isolate and extract the text elements</span>
<span class="c">   from an HTML document. *)</span>
<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netstring&quot;</span><span class="o">;;</span>

<span class="c">(* Load the HTML document. *)</span>
<span class="k">let</span> <span class="n">channel</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">input_channel</span> <span class="o">(</span><span class="n">open_in</span> <span class="n">filename</span><span class="o">)</span>
<span class="k">let</span> <span class="n">html</span> <span class="o">=</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="n">parse</span> <span class="n">channel</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">channel</span><span class="o">#</span><span class="n">close_in</span> <span class="bp">()</span>

<span class="c">(* Convert the document to plain text. *)</span>
<span class="k">let</span> <span class="n">plain_text</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">text</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span> <span class="n">html</span> <span class="o">=</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
      <span class="o">(</span><span class="k">function</span>
         <span class="o">|</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">text</span> <span class="o">:=</span> <span class="n">s</span> <span class="o">::</span> <span class="o">!</span><span class="n">text</span>
         <span class="o">|</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span> <span class="o">(_,</span> <span class="o">_,</span> <span class="n">children</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="n">children</span><span class="o">)</span>
      <span class="n">html</span> <span class="k">in</span>
  <span class="n">loop</span> <span class="o">(</span><span class="nn">Nethtml</span><span class="p">.</span><span class="n">decode</span> <span class="n">html</span><span class="o">);</span>
  <span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="o">!</span><span class="n">text</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* htitle - get html title from URL *)</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;str&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netclient&quot;</span><span class="o">;;</span>

<span class="k">open</span> <span class="nn">Http_client</span><span class="p">.</span><span class="nc">Convenience</span>

<span class="k">let</span> <span class="n">ltrim</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">global_replace</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;^[ </span><span class="se">\r\n\t\x00\x0B</span><span class="s2">]*&quot;</span><span class="o">)</span> <span class="s2">&quot;&quot;</span>
<span class="k">let</span> <span class="n">rtrim</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">global_replace</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[ </span><span class="se">\r\n\t\x00\x0B</span><span class="s2">]*$&quot;</span><span class="o">)</span> <span class="s2">&quot;&quot;</span>
<span class="k">let</span> <span class="n">trim</span> <span class="n">s</span> <span class="o">=</span> <span class="n">rtrim</span> <span class="o">(</span><span class="n">ltrim</span> <span class="n">s</span><span class="o">)</span>

<span class="k">let</span> <span class="n">find_title</span> <span class="n">html</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">title</span> <span class="o">=</span> <span class="n">ref</span> <span class="s2">&quot;&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span> <span class="o">=</span> <span class="k">function</span>
    <span class="o">|</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span> <span class="o">(</span><span class="s2">&quot;title&quot;</span><span class="o">,</span> <span class="o">_,</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="n">data</span> <span class="o">::</span> <span class="o">_)</span> <span class="o">-&gt;</span>
        <span class="n">title</span> <span class="o">:=</span> <span class="n">trim</span> <span class="n">data</span><span class="o">;</span> <span class="k">raise</span> <span class="nc">Exit</span>
    <span class="o">|</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span> <span class="o">(_,</span> <span class="o">_,</span> <span class="n">children</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="n">loop</span> <span class="n">children</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="o">(</span><span class="k">try</span> <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="n">loop</span> <span class="n">html</span> <span class="k">with</span> <span class="nc">Exit</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">);</span>
  <span class="o">!</span><span class="n">title</span>

<span class="k">let</span> <span class="n">urls</span> <span class="o">=</span>
  <span class="k">if</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="o">&gt;</span> <span class="mi">1</span>
  <span class="k">then</span> <span class="nn">List</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">)</span>
  <span class="k">else</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;usage: %s url ...</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">);</span> <span class="n">exit</span> <span class="mi">1</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">url</span> <span class="o">-&gt;</span>
       <span class="n">print_string</span> <span class="o">(</span><span class="n">url</span> <span class="o">^</span> <span class="s2">&quot;: &quot;</span><span class="o">);</span>
       <span class="k">try</span>
         <span class="k">let</span> <span class="n">res</span> <span class="o">=</span> <span class="n">http_get</span> <span class="n">url</span> <span class="k">in</span>
         <span class="k">let</span> <span class="n">ch</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">input_string</span> <span class="n">res</span> <span class="k">in</span>
         <span class="k">let</span> <span class="n">html</span> <span class="o">=</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="n">parse</span> <span class="n">ch</span> <span class="k">in</span>
         <span class="n">print_endline</span> <span class="o">(</span><span class="n">find_title</span> <span class="n">html</span><span class="o">)</span>
       <span class="k">with</span>
         <span class="o">|</span> <span class="nn">Http_client</span><span class="p">.</span><span class="nc">Http_error</span> <span class="o">(</span><span class="n">status</span><span class="o">,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
             <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%d %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">status</span>
               <span class="o">(</span><span class="nn">Nethttp</span><span class="p">.</span><span class="n">string_of_http_status</span>
                  <span class="o">(</span><span class="nn">Nethttp</span><span class="p">.</span><span class="n">http_status_of_int</span> <span class="n">status</span><span class="o">))</span>
         <span class="o">|</span> <span class="nc">Failure</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">print_endline</span> <span class="n">s</span><span class="o">)</span>
    <span class="n">urls</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1075"
>Finding Stale Links</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* churl - check urls *)</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netclient&quot;</span><span class="o">;;</span>

<span class="k">open</span> <span class="nn">Http_client</span><span class="p">.</span><span class="nc">Convenience</span>
<span class="k">open</span> <span class="nc">Nethtml</span>

<span class="k">let</span> <span class="k">rec</span> <span class="n">fold_elements</span> <span class="n">f</span> <span class="n">accu</span> <span class="o">=</span> <span class="k">function</span>
  <span class="o">|</span> <span class="nc">Element</span> <span class="o">(_,</span> <span class="o">_,</span> <span class="n">children</span><span class="o">)</span> <span class="k">as</span> <span class="n">element</span> <span class="o">-&gt;</span>
      <span class="k">let</span> <span class="n">accu</span> <span class="o">=</span>
        <span class="nn">List</span><span class="p">.</span><span class="n">fold_right</span>
          <span class="o">(</span><span class="k">fun</span> <span class="n">child</span> <span class="n">accu</span> <span class="o">-&gt;</span>
             <span class="n">fold_elements</span> <span class="n">f</span> <span class="n">accu</span> <span class="n">child</span><span class="o">)</span>
          <span class="n">children</span>
          <span class="n">accu</span> <span class="k">in</span>
      <span class="n">f</span> <span class="n">accu</span> <span class="n">element</span>
  <span class="o">|</span> <span class="n">other</span> <span class="o">-&gt;</span> <span class="n">accu</span>

<span class="k">type</span> <span class="n">link</span> <span class="o">=</span> <span class="nc">A</span> <span class="k">of</span> <span class="kt">string</span> <span class="o">|</span> <span class="nc">IMG</span> <span class="k">of</span> <span class="kt">string</span>

<span class="k">let</span> <span class="n">find_links</span> <span class="n">elements</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">flatten</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span>
       <span class="o">(</span><span class="n">fold_elements</span>
          <span class="o">(</span><span class="k">fun</span> <span class="n">accu</span> <span class="n">element</span> <span class="o">-&gt;</span>
             <span class="k">match</span> <span class="n">element</span> <span class="k">with</span>
               <span class="o">|</span> <span class="nc">Element</span> <span class="o">(</span><span class="s2">&quot;a&quot;</span><span class="o">,</span> <span class="n">attribs</span><span class="o">,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
                   <span class="o">(</span><span class="k">try</span> <span class="nc">A</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">assoc</span> <span class="s2">&quot;href&quot;</span> <span class="n">attribs</span><span class="o">)</span> <span class="o">::</span> <span class="n">accu</span>
                    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="n">accu</span><span class="o">)</span>
               <span class="o">|</span> <span class="nc">Element</span> <span class="o">(</span><span class="s2">&quot;img&quot;</span><span class="o">,</span> <span class="n">attribs</span><span class="o">,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
                   <span class="o">(</span><span class="k">try</span> <span class="nc">IMG</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">assoc</span> <span class="s2">&quot;src&quot;</span> <span class="n">attribs</span><span class="o">)</span> <span class="o">::</span> <span class="n">accu</span>
                    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="n">accu</span><span class="o">)</span>
               <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">accu</span><span class="o">)</span>
          <span class="bp">[]</span><span class="o">)</span>
       <span class="n">elements</span><span class="o">)</span>

<span class="k">let</span> <span class="n">check_url</span> <span class="n">url</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;  %s: %s</span><span class="se">\n</span><span class="s2">%!&quot;</span> <span class="n">url</span>
    <span class="o">(</span><span class="k">match</span> <span class="o">(</span><span class="n">http_head_message</span> <span class="n">url</span><span class="o">)#</span><span class="n">status</span> <span class="k">with</span>
       <span class="o">|</span> <span class="o">`</span><span class="nc">Successful</span> <span class="o">-&gt;</span> <span class="s2">&quot;OK&quot;</span>
       <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="s2">&quot;BAD&quot;</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="o">&lt;&gt;</span> <span class="mi">2</span>
  <span class="k">then</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;usage: %s &lt;start_url&gt;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">);</span> <span class="n">exit</span> <span class="mi">1</span><span class="o">)</span>

<span class="k">let</span> <span class="n">base_url</span> <span class="o">=</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span>
<span class="k">let</span> <span class="n">elements</span> <span class="o">=</span> <span class="n">parse</span> <span class="o">(</span><span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">input_string</span> <span class="o">(</span><span class="n">http_get</span> <span class="n">base_url</span><span class="o">))</span>
<span class="k">let</span> <span class="n">url_syntax</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="nn">Neturl</span><span class="p">.</span><span class="n">common_url_syntax</span> <span class="s2">&quot;http&quot;</span>
<span class="k">let</span> <span class="n">url_syntax</span> <span class="o">=</span>
  <span class="o">{</span><span class="n">url_syntax</span> <span class="k">with</span>
     <span class="nn">Neturl</span><span class="p">.</span><span class="n">url_enable_fragment</span> <span class="o">=</span> <span class="nn">Neturl</span><span class="p">.</span><span class="nc">Url_part_allowed</span><span class="o">}</span>
<span class="k">let</span> <span class="n">url_syntax</span> <span class="o">=</span> <span class="nn">Neturl</span><span class="p">.</span><span class="n">partial_url_syntax</span> <span class="n">url_syntax</span>

<span class="k">module</span> <span class="nc">StringSet</span> <span class="o">=</span> <span class="nn">Set</span><span class="p">.</span><span class="nc">Make</span><span class="o">(</span><span class="nc">String</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">print_endline</span> <span class="o">(</span><span class="n">base_url</span> <span class="o">^</span> <span class="s2">&quot;:&quot;</span><span class="o">);</span>
  <span class="nn">StringSet</span><span class="p">.</span><span class="n">iter</span> <span class="n">check_url</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">fold_left</span>
       <span class="o">(</span><span class="k">fun</span> <span class="n">accu</span> <span class="n">s</span> <span class="o">-&gt;</span>
          <span class="k">try</span>
            <span class="nn">StringSet</span><span class="p">.</span><span class="n">add</span>
              <span class="o">(</span><span class="nn">Neturl</span><span class="p">.</span><span class="n">string_of_url</span>
                 <span class="o">(</span><span class="nn">Neturl</span><span class="p">.</span><span class="n">apply_relative_url</span>
                    <span class="o">(</span><span class="nn">Neturl</span><span class="p">.</span><span class="n">url_of_string</span> <span class="n">url_syntax</span> <span class="n">base_url</span><span class="o">)</span>
                    <span class="o">(</span><span class="nn">Neturl</span><span class="p">.</span><span class="n">url_of_string</span> <span class="n">url_syntax</span> <span class="n">s</span><span class="o">)))</span>
              <span class="n">accu</span>
          <span class="k">with</span> <span class="nn">Neturl</span><span class="p">.</span><span class="nc">Malformed_URL</span> <span class="o">-&gt;</span>
            <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Malformed URL: %s</span><span class="se">\n</span><span class="s2">%!&quot;</span> <span class="n">s</span><span class="o">;</span>
            <span class="n">accu</span><span class="o">)</span>
       <span class="nn">StringSet</span><span class="p">.</span><span class="n">empty</span>
       <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span>
          <span class="o">(</span><span class="k">function</span>
             <span class="o">|</span> <span class="nc">A</span> <span class="n">href</span> <span class="o">-&gt;</span> <span class="n">href</span>
             <span class="o">|</span> <span class="nc">IMG</span> <span class="n">src</span> <span class="o">-&gt;</span> <span class="n">src</span><span class="o">)</span>
          <span class="o">(</span><span class="n">find_links</span> <span class="n">elements</span><span class="o">)))</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1078"
>Finding Fresh Links</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* surl - sort URLs by their last modification date *)</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netclient&quot;</span><span class="o">;;</span>

<span class="k">open</span> <span class="nn">Http_client</span><span class="p">.</span><span class="nc">Convenience</span>

<span class="k">let</span> <span class="n">dates</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="k">let</span> <span class="n">url</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">stdin</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">call</span> <span class="o">=</span> <span class="n">http_head_message</span> <span class="n">url</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">date</span> <span class="o">=</span>
        <span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="nn">Netdate</span><span class="p">.</span><span class="n">parse</span>
                    <span class="o">(</span><span class="n">call</span><span class="o">#</span><span class="n">response_header</span><span class="o">#</span><span class="n">field</span> <span class="s2">&quot;Last-Modified&quot;</span><span class="o">))</span>
        <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="nc">None</span> <span class="k">in</span>
      <span class="n">dates</span> <span class="o">:=</span> <span class="o">(</span><span class="n">date</span><span class="o">,</span> <span class="n">url</span><span class="o">)</span> <span class="o">::</span> <span class="o">!</span><span class="n">dates</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">date</span><span class="o">,</span> <span class="n">url</span><span class="o">)</span> <span class="o">-&gt;</span>
       <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%-25s %s</span><span class="se">\n</span><span class="s2">&quot;</span>
         <span class="o">(</span><span class="k">match</span> <span class="n">date</span> <span class="k">with</span>
            <span class="o">|</span> <span class="nc">Some</span> <span class="n">date</span> <span class="o">-&gt;</span> <span class="nn">Netdate</span><span class="p">.</span><span class="n">format</span> <span class="s2">&quot;%a %b %d %H:%M:%S %Y&quot;</span> <span class="n">date</span>
            <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="s2">&quot;&lt;NONE SPECIFIED&gt;&quot;</span><span class="o">)</span>
         <span class="n">url</span><span class="o">)</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">sort</span> <span class="n">compare</span> <span class="o">!</span><span class="n">dates</span><span class="o">))</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1081"
>Creating HTML Templates</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* Template replacement using regular expressions from the Str module. *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">slurp_channel</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">buffer_size</span> <span class="o">=</span> <span class="mi">4096</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">create</span> <span class="n">buffer_size</span> <span class="k">in</span>
  <span class="k">let</span> <span class="kt">string</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">create</span> <span class="n">buffer_size</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">chars_read</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">1</span> <span class="k">in</span>
  <span class="k">while</span> <span class="o">!</span><span class="n">chars_read</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="k">do</span>
    <span class="n">chars_read</span> <span class="o">:=</span> <span class="n">input</span> <span class="n">channel</span> <span class="kt">string</span> <span class="mi">0</span> <span class="n">buffer_size</span><span class="o">;</span>
    <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_substring</span> <span class="n">buffer</span> <span class="kt">string</span> <span class="mi">0</span> <span class="o">!</span><span class="n">chars_read</span>
  <span class="k">done</span><span class="o">;</span>
  <span class="nn">Buffer</span><span class="p">.</span><span class="n">contents</span> <span class="n">buffer</span>

<span class="k">let</span> <span class="n">slurp_file</span> <span class="n">filename</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">open_in_bin</span> <span class="n">filename</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">result</span> <span class="o">=</span>
    <span class="k">try</span> <span class="n">slurp_channel</span> <span class="n">channel</span>
    <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">close_in</span> <span class="n">channel</span><span class="o">;</span> <span class="k">raise</span> <span class="n">e</span> <span class="k">in</span>
  <span class="n">close_in</span> <span class="n">channel</span><span class="o">;</span>
  <span class="n">result</span>

<span class="k">let</span> <span class="n">template_regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;%%</span><span class="se">\\</span><span class="s2">([^%]+</span><span class="se">\\</span><span class="s2">)%%&quot;</span>

<span class="k">let</span> <span class="n">template</span> <span class="n">filename</span> <span class="n">fillings</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">text</span> <span class="o">=</span> <span class="n">slurp_file</span> <span class="n">filename</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">eval</span> <span class="n">s</span> <span class="o">=</span>
    <span class="k">try</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">fillings</span> <span class="n">s</span>
    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="s2">&quot;&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">replace</span> <span class="o">_</span> <span class="o">=</span>
    <span class="n">eval</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">1</span> <span class="n">text</span><span class="o">)</span> <span class="k">in</span>
  <span class="nn">Str</span><span class="p">.</span><span class="n">global_substitute</span> <span class="n">template_regexp</span> <span class="n">replace</span> <span class="n">text</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Alternative implementation: a hand-written stream parser. This version</span>
<span class="c">   avoids loading the whole template into memory, so it is efficient for</span>
<span class="c">   large files. *)</span>

<span class="k">let</span> <span class="n">template</span> <span class="n">filename</span> <span class="n">fillings</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">f</span> <span class="o">=</span> <span class="n">open_in</span> <span class="n">filename</span> <span class="k">in</span>
  <span class="k">try</span>
    <span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">create</span> <span class="o">(</span><span class="n">in_channel_length</span> <span class="n">f</span><span class="o">)</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">text</span> <span class="o">=</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">of_channel</span> <span class="n">f</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">eval</span> <span class="n">s</span> <span class="o">=</span>
      <span class="k">try</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">fillings</span> <span class="n">s</span>
      <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="s2">&quot;&quot;</span> <span class="k">in</span>
    <span class="k">let</span> <span class="k">rec</span> <span class="n">search</span> <span class="bp">()</span> <span class="o">=</span>
      <span class="k">match</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">peek</span> <span class="n">text</span> <span class="k">with</span>
        <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="bp">()</span>
        <span class="o">|</span> <span class="nc">Some</span> <span class="sc">&#39;%&#39;</span> <span class="o">-&gt;</span>
            <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">text</span><span class="o">;</span>
            <span class="o">(</span><span class="k">match</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">peek</span> <span class="n">text</span> <span class="k">with</span>
               <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span>
                   <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_char</span> <span class="n">buffer</span> <span class="sc">&#39;%&#39;</span><span class="o">;</span>
                   <span class="n">search</span> <span class="bp">()</span>
               <span class="o">|</span> <span class="nc">Some</span> <span class="sc">&#39;%&#39;</span> <span class="o">-&gt;</span>
                   <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">text</span><span class="o">;</span>
                   <span class="n">replace</span> <span class="s2">&quot;&quot;</span>
               <span class="o">|</span> <span class="nc">Some</span> <span class="n">c</span> <span class="o">-&gt;</span>
                   <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">text</span><span class="o">;</span>
                   <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_char</span> <span class="n">buffer</span> <span class="sc">&#39;%&#39;</span><span class="o">;</span>
                   <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_char</span> <span class="n">buffer</span> <span class="n">c</span><span class="o">;</span>
                   <span class="n">search</span> <span class="bp">()</span><span class="o">)</span>
        <span class="o">|</span> <span class="nc">Some</span> <span class="n">c</span> <span class="o">-&gt;</span>
            <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">text</span><span class="o">;</span>
            <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_char</span> <span class="n">buffer</span> <span class="n">c</span><span class="o">;</span>
            <span class="n">search</span> <span class="bp">()</span>
    <span class="ow">and</span> <span class="n">replace</span> <span class="n">acc</span> <span class="o">=</span>
      <span class="k">match</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">peek</span> <span class="n">text</span> <span class="k">with</span>
        <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span>
            <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_string</span> <span class="n">buffer</span> <span class="s2">&quot;%%&quot;</span><span class="o">;</span>
            <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_string</span> <span class="n">buffer</span> <span class="n">acc</span>
        <span class="o">|</span> <span class="nc">Some</span> <span class="sc">&#39;%&#39;</span> <span class="o">-&gt;</span>
            <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">text</span><span class="o">;</span>
            <span class="o">(</span><span class="k">match</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">peek</span> <span class="n">text</span> <span class="k">with</span>
               <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span>
                   <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_string</span> <span class="n">buffer</span> <span class="s2">&quot;%%&quot;</span><span class="o">;</span>
                   <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_string</span> <span class="n">buffer</span> <span class="n">acc</span><span class="o">;</span>
                   <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_char</span> <span class="n">buffer</span> <span class="sc">&#39;%&#39;</span>
               <span class="o">|</span> <span class="nc">Some</span> <span class="sc">&#39;%&#39;</span> <span class="o">-&gt;</span>
                   <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">text</span><span class="o">;</span>
                   <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_string</span> <span class="n">buffer</span> <span class="o">(</span><span class="n">eval</span> <span class="n">acc</span><span class="o">);</span>
                   <span class="n">search</span> <span class="bp">()</span>
               <span class="o">|</span> <span class="nc">Some</span> <span class="n">c</span> <span class="o">-&gt;</span>
                   <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">text</span><span class="o">;</span>
                   <span class="n">replace</span> <span class="o">(</span><span class="n">acc</span> <span class="o">^</span> <span class="s2">&quot;%&quot;</span> <span class="o">^</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="mi">1</span> <span class="n">c</span><span class="o">)))</span>
        <span class="o">|</span> <span class="nc">Some</span> <span class="n">c</span> <span class="o">-&gt;</span>
            <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">text</span><span class="o">;</span>
            <span class="n">replace</span> <span class="o">(</span><span class="n">acc</span> <span class="o">^</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="mi">1</span> <span class="n">c</span><span class="o">))</span> <span class="k">in</span>
    <span class="n">search</span> <span class="bp">()</span><span class="o">;</span>
    <span class="n">close_in</span> <span class="n">f</span><span class="o">;</span>
    <span class="nn">Buffer</span><span class="p">.</span><span class="n">contents</span> <span class="n">buffer</span>
  <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span>
    <span class="n">close_in</span> <span class="n">f</span><span class="o">;</span>
    <span class="k">raise</span> <span class="n">e</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* simple.template contains the following:</span>

<span class="c">&lt;!-- simple.template for internal template() function --&gt;</span>
<span class="c">&lt;HTML&gt;&lt;HEAD&gt;&lt;TITLE&gt;Report for %%username%%&lt;/TITLE&gt;&lt;/HEAD&gt;</span>
<span class="c">&lt;BODY&gt;&lt;H1&gt;Report for %%username%%&lt;/H1&gt;</span>
<span class="c">%%username%% logged in %%count%% times, for a total of %%total%% minutes.</span>

<span class="c">*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">fields</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">3</span> <span class="k">in</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">fields</span> <span class="s2">&quot;username&quot;</span> <span class="n">whats_his_name</span><span class="o">;</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">fields</span> <span class="s2">&quot;count&quot;</span> <span class="o">(</span><span class="n">string_of_int</span> <span class="n">login_count</span><span class="o">);</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">fields</span> <span class="s2">&quot;total&quot;</span> <span class="o">(</span><span class="n">string_of_int</span> <span class="n">minute_used</span><span class="o">);</span>
  <span class="n">print_endline</span> <span class="o">(</span><span class="n">template</span> <span class="s2">&quot;simple.template&quot;</span> <span class="n">fields</span><span class="o">)</span>

<span class="c">(* Output:</span>

<span class="c">&lt;!-- simple.template for internal template() function --&gt;</span>
<span class="c">&lt;HTML&gt;&lt;HEAD&gt;&lt;TITLE&gt;Report for ramen&lt;/TITLE&gt;&lt;/HEAD&gt;</span>
<span class="c">&lt;BODY&gt;&lt;H1&gt;Report for ramen&lt;/H1&gt;</span>
<span class="c">ramen logged in 42 times, for a total of 123 minutes.</span>

<span class="c">*)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* userrep - report duration of user logins using SQL database *)</span>

<span class="k">let</span> <span class="n">process</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="o">=</span>
  <span class="n">cgi</span><span class="o">#</span><span class="n">set_header</span> <span class="o">~</span><span class="n">content_type</span><span class="o">:</span><span class="s2">&quot;text/html&quot;</span> <span class="bp">()</span><span class="o">;</span>
  <span class="k">begin</span>
    <span class="k">match</span> <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;username&quot;</span> <span class="k">with</span>
      <span class="o">|</span> <span class="s2">&quot;&quot;</span> <span class="o">-&gt;</span>
          <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">output_string</span> <span class="s2">&quot;No username&quot;</span>
      <span class="o">|</span> <span class="n">user</span> <span class="o">-&gt;</span>
          <span class="k">let</span> <span class="n">db</span> <span class="o">=</span>
            <span class="nn">Mysql</span><span class="p">.</span><span class="n">quick_connect</span>
              <span class="o">~</span><span class="n">user</span><span class="o">:</span><span class="s2">&quot;user&quot;</span>
              <span class="o">~</span><span class="n">password</span><span class="o">:</span><span class="s2">&quot;seekritpassword&quot;</span>
              <span class="o">~</span><span class="n">database</span><span class="o">:</span><span class="s2">&quot;connections&quot;</span> <span class="bp">()</span> <span class="k">in</span>
          <span class="k">let</span> <span class="n">sql</span> <span class="o">=</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;</span>
<span class="s2">            SELECT COUNT(duration),SUM(duration)</span>
<span class="s2">            FROM logins WHERE username=&#39;%s&#39;</span>
<span class="s2">          &quot;</span> <span class="o">(</span><span class="nn">Mysql</span><span class="p">.</span><span class="n">escape</span> <span class="n">user</span><span class="o">)</span> <span class="k">in</span>
          <span class="k">let</span> <span class="n">result</span> <span class="o">=</span> <span class="nn">Mysql</span><span class="p">.</span><span class="n">exec</span> <span class="n">db</span> <span class="n">sql</span> <span class="k">in</span>
          <span class="k">let</span> <span class="n">default</span> <span class="n">d</span> <span class="o">=</span> <span class="k">function</span> <span class="nc">Some</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span> <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="n">d</span> <span class="k">in</span>
          <span class="k">let</span> <span class="o">(</span><span class="n">count</span><span class="o">,</span> <span class="n">total</span><span class="o">)</span> <span class="o">=</span>
            <span class="k">match</span> <span class="nn">Mysql</span><span class="p">.</span><span class="n">fetch</span> <span class="n">result</span> <span class="k">with</span>
              <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="s2">&quot;0&quot;</span><span class="o">,</span> <span class="s2">&quot;0&quot;</span><span class="o">)</span>
              <span class="o">|</span> <span class="nc">Some</span> <span class="n">row</span> <span class="o">-&gt;</span>
                  <span class="o">(</span><span class="n">default</span> <span class="s2">&quot;0&quot;</span> <span class="n">row</span><span class="o">.(</span><span class="mi">0</span><span class="o">),</span>
                   <span class="n">default</span> <span class="s2">&quot;0&quot;</span> <span class="n">row</span><span class="o">.(</span><span class="mi">1</span><span class="o">))</span> <span class="k">in</span>
          <span class="c">(* template defined in the solution above *)</span>
          <span class="k">let</span> <span class="n">tpl</span> <span class="o">=</span> <span class="n">template</span> <span class="s2">&quot;report.tpl&quot;</span> <span class="k">in</span>
          <span class="k">let</span> <span class="n">vars</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">3</span> <span class="k">in</span>
          <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">vars</span> <span class="s2">&quot;username&quot;</span> <span class="n">user</span><span class="o">;</span>
          <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">vars</span> <span class="s2">&quot;count&quot;</span> <span class="n">count</span><span class="o">;</span>
          <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">vars</span> <span class="s2">&quot;total&quot;</span> <span class="n">total</span><span class="o">;</span>
          <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">output_string</span> <span class="o">(</span><span class="n">tpl</span> <span class="n">vars</span><span class="o">)</span>
  <span class="k">end</span><span class="o">;</span>
  <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">commit_work</span> <span class="bp">()</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">config</span> <span class="o">=</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">default_config</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">buffered</span> <span class="o">_</span> <span class="n">ch</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">buffered_trans_channel</span> <span class="n">ch</span> <span class="k">in</span>
  <span class="nn">Netcgi_cgi</span><span class="p">.</span><span class="n">run</span> <span class="o">~</span><span class="n">config</span> <span class="o">~</span><span class="n">output_type</span><span class="o">:(`</span><span class="nc">Transactional</span> <span class="n">buffered</span><span class="o">)</span> <span class="n">process</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1084"
>Mirroring Web Pages</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;unix&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netclient&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">mirror</span> <span class="n">url</span> <span class="n">file</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">call</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Http_client</span><span class="p">.</span><span class="n">get</span> <span class="n">url</span> <span class="k">in</span>
  <span class="k">begin</span>
    <span class="k">try</span>
      <span class="k">let</span> <span class="n">mtime</span> <span class="o">=</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">stat</span> <span class="n">file</span><span class="o">).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">st_mtime</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">date</span> <span class="o">=</span> <span class="nn">Netdate</span><span class="p">.</span><span class="n">mk_mail_date</span> <span class="n">mtime</span> <span class="k">in</span>
      <span class="n">call</span><span class="o">#</span><span class="n">set_req_header</span> <span class="s2">&quot;If-Modified-Since&quot;</span> <span class="n">date</span>
    <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span>
  <span class="k">end</span><span class="o">;</span>
  <span class="n">call</span><span class="o">#</span><span class="n">set_response_body_storage</span> <span class="o">(`</span><span class="nc">File</span> <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="n">file</span><span class="o">));</span>
  <span class="k">let</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Http_client</span><span class="p">.</span><span class="n">pipeline</span> <span class="k">in</span>
  <span class="n">pipeline</span><span class="o">#</span><span class="n">add</span> <span class="n">call</span><span class="o">;</span>
  <span class="n">pipeline</span><span class="o">#</span><span class="n">run</span> <span class="bp">()</span><span class="o">;</span>
  <span class="k">if</span> <span class="n">call</span><span class="o">#</span><span class="n">response_status</span> <span class="o">=</span> <span class="o">`</span><span class="nc">Ok</span>
  <span class="k">then</span> <span class="o">(</span><span class="k">let</span> <span class="n">date</span> <span class="o">=</span>
          <span class="nn">Netdate</span><span class="p">.</span><span class="n">parse</span>
            <span class="o">(</span><span class="n">call</span><span class="o">#</span><span class="n">response_header</span><span class="o">#</span><span class="n">field</span> <span class="s2">&quot;Last-Modified&quot;</span><span class="o">)</span> <span class="k">in</span>
        <span class="nn">Unix</span><span class="p">.</span><span class="n">utimes</span> <span class="n">file</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span> <span class="o">(</span><span class="nn">Netdate</span><span class="p">.</span><span class="n">since_epoch</span> <span class="n">date</span><span class="o">));</span>
  <span class="n">call</span><span class="o">#</span><span class="n">response_status</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1087"
>Creating a Robot</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="c">(* Parse &quot;robots.txt&quot; content from a stream of lines and return a</span>
<span class="c">   list of user agents and a multi-valued hash table containing the</span>
<span class="c">   rules for each user agent. *)</span>
<span class="k">let</span> <span class="n">parse_robots</span> <span class="o">=</span>
  <span class="k">let</span> <span class="k">module</span> <span class="nc">S</span> <span class="o">=</span> <span class="nn">Set</span><span class="p">.</span><span class="nc">Make</span><span class="o">(</span><span class="k">struct</span>
                            <span class="k">type</span> <span class="n">t</span> <span class="o">=</span> <span class="kt">string</span>
                            <span class="k">let</span> <span class="n">compare</span> <span class="o">=</span> <span class="n">compare</span>
                          <span class="k">end</span><span class="o">)</span> <span class="k">in</span>

  <span class="c">(* Precompile regular expressions. *)</span>
  <span class="k">let</span> <span class="n">comments</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;#.*&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">leading_white</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;^[ </span><span class="se">\t</span><span class="s2">]+&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">trailing_white</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[ </span><span class="se">\t\r</span><span class="s2">]+$&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">colon_delim</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[ </span><span class="se">\t</span><span class="s2">]*:[ </span><span class="se">\t</span><span class="s2">]*&quot;</span> <span class="k">in</span>

  <span class="k">fun</span> <span class="n">stream</span> <span class="o">-&gt;</span>
    <span class="k">let</span> <span class="n">user_agent</span> <span class="o">=</span> <span class="n">ref</span> <span class="s2">&quot;*&quot;</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">user_agents</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="nn">S</span><span class="p">.</span><span class="n">singleton</span> <span class="s2">&quot;*&quot;</span><span class="o">)</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">rules</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span> <span class="k">in</span>

    <span class="nn">Stream</span><span class="p">.</span><span class="n">iter</span>
      <span class="o">(</span><span class="k">fun</span> <span class="n">s</span> <span class="o">-&gt;</span>
         <span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span> <span class="n">comments</span> <span class="s2">&quot;&quot;</span> <span class="n">s</span> <span class="k">in</span>
         <span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span> <span class="n">leading_white</span> <span class="s2">&quot;&quot;</span> <span class="n">s</span> <span class="k">in</span>
         <span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span> <span class="n">trailing_white</span> <span class="s2">&quot;&quot;</span> <span class="n">s</span> <span class="k">in</span>
         <span class="k">if</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">then</span>
           <span class="k">match</span> <span class="nn">Str</span><span class="p">.</span><span class="n">bounded_split_delim</span> <span class="n">colon_delim</span> <span class="n">s</span> <span class="mi">2</span> <span class="k">with</span>
             <span class="o">|</span> <span class="o">[</span><span class="s2">&quot;User-agent&quot;</span><span class="o">;</span> <span class="k">value</span><span class="o">]</span> <span class="o">-&gt;</span>
                 <span class="c">(* Found a new User-agent. *)</span>
                 <span class="n">user_agent</span> <span class="o">:=</span> <span class="k">value</span><span class="o">;</span>
                 <span class="n">user_agents</span> <span class="o">:=</span> <span class="nn">S</span><span class="p">.</span><span class="n">add</span> <span class="k">value</span> <span class="o">!</span><span class="n">user_agents</span>
             <span class="o">|</span> <span class="o">[</span><span class="s2">&quot;Sitemap&quot;</span><span class="o">;</span> <span class="k">value</span><span class="o">]</span> <span class="o">-&gt;</span>
                 <span class="c">(* Sitemaps are always global. *)</span>
                 <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">add</span> <span class="n">rules</span> <span class="s2">&quot;*&quot;</span> <span class="o">(</span><span class="s2">&quot;Sitemap&quot;</span><span class="o">,</span> <span class="k">value</span><span class="o">)</span>
             <span class="o">|</span> <span class="o">[</span><span class="n">key</span><span class="o">;</span> <span class="k">value</span><span class="o">]</span> <span class="o">-&gt;</span>
                 <span class="c">(* Found a rule for the current User-agent. *)</span>
                 <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">add</span> <span class="n">rules</span> <span class="o">!</span><span class="n">user_agent</span> <span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="k">value</span><span class="o">)</span>
             <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="n">s</span><span class="o">)</span>
      <span class="n">stream</span><span class="o">;</span>
    <span class="nn">S</span><span class="p">.</span><span class="n">elements</span> <span class="o">!</span><span class="n">user_agents</span><span class="o">,</span> <span class="n">rules</span>

<span class="c">(* Produce a stream of lines from an input channel. *)</span>
<span class="k">let</span> <span class="n">line_stream_of_channel</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">channel</span><span class="o">)</span> <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="nc">None</span><span class="o">)</span>

<span class="c">(* Produce a stream of lines from a string in memory. *)</span>
<span class="k">let</span> <span class="n">line_stream_of_string</span> <span class="kt">string</span> <span class="o">=</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">of_list</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">split</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span> <span class="kt">string</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Use Ocamlnet to retrieve a &quot;robots.txt&quot; file and print its rules. *)</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netclient&quot;</span><span class="o">;;</span>
<span class="k">open</span> <span class="nn">Http_client</span><span class="p">.</span><span class="nc">Convenience</span>

<span class="k">let</span> <span class="n">agents</span><span class="o">,</span> <span class="n">rules</span> <span class="o">=</span>
  <span class="n">parse_robots</span>
    <span class="o">(</span><span class="n">line_stream_of_string</span>
       <span class="o">(</span><span class="n">http_get</span> <span class="s2">&quot;http://sourceforge.net/robots.txt&quot;</span><span class="o">))</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">agent</span> <span class="o">-&gt;</span>
       <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;User-agent: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">agent</span><span class="o">;</span>
       <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
         <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="k">value</span><span class="o">)</span> <span class="o">-&gt;</span>
            <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">%s: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">key</span> <span class="k">value</span><span class="o">)</span>
         <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find_all</span> <span class="n">rules</span> <span class="n">agent</span><span class="o">))</span>
    <span class="n">agents</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1090"
>Parsing a Web Server Log File</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* Use the Weblogs library by Richard Jones:</span>
<span class="c">   http://merjis.com/developers/weblogs</span>

<span class="c">   You will also need the HostIP library:</span>
<span class="c">   http://merjis.com/developers/hostip *)</span>

<span class="k">let</span> <span class="n">log</span> <span class="o">=</span> <span class="nn">Weblogs</span><span class="p">.</span><span class="n">import_file</span> <span class="s2">&quot;/var/log/apache2/access.log&quot;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">{</span><span class="nn">Weblogs</span><span class="p">.</span><span class="n">src_ip</span><span class="o">=</span><span class="n">client</span><span class="o">;</span>
          <span class="n">remote_username</span><span class="o">=</span><span class="n">identuser</span><span class="o">;</span>
          <span class="n">username</span><span class="o">=</span><span class="n">authuser</span><span class="o">;</span>
          <span class="n">t</span><span class="o">=</span><span class="n">datetime</span><span class="o">;</span>
          <span class="n">http_method</span><span class="o">=</span><span class="k">method&#39;</span><span class="o">;</span>
          <span class="n">full_url</span><span class="o">=</span><span class="n">url</span><span class="o">;</span>
          <span class="n">http_version</span><span class="o">=</span><span class="n">protocol</span><span class="o">;</span>
          <span class="n">rcode</span><span class="o">=</span><span class="n">status</span><span class="o">;</span>
          <span class="n">size</span><span class="o">=</span><span class="n">bytes</span><span class="o">;</span>
          <span class="c">(* Many more fields are available.</span>
<span class="c">             See Weblogs API documentation for details. *)</span>
         <span class="o">}</span> <span class="o">-&gt;</span>
       <span class="c">(* ... *)</span>
       <span class="bp">()</span><span class="o">)</span>
    <span class="n">log</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1093"
>Processing Server Logs</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* sumwww - summarize web server log activity *)</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;weblogs&quot;</span><span class="o">;;</span>

<span class="k">open</span> <span class="nc">Weblogs</span>

<span class="k">let</span> <span class="n">file</span> <span class="o">=</span>
  <span class="k">if</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="o">=</span> <span class="mi">2</span>
  <span class="k">then</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span>
  <span class="k">else</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;usage: %s &lt;logfile&gt;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">);</span>
        <span class="n">exit</span> <span class="mi">1</span><span class="o">)</span>

<span class="k">let</span> <span class="n">format_date</span> <span class="o">=</span> <span class="nn">CalendarLib</span><span class="p">.</span><span class="nn">Printer</span><span class="p">.</span><span class="nn">CalendarPrinter</span><span class="p">.</span><span class="n">sprint</span> <span class="s2">&quot;%d/%b/%Y&quot;</span>

<span class="k">let</span> <span class="n">incr_hash</span> <span class="n">hash</span> <span class="n">key</span> <span class="n">by</span> <span class="o">=</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">hash</span> <span class="n">key</span>
    <span class="o">(</span><span class="k">try</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">hash</span> <span class="n">key</span> <span class="o">+</span> <span class="n">by</span>
     <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="n">by</span><span class="o">)</span>

<span class="k">let</span> <span class="n">count_hash</span> <span class="n">hash</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">incr</span> <span class="n">count</span><span class="o">)</span> <span class="n">hash</span><span class="o">;</span>
  <span class="o">!</span><span class="n">count</span>

<span class="k">let</span> <span class="n">add_hash</span> <span class="n">dest</span> <span class="n">src</span> <span class="o">=</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="n">incr_hash</span> <span class="n">dest</span><span class="o">)</span> <span class="n">src</span>

<span class="k">let</span> <span class="n">lastdate</span> <span class="o">=</span> <span class="n">ref</span> <span class="s2">&quot;&quot;</span>

<span class="k">let</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>
<span class="k">let</span> <span class="n">posts</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>
<span class="k">let</span> <span class="n">homes</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>
<span class="k">let</span> <span class="n">bytesum</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span><span class="n">l</span>
<span class="k">let</span> <span class="n">hosts</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span><span class="o">)</span>
<span class="k">let</span> <span class="n">whats</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span><span class="o">)</span>

<span class="k">let</span> <span class="n">sumcount</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>
<span class="k">let</span> <span class="n">allposts</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>
<span class="k">let</span> <span class="n">allhomes</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>
<span class="k">let</span> <span class="n">bytesumsum</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span><span class="n">l</span>
<span class="k">let</span> <span class="n">allhosts</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span><span class="o">)</span>
<span class="k">let</span> <span class="n">allwhats</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span><span class="o">)</span>

<span class="c">(* display the tallies of hosts and URLs *)</span>
<span class="k">let</span> <span class="n">write_report</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s %7d %8d %8d %7d %7d %14ld</span><span class="se">\n</span><span class="s2">%!&quot;</span>
    <span class="o">!</span><span class="n">lastdate</span> <span class="o">(</span><span class="n">count_hash</span> <span class="o">!</span><span class="n">hosts</span><span class="o">)</span> <span class="o">!</span><span class="n">count</span> <span class="o">(</span><span class="n">count_hash</span> <span class="o">!</span><span class="n">whats</span><span class="o">)</span>
    <span class="o">!</span><span class="n">posts</span> <span class="o">!</span><span class="n">homes</span> <span class="o">!</span><span class="n">bytesum</span><span class="o">;</span>

  <span class="c">(* add to summary data *)</span>
  <span class="n">sumcount</span> <span class="o">:=</span> <span class="o">!</span><span class="n">sumcount</span> <span class="o">+</span> <span class="o">!</span><span class="n">count</span><span class="o">;</span>
  <span class="n">bytesumsum</span> <span class="o">:=</span> <span class="nn">Int32</span><span class="p">.</span><span class="n">add</span> <span class="o">!</span><span class="n">bytesumsum</span> <span class="o">!</span><span class="n">bytesum</span><span class="o">;</span>
  <span class="n">allposts</span> <span class="o">:=</span> <span class="o">!</span><span class="n">allposts</span> <span class="o">+</span> <span class="o">!</span><span class="n">posts</span><span class="o">;</span>
  <span class="n">allhomes</span> <span class="o">:=</span> <span class="o">!</span><span class="n">allhomes</span> <span class="o">+</span> <span class="o">!</span><span class="n">homes</span><span class="o">;</span>

  <span class="c">(* reset daily data *)</span>
  <span class="n">count</span> <span class="o">:=</span> <span class="mi">0</span><span class="o">;</span>
  <span class="n">posts</span> <span class="o">:=</span> <span class="mi">0</span><span class="o">;</span>
  <span class="n">homes</span> <span class="o">:=</span> <span class="mi">0</span><span class="o">;</span>
  <span class="n">bytesum</span> <span class="o">:=</span> <span class="mi">0</span><span class="n">l</span><span class="o">;</span>
  <span class="n">add_hash</span> <span class="o">!</span><span class="n">allhosts</span> <span class="o">!</span><span class="n">hosts</span><span class="o">;</span>
  <span class="n">add_hash</span> <span class="o">!</span><span class="n">allwhats</span> <span class="o">!</span><span class="n">whats</span><span class="o">;</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">clear</span> <span class="o">!</span><span class="n">hosts</span><span class="o">;</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">clear</span> <span class="o">!</span><span class="n">whats</span>

<span class="c">(* read log file and tally hits from the host and to the URL *)</span>
<span class="k">let</span> <span class="n">daily_logs</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">log</span> <span class="o">=</span> <span class="n">import_file</span> <span class="n">file</span> <span class="k">in</span>
  <span class="n">print_endline</span>
    <span class="s2">&quot;    Date     Hosts  Accesses  Unidocs   POST    Home       Bytes&quot;</span><span class="o">;</span>
  <span class="n">print_endline</span>
    <span class="s2">&quot;----------- ------- -------- -------- ------- ------- --------------&quot;</span><span class="o">;</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">row</span> <span class="o">-&gt;</span>
       <span class="k">let</span> <span class="n">date</span> <span class="o">=</span> <span class="n">format_date</span> <span class="n">row</span><span class="o">.</span><span class="n">t</span> <span class="k">in</span>
       <span class="k">let</span> <span class="n">host</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">src_ip</span> <span class="k">in</span>
       <span class="k">let</span> <span class="n">what</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">url</span> <span class="k">in</span>
       <span class="k">let</span> <span class="n">post</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">http_method</span> <span class="o">=</span> <span class="nc">POST</span> <span class="k">in</span>
       <span class="k">let</span> <span class="n">home</span> <span class="o">=</span> <span class="n">what</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span> <span class="k">in</span>
       <span class="k">let</span> <span class="n">bytes</span> <span class="o">=</span> <span class="k">match</span> <span class="n">row</span><span class="o">.</span><span class="n">size</span> <span class="k">with</span> <span class="nc">Some</span> <span class="n">n</span> <span class="o">-&gt;</span> <span class="n">n</span> <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="mi">0</span> <span class="k">in</span>
       <span class="k">if</span> <span class="o">!</span><span class="n">lastdate</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">then</span> <span class="n">lastdate</span> <span class="o">:=</span> <span class="n">date</span><span class="o">;</span>
       <span class="k">if</span> <span class="o">!</span><span class="n">lastdate</span> <span class="o">&lt;&gt;</span> <span class="n">date</span> <span class="k">then</span> <span class="n">write_report</span> <span class="bp">()</span><span class="o">;</span>
       <span class="n">lastdate</span> <span class="o">:=</span> <span class="n">date</span><span class="o">;</span>
       <span class="n">incr</span> <span class="n">count</span><span class="o">;</span>
       <span class="k">if</span> <span class="n">post</span> <span class="k">then</span> <span class="n">incr</span> <span class="n">posts</span><span class="o">;</span>
       <span class="k">if</span> <span class="n">home</span> <span class="k">then</span> <span class="n">incr</span> <span class="n">homes</span><span class="o">;</span>
       <span class="n">incr_hash</span> <span class="o">!</span><span class="n">hosts</span> <span class="n">host</span> <span class="mi">1</span><span class="o">;</span>
       <span class="n">incr_hash</span> <span class="o">!</span><span class="n">whats</span> <span class="n">what</span> <span class="mi">1</span><span class="o">;</span>
       <span class="n">bytesum</span> <span class="o">:=</span> <span class="nn">Int32</span><span class="p">.</span><span class="n">add</span> <span class="o">!</span><span class="n">bytesum</span> <span class="o">(</span><span class="nn">Int32</span><span class="p">.</span><span class="n">of_int</span> <span class="n">bytes</span><span class="o">))</span>
    <span class="n">log</span><span class="o">;</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="n">write_report</span> <span class="bp">()</span>

<span class="k">let</span> <span class="n">summary</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">lastdate</span> <span class="o">:=</span> <span class="s2">&quot;Grand Total&quot;</span><span class="o">;</span>
  <span class="n">count</span> <span class="o">:=</span> <span class="o">!</span><span class="n">sumcount</span><span class="o">;</span>
  <span class="n">bytesum</span> <span class="o">:=</span> <span class="o">!</span><span class="n">bytesumsum</span><span class="o">;</span>
  <span class="n">hosts</span> <span class="o">:=</span> <span class="o">!</span><span class="n">allhosts</span><span class="o">;</span>
  <span class="n">posts</span> <span class="o">:=</span> <span class="o">!</span><span class="n">allposts</span><span class="o">;</span>
  <span class="n">whats</span> <span class="o">:=</span> <span class="o">!</span><span class="n">allwhats</span><span class="o">;</span>
  <span class="n">homes</span> <span class="o">:=</span> <span class="o">!</span><span class="n">allhomes</span><span class="o">;</span>
  <span class="n">write_report</span> <span class="bp">()</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">daily_logs</span> <span class="bp">()</span><span class="o">;</span>
  <span class="n">summary</span> <span class="bp">()</span><span class="o">;</span>
  <span class="n">exit</span> <span class="mi">0</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* aprept - report on Apache logs *)</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;weblogs&quot;</span><span class="o">;;</span>

<span class="k">open</span> <span class="nc">Weblogs</span>

<span class="k">let</span> <span class="n">file</span> <span class="o">=</span>
  <span class="k">if</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="o">=</span> <span class="mi">2</span>
  <span class="k">then</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span>
  <span class="k">else</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;usage: %s &lt;logfile&gt;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">);</span>
        <span class="n">exit</span> <span class="mi">1</span><span class="o">)</span>

<span class="k">let</span> <span class="n">log</span> <span class="o">=</span> <span class="n">import_file</span> <span class="n">file</span>
<span class="k">let</span> <span class="n">conn</span> <span class="o">=</span> <span class="nn">HostIP</span><span class="p">.</span><span class="n">connection</span> <span class="bp">()</span>

<span class="k">let</span> <span class="n">incr_hash</span> <span class="n">hash</span> <span class="n">key</span> <span class="n">by</span> <span class="o">=</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">hash</span> <span class="n">key</span>
    <span class="o">(</span><span class="k">try</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">hash</span> <span class="n">key</span> <span class="o">+</span> <span class="n">by</span>
     <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="n">by</span><span class="o">)</span>

<span class="k">let</span> <span class="n">report_countries</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">total</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">countries</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">row</span> <span class="o">-&gt;</span>
       <span class="k">let</span> <span class="n">country</span> <span class="o">=</span>
         <span class="k">match</span> <span class="nn">HostIP</span><span class="p">.</span><span class="n">get_country_name</span> <span class="n">conn</span> <span class="n">row</span><span class="o">.</span><span class="n">src_ip</span> <span class="k">with</span>
           <span class="o">|</span> <span class="nc">Some</span> <span class="n">country</span> <span class="o">-&gt;</span> <span class="n">country</span>
           <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="s2">&quot;UNKNOWN&quot;</span> <span class="k">in</span>
       <span class="n">incr_hash</span> <span class="n">countries</span> <span class="n">country</span> <span class="mi">1</span><span class="o">;</span>
       <span class="n">incr</span> <span class="n">total</span><span class="o">)</span>
    <span class="n">log</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">country_records</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">country</span> <span class="n">count</span> <span class="o">-&gt;</span>
       <span class="n">country_records</span> <span class="o">:=</span> <span class="o">(</span><span class="n">count</span><span class="o">,</span> <span class="n">country</span><span class="o">)</span> <span class="o">::</span> <span class="o">!</span><span class="n">country_records</span><span class="o">)</span>
    <span class="n">countries</span><span class="o">;</span>
  <span class="n">print_endline</span> <span class="s2">&quot;Domain                  Records&quot;</span><span class="o">;</span>
  <span class="n">print_endline</span> <span class="s2">&quot;===============================&quot;</span><span class="o">;</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">count</span><span class="o">,</span> <span class="n">country</span><span class="o">)</span> <span class="o">-&gt;</span>
       <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%18s %5d %5.2f%%</span><span class="se">\n</span><span class="s2">%!&quot;</span>
         <span class="n">country</span> <span class="n">count</span> <span class="o">(</span><span class="kt">float</span> <span class="n">count</span> <span class="o">*.</span> <span class="mi">100</span><span class="o">.</span> <span class="o">/.</span> <span class="kt">float</span> <span class="o">!</span><span class="n">total</span><span class="o">))</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">sort</span> <span class="n">compare</span> <span class="o">!</span><span class="n">country_records</span><span class="o">))</span>

<span class="k">let</span> <span class="n">report_files</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">total</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">totalbytes</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span><span class="n">l</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">bytes</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">records</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">row</span> <span class="o">-&gt;</span>
       <span class="k">let</span> <span class="n">file</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">url</span> <span class="k">in</span>
       <span class="k">let</span> <span class="n">size</span> <span class="o">=</span> <span class="k">match</span> <span class="n">row</span><span class="o">.</span><span class="n">size</span> <span class="k">with</span> <span class="nc">Some</span> <span class="n">n</span> <span class="o">-&gt;</span> <span class="n">n</span> <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="mi">0</span> <span class="k">in</span>
       <span class="n">incr_hash</span> <span class="n">bytes</span> <span class="n">file</span> <span class="n">size</span><span class="o">;</span>
       <span class="n">incr_hash</span> <span class="n">records</span> <span class="n">file</span> <span class="mi">1</span><span class="o">;</span>
       <span class="n">totalbytes</span> <span class="o">:=</span> <span class="nn">Int32</span><span class="p">.</span><span class="n">add</span> <span class="o">!</span><span class="n">totalbytes</span> <span class="o">(</span><span class="nn">Int32</span><span class="p">.</span><span class="n">of_int</span> <span class="n">size</span><span class="o">);</span>
       <span class="n">incr</span> <span class="n">total</span><span class="o">)</span>
    <span class="n">log</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">file_records</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">file</span> <span class="n">size</span> <span class="o">-&gt;</span>
       <span class="k">let</span> <span class="n">count</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">records</span> <span class="n">file</span> <span class="k">in</span>
       <span class="n">file_records</span> <span class="o">:=</span> <span class="o">(</span><span class="n">file</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="n">count</span><span class="o">)</span> <span class="o">::</span> <span class="o">!</span><span class="n">file_records</span><span class="o">)</span>
    <span class="n">bytes</span><span class="o">;</span>
  <span class="n">print_endline</span>
    <span class="s2">&quot;File                               Bytes          Records&quot;</span><span class="o">;</span>
  <span class="n">print_endline</span>
    <span class="s2">&quot;=========================================================&quot;</span><span class="o">;</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">file</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="n">count</span><span class="o">)</span> <span class="o">-&gt;</span>
       <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%-22s %10d %5.2f%% %9d %5.2f%%</span><span class="se">\n</span><span class="s2">%!&quot;</span>
         <span class="n">file</span> <span class="n">size</span>
         <span class="o">(</span><span class="kt">float</span> <span class="n">size</span> <span class="o">*.</span> <span class="mi">100</span><span class="o">.</span> <span class="o">/.</span> <span class="nn">Int32</span><span class="p">.</span><span class="n">to_float</span> <span class="o">!</span><span class="n">totalbytes</span><span class="o">)</span>
         <span class="n">count</span>
         <span class="o">(</span><span class="kt">float</span> <span class="n">count</span> <span class="o">*.</span> <span class="mi">100</span><span class="o">.</span> <span class="o">/.</span> <span class="kt">float</span> <span class="o">!</span><span class="n">total</span><span class="o">))</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">sort</span> <span class="n">compare</span> <span class="o">!</span><span class="n">file_records</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">report_countries</span> <span class="bp">()</span><span class="o">;</span>
  <span class="n">print_newline</span> <span class="bp">()</span><span class="o">;</span>
  <span class="n">report_files</span> <span class="bp">()</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1096"
>Program: htmlsub</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* htmlsub - make substitutions in normal text of HTML files *)</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;str&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netstring&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">usage</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Usage: %s &lt;from&gt; &lt;to&gt; &lt;file&gt;...</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">);</span>
  <span class="n">exit</span> <span class="mi">1</span>

<span class="k">let</span> <span class="n">from</span><span class="o">,</span> <span class="k">to&#39;</span><span class="o">,</span> <span class="n">files</span> <span class="o">=</span>
  <span class="k">match</span> <span class="nn">List</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">)</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">from</span> <span class="o">::</span> <span class="k">to&#39;</span> <span class="o">::</span> <span class="n">files</span> <span class="o">-&gt;</span> <span class="n">from</span><span class="o">,</span> <span class="k">to&#39;</span><span class="o">,</span> <span class="n">files</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">usage</span> <span class="bp">()</span>

<span class="k">let</span> <span class="k">rec</span> <span class="n">map_data</span> <span class="n">f</span> <span class="o">=</span> <span class="k">function</span>
  <span class="o">|</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="n">data</span> <span class="o">-&gt;</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="o">(</span><span class="n">f</span> <span class="n">data</span><span class="o">)</span>
  <span class="o">|</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span> <span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">attribs</span><span class="o">,</span> <span class="n">children</span><span class="o">)</span> <span class="o">-&gt;</span>
      <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span> <span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">attribs</span><span class="o">,</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="n">map_data</span> <span class="n">f</span><span class="o">)</span> <span class="n">children</span><span class="o">)</span>

<span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp_string</span> <span class="n">from</span>
<span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span>
<span class="k">let</span> <span class="n">out_channel</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">output_buffer</span> <span class="n">buffer</span>
<span class="k">let</span> <span class="n">write</span> <span class="n">html</span> <span class="o">=</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="n">write</span> <span class="n">out_channel</span> <span class="o">(</span><span class="nn">Nethtml</span><span class="p">.</span><span class="n">encode</span> <span class="n">html</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">file</span> <span class="o">-&gt;</span>
       <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">input_channel</span> <span class="o">(</span><span class="n">open_in</span> <span class="n">file</span><span class="o">)</span> <span class="k">in</span>
       <span class="k">let</span> <span class="n">html</span> <span class="o">=</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="n">decode</span> <span class="o">(</span><span class="nn">Nethtml</span><span class="p">.</span><span class="n">parse</span> <span class="n">in_channel</span><span class="o">)</span> <span class="k">in</span>
       <span class="n">in_channel</span><span class="o">#</span><span class="n">close_in</span> <span class="bp">()</span><span class="o">;</span>
       <span class="n">write</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="n">map_data</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">global_replace</span> <span class="n">regexp</span> <span class="k">to&#39;</span><span class="o">))</span> <span class="n">html</span><span class="o">))</span>
    <span class="n">files</span><span class="o">;</span>
  <span class="n">print_endline</span> <span class="o">(</span><span class="nn">Buffer</span><span class="p">.</span><span class="n">contents</span> <span class="n">buffer</span><span class="o">)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1099"
>Program: hrefsub</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* hrefsub - make substitutions in &lt;A HREF=&quot;...&quot;&gt; fields of HTML files *)</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;str&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netstring&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">usage</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Usage: %s &lt;from&gt; &lt;to&gt; &lt;file&gt;...</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">);</span>
  <span class="n">exit</span> <span class="mi">1</span>

<span class="k">let</span> <span class="n">from</span><span class="o">,</span> <span class="k">to&#39;</span><span class="o">,</span> <span class="n">files</span> <span class="o">=</span>
  <span class="k">match</span> <span class="nn">List</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">)</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">from</span> <span class="o">::</span> <span class="k">to&#39;</span> <span class="o">::</span> <span class="n">files</span> <span class="o">-&gt;</span> <span class="n">from</span><span class="o">,</span> <span class="k">to&#39;</span><span class="o">,</span> <span class="n">files</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">usage</span> <span class="bp">()</span>

<span class="k">let</span> <span class="k">rec</span> <span class="n">map_attr</span> <span class="n">tag</span> <span class="n">attr</span> <span class="n">f</span> <span class="o">=</span> <span class="k">function</span>
  <span class="o">|</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="o">_</span> <span class="k">as</span> <span class="n">d</span> <span class="o">-&gt;</span> <span class="n">d</span>
  <span class="o">|</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span> <span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">attribs</span><span class="o">,</span> <span class="n">children</span><span class="o">)</span>
      <span class="k">when</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">name</span> <span class="o">&amp;&amp;</span> <span class="nn">List</span><span class="p">.</span><span class="n">mem_assoc</span> <span class="n">attr</span> <span class="n">attribs</span> <span class="o">-&gt;</span>
      <span class="k">let</span> <span class="k">value</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">assoc</span> <span class="n">attr</span> <span class="n">attribs</span> <span class="k">in</span>
      <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span> <span class="o">(</span><span class="n">name</span><span class="o">,</span>
                       <span class="o">(</span><span class="n">attr</span><span class="o">,</span> <span class="n">f</span> <span class="k">value</span><span class="o">)</span>
                       <span class="o">::</span> <span class="nn">List</span><span class="p">.</span><span class="n">remove_assoc</span> <span class="n">attr</span> <span class="n">attribs</span><span class="o">,</span>
                       <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="n">map_attr</span> <span class="n">tag</span> <span class="n">attr</span> <span class="n">f</span><span class="o">)</span> <span class="n">children</span><span class="o">)</span>
  <span class="o">|</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span> <span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">attribs</span><span class="o">,</span> <span class="n">children</span><span class="o">)</span> <span class="o">-&gt;</span>
      <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span> <span class="o">(</span><span class="n">name</span><span class="o">,</span>
                       <span class="n">attribs</span><span class="o">,</span>
                       <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="n">map_attr</span> <span class="n">tag</span> <span class="n">attr</span> <span class="n">f</span><span class="o">)</span> <span class="n">children</span><span class="o">)</span>

<span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp_string</span> <span class="n">from</span>
<span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span>
<span class="k">let</span> <span class="n">out_channel</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">output_buffer</span> <span class="n">buffer</span>
<span class="k">let</span> <span class="n">write</span> <span class="n">html</span> <span class="o">=</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="n">write</span> <span class="n">out_channel</span> <span class="o">(</span><span class="nn">Nethtml</span><span class="p">.</span><span class="n">encode</span> <span class="n">html</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">file</span> <span class="o">-&gt;</span>
       <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">input_channel</span> <span class="o">(</span><span class="n">open_in</span> <span class="n">file</span><span class="o">)</span> <span class="k">in</span>
       <span class="k">let</span> <span class="n">html</span> <span class="o">=</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="n">decode</span> <span class="o">(</span><span class="nn">Nethtml</span><span class="p">.</span><span class="n">parse</span> <span class="n">in_channel</span><span class="o">)</span> <span class="k">in</span>
       <span class="n">in_channel</span><span class="o">#</span><span class="n">close_in</span> <span class="bp">()</span><span class="o">;</span>
       <span class="n">write</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="n">map_attr</span> <span class="s2">&quot;a&quot;</span> <span class="s2">&quot;href&quot;</span>
                          <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">global_replace</span> <span class="n">regexp</span> <span class="k">to&#39;</span><span class="o">))</span> <span class="n">html</span><span class="o">))</span>
    <span class="n">files</span><span class="o">;</span>
  <span class="n">print_endline</span> <span class="o">(</span><span class="nn">Buffer</span><span class="p">.</span><span class="n">contents</span> <span class="n">buffer</span><span class="o">)</span>
</pre></div>
</body>
</html></PRE
></TD
></TR
></TABLE
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="cgiprogramming.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="a1102.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>CGI Programming</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
>&nbsp;</TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Helpers</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>
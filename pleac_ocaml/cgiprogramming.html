<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN""http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>CGI Programming</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="PLEAC-Objective CAML "
HREF="index.html"><LINK
REL="PREVIOUS"
TITLE="Internet Services"
HREF="internetservices.html"><LINK
REL="NEXT"
TITLE="Web Automation"
HREF="webautomation.html"><style type="text/css">td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
pre { line-height: 125%; }

  </style></head
><BODY TEXT="#cecece" BGCOLOR="#4f6f6f" LINK="#f5deb3" VLINK="#d5ae83"
CLASS="SECT1"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>PLEAC-Objective CAML </TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="internetservices.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
></TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="webautomation.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="CGIPROGRAMMING"
>19. CGI Programming</A
></H1
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1007"
>Introduction</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* If you&#39;ve never seen a URL before, here are a few examples. *)</span>
<span class="n">http</span><span class="o">://</span><span class="n">caml</span><span class="o">.</span><span class="n">inria</span><span class="o">.</span><span class="n">fr</span><span class="o">/</span>
<span class="n">http</span><span class="o">://</span><span class="n">www</span><span class="o">.</span><span class="n">ocaml</span><span class="o">-</span><span class="n">tutorial</span><span class="o">.</span><span class="n">org</span><span class="o">/</span>
<span class="n">http</span><span class="o">://</span><span class="n">en</span><span class="o">.</span><span class="n">wikipedia</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">wiki</span><span class="o">/</span><span class="nc">Ocaml</span>
<span class="n">http</span><span class="o">://</span><span class="n">pleac</span><span class="o">.</span><span class="n">sourceforge</span><span class="o">.</span><span class="n">net</span><span class="o">/</span><span class="n">pleac_ocaml</span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">html</span>

<span class="c">(* The URL for a form submission using the GET method will contain a</span>
<span class="c">   query string (the sequence of characters after the &#39;?&#39;) with named</span>
<span class="c">   parameters of the form: key1=value1&amp;key2=value2&amp;... *)</span>
<span class="n">http</span><span class="o">://</span><span class="n">caml</span><span class="o">.</span><span class="n">inria</span><span class="o">.</span><span class="n">fr</span><span class="o">/</span><span class="n">cgi</span><span class="o">-</span><span class="n">bin</span><span class="o">/</span><span class="n">search</span><span class="o">.</span><span class="n">en</span><span class="o">.</span><span class="n">cgi</span><span class="o">?</span><span class="n">corpus</span><span class="o">=</span><span class="n">hump</span><span class="o">&amp;</span><span class="n">words</span><span class="o">=</span><span class="n">cgi</span>

<span class="c">(* The URL for a form submission using POST will not usually contain</span>
<span class="c">   a query string, so it will appear cleaner. *)</span>
<span class="n">http</span><span class="o">://</span><span class="n">caml</span><span class="o">.</span><span class="n">inria</span><span class="o">.</span><span class="n">fr</span><span class="o">/</span><span class="n">cgi</span><span class="o">-</span><span class="n">bin</span><span class="o">/</span><span class="n">hump</span><span class="o">.</span><span class="n">cgi</span>

<span class="c">(* GET requests are assumed to be &quot;idempotent&quot;, meaning they can be</span>
<span class="c">   requested many times without any different effect than if they were</span>
<span class="c">   only requested once. This has the practical difference of making</span>
<span class="c">   GET requests easy to cache, and POST requests nearly impossible</span>
<span class="c">   (since there is no guarantee that a POST is non-destructive). It</span>
<span class="c">   is considered best practice to use POST, not GET, for side-effecting</span>
<span class="c">   operations such as deleting or modifying a record. *)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1010"
>Writing a CGI Script</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">env</span> <span class="n">ocaml</span>
<span class="c">(* hiweb - load CGI module to decode information given by web server *)</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>                        <span class="c">(* Findlib *)</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netcgi2&quot;</span><span class="o">;;</span>                    <span class="c">(* Ocamlnet *)</span>

<span class="c">(* Create an HTML escaping function for the UTF-8 encoding. *)</span>
<span class="k">let</span> <span class="n">escape_html</span> <span class="o">=</span> <span class="nn">Netencoding</span><span class="p">.</span><span class="nn">Html</span><span class="p">.</span><span class="n">encode</span> <span class="o">~</span><span class="n">in_enc</span><span class="o">:`</span><span class="nc">Enc_utf8</span> <span class="bp">()</span>

<span class="c">(* Construct the beginning of an (X)HTML document. *)</span>
<span class="k">let</span> <span class="n">start_html</span> <span class="n">title</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;\</span>
<span class="s2">&lt;!DOCTYPE html PUBLIC </span><span class="se">\&quot;</span><span class="s2">-//W3C//DTD XHTML 1.0 Transitional//EN</span><span class="se">\&quot;</span><span class="s2"> </span><span class="se">\&quot;</span><span class="s2">http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd</span><span class="se">\&quot;</span><span class="s2">&gt;</span>
<span class="s2">&lt;html xmlns=</span><span class="se">\&quot;</span><span class="s2">http://www.w3.org/1999/xhtml</span><span class="se">\&quot;</span><span class="s2">&gt;</span>
<span class="s2">    &lt;head&gt;</span>
<span class="s2">        &lt;title&gt;%s&lt;/title&gt;</span>
<span class="s2">        &lt;meta http-equiv=</span><span class="se">\&quot;</span><span class="s2">Content-Type</span><span class="se">\&quot;</span><span class="s2"> content=</span><span class="se">\&quot;</span><span class="s2">text/html; charset=UTF-8</span><span class="se">\&quot;</span><span class="s2"> /&gt;</span>
<span class="s2">    &lt;/head&gt;</span>
<span class="s2">    &lt;body&gt;</span>

<span class="s2">&quot;</span> <span class="o">(</span><span class="n">escape_html</span> <span class="n">title</span><span class="o">)</span>

<span class="c">(* Construct the end of an (X)HTML document. *)</span>
<span class="k">let</span> <span class="n">end_html</span> <span class="o">=</span> <span class="s2">&quot;</span>

<span class="s2">    &lt;/body&gt;</span>
<span class="s2">&lt;/html&gt;</span>
<span class="s2">&quot;</span>

<span class="c">(* Construct a few common elements. *)</span>
<span class="k">let</span> <span class="n">p</span> <span class="n">contents</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;&lt;p&gt;%s&lt;/p&gt;&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="n">contents</span><span class="o">)</span>
<span class="k">let</span> <span class="n">tt</span> <span class="n">contents</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;&lt;tt&gt;%s&lt;/tt&gt;&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="n">contents</span><span class="o">)</span>

<span class="c">(* Process a page request. *)</span>
<span class="k">let</span> <span class="n">process</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="o">=</span>
  <span class="c">(* Get a parameter from a form. *)</span>
  <span class="k">let</span> <span class="k">value</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;PARAM_NAME&quot;</span> <span class="k">in</span>

  <span class="c">(* Output a document. *)</span>
  <span class="k">let</span> <span class="n">out</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">output_string</span> <span class="k">in</span>
  <span class="n">out</span> <span class="o">(</span><span class="n">start_html</span> <span class="s2">&quot;Howdy there!&quot;</span><span class="o">);</span>
  <span class="n">out</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;You typed: &quot;</span><span class="o">;</span> <span class="n">tt</span> <span class="o">[</span><span class="n">escape_html</span> <span class="k">value</span><span class="o">]]);</span>
  <span class="n">out</span> <span class="n">end_html</span><span class="o">;</span>

  <span class="c">(* Flush the output buffer. *)</span>
  <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">commit_work</span> <span class="bp">()</span>

<span class="c">(* Initialize and run the Netcgi process. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">config</span> <span class="o">=</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">default_config</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">buffered</span> <span class="o">_</span> <span class="n">ch</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">buffered_trans_channel</span> <span class="n">ch</span> <span class="k">in</span>
  <span class="nn">Netcgi_cgi</span><span class="p">.</span><span class="n">run</span> <span class="o">~</span><span class="n">config</span> <span class="o">~</span><span class="n">output_type</span><span class="o">:(`</span><span class="nc">Transactional</span> <span class="n">buffered</span><span class="o">)</span> <span class="n">process</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Set the output mime-type and expiration time. *)</span>
<span class="n">cgi</span><span class="o">#</span><span class="n">set_header</span> <span class="o">~</span><span class="n">content_type</span><span class="o">:</span><span class="s2">&quot;text/html&quot;</span> <span class="o">~</span><span class="n">cache</span><span class="o">:(`</span><span class="nc">Max_age</span> <span class="mi">3600</span><span class="o">)</span> <span class="bp">()</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Read multiple form fields, one containing multiple values. *)</span>
<span class="k">let</span> <span class="n">who</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;Name&quot;</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">phone</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;Number&quot;</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">picks</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">map</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">arg</span> <span class="o">-&gt;</span> <span class="n">arg</span><span class="o">#</span><span class="k">value</span><span class="o">)</span>
    <span class="o">(</span><span class="n">cgi</span><span class="o">#</span><span class="n">multiple_argument</span> <span class="s2">&quot;Choices&quot;</span><span class="o">)</span> <span class="k">in</span>
<span class="c">(* ... *)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1013"
>Redirecting Error Messages</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* The default Netcgi configuration sends all exceptions to the browser</span>
<span class="c">   in nicely formatted error pages. This is helpful during development</span>
<span class="c">   but may be inappropriate for production. The exception pages can be</span>
<span class="c">   disabled by setting the &quot;default_exn_handler&quot; configuration field: *)</span>
<span class="k">let</span> <span class="n">config</span> <span class="o">=</span> <span class="o">{</span><span class="nn">Netcgi</span><span class="p">.</span><span class="n">default_config</span> <span class="k">with</span>
                <span class="nn">Netcgi</span><span class="p">.</span><span class="n">default_exn_handler</span><span class="o">=</span><span class="bp">false</span><span class="o">}</span>

<span class="c">(* Most web servers send standard error to the error log, which is</span>
<span class="c">   typically /var/log/apache2/error.log for a default Apache 2</span>
<span class="c">   configuration. You can define a &quot;warn&quot; function to include the</span>
<span class="c">   script name in warning messages: *)</span>
<span class="k">let</span> <span class="n">warn</span> <span class="o">=</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">Filename</span><span class="p">.</span><span class="n">basename</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">))</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">warn</span> <span class="s2">&quot;This goes to the error log.&quot;</span>

<span class="c">(* You can also use Printf.kprintf to define a fancier warning function</span>
<span class="c">   that supports Printf formatting. *)</span>
<span class="k">let</span> <span class="n">warn</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">kprintf</span>
    <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">Filename</span><span class="p">.</span><span class="n">basename</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">)))</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">warn</span> <span class="s2">&quot;So does %s.&quot;</span> <span class="s2">&quot;this&quot;</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1016"
>Fixing a 500 Server Error</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">env</span> <span class="n">ocaml</span>
<span class="c">(* webwhoami - show web users id *)</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netcgi2&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;unix&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">process</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="o">=</span>
  <span class="n">cgi</span><span class="o">#</span><span class="n">set_header</span> <span class="o">~</span><span class="n">content_type</span><span class="o">:</span><span class="s2">&quot;text/plain&quot;</span> <span class="bp">()</span><span class="o">;</span>
  <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">output_string</span>
    <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;Running as %s</span><span class="se">\n</span><span class="s2">&quot;</span>
       <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">getpwuid</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">geteuid</span> <span class="bp">()</span><span class="o">)).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">pw_name</span><span class="o">);</span>
  <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">commit_work</span> <span class="bp">()</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">config</span> <span class="o">=</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">default_config</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">buffered</span> <span class="o">_</span> <span class="n">ch</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">buffered_trans_channel</span> <span class="n">ch</span> <span class="k">in</span>
  <span class="nn">Netcgi_cgi</span><span class="p">.</span><span class="n">run</span> <span class="o">~</span><span class="n">config</span> <span class="o">~</span><span class="n">output_type</span><span class="o">:(`</span><span class="nc">Transactional</span> <span class="n">buffered</span><span class="o">)</span> <span class="n">process</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* By using Netcgi_test.run instead of Netcgi_run, you can enable a</span>
<span class="c">   command-line testing mechanism. *)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">config</span> <span class="o">=</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">default_config</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">buffered</span> <span class="o">_</span> <span class="n">ch</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">buffered_trans_channel</span> <span class="n">ch</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">output_type</span> <span class="o">=</span> <span class="o">`</span><span class="nc">Transactional</span> <span class="n">buffered</span> <span class="k">in</span>
  <span class="k">if</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">isatty</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span>
  <span class="k">then</span> <span class="nn">Netcgi_test</span><span class="p">.</span><span class="n">run</span> <span class="o">~</span><span class="n">config</span> <span class="o">~</span><span class="n">output_type</span> <span class="n">process</span>
  <span class="k">else</span> <span class="nn">Netcgi_cgi</span><span class="p">.</span><span class="n">run</span> <span class="o">~</span><span class="n">config</span> <span class="o">~</span><span class="n">output_type</span> <span class="n">process</span>

<span class="c">(* Now, you can run the CGI script from the command line to test for</span>
<span class="c">   compilation and runtime errors. *)</span>
<span class="o">$</span> <span class="o">./</span><span class="n">webwhoami</span> <span class="o">-</span><span class="n">help</span>
<span class="n">ocaml</span> <span class="o">[</span><span class="n">options</span><span class="o">]</span> <span class="n">name1</span><span class="o">=</span><span class="n">value1</span> <span class="o">...</span> <span class="n">nameN</span><span class="o">=</span><span class="n">valueN</span>
  <span class="o">-</span><span class="n">get</span>               <span class="nc">Set</span> <span class="n">the</span> <span class="k">method</span> <span class="k">to</span> <span class="nc">GET</span> <span class="o">(</span><span class="n">the</span> <span class="n">default</span><span class="o">)</span>
  <span class="o">-</span><span class="n">head</span>              <span class="nc">Set</span> <span class="n">the</span> <span class="k">method</span> <span class="k">to</span> <span class="nc">HEAD</span>
  <span class="o">-</span><span class="n">post</span>              <span class="nc">Set</span> <span class="n">the</span> <span class="k">method</span> <span class="k">to</span> <span class="nc">POST</span>
  <span class="o">-</span><span class="n">put</span> <span class="n">file</span>          <span class="nc">Set</span> <span class="n">the</span> <span class="k">method</span> <span class="k">to</span> <span class="nc">PUT</span> <span class="k">with</span> <span class="n">the</span> <span class="n">file</span> <span class="k">as</span> <span class="n">argument</span>
  <span class="o">-</span><span class="n">delete</span>            <span class="nc">Set</span> <span class="n">the</span> <span class="k">method</span> <span class="k">to</span> <span class="nc">DELETE</span>
  <span class="o">-</span><span class="n">mimetype</span> <span class="k">type</span>     <span class="nc">Set</span> <span class="n">the</span> <span class="nc">MIME</span> <span class="k">type</span> <span class="k">for</span> <span class="n">the</span> <span class="n">next</span> <span class="n">file</span> <span class="n">argument</span><span class="o">(</span><span class="n">s</span><span class="o">)</span> <span class="o">(</span><span class="n">default</span><span class="o">:</span> <span class="n">text</span><span class="o">/</span><span class="n">plain</span><span class="o">)</span>
  <span class="o">-</span><span class="n">filename</span> <span class="n">path</span>     <span class="nc">Set</span> <span class="n">the</span> <span class="n">filename</span> <span class="n">property</span> <span class="k">for</span> <span class="n">the</span> <span class="n">next</span> <span class="n">file</span> <span class="n">argument</span><span class="o">(</span><span class="n">s</span><span class="o">)</span>
  <span class="o">-</span><span class="n">filearg</span> <span class="n">name</span><span class="o">=</span><span class="n">file</span> <span class="nc">Specify</span> <span class="n">a</span> <span class="n">file</span> <span class="n">argument</span> <span class="n">whose</span> <span class="n">contents</span> <span class="n">are</span> <span class="k">in</span> <span class="n">the</span> <span class="n">file</span>
  <span class="o">-</span><span class="n">user</span> <span class="n">name</span>         <span class="nc">Set</span> <span class="nc">REMOTE_USER</span> <span class="k">to</span> <span class="n">this</span> <span class="n">name</span>
  <span class="o">-</span><span class="n">prop</span> <span class="n">name</span><span class="o">=</span><span class="k">value</span>   <span class="nc">Set</span> <span class="n">the</span> <span class="n">environment</span> <span class="n">property</span>
  <span class="o">-</span><span class="n">header</span> <span class="n">name</span><span class="o">=</span><span class="k">value</span> <span class="nc">Set</span> <span class="n">the</span> <span class="n">request</span> <span class="n">header</span> <span class="n">field</span>
  <span class="o">-</span><span class="n">o</span> <span class="n">file</span>            <span class="nc">Set</span> <span class="n">the</span> <span class="n">output</span> <span class="n">file</span> <span class="o">(</span><span class="n">default</span><span class="o">:</span> <span class="n">stdout</span><span class="o">)</span>
  <span class="o">-</span><span class="n">help</span>              <span class="nc">Display</span> <span class="n">this</span> <span class="kt">list</span> <span class="k">of</span> <span class="n">options</span>
  <span class="o">--</span><span class="n">help</span>             <span class="nc">Display</span> <span class="n">this</span> <span class="kt">list</span> <span class="k">of</span> <span class="n">options</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1019"
>Writing a Safe CGI Program</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* There is no feature in OCaml resembling Perl&#39;s &quot;taint mode&quot;. *)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1022"
>Making CGI Scripts Efficient</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* Ocamlnet provides an Apache 2 module called netcgi_apache that allows</span>
<span class="c">   Netcgi scripts to run inside the Apache process. To load the module,</span>
<span class="c">   put something like the following in your Apache configuration file: *)</span>

<span class="nc">LoadModule</span> <span class="n">netcgi_module</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">apache2</span><span class="o">/</span><span class="n">modules</span><span class="o">/</span><span class="n">mod_netcgi_apache</span><span class="o">.</span><span class="n">so</span>
<span class="nc">NetcgiLoad</span> <span class="n">pcre</span><span class="o">/</span><span class="n">pcre</span><span class="o">.</span><span class="n">cma</span>
<span class="nc">NetcgiLoad</span> <span class="n">netsys</span><span class="o">/</span><span class="n">netsys</span><span class="o">.</span><span class="n">cma</span>
<span class="nc">NetcgiLoad</span> <span class="n">netstring</span><span class="o">/</span><span class="n">netstring</span><span class="o">.</span><span class="n">cma</span>
<span class="nc">NetcgiLoad</span> <span class="n">str</span><span class="o">.</span><span class="n">cma</span>
<span class="nc">NetcgiLoad</span> <span class="n">netcgi2</span><span class="o">/</span><span class="n">netcgi</span><span class="o">.</span><span class="n">cma</span>
<span class="nc">NetcgiLoad</span> <span class="n">netcgi_apache</span><span class="o">/</span><span class="n">netcgi_apache</span><span class="o">.</span><span class="n">cma</span>

<span class="c">(* Extra libraries can be added with additional &quot;NetcgiLoad&quot; directives.</span>
<span class="c">   The following will enable netcgi_apache for *.cma files: *)</span>

<span class="nc">NetcgiHandler</span> <span class="nn">Netcgi_apache</span><span class="p">.</span><span class="n">bytecode</span>
<span class="nc">AddHandler</span> <span class="n">ocaml</span><span class="o">-</span><span class="n">bytecode</span> <span class="o">.</span><span class="n">cma</span>

<span class="c">(* Or, if you prefer, you can enable netcgi_apache for a directory: *)</span>

<span class="o">&lt;</span><span class="nc">Location</span> <span class="o">/</span><span class="n">caml</span><span class="o">-</span><span class="n">bin</span><span class="o">&gt;</span>
  <span class="nc">SetHandler</span> <span class="n">ocaml</span><span class="o">-</span><span class="n">bytecode</span>
  <span class="nc">NetcgiHandler</span> <span class="nn">Netcgi_apache</span><span class="p">.</span><span class="n">bytecode</span>
  <span class="nc">Options</span> <span class="nc">ExecCGI</span>
  <span class="nc">Allow</span> <span class="n">from</span> <span class="n">all</span>
<span class="o">&lt;/</span><span class="nc">Location</span><span class="o">&gt;</span>

<span class="c">(* Each script contains code similar to other Netcgi examples but uses</span>
<span class="c">   Netcgi_apache.run to run the process. *)</span>

<span class="k">let</span> <span class="n">process</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi_apache</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="o">=</span>
  <span class="n">cgi</span><span class="o">#</span><span class="n">set_header</span> <span class="o">~</span><span class="n">content_type</span><span class="o">:</span><span class="s2">&quot;text/html&quot;</span> <span class="bp">()</span><span class="o">;</span>
  <span class="c">(* ... *)</span>
  <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">commit_work</span> <span class="bp">()</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">config</span> <span class="o">=</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">default_config</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">buffered</span> <span class="o">_</span> <span class="n">ch</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">buffered_trans_channel</span> <span class="n">ch</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">output_type</span> <span class="o">=</span> <span class="o">`</span><span class="nc">Transactional</span> <span class="n">buffered</span> <span class="k">in</span>
  <span class="nn">Netcgi_apache</span><span class="p">.</span><span class="n">run</span> <span class="o">~</span><span class="n">config</span> <span class="o">~</span><span class="n">output_type</span> <span class="n">process</span>

<span class="c">(* Scripts need to be compiled into bytecode libraries before Apache can</span>
<span class="c">   execute them. If you have findlib installed, you can compile them as</span>
<span class="c">   follows: *)</span>

<span class="n">ocamlfind</span> <span class="n">ocamlc</span> <span class="o">-</span><span class="n">package</span> <span class="n">netcgi_apache</span> <span class="o">-</span><span class="n">c</span> <span class="n">myscript</span><span class="o">.</span><span class="n">ml</span>
<span class="n">ocamlfind</span> <span class="n">ocamlc</span> <span class="o">-</span><span class="n">a</span> <span class="o">-</span><span class="n">o</span> <span class="n">myscript</span><span class="o">.</span><span class="n">cma</span> <span class="n">myscript</span><span class="o">.</span><span class="n">cmo</span>

<span class="c">(* Here is a Makefile to automate the build process. *)</span>

<span class="nc">RESULTS</span> <span class="o">=</span> <span class="n">myscript</span><span class="o">.</span><span class="n">cma</span> <span class="n">another</span><span class="o">.</span><span class="n">cma</span>
<span class="nc">PACKS</span> <span class="o">=</span> <span class="n">netcgi_apache</span><span class="o">,</span><span class="n">anotherlib</span>

<span class="o">%.</span><span class="n">cmo</span> <span class="o">:</span> <span class="o">%.</span><span class="n">ml</span>
	<span class="n">ocamlfind</span> <span class="n">ocamlc</span> <span class="o">-</span><span class="n">package</span> <span class="o">$(</span><span class="nc">PACKS</span><span class="o">)</span> <span class="o">-</span><span class="n">c</span> <span class="o">$&lt;</span>

<span class="o">%.</span><span class="n">cma</span> <span class="o">:</span> <span class="o">%.</span><span class="n">cmo</span>
	<span class="n">ocamlfind</span> <span class="n">ocamlc</span> <span class="o">-</span><span class="n">a</span> <span class="o">-</span><span class="n">o</span> <span class="o">$@</span> <span class="o">$&lt;</span>

<span class="n">all</span><span class="o">:</span> <span class="o">$(</span><span class="nc">RESULTS</span><span class="o">)</span>

<span class="n">clean</span><span class="o">:</span>
	<span class="n">rm</span> <span class="o">-</span><span class="n">f</span> <span class="o">*.</span><span class="n">cma</span> <span class="o">*.</span><span class="n">cmi</span> <span class="o">*.</span><span class="n">cmo</span> <span class="o">$(</span><span class="nc">RESULTS</span><span class="o">)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1025"
>Executing Commands Without Shell Escapes</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* UNSAFE *)</span>
<span class="k">let</span> <span class="n">status</span> <span class="o">=</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">system</span>
    <span class="o">(</span><span class="n">command</span> <span class="o">^</span> <span class="s2">&quot; &quot;</span> <span class="o">^</span> <span class="n">input</span> <span class="o">^</span> <span class="s2">&quot; &quot;</span> <span class="o">^</span> <span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot; &quot;</span> <span class="n">files</span><span class="o">)</span>

<span class="c">(* safer *)</span>
<span class="k">let</span> <span class="n">pid</span> <span class="o">=</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">create_process</span> <span class="n">command</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">of_list</span> <span class="o">([</span><span class="n">command</span><span class="o">;</span> <span class="n">input</span><span class="o">]</span> <span class="o">@</span> <span class="n">files</span><span class="o">))</span>
    <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdout</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stderr</span>
<span class="k">let</span> <span class="o">_,</span> <span class="n">status</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">waitpid</span> <span class="bp">[]</span> <span class="n">pid</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1028"
>Formatting Lists and Tables with HTML Shortcuts</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="k">open</span> <span class="nc">Printf</span>

<span class="c">(* Define some HTML helper functions. *)</span>
<span class="k">let</span> <span class="n">ol</span> <span class="n">contents</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;ol&gt;%s&lt;/ol&gt;&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="n">contents</span><span class="o">)</span>
<span class="k">let</span> <span class="n">ul</span> <span class="n">contents</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;ul&gt;%s&lt;/ul&gt;&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="n">contents</span><span class="o">)</span>
<span class="k">let</span> <span class="n">li</span> <span class="o">?(</span><span class="n">typ</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="n">content</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">typ</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
  <span class="k">then</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;li&gt;%s&lt;/li&gt;&quot;</span> <span class="n">content</span>
  <span class="k">else</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;li type=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2">&gt;%s&lt;/li&gt;&quot;</span> <span class="n">typ</span> <span class="n">content</span>
<span class="k">let</span> <span class="n">tr</span> <span class="n">contents</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;tr&gt;%s&lt;/tr&gt;&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="n">contents</span><span class="o">)</span>
<span class="k">let</span> <span class="n">th</span> <span class="n">content</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;th&gt;%s&lt;/th&gt;&quot;</span> <span class="n">content</span>
<span class="k">let</span> <span class="n">td</span> <span class="n">content</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;td&gt;%s&lt;/td&gt;&quot;</span> <span class="n">content</span>

<span class="c">(* Main CGI process. *)</span>
<span class="k">let</span> <span class="n">process</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="o">=</span>

  <span class="c">(* Define a print function for convenience. *)</span>
  <span class="k">let</span> <span class="n">print</span> <span class="n">s</span> <span class="o">=</span>
    <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">output_string</span> <span class="n">s</span><span class="o">;</span>
    <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">output_string</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">in</span>

  <span class="c">(* Print a numbered list. *)</span>
  <span class="n">print</span> <span class="o">(</span><span class="n">ol</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">li</span> <span class="o">[</span><span class="s2">&quot;red&quot;</span><span class="o">;</span> <span class="s2">&quot;blue&quot;</span><span class="o">;</span> <span class="s2">&quot;green&quot;</span><span class="o">]));</span>

  <span class="c">(* Print a bulleted list. *)</span>
  <span class="k">let</span> <span class="n">names</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;Larry&quot;</span><span class="o">;</span> <span class="s2">&quot;Moe&quot;</span><span class="o">;</span> <span class="s2">&quot;Curly&quot;</span><span class="o">]</span> <span class="k">in</span>
  <span class="n">print</span> <span class="o">(</span><span class="n">ul</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="n">li</span> <span class="o">~</span><span class="n">typ</span><span class="o">:</span><span class="s2">&quot;disc&quot;</span><span class="o">)</span> <span class="n">names</span><span class="o">));</span>

  <span class="c">(* The &quot;li&quot; function gets applied to a single item. *)</span>
  <span class="n">print</span> <span class="o">(</span><span class="n">li</span> <span class="s2">&quot;alpha&quot;</span><span class="o">);</span>

  <span class="c">(* If there are multiple items, use List.map. *)</span>
  <span class="n">print</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot; &quot;</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">li</span> <span class="o">[</span><span class="s2">&quot;alpha&quot;</span><span class="o">;</span> <span class="s2">&quot;omega&quot;</span><span class="o">]));</span>

  <span class="c">(* Build a table of states and their cities. *)</span>
  <span class="k">let</span> <span class="o">(</span> <span class="o">=&gt;</span> <span class="o">)</span> <span class="n">k</span> <span class="n">v</span> <span class="o">=</span> <span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">state_cities</span> <span class="o">=</span>
    <span class="o">[</span>
      <span class="s2">&quot;Wisconsin&quot;</span>  <span class="o">=&gt;</span> <span class="o">[</span> <span class="s2">&quot;Superior&quot;</span><span class="o">;</span> <span class="s2">&quot;Lake Geneva&quot;</span><span class="o">;</span> <span class="s2">&quot;Madison&quot;</span> <span class="o">];</span>
      <span class="s2">&quot;Colorado&quot;</span>   <span class="o">=&gt;</span> <span class="o">[</span> <span class="s2">&quot;Denver&quot;</span><span class="o">;</span> <span class="s2">&quot;Fort Collins&quot;</span><span class="o">;</span> <span class="s2">&quot;Boulder&quot;</span> <span class="o">];</span>
      <span class="s2">&quot;Texas&quot;</span>      <span class="o">=&gt;</span> <span class="o">[</span> <span class="s2">&quot;Plano&quot;</span><span class="o">;</span> <span class="s2">&quot;Austin&quot;</span><span class="o">;</span> <span class="s2">&quot;Fort Stockton&quot;</span> <span class="o">];</span>
      <span class="s2">&quot;California&quot;</span> <span class="o">=&gt;</span> <span class="o">[</span> <span class="s2">&quot;Sebastopol&quot;</span><span class="o">;</span> <span class="s2">&quot;Santa Rosa&quot;</span><span class="o">;</span> <span class="s2">&quot;Berkeley&quot;</span> <span class="o">];</span>
    <span class="o">]</span> <span class="k">in</span>

  <span class="c">(* Print the table in sorted order. *)</span>
  <span class="n">print</span> <span class="s2">&quot;&lt;TABLE&gt; &lt;CAPTION&gt;Cities I Have Known&lt;/CAPTION&gt;&quot;</span><span class="o">;</span>
  <span class="n">print</span> <span class="o">(</span><span class="n">tr</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">th</span> <span class="o">[</span><span class="s2">&quot;State&quot;</span><span class="o">;</span> <span class="s2">&quot;Cities&quot;</span><span class="o">]));</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">state</span><span class="o">,</span> <span class="n">cities</span><span class="o">)</span> <span class="o">-&gt;</span>
       <span class="n">print</span> <span class="o">(</span><span class="n">tr</span> <span class="o">(</span><span class="n">th</span> <span class="n">state</span> <span class="o">::</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">td</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">sort</span> <span class="n">compare</span> <span class="n">cities</span><span class="o">))))</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">sort</span> <span class="n">compare</span> <span class="n">state_cities</span><span class="o">);</span>
  <span class="n">print</span> <span class="s2">&quot;&lt;/TABLE&gt;&quot;</span><span class="o">;</span>

  <span class="c">(* Flush the output buffer. *)</span>
  <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">commit_work</span> <span class="bp">()</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* salcheck - check for salaries *)</span>

<span class="c">(* Requires ocaml-mysql, available here:</span>
<span class="c">   http://raevnos.pennmush.org/code/ocaml-mysql/</span>

<span class="c">   For netcgi_apache, the following configuration directive is needed:</span>
<span class="c">   NetcgiLoad mysql/mysql.cma *)</span>

<span class="k">open</span> <span class="nc">Printf</span>

<span class="k">let</span> <span class="n">escape_html</span> <span class="o">=</span> <span class="nn">Netencoding</span><span class="p">.</span><span class="nn">Html</span><span class="p">.</span><span class="n">encode</span> <span class="o">~</span><span class="n">in_enc</span><span class="o">:`</span><span class="nc">Enc_utf8</span> <span class="bp">()</span>

<span class="k">let</span> <span class="n">start_html</span> <span class="n">title</span> <span class="o">=</span>
  <span class="n">sprintf</span> <span class="s2">&quot;\</span>
<span class="s2">&lt;!DOCTYPE html PUBLIC </span><span class="se">\&quot;</span><span class="s2">-//W3C//DTD XHTML 1.0 Transitional//EN</span><span class="se">\&quot;</span><span class="s2"> </span><span class="se">\&quot;</span><span class="s2">http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd</span><span class="se">\&quot;</span><span class="s2">&gt;</span>
<span class="s2">&lt;html xmlns=</span><span class="se">\&quot;</span><span class="s2">http://www.w3.org/1999/xhtml</span><span class="se">\&quot;</span><span class="s2">&gt;</span>
<span class="s2">    &lt;head&gt;</span>
<span class="s2">        &lt;title&gt;%s&lt;/title&gt;</span>
<span class="s2">        &lt;meta http-equiv=</span><span class="se">\&quot;</span><span class="s2">Content-Type</span><span class="se">\&quot;</span><span class="s2"> content=</span><span class="se">\&quot;</span><span class="s2">text/html; charset=UTF-8</span><span class="se">\&quot;</span><span class="s2"> /&gt;</span>
<span class="s2">    &lt;/head&gt;</span>
<span class="s2">    &lt;body&gt;</span>

<span class="s2">&quot;</span> <span class="o">(</span><span class="n">escape_html</span> <span class="n">title</span><span class="o">)</span>

<span class="k">let</span> <span class="n">end_html</span> <span class="o">=</span> <span class="s2">&quot;</span>

<span class="s2">    &lt;/body&gt;</span>
<span class="s2">&lt;/html&gt;</span>
<span class="s2">&quot;</span>

<span class="k">let</span> <span class="n">start_form</span> <span class="o">?(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="o">?(</span><span class="k">method&#39;</span><span class="o">=</span><span class="s2">&quot;get&quot;</span><span class="o">)</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">sprintf</span> <span class="s2">&quot;&lt;form action=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> method=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2">&gt;&quot;</span>
    <span class="o">(</span><span class="n">escape_html</span> <span class="n">action</span><span class="o">)</span> <span class="o">(</span><span class="n">escape_html</span> <span class="k">method&#39;</span><span class="o">)</span>
<span class="k">let</span> <span class="n">end_form</span> <span class="o">=</span> <span class="s2">&quot;&lt;/form&gt;&quot;</span>

<span class="k">let</span> <span class="n">p</span> <span class="n">contents</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;p&gt;%s&lt;/p&gt;&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="n">contents</span><span class="o">)</span>
<span class="k">let</span> <span class="n">h1</span> <span class="n">contents</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;h1&gt;%s&lt;/h1&gt;&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="n">contents</span><span class="o">)</span>

<span class="k">let</span> <span class="n">textfield</span> <span class="o">?(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="o">?(</span><span class="k">value</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">sprintf</span> <span class="s2">&quot;&lt;input type=</span><span class="se">\&quot;</span><span class="s2">text</span><span class="se">\&quot;</span><span class="s2"> name=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> value=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> /&gt;&quot;</span>
    <span class="o">(</span><span class="n">escape_html</span> <span class="n">name</span><span class="o">)</span> <span class="o">(</span><span class="n">escape_html</span> <span class="k">value</span><span class="o">)</span>

<span class="k">let</span> <span class="n">submit</span> <span class="o">?(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="o">?(</span><span class="k">value</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">sprintf</span> <span class="s2">&quot;&lt;input type=</span><span class="se">\&quot;</span><span class="s2">submit</span><span class="se">\&quot;</span><span class="s2"> name=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> value=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> /&gt;&quot;</span>
    <span class="o">(</span><span class="n">escape_html</span> <span class="n">name</span><span class="o">)</span> <span class="o">(</span><span class="n">escape_html</span> <span class="k">value</span><span class="o">)</span>

<span class="k">let</span> <span class="n">tr</span> <span class="n">contents</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;tr&gt;%s&lt;/tr&gt;&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="n">contents</span><span class="o">)</span>
<span class="k">let</span> <span class="n">td</span> <span class="n">content</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;td&gt;%s&lt;/td&gt;&quot;</span> <span class="n">content</span>

<span class="k">let</span> <span class="n">process</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">limit</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;LIMIT&quot;</span> <span class="k">in</span>

  <span class="n">cgi</span><span class="o">#</span><span class="n">set_header</span> <span class="o">~</span><span class="n">content_type</span><span class="o">:</span><span class="s2">&quot;text/html&quot;</span> <span class="bp">()</span><span class="o">;</span>

  <span class="k">let</span> <span class="n">print</span> <span class="n">s</span> <span class="o">=</span>
    <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">output_string</span> <span class="n">s</span><span class="o">;</span>
    <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">output_string</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">in</span>

  <span class="n">print</span> <span class="o">(</span><span class="n">start_html</span> <span class="s2">&quot;Salary Query&quot;</span><span class="o">);</span>
  <span class="n">print</span> <span class="o">(</span><span class="n">h1</span> <span class="o">[</span><span class="s2">&quot;Search&quot;</span><span class="o">]);</span>
  <span class="n">print</span> <span class="o">(</span><span class="n">start_form</span> <span class="bp">()</span><span class="o">);</span>
  <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;Enter minimum salary &quot;</span><span class="o">;</span>
            <span class="n">textfield</span> <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;LIMIT&quot;</span> <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="n">limit</span> <span class="bp">()</span><span class="o">]);</span>
  <span class="n">print</span> <span class="o">(</span><span class="n">submit</span> <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="s2">&quot;Submit&quot;</span> <span class="bp">()</span><span class="o">);</span>
  <span class="n">print</span> <span class="n">end_form</span><span class="o">;</span>

  <span class="k">if</span> <span class="n">limit</span> <span class="o">&lt;&gt;</span> <span class="s2">&quot;&quot;</span> <span class="k">then</span>
    <span class="k">begin</span>
      <span class="k">let</span> <span class="n">db</span> <span class="o">=</span>
        <span class="nn">Mysql</span><span class="p">.</span><span class="n">quick_connect</span>
          <span class="o">~</span><span class="n">user</span><span class="o">:</span><span class="s2">&quot;username&quot;</span>
          <span class="o">~</span><span class="n">password</span><span class="o">:</span><span class="s2">&quot;password&quot;</span>
          <span class="o">~</span><span class="n">database</span><span class="o">:</span><span class="s2">&quot;somedb&quot;</span>
          <span class="o">~</span><span class="n">host</span><span class="o">:</span><span class="s2">&quot;localhost&quot;</span>
          <span class="o">~</span><span class="n">port</span><span class="o">:</span><span class="mi">3306</span> <span class="bp">()</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">sql</span> <span class="o">=</span>
        <span class="n">sprintf</span> <span class="s2">&quot;</span>
<span class="s2">            SELECT name, salary</span>
<span class="s2">            FROM   employees</span>
<span class="s2">            WHERE  salary &gt; %s</span>
<span class="s2">        &quot;</span> <span class="o">(</span><span class="nn">Mysql</span><span class="p">.</span><span class="n">ml2float</span> <span class="o">(</span><span class="n">float_of_string</span> <span class="n">limit</span><span class="o">))</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">result</span> <span class="o">=</span> <span class="nn">Mysql</span><span class="p">.</span><span class="n">exec</span> <span class="n">db</span> <span class="n">sql</span> <span class="k">in</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">h1</span> <span class="o">[</span><span class="s2">&quot;Results&quot;</span><span class="o">]);</span>
      <span class="n">print</span> <span class="s2">&quot;&lt;table border=</span><span class="se">\&quot;</span><span class="s2">1</span><span class="se">\&quot;</span><span class="s2">&gt;&quot;</span><span class="o">;</span>
      <span class="n">print</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">(</span><span class="nn">Mysql</span><span class="p">.</span><span class="n">map</span> <span class="n">result</span>
                  <span class="o">(</span><span class="k">fun</span> <span class="n">values</span> <span class="o">-&gt;</span>
                     <span class="n">tr</span> <span class="o">[</span><span class="n">td</span> <span class="o">(</span><span class="n">escape_html</span>
                               <span class="o">(</span><span class="nn">Mysql</span><span class="p">.</span><span class="n">not_null</span>
                                  <span class="nn">Mysql</span><span class="p">.</span><span class="n">str2ml</span> <span class="n">values</span><span class="o">.(</span><span class="mi">0</span><span class="o">)));</span>
                         <span class="n">td</span> <span class="o">(</span><span class="n">sprintf</span> <span class="s2">&quot;%.2f&quot;</span>
                               <span class="o">(</span><span class="nn">Mysql</span><span class="p">.</span><span class="n">not_null</span>
                                  <span class="nn">Mysql</span><span class="p">.</span><span class="n">float2ml</span> <span class="n">values</span><span class="o">.(</span><span class="mi">1</span><span class="o">)))])));</span>
      <span class="n">print</span> <span class="s2">&quot;&lt;/table&gt;&quot;</span><span class="o">;</span>
      <span class="nn">Mysql</span><span class="p">.</span><span class="n">disconnect</span> <span class="n">db</span><span class="o">;</span>
    <span class="k">end</span><span class="o">;</span>

  <span class="n">print</span> <span class="n">end_html</span><span class="o">;</span>
  <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">commit_work</span> <span class="bp">()</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">buffered</span> <span class="o">_</span> <span class="n">ch</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">buffered_trans_channel</span> <span class="n">ch</span> <span class="k">in</span>
  <span class="nn">Netcgi_apache</span><span class="p">.</span><span class="n">run</span>
    <span class="o">~</span><span class="n">output_type</span><span class="o">:(`</span><span class="nc">Transactional</span> <span class="n">buffered</span><span class="o">)</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">cgi</span> <span class="o">-&gt;</span> <span class="n">process</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:&gt;</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">))</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1031"
>Redirecting to a Different Location</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="k">let</span> <span class="n">process</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://caml.inria.fr/cgi-bin/hump.cgi&quot;</span> <span class="k">in</span>
  <span class="n">cgi</span><span class="o">#</span><span class="n">set_redirection_header</span> <span class="n">url</span><span class="o">;</span>
  <span class="c">(* By default, the above will send a 302 Found. To instead send</span>
<span class="c">     a 301 Moved Permanently, use the following command. *)</span>
  <span class="n">cgi</span><span class="o">#</span><span class="n">set_header</span> <span class="o">~</span><span class="n">status</span><span class="o">:`</span><span class="nc">Moved_permanently</span> <span class="bp">()</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* oreobounce - set a cookie and redirect the browser *)</span>

<span class="k">let</span> <span class="n">process</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">oreo</span> <span class="o">=</span>
    <span class="nn">Netcgi_common</span><span class="p">.</span><span class="nn">Cookie</span><span class="p">.</span><span class="n">make</span>
      <span class="o">~</span><span class="n">max_age</span><span class="o">:(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">30</span> <span class="o">*</span> <span class="mi">3</span><span class="o">)</span>  <span class="c">(* 3 months *)</span>
      <span class="o">~</span><span class="n">domain</span><span class="o">:</span><span class="s2">&quot;.sourceforge.nett&quot;</span>
      <span class="s2">&quot;filling&quot;</span> <span class="s2">&quot;vanilla crme&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">whither</span> <span class="o">=</span> <span class="s2">&quot;http://somewhere.sourceforge.net/nonesuch.html&quot;</span> <span class="k">in</span>
  <span class="n">cgi</span><span class="o">#</span><span class="n">set_redirection_header</span> <span class="o">~</span><span class="n">set_cookies</span><span class="o">:[</span><span class="n">oreo</span><span class="o">]</span> <span class="n">whither</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">buffered</span> <span class="o">_</span> <span class="n">ch</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">buffered_trans_channel</span> <span class="n">ch</span> <span class="k">in</span>
  <span class="nn">Netcgi_apache</span><span class="p">.</span><span class="n">run</span>
    <span class="o">~</span><span class="n">output_type</span><span class="o">:(`</span><span class="nc">Transactional</span> <span class="n">buffered</span><span class="o">)</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">cgi</span> <span class="o">-&gt;</span> <span class="n">process</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:&gt;</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">))</span>

<span class="c">(*</span>
<span class="c">HTTP/1.1 302 Found</span>
<span class="c">Date: Thu, 06 Nov 2008 04:39:53 GMT</span>
<span class="c">Server: Apache/2.2.9 (Debian) Netcgi_apache/2.2.9 PHP/5.2.6-5 with Suhosin-Patch</span>
<span class="c">Set-Cookie: filling=vanilla%20cr%E8me;Version=1;Domain=.sourceforge.nt;Max-Age=7776000;Expires=Wed, 04 Feb 2009 04:39:55 +0000</span>
<span class="c">Location: http://somewhere.sourceforge.net/nonesuch.html</span>
<span class="c">Status: 302</span>
<span class="c">Transfer-Encoding: chunked</span>
<span class="c">Content-Type: text/html</span>
<span class="c">*)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* os_snipe - redirect to a Jargon File entry about current OS *)</span>

<span class="k">let</span> <span class="n">process</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">dir</span> <span class="o">=</span> <span class="s2">&quot;http://www.wins.uva.nl/%7Emes/jargon&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">page</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">cgi</span><span class="o">#</span><span class="n">environment</span><span class="o">#</span><span class="n">user_agent</span> <span class="k">with</span>
      <span class="o">|</span> <span class="n">s</span> <span class="k">when</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span>
            <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;.*Mac&quot;</span><span class="o">)</span> <span class="n">s</span> <span class="mi">0</span> <span class="o">-&gt;</span>
          <span class="s2">&quot;m/Macintrash.html&quot;</span>
      <span class="o">|</span> <span class="n">s</span> <span class="k">when</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span>
            <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;.*Win</span><span class="se">\\</span><span class="s2">(dows </span><span class="se">\\</span><span class="s2">)?NT&quot;</span><span class="o">)</span> <span class="n">s</span> <span class="mi">0</span> <span class="o">-&gt;</span>
          <span class="s2">&quot;e/evilandrude.html&quot;</span>
      <span class="o">|</span> <span class="n">s</span> <span class="k">when</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span>
            <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;.*</span><span class="se">\\</span><span class="s2">(Win</span><span class="se">\\</span><span class="s2">|MSIE</span><span class="se">\\</span><span class="s2">|WebTV</span><span class="se">\\</span><span class="s2">)&quot;</span><span class="o">)</span> <span class="n">s</span> <span class="mi">0</span> <span class="o">-&gt;</span>
          <span class="s2">&quot;m/MicroslothWindows.html&quot;</span>
      <span class="o">|</span> <span class="n">s</span> <span class="k">when</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span>
            <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;.*Linux&quot;</span><span class="o">)</span> <span class="n">s</span> <span class="mi">0</span> <span class="o">-&gt;</span>
          <span class="s2">&quot;l/Linux.html&quot;</span>
      <span class="o">|</span> <span class="n">s</span> <span class="k">when</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span>
            <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;.*HP-UX&quot;</span><span class="o">)</span> <span class="n">s</span> <span class="mi">0</span> <span class="o">-&gt;</span>
          <span class="s2">&quot;h/HP-SUX.html&quot;</span>
      <span class="o">|</span> <span class="n">s</span> <span class="k">when</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span>
            <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;.*SunOS&quot;</span><span class="o">)</span> <span class="n">s</span> <span class="mi">0</span> <span class="o">-&gt;</span>
          <span class="s2">&quot;s/ScumOS.html&quot;</span>
      <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span>
          <span class="s2">&quot;a/AppendixB.html&quot;</span> <span class="k">in</span>
  <span class="n">cgi</span><span class="o">#</span><span class="n">set_redirection_header</span> <span class="o">(</span><span class="n">dir</span> <span class="o">^</span> <span class="s2">&quot;/&quot;</span> <span class="o">^</span> <span class="n">page</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">buffered</span> <span class="o">_</span> <span class="n">ch</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">buffered_trans_channel</span> <span class="n">ch</span> <span class="k">in</span>
  <span class="nn">Netcgi_apache</span><span class="p">.</span><span class="n">run</span>
    <span class="o">~</span><span class="n">output_type</span><span class="o">:(`</span><span class="nc">Transactional</span> <span class="n">buffered</span><span class="o">)</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">cgi</span> <span class="o">-&gt;</span> <span class="n">process</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:&gt;</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">))</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">process</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="o">=</span>
  <span class="n">cgi</span><span class="o">#</span><span class="n">environment</span><span class="o">#</span><span class="n">set_status</span> <span class="o">`</span><span class="nc">No_content</span>

<span class="c">(*</span>
<span class="c">HTTP/1.1 204 No Content</span>
<span class="c">Date: Thu, 06 Nov 2008 05:25:46 GMT</span>
<span class="c">Server: Apache/2.2.9 (Debian) Netcgi_apache/2.2.9 PHP/5.2.6-5 with Suhosin-Patch</span>
<span class="c">Status: 204</span>
<span class="c">Content-Type: text/html</span>
<span class="c">*)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1034"
>Debugging the Raw HTTP Exchange</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* dummyhttpd - start an HTTP daemon and print what the client sends *)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">host</span> <span class="o">=</span> <span class="s2">&quot;localhost&quot;</span>
<span class="k">let</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">8989</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Please contact me at: http://%s:%d/</span><span class="se">\n</span><span class="s2">%!&quot;</span> <span class="n">host</span> <span class="n">port</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">addr</span> <span class="o">=</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">gethostbyname</span> <span class="n">host</span><span class="o">).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">h_addr_list</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">server</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">socket</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">PF_INET</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">SOCK_STREAM</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">setsockopt</span> <span class="n">server</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">SO_REUSEADDR</span> <span class="bp">true</span><span class="o">;</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">bind</span> <span class="n">server</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">ADDR_INET</span> <span class="o">(</span><span class="n">addr</span><span class="o">,</span> <span class="n">port</span><span class="o">));</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">listen</span> <span class="n">server</span> <span class="mi">10</span><span class="o">;</span>
  <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
    <span class="k">begin</span>
      <span class="k">let</span> <span class="n">client</span><span class="o">,</span> <span class="n">sockaddr</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">accept</span> <span class="n">server</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">in_channel_of_descr</span> <span class="n">client</span> <span class="k">in</span>
      <span class="k">try</span>
        <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
          <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">in_channel</span> <span class="k">in</span>
          <span class="n">print_endline</span> <span class="n">line</span>
        <span class="k">done</span>
      <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
        <span class="n">print_endline</span> <span class="s2">&quot;EOF&quot;</span><span class="o">;</span>
        <span class="n">close_in</span> <span class="n">in_channel</span>
    <span class="k">end</span>
  <span class="k">done</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1037"
>Managing Cookies</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* Read a cookie: *)</span>
<span class="nn">Netcgi_common</span><span class="p">.</span><span class="nn">Cookie</span><span class="p">.</span><span class="n">value</span> <span class="o">(</span><span class="n">cgi</span><span class="o">#</span><span class="n">environment</span><span class="o">#</span><span class="n">cookie</span> <span class="s2">&quot;preference name&quot;</span><span class="o">)</span>

<span class="c">(* Make a cookie: *)</span>
<span class="k">let</span> <span class="n">cookie</span> <span class="o">=</span>
  <span class="nn">Netcgi_common</span><span class="p">.</span><span class="nn">Cookie</span><span class="p">.</span><span class="n">make</span>
    <span class="o">~</span><span class="n">max_age</span><span class="o">:(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">365</span> <span class="o">*</span> <span class="mi">2</span><span class="o">)</span>  <span class="c">(* 2 years *)</span>
    <span class="s2">&quot;preference name&quot;</span>                  <span class="c">(* name *)</span>
    <span class="s2">&quot;whatever you&#39;d like&quot;</span>              <span class="c">(* value*)</span>

<span class="c">(* Write a cookie: *)</span>
<span class="n">cgi</span><span class="o">#</span><span class="n">set_header</span> <span class="o">~</span><span class="n">set_cookies</span><span class="o">:[</span><span class="n">cookie</span><span class="o">]</span> <span class="bp">()</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">env</span> <span class="n">ocaml</span>
<span class="c">(* ic_cookies - sample CGI script that uses a cookie *)</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netcgi2&quot;</span><span class="o">;;</span>

<span class="k">open</span> <span class="nc">Printf</span>

<span class="k">let</span> <span class="n">escape_html</span> <span class="o">=</span> <span class="nn">Netencoding</span><span class="p">.</span><span class="nn">Html</span><span class="p">.</span><span class="n">encode</span> <span class="o">~</span><span class="n">in_enc</span><span class="o">:`</span><span class="nc">Enc_utf8</span> <span class="bp">()</span>

<span class="k">let</span> <span class="n">start_html</span> <span class="n">title</span> <span class="o">=</span>
  <span class="n">sprintf</span> <span class="s2">&quot;\</span>
<span class="s2">&lt;!DOCTYPE html PUBLIC </span><span class="se">\&quot;</span><span class="s2">-//W3C//DTD XHTML 1.0 Transitional//EN</span><span class="se">\&quot;</span><span class="s2"> </span><span class="se">\&quot;</span><span class="s2">http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd</span><span class="se">\&quot;</span><span class="s2">&gt;</span>
<span class="s2">&lt;html xmlns=</span><span class="se">\&quot;</span><span class="s2">http://www.w3.org/1999/xhtml</span><span class="se">\&quot;</span><span class="s2">&gt;</span>
<span class="s2">    &lt;head&gt;</span>
<span class="s2">        &lt;title&gt;%s&lt;/title&gt;</span>
<span class="s2">        &lt;meta http-equiv=</span><span class="se">\&quot;</span><span class="s2">Content-Type</span><span class="se">\&quot;</span><span class="s2"> content=</span><span class="se">\&quot;</span><span class="s2">text/html; charset=UTF-8</span><span class="se">\&quot;</span><span class="s2"> /&gt;</span>
<span class="s2">    &lt;/head&gt;</span>
<span class="s2">    &lt;body&gt;</span>
<span class="s2">&quot;</span> <span class="o">(</span><span class="n">escape_html</span> <span class="n">title</span><span class="o">)</span>

<span class="k">let</span> <span class="n">end_html</span> <span class="o">=</span> <span class="s2">&quot;</span>
<span class="s2">    &lt;/body&gt;</span>
<span class="s2">&lt;/html&gt;</span>
<span class="s2">&quot;</span>

<span class="k">let</span> <span class="n">h1</span> <span class="n">contents</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;h1&gt;%s&lt;/h1&gt;&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="n">contents</span><span class="o">)</span>
<span class="k">let</span> <span class="n">hr</span> <span class="o">=</span> <span class="s2">&quot;&lt;hr /&gt;&quot;</span>
<span class="k">let</span> <span class="n">p</span> <span class="n">contents</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;p&gt;%s&lt;/p&gt;&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="n">contents</span><span class="o">)</span>

<span class="k">let</span> <span class="n">start_form</span> <span class="o">?(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="o">?(</span><span class="k">method&#39;</span><span class="o">=</span><span class="s2">&quot;get&quot;</span><span class="o">)</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">sprintf</span> <span class="s2">&quot;&lt;form action=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> method=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2">&gt;&quot;</span>
    <span class="o">(</span><span class="n">escape_html</span> <span class="n">action</span><span class="o">)</span> <span class="o">(</span><span class="n">escape_html</span> <span class="k">method&#39;</span><span class="o">)</span>
<span class="k">let</span> <span class="n">end_form</span> <span class="o">=</span> <span class="s2">&quot;&lt;/form&gt;&quot;</span>

<span class="k">let</span> <span class="n">textfield</span> <span class="o">?(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="o">?(</span><span class="k">value</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">sprintf</span> <span class="s2">&quot;&lt;input type=</span><span class="se">\&quot;</span><span class="s2">text</span><span class="se">\&quot;</span><span class="s2"> name=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> value=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> /&gt;&quot;</span>
    <span class="o">(</span><span class="n">escape_html</span> <span class="n">name</span><span class="o">)</span> <span class="o">(</span><span class="n">escape_html</span> <span class="k">value</span><span class="o">)</span>

<span class="k">let</span> <span class="n">process</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">cookname</span> <span class="o">=</span> <span class="s2">&quot;favorite ice cream&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">favorite</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;flavor&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">tasty</span> <span class="o">=</span>
    <span class="k">try</span> <span class="nn">Netcgi_common</span><span class="p">.</span><span class="nn">Cookie</span><span class="p">.</span><span class="n">value</span> <span class="o">(</span><span class="n">cgi</span><span class="o">#</span><span class="n">environment</span><span class="o">#</span><span class="n">cookie</span> <span class="n">cookname</span><span class="o">)</span>
    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="s2">&quot;mint&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">print</span> <span class="n">s</span> <span class="o">=</span>
    <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">output_string</span> <span class="n">s</span><span class="o">;</span>
    <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">output_string</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">in</span>

  <span class="n">cgi</span><span class="o">#</span><span class="n">set_header</span> <span class="o">~</span><span class="n">content_type</span><span class="o">:</span><span class="s2">&quot;text/html&quot;</span> <span class="bp">()</span><span class="o">;</span>
  <span class="k">if</span> <span class="n">favorite</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
  <span class="k">then</span>
    <span class="k">begin</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">start_html</span> <span class="s2">&quot;Ice Cookies&quot;</span><span class="o">);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">h1</span> <span class="o">[</span><span class="s2">&quot;Hello Ice Cream&quot;</span><span class="o">]);</span>
      <span class="n">print</span> <span class="n">hr</span><span class="o">;</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">start_form</span> <span class="o">~</span><span class="k">method&#39;</span><span class="o">:</span><span class="s2">&quot;post&quot;</span> <span class="bp">()</span><span class="o">);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;Please select a flavor: &quot;</span><span class="o">;</span>
                <span class="n">textfield</span> <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;flavor&quot;</span> <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="n">tasty</span> <span class="bp">()</span><span class="o">]);</span>
      <span class="n">print</span> <span class="n">end_form</span><span class="o">;</span>
      <span class="n">print</span> <span class="n">hr</span><span class="o">;</span>
      <span class="n">print</span> <span class="n">end_html</span><span class="o">;</span>
    <span class="k">end</span>
  <span class="k">else</span>
    <span class="k">begin</span>
      <span class="k">let</span> <span class="n">cookie</span> <span class="o">=</span>
        <span class="nn">Netcgi_common</span><span class="p">.</span><span class="nn">Cookie</span><span class="p">.</span><span class="n">make</span>
          <span class="o">~</span><span class="n">max_age</span><span class="o">:(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">365</span> <span class="o">*</span> <span class="mi">2</span><span class="o">)</span>  <span class="c">(* 2 years *)</span>
          <span class="n">cookname</span> <span class="n">favorite</span> <span class="k">in</span>
      <span class="n">cgi</span><span class="o">#</span><span class="n">set_header</span> <span class="o">~</span><span class="n">set_cookies</span><span class="o">:[</span><span class="n">cookie</span><span class="o">]</span> <span class="bp">()</span><span class="o">;</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">start_html</span> <span class="s2">&quot;Ice Cookies, #2&quot;</span><span class="o">);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">h1</span> <span class="o">[</span><span class="s2">&quot;Hello Ice Cream&quot;</span><span class="o">]);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;You chose as your favorite flavor `&quot;</span><span class="o">;</span>
                <span class="n">escape_html</span> <span class="n">favorite</span><span class="o">;</span> <span class="s2">&quot;&#39;.&quot;</span><span class="o">]);</span>
      <span class="n">print</span> <span class="n">end_html</span><span class="o">;</span>
    <span class="k">end</span><span class="o">;</span>
  <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">commit_work</span> <span class="bp">()</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">config</span> <span class="o">=</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">default_config</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">buffered</span> <span class="o">_</span> <span class="n">ch</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">buffered_trans_channel</span> <span class="n">ch</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">output_type</span> <span class="o">=</span> <span class="o">`</span><span class="nc">Transactional</span> <span class="n">buffered</span> <span class="k">in</span>
  <span class="k">if</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">isatty</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span>
  <span class="k">then</span> <span class="nn">Netcgi_test</span><span class="p">.</span><span class="n">run</span> <span class="o">~</span><span class="n">config</span> <span class="o">~</span><span class="n">output_type</span> <span class="n">process</span>
  <span class="k">else</span> <span class="nn">Netcgi_cgi</span><span class="p">.</span><span class="n">run</span> <span class="o">~</span><span class="n">config</span> <span class="o">~</span><span class="n">output_type</span> <span class="n">process</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1040"
>Creating Sticky Widgets</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">env</span> <span class="n">ocaml</span>
<span class="c">(* who.cgi - run who(1) on a user and format the results nicely *)</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netcgi2&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;str&quot;</span><span class="o">;;</span>

<span class="k">open</span> <span class="nc">Printf</span>

<span class="k">let</span> <span class="n">escape_html</span> <span class="o">=</span> <span class="nn">Netencoding</span><span class="p">.</span><span class="nn">Html</span><span class="p">.</span><span class="n">encode</span> <span class="o">~</span><span class="n">in_enc</span><span class="o">:`</span><span class="nc">Enc_utf8</span> <span class="bp">()</span>

<span class="k">let</span> <span class="n">start_html</span> <span class="n">title</span> <span class="o">=</span>
  <span class="n">sprintf</span> <span class="s2">&quot;\</span>
<span class="s2">&lt;!DOCTYPE html PUBLIC </span><span class="se">\&quot;</span><span class="s2">-//W3C//DTD XHTML 1.0 Transitional//EN</span><span class="se">\&quot;</span><span class="s2"> </span><span class="se">\&quot;</span><span class="s2">http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd</span><span class="se">\&quot;</span><span class="s2">&gt;</span>
<span class="s2">&lt;html xmlns=</span><span class="se">\&quot;</span><span class="s2">http://www.w3.org/1999/xhtml</span><span class="se">\&quot;</span><span class="s2">&gt;</span>
<span class="s2">    &lt;head&gt;</span>
<span class="s2">        &lt;title&gt;%s&lt;/title&gt;</span>
<span class="s2">        &lt;meta http-equiv=</span><span class="se">\&quot;</span><span class="s2">Content-Type</span><span class="se">\&quot;</span><span class="s2"> content=</span><span class="se">\&quot;</span><span class="s2">text/html; charset=UTF-8</span><span class="se">\&quot;</span><span class="s2"> /&gt;</span>
<span class="s2">    &lt;/head&gt;</span>
<span class="s2">    &lt;body&gt;</span>
<span class="s2">&quot;</span> <span class="o">(</span><span class="n">escape_html</span> <span class="n">title</span><span class="o">)</span>

<span class="k">let</span> <span class="n">end_html</span> <span class="o">=</span> <span class="s2">&quot;</span>
<span class="s2">    &lt;/body&gt;</span>
<span class="s2">&lt;/html&gt;</span>
<span class="s2">&quot;</span>

<span class="k">let</span> <span class="n">h1</span> <span class="n">contents</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;h1&gt;%s&lt;/h1&gt;&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="n">contents</span><span class="o">)</span>
<span class="k">let</span> <span class="n">p</span> <span class="n">contents</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;p&gt;%s&lt;/p&gt;&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="n">contents</span><span class="o">)</span>
<span class="k">let</span> <span class="n">pre</span> <span class="n">contents</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;pre&gt;%s&lt;/pre&gt;&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="n">contents</span><span class="o">)</span>

<span class="k">let</span> <span class="n">start_form</span> <span class="o">?(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="o">?(</span><span class="k">method&#39;</span><span class="o">=</span><span class="s2">&quot;get&quot;</span><span class="o">)</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">sprintf</span> <span class="s2">&quot;&lt;form action=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> method=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2">&gt;&quot;</span>
    <span class="o">(</span><span class="n">escape_html</span> <span class="n">action</span><span class="o">)</span> <span class="o">(</span><span class="n">escape_html</span> <span class="k">method&#39;</span><span class="o">)</span>
<span class="k">let</span> <span class="n">end_form</span> <span class="o">=</span> <span class="s2">&quot;&lt;/form&gt;&quot;</span>

<span class="k">let</span> <span class="n">textfield</span> <span class="o">?(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="o">?(</span><span class="k">value</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">sprintf</span> <span class="s2">&quot;&lt;input type=</span><span class="se">\&quot;</span><span class="s2">text</span><span class="se">\&quot;</span><span class="s2"> name=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> value=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> /&gt;&quot;</span>
    <span class="o">(</span><span class="n">escape_html</span> <span class="n">name</span><span class="o">)</span> <span class="o">(</span><span class="n">escape_html</span> <span class="k">value</span><span class="o">)</span>

<span class="k">let</span> <span class="n">submit</span> <span class="o">?(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="o">?(</span><span class="k">value</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">sprintf</span> <span class="s2">&quot;&lt;input type=</span><span class="se">\&quot;</span><span class="s2">submit</span><span class="se">\&quot;</span><span class="s2"> name=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> value=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> /&gt;&quot;</span>
    <span class="o">(</span><span class="n">escape_html</span> <span class="n">name</span><span class="o">)</span> <span class="o">(</span><span class="n">escape_html</span> <span class="k">value</span><span class="o">)</span>

<span class="k">let</span> <span class="n">process</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">print</span> <span class="n">s</span> <span class="o">=</span>
    <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">output_string</span> <span class="n">s</span><span class="o">;</span>
    <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">output_string</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">in</span>

  <span class="k">let</span> <span class="n">name</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;WHO&quot;</span> <span class="k">in</span>

  <span class="c">(* print search form *)</span>
  <span class="n">cgi</span><span class="o">#</span><span class="n">set_header</span> <span class="o">~</span><span class="n">content_type</span><span class="o">:</span><span class="s2">&quot;text/html&quot;</span> <span class="bp">()</span><span class="o">;</span>
  <span class="n">print</span> <span class="o">(</span><span class="n">start_html</span> <span class="s2">&quot;Query Users&quot;</span><span class="o">);</span>
  <span class="n">print</span> <span class="o">(</span><span class="n">h1</span> <span class="o">[</span><span class="s2">&quot;Search&quot;</span><span class="o">]);</span>
  <span class="n">print</span> <span class="o">(</span><span class="n">start_form</span> <span class="o">~</span><span class="k">method&#39;</span><span class="o">:</span><span class="s2">&quot;post&quot;</span> <span class="bp">()</span><span class="o">);</span>
  <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;Which user? &quot;</span><span class="o">;</span>
            <span class="n">textfield</span> <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;WHO&quot;</span> <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="n">name</span> <span class="bp">()</span><span class="o">]);</span>
  <span class="n">print</span> <span class="o">(</span><span class="n">submit</span> <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="s2">&quot;Query&quot;</span> <span class="bp">()</span><span class="o">);</span>
  <span class="n">print</span> <span class="n">end_form</span><span class="o">;</span>

  <span class="c">(* print results of the query if we have someone to look for *)</span>
  <span class="k">if</span> <span class="n">name</span> <span class="o">&lt;&gt;</span> <span class="s2">&quot;&quot;</span> <span class="k">then</span>
    <span class="k">begin</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">h1</span> <span class="o">[</span><span class="s2">&quot;Results&quot;</span><span class="o">]);</span>
      <span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="n">name</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">proc</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_in</span> <span class="s2">&quot;who&quot;</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">found</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">html</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span> <span class="k">in</span>
      <span class="k">begin</span>
        <span class="c">(* call who and build up text of response *)</span>
        <span class="k">try</span>
          <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
            <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">proc</span> <span class="k">in</span>
            <span class="c">(* only lines matching [name] *)</span>
            <span class="k">if</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">regexp</span> <span class="n">line</span> <span class="mi">0</span> <span class="k">then</span>
              <span class="k">begin</span>
                <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_string</span> <span class="n">html</span> <span class="o">(</span><span class="n">escape_html</span> <span class="n">line</span> <span class="o">^</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">);</span>
                <span class="n">found</span> <span class="o">:=</span> <span class="bp">true</span><span class="o">;</span>
              <span class="k">end</span>
          <span class="k">done</span>
        <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
          <span class="n">close_in</span> <span class="n">proc</span><span class="o">;</span>
          <span class="c">(* nice message if we didn&#39;t find anyone by that name *)</span>
          <span class="k">if</span> <span class="n">not</span> <span class="o">!</span><span class="n">found</span>
          <span class="k">then</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_string</span> <span class="n">html</span>
            <span class="o">(</span><span class="n">escape_html</span> <span class="n">name</span> <span class="o">^</span> <span class="s2">&quot; is not logged in&quot;</span><span class="o">);</span>
      <span class="k">end</span><span class="o">;</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">pre</span> <span class="o">[</span><span class="nn">Buffer</span><span class="p">.</span><span class="n">contents</span> <span class="n">html</span><span class="o">]);</span>
    <span class="k">end</span><span class="o">;</span>

  <span class="n">print</span> <span class="n">end_html</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">config</span> <span class="o">=</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">default_config</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">buffered</span> <span class="o">_</span> <span class="n">ch</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">buffered_trans_channel</span> <span class="n">ch</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">output_type</span> <span class="o">=</span> <span class="o">`</span><span class="nc">Transactional</span> <span class="n">buffered</span> <span class="k">in</span>
  <span class="k">if</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">isatty</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span>
  <span class="k">then</span> <span class="nn">Netcgi_test</span><span class="p">.</span><span class="n">run</span> <span class="o">~</span><span class="n">config</span> <span class="o">~</span><span class="n">output_type</span> <span class="n">process</span>
  <span class="k">else</span> <span class="nn">Netcgi_cgi</span><span class="p">.</span><span class="n">run</span> <span class="o">~</span><span class="n">config</span> <span class="o">~</span><span class="n">output_type</span> <span class="n">process</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1043"
>Writing a Multiscreen CGI Script</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">env</span> <span class="n">ocaml</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netcgi2&quot;</span><span class="o">;;</span>

<span class="k">open</span> <span class="nc">Printf</span>

<span class="k">let</span> <span class="o">(</span> <span class="o">=&gt;</span> <span class="o">)</span> <span class="n">k</span> <span class="n">v</span> <span class="o">=</span> <span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">)</span>

<span class="k">let</span> <span class="n">escape_html</span> <span class="o">=</span> <span class="nn">Netencoding</span><span class="p">.</span><span class="nn">Html</span><span class="p">.</span><span class="n">encode</span> <span class="o">~</span><span class="n">in_enc</span><span class="o">:`</span><span class="nc">Enc_utf8</span> <span class="bp">()</span>

<span class="k">let</span> <span class="n">start_html</span> <span class="n">title</span> <span class="o">=</span>
  <span class="n">sprintf</span> <span class="s2">&quot;\</span>
<span class="s2">&lt;!DOCTYPE html PUBLIC </span><span class="se">\&quot;</span><span class="s2">-//W3C//DTD XHTML 1.0 Transitional//EN</span><span class="se">\&quot;</span><span class="s2"> </span><span class="se">\&quot;</span><span class="s2">http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd</span><span class="se">\&quot;</span><span class="s2">&gt;</span>
<span class="s2">&lt;html xmlns=</span><span class="se">\&quot;</span><span class="s2">http://www.w3.org/1999/xhtml</span><span class="se">\&quot;</span><span class="s2">&gt;</span>
<span class="s2">    &lt;head&gt;</span>
<span class="s2">        &lt;title&gt;%s&lt;/title&gt;</span>
<span class="s2">        &lt;meta http-equiv=</span><span class="se">\&quot;</span><span class="s2">Content-Type</span><span class="se">\&quot;</span><span class="s2"> content=</span><span class="se">\&quot;</span><span class="s2">text/html; charset=UTF-8</span><span class="se">\&quot;</span><span class="s2"> /&gt;</span>
<span class="s2">    &lt;/head&gt;</span>
<span class="s2">    &lt;body&gt;</span>
<span class="s2">&quot;</span> <span class="o">(</span><span class="n">escape_html</span> <span class="n">title</span><span class="o">)</span>

<span class="k">let</span> <span class="n">end_html</span> <span class="o">=</span> <span class="s2">&quot;</span>
<span class="s2">    &lt;/body&gt;</span>
<span class="s2">&lt;/html&gt;</span>
<span class="s2">&quot;</span>

<span class="k">let</span> <span class="n">h1</span> <span class="n">contents</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;h1&gt;%s&lt;/h1&gt;&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="n">contents</span><span class="o">)</span>
<span class="k">let</span> <span class="n">p</span> <span class="n">contents</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;p&gt;%s&lt;/p&gt;&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="n">contents</span><span class="o">)</span>
<span class="k">let</span> <span class="n">pre</span> <span class="n">contents</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;pre&gt;%s&lt;/pre&gt;&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="n">contents</span><span class="o">)</span>

<span class="k">let</span> <span class="n">start_form</span> <span class="o">?(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="o">?(</span><span class="k">method&#39;</span><span class="o">=</span><span class="s2">&quot;get&quot;</span><span class="o">)</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">sprintf</span> <span class="s2">&quot;&lt;form action=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> method=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2">&gt;&quot;</span>
    <span class="o">(</span><span class="n">escape_html</span> <span class="n">action</span><span class="o">)</span> <span class="o">(</span><span class="n">escape_html</span> <span class="k">method&#39;</span><span class="o">)</span>
<span class="k">let</span> <span class="n">end_form</span> <span class="o">=</span> <span class="s2">&quot;&lt;/form&gt;&quot;</span>

<span class="k">let</span> <span class="n">hidden</span> <span class="o">?(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="o">?(</span><span class="k">value</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">sprintf</span> <span class="s2">&quot;&lt;input type=</span><span class="se">\&quot;</span><span class="s2">hidden</span><span class="se">\&quot;</span><span class="s2"> name=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> value=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> /&gt;&quot;</span>
    <span class="o">(</span><span class="n">escape_html</span> <span class="n">name</span><span class="o">)</span> <span class="o">(</span><span class="n">escape_html</span> <span class="k">value</span><span class="o">)</span>

<span class="k">let</span> <span class="n">submit</span> <span class="o">?(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="o">?(</span><span class="k">value</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">sprintf</span> <span class="s2">&quot;&lt;input type=</span><span class="se">\&quot;</span><span class="s2">submit</span><span class="se">\&quot;</span><span class="s2"> name=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> value=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> /&gt;&quot;</span>
    <span class="o">(</span><span class="n">escape_html</span> <span class="n">name</span><span class="o">)</span> <span class="o">(</span><span class="n">escape_html</span> <span class="k">value</span><span class="o">)</span>

<span class="k">let</span> <span class="n">popup_menu</span> <span class="o">?(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="o">?(</span><span class="k">value</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="n">values</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">options</span> <span class="o">=</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">map</span>
      <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="k">value&#39;</span><span class="o">,</span> <span class="n">label</span><span class="o">)</span> <span class="o">-&gt;</span>
         <span class="n">sprintf</span> <span class="s2">&quot;&lt;option %s value=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2">&gt;%s&lt;/option&gt;&quot;</span>
           <span class="o">(</span><span class="k">if</span> <span class="k">value</span> <span class="o">=</span> <span class="k">value&#39;</span> <span class="k">then</span> <span class="s2">&quot;selected=</span><span class="se">\&quot;</span><span class="s2">selected</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="o">)</span>
           <span class="o">(</span><span class="n">escape_html</span> <span class="k">value&#39;</span><span class="o">)</span>
           <span class="o">(</span><span class="n">escape_html</span> <span class="n">label</span><span class="o">))</span>
      <span class="n">values</span> <span class="k">in</span>
  <span class="n">sprintf</span> <span class="s2">&quot;&lt;select name=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2">&gt;</span><span class="se">\n</span><span class="s2">%s</span><span class="se">\n</span><span class="s2">&lt;/select&gt;&quot;</span>
    <span class="o">(</span><span class="n">escape_html</span> <span class="n">name</span><span class="o">)</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">options</span><span class="o">)</span>

<span class="k">let</span> <span class="n">standard_header</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">h1</span> <span class="o">[</span><span class="s2">&quot;Program Title&quot;</span><span class="o">]</span>
<span class="k">let</span> <span class="n">standard_footer</span> <span class="bp">()</span> <span class="o">=</span> <span class="s2">&quot;&lt;hr /&gt;&quot;</span>

<span class="k">let</span> <span class="n">to_page</span> <span class="k">value</span> <span class="o">=</span> <span class="n">submit</span> <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;.State&quot;</span> <span class="o">~</span><span class="k">value</span> <span class="bp">()</span>

<span class="c">(* when we get a .State that doesn&#39;t exist *)</span>
<span class="k">let</span> <span class="n">no_such_page</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="n">print</span> <span class="o">=</span> <span class="bp">()</span>

<span class="k">let</span> <span class="n">front_page</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="n">print</span> <span class="n">active</span> <span class="o">=</span> <span class="bp">()</span>
<span class="k">let</span> <span class="n">sweater</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="n">print</span> <span class="n">active</span> <span class="o">=</span> <span class="bp">()</span>
<span class="k">let</span> <span class="n">checkout</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="n">print</span> <span class="n">active</span> <span class="o">=</span> <span class="bp">()</span>
<span class="k">let</span> <span class="n">credit_card</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="n">print</span> <span class="n">active</span> <span class="o">=</span> <span class="bp">()</span>
<span class="k">let</span> <span class="n">order</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="n">print</span> <span class="n">active</span> <span class="o">=</span> <span class="bp">()</span>

<span class="k">let</span> <span class="n">t_shirt</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="n">print</span> <span class="n">active</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">size</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;size&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">color</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;color&quot;</span> <span class="k">in</span>
  <span class="k">if</span> <span class="n">active</span> <span class="k">then</span>
    <span class="k">begin</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;You want to buy a t-shirt?&quot;</span><span class="o">]);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;Size: &quot;</span><span class="o">;</span>
                <span class="n">popup_menu</span> <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;size&quot;</span> <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="n">size</span>
                  <span class="o">[</span><span class="s2">&quot;XL&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;X-Large&quot;</span><span class="o">;</span>
                   <span class="s2">&quot;L&quot;</span>  <span class="o">=&gt;</span> <span class="s2">&quot;Large&quot;</span><span class="o">;</span>
                   <span class="s2">&quot;M&quot;</span>  <span class="o">=&gt;</span> <span class="s2">&quot;Medium&quot;</span><span class="o">;</span>
                   <span class="s2">&quot;S&quot;</span>  <span class="o">=&gt;</span> <span class="s2">&quot;Small&quot;</span><span class="o">;</span>
                   <span class="s2">&quot;XS&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;X-Small&quot;</span><span class="o">]]);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;Color: &quot;</span><span class="o">;</span>
                <span class="n">popup_menu</span> <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;color&quot;</span> <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="n">color</span>
                  <span class="o">[</span><span class="s2">&quot;Black&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Black&quot;</span><span class="o">;</span> <span class="s2">&quot;White&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;White&quot;</span><span class="o">]]);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="n">to_page</span> <span class="s2">&quot;Shoes&quot;</span><span class="o">;</span> <span class="n">to_page</span> <span class="s2">&quot;Checkout&quot;</span><span class="o">]);</span>
    <span class="k">end</span>
  <span class="k">else</span>
    <span class="k">begin</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">hidden</span> <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;size&quot;</span> <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="n">size</span> <span class="bp">()</span><span class="o">);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">hidden</span> <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;color&quot;</span> <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="n">color</span> <span class="bp">()</span><span class="o">);</span>
    <span class="k">end</span>

<span class="k">let</span> <span class="n">states</span> <span class="o">=</span>
  <span class="o">[</span>
    <span class="s2">&quot;Default&quot;</span>  <span class="o">=&gt;</span> <span class="n">front_page</span><span class="o">;</span>
    <span class="s2">&quot;Shirt&quot;</span>    <span class="o">=&gt;</span> <span class="n">t_shirt</span><span class="o">;</span>
    <span class="s2">&quot;Sweater&quot;</span>  <span class="o">=&gt;</span> <span class="n">sweater</span><span class="o">;</span>
    <span class="s2">&quot;Checkout&quot;</span> <span class="o">=&gt;</span> <span class="n">checkout</span><span class="o">;</span>
    <span class="s2">&quot;Card&quot;</span>     <span class="o">=&gt;</span> <span class="n">credit_card</span><span class="o">;</span>
    <span class="s2">&quot;Order&quot;</span>    <span class="o">=&gt;</span> <span class="n">order</span><span class="o">;</span>
    <span class="s2">&quot;Cancel&quot;</span>   <span class="o">=&gt;</span> <span class="n">front_page</span><span class="o">;</span>
  <span class="o">]</span>

<span class="k">let</span> <span class="n">process</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">page</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="o">~</span><span class="n">default</span><span class="o">:</span><span class="s2">&quot;Default&quot;</span> <span class="s2">&quot;.State&quot;</span> <span class="k">in</span>
  <span class="n">cgi</span><span class="o">#</span><span class="n">set_header</span> <span class="o">~</span><span class="n">content_type</span><span class="o">:</span><span class="s2">&quot;text/html&quot;</span> <span class="bp">()</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">print</span> <span class="n">s</span> <span class="o">=</span>
    <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">output_string</span> <span class="n">s</span><span class="o">;</span>
    <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">output_string</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">in</span>
  <span class="n">print</span> <span class="o">(</span><span class="n">start_html</span> <span class="s2">&quot;Program Title&quot;</span><span class="o">);</span>
  <span class="n">print</span> <span class="o">(</span><span class="n">standard_header</span> <span class="bp">()</span><span class="o">);</span>
  <span class="n">print</span> <span class="o">(</span><span class="n">start_form</span> <span class="bp">()</span><span class="o">);</span>
  <span class="k">if</span> <span class="nn">List</span><span class="p">.</span><span class="n">mem_assoc</span> <span class="n">page</span> <span class="n">states</span>
  <span class="k">then</span> <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">state</span><span class="o">,</span> <span class="n">sub</span><span class="o">)</span> <span class="o">-&gt;</span>
                    <span class="n">sub</span> <span class="n">cgi</span> <span class="n">print</span> <span class="o">(</span><span class="n">page</span> <span class="o">=</span> <span class="n">state</span><span class="o">))</span> <span class="n">states</span>
  <span class="k">else</span> <span class="n">no_such_page</span> <span class="n">cgi</span> <span class="n">print</span><span class="o">;</span>
  <span class="n">print</span> <span class="o">(</span><span class="n">standard_footer</span> <span class="bp">()</span><span class="o">);</span>
  <span class="n">print</span> <span class="n">end_form</span><span class="o">;</span>
  <span class="n">print</span> <span class="n">end_html</span><span class="o">;</span>
  <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">commit_work</span> <span class="bp">()</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">config</span> <span class="o">=</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">default_config</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">buffered</span> <span class="o">_</span> <span class="n">ch</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">buffered_trans_channel</span> <span class="n">ch</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">output_type</span> <span class="o">=</span> <span class="o">`</span><span class="nc">Transactional</span> <span class="n">buffered</span> <span class="k">in</span>
  <span class="k">if</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">isatty</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span>
  <span class="k">then</span> <span class="nn">Netcgi_test</span><span class="p">.</span><span class="n">run</span> <span class="o">~</span><span class="n">config</span> <span class="o">~</span><span class="n">output_type</span> <span class="n">process</span>
  <span class="k">else</span> <span class="nn">Netcgi_cgi</span><span class="p">.</span><span class="n">run</span> <span class="o">~</span><span class="n">config</span> <span class="o">~</span><span class="n">output_type</span> <span class="n">process</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1046"
>Saving a Form to a File or Mail Pipe</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">env</span> <span class="n">ocaml</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netcgi2&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">escape</span>   <span class="o">=</span> <span class="nn">Netencoding</span><span class="p">.</span><span class="nn">Url</span><span class="p">.</span><span class="n">encode</span> <span class="o">~</span><span class="n">plus</span><span class="o">:</span><span class="bp">false</span>
<span class="k">let</span> <span class="n">unescape</span> <span class="o">=</span> <span class="nn">Netencoding</span><span class="p">.</span><span class="nn">Url</span><span class="p">.</span><span class="n">decode</span> <span class="o">~</span><span class="n">plus</span><span class="o">:</span><span class="bp">false</span>

<span class="k">let</span> <span class="n">save_arguments</span> <span class="o">(</span><span class="n">ch</span> <span class="o">:</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">out_obj_channel</span><span class="o">)</span> <span class="n">args</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">arg</span> <span class="o">-&gt;</span>
       <span class="n">ch</span><span class="o">#</span><span class="n">output_string</span> <span class="o">(</span><span class="n">escape</span> <span class="n">arg</span><span class="o">#</span><span class="n">name</span><span class="o">);</span>
       <span class="n">ch</span><span class="o">#</span><span class="n">output_char</span> <span class="sc">&#39;=&#39;</span><span class="o">;</span>
       <span class="n">ch</span><span class="o">#</span><span class="n">output_string</span> <span class="o">(</span><span class="n">escape</span> <span class="n">arg</span><span class="o">#</span><span class="k">value</span><span class="o">);</span>
       <span class="n">ch</span><span class="o">#</span><span class="n">output_char</span> <span class="sc">&#39;\n&#39;</span><span class="o">)</span>
    <span class="n">args</span><span class="o">;</span>
  <span class="n">ch</span><span class="o">#</span><span class="n">output_string</span> <span class="s2">&quot;=</span><span class="se">\n</span><span class="s2">&quot;</span>

<span class="k">let</span> <span class="n">process</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="o">=</span>
  <span class="c">(* first open and exclusively lock the file *)</span>
  <span class="k">let</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">open_out_gen</span> <span class="o">[</span><span class="nc">Open_append</span><span class="o">;</span> <span class="nc">Open_creat</span><span class="o">]</span> <span class="mo">0o666</span> <span class="s2">&quot;/tmp/formlog&quot;</span> <span class="k">in</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">lockf</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">descr_of_out_channel</span> <span class="n">ch</span><span class="o">)</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">F_LOCK</span> <span class="mi">0</span><span class="o">;</span>

  <span class="c">(* locally set some additional arguments *)</span>
  <span class="k">let</span> <span class="n">arguments</span> <span class="o">=</span>
    <span class="nn">Netcgi</span><span class="p">.</span><span class="nn">Argument</span><span class="p">.</span><span class="n">set</span>
      <span class="o">[</span>
        <span class="nn">Netcgi</span><span class="p">.</span><span class="nn">Argument</span><span class="p">.</span><span class="n">simple</span> <span class="s2">&quot;_timestamp&quot;</span>
          <span class="o">(</span><span class="n">string_of_float</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">time</span> <span class="bp">()</span><span class="o">));</span>
        <span class="nn">Netcgi</span><span class="p">.</span><span class="nn">Argument</span><span class="p">.</span><span class="n">simple</span> <span class="s2">&quot;_environs&quot;</span>
          <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">environment</span> <span class="bp">()</span><span class="o">)));</span>
      <span class="o">]</span>
      <span class="n">cgi</span><span class="o">#</span><span class="n">arguments</span> <span class="k">in</span>

  <span class="c">(* wrap output in a Netchannel and save *)</span>
  <span class="k">let</span> <span class="n">ch</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">output_channel</span> <span class="n">ch</span> <span class="k">in</span>
  <span class="n">save_arguments</span> <span class="n">ch</span> <span class="n">arguments</span><span class="o">;</span>
  <span class="n">ch</span><span class="o">#</span><span class="n">close_out</span> <span class="bp">()</span><span class="o">;</span>

  <span class="c">(* send in an email *)</span>
  <span class="k">let</span> <span class="n">body</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">create</span> <span class="mi">256</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">ch</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">output_buffer</span> <span class="n">body</span> <span class="k">in</span>
  <span class="n">save_arguments</span> <span class="n">ch</span> <span class="n">arguments</span><span class="o">;</span>
  <span class="nn">Netsendmail</span><span class="p">.</span><span class="n">sendmail</span>
    <span class="o">(</span><span class="nn">Netsendmail</span><span class="p">.</span><span class="n">compose</span>
       <span class="o">~</span><span class="n">from_addr</span><span class="o">:(</span><span class="s2">&quot;your cgi script&quot;</span><span class="o">,</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">))</span>
       <span class="o">~</span><span class="n">to_addrs</span><span class="o">:[(</span><span class="s2">&quot;hisname&quot;</span><span class="o">,</span> <span class="s2">&quot;hisname@hishost.com&quot;</span><span class="o">)]</span>
       <span class="o">~</span><span class="n">subject</span><span class="o">:</span><span class="s2">&quot;mailed form submission&quot;</span>
       <span class="o">(</span><span class="nn">Buffer</span><span class="p">.</span><span class="n">contents</span> <span class="n">body</span><span class="o">))</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">config</span> <span class="o">=</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">default_config</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">buffered</span> <span class="o">_</span> <span class="n">ch</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">buffered_trans_channel</span> <span class="n">ch</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">output_type</span> <span class="o">=</span> <span class="o">`</span><span class="nc">Transactional</span> <span class="n">buffered</span> <span class="k">in</span>
  <span class="k">if</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">isatty</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span>
  <span class="k">then</span> <span class="nn">Netcgi_test</span><span class="p">.</span><span class="n">run</span> <span class="o">~</span><span class="n">config</span> <span class="o">~</span><span class="n">output_type</span> <span class="n">process</span>
  <span class="k">else</span> <span class="nn">Netcgi_cgi</span><span class="p">.</span><span class="n">run</span> <span class="o">~</span><span class="n">config</span> <span class="o">~</span><span class="n">output_type</span> <span class="n">process</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;str&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;unix&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netstring&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">escape</span>   <span class="o">=</span> <span class="nn">Netencoding</span><span class="p">.</span><span class="nn">Url</span><span class="p">.</span><span class="n">encode</span> <span class="o">~</span><span class="n">plus</span><span class="o">:</span><span class="bp">false</span>
<span class="k">let</span> <span class="n">unescape</span> <span class="o">=</span> <span class="nn">Netencoding</span><span class="p">.</span><span class="nn">Url</span><span class="p">.</span><span class="n">decode</span> <span class="o">~</span><span class="n">plus</span><span class="o">:</span><span class="bp">false</span>

<span class="k">let</span> <span class="n">parse_env</span> <span class="n">data</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">result</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">16</span> <span class="k">in</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span>
       <span class="k">try</span>
         <span class="k">let</span> <span class="n">index</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">index</span> <span class="n">line</span> <span class="sc">&#39;=&#39;</span> <span class="k">in</span>
         <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">add</span> <span class="n">result</span>
           <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">line</span> <span class="mi">0</span> <span class="n">index</span><span class="o">)</span>
           <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">line</span> <span class="o">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">line</span> <span class="o">-</span> <span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="o">))</span>
       <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">)</span>
    <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">split</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span> <span class="n">data</span><span class="o">);</span>
  <span class="n">result</span>

<span class="k">let</span> <span class="n">ends_with</span> <span class="n">suffix</span> <span class="n">s</span> <span class="o">=</span>
  <span class="k">try</span> <span class="nn">Str</span><span class="p">.</span><span class="n">last_chars</span> <span class="n">s</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">suffix</span><span class="o">)</span> <span class="o">=</span> <span class="n">suffix</span>
  <span class="k">with</span> <span class="nc">Invalid_argument</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">forms</span> <span class="o">=</span> <span class="n">open_in</span> <span class="s2">&quot;/tmp/formlog&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">args</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">8</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">lockf</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">descr_of_in_channel</span> <span class="n">forms</span><span class="o">)</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">F_RLOCK</span> <span class="mi">0</span><span class="o">;</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">forms</span> <span class="k">in</span>
      <span class="k">if</span> <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;=&quot;</span> <span class="k">then</span>
        <span class="k">begin</span>
          <span class="k">let</span> <span class="n">his_env</span> <span class="o">=</span> <span class="n">parse_env</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">args</span> <span class="s2">&quot;_environs&quot;</span><span class="o">)</span> <span class="k">in</span>
          <span class="k">let</span> <span class="n">host</span> <span class="o">=</span>
            <span class="k">try</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">his_env</span> <span class="s2">&quot;REMOTE_HOST&quot;</span>
            <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="s2">&quot;&quot;</span> <span class="k">in</span>
          <span class="k">if</span> <span class="n">host</span> <span class="o">&lt;&gt;</span> <span class="s2">&quot;perl.com&quot;</span> <span class="o">&amp;&amp;</span> <span class="n">not</span> <span class="o">(</span><span class="n">ends_with</span> <span class="s2">&quot;.perl.com&quot;</span> <span class="n">host</span><span class="o">)</span>
          <span class="k">then</span> <span class="o">(</span><span class="n">count</span> <span class="o">:=</span>
                  <span class="o">(!</span><span class="n">count</span> <span class="o">+</span>
                     <span class="n">int_of_string</span>
                     <span class="o">(</span><span class="k">try</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">args</span> <span class="s2">&quot;items requested&quot;</span>
                      <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="s2">&quot;0&quot;</span><span class="o">)));</span>
          <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">clear</span> <span class="n">args</span>
        <span class="k">end</span>
      <span class="k">else</span>
        <span class="k">begin</span>
          <span class="k">let</span> <span class="n">index</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">index</span> <span class="n">line</span> <span class="sc">&#39;=&#39;</span> <span class="k">in</span>
          <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">add</span> <span class="n">args</span>
            <span class="o">(</span><span class="n">unescape</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">line</span> <span class="mi">0</span> <span class="n">index</span><span class="o">))</span>
            <span class="o">(</span><span class="n">unescape</span>
               <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">sub</span>
                  <span class="n">line</span>
                  <span class="o">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span>
                  <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">line</span> <span class="o">-</span> <span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)))</span>
        <span class="k">end</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
    <span class="n">close_in</span> <span class="n">forms</span><span class="o">;</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Total orders: %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">!</span><span class="n">count</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1049"
>Program: chemiserie</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">env</span> <span class="n">ocaml</span>
<span class="c">(* chemiserie - simple CGI shopping for shirts and sweaters *)</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netcgi2&quot;</span><span class="o">;;</span>

<span class="k">open</span> <span class="nc">Printf</span>

<span class="k">let</span> <span class="o">(</span> <span class="o">=&gt;</span> <span class="o">)</span> <span class="n">k</span> <span class="n">v</span> <span class="o">=</span> <span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">)</span>

<span class="k">let</span> <span class="n">escape_html</span> <span class="o">=</span> <span class="nn">Netencoding</span><span class="p">.</span><span class="nn">Html</span><span class="p">.</span><span class="n">encode</span> <span class="o">~</span><span class="n">in_enc</span><span class="o">:`</span><span class="nc">Enc_utf8</span> <span class="bp">()</span>

<span class="k">let</span> <span class="n">start_html</span> <span class="n">title</span> <span class="o">=</span>
  <span class="n">sprintf</span> <span class="s2">&quot;\</span>
<span class="s2">&lt;!DOCTYPE html PUBLIC </span><span class="se">\&quot;</span><span class="s2">-//W3C//DTD XHTML 1.0 Transitional//EN</span><span class="se">\&quot;</span><span class="s2"> </span><span class="se">\&quot;</span><span class="s2">http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd</span><span class="se">\&quot;</span><span class="s2">&gt;</span>
<span class="s2">&lt;html xmlns=</span><span class="se">\&quot;</span><span class="s2">http://www.w3.org/1999/xhtml</span><span class="se">\&quot;</span><span class="s2">&gt;</span>
<span class="s2">    &lt;head&gt;</span>
<span class="s2">        &lt;title&gt;%s&lt;/title&gt;</span>
<span class="s2">        &lt;meta http-equiv=</span><span class="se">\&quot;</span><span class="s2">Content-Type</span><span class="se">\&quot;</span><span class="s2"> content=</span><span class="se">\&quot;</span><span class="s2">text/html; charset=UTF-8</span><span class="se">\&quot;</span><span class="s2"> /&gt;</span>
<span class="s2">    &lt;/head&gt;</span>
<span class="s2">    &lt;body&gt;</span>
<span class="s2">&quot;</span> <span class="o">(</span><span class="n">escape_html</span> <span class="n">title</span><span class="o">)</span>

<span class="k">let</span> <span class="n">end_html</span> <span class="o">=</span> <span class="s2">&quot;</span>
<span class="s2">    &lt;/body&gt;</span>
<span class="s2">&lt;/html&gt;</span>
<span class="s2">&quot;</span>

<span class="k">let</span> <span class="n">h1</span> <span class="n">contents</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;h1&gt;%s&lt;/h1&gt;&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="n">contents</span><span class="o">)</span>
<span class="k">let</span> <span class="n">h2</span> <span class="n">contents</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;h2&gt;%s&lt;/h2&gt;&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="n">contents</span><span class="o">)</span>
<span class="k">let</span> <span class="n">p</span> <span class="n">contents</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;p&gt;%s&lt;/p&gt;&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="n">contents</span><span class="o">)</span>
<span class="k">let</span> <span class="n">pre</span> <span class="n">contents</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;pre&gt;%s&lt;/pre&gt;&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="n">contents</span><span class="o">)</span>

<span class="k">let</span> <span class="n">start_form</span> <span class="o">?(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="o">?(</span><span class="k">method&#39;</span><span class="o">=</span><span class="s2">&quot;get&quot;</span><span class="o">)</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">sprintf</span> <span class="s2">&quot;&lt;form action=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> method=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2">&gt;&quot;</span>
    <span class="o">(</span><span class="n">escape_html</span> <span class="n">action</span><span class="o">)</span> <span class="o">(</span><span class="n">escape_html</span> <span class="k">method&#39;</span><span class="o">)</span>
<span class="k">let</span> <span class="n">end_form</span> <span class="o">=</span> <span class="s2">&quot;&lt;/form&gt;&quot;</span>

<span class="k">let</span> <span class="n">hidden</span> <span class="o">?(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="o">?(</span><span class="k">value</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">sprintf</span> <span class="s2">&quot;&lt;input type=</span><span class="se">\&quot;</span><span class="s2">hidden</span><span class="se">\&quot;</span><span class="s2"> name=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> value=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> /&gt;&quot;</span>
    <span class="o">(</span><span class="n">escape_html</span> <span class="n">name</span><span class="o">)</span> <span class="o">(</span><span class="n">escape_html</span> <span class="k">value</span><span class="o">)</span>

<span class="k">let</span> <span class="n">submit</span> <span class="o">?(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="o">?(</span><span class="k">value</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">sprintf</span> <span class="s2">&quot;&lt;input type=</span><span class="se">\&quot;</span><span class="s2">submit</span><span class="se">\&quot;</span><span class="s2"> name=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> value=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> /&gt;&quot;</span>
    <span class="o">(</span><span class="n">escape_html</span> <span class="n">name</span><span class="o">)</span> <span class="o">(</span><span class="n">escape_html</span> <span class="k">value</span><span class="o">)</span>

<span class="k">let</span> <span class="n">textfield</span> <span class="o">?(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="o">?(</span><span class="k">value</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">sprintf</span> <span class="s2">&quot;&lt;input type=</span><span class="se">\&quot;</span><span class="s2">text</span><span class="se">\&quot;</span><span class="s2"> name=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> value=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> /&gt;&quot;</span>
    <span class="o">(</span><span class="n">escape_html</span> <span class="n">name</span><span class="o">)</span> <span class="o">(</span><span class="n">escape_html</span> <span class="k">value</span><span class="o">)</span>

<span class="k">let</span> <span class="n">popup_menu</span> <span class="o">?(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="o">?(</span><span class="k">value</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="n">values</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">options</span> <span class="o">=</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">map</span>
      <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="k">value&#39;</span><span class="o">,</span> <span class="n">label</span><span class="o">)</span> <span class="o">-&gt;</span>
         <span class="n">sprintf</span> <span class="s2">&quot;&lt;option %s value=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2">&gt;%s&lt;/option&gt;&quot;</span>
           <span class="o">(</span><span class="k">if</span> <span class="k">value</span> <span class="o">=</span> <span class="k">value&#39;</span> <span class="k">then</span> <span class="s2">&quot;selected=</span><span class="se">\&quot;</span><span class="s2">selected</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="o">)</span>
           <span class="o">(</span><span class="n">escape_html</span> <span class="k">value&#39;</span><span class="o">)</span>
           <span class="o">(</span><span class="n">escape_html</span> <span class="n">label</span><span class="o">))</span>
      <span class="n">values</span> <span class="k">in</span>
  <span class="n">sprintf</span> <span class="s2">&quot;&lt;select name=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2">&gt;</span><span class="se">\n</span><span class="s2">%s</span><span class="se">\n</span><span class="s2">&lt;/select&gt;&quot;</span>
    <span class="o">(</span><span class="n">escape_html</span> <span class="n">name</span><span class="o">)</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">options</span><span class="o">)</span>

<span class="k">let</span> <span class="n">defaults</span> <span class="n">label</span> <span class="o">=</span>
  <span class="n">sprintf</span> <span class="s2">&quot;&lt;input type=</span><span class="se">\&quot;</span><span class="s2">button</span><span class="se">\&quot;</span><span class="s2"> value=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> onclick=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> /&gt;&quot;</span>
    <span class="o">(</span><span class="n">escape_html</span> <span class="n">label</span><span class="o">)</span> <span class="s2">&quot;javascript:location.href=&#39;?&#39;&quot;</span>

<span class="k">let</span> <span class="n">to_page</span> <span class="k">value</span> <span class="o">=</span> <span class="n">submit</span> <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;.State&quot;</span> <span class="o">~</span><span class="k">value</span> <span class="bp">()</span>

<span class="c">(********************************</span>
<span class="c"> * header, footer, menu functions</span>
<span class="c"> ********************************)</span>

<span class="k">let</span> <span class="n">standard_header</span> <span class="n">print</span> <span class="o">=</span>
  <span class="n">print</span> <span class="o">(</span><span class="n">start_html</span> <span class="s2">&quot;Shirts&quot;</span><span class="o">);</span>
  <span class="n">print</span> <span class="o">(</span><span class="n">start_form</span> <span class="bp">()</span><span class="o">)</span>

<span class="k">let</span> <span class="n">standard_footer</span> <span class="n">print</span> <span class="o">=</span>
  <span class="n">print</span> <span class="n">end_form</span><span class="o">;</span>
  <span class="n">print</span> <span class="n">end_html</span>

<span class="k">let</span> <span class="n">shop_menu</span> <span class="n">print</span> <span class="o">=</span>
  <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="n">defaults</span> <span class="s2">&quot;Empty My Shopping Cart&quot;</span><span class="o">;</span>
            <span class="n">to_page</span> <span class="s2">&quot;Shirt&quot;</span><span class="o">;</span>
            <span class="n">to_page</span> <span class="s2">&quot;Sweater&quot;</span><span class="o">;</span>
            <span class="n">to_page</span> <span class="s2">&quot;Checkout&quot;</span><span class="o">])</span>

<span class="c">(*****************************</span>
<span class="c"> * subroutines for each screen</span>
<span class="c"> *****************************)</span>

<span class="c">(* The default page. *)</span>
<span class="k">let</span> <span class="n">front_page</span> <span class="n">cgi</span> <span class="n">print</span> <span class="n">active</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">active</span> <span class="k">then</span>
    <span class="k">begin</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">h1</span> <span class="o">[</span><span class="s2">&quot;Hi!&quot;</span><span class="o">]);</span>
      <span class="n">print</span> <span class="s2">&quot;Welcome to our Shirt Shop!  Please make your selection &quot;</span><span class="o">;</span>
      <span class="n">print</span> <span class="s2">&quot;from the menu below.&quot;</span><span class="o">;</span>
      <span class="n">shop_menu</span> <span class="n">print</span><span class="o">;</span>
    <span class="k">end</span>

<span class="c">(* Page to order a shirt from. *)</span>
<span class="k">let</span> <span class="n">shirt</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="n">print</span> <span class="n">active</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">sizes</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;XL&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;X-Large&quot;</span><span class="o">;</span>
               <span class="s2">&quot;L&quot;</span>  <span class="o">=&gt;</span> <span class="s2">&quot;Large&quot;</span><span class="o">;</span>
               <span class="s2">&quot;M&quot;</span>  <span class="o">=&gt;</span> <span class="s2">&quot;Medium&quot;</span><span class="o">;</span>
               <span class="s2">&quot;S&quot;</span>  <span class="o">=&gt;</span> <span class="s2">&quot;Small&quot;</span><span class="o">;</span>
               <span class="s2">&quot;XS&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;X-Small&quot;</span><span class="o">]</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">colors</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;Black&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Black&quot;</span><span class="o">;</span> <span class="s2">&quot;White&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;White&quot;</span><span class="o">]</span> <span class="k">in</span>

  <span class="k">let</span> <span class="n">size</span><span class="o">,</span> <span class="n">color</span><span class="o">,</span> <span class="n">count</span> <span class="o">=</span>
    <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;shirt_size&quot;</span><span class="o">,</span>
    <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;shirt_color&quot;</span><span class="o">,</span>
    <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;shirt_count&quot;</span> <span class="k">in</span>

  <span class="c">(* sanity check *)</span>
  <span class="k">let</span> <span class="n">size</span> <span class="o">=</span>
    <span class="k">if</span> <span class="nn">List</span><span class="p">.</span><span class="n">mem_assoc</span> <span class="n">size</span> <span class="n">sizes</span>
    <span class="k">then</span> <span class="n">size</span>
    <span class="k">else</span> <span class="n">fst</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">hd</span> <span class="n">sizes</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">color</span> <span class="o">=</span>
    <span class="k">if</span> <span class="nn">List</span><span class="p">.</span><span class="n">mem_assoc</span> <span class="n">color</span> <span class="n">colors</span>
    <span class="k">then</span> <span class="n">color</span>
    <span class="k">else</span> <span class="n">fst</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">hd</span> <span class="n">colors</span><span class="o">)</span> <span class="k">in</span>

  <span class="k">if</span> <span class="n">active</span> <span class="k">then</span>
    <span class="k">begin</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">h1</span> <span class="o">[</span><span class="s2">&quot;T-Shirt&quot;</span><span class="o">]);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;What a shirt!  This baby is decked out with all the &quot;</span><span class="o">;</span>
                <span class="s2">&quot;options. It comes with full luxury interior, cotton &quot;</span><span class="o">;</span>
                <span class="s2">&quot;trim, and a collar to make your eyes water! &quot;</span><span class="o">;</span>
                <span class="s2">&quot;Unit price: $33.00&quot;</span><span class="o">]);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">h2</span> <span class="o">[</span><span class="s2">&quot;Options&quot;</span><span class="o">]);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;How Many? &quot;</span><span class="o">;</span>
                <span class="n">textfield</span>
                  <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;shirt_count&quot;</span>
                  <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="n">count</span> <span class="bp">()</span><span class="o">]);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;Size? &quot;</span><span class="o">;</span>
                <span class="n">popup_menu</span> <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;shirt_size&quot;</span> <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="n">size</span> <span class="n">sizes</span><span class="o">]);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;Color? &quot;</span><span class="o">;</span>
                <span class="n">popup_menu</span> <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;shirt_color&quot;</span> <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="n">color</span> <span class="n">colors</span><span class="o">]);</span>
      <span class="n">shop_menu</span> <span class="n">print</span><span class="o">;</span>
    <span class="k">end</span>
  <span class="k">else</span>
    <span class="k">begin</span>
      <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;&gt;</span> <span class="s2">&quot;&quot;</span>
      <span class="k">then</span> <span class="n">print</span> <span class="o">(</span><span class="n">hidden</span> <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;shirt_size&quot;</span> <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="n">size</span> <span class="bp">()</span><span class="o">);</span>
      <span class="k">if</span> <span class="n">color</span> <span class="o">&lt;&gt;</span> <span class="s2">&quot;&quot;</span>
      <span class="k">then</span> <span class="n">print</span> <span class="o">(</span><span class="n">hidden</span> <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;shirt_color&quot;</span> <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="n">color</span> <span class="bp">()</span><span class="o">);</span>
      <span class="k">if</span> <span class="n">count</span> <span class="o">&lt;&gt;</span> <span class="s2">&quot;&quot;</span>
      <span class="k">then</span> <span class="n">print</span> <span class="o">(</span><span class="n">hidden</span> <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;shirt_count&quot;</span> <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="n">count</span> <span class="bp">()</span><span class="o">);</span>
    <span class="k">end</span>

<span class="c">(* Page to order a sweater from. *)</span>
<span class="k">let</span> <span class="n">sweater</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="n">print</span> <span class="n">active</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">sizes</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;XL&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;X-Large&quot;</span><span class="o">;</span>
               <span class="s2">&quot;L&quot;</span>  <span class="o">=&gt;</span> <span class="s2">&quot;Large&quot;</span><span class="o">;</span>
               <span class="s2">&quot;M&quot;</span>  <span class="o">=&gt;</span> <span class="s2">&quot;Medium&quot;</span><span class="o">]</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">colors</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;Chartreuse&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Chartreuse&quot;</span><span class="o">;</span>
                <span class="s2">&quot;Puce&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Puce&quot;</span><span class="o">;</span>
                <span class="s2">&quot;Lavender&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Lavender&quot;</span><span class="o">]</span> <span class="k">in</span>

  <span class="k">let</span> <span class="n">size</span><span class="o">,</span> <span class="n">color</span><span class="o">,</span> <span class="n">count</span> <span class="o">=</span>
    <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;sweater_size&quot;</span><span class="o">,</span>
    <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;sweater_color&quot;</span><span class="o">,</span>
    <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;sweater_count&quot;</span> <span class="k">in</span>

  <span class="c">(* sanity check *)</span>
  <span class="k">let</span> <span class="n">size</span> <span class="o">=</span>
    <span class="k">if</span> <span class="nn">List</span><span class="p">.</span><span class="n">mem_assoc</span> <span class="n">size</span> <span class="n">sizes</span>
    <span class="k">then</span> <span class="n">size</span>
    <span class="k">else</span> <span class="n">fst</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">hd</span> <span class="n">sizes</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">color</span> <span class="o">=</span>
    <span class="k">if</span> <span class="nn">List</span><span class="p">.</span><span class="n">mem_assoc</span> <span class="n">color</span> <span class="n">colors</span>
    <span class="k">then</span> <span class="n">color</span>
    <span class="k">else</span> <span class="n">fst</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">hd</span> <span class="n">colors</span><span class="o">)</span> <span class="k">in</span>

  <span class="k">if</span> <span class="n">active</span> <span class="k">then</span>
    <span class="k">begin</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">h1</span> <span class="o">[</span><span class="s2">&quot;Sweater&quot;</span><span class="o">]);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;Nothing implies preppy elegance more than this fine &quot;</span><span class="o">;</span>
                <span class="s2">&quot;sweater.  Made by peasant workers from black market &quot;</span><span class="o">;</span>
                <span class="s2">&quot;silk, it slides onto your lean form and cries out &quot;</span><span class="o">;</span>
                <span class="s2">&quot;``Take me, for I am a god!&#39;&#39;.  Unit price: $49.99.&quot;</span><span class="o">]);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">h2</span> <span class="o">[</span><span class="s2">&quot;Options&quot;</span><span class="o">]);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;How Many? &quot;</span><span class="o">;</span>
                <span class="n">textfield</span>
                  <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;sweater_count&quot;</span>
                  <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="n">count</span> <span class="bp">()</span><span class="o">]);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;Size? &quot;</span><span class="o">;</span>
                <span class="n">popup_menu</span> <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;sweater_size&quot;</span> <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="n">size</span> <span class="n">sizes</span><span class="o">]);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;Color? &quot;</span><span class="o">;</span>
                <span class="n">popup_menu</span> <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;sweater_color&quot;</span> <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="n">color</span> <span class="n">colors</span><span class="o">]);</span>
      <span class="n">shop_menu</span> <span class="n">print</span><span class="o">;</span>
    <span class="k">end</span>
  <span class="k">else</span>
    <span class="k">begin</span>
      <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;&gt;</span> <span class="s2">&quot;&quot;</span>
      <span class="k">then</span> <span class="n">print</span> <span class="o">(</span><span class="n">hidden</span> <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;sweater_size&quot;</span> <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="n">size</span> <span class="bp">()</span><span class="o">);</span>
      <span class="k">if</span> <span class="n">color</span> <span class="o">&lt;&gt;</span> <span class="s2">&quot;&quot;</span>
      <span class="k">then</span> <span class="n">print</span> <span class="o">(</span><span class="n">hidden</span> <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;sweater_color&quot;</span> <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="n">color</span> <span class="bp">()</span><span class="o">);</span>
      <span class="k">if</span> <span class="n">count</span> <span class="o">&lt;&gt;</span> <span class="s2">&quot;&quot;</span>
      <span class="k">then</span> <span class="n">print</span> <span class="o">(</span><span class="n">hidden</span> <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;sweater_count&quot;</span> <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="n">count</span> <span class="bp">()</span><span class="o">);</span>
    <span class="k">end</span>

<span class="k">let</span> <span class="n">calculate_price</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">shirts</span> <span class="o">=</span>
    <span class="k">try</span> <span class="n">int_of_string</span> <span class="o">(</span><span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;shirt_count&quot;</span><span class="o">)</span>
    <span class="k">with</span> <span class="nc">Failure</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">sweaters</span> <span class="o">=</span>
    <span class="k">try</span> <span class="n">int_of_string</span> <span class="o">(</span><span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;shirt_count&quot;</span><span class="o">)</span>
    <span class="k">with</span> <span class="nc">Failure</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="n">sprintf</span> <span class="s2">&quot;$%.2f&quot;</span> <span class="o">(</span><span class="kt">float</span> <span class="n">shirts</span> <span class="o">*.</span> <span class="mi">33</span><span class="o">.</span><span class="mi">0</span> <span class="o">+.</span> <span class="kt">float</span> <span class="n">sweaters</span> <span class="o">*.</span> <span class="mi">49</span><span class="o">.</span><span class="mi">99</span><span class="o">)</span>

<span class="c">(* Returns HTML for the current order (&quot;You have ordered ...&quot;) *)</span>
<span class="k">let</span> <span class="n">order_text</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">shirt_count</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;shirt_count&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">shirt_size</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;shirt_size&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">shirt_color</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;shirt_color&quot;</span> <span class="k">in</span>

  <span class="k">let</span> <span class="n">sweater_count</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;sweater_count&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">sweater_size</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;sweater_size&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">sweater_color</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;sweater_color&quot;</span> <span class="k">in</span>

  <span class="k">let</span> <span class="n">html</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span> <span class="k">in</span>

  <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">mem</span> <span class="n">shirt_count</span> <span class="o">[</span><span class="s2">&quot;&quot;</span><span class="o">;</span> <span class="s2">&quot;0&quot;</span><span class="o">])</span> <span class="k">then</span>
    <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_string</span> <span class="n">html</span>
      <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;You have ordered &quot;</span><span class="o">;</span> <span class="n">escape_html</span> <span class="n">shirt_count</span><span class="o">;</span>
          <span class="s2">&quot; shirts of size &quot;</span><span class="o">;</span> <span class="n">escape_html</span> <span class="n">shirt_size</span><span class="o">;</span>
          <span class="s2">&quot; and color &quot;</span><span class="o">;</span> <span class="n">escape_html</span> <span class="n">shirt_color</span><span class="o">;</span> <span class="s2">&quot;.&quot;</span><span class="o">]);</span>

  <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">mem</span> <span class="n">sweater_count</span> <span class="o">[</span><span class="s2">&quot;&quot;</span><span class="o">;</span> <span class="s2">&quot;0&quot;</span><span class="o">])</span> <span class="k">then</span>
    <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_string</span> <span class="n">html</span>
      <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;You have ordered &quot;</span><span class="o">;</span> <span class="n">escape_html</span> <span class="n">sweater_count</span><span class="o">;</span>
          <span class="s2">&quot; sweaters of size &quot;</span><span class="o">;</span> <span class="n">escape_html</span> <span class="n">sweater_size</span><span class="o">;</span>
          <span class="s2">&quot; and color &quot;</span><span class="o">;</span> <span class="n">escape_html</span> <span class="n">sweater_color</span><span class="o">;</span> <span class="s2">&quot;.&quot;</span><span class="o">]);</span>

  <span class="k">let</span> <span class="n">html</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">contents</span> <span class="n">html</span> <span class="k">in</span>
  <span class="k">match</span> <span class="n">html</span> <span class="k">with</span>
    <span class="o">|</span> <span class="s2">&quot;&quot;</span> <span class="o">-&gt;</span> <span class="n">p</span> <span class="o">[</span><span class="s2">&quot;Nothing!&quot;</span><span class="o">]</span>
    <span class="o">|</span> <span class="n">html</span> <span class="o">-&gt;</span> <span class="n">html</span> <span class="o">^</span> <span class="n">p</span> <span class="o">[</span><span class="s2">&quot;For a total cost of &quot;</span><span class="o">;</span> <span class="n">calculate_price</span> <span class="n">cgi</span><span class="o">]</span>

<span class="c">(* Page to display current order for confirmation. *)</span>
<span class="k">let</span> <span class="n">checkout</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="n">print</span> <span class="n">active</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">active</span> <span class="k">then</span>
    <span class="k">begin</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">h1</span> <span class="o">[</span><span class="s2">&quot;Order Confirmation&quot;</span><span class="o">]);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;You ordered the following:&quot;</span><span class="o">]);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">order_text</span> <span class="n">cgi</span><span class="o">);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;Is this right?  Select &#39;Card&#39; to pay for the items &quot;</span><span class="o">;</span>
                <span class="s2">&quot;or &#39;Shirt&#39; or &#39;Sweater&#39; to continue shopping.&quot;</span><span class="o">]);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="n">to_page</span> <span class="s2">&quot;Card&quot;</span><span class="o">;</span>
                <span class="n">to_page</span> <span class="s2">&quot;Shirt&quot;</span><span class="o">;</span>
                <span class="n">to_page</span> <span class="s2">&quot;Sweater&quot;</span><span class="o">]);</span>
    <span class="k">end</span>

<span class="c">(* Page to gather credit-card information. *)</span>
<span class="k">let</span> <span class="n">credit_card</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="n">print</span> <span class="n">active</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">widgets</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;Name&quot;</span><span class="o">;</span> <span class="s2">&quot;Address1&quot;</span><span class="o">;</span> <span class="s2">&quot;Address2&quot;</span><span class="o">;</span> <span class="s2">&quot;City&quot;</span><span class="o">;</span> <span class="s2">&quot;Zip&quot;</span><span class="o">;</span> <span class="s2">&quot;State&quot;</span><span class="o">;</span>
                 <span class="s2">&quot;Phone&quot;</span><span class="o">;</span> <span class="s2">&quot;Card&quot;</span><span class="o">;</span> <span class="s2">&quot;Expiry&quot;</span><span class="o">]</span> <span class="k">in</span>
  <span class="k">if</span> <span class="n">active</span> <span class="k">then</span>
    <span class="k">begin</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">pre</span> <span class="o">[</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;Name:          &quot;</span><span class="o">;</span>
                     <span class="n">textfield</span>
                       <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;Name&quot;</span>
                       <span class="o">~</span><span class="k">value</span><span class="o">:(</span><span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;Name&quot;</span><span class="o">)</span> <span class="bp">()</span><span class="o">];</span>
                  <span class="n">p</span> <span class="o">[</span><span class="s2">&quot;Address:       &quot;</span><span class="o">;</span>
                     <span class="n">textfield</span>
                       <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;Address1&quot;</span>
                       <span class="o">~</span><span class="k">value</span><span class="o">:(</span><span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;Address1&quot;</span><span class="o">)</span> <span class="bp">()</span><span class="o">];</span>
                  <span class="n">p</span> <span class="o">[</span><span class="s2">&quot;               &quot;</span><span class="o">;</span>
                     <span class="n">textfield</span>
                       <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;Address2&quot;</span>
                       <span class="o">~</span><span class="k">value</span><span class="o">:(</span><span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;Address2&quot;</span><span class="o">)</span> <span class="bp">()</span><span class="o">];</span>
                  <span class="n">p</span> <span class="o">[</span><span class="s2">&quot;City:          &quot;</span><span class="o">;</span>
                     <span class="n">textfield</span>
                       <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;City&quot;</span>
                       <span class="o">~</span><span class="k">value</span><span class="o">:(</span><span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;City&quot;</span><span class="o">)</span> <span class="bp">()</span><span class="o">];</span>
                  <span class="n">p</span> <span class="o">[</span><span class="s2">&quot;Zip:           &quot;</span><span class="o">;</span>
                     <span class="n">textfield</span>
                       <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;Zip&quot;</span>
                       <span class="o">~</span><span class="k">value</span><span class="o">:(</span><span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;Zip&quot;</span><span class="o">)</span> <span class="bp">()</span><span class="o">];</span>
                  <span class="n">p</span> <span class="o">[</span><span class="s2">&quot;State:         &quot;</span><span class="o">;</span>
                     <span class="n">textfield</span>
                       <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;State&quot;</span>
                       <span class="o">~</span><span class="k">value</span><span class="o">:(</span><span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;State&quot;</span><span class="o">)</span> <span class="bp">()</span><span class="o">];</span>
                  <span class="n">p</span> <span class="o">[</span><span class="s2">&quot;Phone:         &quot;</span><span class="o">;</span>
                     <span class="n">textfield</span>
                       <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;Phone&quot;</span>
                       <span class="o">~</span><span class="k">value</span><span class="o">:(</span><span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;Phone&quot;</span><span class="o">)</span> <span class="bp">()</span><span class="o">];</span>
                  <span class="n">p</span> <span class="o">[</span><span class="s2">&quot;Credit Card *: &quot;</span><span class="o">;</span>
                     <span class="n">textfield</span>
                       <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;Card&quot;</span>
                       <span class="o">~</span><span class="k">value</span><span class="o">:(</span><span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;Card&quot;</span><span class="o">)</span> <span class="bp">()</span><span class="o">];</span>
                  <span class="n">p</span> <span class="o">[</span><span class="s2">&quot;Expiry:        &quot;</span><span class="o">;</span>
                     <span class="n">textfield</span>
                       <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;Expiry&quot;</span>
                       <span class="o">~</span><span class="k">value</span><span class="o">:(</span><span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;Expiry&quot;</span><span class="o">)</span> <span class="bp">()</span><span class="o">]]);</span>

      <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;Click on &#39;Order&#39; to order the items. &quot;</span><span class="o">;</span>
                <span class="s2">&quot;Click on &#39;Cancel&#39; to return shopping.&quot;</span><span class="o">]);</span>

      <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="n">to_page</span> <span class="s2">&quot;Order&quot;</span><span class="o">;</span> <span class="n">to_page</span> <span class="s2">&quot;Cancel&quot;</span><span class="o">]);</span>
    <span class="k">end</span>
  <span class="k">else</span>
    <span class="k">begin</span>
      <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
        <span class="o">(</span><span class="k">fun</span> <span class="n">widget</span> <span class="o">-&gt;</span>
           <span class="n">print</span> <span class="o">(</span><span class="n">hidden</span>
                    <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="n">widget</span>
                    <span class="o">~</span><span class="k">value</span><span class="o">:(</span><span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="n">widget</span><span class="o">)</span> <span class="bp">()</span><span class="o">))</span>
        <span class="n">widgets</span>
    <span class="k">end</span>

<span class="c">(* Page to complete an order. *)</span>
<span class="k">let</span> <span class="n">order</span> <span class="n">cgi</span> <span class="n">print</span> <span class="n">active</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">active</span> <span class="k">then</span>
    <span class="k">begin</span>
      <span class="c">(* you&#39;d check credit card values here *)</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">h1</span> <span class="o">[</span><span class="s2">&quot;Ordered!&quot;</span><span class="o">]);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;You have ordered the following toppings:&quot;</span><span class="o">]);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">order_text</span> <span class="n">cgi</span><span class="o">);</span>

      <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="n">defaults</span> <span class="s2">&quot;Begin Again&quot;</span><span class="o">]);</span>
    <span class="k">end</span>

<span class="c">(* state table mapping pages to functions *)</span>
<span class="k">type</span> <span class="n">page</span> <span class="o">=</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="kt">string</span> <span class="o">-&gt;</span> <span class="kt">unit</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="kt">bool</span> <span class="o">-&gt;</span> <span class="kt">unit</span>
<span class="k">let</span> <span class="o">(</span><span class="n">states</span> <span class="o">:</span> <span class="o">(</span><span class="kt">string</span> <span class="o">*</span> <span class="n">page</span><span class="o">)</span> <span class="kt">list</span><span class="o">)</span> <span class="o">=</span>
  <span class="o">[</span>
    <span class="s2">&quot;Default&quot;</span>  <span class="o">=&gt;</span> <span class="n">front_page</span><span class="o">;</span>
    <span class="s2">&quot;Shirt&quot;</span>    <span class="o">=&gt;</span> <span class="n">shirt</span><span class="o">;</span>
    <span class="s2">&quot;Sweater&quot;</span>  <span class="o">=&gt;</span> <span class="n">sweater</span><span class="o">;</span>
    <span class="s2">&quot;Checkout&quot;</span> <span class="o">=&gt;</span> <span class="n">checkout</span><span class="o">;</span>
    <span class="s2">&quot;Card&quot;</span>     <span class="o">=&gt;</span> <span class="n">credit_card</span><span class="o">;</span>
    <span class="s2">&quot;Order&quot;</span>    <span class="o">=&gt;</span> <span class="n">order</span><span class="o">;</span>
    <span class="s2">&quot;Cancel&quot;</span>   <span class="o">=&gt;</span> <span class="n">front_page</span><span class="o">;</span>
  <span class="o">]</span>

<span class="k">let</span> <span class="n">no_such_page</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="n">print</span> <span class="n">current_screen</span> <span class="o">=</span>
  <span class="n">print</span> <span class="o">(</span><span class="s2">&quot;No screen for &quot;</span> <span class="o">^</span> <span class="n">current_screen</span><span class="o">)</span>

<span class="k">let</span> <span class="n">process</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">current_screen</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="o">~</span><span class="n">default</span><span class="o">:</span><span class="s2">&quot;Default&quot;</span> <span class="s2">&quot;.State&quot;</span> <span class="k">in</span>

  <span class="k">let</span> <span class="n">print</span> <span class="n">s</span> <span class="o">=</span>
    <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">output_string</span> <span class="n">s</span><span class="o">;</span>
    <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">output_string</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">in</span>

  <span class="c">(* Generate the current page. *)</span>
  <span class="n">cgi</span><span class="o">#</span><span class="n">set_header</span> <span class="o">~</span><span class="n">content_type</span><span class="o">:</span><span class="s2">&quot;text/html&quot;</span> <span class="bp">()</span><span class="o">;</span>
  <span class="n">standard_header</span> <span class="n">print</span><span class="o">;</span>
  <span class="k">if</span> <span class="nn">List</span><span class="p">.</span><span class="n">mem_assoc</span> <span class="n">current_screen</span> <span class="n">states</span>
  <span class="k">then</span> <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">state</span><span class="o">,</span> <span class="n">sub</span><span class="o">)</span> <span class="o">-&gt;</span>
                    <span class="n">sub</span> <span class="n">cgi</span> <span class="n">print</span> <span class="o">(</span><span class="n">current_screen</span> <span class="o">=</span> <span class="n">state</span><span class="o">))</span> <span class="n">states</span>
  <span class="k">else</span> <span class="n">no_such_page</span> <span class="n">cgi</span> <span class="n">print</span> <span class="n">current_screen</span><span class="o">;</span>
  <span class="n">standard_footer</span> <span class="n">print</span><span class="o">;</span>
  <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">commit_work</span> <span class="bp">()</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">config</span> <span class="o">=</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">default_config</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">buffered</span> <span class="o">_</span> <span class="n">ch</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">buffered_trans_channel</span> <span class="n">ch</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">output_type</span> <span class="o">=</span> <span class="o">`</span><span class="nc">Transactional</span> <span class="n">buffered</span> <span class="k">in</span>
  <span class="k">if</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">isatty</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span>
  <span class="k">then</span> <span class="nn">Netcgi_test</span><span class="p">.</span><span class="n">run</span> <span class="o">~</span><span class="n">config</span> <span class="o">~</span><span class="n">output_type</span> <span class="n">process</span>
  <span class="k">else</span> <span class="nn">Netcgi_cgi</span><span class="p">.</span><span class="n">run</span> <span class="o">~</span><span class="n">config</span> <span class="o">~</span><span class="n">output_type</span> <span class="n">process</span></PRE
></TD
></TR
></TABLE
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="internetservices.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="webautomation.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Internet Services</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
>&nbsp;</TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Web Automation</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>
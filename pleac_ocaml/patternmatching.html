<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN""http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>Pattern Matching</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="PLEAC-Objective CAML "
HREF="index.html"><LINK
REL="PREVIOUS"
TITLE="Hashes"
HREF="hashes.html"><LINK
REL="NEXT"
TITLE="File Access"
HREF="fileaccess.html"><style type="text/css">td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
pre { line-height: 125%; }

  </style></head
><BODY TEXT="#cecece" BGCOLOR="#4f6f6f" LINK="#f5deb3" VLINK="#d5ae83"
CLASS="SECT1"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>PLEAC-Objective CAML </TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="hashes.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
></TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="fileaccess.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="PATTERNMATCHING"
>6. Pattern Matching</A
></H1
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN285"
>Introduction</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* We will use the Str library distributed with OCaml for regular expressions.</span>
<span class="c"> * There are two ways to use the str library, building a top or passing it to ocaml.</span>
<span class="c"> * Under Unix, you can create a new toplevel which has the Str module:</span>
<span class="c"> *      $ ocamlmktop -o strtop str.cma</span>
<span class="c"> *      $ ./strtop</span>
<span class="c"> *   Now you don&#39;t need to prefix the contents of the str module with Str.</span>
<span class="c"> * The alternative is to pass str.cma as a parameter:</span>
<span class="c"> *     $ ocaml str.cma</span>
<span class="c"> *   Now you may refer to the contents of the str module by using Str.</span>
<span class="c"> * Under Windows, if you are using ocamlwin.exe you can simply load Str:</span>
<span class="c"> *      # load &quot;str.cma&quot;;;</span>
<span class="c"> *)</span>
<span class="c">(* Str.search_forward returns an int or throws an exception if the pattern isn&#39;t found.</span>
<span class="c"> * In Perl, the =~ operator returns null. Since these two values have different</span>
<span class="c"> * types in OCaml, we cannot copy this behaviour directly.</span>
<span class="c"> * Instead, we return an impossible index, -1 using try ... with.</span>
<span class="c"> * Another method would be to define an =~ operator and use that directly:</span>
<span class="c"># let (=~) s re = Str.string_match (Str.regexp re) s 0;;</span>
<span class="c">val ( =~ ) : string -&gt; string -&gt; bool = &lt;fun&gt;</span>
<span class="c"># &quot;abc&quot; =~ &quot;a&quot;;;</span>
<span class="c">- : bool = true</span>
<span class="c"># &quot;bc&quot; =~ &quot;a&quot;;;</span>
<span class="c">- : bool = false</span>
<span class="c"> * Don&#39;t underestimate the power of this. Many of the following examples could be</span>
<span class="c"> * simplified by defining infix operators.</span>
<span class="c"> *)</span>
<span class="k">try</span> <span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="n">pattern</span><span class="o">)</span> <span class="kt">string</span> <span class="mi">0</span><span class="o">;</span>
<span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="o">;;</span>

<span class="k">try</span> <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="n">pattern</span><span class="o">)</span> <span class="n">replacement</span> <span class="kt">string</span><span class="o">;</span>
<span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="s2">&quot;&quot;</span><span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">try</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;sheep&quot;</span><span class="o">)</span> <span class="n">meadow</span> <span class="mi">0</span><span class="o">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
<span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">false</span><span class="o">;;</span> <span class="c">(* true if meadow contains &quot;sheep&quot; *)</span>

<span class="k">try</span> <span class="n">not</span> <span class="o">((</span><span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;sheep&quot;</span><span class="o">)</span> <span class="n">meadow</span> <span class="mi">0</span><span class="o">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="o">);</span>
<span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">true</span><span class="o">;;</span> <span class="c">(* true if meadow doesn&#39;t contain &quot;sheep&quot; *)</span>

<span class="k">let</span> <span class="n">meadow</span> <span class="o">=</span>
    <span class="k">try</span> <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;old&quot;</span><span class="o">)</span> <span class="s2">&quot;new&quot;</span> <span class="n">meadow</span><span class="o">;</span>
    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="n">meadow</span><span class="o">;;</span> <span class="c">(* Replace &quot;old&quot; with &quot;new&quot; in meadow *)</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">try</span>
    <span class="k">let</span> <span class="n">temp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">bovines?</span><span class="se">\\</span><span class="s2">b&quot;</span><span class="o">)</span> <span class="n">meadow</span> <span class="mi">0</span> <span class="k">in</span>
        <span class="n">print_string</span> <span class="s2">&quot;Here be sheep!&quot;</span><span class="o">;</span>
<span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="kt">string</span> <span class="o">=</span> <span class="s2">&quot;good food&quot;</span> <span class="k">in</span>
    <span class="k">try</span>
        <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;o*&quot;</span><span class="o">)</span> <span class="s2">&quot;e&quot;</span> <span class="kt">string</span><span class="o">;</span>
    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="kt">string</span><span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="c">(* There is no way to take command line parameters to ocaml that I know of.</span>
<span class="c"> * You would first have to compile your OCaml program using ocamlc.</span>
<span class="c"> *)</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="k">rec</span> <span class="n">match_num</span> <span class="n">s</span> <span class="n">start</span><span class="o">=</span>
    <span class="k">if</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">then</span>
        <span class="k">try</span>
            <span class="k">let</span> <span class="n">temp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[0123456789]+&quot;</span><span class="o">)</span> <span class="n">s</span> <span class="n">start</span> <span class="k">in</span>
                <span class="n">print_string</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="o">(</span><span class="s2">&quot;Found number &quot;</span> <span class="o">::</span> <span class="nn">Str</span><span class="p">.</span><span class="n">matched_string</span> <span class="n">s</span> <span class="o">::</span> <span class="o">[</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">]));</span>
                <span class="n">match_num</span> <span class="n">s</span> <span class="o">(</span><span class="n">temp</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
        <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">;</span>
    <span class="k">else</span>
        <span class="bp">()</span><span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="k">rec</span> <span class="n">match_group</span> <span class="n">s</span> <span class="n">start</span> <span class="n">numbers</span><span class="o">=</span>
    <span class="k">if</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">then</span>
        <span class="k">try</span>
            <span class="k">let</span> <span class="n">temp</span> <span class="o">=</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[0123456789]+&quot;</span><span class="o">)</span> <span class="n">s</span> <span class="n">start</span><span class="o">)</span> <span class="k">in</span>
                <span class="k">let</span> <span class="n">numbers</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">matched_string</span> <span class="n">s</span> <span class="o">::</span> <span class="n">numbers</span> <span class="k">in</span>
                    <span class="n">match_group</span> <span class="n">s</span> <span class="o">(</span><span class="n">temp</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">numbers</span><span class="o">;</span>
        <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="n">numbers</span><span class="o">;</span>
    <span class="k">else</span>
        <span class="n">numbers</span><span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="o">(=+)</span> <span class="n">s</span> <span class="n">re</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">result</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
    <span class="k">while</span> <span class="o">((</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span><span class="o">)</span> <span class="o">&gt;</span> <span class="o">!</span><span class="n">offset</span><span class="o">)</span> <span class="k">do</span>
        <span class="k">try</span>
            <span class="n">offset</span> <span class="o">:=</span> <span class="mi">1</span> <span class="o">+</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="n">re</span><span class="o">)</span> <span class="n">s</span> <span class="o">!</span><span class="n">offset</span><span class="o">);</span>
            <span class="n">result</span> <span class="o">:=</span> <span class="o">!</span><span class="n">result</span> <span class="o">@</span> <span class="o">[</span><span class="nn">Str</span><span class="p">.</span><span class="n">matched_string</span> <span class="n">s</span><span class="o">]</span> <span class="o">@</span> <span class="bp">[]</span><span class="o">;</span>
        <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="n">ignore</span> <span class="o">(</span><span class="n">offset</span> <span class="o">:=</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span><span class="o">)</span>
    <span class="k">done</span><span class="o">;</span>
    <span class="n">result</span><span class="o">;;</span>

<span class="k">let</span> <span class="o">(=-)</span> <span class="n">s</span> <span class="n">re</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">result</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
    <span class="k">while</span> <span class="o">((</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span><span class="o">)</span> <span class="o">&gt;</span> <span class="o">!</span><span class="n">offset</span><span class="o">)</span> <span class="k">do</span>
        <span class="k">try</span>
            <span class="n">ignore</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="n">re</span><span class="o">)</span> <span class="n">s</span> <span class="o">!</span><span class="n">offset</span><span class="o">);</span>
            <span class="n">offset</span> <span class="o">:=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">match_end</span> <span class="bp">()</span><span class="o">;</span>
            <span class="n">result</span> <span class="o">:=</span> <span class="o">!</span><span class="n">result</span> <span class="o">@</span> <span class="o">[</span><span class="nn">Str</span><span class="p">.</span><span class="n">matched_string</span> <span class="n">s</span><span class="o">]</span> <span class="o">@</span> <span class="bp">[]</span><span class="o">;</span>
        <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="n">ignore</span> <span class="o">(</span><span class="n">offset</span> <span class="o">:=</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span><span class="o">)</span>
    <span class="k">done</span><span class="o">;</span>
    <span class="n">result</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">digits</span> <span class="o">=</span> <span class="s2">&quot;123456789&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">yeslap</span> <span class="o">=</span> <span class="n">digits</span> <span class="o">=+</span> <span class="s2">&quot;[1234567890][1234567890][1234567890]&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">nonlap</span> <span class="o">=</span> <span class="n">digits</span> <span class="o">=-</span> <span class="s2">&quot;[1234567890][1234567890][1234567890]&quot;</span><span class="o">;;</span>

<span class="n">print_string</span> <span class="s2">&quot;Non-overlapping: &quot;</span><span class="o">;</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">print_string</span> <span class="o">(</span><span class="n">v</span> <span class="o">^</span> <span class="s2">&quot; &quot;</span><span class="o">))</span> <span class="o">!</span><span class="n">nonlap</span><span class="o">;</span>
<span class="n">print_string</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;;</span>
<span class="c">(* Non-overlapping: 123 456 789 *)</span>

<span class="n">print_string</span> <span class="s2">&quot;Overlapping: &quot;</span><span class="o">;</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">print_string</span> <span class="o">(</span><span class="n">v</span> <span class="o">^</span> <span class="s2">&quot; &quot;</span><span class="o">))</span> <span class="o">!</span><span class="n">yeslap</span><span class="o">;</span>
<span class="n">print_string</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;;</span>
<span class="c">(* Overlapping: 123 234 345 456 567 678 789 *)</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="n">index</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span><span class="o">;;</span>
<span class="k">let</span> <span class="kt">string</span> <span class="o">=</span> <span class="s2">&quot;And little lambs eat ivy&quot;</span><span class="o">;;</span>
<span class="k">try</span>
    <span class="n">index</span> <span class="o">:=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;l[^s]*s&quot;</span><span class="o">)</span> <span class="kt">string</span> <span class="mi">0</span><span class="o">;</span>
<span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">;;</span>

<span class="n">print_string</span> <span class="o">(</span><span class="s2">&quot;(&quot;</span> <span class="o">^</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="kt">string</span> <span class="mi">0</span> <span class="o">!</span><span class="n">index</span><span class="o">)</span> <span class="o">^</span> <span class="s2">&quot;) &quot;</span><span class="o">);</span>
<span class="n">print_string</span> <span class="o">(</span><span class="s2">&quot;(&quot;</span> <span class="o">^</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">matched_string</span> <span class="kt">string</span><span class="o">)</span> <span class="o">^</span> <span class="s2">&quot;) &quot;</span><span class="o">);</span>
<span class="n">print_string</span> <span class="o">(</span><span class="s2">&quot;(&quot;</span> <span class="o">^</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">string_after</span> <span class="kt">string</span> <span class="mi">16</span><span class="o">)</span> <span class="o">^</span> <span class="s2">&quot;)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">);;</span>
<span class="c">(* (And ) (little lambs) ( eat ivy) *)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN288"
>Copying and Substituting Simultaneously</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="c">(* The Str module doesn&#39;t modify strings in place; you always get</span>
<span class="c">   a copy when you perform a substitution. *)</span>
<span class="k">let</span> <span class="n">dst</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">global_replace</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;this&quot;</span><span class="o">)</span> <span class="s2">&quot;that&quot;</span> <span class="n">src</span>

<span class="c">(* Strip to basename. *)</span>
<span class="k">let</span> <span class="n">progname</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;^.*/&quot;</span><span class="o">)</span> <span class="s2">&quot;&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span>

<span class="c">(* Make All Words Title-Cased. *)</span>
<span class="k">let</span> <span class="n">capword</span> <span class="o">=</span>
  <span class="nn">Str</span><span class="p">.</span><span class="n">global_substitute</span>
    <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">b.&quot;</span><span class="o">)</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="nn">String</span><span class="p">.</span><span class="n">uppercase</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">matched_string</span> <span class="n">s</span><span class="o">))</span>
    <span class="n">words</span>

<span class="c">(* /usr/man/man3/foo.1 changes to /usr/man/cat3/foo.1 *)</span>
<span class="k">let</span> <span class="n">catpage</span> <span class="o">=</span>
  <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;man</span><span class="se">\\</span><span class="s2">([0-9]</span><span class="se">\\</span><span class="s2">)&quot;</span><span class="o">)</span> <span class="s2">&quot;cat</span><span class="se">\\</span><span class="s2">1&quot;</span> <span class="n">manpage</span>

<span class="c">(* Copy and substitute on all strings in a list. *)</span>
<span class="k">let</span> <span class="n">bindirs</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;/usr/bin&quot;</span><span class="o">;</span> <span class="s2">&quot;/bin&quot;</span><span class="o">;</span> <span class="s2">&quot;/usr/local/bin&quot;</span><span class="o">]</span>
<span class="k">let</span> <span class="n">libdirs</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;bin&quot;</span><span class="o">)</span> <span class="s2">&quot;lib&quot;</span> <span class="n">s</span><span class="o">)</span>
    <span class="n">bindirs</span>
<span class="c">(* [&quot;/usr/lib&quot;; &quot;/lib&quot;; &quot;/usr/local/lib&quot;] *)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN291"
>Matching Letters</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* Str can do a simple character range match, but it isn&#39;t very</span>
<span class="c">   practical for matching alphabetic characters in general. *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;^[A-Za-z]+$&quot;</span><span class="o">)</span> <span class="n">var</span> <span class="mi">0</span>
  <span class="k">then</span> <span class="n">print_endline</span> <span class="s2">&quot;var is purely alphabetic&quot;</span>

<span class="c">(* With Pcre, you can use UTF8 support and match characters with</span>
<span class="c">   the letter property. *)</span>
<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+pcre&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;pcre.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span> <span class="o">~</span><span class="n">rex</span><span class="o">:(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="o">~</span><span class="n">flags</span><span class="o">:[`</span><span class="nc">UTF8</span><span class="o">]</span> <span class="s2">&quot;^</span><span class="se">\\</span><span class="s2">pL+$&quot;</span><span class="o">)</span> <span class="n">var</span>
  <span class="k">then</span> <span class="n">print_endline</span> <span class="s2">&quot;var is purely alphabetic&quot;</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN294"
>Matching Words</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="c">(* Str&#39;s regexps lack a whitespace-matching pattern.</span>
<span class="c">   Here is a substitute. *)</span>
<span class="k">let</span> <span class="n">whitespace_chars</span> <span class="o">=</span>
  <span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="mi">1</span><span class="o">)</span>
       <span class="o">[</span>
         <span class="nn">Char</span><span class="p">.</span><span class="n">chr</span> <span class="mi">9</span><span class="o">;</span>  <span class="c">(* HT *)</span>
         <span class="nn">Char</span><span class="p">.</span><span class="n">chr</span> <span class="mi">10</span><span class="o">;</span> <span class="c">(* LF *)</span>
         <span class="nn">Char</span><span class="p">.</span><span class="n">chr</span> <span class="mi">11</span><span class="o">;</span> <span class="c">(* VT *)</span>
         <span class="nn">Char</span><span class="p">.</span><span class="n">chr</span> <span class="mi">12</span><span class="o">;</span> <span class="c">(* FF *)</span>
         <span class="nn">Char</span><span class="p">.</span><span class="n">chr</span> <span class="mi">13</span><span class="o">;</span> <span class="c">(* CR *)</span>
         <span class="nn">Char</span><span class="p">.</span><span class="n">chr</span> <span class="mi">32</span><span class="o">;</span> <span class="c">(* space *)</span>
       <span class="o">])</span>
<span class="k">let</span> <span class="n">space</span> <span class="o">=</span> <span class="s2">&quot;[&quot;</span> <span class="o">^</span> <span class="n">whitespace_chars</span> <span class="o">^</span> <span class="s2">&quot;]&quot;</span>
<span class="k">let</span> <span class="n">non_space</span> <span class="o">=</span> <span class="s2">&quot;[^&quot;</span> <span class="o">^</span> <span class="n">whitespace_chars</span> <span class="o">^</span> <span class="s2">&quot;]&quot;</span>

<span class="c">(* as many non-whitespace characters as possible *)</span>
<span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="o">(</span><span class="n">non_space</span> <span class="o">^</span> <span class="s2">&quot;+&quot;</span><span class="o">)</span>

<span class="c">(* as many letters, apostrophes, and hyphens *)</span>
<span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[A-Za-z&#39;-]+&quot;</span>

<span class="c">(* usually best *)</span>
<span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">b</span><span class="se">\\</span><span class="s2">([A-Za-z]+</span><span class="se">\\</span><span class="s2">)</span><span class="se">\\</span><span class="s2">b&quot;</span>

<span class="c">(* fails at ends or w/ punctuation *)</span>
<span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="o">(</span><span class="n">space</span> <span class="o">^</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">([A-Za-z]+</span><span class="se">\\</span><span class="s2">)&quot;</span> <span class="o">^</span> <span class="n">space</span><span class="o">)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN297"
>Commenting Regular Expressions</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* resname - change all &quot;foo.bar.com&quot; style names in the input stream</span>
<span class="c">   into &quot;foo.bar.com [204.148.40.9]&quot; (or whatever) instead *)</span>

<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+pcre&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;pcre.cma&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span>
  <span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="o">~</span><span class="n">flags</span><span class="o">:[`</span><span class="nc">EXTENDED</span><span class="o">]</span> <span class="s2">&quot;</span>
<span class="s2">    (                     # capture the hostname in substring 1</span>
<span class="s2">      (?:                 # these parens for grouping only</span>
<span class="s2">        (?! [-_]  )       # lookahead for neither underscore nor dash</span>
<span class="s2">        [</span><span class="se">\\</span><span class="s2">w-] +          # hostname component</span>
<span class="s2">        </span><span class="se">\\</span><span class="s2">.               # and the domain dot</span>
<span class="s2">      ) +                 # now repeat that whole thing a bunch of times</span>
<span class="s2">      [A-Za-z]            # next must be a letter</span>
<span class="s2">      [</span><span class="se">\\</span><span class="s2">w-] +            # now trailing domain part</span>
<span class="s2">    )                     # end of substring 1 capture</span>
<span class="s2">  &quot;</span>

<span class="k">let</span> <span class="n">process</span> <span class="n">line</span> <span class="o">=</span>
  <span class="n">print_endline</span>
    <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">substitute_substrings</span>
       <span class="o">~</span><span class="n">rex</span><span class="o">:</span><span class="n">regexp</span>
       <span class="o">~</span><span class="n">subst</span><span class="o">:(</span><span class="k">fun</span> <span class="n">subs</span> <span class="o">-&gt;</span>
                 <span class="k">let</span> <span class="n">name</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">get_substring</span> <span class="n">subs</span> <span class="mi">1</span> <span class="k">in</span>
                 <span class="k">let</span> <span class="n">addr</span> <span class="o">=</span>
                   <span class="k">try</span>
                     <span class="nn">Unix</span><span class="p">.</span><span class="n">string_of_inet_addr</span>
                       <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">gethostbyname</span> <span class="n">name</span><span class="o">).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">h_addr_list</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span>
                   <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="s2">&quot;???&quot;</span> <span class="k">in</span>
                 <span class="n">name</span> <span class="o">^</span> <span class="s2">&quot; [&quot;</span> <span class="o">^</span> <span class="n">addr</span> <span class="o">^</span> <span class="s2">&quot;]&quot;</span><span class="o">)</span>
       <span class="n">line</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">read_line</span> <span class="bp">()</span> <span class="k">in</span>
      <span class="n">process</span> <span class="n">line</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">vars</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">vars</span> <span class="s2">&quot;name&quot;</span> <span class="s2">&quot;Bob&quot;</span><span class="o">;</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">vars</span> <span class="s2">&quot;flavor&quot;</span> <span class="s2">&quot;rhubarb&quot;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">print_endline</span>
    <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">substitute_substrings</span>
       <span class="o">~</span><span class="n">rex</span><span class="o">:(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="o">~</span><span class="n">flags</span><span class="o">:[`</span><span class="nc">EXTENDED</span><span class="o">]</span> <span class="s2">&quot;</span>
<span class="s2">               </span><span class="se">\\</span><span class="s2">#                #   a pound sign</span>
<span class="s2">               (</span><span class="se">\\</span><span class="s2">w+)             #   the variable name</span>
<span class="s2">               </span><span class="se">\\</span><span class="s2">#                #   another pound sign</span>
<span class="s2">             &quot;</span><span class="o">)</span>
       <span class="o">~</span><span class="n">subst</span><span class="o">:(</span><span class="k">fun</span> <span class="n">subs</span> <span class="o">-&gt;</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">vars</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">get_substring</span> <span class="n">subs</span> <span class="mi">1</span><span class="o">))</span>
       <span class="s2">&quot;Hello, #name#, would you like some #flavor# pie?&quot;</span><span class="o">)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN300"
>Finding the Nth Occurrence of a Match</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">want</span> <span class="o">=</span> <span class="mi">3</span>
<span class="k">let</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>
<span class="k">let</span> <span class="n">pond</span> <span class="o">=</span> <span class="s2">&quot;One fish two fish red fish blue fish&quot;</span>
<span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp_case_fold</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">([a-z]+</span><span class="se">\\</span><span class="s2">)[ ]+fish</span><span class="se">\\</span><span class="s2">b&quot;</span>

<span class="k">exception</span> <span class="nc">Found</span> <span class="k">of</span> <span class="kt">string</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">start</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="n">ignore</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span> <span class="n">regexp</span> <span class="n">pond</span> <span class="o">!</span><span class="n">start</span><span class="o">);</span>
      <span class="n">start</span> <span class="o">:=</span> <span class="o">!</span><span class="n">start</span> <span class="o">+</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">matched_string</span> <span class="n">pond</span><span class="o">);</span>
      <span class="n">incr</span> <span class="n">count</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">!</span><span class="n">count</span> <span class="o">=</span> <span class="n">want</span> <span class="k">then</span> <span class="k">raise</span> <span class="o">(</span><span class="nc">Found</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">1</span> <span class="n">pond</span><span class="o">))</span>
    <span class="k">done</span>
  <span class="k">with</span>
    <span class="o">|</span> <span class="nc">Found</span> <span class="n">color</span> <span class="o">-&gt;</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;The third fish is a %s one.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">color</span>
    <span class="o">|</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Only found %d fish!</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">!</span><span class="n">count</span>

<span class="c">(* The third fish is a red one. *)</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">colors</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">start</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">fish</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="k">begin</span>
    <span class="k">try</span>
      <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
        <span class="n">ignore</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span> <span class="n">regexp</span> <span class="n">pond</span> <span class="o">!</span><span class="n">start</span><span class="o">);</span>
        <span class="n">start</span> <span class="o">:=</span> <span class="o">!</span><span class="n">start</span> <span class="o">+</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">matched_string</span> <span class="n">pond</span><span class="o">));</span>
        <span class="n">fish</span> <span class="o">:=</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">1</span> <span class="n">pond</span><span class="o">)</span> <span class="o">::</span> <span class="o">!</span><span class="n">fish</span>
      <span class="k">done</span><span class="o">;</span>
    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">()</span>
  <span class="k">end</span><span class="o">;</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">of_list</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="o">!</span><span class="n">fish</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;The third fish in the pond is %s.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">colors</span><span class="o">.(</span><span class="mi">2</span><span class="o">)</span>

<span class="c">(* The third fish in the pond is red. *)</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">evens</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">colors&#39;</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">iteri</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">i</span> <span class="n">color</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">mod</span> <span class="mi">2</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">then</span> <span class="n">colors&#39;</span> <span class="o">:=</span> <span class="n">color</span> <span class="o">::</span> <span class="o">!</span><span class="n">colors&#39;</span><span class="o">)</span>
    <span class="n">colors</span><span class="o">;</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="o">!</span><span class="n">colors&#39;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Even numbered fish are %s.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot; &quot;</span> <span class="n">evens</span><span class="o">)</span>

<span class="c">(* Even numbered fish are two blue. *)</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="n">print_endline</span>
    <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">global_substitute</span>
       <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp_case_fold</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">b</span><span class="se">\\</span><span class="s2">([a-z]+</span><span class="se">\\</span><span class="s2">)</span><span class="se">\\</span><span class="s2">([ ]+fish</span><span class="se">\\</span><span class="s2">b</span><span class="se">\\</span><span class="s2">)&quot;</span><span class="o">)</span>
       <span class="o">(</span><span class="k">fun</span> <span class="n">s</span> <span class="o">-&gt;</span>
          <span class="n">incr</span> <span class="n">count</span><span class="o">;</span>
          <span class="k">if</span> <span class="o">!</span><span class="n">count</span> <span class="o">=</span> <span class="mi">4</span>
          <span class="k">then</span> <span class="s2">&quot;sushi&quot;</span> <span class="o">^</span> <span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">2</span> <span class="n">s</span>
          <span class="k">else</span> <span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">1</span> <span class="n">s</span> <span class="o">^</span> <span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">2</span> <span class="n">s</span><span class="o">)</span>
       <span class="n">pond</span><span class="o">)</span>

<span class="c">(* One fish two fish red fish sushi fish *)</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">pond</span> <span class="o">=</span> <span class="s2">&quot;One fish two fish red fish blue fish swim here.&quot;</span>
<span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp_case_fold</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">b</span><span class="se">\\</span><span class="s2">([a-z]+</span><span class="se">\\</span><span class="s2">)[ ]+fish</span><span class="se">\\</span><span class="s2">b&quot;</span>
<span class="k">let</span> <span class="n">colors</span> <span class="o">=</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span> <span class="n">start</span> <span class="n">acc</span> <span class="o">=</span>
    <span class="k">try</span>
      <span class="n">ignore</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span> <span class="n">regexp</span> <span class="n">pond</span> <span class="n">start</span><span class="o">);</span>
      <span class="n">loop</span>
        <span class="o">(</span><span class="n">start</span> <span class="o">+</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">matched_string</span> <span class="n">pond</span><span class="o">))</span>
        <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">1</span> <span class="n">pond</span> <span class="o">::</span> <span class="n">acc</span><span class="o">)</span>
    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
      <span class="n">acc</span> <span class="k">in</span>
  <span class="n">loop</span> <span class="mi">0</span> <span class="bp">[]</span>
<span class="k">let</span> <span class="n">color</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">hd</span> <span class="n">colors</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Last fish is %s.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">color</span>

<span class="c">(* Last fish is blue. *)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN303"
>Matching Multiple Lines</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* killtags - very bad html tag killer *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;&lt;[^&gt;]*&gt;&quot;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">filename</span> <span class="o">-&gt;</span>
       <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
       <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span> <span class="n">open_in</span> <span class="n">filename</span> <span class="k">in</span>
       <span class="k">try</span>
         <span class="k">begin</span>
           <span class="k">try</span> <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span> <span class="n">lines</span> <span class="o">:=</span> <span class="n">input_line</span> <span class="n">in_channel</span> <span class="o">::</span> <span class="o">!</span><span class="n">lines</span> <span class="k">done</span>
           <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span>
         <span class="k">end</span><span class="o">;</span>
         <span class="k">let</span> <span class="n">contents</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="o">!</span><span class="n">lines</span><span class="o">)</span> <span class="k">in</span>
         <span class="n">print_endline</span>
           <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span>
              <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span>
                 <span class="o">(</span><span class="k">function</span>
                    <span class="o">|</span> <span class="nn">Str</span><span class="p">.</span><span class="nc">Text</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span>
                    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="s2">&quot;&quot;</span><span class="o">)</span>
                 <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">full_split</span> <span class="n">regexp</span> <span class="n">contents</span><span class="o">)));</span>
         <span class="n">close_in</span> <span class="n">in_channel</span>
       <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span>
         <span class="n">close_in</span> <span class="n">in_channel</span><span class="o">;</span>
         <span class="k">raise</span> <span class="n">e</span><span class="o">)</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">))</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* headerfy - change certain chapter headers to html *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">line_stream_of_channel</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">channel</span><span class="o">)</span> <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="nc">None</span><span class="o">)</span>

<span class="k">let</span> <span class="n">paragraph_stream_of_channel</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">line_stream_of_channel</span> <span class="n">channel</span> <span class="k">in</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">next</span> <span class="n">para_lines</span> <span class="n">i</span> <span class="o">=</span>
    <span class="k">match</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">peek</span> <span class="n">lines</span><span class="o">,</span> <span class="n">para_lines</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">None</span><span class="o">,</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="nc">None</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="s2">&quot;&quot;</span><span class="o">,</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">lines</span><span class="o">;</span> <span class="n">next</span> <span class="n">para_lines</span> <span class="n">i</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="s2">&quot;&quot;</span><span class="o">,</span> <span class="o">_</span>
      <span class="o">|</span> <span class="nc">None</span><span class="o">,</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nc">Some</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="n">para_lines</span><span class="o">))</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">line</span><span class="o">,</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">lines</span><span class="o">;</span> <span class="n">next</span> <span class="o">(</span><span class="n">line</span> <span class="o">::</span> <span class="n">para_lines</span><span class="o">)</span> <span class="n">i</span> <span class="k">in</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span> <span class="o">(</span><span class="n">next</span> <span class="bp">[]</span><span class="o">)</span>

<span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;^Chapter[</span><span class="se">\r\n\t</span><span class="s2"> ]+[0-9]+[</span><span class="se">\r\n\t</span><span class="s2"> ]*:[^</span><span class="se">\r\n</span><span class="s2">]*&quot;</span>

<span class="k">let</span> <span class="n">headerfy</span> <span class="n">chunk</span> <span class="o">=</span>
  <span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span>
       <span class="o">(</span><span class="k">function</span>
          <span class="o">|</span> <span class="nn">Str</span><span class="p">.</span><span class="nc">Text</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span>
          <span class="o">|</span> <span class="nn">Str</span><span class="p">.</span><span class="nc">Delim</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="s2">&quot;&lt;H1&gt;&quot;</span> <span class="o">^</span> <span class="n">s</span> <span class="o">^</span> <span class="s2">&quot;&lt;/H1&gt;&quot;</span><span class="o">)</span>
       <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">full_split</span> <span class="n">regexp</span> <span class="n">chunk</span><span class="o">))</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">filename</span> <span class="o">-&gt;</span>
       <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span> <span class="n">open_in</span> <span class="n">filename</span> <span class="k">in</span>
       <span class="k">try</span>
         <span class="nn">Stream</span><span class="p">.</span><span class="n">iter</span>
           <span class="o">(</span><span class="k">fun</span> <span class="n">para</span> <span class="o">-&gt;</span>
              <span class="n">print_endline</span> <span class="o">(</span><span class="n">headerfy</span> <span class="n">para</span><span class="o">);</span>
              <span class="n">print_newline</span> <span class="bp">()</span><span class="o">)</span>
           <span class="o">(</span><span class="n">paragraph_stream_of_channel</span> <span class="n">in_channel</span><span class="o">);</span>
         <span class="n">close_in</span> <span class="n">in_channel</span>
       <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span>
         <span class="n">close_in</span> <span class="n">in_channel</span><span class="o">;</span>
         <span class="k">raise</span> <span class="n">e</span><span class="o">)</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">))</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN306"
>Reading Records with a Pattern Separator</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">chunks</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="k">begin</span>
    <span class="k">try</span> <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span> <span class="n">lines</span> <span class="o">:=</span> <span class="n">input_line</span> <span class="n">stdin</span> <span class="o">::</span> <span class="o">!</span><span class="n">lines</span> <span class="k">done</span>
    <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span>
  <span class="k">end</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">contents</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="o">!</span><span class="n">lines</span><span class="o">)</span> <span class="k">in</span>
  <span class="nn">Str</span><span class="p">.</span><span class="n">full_split</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;^</span><span class="se">\\</span><span class="s2">.</span><span class="se">\\</span><span class="s2">(Ch</span><span class="se">\\</span><span class="s2">|Se</span><span class="se">\\</span><span class="s2">|Ss</span><span class="se">\\</span><span class="s2">)$&quot;</span><span class="o">)</span> <span class="n">contents</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span>
    <span class="s2">&quot;I read %d chunks.</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">length</span> <span class="n">chunks</span><span class="o">)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN309"
>Extracting a Range of Lines</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="c">(* Creates a stream that produces ranges of items from another stream.</span>
<span class="c">   Production of items starts when when (start_test count item) returns</span>
<span class="c">   true and stops when (finish_test count item) returns true. Multiple</span>
<span class="c">   ranges will be produced if start_test returns true again. The count</span>
<span class="c">   starts at 1. Ranges are inclusive; the item that causes finish_test</span>
<span class="c">   to return true will be produced. *)</span>
<span class="k">let</span> <span class="n">stream_range</span> <span class="n">start_test</span> <span class="n">finish_test</span> <span class="n">stream</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">active</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">1</span> <span class="k">in</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">next</span> <span class="n">i</span> <span class="o">=</span>
    <span class="k">match</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">peek</span> <span class="n">stream</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="nc">None</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">item</span> <span class="o">-&gt;</span>
          <span class="k">if</span> <span class="n">not</span> <span class="o">!</span><span class="n">active</span> <span class="k">then</span>
            <span class="k">begin</span>
              <span class="k">if</span> <span class="n">start_test</span> <span class="o">!</span><span class="n">count</span> <span class="n">item</span>
              <span class="k">then</span> <span class="o">(</span><span class="n">active</span> <span class="o">:=</span> <span class="bp">true</span><span class="o">;</span> <span class="n">next</span> <span class="n">i</span><span class="o">)</span>
              <span class="k">else</span> <span class="o">(</span><span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">stream</span><span class="o">;</span> <span class="n">incr</span> <span class="n">count</span><span class="o">;</span> <span class="n">next</span> <span class="n">i</span><span class="o">)</span>
            <span class="k">end</span>
          <span class="k">else</span>
            <span class="k">begin</span>
              <span class="k">if</span> <span class="n">finish_test</span> <span class="o">!</span><span class="n">count</span> <span class="n">item</span> <span class="k">then</span> <span class="n">active</span> <span class="o">:=</span> <span class="bp">false</span><span class="o">;</span>
              <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">stream</span><span class="o">;</span>
              <span class="n">incr</span> <span class="n">count</span><span class="o">;</span>
              <span class="nc">Some</span> <span class="n">item</span>
            <span class="k">end</span> <span class="k">in</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span> <span class="n">next</span>

<span class="c">(* Creates a stream that produces items between a pair of indices.</span>
<span class="c">   If start = 2 and finish = 4, items 2, 3, and 4 will be produced.</span>
<span class="c">   The first item is number 1. *)</span>
<span class="k">let</span> <span class="n">stream_range_numbers</span> <span class="n">start</span> <span class="n">finish</span> <span class="n">stream</span> <span class="o">=</span>
  <span class="n">stream_range</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">count</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">count</span> <span class="o">=</span> <span class="n">start</span><span class="o">)</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">count</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">count</span> <span class="o">=</span> <span class="n">finish</span><span class="o">)</span>
    <span class="n">stream</span>

<span class="c">(* Creates a stream that produces strings between a pair of regexps.</span>
<span class="c">   The regexp will be tested using Str.string_match. *)</span>
<span class="k">let</span> <span class="n">stream_range_patterns</span> <span class="n">start</span> <span class="n">finish</span> <span class="n">stream</span> <span class="o">=</span>
  <span class="n">stream_range</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="n">line</span> <span class="o">-&gt;</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">start</span> <span class="n">line</span> <span class="mi">0</span><span class="o">)</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="n">line</span> <span class="o">-&gt;</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">finish</span> <span class="n">line</span> <span class="mi">0</span><span class="o">)</span>
    <span class="n">stream</span>

<span class="c">(* Produce a stream of lines from an input channel. *)</span>
<span class="k">let</span> <span class="n">line_stream_of_channel</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">channel</span><span class="o">)</span> <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="nc">None</span><span class="o">)</span>

<span class="c">(* Print lines 15 through 17 inclusive. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">iter</span>
    <span class="n">print_endline</span>
    <span class="o">(</span><span class="n">stream_range_numbers</span> <span class="mi">15</span> <span class="mi">17</span>
       <span class="o">(</span><span class="n">line_stream_of_channel</span> <span class="o">(</span><span class="n">open_in</span> <span class="n">datafile</span><span class="o">)))</span>

<span class="c">(* Print out all &lt;XMP&gt; .. &lt;/XMP&gt; displays from HTML doc. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">iter</span>
    <span class="n">print_endline</span>
    <span class="o">(</span><span class="n">stream_range_patterns</span>
       <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;.*&lt;XMP&gt;&quot;</span><span class="o">)</span>
       <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;.*&lt;/XMP&gt;&quot;</span><span class="o">)</span>
       <span class="o">(</span><span class="n">line_stream_of_channel</span> <span class="n">stdin</span><span class="o">))</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">in_header</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">true</span>
<span class="k">let</span> <span class="n">in_body</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span>
       <span class="k">if</span> <span class="o">!</span><span class="n">in_header</span> <span class="o">&amp;&amp;</span> <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
       <span class="k">then</span> <span class="o">(</span><span class="n">in_header</span> <span class="o">:=</span> <span class="bp">false</span><span class="o">;</span> <span class="n">in_body</span> <span class="o">:=</span> <span class="bp">true</span><span class="o">)</span>
       <span class="k">else</span>
         <span class="k">begin</span>
           <span class="c">(* do something with line *)</span>
         <span class="k">end</span><span class="o">)</span>
    <span class="o">(</span><span class="n">line_stream_of_channel</span> <span class="n">stdin</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">module</span> <span class="nc">StringSet</span> <span class="o">=</span> <span class="nn">Set</span><span class="p">.</span><span class="nc">Make</span><span class="o">(</span><span class="nc">String</span><span class="o">)</span>
<span class="k">let</span> <span class="n">seen</span> <span class="o">=</span> <span class="n">ref</span> <span class="nn">StringSet</span><span class="p">.</span><span class="n">empty</span>
<span class="k">let</span> <span class="n">email_regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">([^&lt;&gt;(),; </span><span class="se">\t</span><span class="s2">]+@[^&lt;&gt;(),; </span><span class="se">\t</span><span class="s2">]+</span><span class="se">\\</span><span class="s2">)&quot;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span>
       <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
         <span class="o">(</span><span class="k">function</span>
            <span class="o">|</span> <span class="nn">Str</span><span class="p">.</span><span class="nc">Delim</span> <span class="n">email</span> <span class="o">-&gt;</span>
                <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="nn">StringSet</span><span class="p">.</span><span class="n">mem</span> <span class="n">email</span> <span class="o">!</span><span class="n">seen</span><span class="o">)</span>
                <span class="k">then</span>
                  <span class="k">begin</span>
                    <span class="n">seen</span> <span class="o">:=</span> <span class="nn">StringSet</span><span class="p">.</span><span class="n">add</span> <span class="n">email</span> <span class="o">!</span><span class="n">seen</span><span class="o">;</span>
                    <span class="n">print_endline</span> <span class="n">email</span><span class="o">;</span>
                  <span class="k">end</span>
            <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">)</span>
         <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">full_split</span> <span class="n">email_regexp</span> <span class="n">line</span><span class="o">))</span>
    <span class="o">(</span><span class="n">stream_range_patterns</span>
       <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;^From:?[ </span><span class="se">\t</span><span class="s2">]&quot;</span><span class="o">)</span>
       <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;^$&quot;</span><span class="o">)</span>
       <span class="o">(</span><span class="n">line_stream_of_channel</span> <span class="n">stdin</span><span class="o">))</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN312"
>Matching Shell Globs as Regular Expressions</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">regexp_string_of_glob</span> <span class="n">s</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">i</span><span class="o">,</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(-</span><span class="mi">1</span><span class="o">),</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">create</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span> <span class="o">+</span> <span class="mi">8</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">read</span> <span class="bp">()</span> <span class="o">=</span>
    <span class="n">incr</span> <span class="n">i</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">!</span><span class="n">i</span> <span class="o">&lt;</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span>
    <span class="k">then</span> <span class="nc">Some</span> <span class="n">s</span><span class="o">.[!</span><span class="n">i</span><span class="o">]</span>
    <span class="k">else</span> <span class="nc">None</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">write</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_string</span> <span class="n">buffer</span> <span class="k">in</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">parse_glob</span> <span class="bp">()</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">read</span> <span class="bp">()</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="sc">&#39;*&#39;</span> <span class="o">-&gt;</span> <span class="n">write</span> <span class="s2">&quot;.*&quot;</span><span class="o">;</span> <span class="n">parse_glob</span> <span class="bp">()</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="sc">&#39;?&#39;</span> <span class="o">-&gt;</span> <span class="n">write</span> <span class="s2">&quot;.&quot;</span><span class="o">;</span> <span class="n">parse_glob</span> <span class="bp">()</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="sc">&#39;[&#39;</span> <span class="o">-&gt;</span> <span class="n">parse_bracket</span> <span class="s2">&quot;&quot;</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">c</span> <span class="o">-&gt;</span> <span class="n">write</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">quote</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="mi">1</span> <span class="n">c</span><span class="o">));</span> <span class="n">parse_glob</span> <span class="bp">()</span>
      <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="bp">()</span>
  <span class="ow">and</span> <span class="n">parse_bracket</span> <span class="n">text</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">read</span> <span class="bp">()</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="sc">&#39;!&#39;</span> <span class="k">when</span> <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">-&gt;</span> <span class="n">parse_bracket</span> <span class="s2">&quot;^&quot;</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="sc">&#39;]&#39;</span> <span class="o">-&gt;</span> <span class="n">write</span> <span class="o">(</span><span class="s2">&quot;[&quot;</span> <span class="o">^</span> <span class="n">text</span> <span class="o">^</span> <span class="s2">&quot;]&quot;</span><span class="o">);</span> <span class="n">parse_glob</span> <span class="bp">()</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">c</span> <span class="o">-&gt;</span> <span class="n">parse_bracket</span> <span class="o">(</span><span class="n">text</span> <span class="o">^</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="mi">1</span> <span class="n">c</span><span class="o">))</span>
      <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="n">write</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">quote</span> <span class="o">(</span><span class="s2">&quot;[&quot;</span> <span class="o">^</span> <span class="n">text</span><span class="o">))</span> <span class="k">in</span>
  <span class="n">write</span> <span class="s2">&quot;^&quot;</span><span class="o">;</span>
  <span class="n">parse_glob</span> <span class="bp">()</span><span class="o">;</span>
  <span class="n">write</span> <span class="s2">&quot;$&quot;</span><span class="o">;</span>
  <span class="nn">Buffer</span><span class="p">.</span><span class="n">contents</span> <span class="n">buffer</span>

<span class="k">let</span> <span class="n">regexp_of_glob</span> <span class="n">s</span> <span class="o">=</span>
  <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="o">(</span><span class="n">regexp_string_of_glob</span> <span class="n">s</span><span class="o">)</span>

<span class="k">let</span> <span class="n">regexp_of_glob_case_fold</span> <span class="n">s</span> <span class="o">=</span>
  <span class="nn">Str</span><span class="p">.</span><span class="n">regexp_case_fold</span> <span class="o">(</span><span class="n">regexp_string_of_glob</span> <span class="n">s</span><span class="o">)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN315"
>Speeding Up Interpolated Matches</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">popstates</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;CO&quot;</span><span class="o">;</span> <span class="s2">&quot;ON&quot;</span><span class="o">;</span> <span class="s2">&quot;MI&quot;</span><span class="o">;</span> <span class="s2">&quot;WI&quot;</span><span class="o">;</span> <span class="s2">&quot;MN&quot;</span><span class="o">]</span>

<span class="c">(* Naive version: Compile a regexp each time it is needed. *)</span>
<span class="k">let</span> <span class="n">popgrep1</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">begin</span>
      <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
        <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">stdin</span> <span class="k">in</span>
        <span class="k">try</span>
          <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
            <span class="o">(</span><span class="k">fun</span> <span class="n">state</span> <span class="o">-&gt;</span>
               <span class="k">if</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span>
                     <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="o">(</span><span class="s2">&quot;.*</span><span class="se">\\</span><span class="s2">b&quot;</span> <span class="o">^</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">quote</span> <span class="n">state</span><span class="o">)</span> <span class="o">^</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">b&quot;</span><span class="o">))</span>
                     <span class="n">line</span> <span class="mi">0</span><span class="o">)</span>
               <span class="k">then</span> <span class="o">(</span><span class="n">print_endline</span> <span class="n">line</span><span class="o">;</span> <span class="k">raise</span> <span class="nc">Exit</span><span class="o">))</span>
            <span class="n">popstates</span>
        <span class="k">with</span> <span class="nc">Exit</span> <span class="o">-&gt;</span> <span class="bp">()</span>
      <span class="k">done</span>
    <span class="k">end</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span>

<span class="c">(* First optimization: Compile the regexps in advance. *)</span>
<span class="k">let</span> <span class="n">popgrep2</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">popstate_regexps</span> <span class="o">=</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">map</span>
      <span class="o">(</span><span class="k">fun</span> <span class="n">state</span> <span class="o">-&gt;</span>
         <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="o">(</span><span class="s2">&quot;.*</span><span class="se">\\</span><span class="s2">b&quot;</span> <span class="o">^</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">quote</span> <span class="n">state</span><span class="o">)</span> <span class="o">^</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">b&quot;</span><span class="o">))</span>
      <span class="n">popstates</span> <span class="k">in</span>
  <span class="k">try</span>
    <span class="k">begin</span>
      <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
        <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">stdin</span> <span class="k">in</span>
        <span class="k">try</span>
          <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
            <span class="o">(</span><span class="k">fun</span> <span class="n">regexp</span> <span class="o">-&gt;</span>
               <span class="k">if</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">regexp</span> <span class="n">line</span> <span class="mi">0</span><span class="o">)</span>
               <span class="k">then</span> <span class="o">(</span><span class="n">print_endline</span> <span class="n">line</span><span class="o">;</span> <span class="k">raise</span> <span class="nc">Exit</span><span class="o">))</span>
            <span class="n">popstate_regexps</span>
        <span class="k">with</span> <span class="nc">Exit</span> <span class="o">-&gt;</span> <span class="bp">()</span>
      <span class="k">done</span>
    <span class="k">end</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span>

<span class="c">(* Second optimization: Build a single regexp for all states. *)</span>
<span class="k">let</span> <span class="n">popgrep3</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">popstates_regexp</span> <span class="o">=</span>
    <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span>
      <span class="o">(</span><span class="s2">&quot;.*</span><span class="se">\\</span><span class="s2">b</span><span class="se">\\</span><span class="s2">(&quot;</span>
       <span class="o">^</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">|&quot;</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="nn">Str</span><span class="p">.</span><span class="n">quote</span> <span class="n">popstates</span><span class="o">))</span>
       <span class="o">^</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">)</span><span class="se">\\</span><span class="s2">b&quot;</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">try</span>
    <span class="k">begin</span>
      <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
        <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">stdin</span> <span class="k">in</span>
        <span class="k">if</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">popstates_regexp</span> <span class="n">line</span> <span class="mi">0</span>
        <span class="k">then</span> <span class="n">print_endline</span> <span class="n">line</span>
      <span class="k">done</span>
    <span class="k">end</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span>

<span class="c">(* Speed tests with a 15,000 line input file: *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">popgrep1</span> <span class="bp">()</span>         <span class="c">(* time: 13.670s *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">popgrep2</span> <span class="bp">()</span>         <span class="c">(* time:  0.264s *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">popgrep3</span> <span class="bp">()</span>         <span class="c">(* time:  0.123s *)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN318"
>Testing for a Valid Pattern</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
    <span class="n">print_string</span> <span class="s2">&quot;Pattern? &quot;</span><span class="o">;</span>
    <span class="n">flush</span> <span class="n">stdout</span><span class="o">;</span>
    <span class="k">let</span> <span class="n">pattern</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">stdin</span> <span class="k">in</span>
    <span class="k">try</span> <span class="n">ignore</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="n">pattern</span><span class="o">)</span>
    <span class="k">with</span> <span class="nc">Failure</span> <span class="n">message</span> <span class="o">-&gt;</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;INVALID PATTERN: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">message</span>
  <span class="k">done</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">is_valid_pattern</span> <span class="n">pattern</span> <span class="o">=</span>
  <span class="k">try</span> <span class="n">ignore</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="n">pattern</span><span class="o">);</span> <span class="bp">true</span>
  <span class="k">with</span> <span class="nc">Failure</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* paragrep - trivial paragraph grepper *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">line_stream_of_channel</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">channel</span><span class="o">)</span> <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="nc">None</span><span class="o">)</span>

<span class="k">let</span> <span class="n">paragraph_stream_of_channel</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">line_stream_of_channel</span> <span class="n">channel</span> <span class="k">in</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">next</span> <span class="n">para_lines</span> <span class="n">i</span> <span class="o">=</span>
    <span class="k">match</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">peek</span> <span class="n">lines</span><span class="o">,</span> <span class="n">para_lines</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">None</span><span class="o">,</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="nc">None</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="s2">&quot;&quot;</span><span class="o">,</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">lines</span><span class="o">;</span> <span class="n">next</span> <span class="n">para_lines</span> <span class="n">i</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="s2">&quot;&quot;</span><span class="o">,</span> <span class="o">_</span>
      <span class="o">|</span> <span class="nc">None</span><span class="o">,</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nc">Some</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="n">para_lines</span><span class="o">))</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">line</span><span class="o">,</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">lines</span><span class="o">;</span> <span class="n">next</span> <span class="o">(</span><span class="n">line</span> <span class="o">::</span> <span class="n">para_lines</span><span class="o">)</span> <span class="n">i</span> <span class="k">in</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span> <span class="o">(</span><span class="n">next</span> <span class="bp">[]</span><span class="o">)</span>

<span class="k">let</span> <span class="n">paragrep</span> <span class="n">pat</span> <span class="n">files</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span>
    <span class="k">begin</span>
      <span class="k">try</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="n">pat</span>
      <span class="k">with</span> <span class="nc">Failure</span> <span class="n">msg</span> <span class="o">-&gt;</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s: Bad pattern %s: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span> <span class="n">pat</span> <span class="n">msg</span><span class="o">;</span>
        <span class="n">exit</span> <span class="mi">1</span>
    <span class="k">end</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">file</span> <span class="o">-&gt;</span>
       <span class="k">let</span> <span class="n">channel</span> <span class="o">=</span>
         <span class="k">if</span> <span class="n">file</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
         <span class="k">then</span> <span class="n">stdin</span>
         <span class="k">else</span> <span class="n">open_in</span> <span class="n">file</span> <span class="k">in</span>
       <span class="k">try</span>
         <span class="nn">Stream</span><span class="p">.</span><span class="n">iter</span>
           <span class="o">(</span><span class="k">fun</span> <span class="n">para</span> <span class="o">-&gt;</span>
              <span class="n">incr</span> <span class="n">count</span><span class="o">;</span>
              <span class="k">try</span>
                <span class="n">ignore</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span> <span class="n">regexp</span> <span class="n">para</span> <span class="mi">0</span><span class="o">);</span>
                <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s %d: %s</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="n">file</span> <span class="o">!</span><span class="n">count</span> <span class="n">para</span>
              <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">)</span>
           <span class="o">(</span><span class="n">paragraph_stream_of_channel</span> <span class="n">channel</span><span class="o">);</span>
         <span class="n">close_in</span> <span class="n">channel</span>
       <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span>
         <span class="n">close_in</span> <span class="n">channel</span><span class="o">;</span>
         <span class="k">raise</span> <span class="n">e</span><span class="o">)</span>
    <span class="n">files</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">match</span> <span class="nn">List</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">)</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">pat</span> <span class="o">::</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="n">paragrep</span> <span class="n">pat</span> <span class="o">[</span><span class="s2">&quot;-&quot;</span><span class="o">]</span>
    <span class="o">|</span> <span class="n">pat</span> <span class="o">::</span> <span class="n">files</span> <span class="o">-&gt;</span> <span class="n">paragrep</span> <span class="n">pat</span> <span class="n">files</span>
    <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;usage: %s pat [files]</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">safe_pat</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">quote</span> <span class="n">pat</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN321"
>Honoring Locale Settings in Regular Expressions</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* OCaml does not provide a way to change the locale, and PCRE does</span>
<span class="c">   not appear to be sensitive to the default locale. Regardless, Str</span>
<span class="c">   does not support locales, and PCRE only matches ASCII characters</span>
<span class="c">   for \w and friends. This example instead demonstrates the use of</span>
<span class="c">   PCRE&#39;s UTF-8 support to match words, and it does not use locales. *)</span>

<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+pcre&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;pcre.cma&quot;</span><span class="o">;;</span>

<span class="c">(* encoded as UTF-8 *)</span>
<span class="k">let</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;andreas k</span><span class="se">\xc3\xb6</span><span class="s2">nig&quot;</span>

<span class="c">(* the original regexp which is not Unicode-aware *)</span>
<span class="k">let</span> <span class="n">ascii_regexp</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">b(</span><span class="se">\\</span><span class="s2">w+)</span><span class="se">\\</span><span class="s2">b&quot;</span>

<span class="c">(* a revised regexp which tests for Unicode letters and numbers *)</span>
<span class="k">let</span> <span class="n">utf8_regexp</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="o">~</span><span class="n">flags</span><span class="o">:[`</span><span class="nc">UTF8</span><span class="o">]</span> <span class="s2">&quot;([</span><span class="se">\\</span><span class="s2">pL</span><span class="se">\\</span><span class="s2">pN]+)&quot;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">enc</span><span class="o">,</span> <span class="n">regexp</span><span class="o">)</span> <span class="o">-&gt;</span>
       <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s names: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">enc</span>
         <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot; &quot;</span>
            <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span>
               <span class="nn">String</span><span class="p">.</span><span class="n">capitalize</span>
               <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">flatten</span>
                  <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span>
                     <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">map</span>
                        <span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span>
                        <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">extract_all</span>
                           <span class="o">~</span><span class="n">full_match</span><span class="o">:</span><span class="bp">false</span>
                           <span class="o">~</span><span class="n">rex</span><span class="o">:</span><span class="n">regexp</span>
                           <span class="n">name</span><span class="o">)))))))</span>
    <span class="o">[</span><span class="s2">&quot;ASCII&quot;</span><span class="o">,</span> <span class="n">ascii_regexp</span><span class="o">;</span> <span class="s2">&quot;UTF-8&quot;</span><span class="o">,</span> <span class="n">utf8_regexp</span><span class="o">]</span>

<span class="c">(*</span>
<span class="c">  ASCII names: Andreas K Nig</span>
<span class="c">  UTF-8 names: Andreas Knig</span>
<span class="c">*)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN324"
>Approximate Matching</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* Calculates the Levenshtein, or edit distance, between two strings. *)</span>
<span class="k">let</span> <span class="n">levenshtein</span> <span class="n">s</span> <span class="n">t</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">n</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">m</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">t</span> <span class="k">in</span>
  <span class="k">match</span> <span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="n">n</span><span class="o">)</span> <span class="k">with</span>
    <span class="o">|</span> <span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">m</span>
    <span class="o">|</span> <span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">n</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">n</span>
    <span class="o">|</span> <span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="n">n</span><span class="o">)</span> <span class="o">-&gt;</span>
        <span class="k">let</span> <span class="n">d</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">init</span> <span class="o">(</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">)</span> <span class="k">in</span>
        <span class="k">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
        <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">to</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">do</span>
          <span class="k">let</span> <span class="n">e</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="k">in</span>
          <span class="k">for</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">to</span> <span class="n">m</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">do</span>
            <span class="k">let</span> <span class="n">cost</span> <span class="o">=</span> <span class="k">if</span> <span class="n">s</span><span class="o">.[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">t</span><span class="o">.[</span><span class="n">j</span><span class="o">]</span> <span class="k">then</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span> <span class="k">in</span>
            <span class="n">x</span> <span class="o">:=</span>
              <span class="n">min</span>
                <span class="o">(</span><span class="n">d</span><span class="o">.(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span>      <span class="c">(* insertion *)</span>
                <span class="o">(</span><span class="n">min</span>
                   <span class="o">(!</span><span class="n">e</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span>          <span class="c">(* deletion *)</span>
                   <span class="o">(</span><span class="n">d</span><span class="o">.(</span><span class="n">j</span><span class="o">)</span> <span class="o">+</span> <span class="n">cost</span><span class="o">));</span>  <span class="c">(* substitution *)</span>
            <span class="n">d</span><span class="o">.(</span><span class="n">j</span><span class="o">)</span> <span class="o">&lt;-</span> <span class="o">!</span><span class="n">e</span><span class="o">;</span>
            <span class="n">e</span> <span class="o">:=</span> <span class="o">!</span><span class="n">x</span>
          <span class="k">done</span><span class="o">;</span>
          <span class="n">d</span><span class="o">.(</span><span class="n">m</span><span class="o">)</span> <span class="o">&lt;-</span> <span class="o">!</span><span class="n">x</span>
        <span class="k">done</span><span class="o">;</span>
        <span class="o">!</span><span class="n">x</span>

<span class="c">(* Determines if two strings are an approximate match. *)</span>
<span class="k">let</span> <span class="n">amatch</span> <span class="o">?(</span><span class="n">percentage</span><span class="o">=</span><span class="mi">20</span><span class="o">)</span> <span class="n">s</span> <span class="n">t</span> <span class="o">=</span>
  <span class="n">levenshtein</span> <span class="n">s</span> <span class="n">t</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span> <span class="o">&lt;=</span> <span class="n">percentage</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">dict</span> <span class="o">=</span> <span class="n">open_in</span> <span class="s2">&quot;/usr/dict/words&quot;</span> <span class="k">in</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="k">let</span> <span class="n">word</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">dict</span> <span class="k">in</span>
      <span class="k">if</span> <span class="n">amatch</span> <span class="s2">&quot;balast&quot;</span> <span class="n">word</span>
      <span class="k">then</span> <span class="n">print_endline</span> <span class="n">word</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="n">close_in</span> <span class="n">dict</span>

<span class="c">(*</span>
<span class="c">  ballast</span>
<span class="c">  blast</span>
<span class="c">*)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN327"
>Matching from Where the Last Pattern Left Off</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+pcre&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;pcre.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;12 345 hello 6 7world89 10&quot;</span>
<span class="k">let</span> <span class="n">rex</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;(</span><span class="se">\\</span><span class="s2">d+)&quot;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">subs</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">exec</span> <span class="o">~</span><span class="n">rex</span> <span class="n">s</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Found %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">get_substring</span> <span class="o">!</span><span class="n">subs</span> <span class="mi">1</span><span class="o">);</span>
      <span class="n">subs</span> <span class="o">:=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">next_match</span> <span class="o">~</span><span class="n">rex</span> <span class="o">!</span><span class="n">subs</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">()</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">n</span> <span class="o">=</span> <span class="s2">&quot;   49 here&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">n</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">replace</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">G &quot;</span> <span class="o">~</span><span class="n">templ</span><span class="o">:</span><span class="s2">&quot;0&quot;</span> <span class="n">n</span> <span class="k">in</span>
  <span class="n">print_endline</span> <span class="n">n</span>

<span class="c">(* 00049 here *)</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;3,4,5,9,120&quot;</span>
<span class="k">let</span> <span class="n">rex</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">G,?(</span><span class="se">\\</span><span class="s2">d+)&quot;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">subs</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">exec</span> <span class="o">~</span><span class="n">rex</span> <span class="n">s</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Found number %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">get_substring</span> <span class="o">!</span><span class="n">subs</span> <span class="mi">1</span><span class="o">);</span>
      <span class="n">subs</span> <span class="o">:=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">next_match</span> <span class="o">~</span><span class="n">rex</span> <span class="o">!</span><span class="n">subs</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">()</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;The year 1752 lost 10 days on the 3rd of September&quot;</span>

<span class="k">let</span> <span class="n">rex</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;(</span><span class="se">\\</span><span class="s2">d+)&quot;</span>
<span class="k">let</span> <span class="n">subs</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">exec</span> <span class="o">~</span><span class="n">rex</span> <span class="n">s</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Found number %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">get_substring</span> <span class="o">!</span><span class="n">subs</span> <span class="mi">1</span><span class="o">);</span>
      <span class="n">subs</span> <span class="o">:=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">next_match</span> <span class="o">~</span><span class="n">rex</span> <span class="o">!</span><span class="n">subs</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">()</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">rex</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">G(</span><span class="se">\\</span><span class="s2">S+)&quot;</span> <span class="k">in</span>
  <span class="n">subs</span> <span class="o">:=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">next_match</span> <span class="o">~</span><span class="n">rex</span> <span class="o">!</span><span class="n">subs</span><span class="o">;</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Found %s after the last number.</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">get_substring</span> <span class="o">!</span><span class="n">subs</span> <span class="mi">1</span><span class="o">)</span>

<span class="c">(*</span>
<span class="c">  Found number 1752</span>
<span class="c">  Found number 10</span>
<span class="c">  Found number 3</span>
<span class="c">  Found rd after the last number.</span>
<span class="c">*)</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">match</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">get_substring_ofs</span> <span class="o">!</span><span class="n">subs</span> <span class="mi">1</span> <span class="k">with</span>
    <span class="o">|</span> <span class="o">(</span><span class="n">start</span><span class="o">,</span> <span class="n">finish</span><span class="o">)</span> <span class="o">-&gt;</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span>
          <span class="s2">&quot;The position in &#39;s&#39; is %d..%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">start</span> <span class="n">finish</span>

<span class="c">(* The position in &#39;s&#39; is 35..37 *)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN330"
>Greedy and Non-Greedy Matches</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;Even &lt;TT&gt;vi&lt;/TT&gt; can edit &lt;TT&gt;troff&lt;/TT&gt; effectively.&quot;</span>

<span class="c">(* The Str library does not support non-greedy matches. In many cases,</span>
<span class="c">   you can turn a non-greedy match into a greedy one, however: *)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">print_endline</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">global_replace</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;&lt;.*&gt;&quot;</span><span class="o">)</span> <span class="s2">&quot;&quot;</span> <span class="n">s</span><span class="o">)</span>
<span class="c">(* Even  effectively. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">print_endline</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">global_replace</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;&lt;[^&gt;]*&gt;&quot;</span><span class="o">)</span> <span class="s2">&quot;&quot;</span> <span class="n">s</span><span class="o">)</span>
<span class="c">(* Even vi can edit troff effectively. *)</span>

<span class="c">(* If you need non-greedy matches, you&#39;ll want to use PCRE instead: *)</span>

<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+pcre&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;pcre.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">print_endline</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">replace</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;&lt;.*?&gt;&quot;</span> <span class="o">~</span><span class="n">templ</span><span class="o">:</span><span class="s2">&quot;&quot;</span> <span class="n">s</span><span class="o">)</span>
<span class="c">(* Even vi can edit troff effectively. *)</span>

<span class="c">(* Non-greedy matches don&#39;t always work the way you expect: *)</span>

<span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;&lt;b&gt;&lt;i&gt;this&lt;/i&gt; and &lt;i&gt;that&lt;/i&gt; are important&lt;/b&gt; Oh, &lt;b&gt;&lt;i&gt;me too!&lt;/i&gt;&lt;/b&gt;&quot;</span>

<span class="k">let</span> <span class="n">rex</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;&lt;b&gt;&lt;i&gt;(.*?)&lt;/i&gt;&lt;/b&gt;&quot;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">print_endline</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">extract</span> <span class="o">~</span><span class="n">rex</span> <span class="n">s</span><span class="o">).(</span><span class="mi">1</span><span class="o">)</span>
<span class="c">(* this&lt;/i&gt; and &lt;i&gt;that&lt;/i&gt; are important&lt;/b&gt; Oh, &lt;b&gt;&lt;i&gt;me too! *)</span>

<span class="c">(* One solution is to use a non-grouping negative lookahead assertion: *)</span>

<span class="k">let</span> <span class="n">rex</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;&lt;b&gt;&lt;i&gt;((?:(?!&lt;/b&gt;|&lt;/i&gt;).)*)&lt;/i&gt;&lt;/b&gt;&quot;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">print_endline</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">extract</span> <span class="o">~</span><span class="n">rex</span> <span class="n">s</span><span class="o">).(</span><span class="mi">1</span><span class="o">)</span>
<span class="c">(* me too! *)</span>

<span class="c">(* If performance is important, here is a faster technique: *)</span>

<span class="k">let</span> <span class="n">rex</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="o">~</span><span class="n">flags</span><span class="o">:[`</span><span class="nc">DOTALL</span><span class="o">;</span> <span class="o">`</span><span class="nc">EXTENDED</span><span class="o">]</span> <span class="s2">&quot;</span>
<span class="s2">    &lt;b&gt;&lt;i&gt;</span>
<span class="s2">    [^&lt;]*  # stuff not possibly bad, and not possibly the end.</span>
<span class="s2">    (?:</span>
<span class="s2"> # at this point, we can have &#39;&lt;&#39; if not part of something bad</span>
<span class="s2">     (?!  &lt;/?[ib]&gt;  )   # what we can&#39;t have</span>
<span class="s2">     &lt;                  # okay, so match the &#39;&lt;&#39;</span>
<span class="s2">     [^&lt;]*              # and continue with more safe stuff</span>
<span class="s2">    ) *</span>
<span class="s2">    &lt;/i&gt;&lt;/b&gt;</span>
<span class="s2">&quot;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">print_endline</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">extract</span> <span class="o">~</span><span class="n">rex</span> <span class="n">s</span><span class="o">).(</span><span class="mi">0</span><span class="o">)</span>
<span class="c">(* &lt;b&gt;&lt;i&gt;me too!&lt;/i&gt;&lt;/b&gt; *)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN333"
>Detecting Duplicate Words</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+pcre&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;pcre.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">line_stream_of_channel</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">channel</span><span class="o">)</span> <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="nc">None</span><span class="o">)</span>

<span class="k">let</span> <span class="n">paragraph_stream_of_channel</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">line_stream_of_channel</span> <span class="n">channel</span> <span class="k">in</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">next</span> <span class="n">para_lines</span> <span class="n">i</span> <span class="o">=</span>
    <span class="k">match</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">peek</span> <span class="n">lines</span><span class="o">,</span> <span class="n">para_lines</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">None</span><span class="o">,</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="nc">None</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="s2">&quot;&quot;</span><span class="o">,</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">lines</span><span class="o">;</span> <span class="n">next</span> <span class="n">para_lines</span> <span class="n">i</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="s2">&quot;&quot;</span><span class="o">,</span> <span class="o">_</span>
      <span class="o">|</span> <span class="nc">None</span><span class="o">,</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nc">Some</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="n">para_lines</span><span class="o">))</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">line</span><span class="o">,</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">lines</span><span class="o">;</span> <span class="n">next</span> <span class="o">(</span><span class="n">line</span> <span class="o">::</span> <span class="n">para_lines</span><span class="o">)</span> <span class="n">i</span> <span class="k">in</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span> <span class="o">(</span><span class="n">next</span> <span class="bp">[]</span><span class="o">)</span>

<span class="k">let</span> <span class="n">find_dup_words</span> <span class="n">files</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">rex</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="o">~</span><span class="n">flags</span><span class="o">:[`</span><span class="nc">CASELESS</span><span class="o">;</span> <span class="o">`</span><span class="nc">EXTENDED</span><span class="o">]</span> <span class="s2">&quot;</span>
<span class="s2">      </span><span class="se">\\</span><span class="s2">b            # start at a word boundary (begin letters)</span>
<span class="s2">      (</span><span class="se">\\</span><span class="s2">S+)         # find chunk of non-whitespace</span>
<span class="s2">      </span><span class="se">\\</span><span class="s2">b            # until another word boundary (end letters)</span>
<span class="s2">      (</span>
<span class="s2">          </span><span class="se">\\</span><span class="s2">s+       # separated by some whitespace</span>
<span class="s2">          </span><span class="se">\\</span><span class="s2">1        # and that very same chunk again</span>
<span class="s2">          </span><span class="se">\\</span><span class="s2">b        # until another word boundary</span>
<span class="s2">      ) +            # one or more sets of those</span>
<span class="s2">  &quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">file</span> <span class="o">-&gt;</span>
       <span class="k">let</span> <span class="n">channel</span> <span class="o">=</span> <span class="k">if</span> <span class="n">file</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span> <span class="k">then</span> <span class="n">stdin</span> <span class="k">else</span> <span class="n">open_in</span> <span class="n">file</span> <span class="k">in</span>
       <span class="k">try</span>
         <span class="nn">Stream</span><span class="p">.</span><span class="n">iter</span>
           <span class="o">(</span><span class="k">fun</span> <span class="n">para</span> <span class="o">-&gt;</span>
              <span class="n">incr</span> <span class="n">count</span><span class="o">;</span>
              <span class="k">try</span>
                <span class="k">let</span> <span class="n">subs</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">exec</span> <span class="o">~</span><span class="n">rex</span> <span class="n">para</span><span class="o">)</span> <span class="k">in</span>
                <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
                  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;dup word &#39;%s&#39; at paragraph %d.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">get_substring</span> <span class="o">!</span><span class="n">subs</span> <span class="mi">1</span><span class="o">)</span>
                    <span class="o">!</span><span class="n">count</span><span class="o">;</span>
                  <span class="n">flush</span> <span class="n">stdout</span><span class="o">;</span>
                  <span class="n">subs</span> <span class="o">:=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">next_match</span> <span class="o">~</span><span class="n">rex</span> <span class="o">!</span><span class="n">subs</span><span class="o">;</span>
                <span class="k">done</span>
              <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">)</span>
           <span class="o">(</span><span class="n">paragraph_stream_of_channel</span> <span class="n">channel</span><span class="o">);</span>
         <span class="n">close_in</span> <span class="n">channel</span>
       <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span>
         <span class="n">close_in</span> <span class="n">channel</span><span class="o">;</span>
         <span class="k">raise</span> <span class="n">e</span><span class="o">)</span>
    <span class="n">files</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">match</span> <span class="nn">List</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">)</span> <span class="k">with</span>
    <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="n">find_dup_words</span> <span class="o">[</span><span class="s2">&quot;-&quot;</span><span class="o">]</span>
    <span class="o">|</span> <span class="n">files</span> <span class="o">-&gt;</span> <span class="n">find_dup_words</span> <span class="n">files</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(*</span>
<span class="c">  This is a test</span>
<span class="c">  test of the duplicate word finder.</span>
<span class="c">*)</span>

<span class="c">(* dup word &#39;test&#39; at paragraph 1. *)</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">a</span> <span class="o">=</span> <span class="s2">&quot;nobody&quot;</span>
<span class="k">let</span> <span class="n">b</span> <span class="o">=</span> <span class="s2">&quot;bodysnatcher&quot;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">let</span> <span class="n">subs</span> <span class="o">=</span>
      <span class="nn">Pcre</span><span class="p">.</span><span class="n">exec</span>
        <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;^(</span><span class="se">\\</span><span class="s2">w+)(</span><span class="se">\\</span><span class="s2">w+) </span><span class="se">\\</span><span class="s2">2(</span><span class="se">\\</span><span class="s2">w+)$&quot;</span>
        <span class="o">(</span><span class="n">a</span> <span class="o">^</span> <span class="s2">&quot; &quot;</span> <span class="o">^</span> <span class="n">b</span><span class="o">)</span> <span class="k">in</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s overlaps in %s-%s-%s</span><span class="se">\n</span><span class="s2">&quot;</span>
      <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">get_substring</span> <span class="n">subs</span> <span class="mi">2</span><span class="o">)</span>
      <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">get_substring</span> <span class="n">subs</span> <span class="mi">1</span><span class="o">)</span>
      <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">get_substring</span> <span class="n">subs</span> <span class="mi">2</span><span class="o">)</span>
      <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">get_substring</span> <span class="n">subs</span> <span class="mi">3</span><span class="o">)</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
    <span class="bp">()</span>

<span class="c">(* body overlaps in no-body-snatcher *)</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* prime_pattern -- find prime factors of argument using pattern matching *)</span>
<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+pcre&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;pcre.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">arg</span> <span class="o">=</span> <span class="k">try</span> <span class="n">int_of_string</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span> <span class="k">with</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="mi">0</span>
<span class="k">let</span> <span class="n">n</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="n">arg</span> <span class="sc">&#39;o&#39;</span><span class="o">)</span>
<span class="k">let</span> <span class="n">rex</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;^(oo+?)</span><span class="se">\\</span><span class="s2">1+$&quot;</span>
<span class="k">let</span> <span class="n">templ</span> <span class="o">=</span> <span class="s2">&quot;o&quot;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="k">let</span> <span class="n">pat</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">get_substring</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">exec</span> <span class="o">~</span><span class="n">rex</span> <span class="o">!</span><span class="n">n</span><span class="o">)</span> <span class="mi">1</span> <span class="k">in</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%d &quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">pat</span><span class="o">);</span>
      <span class="n">n</span> <span class="o">:=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">replace</span> <span class="o">~</span><span class="n">pat</span> <span class="o">~</span><span class="n">templ</span> <span class="o">!</span><span class="n">n</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="o">!</span><span class="n">n</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">exception</span> <span class="nc">Found</span> <span class="k">of</span> <span class="o">(</span><span class="kt">int</span> <span class="o">*</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">int</span><span class="o">)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">match</span>
      <span class="nn">Pcre</span><span class="p">.</span><span class="n">extract</span>
        <span class="o">~</span><span class="n">full_match</span><span class="o">:</span><span class="bp">false</span>
        <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;^(o*)</span><span class="se">\\</span><span class="s2">1{11}(o*)</span><span class="se">\\</span><span class="s2">2{14}(o*)</span><span class="se">\\</span><span class="s2">3{15}$&quot;</span>
        <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="mi">281</span> <span class="sc">&#39;o&#39;</span><span class="o">)</span>
    <span class="k">with</span>
      <span class="o">|</span> <span class="o">[|</span> <span class="n">x</span><span class="o">;</span> <span class="n">y</span><span class="o">;</span> <span class="n">z</span> <span class="o">|]</span> <span class="o">-&gt;</span> <span class="k">raise</span> <span class="o">(</span><span class="nc">Found</span>
                                  <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">x</span><span class="o">,</span>
                                   <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">y</span><span class="o">,</span>
                                   <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">z</span><span class="o">))</span>
      <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">raise</span> <span class="nc">Not_found</span>
  <span class="k">with</span>
    <span class="o">|</span> <span class="nc">Found</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">,</span> <span class="n">z</span><span class="o">)</span> <span class="o">-&gt;</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;One solution is: x=%d; y=%d; z=%d.</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="n">x</span> <span class="n">y</span> <span class="n">z</span>
    <span class="o">|</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;No solution.</span><span class="se">\n</span><span class="s2">&quot;</span>

<span class="c">(* One solution is: x=17; y=3; z=2. *)</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;^(o+)</span><span class="se">\\</span><span class="s2">1{11}(o+)</span><span class="se">\\</span><span class="s2">2{14}(o+)</span><span class="se">\\</span><span class="s2">3{15}$&quot;</span>
<span class="c">(* One solution is: x=17; y=3; z=2. *)</span>

<span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;^(o*?)</span><span class="se">\\</span><span class="s2">1{11}(o*)</span><span class="se">\\</span><span class="s2">2{14}(o*)</span><span class="se">\\</span><span class="s2">3{15}$&quot;</span>
<span class="c">(* One solution is: x=0; y=7; z=11. *)</span>

<span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;^(o+?)</span><span class="se">\\</span><span class="s2">1{11}(o*)</span><span class="se">\\</span><span class="s2">2{14}(o*)</span><span class="se">\\</span><span class="s2">3{15}$&quot;</span>
<span class="c">(* One solution is: x=1; y=3; z=14. *)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN336"
>Expressing AND, OR, and NOT in a Single Pattern</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+pcre&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;pcre.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">pat</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">config_channel</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="k">if</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span> <span class="o">~</span><span class="n">pat</span> <span class="n">data</span> <span class="k">then</span> <span class="c">(* ... *)</span> <span class="bp">()</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* alpha OR beta *)</span>
<span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;alpha|beta&quot;</span>

<span class="c">(* alpha AND beta *)</span>
<span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="o">~</span><span class="n">flags</span><span class="o">:[`</span><span class="nc">DOTALL</span><span class="o">]</span> <span class="s2">&quot;^(?=.*alpha)(?=.*beta)&quot;</span>

<span class="c">(* alpha AND beta, no overlap *)</span>
<span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="o">~</span><span class="n">flags</span><span class="o">:[`</span><span class="nc">DOTALL</span><span class="o">]</span> <span class="s2">&quot;alpha.*beta|beta.*alpha&quot;</span>

<span class="c">(* NOT pat *)</span>
<span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="o">~</span><span class="n">flags</span><span class="o">:[`</span><span class="nc">DOTALL</span><span class="o">]</span> <span class="s2">&quot;^(?:(?!pat).)*$&quot;</span>

<span class="c">(* NOT bad BUT good *)</span>
<span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="o">~</span><span class="n">flags</span><span class="o">:[`</span><span class="nc">DOTALL</span><span class="o">]</span> <span class="s2">&quot;(?=(?:(?!bad).)*$)good&quot;</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span> <span class="o">~</span><span class="n">rex</span><span class="o">:</span><span class="n">regexp</span> <span class="n">text</span><span class="o">)</span>
  <span class="k">then</span> <span class="n">something</span> <span class="bp">()</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span> <span class="o">~</span><span class="n">rex</span><span class="o">:</span><span class="n">rexexp1</span> <span class="n">text</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span> <span class="o">~</span><span class="n">rex</span><span class="o">:</span><span class="n">rexexp2</span> <span class="n">text</span><span class="o">)</span>
  <span class="k">then</span> <span class="n">something</span> <span class="bp">()</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span> <span class="o">~</span><span class="n">rex</span><span class="o">:</span><span class="n">rexexp1</span> <span class="n">text</span><span class="o">)</span> <span class="o">||</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span> <span class="o">~</span><span class="n">rex</span><span class="o">:</span><span class="n">rexexp2</span> <span class="n">text</span><span class="o">)</span>
  <span class="k">then</span> <span class="n">something</span> <span class="bp">()</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* minigrep - trivial grep *)</span>
<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+pcre&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;pcre.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">line_stream_of_channel</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">channel</span><span class="o">)</span> <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="nc">None</span><span class="o">)</span>

<span class="k">let</span> <span class="n">minigrep</span> <span class="n">pat</span> <span class="n">files</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">rex</span> <span class="o">=</span>
    <span class="k">try</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="n">pat</span>
    <span class="k">with</span> <span class="nn">Pcre</span><span class="p">.</span><span class="nc">BadPattern</span> <span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s: Bad pattern %s: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span> <span class="n">pat</span> <span class="n">msg</span><span class="o">;</span>
      <span class="n">exit</span> <span class="mi">1</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">process</span> <span class="n">file</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">channel</span> <span class="o">=</span> <span class="k">if</span> <span class="n">file</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span> <span class="k">then</span> <span class="n">stdin</span> <span class="k">else</span> <span class="n">open_in</span> <span class="n">file</span> <span class="k">in</span>
    <span class="k">try</span>
      <span class="nn">Stream</span><span class="p">.</span><span class="n">iter</span>
        <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span> <span class="o">~</span><span class="n">rex</span> <span class="n">line</span> <span class="k">then</span> <span class="n">print_endline</span> <span class="n">line</span><span class="o">)</span>
        <span class="o">(</span><span class="n">line_stream_of_channel</span> <span class="n">channel</span><span class="o">);</span>
      <span class="n">close_in</span> <span class="n">channel</span>
    <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span>
      <span class="n">close_in</span> <span class="n">channel</span><span class="o">;</span>
      <span class="k">raise</span> <span class="n">e</span> <span class="k">in</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="n">process</span> <span class="n">files</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">match</span> <span class="nn">List</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">)</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">pat</span> <span class="o">::</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="n">minigrep</span> <span class="n">pat</span> <span class="o">[</span><span class="s2">&quot;-&quot;</span><span class="o">]</span>
    <span class="o">|</span> <span class="n">pat</span> <span class="o">::</span> <span class="n">files</span> <span class="o">-&gt;</span> <span class="n">minigrep</span> <span class="n">pat</span> <span class="n">files</span>
    <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;usage: %s pat [files]</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="kt">string</span> <span class="o">=</span> <span class="s2">&quot;labelled&quot;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%b</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span>
       <span class="o">~</span><span class="n">rex</span><span class="o">:(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="o">~</span><span class="n">flags</span><span class="o">:[`</span><span class="nc">DOTALL</span><span class="o">]</span> <span class="s2">&quot;^(?=.*bell)(?=.*lab)&quot;</span><span class="o">)</span>
       <span class="kt">string</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%b</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;bell&quot;</span> <span class="kt">string</span> <span class="o">&amp;&amp;</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;lab&quot;</span> <span class="kt">string</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span>
        <span class="o">~</span><span class="n">rex</span><span class="o">:(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="o">~</span><span class="n">flags</span><span class="o">:[`</span><span class="nc">DOTALL</span><span class="o">;</span> <span class="o">`</span><span class="nc">EXTENDED</span><span class="o">]</span> <span class="s2">&quot;</span>
<span class="s2">             ^              # start of string</span>
<span class="s2">            (?=             # zero-width lookahead</span>
<span class="s2">                .*          # any amount of intervening stuff</span>
<span class="s2">                bell        # the desired bell string</span>
<span class="s2">            )               # rewind, since we were only looking</span>
<span class="s2">            (?=             # and do the same thing</span>
<span class="s2">                .*          # any amount of intervening stuff</span>
<span class="s2">                lab         # and the lab part</span>
<span class="s2">            )&quot;</span><span class="o">)</span>
        <span class="kt">string</span><span class="o">)</span>
  <span class="k">then</span> <span class="n">print_endline</span> <span class="s2">&quot;Looks like Bell Labs might be in Murray Hill!&quot;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%b</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;(?:^.*bell.*lab)|(?:^.*lab.*bell)&quot;</span> <span class="kt">string</span><span class="o">)</span>

<span class="k">let</span> <span class="n">brand</span> <span class="o">=</span> <span class="s2">&quot;labelled&quot;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span>
        <span class="o">~</span><span class="n">rex</span><span class="o">:(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="o">~</span><span class="n">flags</span><span class="o">:[`</span><span class="nc">DOTALL</span><span class="o">;</span> <span class="o">`</span><span class="nc">EXTENDED</span><span class="o">]</span> <span class="s2">&quot;</span>
<span class="s2">        (?:                 # non-capturing grouper</span>
<span class="s2">            ^ .*?           # any amount of stuff at the front</span>
<span class="s2">              bell          # look for a bell</span>
<span class="s2">              .*?           # followed by any amount of anything</span>
<span class="s2">              lab           # look for a lab</span>
<span class="s2">          )                 # end grouper</span>
<span class="s2">    |                       # otherwise, try the other direction</span>
<span class="s2">        (?:                 # non-capturing grouper</span>
<span class="s2">            ^ .*?           # any amount of stuff at the front</span>
<span class="s2">              lab           # look for a lab</span>
<span class="s2">              .*?           # followed by any amount of anything</span>
<span class="s2">              bell          # followed by a bell</span>
<span class="s2">          )                 # end grouper</span>
<span class="s2">      &quot;</span><span class="o">)</span> <span class="n">brand</span><span class="o">)</span>
  <span class="k">then</span> <span class="n">print_endline</span> <span class="s2">&quot;Our brand has bell and lab separate.&quot;</span>

<span class="k">let</span> <span class="n">map</span> <span class="o">=</span> <span class="s2">&quot;a map of the world&quot;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%b</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span>
       <span class="o">~</span><span class="n">rex</span><span class="o">:(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="o">~</span><span class="n">flags</span><span class="o">:[`</span><span class="nc">DOTALL</span><span class="o">]</span> <span class="s2">&quot;^(?:(?!waldo).)*$&quot;</span><span class="o">)</span>
       <span class="n">map</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span>
        <span class="o">~</span><span class="n">rex</span><span class="o">:(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="o">~</span><span class="n">flags</span><span class="o">:[`</span><span class="nc">DOTALL</span><span class="o">;</span> <span class="o">`</span><span class="nc">EXTENDED</span><span class="o">]</span> <span class="s2">&quot;</span>
<span class="s2">        ^                   # start of string</span>
<span class="s2">        (?:                 # non-capturing grouper</span>
<span class="s2">            (?!             # look ahead negation</span>
<span class="s2">                waldo       # is he ahead of us now?</span>
<span class="s2">            )               # is so, the negation failed</span>
<span class="s2">            .               # any character (cuzza /s)</span>
<span class="s2">        ) *                 # repeat that grouping 0 or more</span>
<span class="s2">        $                   # through the end of the string</span>
<span class="s2">      &quot;</span><span class="o">)</span> <span class="n">map</span><span class="o">)</span>
  <span class="k">then</span> <span class="n">print_endline</span> <span class="s2">&quot;There&#39;s no waldo here!&quot;</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">%</span> <span class="n">w</span> <span class="o">|</span> <span class="n">minigrep</span> <span class="k">&#39;</span><span class="o">^(?!.*</span><span class="n">ttyp</span><span class="o">).*</span><span class="n">tchrist&#39;</span>

<span class="c">(*-----------------------------*)</span>

<span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="o">~</span><span class="n">flags</span><span class="o">:[`</span><span class="nc">EXTENDED</span><span class="o">]</span> <span class="s2">&quot;</span>
<span class="s2">    ^                       # anchored to the start</span>
<span class="s2">    (?!                     # zero-width look-ahead assertion</span>
<span class="s2">        .*                  # any amount of anything (faster than .*?)</span>
<span class="s2">        ttyp                # the string you don&#39;t want to find</span>
<span class="s2">    )                       # end look-ahead negation; rewind to start</span>
<span class="s2">    .*                      # any amount of anything (faster than .*?)</span>
<span class="s2">    tchrist                 # now try to find Tom</span>
<span class="s2">&quot;</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">%</span> <span class="n">w</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">tchrist</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">-</span><span class="n">v</span> <span class="n">ttyp</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">%</span> <span class="n">grep</span> <span class="o">-</span><span class="n">i</span> <span class="k">&#39;</span><span class="n">pattern&#39;</span> <span class="n">files</span>
<span class="o">%</span> <span class="n">minigrep</span> <span class="k">&#39;</span><span class="o">(?</span><span class="n">i</span><span class="o">)</span><span class="n">pattern&#39;</span> <span class="n">files</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN339"
>Matching Multiple-Byte Characters</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="c">(* Regexp text for an EUC-JP character *)</span>
<span class="k">let</span> <span class="n">eucjp</span> <span class="o">=</span>
  <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">|&quot;</span>
     <span class="c">(* EUC-JP encoding subcomponents: *)</span>
     <span class="o">[</span>
       <span class="c">(* ASCII/JIS-Roman (one-byte/character) *)</span>
       <span class="s2">&quot;[</span><span class="se">\x00</span><span class="s2">-</span><span class="se">\x7F</span><span class="s2">]&quot;</span><span class="o">;</span>

       <span class="c">(* half-width katakana (two bytes/char) *)</span>
       <span class="s2">&quot;</span><span class="se">\x8E</span><span class="s2">[</span><span class="se">\xA0</span><span class="s2">-</span><span class="se">\xDF</span><span class="s2">]&quot;</span><span class="o">;</span>

       <span class="c">(* JIS X 0212-1990 (three bytes/char) *)</span>
       <span class="s2">&quot;</span><span class="se">\x8F</span><span class="s2">[</span><span class="se">\xA1</span><span class="s2">-</span><span class="se">\xFE</span><span class="s2">][</span><span class="se">\xA1</span><span class="s2">-</span><span class="se">\xFE</span><span class="s2">]&quot;</span><span class="o">;</span>

       <span class="c">(* JIS X 0208:1997 (two bytes/char) *)</span>
       <span class="s2">&quot;[</span><span class="se">\xA1</span><span class="s2">-</span><span class="se">\xFE</span><span class="s2">][</span><span class="se">\xA1</span><span class="s2">-</span><span class="se">\xFE</span><span class="s2">]&quot;</span><span class="o">;</span>
     <span class="o">])</span>

<span class="c">(* Match any number of EUC-JP characters preceding Tokyo *)</span>
<span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="o">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">(</span><span class="se">\\</span><span class="s2">(&quot;</span> <span class="o">^</span> <span class="n">eucjp</span> <span class="o">^</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">)*</span><span class="se">\\</span><span class="s2">)</span><span class="se">\\</span><span class="s2">(</span><span class="se">\xC5\xEC\xB5\xFE\\</span><span class="s2">)&quot;</span><span class="o">)</span>

<span class="c">(* Search from the beginning for a match *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">regexp</span> <span class="kt">string</span> <span class="mi">0</span>
  <span class="k">then</span> <span class="n">print_endline</span> <span class="s2">&quot;Found Tokyo&quot;</span>

<span class="c">(* Replace Tokyo with Osaka *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">create</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="kt">string</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">start</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="k">while</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">regexp</span> <span class="kt">string</span> <span class="o">!</span><span class="n">start</span> <span class="k">do</span>
    <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_string</span> <span class="n">buffer</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">1</span> <span class="kt">string</span><span class="o">);</span>
    <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_string</span> <span class="n">buffer</span> <span class="n">osaka</span><span class="o">;</span> <span class="c">(* Assuming osaka is defined *)</span>
    <span class="n">start</span> <span class="o">:=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">match_end</span> <span class="bp">()</span><span class="o">;</span>
  <span class="k">done</span><span class="o">;</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">start</span> <span class="o">&lt;</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="kt">string</span>
  <span class="k">then</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_substring</span> <span class="n">buffer</span> <span class="kt">string</span>
    <span class="o">!</span><span class="n">start</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="kt">string</span> <span class="o">-</span> <span class="o">!</span><span class="n">start</span><span class="o">);</span>
  <span class="n">print_endline</span> <span class="o">(</span><span class="nn">Buffer</span><span class="p">.</span><span class="n">contents</span> <span class="n">buffer</span><span class="o">)</span>

<span class="c">(* Split a multi-byte string into characters *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* One character per list element *)</span>
  <span class="k">let</span> <span class="n">chars</span> <span class="o">=</span>
    <span class="nn">Array</span><span class="p">.</span><span class="n">map</span>
      <span class="o">(</span><span class="k">function</span>
         <span class="o">|</span> <span class="nn">Str</span><span class="p">.</span><span class="nc">Delim</span> <span class="n">c</span> <span class="o">-&gt;</span> <span class="n">c</span>
         <span class="o">|</span> <span class="nn">Str</span><span class="p">.</span><span class="nc">Text</span> <span class="n">c</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="o">(</span><span class="s2">&quot;invalid char: &quot;</span> <span class="o">^</span> <span class="n">c</span><span class="o">))</span>
      <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">of_list</span>
         <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">full_split</span>
            <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="n">eucjp</span><span class="o">)</span>
            <span class="kt">string</span><span class="o">))</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">length</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">chars</span> <span class="k">in</span>
  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">to</span> <span class="n">length</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">do</span>
    <span class="k">if</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">chars</span><span class="o">.(</span><span class="n">i</span><span class="o">)</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">then</span>
      <span class="k">begin</span>
        <span class="c">(* Do something interesting with this one-byte character *)</span>
      <span class="k">end</span>
    <span class="k">else</span>
      <span class="k">begin</span>
        <span class="c">(* Do something interesting with this multi-byte character *)</span>
      <span class="k">end</span>
  <span class="k">done</span><span class="o">;</span>
  <span class="c">(* Glue list back together *)</span>
  <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="n">chars</span><span class="o">)</span> <span class="k">in</span>
  <span class="n">print_endline</span> <span class="n">line</span>

<span class="c">(* Determine if an entire string is valid EUC-JP *)</span>
<span class="k">let</span> <span class="n">is_eucjp</span> <span class="n">s</span> <span class="o">=</span>
  <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span>
    <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="o">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">(&quot;</span> <span class="o">^</span> <span class="n">eucjp</span> <span class="o">^</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">)*$&quot;</span><span class="o">))</span> <span class="n">s</span> <span class="mi">0</span>

<span class="c">(* Assuming a similar string has been defined for Shift-JIS *)</span>
<span class="k">let</span> <span class="n">is_sjis</span> <span class="n">s</span> <span class="o">=</span>
  <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span>
    <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="o">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">(&quot;</span> <span class="o">^</span> <span class="n">sjis</span> <span class="o">^</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">)*$&quot;</span><span class="o">))</span> <span class="n">s</span> <span class="mi">0</span>

<span class="c">(* Convert from EUC-JP to Unicode, assuming a Hashtbl named</span>
<span class="c">   euc2uni is defined with the appropriate character mappings *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">chars</span> <span class="o">=</span>
    <span class="nn">Array</span><span class="p">.</span><span class="n">map</span>
      <span class="o">(</span><span class="k">function</span>
         <span class="o">|</span> <span class="nn">Str</span><span class="p">.</span><span class="nc">Delim</span> <span class="n">c</span> <span class="o">-&gt;</span> <span class="n">c</span>
         <span class="o">|</span> <span class="nn">Str</span><span class="p">.</span><span class="nc">Text</span> <span class="n">c</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="o">(</span><span class="s2">&quot;invalid char: &quot;</span> <span class="o">^</span> <span class="n">c</span><span class="o">))</span>
      <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">of_list</span>
         <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">full_split</span>
            <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="n">eucjp</span><span class="o">)</span>
            <span class="kt">string</span><span class="o">))</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">length</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">chars</span> <span class="k">in</span>
  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">to</span> <span class="n">length</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">do</span>
    <span class="k">if</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">mem</span> <span class="n">euc2uni</span> <span class="n">chars</span><span class="o">.(</span><span class="n">i</span><span class="o">)</span>
    <span class="k">then</span>
      <span class="k">begin</span>
        <span class="n">chars</span><span class="o">.(</span><span class="n">i</span><span class="o">)</span> <span class="o">&lt;-</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">euc2uni</span> <span class="n">chars</span><span class="o">.(</span><span class="n">i</span><span class="o">))</span>
      <span class="k">end</span>
    <span class="k">else</span>
      <span class="k">begin</span>
        <span class="c">(* deal with unknown EUC-&gt;Unicode mapping here *)</span>
      <span class="k">end</span>
  <span class="k">done</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="n">chars</span><span class="o">)</span> <span class="k">in</span>
  <span class="n">print_endline</span> <span class="n">line</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN342"
>Matching a Valid Mail Address</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="c">(* Not foolproof, but works in most common cases. *)</span>
<span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span>
  <span class="nn">Str</span><span class="p">.</span><span class="n">regexp_case_fold</span>
    <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">b[A-Z0-9._%+-]+@[A-Z0-9.-]+</span><span class="se">\\</span><span class="s2">.[A-Z][A-Z][A-Z]?[A-Z]?</span><span class="se">\\</span><span class="s2">b&quot;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="n">print_string</span> <span class="s2">&quot;Email: &quot;</span><span class="o">;</span>
      <span class="n">flush</span> <span class="n">stdout</span><span class="o">;</span>
      <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">stdin</span> <span class="k">in</span>
      <span class="k">try</span>
        <span class="k">let</span> <span class="n">start</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
        <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
          <span class="n">start</span> <span class="o">:=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span> <span class="n">regexp</span> <span class="n">line</span> <span class="o">!</span><span class="n">start</span><span class="o">;</span>
          <span class="k">let</span> <span class="kt">string</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">matched_string</span> <span class="n">line</span> <span class="k">in</span>
          <span class="n">start</span> <span class="o">:=</span> <span class="o">!</span><span class="n">start</span> <span class="o">+</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="kt">string</span><span class="o">;</span>
          <span class="n">print_string</span> <span class="s2">&quot;Found: &quot;</span><span class="o">;</span>
          <span class="n">print_endline</span> <span class="kt">string</span><span class="o">;</span>
        <span class="k">done</span>
      <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">()</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN345"
>Matching Abbreviations</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="n">print_string</span> <span class="s2">&quot;Action: &quot;</span><span class="o">;</span>
      <span class="n">flush</span> <span class="n">stdout</span><span class="o">;</span>
      <span class="k">let</span> <span class="n">answer</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">stdin</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp_string_case_fold</span> <span class="n">answer</span> <span class="k">in</span>
      <span class="k">if</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">regexp</span> <span class="s2">&quot;SEND&quot;</span> <span class="mi">0</span>
      <span class="k">then</span> <span class="n">print_endline</span> <span class="s2">&quot;Action is send&quot;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">regexp</span> <span class="s2">&quot;STOP&quot;</span> <span class="mi">0</span>
      <span class="k">then</span> <span class="n">print_endline</span> <span class="s2">&quot;Action is stop&quot;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">regexp</span> <span class="s2">&quot;ABORT&quot;</span> <span class="mi">0</span>
      <span class="k">then</span> <span class="n">print_endline</span> <span class="s2">&quot;Action is abort&quot;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">regexp</span> <span class="s2">&quot;LIST&quot;</span> <span class="mi">0</span>
      <span class="k">then</span> <span class="n">print_endline</span> <span class="s2">&quot;Action is list&quot;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">regexp</span> <span class="s2">&quot;EDIT&quot;</span> <span class="mi">0</span>
      <span class="k">then</span> <span class="n">print_endline</span> <span class="s2">&quot;Action is edit&quot;</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* assumes that invoke_editor, deliver_message, *)</span>
<span class="c">(* file and pager are defined somewhere else. *)</span>
<span class="k">let</span> <span class="n">actions</span> <span class="o">=</span>
  <span class="o">[</span>
    <span class="s2">&quot;edit&quot;</span><span class="o">,</span> <span class="n">invoke_editor</span><span class="o">;</span>
    <span class="s2">&quot;send&quot;</span><span class="o">,</span> <span class="n">deliver_message</span><span class="o">;</span>
    <span class="s2">&quot;list&quot;</span><span class="o">,</span> <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="n">ignore</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="n">command</span> <span class="o">(</span><span class="n">pager</span> <span class="o">^</span> <span class="s2">&quot; &quot;</span> <span class="o">^</span> <span class="n">file</span><span class="o">)));</span>
    <span class="s2">&quot;abort&quot;</span><span class="o">,</span> <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="n">print_endline</span> <span class="s2">&quot;See ya!&quot;</span><span class="o">;</span> <span class="n">exit</span> <span class="mi">0</span><span class="o">);</span>
  <span class="o">]</span>

<span class="k">let</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="n">print_string</span> <span class="s2">&quot;Action: &quot;</span><span class="o">;</span>
      <span class="n">flush</span> <span class="n">stdout</span><span class="o">;</span>
      <span class="k">let</span> <span class="n">answer</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">stdin</span> <span class="k">in</span>
      <span class="c">(* trim leading white space *)</span>
      <span class="k">let</span> <span class="n">answer</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;^[ </span><span class="se">\t</span><span class="s2">]+&quot;</span><span class="o">)</span> <span class="s2">&quot;&quot;</span> <span class="n">answer</span> <span class="k">in</span>
      <span class="c">(* trim trailing white space *)</span>
      <span class="k">let</span> <span class="n">answer</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[ </span><span class="se">\t</span><span class="s2">]+$&quot;</span><span class="o">)</span> <span class="s2">&quot;&quot;</span> <span class="n">answer</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp_string_case_fold</span> <span class="n">answer</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">found</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span> <span class="k">in</span>
      <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
        <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">action</span><span class="o">,</span> <span class="n">handler</span><span class="o">)</span> <span class="o">-&gt;</span>
           <span class="k">if</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">regexp</span> <span class="n">action</span> <span class="mi">0</span>
           <span class="k">then</span> <span class="o">(</span><span class="n">found</span> <span class="o">:=</span> <span class="bp">true</span><span class="o">;</span> <span class="n">handler</span> <span class="bp">()</span><span class="o">))</span>
        <span class="n">actions</span><span class="o">;</span>
      <span class="k">if</span> <span class="n">not</span> <span class="o">!</span><span class="n">found</span>
      <span class="k">then</span> <span class="o">(</span><span class="n">incr</span> <span class="n">errors</span><span class="o">;</span> <span class="n">print_endline</span> <span class="o">(</span><span class="s2">&quot;Unknown command: &quot;</span> <span class="o">^</span> <span class="n">answer</span><span class="o">))</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN348"
>Program: urlify</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* urlify - wrap HTML links around URL-like constructs *)</span>
<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+pcre&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;pcre.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">urls</span> <span class="o">=</span> <span class="s2">&quot;(http|telnet|gopher|file|wais|ftp)&quot;</span>
<span class="k">let</span> <span class="n">ltrs</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">w&quot;</span>
<span class="k">let</span> <span class="n">gunk</span> <span class="o">=</span> <span class="s2">&quot;/#~:.?+=&amp;%@!</span><span class="se">\\</span><span class="s2">-&quot;</span>
<span class="k">let</span> <span class="n">punc</span> <span class="o">=</span> <span class="s2">&quot;.:?</span><span class="se">\\</span><span class="s2">-&quot;</span>
<span class="k">let</span> <span class="n">any</span>  <span class="o">=</span> <span class="n">ltrs</span> <span class="o">^</span> <span class="n">gunk</span> <span class="o">^</span> <span class="n">punc</span>

<span class="k">let</span> <span class="n">rex</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="o">~</span><span class="n">flags</span><span class="o">:[`</span><span class="nc">CASELESS</span><span class="o">;</span> <span class="o">`</span><span class="nc">EXTENDED</span><span class="o">]</span>
  <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;</span>
<span class="s2">      </span><span class="se">\\</span><span class="s2">b                   # start at word boundary</span>
<span class="s2">      (                     # begin $1  {</span>
<span class="s2">       %s        :          # need resource and a colon</span>
<span class="s2">       [%s] +?              # followed by one or more</span>
<span class="s2">                            #  of any valid character, but</span>
<span class="s2">                            #  be conservative and take only</span>
<span class="s2">                            #  what you need to....</span>
<span class="s2">      )                     # end   $1  }</span>
<span class="s2">      (?=                   # look-ahead non-consumptive assertion</span>
<span class="s2">       [%s]*                # either 0 or more punctuation</span>
<span class="s2">       [^%s]                #   followed by a non-url char</span>
<span class="s2">       |                    # or else</span>
<span class="s2">       $                    #   then end of the string</span>
<span class="s2">      )</span>
<span class="s2">&quot;</span> <span class="n">urls</span> <span class="n">any</span> <span class="n">punc</span> <span class="n">any</span><span class="o">)</span>

<span class="k">let</span> <span class="n">templ</span> <span class="o">=</span> <span class="s2">&quot;&lt;A HREF=</span><span class="se">\&quot;</span><span class="s2">$1</span><span class="se">\&quot;</span><span class="s2">&gt;$1&lt;/A&gt;&quot;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">stdin</span> <span class="k">in</span>
      <span class="n">print_endline</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">replace</span> <span class="o">~</span><span class="n">rex</span> <span class="o">~</span><span class="n">templ</span> <span class="n">line</span><span class="o">)</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
    <span class="bp">()</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN351"
>Program: tcgrep</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">%</span> <span class="n">tcgrep</span> <span class="o">-</span><span class="n">ril</span> <span class="k">&#39;</span><span class="o">^</span><span class="nc">From</span><span class="o">:</span> <span class="o">.*</span><span class="n">kate&#39;</span> <span class="o">~/</span><span class="n">mail</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* tcgrep: rewrite of tom christiansen&#39;s rewrite of grep *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="c">(* http://ocaml.info/home/ocaml_sources.html#pcre-ocaml *)</span>
<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+pcre&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;pcre.cma&quot;</span><span class="o">;;</span>

<span class="c">(* http://alain.frisch.fr/soft.html#Getopt *)</span>
<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+getopt&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;getopt.cma&quot;</span><span class="o">;;</span>

<span class="c">(* Initialize globals. *)</span>
<span class="k">let</span> <span class="n">me</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">replace</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;.*/&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span>
<span class="k">let</span> <span class="n">matches</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>
<span class="k">let</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>
<span class="k">let</span> <span class="n">grand_total</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>
<span class="k">let</span> <span class="n">mult</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span>
<span class="k">let</span> <span class="n">compress</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;.z&quot;</span><span class="o">,</span> <span class="s2">&quot;zcat&quot;</span><span class="o">;</span> <span class="s2">&quot;.gz&quot;</span><span class="o">,</span> <span class="s2">&quot;zcat&quot;</span><span class="o">;</span> <span class="s2">&quot;.Z&quot;</span><span class="o">,</span> <span class="s2">&quot;zcat&quot;</span><span class="o">]</span>

<span class="c">(* Prints usage and exits. *)</span>
<span class="k">let</span> <span class="n">usage</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;usage: %s [flags] [files]</span>

<span class="s2">Standard grep options:</span>
<span class="s2">        i   case insensitive</span>
<span class="s2">        n   number lines</span>
<span class="s2">        c   give count of lines matching</span>
<span class="s2">        C   ditto, but &gt;1 match per line possible</span>
<span class="s2">        w   word boundaries only</span>
<span class="s2">        s   silent mode</span>
<span class="s2">        x   exact matches only</span>
<span class="s2">        v   invert search sense (lines that DON&#39;T match)</span>
<span class="s2">        h   hide filenames</span>
<span class="s2">        e   expression (for exprs beginning with -)</span>
<span class="s2">        f   file with expressions</span>
<span class="s2">        l   list filenames matching</span>

<span class="s2">Specials:</span>
<span class="s2">        1   1 match per file</span>
<span class="s2">        H   highlight matches</span>
<span class="s2">        u   underline matches</span>
<span class="s2">        r   recursive on directories or dot if none</span>
<span class="s2">        t   process directories in &#39;ls -t&#39; order</span>
<span class="s2">        p   paragraph mode (default: line mode)</span>
<span class="s2">        P   ditto, but specify separator, e.g. -P &#39;%%&#39;</span>
<span class="s2">        a   all files, not just plain text files (not implemented)</span>
<span class="s2">        q   quiet about failed file and dir opens</span>
<span class="s2">        T   trace files as opened</span>

<span class="s2">May use a TCGREP environment variable to set default options.</span>
<span class="s2">&quot;</span> <span class="n">me</span><span class="o">;</span>
  <span class="n">exit</span> <span class="mi">255</span>

<span class="c">(* Produces a stream of lines from an input channel. *)</span>
<span class="k">let</span> <span class="n">line_stream_of_channel</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">channel</span><span class="o">)</span> <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="nc">None</span><span class="o">)</span>

<span class="c">(* Produces a stream of chunks from an input channel given a delimiter. *)</span>
<span class="k">let</span> <span class="n">delimited_stream_of_channel</span> <span class="n">delim</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">line_stream_of_channel</span> <span class="n">channel</span> <span class="k">in</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">next</span> <span class="n">para_lines</span> <span class="n">i</span> <span class="o">=</span>
    <span class="k">match</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">peek</span> <span class="n">lines</span><span class="o">,</span> <span class="n">para_lines</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">None</span><span class="o">,</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="nc">None</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">delim&#39;</span><span class="o">,</span> <span class="bp">[]</span> <span class="k">when</span> <span class="n">delim&#39;</span> <span class="o">=</span> <span class="n">delim</span> <span class="o">-&gt;</span>
          <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">lines</span><span class="o">;</span> <span class="n">next</span> <span class="n">para_lines</span> <span class="n">i</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">delim&#39;</span><span class="o">,</span> <span class="o">_</span> <span class="k">when</span> <span class="n">delim&#39;</span> <span class="o">=</span> <span class="n">delim</span> <span class="o">-&gt;</span>
          <span class="nc">Some</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="n">para_lines</span><span class="o">))</span>
      <span class="o">|</span> <span class="nc">None</span><span class="o">,</span> <span class="o">_</span> <span class="o">-&gt;</span>
          <span class="nc">Some</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="n">para_lines</span><span class="o">))</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">line</span><span class="o">,</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">lines</span><span class="o">;</span> <span class="n">next</span> <span class="o">(</span><span class="n">line</span> <span class="o">::</span> <span class="n">para_lines</span><span class="o">)</span> <span class="n">i</span> <span class="k">in</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span> <span class="o">(</span><span class="n">next</span> <span class="bp">[]</span><span class="o">)</span>

<span class="c">(* An empty delimiter corresponds to an empty line, so we can create</span>
<span class="c">   a paragraph stream in terms of the previous function. *)</span>
<span class="k">let</span> <span class="n">paragraph_stream_of_channel</span> <span class="o">=</span> <span class="n">delimited_stream_of_channel</span> <span class="s2">&quot;&quot;</span>

<span class="c">(* By default, the stream builder will produce lines. This can be changed</span>
<span class="c">   by the -p and -P options. *)</span>
<span class="k">let</span> <span class="n">stream_of_channel</span> <span class="o">=</span> <span class="n">ref</span> <span class="n">line_stream_of_channel</span>

<span class="c">(* Type for command-line options and their values. *)</span>
<span class="k">type</span> <span class="n">opt</span> <span class="o">=</span> <span class="nc">OBool</span> <span class="k">of</span> <span class="kt">bool</span> <span class="o">|</span> <span class="nc">OStr</span> <span class="k">of</span> <span class="kt">string</span>

<span class="c">(* Set an option. *)</span>
<span class="k">let</span> <span class="n">opt_set</span> <span class="n">opt</span> <span class="n">c</span> <span class="o">=</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">opt</span> <span class="n">c</span> <span class="o">(</span><span class="nc">OBool</span> <span class="bp">true</span><span class="o">)</span>

<span class="c">(* Test an option. *)</span>
<span class="k">let</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="n">c</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">match</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">opt</span> <span class="n">c</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">OBool</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">b</span>
      <span class="o">|</span> <span class="nc">OStr</span> <span class="s2">&quot;&quot;</span> <span class="o">-&gt;</span> <span class="bp">false</span>
      <span class="o">|</span> <span class="nc">OStr</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">true</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
    <span class="bp">false</span>

<span class="c">(* Convert an option to a string. *)</span>
<span class="k">let</span> <span class="n">opt_str</span> <span class="n">opt</span> <span class="n">c</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">match</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">opt</span> <span class="n">c</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">OBool</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">string_of_bool</span> <span class="n">b</span>
      <span class="o">|</span> <span class="nc">OStr</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
    <span class="s2">&quot;&quot;</span>

<span class="c">(* Gets terminal escape characters. *)</span>
<span class="k">let</span> <span class="n">tput</span> <span class="n">cap</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">ch</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_in</span> <span class="o">(</span><span class="s2">&quot;tput &quot;</span> <span class="o">^</span> <span class="n">cap</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">try</span>
    <span class="k">let</span> <span class="n">result</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">ch</span> <span class="k">in</span>
    <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_in</span> <span class="n">ch</span><span class="o">);</span>
    <span class="n">result</span>
  <span class="k">with</span>
    <span class="o">|</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
        <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_in</span> <span class="n">ch</span><span class="o">);</span>
        <span class="s2">&quot;&quot;</span>
    <span class="o">|</span> <span class="n">e</span> <span class="o">-&gt;</span>
        <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_in</span> <span class="n">ch</span><span class="o">);</span>
        <span class="k">raise</span> <span class="n">e</span>

<span class="c">(* Splits a filename into its base and extension. *)</span>
<span class="k">let</span> <span class="n">splitext</span> <span class="n">name</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">let</span> <span class="n">base</span> <span class="o">=</span> <span class="nn">Filename</span><span class="p">.</span><span class="n">chop_extension</span> <span class="n">name</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">i</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">base</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">ext</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">name</span> <span class="n">i</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">name</span> <span class="o">-</span> <span class="n">i</span><span class="o">)</span> <span class="k">in</span>
    <span class="n">base</span><span class="o">,</span> <span class="n">ext</span>
  <span class="k">with</span> <span class="nc">Invalid_argument</span> <span class="o">_</span> <span class="o">-&gt;</span>
    <span class="n">name</span><span class="o">,</span> <span class="s2">&quot;&quot;</span>

<span class="c">(* Parses command-line arguments. *)</span>
<span class="k">let</span> <span class="n">parse_args</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">opt</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">args</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>

  <span class="k">let</span> <span class="n">optstring</span> <span class="o">=</span> <span class="s2">&quot;incCwsxvhe:f:l1HurtpP:aqT&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">optstream</span> <span class="o">=</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">of_string</span> <span class="n">optstring</span> <span class="k">in</span>

  <span class="c">(* Prepare options for Getopt. *)</span>
  <span class="k">let</span> <span class="n">opts</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">str_setter</span> <span class="n">c</span> <span class="o">=</span>
      <span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="nn">Getopt</span><span class="p">.</span><span class="n">nolong</span><span class="o">,</span>
       <span class="nc">None</span><span class="o">,</span>
       <span class="nc">Some</span> <span class="o">(</span><span class="k">fun</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">opt</span> <span class="n">c</span> <span class="o">(</span><span class="nc">OStr</span> <span class="n">s</span><span class="o">)))</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">int_setter</span> <span class="n">c</span> <span class="o">=</span>
      <span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="nn">Getopt</span><span class="p">.</span><span class="n">nolong</span><span class="o">,</span>
       <span class="nc">Some</span> <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">opt</span> <span class="n">c</span> <span class="o">(</span><span class="nc">OBool</span> <span class="bp">true</span><span class="o">)),</span>
       <span class="nc">None</span><span class="o">)</span> <span class="k">in</span>
    <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span> <span class="n">acc</span> <span class="o">=</span>
      <span class="k">match</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">peek</span> <span class="n">optstream</span> <span class="k">with</span>
        <span class="o">|</span> <span class="nc">Some</span> <span class="n">c</span> <span class="o">-&gt;</span>
            <span class="o">(</span><span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">optstream</span><span class="o">;</span>
             <span class="k">match</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">peek</span> <span class="n">optstream</span> <span class="k">with</span>
               <span class="o">|</span> <span class="nc">Some</span> <span class="sc">&#39;:&#39;</span> <span class="o">-&gt;</span>
                   <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">optstream</span><span class="o">;</span>
                   <span class="n">loop</span> <span class="o">(</span><span class="n">str_setter</span> <span class="n">c</span> <span class="o">::</span> <span class="n">acc</span><span class="o">)</span>
               <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span>
                   <span class="n">loop</span> <span class="o">(</span><span class="n">int_setter</span> <span class="n">c</span> <span class="o">::</span> <span class="n">acc</span><span class="o">))</span>
        <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="n">acc</span> <span class="k">in</span>
    <span class="n">loop</span> <span class="bp">[]</span> <span class="k">in</span>

  <span class="c">(* Handle TCGREP environment variable. *)</span>
  <span class="k">let</span> <span class="n">cmdline</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">))</span> <span class="k">in</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">env</span> <span class="o">-&gt;</span>
       <span class="k">if</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">env</span> <span class="o">&gt;</span> <span class="mi">7</span>
           <span class="o">&amp;&amp;</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">env</span> <span class="mi">0</span> <span class="mi">7</span> <span class="o">=</span> <span class="s2">&quot;TCGREP=&quot;</span><span class="o">)</span>
       <span class="k">then</span>
         <span class="k">begin</span>
           <span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">env</span> <span class="mi">7</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">env</span> <span class="o">-</span> <span class="mi">7</span><span class="o">)</span> <span class="k">in</span>
           <span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="k">if</span> <span class="n">s</span><span class="o">.[</span><span class="mi">0</span><span class="o">]</span> <span class="o">&lt;&gt;</span> <span class="sc">&#39;-&#39;</span> <span class="k">then</span> <span class="s2">&quot;-&quot;</span> <span class="o">^</span> <span class="n">s</span> <span class="k">else</span> <span class="n">s</span> <span class="k">in</span>
           <span class="n">cmdline</span> <span class="o">:=</span> <span class="n">s</span> <span class="o">::</span> <span class="o">!</span><span class="n">cmdline</span>
         <span class="k">end</span><span class="o">)</span>
    <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">environment</span> <span class="bp">()</span><span class="o">);</span>
  <span class="k">let</span> <span class="n">cmdline</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">of_list</span> <span class="o">!</span><span class="n">cmdline</span> <span class="k">in</span>

  <span class="c">(* Parse command-line options using Getopt. *)</span>
  <span class="k">begin</span>
    <span class="k">try</span>
      <span class="nn">Getopt</span><span class="p">.</span><span class="n">parse</span>
        <span class="n">opts</span> <span class="o">(</span><span class="k">fun</span> <span class="n">arg</span> <span class="o">-&gt;</span> <span class="n">args</span> <span class="o">:=</span> <span class="n">arg</span> <span class="o">::</span> <span class="o">!</span><span class="n">args</span><span class="o">)</span>
        <span class="n">cmdline</span> <span class="mi">0</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">cmdline</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
      <span class="n">args</span> <span class="o">:=</span> <span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="o">!</span><span class="n">args</span>
    <span class="k">with</span> <span class="nn">Getopt</span><span class="p">.</span><span class="nc">Error</span> <span class="n">e</span> <span class="o">-&gt;</span>
      <span class="n">prerr_endline</span> <span class="n">e</span><span class="o">;</span>
      <span class="n">usage</span> <span class="bp">()</span>
  <span class="k">end</span><span class="o">;</span>

  <span class="c">(* Read patterns from file or command line. *)</span>
  <span class="k">let</span> <span class="n">patterns</span> <span class="o">=</span>
    <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;f&#39;</span>
    <span class="k">then</span>
      <span class="k">begin</span>
        <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span>
          <span class="k">try</span> <span class="n">open_in</span> <span class="o">(</span><span class="n">opt_str</span> <span class="n">opt</span> <span class="sc">&#39;f&#39;</span><span class="o">)</span>
          <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span>
            <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s: can&#39;t open %s: %s</span><span class="se">\n</span><span class="s2">&quot;</span>
              <span class="n">me</span> <span class="o">(</span><span class="n">opt_str</span> <span class="n">opt</span> <span class="sc">&#39;f&#39;</span><span class="o">)</span> <span class="o">(</span><span class="nn">Printexc</span><span class="p">.</span><span class="n">to_string</span> <span class="n">e</span><span class="o">);</span>
            <span class="n">exit</span> <span class="mi">255</span> <span class="k">in</span>
        <span class="k">try</span>
          <span class="k">let</span> <span class="n">acc</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
          <span class="nn">Stream</span><span class="p">.</span><span class="n">iter</span>
            <span class="o">(</span><span class="k">fun</span> <span class="n">pat</span> <span class="o">-&gt;</span> <span class="n">acc</span> <span class="o">:=</span> <span class="n">pat</span> <span class="o">::</span> <span class="o">!</span><span class="n">acc</span><span class="o">)</span>
            <span class="o">(</span><span class="n">line_stream_of_channel</span> <span class="n">in_channel</span><span class="o">);</span>
          <span class="n">close_in</span> <span class="n">in_channel</span><span class="o">;</span>
          <span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="o">!</span><span class="n">acc</span>
        <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span>
          <span class="n">close_in</span> <span class="n">in_channel</span><span class="o">;</span>
          <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s: error reading %s: %s</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">me</span> <span class="o">(</span><span class="n">opt_str</span> <span class="n">opt</span> <span class="sc">&#39;f&#39;</span><span class="o">)</span> <span class="o">(</span><span class="nn">Printexc</span><span class="p">.</span><span class="n">to_string</span> <span class="n">e</span><span class="o">);</span>
          <span class="n">exit</span> <span class="mi">255</span>
      <span class="k">end</span>
    <span class="k">else</span> <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;e&#39;</span>
    <span class="k">then</span> <span class="o">[</span><span class="n">opt_str</span> <span class="n">opt</span> <span class="sc">&#39;e&#39;</span><span class="o">]</span>
    <span class="k">else</span> <span class="o">[</span><span class="k">match</span> <span class="o">!</span><span class="n">args</span> <span class="k">with</span> <span class="n">h</span> <span class="o">::</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">args</span> <span class="o">:=</span> <span class="n">t</span><span class="o">;</span> <span class="n">h</span><span class="o">)</span> <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="n">usage</span> <span class="bp">()</span><span class="o">]</span> <span class="k">in</span>

  <span class="c">(* Terminal escape characters for highlighting options. *)</span>
  <span class="k">let</span> <span class="n">highlight</span> <span class="o">=</span>
    <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;H&#39;</span>
    <span class="k">then</span> <span class="n">tput</span> <span class="s2">&quot;smso&quot;</span> <span class="o">^</span> <span class="s2">&quot;$1&quot;</span> <span class="o">^</span> <span class="n">tput</span> <span class="s2">&quot;rmso&quot;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;u&#39;</span>
    <span class="k">then</span> <span class="n">tput</span> <span class="s2">&quot;smul&quot;</span> <span class="o">^</span> <span class="s2">&quot;$1&quot;</span> <span class="o">^</span> <span class="n">tput</span> <span class="s2">&quot;rmul&quot;</span>
    <span class="k">else</span> <span class="s2">&quot;$1&quot;</span> <span class="k">in</span>

  <span class="c">(* Regular expression flags to use. *)</span>
  <span class="k">let</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;i&#39;</span> <span class="k">then</span> <span class="n">flags</span> <span class="o">:=</span> <span class="o">`</span><span class="nc">CASELESS</span> <span class="o">::</span> <span class="o">!</span><span class="n">flags</span><span class="o">;</span>

  <span class="c">(* Options for paragraph modes. *)</span>
  <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;p&#39;</span>
  <span class="k">then</span> <span class="n">stream_of_channel</span> <span class="o">:=</span> <span class="n">paragraph_stream_of_channel</span><span class="o">;</span>
  <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;P&#39;</span>
  <span class="k">then</span> <span class="n">stream_of_channel</span> <span class="o">:=</span> <span class="n">delimited_stream_of_channel</span> <span class="o">(</span><span class="n">opt_str</span> <span class="n">opt</span> <span class="sc">&#39;P&#39;</span><span class="o">);</span>

  <span class="c">(* Word boundary option. *)</span>
  <span class="k">let</span> <span class="n">patterns</span> <span class="o">=</span>
    <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;w&#39;</span>
    <span class="k">then</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">pat</span> <span class="o">-&gt;</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">b&quot;</span> <span class="o">^</span> <span class="n">pat</span> <span class="o">^</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">b&quot;</span><span class="o">)</span> <span class="n">patterns</span>
    <span class="k">else</span> <span class="n">patterns</span> <span class="k">in</span>

  <span class="c">(* Exact match option. *)</span>
  <span class="k">let</span> <span class="n">patterns</span> <span class="o">=</span>
    <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;x&#39;</span>
    <span class="k">then</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">pat</span> <span class="o">-&gt;</span> <span class="s2">&quot;^&quot;</span> <span class="o">^</span> <span class="n">pat</span> <span class="o">^</span> <span class="s2">&quot;$&quot;</span><span class="o">)</span> <span class="n">patterns</span>
    <span class="k">else</span> <span class="n">patterns</span> <span class="k">in</span>

  <span class="c">(* Options that imply other options. *)</span>
  <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;l&#39;</span> <span class="k">then</span> <span class="n">opt_set</span> <span class="n">opt</span> <span class="sc">&#39;1&#39;</span><span class="o">;</span>
  <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;u&#39;</span> <span class="k">then</span> <span class="n">opt_set</span> <span class="n">opt</span> <span class="sc">&#39;H&#39;</span><span class="o">;</span>
  <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;C&#39;</span> <span class="k">then</span> <span class="n">opt_set</span> <span class="n">opt</span> <span class="sc">&#39;c&#39;</span><span class="o">;</span>
  <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;c&#39;</span> <span class="k">then</span> <span class="n">opt_set</span> <span class="n">opt</span> <span class="sc">&#39;s&#39;</span><span class="o">;</span>
  <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;s&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">not</span> <span class="o">(</span><span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;c&#39;</span><span class="o">)</span> <span class="k">then</span> <span class="n">opt_set</span> <span class="n">opt</span> <span class="sc">&#39;1&#39;</span><span class="o">;</span>

  <span class="c">(* Compile the regular expression patterns. *)</span>
  <span class="k">let</span> <span class="n">rexes</span> <span class="o">=</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">map</span>
      <span class="o">(</span><span class="k">fun</span> <span class="n">pat</span> <span class="o">-&gt;</span>
         <span class="k">try</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="o">~</span><span class="n">flags</span><span class="o">:!</span><span class="n">flags</span> <span class="o">(</span><span class="s2">&quot;(&quot;</span> <span class="o">^</span> <span class="n">pat</span> <span class="o">^</span> <span class="s2">&quot;)&quot;</span><span class="o">)</span>
         <span class="k">with</span> <span class="nn">Pcre</span><span class="p">.</span><span class="nc">BadPattern</span> <span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
           <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s: bad pattern %s: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">me</span> <span class="n">pat</span> <span class="n">msg</span><span class="o">;</span>
           <span class="n">exit</span> <span class="mi">255</span><span class="o">)</span>
      <span class="n">patterns</span> <span class="k">in</span>

  <span class="c">(* Increments the matches variable by the number of matches</span>
<span class="c">     (or non-matches) in the given line. *)</span>
  <span class="k">let</span> <span class="n">count_matches</span> <span class="n">line</span> <span class="o">=</span>
    <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;v&#39;</span>
    <span class="k">then</span> <span class="k">fun</span> <span class="n">rex</span> <span class="o">-&gt;</span>
      <span class="o">(</span><span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span> <span class="o">~</span><span class="n">rex</span> <span class="n">line</span><span class="o">)</span> <span class="k">then</span> <span class="n">incr</span> <span class="n">matches</span><span class="o">)</span>
    <span class="k">else</span> <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;C&#39;</span>
    <span class="k">then</span> <span class="k">fun</span> <span class="n">rex</span> <span class="o">-&gt;</span>
      <span class="o">(</span><span class="n">matches</span> <span class="o">:=</span> <span class="o">!</span><span class="n">matches</span> <span class="o">+</span> <span class="o">(</span><span class="k">try</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">extract_all</span> <span class="o">~</span><span class="n">rex</span> <span class="n">line</span><span class="o">)</span>
                              <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="mi">0</span><span class="o">))</span>
    <span class="k">else</span> <span class="k">fun</span> <span class="n">rex</span> <span class="o">-&gt;</span>
      <span class="o">(</span><span class="k">if</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span> <span class="o">~</span><span class="n">rex</span> <span class="n">line</span> <span class="k">then</span> <span class="n">incr</span> <span class="n">matches</span><span class="o">)</span> <span class="k">in</span>

  <span class="c">(* Counts matches in a line and returns the line with any</span>
<span class="c">     necessary highlighting. *)</span>
  <span class="k">let</span> <span class="n">matcher</span> <span class="n">line</span> <span class="o">=</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="n">count_matches</span> <span class="n">line</span><span class="o">)</span> <span class="n">rexes</span><span class="o">;</span>
    <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;H&#39;</span>
    <span class="k">then</span>
      <span class="nn">List</span><span class="p">.</span><span class="n">fold_left</span>
        <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="n">rex</span> <span class="o">-&gt;</span>
           <span class="nn">Pcre</span><span class="p">.</span><span class="n">replace</span> <span class="o">~</span><span class="n">rex</span> <span class="o">~</span><span class="n">templ</span><span class="o">:</span><span class="n">highlight</span> <span class="n">line</span><span class="o">)</span>
        <span class="n">line</span> <span class="n">rexes</span>
    <span class="k">else</span> <span class="n">line</span> <span class="k">in</span>

  <span class="c">(* List of files or directories to process. *)</span>
  <span class="k">let</span> <span class="n">files</span> <span class="o">=</span>
    <span class="k">match</span> <span class="o">!</span><span class="n">args</span> <span class="k">with</span>
      <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;r&#39;</span> <span class="k">then</span> <span class="o">[</span><span class="s2">&quot;.&quot;</span><span class="o">]</span> <span class="k">else</span> <span class="o">[</span><span class="s2">&quot;-&quot;</span><span class="o">]</span>
      <span class="o">|</span> <span class="o">[</span><span class="n">arg</span><span class="o">]</span> <span class="o">-&gt;</span> <span class="o">[</span><span class="n">arg</span><span class="o">]</span>
      <span class="o">|</span> <span class="n">args</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">mult</span> <span class="o">:=</span> <span class="bp">true</span><span class="o">;</span> <span class="n">args</span><span class="o">)</span> <span class="k">in</span>

  <span class="c">(* Overrides for options that affect the multiple-file flag. *)</span>
  <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;h&#39;</span> <span class="k">then</span> <span class="n">mult</span> <span class="o">:=</span> <span class="bp">false</span><span class="o">;</span>
  <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;r&#39;</span> <span class="k">then</span> <span class="n">mult</span> <span class="o">:=</span> <span class="bp">true</span><span class="o">;</span>

  <span class="c">(* Return the three values to be processed by matchfiles. *)</span>
  <span class="n">opt</span><span class="o">,</span> <span class="n">matcher</span><span class="o">,</span> <span class="n">files</span>

<span class="c">(* Used to break out of loops and abort processing of the current file. *)</span>
<span class="k">exception</span> <span class="nc">NextFile</span>

<span class="c">(* Runs given matcher on a list of files using the specified options. *)</span>
<span class="k">let</span> <span class="k">rec</span> <span class="n">matchfiles</span> <span class="n">opt</span> <span class="n">matcher</span> <span class="n">files</span> <span class="o">=</span>
  <span class="c">(* Handles a single directory. *)</span>
  <span class="k">let</span> <span class="n">matchdir</span> <span class="n">dir</span> <span class="o">=</span>
    <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;r&#39;</span><span class="o">)</span>
    <span class="k">then</span>
      <span class="k">begin</span>
        <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;T&#39;</span>
        <span class="k">then</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s: </span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> is a directory, but no -r given</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">me</span> <span class="n">dir</span><span class="o">;</span>
              <span class="n">flush</span> <span class="n">stderr</span><span class="o">)</span>
      <span class="k">end</span>
    <span class="k">else</span>
      <span class="k">begin</span>
        <span class="k">let</span> <span class="n">files</span> <span class="o">=</span>
          <span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="n">readdir</span> <span class="n">dir</span><span class="o">)</span>
          <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span>
            <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;q&#39;</span><span class="o">)</span>
            <span class="k">then</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s: can&#39;t readdir %s: %s</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">me</span> <span class="n">dir</span> <span class="o">(</span><span class="nn">Printexc</span><span class="p">.</span><span class="n">to_string</span> <span class="n">e</span><span class="o">);</span>
                  <span class="n">flush</span> <span class="n">stderr</span><span class="o">);</span>
            <span class="n">incr</span> <span class="n">errors</span><span class="o">;</span>
            <span class="nc">None</span> <span class="k">in</span>
        <span class="k">match</span> <span class="n">files</span> <span class="k">with</span>
          <span class="o">|</span> <span class="nc">Some</span> <span class="n">files</span> <span class="o">-&gt;</span>
              <span class="k">let</span> <span class="n">by_mtime</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span>
                <span class="n">compare</span>
                  <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">stat</span> <span class="o">(</span><span class="nn">Filename</span><span class="p">.</span><span class="n">concat</span> <span class="n">dir</span> <span class="n">b</span><span class="o">)).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">st_mtime</span>
                  <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">stat</span> <span class="o">(</span><span class="nn">Filename</span><span class="p">.</span><span class="n">concat</span> <span class="n">dir</span> <span class="n">a</span><span class="o">)).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">st_mtime</span> <span class="k">in</span>
              <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;t&#39;</span>
              <span class="k">then</span> <span class="nn">Array</span><span class="p">.</span><span class="n">sort</span> <span class="n">by_mtime</span> <span class="n">files</span><span class="o">;</span>
              <span class="n">matchfiles</span> <span class="n">opt</span> <span class="n">matcher</span>
                <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span>
                   <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">map</span>
                      <span class="o">(</span><span class="nn">Filename</span><span class="p">.</span><span class="n">concat</span> <span class="n">dir</span><span class="o">)</span>
                      <span class="n">files</span><span class="o">))</span>
          <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="bp">()</span>
      <span class="k">end</span> <span class="k">in</span>

  <span class="c">(* Handles a single file. *)</span>
  <span class="k">let</span> <span class="n">matchfile</span> <span class="n">file</span> <span class="o">=</span>
    <span class="c">(* Keep a running total of matches for this file. *)</span>
    <span class="k">let</span> <span class="n">total</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>

    <span class="c">(* Keep track of the current line number. *)</span>
    <span class="k">let</span> <span class="n">line_num</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>

    <span class="c">(* Shadow close_in to properly close process channels for compressed</span>
<span class="c">       files and avoid closing stdin. *)</span>
    <span class="k">let</span> <span class="n">process_open</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">close_in</span> <span class="n">channel</span> <span class="o">=</span>
      <span class="k">if</span> <span class="o">!</span><span class="n">process_open</span>
      <span class="k">then</span> <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_in</span> <span class="n">channel</span><span class="o">)</span>
      <span class="k">else</span> <span class="k">if</span> <span class="n">channel</span> <span class="o">!=</span> <span class="n">stdin</span> <span class="k">then</span> <span class="n">close_in</span> <span class="n">channel</span> <span class="k">in</span>

    <span class="c">(* Process a line (or paragraph, with -p or -P) of input. *)</span>
    <span class="k">let</span> <span class="n">matchline</span> <span class="n">line</span> <span class="o">=</span>
       <span class="n">incr</span> <span class="n">line_num</span><span class="o">;</span>
       <span class="n">matches</span> <span class="o">:=</span> <span class="mi">0</span><span class="o">;</span>
       <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">matcher</span> <span class="n">line</span> <span class="k">in</span>
       <span class="k">if</span> <span class="o">!</span><span class="n">matches</span> <span class="o">&gt;</span> <span class="mi">0</span>
       <span class="k">then</span>
         <span class="k">begin</span>
           <span class="n">total</span> <span class="o">:=</span> <span class="o">!</span><span class="n">total</span> <span class="o">+</span> <span class="o">!</span><span class="n">matches</span><span class="o">;</span>
           <span class="n">grand_total</span> <span class="o">:=</span> <span class="o">!</span><span class="n">grand_total</span> <span class="o">+</span> <span class="o">!</span><span class="n">matches</span><span class="o">;</span>
           <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;l&#39;</span>
           <span class="k">then</span> <span class="o">(</span><span class="n">print_endline</span> <span class="n">file</span><span class="o">;</span> <span class="k">raise</span> <span class="nc">NextFile</span><span class="o">)</span>
           <span class="k">else</span> <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;s&#39;</span><span class="o">)</span>
           <span class="k">then</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s%s%s%s</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">(</span><span class="k">if</span> <span class="o">!</span><span class="n">mult</span>
                    <span class="k">then</span> <span class="n">file</span> <span class="o">^</span> <span class="s2">&quot;:&quot;</span>
                    <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="o">)</span>
                   <span class="o">(</span><span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;n&#39;</span>
                    <span class="k">then</span> <span class="o">(</span><span class="n">string_of_int</span> <span class="o">!</span><span class="n">line_num</span>
                          <span class="o">^</span> <span class="o">(</span><span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;p&#39;</span> <span class="o">||</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;P&#39;</span>
                             <span class="k">then</span> <span class="s2">&quot;:</span><span class="se">\n</span><span class="s2">&quot;</span>
                             <span class="k">else</span> <span class="s2">&quot;:&quot;</span><span class="o">))</span>
                    <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="o">)</span>
                   <span class="n">line</span>
                   <span class="o">(</span><span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;p&#39;</span> <span class="o">||</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;P&#39;</span>
                    <span class="k">then</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">^</span> <span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="mi">20</span> <span class="sc">&#39;-&#39;</span>
                    <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="o">);</span>
                 <span class="n">flush</span> <span class="n">stdout</span><span class="o">);</span>
           <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;1&#39;</span> <span class="k">then</span> <span class="k">raise</span> <span class="nc">NextFile</span>
         <span class="k">end</span> <span class="k">in</span>

    <span class="c">(* Get a channel for the file, starting a decompression process if</span>
<span class="c">       necessary. If None, the file will be skipped. *)</span>
    <span class="k">let</span> <span class="n">maybe_channel</span> <span class="o">=</span>
      <span class="k">if</span> <span class="n">file</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
      <span class="k">then</span> <span class="o">(</span><span class="k">if</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">isatty</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span> <span class="o">&amp;&amp;</span> <span class="n">not</span> <span class="o">(</span><span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;q&#39;</span><span class="o">)</span>
            <span class="k">then</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s: reading from stdin</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">me</span><span class="o">;</span>
                  <span class="n">flush</span> <span class="n">stderr</span><span class="o">);</span>
            <span class="nc">Some</span> <span class="n">stdin</span><span class="o">)</span>
      <span class="k">else</span> <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="n">file_exists</span> <span class="n">file</span><span class="o">)</span>
      <span class="k">then</span> <span class="o">(</span><span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;q&#39;</span><span class="o">)</span>
            <span class="k">then</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s: file </span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> does not exist</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">me</span> <span class="n">file</span><span class="o">;</span>
                  <span class="n">flush</span> <span class="n">stderr</span><span class="o">);</span>
            <span class="n">incr</span> <span class="n">errors</span><span class="o">;</span>
            <span class="nc">None</span><span class="o">)</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nn">List</span><span class="p">.</span><span class="n">mem_assoc</span> <span class="o">(</span><span class="n">snd</span> <span class="o">(</span><span class="n">splitext</span> <span class="n">file</span><span class="o">))</span> <span class="n">compress</span>
      <span class="k">then</span> <span class="o">(</span><span class="n">process_open</span> <span class="o">:=</span> <span class="bp">true</span><span class="o">;</span>
            <span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_in</span>
                        <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">assoc</span> <span class="o">(</span><span class="n">snd</span> <span class="o">(</span><span class="n">splitext</span> <span class="n">file</span><span class="o">))</span> <span class="n">compress</span>
                         <span class="o">^</span> <span class="s2">&quot; &lt; &quot;</span> <span class="o">^</span> <span class="n">file</span><span class="o">))</span>
            <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span>
              <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;q&#39;</span><span class="o">)</span>
              <span class="k">then</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s: %s: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">me</span> <span class="n">file</span>
                      <span class="o">(</span><span class="nn">Printexc</span><span class="p">.</span><span class="n">to_string</span> <span class="n">e</span><span class="o">);</span>
                    <span class="n">flush</span> <span class="n">stderr</span><span class="o">);</span>
              <span class="n">incr</span> <span class="n">errors</span><span class="o">;</span>
              <span class="nc">None</span><span class="o">)</span>
      <span class="k">else</span> <span class="o">(</span><span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">open_in</span> <span class="n">file</span><span class="o">)</span>
            <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span>
              <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;q&#39;</span><span class="o">)</span>
              <span class="k">then</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s: %s: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">me</span> <span class="n">file</span>
                      <span class="o">(</span><span class="nn">Printexc</span><span class="p">.</span><span class="n">to_string</span> <span class="n">e</span><span class="o">);</span>
                    <span class="n">flush</span> <span class="n">stderr</span><span class="o">);</span>
              <span class="n">incr</span> <span class="n">errors</span><span class="o">;</span>
              <span class="nc">None</span><span class="o">)</span> <span class="k">in</span>

    <span class="c">(* Run matcher on the open channel, then close the channel. *)</span>
    <span class="k">match</span> <span class="n">maybe_channel</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="bp">()</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">channel</span> <span class="o">-&gt;</span>
          <span class="k">begin</span>
            <span class="k">try</span>
              <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;T&#39;</span>
              <span class="k">then</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s: checking %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">me</span> <span class="n">file</span><span class="o">;</span>
                    <span class="n">flush</span> <span class="n">stderr</span><span class="o">);</span>
              <span class="nn">Stream</span><span class="p">.</span><span class="n">iter</span> <span class="n">matchline</span> <span class="o">(!</span><span class="n">stream_of_channel</span> <span class="n">channel</span><span class="o">);</span>
              <span class="n">close_in</span> <span class="n">channel</span>
            <span class="k">with</span>
              <span class="o">|</span> <span class="nc">NextFile</span> <span class="o">-&gt;</span>
                  <span class="n">close_in</span> <span class="n">channel</span>
              <span class="o">|</span> <span class="n">e</span> <span class="o">-&gt;</span>
                  <span class="n">close_in</span> <span class="n">channel</span><span class="o">;</span>
                  <span class="k">raise</span> <span class="n">e</span>
          <span class="k">end</span><span class="o">;</span>
          <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;c&#39;</span>
          <span class="k">then</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s%d</span><span class="se">\n</span><span class="s2">&quot;</span>
                  <span class="o">(</span><span class="k">if</span> <span class="o">!</span><span class="n">mult</span> <span class="k">then</span> <span class="n">file</span> <span class="o">^</span> <span class="s2">&quot;:&quot;</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="o">)</span>
                  <span class="o">!</span><span class="n">total</span><span class="o">;</span>
                <span class="n">flush</span> <span class="n">stdout</span><span class="o">)</span> <span class="k">in</span>

  <span class="c">(* Handle each of the specified files and directories. *)</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">file</span> <span class="o">-&gt;</span>
       <span class="k">if</span> <span class="n">file</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
       <span class="k">then</span> <span class="n">matchfile</span> <span class="n">file</span>
       <span class="k">else</span> <span class="k">if</span> <span class="k">try</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">is_directory</span> <span class="n">file</span> <span class="k">with</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>
       <span class="k">then</span> <span class="n">matchdir</span> <span class="n">file</span>
       <span class="k">else</span> <span class="n">matchfile</span> <span class="n">file</span><span class="o">)</span>
    <span class="n">files</span>

<span class="c">(* Parse command line arguments, run matcher, and set result status. *)</span>
<span class="k">let</span> <span class="n">opt</span><span class="o">,</span> <span class="n">matcher</span><span class="o">,</span> <span class="n">files</span> <span class="o">=</span> <span class="n">parse_args</span> <span class="bp">()</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">matchfiles</span> <span class="n">opt</span> <span class="n">matcher</span> <span class="n">files</span><span class="o">;</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">errors</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="n">exit</span> <span class="mi">2</span><span class="o">;</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">grand_total</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="n">exit</span> <span class="mi">0</span><span class="o">;</span>
  <span class="n">exit</span> <span class="mi">1</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN354"
>Regular Expression Grabbag</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+pcre&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;pcre.cma&quot;</span><span class="o">;;</span>

<span class="c">(*-----------------------------*)</span>

<span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span>
  <span class="o">~</span><span class="n">rex</span><span class="o">:(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span>
          <span class="o">~</span><span class="n">flags</span><span class="o">:[`</span><span class="nc">CASELESS</span><span class="o">]</span>
          <span class="s2">&quot;^m*(d?c{0,3}|c[dm])(l?x{0,3}|x[lc])(v?i{0,3}|i[vx])$&quot;</span><span class="o">)</span>
  <span class="n">input</span>

<span class="c">(*-----------------------------*)</span>

<span class="nn">Pcre</span><span class="p">.</span><span class="n">replace</span>
  <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;(</span><span class="se">\\</span><span class="s2">S+)(</span><span class="se">\\</span><span class="s2">s+)(</span><span class="se">\\</span><span class="s2">S+)&quot;</span>
  <span class="o">~</span><span class="n">templ</span><span class="o">:</span><span class="s2">&quot;$3$2$1&quot;</span>
  <span class="n">input</span>

<span class="c">(*-----------------------------*)</span>

<span class="nn">Pcre</span><span class="p">.</span><span class="n">extract</span>
  <span class="o">~</span><span class="n">full_match</span><span class="o">:</span><span class="bp">false</span>
  <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;(</span><span class="se">\\</span><span class="s2">w+)</span><span class="se">\\</span><span class="s2">s*=</span><span class="se">\\</span><span class="s2">s*(.*)</span><span class="se">\\</span><span class="s2">s*$&quot;</span>
  <span class="n">input</span>

<span class="c">(*-----------------------------*)</span>

<span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span>
  <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;.{80,}&quot;</span>
  <span class="n">input</span>

<span class="c">(*-----------------------------*)</span>

<span class="nn">Pcre</span><span class="p">.</span><span class="n">extract</span>
  <span class="o">~</span><span class="n">full_match</span><span class="o">:</span><span class="bp">false</span>
  <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;(</span><span class="se">\\</span><span class="s2">d+)/(</span><span class="se">\\</span><span class="s2">d+)/(</span><span class="se">\\</span><span class="s2">d+) (</span><span class="se">\\</span><span class="s2">d+):(</span><span class="se">\\</span><span class="s2">d+):(</span><span class="se">\\</span><span class="s2">d+)&quot;</span>
  <span class="n">input</span>

<span class="c">(*-----------------------------*)</span>

<span class="nn">Pcre</span><span class="p">.</span><span class="n">replace</span>
  <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;/usr/bin&quot;</span>
  <span class="o">~</span><span class="n">templ</span><span class="o">:</span><span class="s2">&quot;/usr/local/bin&quot;</span>
  <span class="n">input</span>

<span class="c">(*-----------------------------*)</span>

<span class="nn">Pcre</span><span class="p">.</span><span class="n">substitute_substrings</span>
  <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;%([0-9A-Fa-f][0-9A-Fa-f])&quot;</span>
  <span class="o">~</span><span class="n">subst</span><span class="o">:(</span><span class="k">fun</span> <span class="n">subs</span> <span class="o">-&gt;</span>
            <span class="k">let</span> <span class="n">c</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">get_substring</span> <span class="n">subs</span> <span class="mi">1</span> <span class="k">in</span>
            <span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="mi">1</span> <span class="o">(</span><span class="nn">Char</span><span class="p">.</span><span class="n">chr</span> <span class="o">(</span><span class="n">int_of_string</span> <span class="o">(</span><span class="s2">&quot;0x&quot;</span> <span class="o">^</span> <span class="n">c</span><span class="o">))))</span>
  <span class="n">input</span>

<span class="c">(*-----------------------------*)</span>

<span class="nn">Pcre</span><span class="p">.</span><span class="n">replace</span>
  <span class="o">~</span><span class="n">rex</span><span class="o">:(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span>
          <span class="o">~</span><span class="n">flags</span><span class="o">:[`</span><span class="nc">DOTALL</span><span class="o">;</span> <span class="o">`</span><span class="nc">EXTENDED</span><span class="o">]</span> <span class="s2">&quot;</span>
<span class="s2">            /</span><span class="se">\\</span><span class="s2">*  # Match the opening delimiter</span>
<span class="s2">            .*?   # Match a minimal number of characters</span>
<span class="s2">            </span><span class="se">\\</span><span class="s2">*/  # Match the closing delimiter</span>
<span class="s2">          &quot;</span><span class="o">)</span>
  <span class="n">input</span>

<span class="c">(*-----------------------------*)</span>

<span class="nn">Pcre</span><span class="p">.</span><span class="n">replace</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;^</span><span class="se">\\</span><span class="s2">s+&quot;</span> <span class="n">input</span>
<span class="nn">Pcre</span><span class="p">.</span><span class="n">replace</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">s+$&quot;</span> <span class="n">input</span>

<span class="c">(*-----------------------------*)</span>

<span class="nn">Pcre</span><span class="p">.</span><span class="n">replace</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">n&quot;</span> <span class="o">~</span><span class="n">templ</span><span class="o">:</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">input</span>

<span class="c">(*-----------------------------*)</span>

<span class="nn">Pcre</span><span class="p">.</span><span class="n">replace</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;^.*::&quot;</span> <span class="n">input</span>

<span class="c">(*-----------------------------*)</span>

<span class="nn">Pcre</span><span class="p">.</span><span class="n">extract</span>
  <span class="o">~</span><span class="n">full_match</span><span class="o">:</span><span class="bp">false</span>
  <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;^([01]?</span><span class="se">\\</span><span class="s2">d</span><span class="se">\\</span><span class="s2">d|2[0-4]</span><span class="se">\\</span><span class="s2">d|25[0-5])</span><span class="se">\\</span><span class="s2">.([01]?</span><span class="se">\\</span><span class="s2">d</span><span class="se">\\</span><span class="s2">d|2[0-4]</span><span class="se">\\</span><span class="s2">d|25[0-5])</span><span class="se">\\</span><span class="s2">.\</span>
<span class="s2">         ([01]?</span><span class="se">\\</span><span class="s2">d</span><span class="se">\\</span><span class="s2">d|2[0-4]</span><span class="se">\\</span><span class="s2">d|25[0-5])</span><span class="se">\\</span><span class="s2">.([01]?</span><span class="se">\\</span><span class="s2">d</span><span class="se">\\</span><span class="s2">d|2[0-4]</span><span class="se">\\</span><span class="s2">d|25[0-5])$&quot;</span>
  <span class="n">input</span>

<span class="c">(*-----------------------------*)</span>

<span class="nn">Pcre</span><span class="p">.</span><span class="n">replace</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;^.*/&quot;</span> <span class="n">input</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">termcap</span> <span class="o">=</span> <span class="s2">&quot;:co#80:li#24:&quot;</span>
<span class="k">let</span> <span class="n">cols</span> <span class="o">=</span>
  <span class="k">try</span> <span class="n">int_of_string</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">extract</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;:co#(</span><span class="se">\\</span><span class="s2">d+):&quot;</span> <span class="n">termcap</span><span class="o">).(</span><span class="mi">1</span><span class="o">)</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">|</span> <span class="nc">Failure</span> <span class="s2">&quot;int_of_string&quot;</span> <span class="o">-&gt;</span> <span class="mi">80</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">name</span> <span class="o">=</span>
  <span class="nn">Pcre</span><span class="p">.</span><span class="n">replace</span>
    <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot; /</span><span class="se">\\</span><span class="s2">S+/&quot;</span>
    <span class="o">~</span><span class="n">templ</span><span class="o">:</span><span class="s2">&quot; &quot;</span>
    <span class="o">(</span><span class="s2">&quot; &quot;</span> <span class="o">^</span> <span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot; &quot;</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">))</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">ch</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_in</span> <span class="s2">&quot;uname -a&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">os</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">ch</span> <span class="k">in</span>
  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_in</span> <span class="n">ch</span><span class="o">);</span>
  <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span> <span class="o">~</span><span class="n">rex</span><span class="o">:(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="o">~</span><span class="n">flags</span><span class="o">:[`</span><span class="nc">CASELESS</span><span class="o">]</span> <span class="s2">&quot;linux&quot;</span><span class="o">)</span> <span class="n">os</span><span class="o">)</span>
  <span class="k">then</span> <span class="n">print_endline</span> <span class="s2">&quot;This isn&#39;t Linux&quot;</span>

<span class="c">(*-----------------------------*)</span>

<span class="nn">Pcre</span><span class="p">.</span><span class="n">replace</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;</span><span class="se">\n\\</span><span class="s2">s+&quot;</span> <span class="o">~</span><span class="n">templ</span><span class="o">:</span><span class="s2">&quot; &quot;</span> <span class="n">input</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">nums</span> <span class="o">=</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">map</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">group</span> <span class="o">-&gt;</span> <span class="n">float_of_string</span> <span class="n">group</span><span class="o">.(</span><span class="mi">1</span><span class="o">))</span>
    <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">extract_all</span>
       <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;(</span><span class="se">\\</span><span class="s2">d+</span><span class="se">\\</span><span class="s2">.?</span><span class="se">\\</span><span class="s2">d*|</span><span class="se">\\</span><span class="s2">.</span><span class="se">\\</span><span class="s2">d+)&quot;</span>
       <span class="n">input</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">capwords</span> <span class="o">=</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">map</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">group</span> <span class="o">-&gt;</span> <span class="n">group</span><span class="o">.(</span><span class="mi">1</span><span class="o">))</span>
    <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">extract_all</span>
       <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;(</span><span class="se">\\</span><span class="s2">b[^</span><span class="se">\\</span><span class="s2">Wa-z0-9_]+</span><span class="se">\\</span><span class="s2">b)&quot;</span>
       <span class="n">input</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">lowords</span> <span class="o">=</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">map</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">group</span> <span class="o">-&gt;</span> <span class="n">group</span><span class="o">.(</span><span class="mi">1</span><span class="o">))</span>
    <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">extract_all</span>
       <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;(</span><span class="se">\\</span><span class="s2">b[^</span><span class="se">\\</span><span class="s2">WA-Z0-9_]+</span><span class="se">\\</span><span class="s2">b)&quot;</span>
       <span class="n">input</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">icwords</span> <span class="o">=</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">map</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">group</span> <span class="o">-&gt;</span> <span class="n">group</span><span class="o">.(</span><span class="mi">1</span><span class="o">))</span>
    <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">extract_all</span>
       <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;(</span><span class="se">\\</span><span class="s2">b[^</span><span class="se">\\</span><span class="s2">Wa-z0-9_][^</span><span class="se">\\</span><span class="s2">WA-Z0-9_]*</span><span class="se">\\</span><span class="s2">b)&quot;</span>
       <span class="n">input</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">links</span> <span class="o">=</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">map</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">group</span> <span class="o">-&gt;</span> <span class="n">group</span><span class="o">.(</span><span class="mi">1</span><span class="o">))</span>
    <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">extract_all</span>
       <span class="o">~</span><span class="n">rex</span><span class="o">:(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span>
               <span class="o">~</span><span class="n">flags</span><span class="o">:[`</span><span class="nc">DOTALL</span><span class="o">;</span> <span class="o">`</span><span class="nc">CASELESS</span><span class="o">]</span>
               <span class="s2">&quot;&lt;A[^&gt;]+?HREF</span><span class="se">\\</span><span class="s2">s*=</span><span class="se">\\</span><span class="s2">s*[</span><span class="se">\&quot;</span><span class="s2">&#39;]?([^&#39;</span><span class="se">\&quot;</span><span class="s2"> &gt;]+?)[ &#39;</span><span class="se">\&quot;</span><span class="s2">]?&gt;&quot;</span><span class="o">)</span>
       <span class="n">input</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">initial</span> <span class="o">=</span>
  <span class="k">try</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">extract</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;^</span><span class="se">\\</span><span class="s2">S+</span><span class="se">\\</span><span class="s2">s+(</span><span class="se">\\</span><span class="s2">S)</span><span class="se">\\</span><span class="s2">S*</span><span class="se">\\</span><span class="s2">s+</span><span class="se">\\</span><span class="s2">S&quot;</span> <span class="n">input</span><span class="o">).(</span><span class="mi">1</span><span class="o">)</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="s2">&quot;&quot;</span>

<span class="c">(*-----------------------------*)</span>

<span class="nn">Pcre</span><span class="p">.</span><span class="n">replace</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">([^</span><span class="se">\&quot;</span><span class="s2">]*)</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">~</span><span class="n">templ</span><span class="o">:</span><span class="s2">&quot;``$1&#39;&#39;&quot;</span> <span class="n">input</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">sentences</span> <span class="o">=</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">map</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">group</span> <span class="o">-&gt;</span> <span class="n">group</span><span class="o">.(</span><span class="mi">1</span><span class="o">))</span>
    <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">extract_all</span>
       <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;(</span><span class="se">\\</span><span class="s2">S.*?</span><span class="se">\\</span><span class="s2">pP)(?=  |</span><span class="se">\\</span><span class="s2">Z)&quot;</span>
       <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">replace</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot; {3,}&quot;</span> <span class="o">~</span><span class="n">templ</span><span class="o">:</span><span class="s2">&quot;  &quot;</span>
          <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">replace</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">~</span><span class="n">templ</span><span class="o">:</span><span class="s2">&quot; &quot;</span>
             <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">replace</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;(</span><span class="se">\\</span><span class="s2">pP</span><span class="se">\n</span><span class="s2">)&quot;</span> <span class="o">~</span><span class="n">templ</span><span class="o">:</span><span class="s2">&quot;$1  &quot;</span>
                <span class="n">input</span><span class="o">))))</span>

<span class="c">(*-----------------------------*)</span>

<span class="nn">Pcre</span><span class="p">.</span><span class="n">extract</span> <span class="o">~</span><span class="n">full_match</span><span class="o">:</span><span class="bp">false</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;(</span><span class="se">\\</span><span class="s2">d{4})-(</span><span class="se">\\</span><span class="s2">d</span><span class="se">\\</span><span class="s2">d)-(</span><span class="se">\\</span><span class="s2">d</span><span class="se">\\</span><span class="s2">d)&quot;</span> <span class="n">input</span>

<span class="c">(*-----------------------------*)</span>

<span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span>
  <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;^[01]?[- .]?(</span><span class="se">\\</span><span class="s2">([2-9]</span><span class="se">\\</span><span class="s2">d{2}</span><span class="se">\\</span><span class="s2">)|[2-9]</span><span class="se">\\</span><span class="s2">d{2})[- .]?</span><span class="se">\\</span><span class="s2">d{3}[- .]?</span><span class="se">\\</span><span class="s2">d{4}$&quot;</span>
  <span class="n">input</span>

<span class="c">(*-----------------------------*)</span>

<span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span>
  <span class="o">~</span><span class="n">rex</span><span class="o">:(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span>
          <span class="o">~</span><span class="n">flags</span><span class="o">:[`</span><span class="nc">CASELESS</span><span class="o">]</span>
          <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">boh</span><span class="se">\\</span><span class="s2">s+my</span><span class="se">\\</span><span class="s2">s+gh?o(d(dess(es)?|s?)|odness|sh)</span><span class="se">\\</span><span class="s2">b&quot;</span><span class="o">)</span>
  <span class="n">input</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">lines</span> <span class="o">=</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">map</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">group</span> <span class="o">-&gt;</span> <span class="n">group</span><span class="o">.(</span><span class="mi">1</span><span class="o">))</span>
    <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">extract_all</span>
       <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;([^</span><span class="se">\010\013</span><span class="s2">]*)(</span><span class="se">\010\013</span><span class="s2">?|</span><span class="se">\013\010</span><span class="s2">?)&quot;</span>
       <span class="n">input</span><span class="o">)</span></PRE
></TD
></TR
></TABLE
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="hashes.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="fileaccess.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Hashes</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
>&nbsp;</TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>File Access</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>
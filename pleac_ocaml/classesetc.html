<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN""http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>Classes, Objects, and Ties</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="PLEAC-Objective CAML "
HREF="index.html"><LINK
REL="PREVIOUS"
TITLE="Packages, Libraries, and Modules"
HREF="packagesetc.html"><LINK
REL="NEXT"
TITLE="Database Access"
HREF="dbaccess.html"><style type="text/css">td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
pre { line-height: 125%; }

  </style></head
><BODY TEXT="#cecece" BGCOLOR="#4f6f6f" LINK="#f5deb3" VLINK="#d5ae83"
CLASS="SECT1"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>PLEAC-Objective CAML </TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="packagesetc.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
></TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="dbaccess.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="CLASSESETC"
>13. Classes, Objects, and Ties</A
></H1
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN704"
>Introduction</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* The simplest object possible. This object has no data, no methods,</span>
<span class="c">   and does not belong to any class. *)</span>
<span class="k">let</span> <span class="n">obj</span> <span class="o">=</span> <span class="k">object</span> <span class="k">end</span>

<span class="c">(* The simplest class possible, and an instance of it. *)</span>
<span class="k">class</span> <span class="n">encoder</span> <span class="o">=</span> <span class="k">object</span> <span class="k">end</span>
<span class="k">let</span> <span class="n">obj</span> <span class="o">=</span> <span class="k">new</span> <span class="n">encoder</span>

<span class="c">(* A class living inside of a module. *)</span>
<span class="k">module</span> <span class="nc">Data</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">class</span> <span class="n">encoder</span> <span class="o">=</span> <span class="k">object</span> <span class="k">end</span>
<span class="k">end</span>
<span class="k">let</span> <span class="n">obj</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Data</span><span class="p">.</span><span class="n">encoder</span>

<span class="c">(* An object with data and a method. *)</span>
<span class="k">let</span> <span class="n">obj</span> <span class="o">=</span> <span class="k">object</span>
  <span class="k">val</span> <span class="n">data</span> <span class="o">=</span> <span class="o">[</span><span class="mi">3</span><span class="o">;</span> <span class="mi">5</span><span class="o">]</span>
  <span class="k">method</span> <span class="n">at</span> <span class="n">n</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">nth</span> <span class="n">data</span> <span class="n">n</span>
<span class="k">end</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* Display the object&#39;s identity (an integer) and call a method. *)</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%d %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">Oo</span><span class="p">.</span><span class="n">id</span> <span class="n">obj</span><span class="o">)</span> <span class="o">(</span><span class="n">obj</span><span class="o">#</span><span class="n">at</span> <span class="mi">1</span><span class="o">)</span>

<span class="c">(* A module containing a class with data and a method. *)</span>
<span class="k">module</span> <span class="nc">Human</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">class</span> <span class="o">[</span><span class="k">&#39;</span><span class="n">a</span><span class="o">]</span> <span class="n">cannibal</span> <span class="n">data</span> <span class="o">=</span> <span class="k">object</span>
    <span class="k">val</span> <span class="n">data</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="kt">list</span> <span class="o">=</span> <span class="n">data</span>
    <span class="k">method</span> <span class="n">at</span> <span class="n">n</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">nth</span> <span class="n">data</span> <span class="n">n</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">obj</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Human</span><span class="p">.</span><span class="n">cannibal</span> <span class="o">[</span><span class="mi">3</span><span class="o">;</span> <span class="mi">5</span><span class="o">]</span> <span class="k">in</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%d %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">Oo</span><span class="p">.</span><span class="n">id</span> <span class="n">obj</span><span class="o">)</span> <span class="o">(</span><span class="n">obj</span><span class="o">#</span><span class="n">at</span> <span class="mi">1</span><span class="o">)</span>

<span class="c">(* Method calls are indicated by the &#39;#&#39; operator. *)</span>
<span class="k">let</span> <span class="n">encoded</span> <span class="o">=</span> <span class="n">obj</span><span class="o">#</span><span class="n">encode</span> <span class="s2">&quot;data&quot;</span>

<span class="c">(* There is no notion of a class method in OCaml.</span>
<span class="c">   Use a module-level function instead. *)</span>
<span class="k">let</span> <span class="n">encoded</span> <span class="o">=</span> <span class="nn">Data</span><span class="p">.</span><span class="nn">Encoder</span><span class="p">.</span><span class="n">encode</span> <span class="s2">&quot;data&quot;</span>

<span class="c">(* Using the &quot;class&quot; keyword is much like defining a function. *)</span>
<span class="k">class</span> <span class="n">klass</span> <span class="o">(</span><span class="n">initial_name</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span> <span class="k">object</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">my_name</span> <span class="o">=</span> <span class="n">initial_name</span>
  <span class="k">method</span> <span class="n">name</span> <span class="o">=</span> <span class="n">my_name</span>
  <span class="k">method</span> <span class="n">set_name</span> <span class="n">name</span> <span class="o">=</span> <span class="n">my_name</span> <span class="o">&lt;-</span> <span class="n">name</span>
<span class="k">end</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">obj</span> <span class="o">=</span> <span class="k">new</span> <span class="n">klass</span> <span class="s2">&quot;Class&quot;</span> <span class="k">in</span>
  <span class="n">print_endline</span> <span class="n">obj</span><span class="o">#</span><span class="n">name</span><span class="o">;</span>
  <span class="n">obj</span><span class="o">#</span><span class="n">set_name</span> <span class="s2">&quot;Clown&quot;</span><span class="o">;</span>
  <span class="n">print_endline</span> <span class="n">obj</span><span class="o">#</span><span class="n">name</span>

<span class="c">(* Initialization can be performed prior to object creation. *)</span>
<span class="k">class</span> <span class="n">random</span> <span class="n">n</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">rng</span> <span class="o">=</span> <span class="nn">Random</span><span class="p">.</span><span class="nn">State</span><span class="p">.</span><span class="n">make_self_init</span> <span class="bp">()</span> <span class="k">in</span>
<span class="k">object</span>
  <span class="k">method</span> <span class="n">next</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Random</span><span class="p">.</span><span class="nn">State</span><span class="p">.</span><span class="n">int</span> <span class="n">rng</span> <span class="n">n</span>
<span class="k">end</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="n">random</span> <span class="mi">10</span> <span class="k">in</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Three random numbers: %d, %d, %d.</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="o">(</span><span class="n">r</span><span class="o">#</span><span class="n">next</span> <span class="bp">()</span><span class="o">)</span> <span class="o">(</span><span class="n">r</span><span class="o">#</span><span class="n">next</span> <span class="bp">()</span><span class="o">)</span> <span class="o">(</span><span class="n">r</span><span class="o">#</span><span class="n">next</span> <span class="bp">()</span><span class="o">)</span>

<span class="c">(* Initialization can also be performed after object creation.</span>
<span class="c">   Note the &quot;self&quot; parameter, which can be used much like the</span>
<span class="c">   &quot;this&quot; reference in other OO languages. *)</span>
<span class="k">class</span> <span class="n">late_initializer</span> <span class="n">name</span> <span class="o">=</span> <span class="k">object</span> <span class="o">(</span><span class="n">self</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">my_name</span> <span class="o">=</span> <span class="n">name</span>
  <span class="k">method</span> <span class="n">prepare_name</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">capitalize</span> <span class="n">my_name</span>
  <span class="k">initializer</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s is ready</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">self</span><span class="o">#</span><span class="n">prepare_name</span> <span class="bp">()</span><span class="o">)</span>
<span class="k">end</span>
<span class="k">let</span> <span class="n">obj</span> <span class="o">=</span> <span class="k">new</span> <span class="n">late_initializer</span> <span class="s2">&quot;object&quot;</span>

<span class="c">(* Methods are curried just like functions. This allows them to</span>
<span class="c">   be used just like functions in many cases. It is customary for</span>
<span class="c">   methods to take at least one argument (even if it is unit)</span>
<span class="c">   unless they represent an object&#39;s attribute. *)</span>
<span class="k">module</span> <span class="nc">Human</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">class</span> <span class="n">cannibal</span> <span class="o">(</span><span class="n">name</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span> <span class="k">object</span>
    <span class="k">val</span> <span class="k">mutable</span> <span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="k">method</span> <span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="k">method</span> <span class="n">feed</span> <span class="n">who</span> <span class="o">=</span> <span class="n">print_endline</span> <span class="o">(</span><span class="s2">&quot;Feeding &quot;</span> <span class="o">^</span> <span class="n">who</span><span class="o">)</span>
    <span class="k">method</span> <span class="n">move</span> <span class="n">where</span> <span class="o">=</span> <span class="n">print_endline</span> <span class="o">(</span><span class="s2">&quot;Moving to &quot;</span> <span class="o">^</span> <span class="n">where</span><span class="o">)</span>
    <span class="k">method</span> <span class="n">die</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">print_endline</span> <span class="s2">&quot;Dying&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">lector</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Human</span><span class="p">.</span><span class="n">cannibal</span> <span class="s2">&quot;Hannibal&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">feed</span><span class="o">,</span> <span class="n">move</span><span class="o">,</span> <span class="n">die</span> <span class="o">=</span> <span class="n">lector</span><span class="o">#</span><span class="n">feed</span><span class="o">,</span> <span class="n">lector</span><span class="o">#</span><span class="n">move</span><span class="o">,</span> <span class="n">lector</span><span class="o">#</span><span class="n">die</span> <span class="k">in</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Cannibal&#39;s name is %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">lector</span><span class="o">#</span><span class="n">name</span><span class="o">;</span>
  <span class="n">feed</span> <span class="s2">&quot;Zak&quot;</span><span class="o">;</span>
  <span class="n">move</span> <span class="s2">&quot;New York&quot;</span><span class="o">;</span>
  <span class="n">die</span> <span class="bp">()</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN707"
>Constructing an Object</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">class</span> <span class="n">klass</span> <span class="n">args</span> <span class="o">=</span> <span class="k">object</span> <span class="o">(</span><span class="n">self</span><span class="o">)</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="o">.</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">age</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">val</span> <span class="n">extra</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span>

  <span class="c">(* Private method to initialize fields. Sets start to</span>
<span class="c">     the current time, and age to 0. If called with arguments,</span>
<span class="c">     init interprets them as key+value pairs to initialize the</span>
<span class="c">     hashtable &quot;extra&quot; with. *)</span>
  <span class="k">method</span> <span class="k">private</span> <span class="n">init</span> <span class="bp">()</span> <span class="o">=</span>
    <span class="n">start</span> <span class="o">&lt;-</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">time</span> <span class="bp">()</span><span class="o">;</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
      <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">extra</span> <span class="n">k</span> <span class="n">v</span><span class="o">)</span>
      <span class="n">args</span>

  <span class="k">initializer</span>
    <span class="n">self</span><span class="o">#</span><span class="n">init</span> <span class="bp">()</span>
<span class="k">end</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN710"
>Destroying an Object</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* The Gc.finalise function can be used to create finalizers,</span>
<span class="c">   which are like destructors but run at garbage collection time,</span>
<span class="c">   for any value, not just objects. You can still use a method if</span>
<span class="c">   you want: *)</span>

<span class="k">class</span> <span class="n">klass</span> <span class="o">=</span>
<span class="k">object</span> <span class="o">(</span><span class="n">self</span><span class="o">)</span>
  <span class="k">initializer</span>
    <span class="nn">Gc</span><span class="p">.</span><span class="n">finalise</span> <span class="o">(</span><span class="k">fun</span> <span class="n">self</span> <span class="o">-&gt;</span> <span class="n">self</span><span class="o">#</span><span class="n">destroy</span> <span class="bp">()</span><span class="o">)</span> <span class="n">self</span>
  <span class="k">method</span> <span class="n">destroy</span> <span class="bp">()</span> <span class="o">=</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;klass %d is dying</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">Oo</span><span class="p">.</span><span class="n">id</span> <span class="n">self</span><span class="o">)</span>
<span class="k">end</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">ignore</span> <span class="o">(</span><span class="k">new</span> <span class="n">klass</span><span class="o">);</span>
  <span class="nn">Gc</span><span class="p">.</span><span class="n">full_major</span> <span class="bp">()</span>

<span class="c">(* The &quot;destroy&quot; method above is public. If you want to keep it</span>
<span class="c">   hidden, you can create a finalizer in a let-binding instead: *)</span>

<span class="k">class</span> <span class="n">klass</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">destroy</span> <span class="n">obj</span> <span class="o">=</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;klass %d is dying</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">Oo</span><span class="p">.</span><span class="n">id</span> <span class="n">obj</span><span class="o">)</span> <span class="k">in</span>
<span class="k">object</span> <span class="o">(</span><span class="n">self</span><span class="o">)</span>
  <span class="k">initializer</span> <span class="nn">Gc</span><span class="p">.</span><span class="n">finalise</span> <span class="n">destroy</span> <span class="n">self</span>
<span class="k">end</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN713"
>Managing Instance Data</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* Using a get and set method. *)</span>
<span class="k">class</span> <span class="n">person</span> <span class="o">=</span> <span class="k">object</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
  <span class="k">method</span> <span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
  <span class="k">method</span> <span class="n">set_name</span> <span class="n">name&#39;</span> <span class="o">=</span> <span class="n">name</span> <span class="o">&lt;-</span> <span class="n">name&#39;</span>
<span class="k">end</span>

<span class="c">(* Using a single method that does both get and set. *)</span>
<span class="k">class</span> <span class="n">person</span> <span class="o">=</span> <span class="k">object</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">age</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="c">(* Unit argument required due to optional argument. *)</span>
  <span class="k">method</span> <span class="n">age</span> <span class="o">?</span><span class="n">set</span> <span class="bp">()</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">set</span> <span class="k">with</span> <span class="nc">Some</span> <span class="n">age&#39;</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">age</span> <span class="o">&lt;-</span> <span class="n">age&#39;</span><span class="o">;</span> <span class="n">age</span><span class="o">)</span> <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="n">age</span>
<span class="k">end</span>

<span class="c">(* Sample call of get and set: happy birthday! *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">obj</span> <span class="o">=</span> <span class="k">new</span> <span class="n">person</span> <span class="k">in</span>
  <span class="n">ignore</span> <span class="o">(</span><span class="n">obj</span><span class="o">#</span><span class="n">age</span> <span class="o">~</span><span class="n">set</span><span class="o">:(</span><span class="n">obj</span><span class="o">#</span><span class="n">age</span> <span class="bp">()</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="bp">()</span><span class="o">)</span>

<span class="c">(* This class converts input when the name is set. *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>
<span class="k">class</span> <span class="n">person</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">funny_chars</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;.*[^</span><span class="se">\n\r\t</span><span class="s2"> A-Za-z0-9&#39;-]&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">numbers</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;.*[0-9]&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">not_blank</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;.*[^</span><span class="se">\n\r\t</span><span class="s2"> ]&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">multiword</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;.*[^</span><span class="se">\n\r\t</span><span class="s2"> ]+[</span><span class="se">\n\r\t</span><span class="s2"> ]+[^</span><span class="se">\n\r\t</span><span class="s2"> ]&quot;</span> <span class="k">in</span>
<span class="k">object</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
  <span class="k">method</span> <span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
  <span class="k">method</span> <span class="n">set_name</span> <span class="n">name&#39;</span> <span class="o">=</span>
    <span class="k">if</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">funny_chars</span> <span class="n">name&#39;</span> <span class="mi">0</span>
    <span class="k">then</span> <span class="n">failwith</span> <span class="s2">&quot;funny characters in name&quot;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">numbers</span> <span class="n">name&#39;</span> <span class="mi">0</span>
    <span class="k">then</span> <span class="n">failwith</span> <span class="s2">&quot;numbers in name&quot;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">not_blank</span> <span class="n">name&#39;</span> <span class="mi">0</span><span class="o">)</span>
    <span class="k">then</span> <span class="n">failwith</span> <span class="s2">&quot;name is blank&quot;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">multiword</span> <span class="n">name&#39;</span> <span class="mi">0</span><span class="o">)</span>
    <span class="k">then</span> <span class="n">failwith</span> <span class="s2">&quot;prefer multiword name&quot;</span>
    <span class="k">else</span> <span class="n">name</span> <span class="o">&lt;-</span> <span class="nn">String</span><span class="p">.</span><span class="n">capitalize</span> <span class="n">name&#39;</span>
<span class="k">end</span>

<span class="c">(* A typical class with attributes and methods. *)</span>
<span class="k">class</span> <span class="n">person</span> <span class="o">=</span> <span class="k">object</span>
  <span class="c">(* Instance variables *)</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">age</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">peers</span> <span class="o">=</span> <span class="bp">[]</span>

  <span class="c">(* Accessors *)</span>
  <span class="k">method</span> <span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
  <span class="k">method</span> <span class="n">set_name</span> <span class="n">name&#39;</span> <span class="o">=</span> <span class="n">name</span> <span class="o">&lt;-</span> <span class="n">name&#39;</span>
  <span class="k">method</span> <span class="n">age</span> <span class="o">=</span> <span class="n">age</span>
  <span class="k">method</span> <span class="n">set_age</span> <span class="n">age&#39;</span> <span class="o">=</span> <span class="n">age</span> <span class="o">&lt;-</span> <span class="n">age&#39;</span>
  <span class="k">method</span> <span class="n">peers</span> <span class="o">=</span> <span class="n">peers</span>
  <span class="k">method</span> <span class="n">set_peers</span> <span class="n">peers&#39;</span> <span class="o">=</span> <span class="n">peers</span> <span class="o">&lt;-</span> <span class="n">peers&#39;</span>

  <span class="c">(* Behavioral methods *)</span>
  <span class="k">method</span> <span class="n">exclaim</span> <span class="bp">()</span> <span class="o">=</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;Hi, I&#39;m %s age %d, working with %s&quot;</span>
      <span class="n">name</span> <span class="n">age</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;, &quot;</span> <span class="n">peers</span><span class="o">)</span>
  <span class="k">method</span> <span class="n">happy_birthday</span> <span class="bp">()</span> <span class="o">=</span>
    <span class="n">age</span> <span class="o">&lt;-</span> <span class="n">age</span> <span class="o">+</span> <span class="mi">1</span>
<span class="k">end</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN716"
>Managing Class Data</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* There are no class methods in OCaml. Use a module instead. *)</span>
<span class="k">module</span> <span class="nc">Person</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">let</span> <span class="o">_</span><span class="n">body_count</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>
  <span class="k">let</span> <span class="n">population</span> <span class="bp">()</span> <span class="o">=</span> <span class="o">!_</span><span class="n">body_count</span>
  <span class="k">let</span> <span class="n">destroy</span> <span class="n">person</span> <span class="o">=</span> <span class="n">decr</span> <span class="o">_</span><span class="n">body_count</span>
  <span class="k">class</span> <span class="n">person</span> <span class="o">=</span> <span class="k">object</span> <span class="o">(</span><span class="n">self</span><span class="o">)</span>
    <span class="k">initializer</span>
      <span class="n">incr</span> <span class="o">_</span><span class="n">body_count</span><span class="o">;</span>
      <span class="nn">Gc</span><span class="p">.</span><span class="n">finalise</span> <span class="n">destroy</span> <span class="n">self</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c">(* Later, the user can say this: *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">people</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">to</span> <span class="mi">10</span> <span class="k">do</span> <span class="n">people</span> <span class="o">:=</span> <span class="k">new</span> <span class="nn">Person</span><span class="p">.</span><span class="n">person</span> <span class="o">::</span> <span class="o">!</span><span class="n">people</span> <span class="k">done</span><span class="o">;</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;There are %d people alive.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">Person</span><span class="p">.</span><span class="n">population</span> <span class="bp">()</span><span class="o">)</span>
  <span class="c">(* There are 10 people alive. *)</span>

<span class="c">(* A class with an attribute that changes all instances when set. *)</span>
<span class="k">module</span> <span class="nc">FixedArray</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">let</span> <span class="o">_</span><span class="n">bounds</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">7</span>  <span class="c">(* default *)</span>
  <span class="k">let</span> <span class="n">max_bounds</span> <span class="bp">()</span> <span class="o">=</span> <span class="o">!_</span><span class="n">bounds</span>
  <span class="k">let</span> <span class="n">set_max_bounds</span> <span class="n">max</span> <span class="o">=</span> <span class="o">_</span><span class="n">bounds</span> <span class="o">:=</span> <span class="n">max</span>
  <span class="k">class</span> <span class="n">fixed_array</span> <span class="o">=</span> <span class="k">object</span>
    <span class="k">method</span> <span class="n">max_bounds</span> <span class="o">=</span> <span class="o">!_</span><span class="n">bounds</span>
    <span class="k">method</span> <span class="n">set_max_bounds</span> <span class="n">bounds&#39;</span> <span class="o">=</span> <span class="o">_</span><span class="n">bounds</span> <span class="o">:=</span> <span class="n">bounds&#39;</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* Set for whole class *)</span>
  <span class="nn">FixedArray</span><span class="p">.</span><span class="n">set_max_bounds</span> <span class="mi">100</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">alpha</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">FixedArray</span><span class="p">.</span><span class="n">fixed_array</span> <span class="k">in</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Bound on alpha is %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">alpha</span><span class="o">#</span><span class="n">max_bounds</span><span class="o">;</span>
  <span class="c">(* 100 *)</span>
  <span class="k">let</span> <span class="n">beta</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">FixedArray</span><span class="p">.</span><span class="n">fixed_array</span> <span class="k">in</span>
  <span class="n">beta</span><span class="o">#</span><span class="n">set_max_bounds</span> <span class="mi">50</span><span class="o">;</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Bound on alpha is %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">alpha</span><span class="o">#</span><span class="n">max_bounds</span><span class="o">;</span>
  <span class="c">(* 50 *)</span>

<span class="c">(* To make the bounds read only, just remove the set method. *)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN719"
>Using Classes as Structs</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* Immediate objects can be used like records, and their types are</span>
<span class="c">   inferred automatically. Unlike with records, object fields names</span>
<span class="c">   do not have to be unique to a module, which can be convenient. *)</span>
<span class="k">let</span> <span class="n">p</span> <span class="o">=</span> <span class="k">object</span>
  <span class="k">method</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Jason Smythe&quot;</span>
  <span class="k">method</span> <span class="n">age</span> <span class="o">=</span> <span class="mi">13</span>
  <span class="k">method</span> <span class="n">peers</span> <span class="o">=</span> <span class="o">[|</span> <span class="s2">&quot;Wilbur&quot;</span><span class="o">;</span> <span class="s2">&quot;Ralph&quot;</span><span class="o">;</span> <span class="s2">&quot;Fred&quot;</span> <span class="o">|]</span>
<span class="k">end</span>
<span class="c">(* val p : &lt; age : int; name : string; peers : string array &gt; = &lt;obj&gt; *)</span>

<span class="c">(* Fetch various values, including the zeroth friend. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;At age %d, %s&#39;s first friend is %s.</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">p</span><span class="o">#</span><span class="n">age</span> <span class="n">p</span><span class="o">#</span><span class="n">name</span> <span class="n">p</span><span class="o">#</span><span class="n">peers</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span>
<span class="c">(* At age 13, Jason Smythe&#39;s first friend is Wilbur. *)</span>

<span class="c">(*---------------------------*)</span>

<span class="c">(* Immediate objects can be nested. *)</span>
<span class="k">let</span> <span class="n">folks</span> <span class="o">=</span> <span class="k">object</span>
  <span class="k">method</span> <span class="n">head</span> <span class="o">=</span> <span class="k">object</span>
    <span class="k">method</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;John&quot;</span>
    <span class="k">method</span> <span class="n">age</span> <span class="o">=</span> <span class="mi">34</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="c">(* val folks : &lt; head : &lt; age : int; name : string &gt; &gt; = &lt;obj&gt; *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s&#39;s age is %d</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">folks</span><span class="o">#</span><span class="n">head</span><span class="o">#</span><span class="n">name</span> <span class="n">folks</span><span class="o">#</span><span class="n">head</span><span class="o">#</span><span class="n">age</span>
<span class="c">(* John&#39;s age is 34 *)</span>

<span class="c">(*---------------------------*)</span>

<span class="c">(* If you want to maintain an invariant, it&#39;s better to use a class. *)</span>
<span class="k">exception</span> <span class="nc">Unreasonable_age</span> <span class="k">of</span> <span class="kt">int</span>
<span class="k">class</span> <span class="n">person</span> <span class="n">init_name</span> <span class="n">init_age</span> <span class="o">=</span> <span class="k">object</span> <span class="o">(</span><span class="n">self</span><span class="o">)</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">age</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">method</span> <span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
  <span class="k">method</span> <span class="n">age</span> <span class="o">=</span> <span class="n">age</span>
  <span class="k">method</span> <span class="n">set_name</span> <span class="n">name&#39;</span> <span class="o">=</span> <span class="n">name</span> <span class="o">&lt;-</span> <span class="n">name&#39;</span>
  <span class="k">method</span> <span class="n">set_age</span> <span class="n">age&#39;</span> <span class="o">=</span>
    <span class="k">if</span> <span class="n">age&#39;</span> <span class="o">&gt;</span> <span class="mi">150</span> <span class="k">then</span> <span class="k">raise</span> <span class="o">(</span><span class="nc">Unreasonable_age</span> <span class="n">age&#39;</span><span class="o">)</span> <span class="k">else</span> <span class="n">age</span> <span class="o">&lt;-</span> <span class="n">age&#39;</span>
  <span class="k">initializer</span>
    <span class="n">self</span><span class="o">#</span><span class="n">set_name</span> <span class="n">init_name</span><span class="o">;</span>
    <span class="n">self</span><span class="o">#</span><span class="n">set_age</span> <span class="n">init_age</span>
<span class="k">end</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN722"
>Cloning Objects</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* Objects can be cloned with Oo.copy. *)</span>
<span class="k">let</span> <span class="n">ob1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">some_class</span>
<span class="c">(* later on *)</span>
<span class="k">let</span> <span class="n">ob2</span> <span class="o">=</span> <span class="nn">Oo</span><span class="p">.</span><span class="n">copy</span> <span class="n">ob1</span>

<span class="c">(* Objects can also be cloned using the functional update syntax. *)</span>
<span class="k">class</span> <span class="n">person</span> <span class="o">(</span><span class="n">name</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">(</span><span class="n">age</span> <span class="o">:</span> <span class="kt">int</span><span class="o">)</span> <span class="o">=</span> <span class="k">object</span>
  <span class="k">val</span> <span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
  <span class="k">val</span> <span class="n">age</span> <span class="o">=</span> <span class="n">age</span>
  <span class="k">method</span> <span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
  <span class="k">method</span> <span class="n">age</span> <span class="o">=</span> <span class="n">age</span>
  <span class="k">method</span> <span class="n">with_name</span> <span class="n">name&#39;</span> <span class="o">=</span> <span class="o">{&lt;</span> <span class="n">name</span> <span class="o">=</span> <span class="n">name&#39;</span> <span class="o">&gt;}</span>
  <span class="k">method</span> <span class="n">with_age</span> <span class="n">age&#39;</span> <span class="o">=</span> <span class="o">{&lt;</span> <span class="n">age</span> <span class="o">=</span> <span class="n">age&#39;</span> <span class="o">&gt;}</span>
  <span class="k">method</span> <span class="n">copy</span> <span class="bp">()</span> <span class="o">=</span> <span class="o">{&lt;</span> <span class="o">&gt;}</span>
<span class="k">end</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN725"
>Calling Methods Indirectly</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* Create a hashtable mapping method names to method calls. *)</span>
<span class="k">let</span> <span class="n">methods</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">3</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">methods</span> <span class="s2">&quot;run&quot;</span>   <span class="o">(</span><span class="k">fun</span> <span class="n">obj</span> <span class="o">-&gt;</span> <span class="n">obj</span><span class="o">#</span><span class="n">run</span> <span class="bp">()</span><span class="o">);</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">methods</span> <span class="s2">&quot;start&quot;</span> <span class="o">(</span><span class="k">fun</span> <span class="n">obj</span> <span class="o">-&gt;</span> <span class="n">obj</span><span class="o">#</span><span class="n">start</span> <span class="bp">()</span><span class="o">);</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">methods</span> <span class="s2">&quot;stop&quot;</span>  <span class="o">(</span><span class="k">fun</span> <span class="n">obj</span> <span class="o">-&gt;</span> <span class="n">obj</span><span class="o">#</span><span class="n">stop</span> <span class="bp">()</span><span class="o">)</span>

<span class="c">(* Call the three methods on the object by name. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">m</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">methods</span> <span class="n">m</span><span class="o">)</span> <span class="n">obj</span><span class="o">)</span>
    <span class="o">[</span><span class="s2">&quot;start&quot;</span><span class="o">;</span> <span class="s2">&quot;run&quot;</span><span class="o">;</span> <span class="s2">&quot;stop&quot;</span><span class="o">]</span>

<span class="c">(* You can alias a method as long as it takes at least one argument. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">meth</span> <span class="o">=</span> <span class="n">obj</span><span class="o">#</span><span class="n">run</span> <span class="k">in</span>
  <span class="c">(* ... *)</span>
  <span class="n">meth</span> <span class="bp">()</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN728"
>Determining Subclass Membership</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* OCaml has no runtime type information and therefore no &quot;instanceof&quot;</span>
<span class="c">   operator. One alternative would be to provide methods to query for</span>
<span class="c">   an object&#39;s class. *)</span>
<span class="k">class</span> <span class="n">widget</span> <span class="o">(</span><span class="n">name</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span> <span class="k">object</span>
  <span class="k">method</span> <span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
  <span class="k">method</span> <span class="n">is_widget</span> <span class="o">=</span> <span class="bp">true</span>
  <span class="k">method</span> <span class="n">is_gadget</span> <span class="o">=</span> <span class="bp">false</span>
<span class="k">end</span>
<span class="k">class</span> <span class="n">gadget</span> <span class="n">name</span> <span class="o">=</span> <span class="k">object</span>
  <span class="k">inherit</span> <span class="n">widget</span> <span class="n">name</span>
  <span class="k">method</span> <span class="n">is_gadget</span> <span class="o">=</span> <span class="bp">true</span>
<span class="k">end</span>

<span class="c">(* Another solution would be to use the visitor pattern. *)</span>
<span class="k">class</span> <span class="n">widget</span> <span class="o">(</span><span class="n">name</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span> <span class="k">object</span> <span class="o">(</span><span class="n">self</span><span class="o">)</span>
  <span class="k">method</span> <span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
  <span class="k">method</span> <span class="n">accept</span> <span class="o">(</span><span class="n">v</span> <span class="o">:</span> <span class="n">visitor</span><span class="o">)</span> <span class="o">=</span> <span class="n">v</span><span class="o">#</span><span class="n">visit_widget</span> <span class="o">(</span><span class="n">self</span> <span class="o">:&gt;</span> <span class="n">widget</span><span class="o">)</span>
<span class="k">end</span>
<span class="ow">and</span> <span class="n">gadget</span> <span class="n">name</span> <span class="o">=</span> <span class="k">object</span> <span class="o">(</span><span class="n">self</span><span class="o">)</span>
  <span class="k">inherit</span> <span class="n">widget</span> <span class="n">name</span>
  <span class="k">method</span> <span class="n">accept</span> <span class="o">(</span><span class="n">v</span> <span class="o">:</span> <span class="n">visitor</span><span class="o">)</span> <span class="o">=</span> <span class="n">v</span><span class="o">#</span><span class="n">visit_gadget</span> <span class="o">(</span><span class="n">self</span> <span class="o">:&gt;</span> <span class="n">gadget</span><span class="o">)</span>
<span class="k">end</span>
<span class="ow">and</span> <span class="n">visitor</span> <span class="o">~</span><span class="n">visit_widget</span> <span class="o">~</span><span class="n">visit_gadget</span> <span class="o">=</span> <span class="k">object</span>
  <span class="k">method</span> <span class="n">visit_widget</span> <span class="o">=</span> <span class="o">(</span><span class="n">visit_widget</span> <span class="o">:</span> <span class="n">widget</span> <span class="o">-&gt;</span> <span class="kt">unit</span><span class="o">)</span>
  <span class="k">method</span> <span class="n">visit_gadget</span> <span class="o">=</span> <span class="o">(</span><span class="n">visit_gadget</span> <span class="o">:</span> <span class="n">gadget</span> <span class="o">-&gt;</span> <span class="kt">unit</span><span class="o">)</span>
<span class="k">end</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">visitor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">visitor</span>
    <span class="o">~</span><span class="n">visit_gadget</span><span class="o">:</span> <span class="o">(</span><span class="k">fun</span> <span class="n">gadget</span> <span class="o">-&gt;</span>
                      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Found gadget: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">gadget</span><span class="o">#</span><span class="n">name</span><span class="o">)</span>
    <span class="o">~</span><span class="n">visit_widget</span><span class="o">:</span> <span class="o">(</span><span class="k">fun</span> <span class="n">widget</span> <span class="o">-&gt;</span>
                      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Found widget: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">widget</span><span class="o">#</span><span class="n">name</span><span class="o">)</span> <span class="k">in</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">obj</span> <span class="o">-&gt;</span> <span class="n">obj</span><span class="o">#</span><span class="n">accept</span> <span class="n">visitor</span><span class="o">)</span>
    <span class="o">[</span><span class="k">new</span> <span class="n">widget</span> <span class="s2">&quot;a&quot;</span><span class="o">;</span> <span class="k">new</span> <span class="n">gadget</span> <span class="s2">&quot;b&quot;</span><span class="o">;</span> <span class="k">new</span> <span class="n">widget</span> <span class="s2">&quot;c&quot;</span><span class="o">]</span>

<span class="c">(* Yet another solution would be to rethink your design in terms of</span>
<span class="c">   variants and pattern matching. *)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN731"
>Writing an Inheritable Class</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="k">class</span> <span class="n">person</span> <span class="o">=</span> <span class="k">object</span> <span class="o">(</span><span class="n">self</span><span class="o">)</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">age</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">method</span> <span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
  <span class="k">method</span> <span class="n">age</span> <span class="o">=</span> <span class="n">age</span>
  <span class="k">method</span> <span class="n">set_name</span> <span class="n">name&#39;</span> <span class="o">=</span> <span class="n">name</span> <span class="o">&lt;-</span> <span class="n">name&#39;</span>
  <span class="k">method</span> <span class="n">set_age</span> <span class="n">age&#39;</span> <span class="o">=</span> <span class="n">age</span> <span class="o">&lt;-</span> <span class="n">age&#39;</span>
<span class="k">end</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">dude</span> <span class="o">=</span> <span class="k">new</span> <span class="n">person</span> <span class="k">in</span>
  <span class="n">dude</span><span class="o">#</span><span class="n">set_name</span> <span class="s2">&quot;Jason&quot;</span><span class="o">;</span>
  <span class="n">dude</span><span class="o">#</span><span class="n">set_age</span> <span class="mi">23</span><span class="o">;</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s is age %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">dude</span><span class="o">#</span><span class="n">name</span> <span class="n">dude</span><span class="o">#</span><span class="n">age</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">class</span> <span class="n">employee</span> <span class="o">=</span> <span class="k">object</span> <span class="o">(</span><span class="n">self</span><span class="o">)</span>
  <span class="k">inherit</span> <span class="n">person</span>
<span class="k">end</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">empl</span> <span class="o">=</span> <span class="k">new</span> <span class="n">employee</span> <span class="k">in</span>
  <span class="n">empl</span><span class="o">#</span><span class="n">set_name</span> <span class="s2">&quot;Jason&quot;</span><span class="o">;</span>
  <span class="n">empl</span><span class="o">#</span><span class="n">set_age</span> <span class="mi">23</span><span class="o">;</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s is age %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">empl</span><span class="o">#</span><span class="n">name</span> <span class="n">empl</span><span class="o">#</span><span class="n">age</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN734"
>Accessing Overridden Methods</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="k">class</span> <span class="n">person</span> <span class="o">(</span><span class="n">name</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">(</span><span class="n">age</span> <span class="o">:</span> <span class="kt">int</span><span class="o">)</span> <span class="o">=</span> <span class="k">object</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">age</span> <span class="o">=</span> <span class="n">age</span>
  <span class="k">method</span> <span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
  <span class="k">method</span> <span class="n">age</span> <span class="o">=</span> <span class="n">age</span>
  <span class="k">method</span> <span class="n">set_name</span> <span class="n">name&#39;</span> <span class="o">=</span> <span class="n">name</span> <span class="o">&lt;-</span> <span class="n">name&#39;</span>
  <span class="k">method</span> <span class="n">set_age</span> <span class="n">age&#39;</span> <span class="o">=</span> <span class="n">age</span> <span class="o">&lt;-</span> <span class="n">age&#39;</span>
<span class="k">end</span>

<span class="k">class</span> <span class="n">liar</span> <span class="n">name</span> <span class="n">age</span> <span class="o">=</span> <span class="k">object</span>
  <span class="c">(* Call superclass constructor and alias superclass as &quot;super&quot;. *)</span>
  <span class="k">inherit</span> <span class="n">person</span> <span class="n">name</span> <span class="n">age</span> <span class="k">as</span> <span class="n">super</span>
  <span class="c">(* Call overridden &quot;age&quot; method. *)</span>
  <span class="k">method</span> <span class="n">age</span> <span class="o">=</span> <span class="n">super</span><span class="o">#</span><span class="n">age</span> <span class="o">-</span> <span class="mi">10</span>
<span class="k">end</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN737"
>Generating Attribute Methods Using AUTOLOAD</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* Use Jacques Garrigue&#39;s pa_oo syntax extension, available at:</span>
<span class="c">   http://www.math.nagoya-u.ac.jp/~garrigue/code/ocaml.html *)</span>

<span class="c">(*pp camlp4o pa_oo.cmo *)</span>
<span class="k">class</span> <span class="n">person</span> <span class="bp">()</span> <span class="o">=</span> <span class="k">object</span> <span class="o">(</span><span class="n">self</span><span class="o">)</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">with</span> <span class="n">accessor</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">age</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">with</span> <span class="n">accessor</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">parent</span> <span class="o">=</span> <span class="nc">None</span> <span class="k">with</span> <span class="n">reader</span>
  <span class="k">method</span> <span class="n">spawn</span> <span class="bp">()</span> <span class="o">=</span> <span class="o">{&lt;</span> <span class="n">parent</span> <span class="o">=</span> <span class="nc">Some</span> <span class="n">self</span> <span class="o">&gt;}</span>
<span class="k">end</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">dad</span> <span class="o">=</span> <span class="k">new</span> <span class="n">person</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="n">dad</span><span class="o">#</span><span class="n">name</span> <span class="o">&lt;-</span> <span class="s2">&quot;Jason&quot;</span><span class="o">;</span>
  <span class="n">dad</span><span class="o">#</span><span class="n">age</span> <span class="o">&lt;-</span> <span class="mi">23</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">kid</span> <span class="o">=</span> <span class="n">dad</span><span class="o">#</span><span class="n">spawn</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="n">kid</span><span class="o">#</span><span class="n">name</span> <span class="o">&lt;-</span> <span class="s2">&quot;Rachel&quot;</span><span class="o">;</span>
  <span class="n">kid</span><span class="o">#</span><span class="n">age</span> <span class="o">&lt;-</span> <span class="mi">2</span><span class="o">;</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Kid&#39;s parent is %s</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="o">(</span><span class="k">match</span> <span class="n">kid</span><span class="o">#</span><span class="n">parent</span> <span class="k">with</span>
       <span class="o">|</span> <span class="nc">Some</span> <span class="n">parent</span> <span class="o">-&gt;</span> <span class="n">parent</span><span class="o">#</span><span class="n">name</span>
       <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="s2">&quot;unknown&quot;</span><span class="o">)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN740"
>Solving the Data Inheritance Problem</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* Use prefixes in instance variable names so we can tell them apart. *)</span>
<span class="k">class</span> <span class="n">person</span> <span class="bp">()</span> <span class="o">=</span> <span class="k">object</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">person_age</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">method</span> <span class="n">age</span> <span class="o">=</span> <span class="n">person_age</span>
  <span class="k">method</span> <span class="n">set_age</span> <span class="n">age&#39;</span> <span class="o">=</span> <span class="n">person_age</span> <span class="o">&lt;-</span> <span class="n">age&#39;</span>
<span class="k">end</span>

<span class="c">(* Now we can access both instance variables as needed. *)</span>
<span class="k">class</span> <span class="n">employee</span> <span class="bp">()</span> <span class="o">=</span> <span class="k">object</span>
  <span class="k">inherit</span> <span class="n">person</span> <span class="bp">()</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">employee_age</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">method</span> <span class="n">age</span> <span class="o">=</span> <span class="n">employee_age</span>
  <span class="k">method</span> <span class="n">set_age</span> <span class="n">age&#39;</span> <span class="o">=</span> <span class="n">employee_age</span> <span class="o">&lt;-</span> <span class="n">age&#39;</span>
  <span class="k">method</span> <span class="n">person_age</span> <span class="o">=</span> <span class="n">person_age</span>
  <span class="k">method</span> <span class="n">set_person_age</span> <span class="n">age&#39;</span> <span class="o">=</span> <span class="n">person_age</span> <span class="o">&lt;-</span> <span class="n">age&#39;</span>
<span class="k">end</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN743"
>Coping with Circular Data Structures</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* OCaml features a generational garbage collector that can handle</span>
<span class="c">   circular references, so you do not need to do anything special to</span>
<span class="c">   safely dispose of circular data structures. The &quot;DESTROY&quot; method</span>
<span class="c">   has been omitted from this translation since it is unnecessary.</span>

<span class="c">   Option types are used heavily due to the imperative style of the</span>
<span class="c">   original recipe, which makes this code somewhat verbose. *)</span>

<span class="c">(* A polymorphic, circular data structure. *)</span>
<span class="k">class</span> <span class="o">[</span><span class="k">&#39;</span><span class="n">a</span><span class="o">]</span> <span class="n">ring</span> <span class="bp">()</span> <span class="o">=</span> <span class="k">object</span> <span class="o">(</span><span class="n">self</span><span class="o">)</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">dummy</span> <span class="o">=</span> <span class="o">(</span><span class="nc">None</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">ring_node</span> <span class="n">option</span><span class="o">)</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="c">(* Initialize dummy now that a reference to self is available. *)</span>
  <span class="k">initializer</span>
    <span class="o">(</span><span class="k">let</span> <span class="n">node</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ring_node</span> <span class="bp">()</span> <span class="k">in</span>
     <span class="n">node</span><span class="o">#</span><span class="n">set_prev</span> <span class="o">(</span><span class="nc">Some</span> <span class="n">node</span><span class="o">);</span>
     <span class="n">node</span><span class="o">#</span><span class="n">set_next</span> <span class="o">(</span><span class="nc">Some</span> <span class="n">node</span><span class="o">);</span>
     <span class="n">dummy</span> <span class="o">&lt;-</span> <span class="nc">Some</span> <span class="n">node</span><span class="o">)</span>

  <span class="c">(* Return the number of values in the ring. *)</span>
  <span class="k">method</span> <span class="n">count</span> <span class="o">=</span> <span class="n">count</span>

  <span class="c">(* Insert a value into the ring structure. *)</span>
  <span class="k">method</span> <span class="n">insert</span> <span class="k">value</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">node</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ring_node</span> <span class="bp">()</span> <span class="k">in</span>
    <span class="n">node</span><span class="o">#</span><span class="n">set_value</span> <span class="o">(</span><span class="nc">Some</span> <span class="k">value</span><span class="o">);</span>
    <span class="o">(</span><span class="k">match</span> <span class="n">dummy</span> <span class="k">with</span>
       <span class="o">|</span> <span class="nc">Some</span> <span class="n">ring_dummy</span> <span class="o">-&gt;</span>
           <span class="n">node</span><span class="o">#</span><span class="n">set_next</span> <span class="n">ring_dummy</span><span class="o">#</span><span class="n">next</span><span class="o">;</span>
           <span class="o">(</span><span class="k">match</span> <span class="n">ring_dummy</span><span class="o">#</span><span class="n">next</span> <span class="k">with</span>
              <span class="o">|</span> <span class="nc">Some</span> <span class="n">ring_dummy_next</span> <span class="o">-&gt;</span>
                  <span class="n">ring_dummy_next</span><span class="o">#</span><span class="n">set_prev</span> <span class="o">(</span><span class="nc">Some</span> <span class="n">node</span><span class="o">)</span>
              <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="k">assert</span> <span class="bp">false</span><span class="o">);</span>
           <span class="n">ring_dummy</span><span class="o">#</span><span class="n">set_next</span> <span class="o">(</span><span class="nc">Some</span> <span class="n">node</span><span class="o">);</span>
           <span class="n">node</span><span class="o">#</span><span class="n">set_prev</span> <span class="o">(</span><span class="nc">Some</span> <span class="n">ring_dummy</span><span class="o">);</span>
           <span class="n">count</span> <span class="o">&lt;-</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>
       <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="k">assert</span> <span class="bp">false</span><span class="o">)</span>

  <span class="c">(* Find a value in the ring. *)</span>
  <span class="k">method</span> <span class="n">search</span> <span class="k">value</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">dummy</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">ring_dummy</span> <span class="o">-&gt;</span>
          <span class="o">(</span><span class="k">match</span> <span class="n">ring_dummy</span><span class="o">#</span><span class="n">next</span> <span class="k">with</span>
             <span class="o">|</span> <span class="nc">Some</span> <span class="n">ring_dummy_next</span> <span class="o">-&gt;</span>
                 <span class="k">let</span> <span class="n">node</span> <span class="o">=</span> <span class="n">ref</span> <span class="n">ring_dummy_next</span> <span class="k">in</span>
                 <span class="k">while</span> <span class="o">!</span><span class="n">node</span> <span class="o">!=</span> <span class="n">ring_dummy</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">node</span><span class="o">#</span><span class="k">value</span> <span class="o">&lt;&gt;</span> <span class="o">(</span><span class="nc">Some</span> <span class="k">value</span><span class="o">)</span>
                 <span class="k">do</span> <span class="n">node</span> <span class="o">:=</span>
                   <span class="k">match</span> <span class="o">!</span><span class="n">node</span><span class="o">#</span><span class="n">next</span> <span class="k">with</span>
                     <span class="o">|</span> <span class="nc">Some</span> <span class="n">n</span> <span class="o">-&gt;</span> <span class="n">n</span>
                     <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="k">assert</span> <span class="bp">false</span>
                 <span class="k">done</span><span class="o">;</span>
                 <span class="o">!</span><span class="n">node</span>
             <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="k">assert</span> <span class="bp">false</span><span class="o">)</span>
      <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="k">assert</span> <span class="bp">false</span>

  <span class="c">(* Delete a node from the ring structure. *)</span>
  <span class="k">method</span> <span class="n">delete_node</span> <span class="n">node</span> <span class="o">=</span>
    <span class="o">(</span><span class="k">match</span> <span class="n">node</span><span class="o">#</span><span class="n">prev</span> <span class="k">with</span>
       <span class="o">|</span> <span class="nc">Some</span> <span class="n">node_prev</span> <span class="o">-&gt;</span> <span class="n">node_prev</span><span class="o">#</span><span class="n">set_next</span> <span class="n">node</span><span class="o">#</span><span class="n">next</span>
       <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="k">assert</span> <span class="bp">false</span><span class="o">);</span>
    <span class="o">(</span><span class="k">match</span> <span class="n">node</span><span class="o">#</span><span class="n">next</span> <span class="k">with</span>
       <span class="o">|</span> <span class="nc">Some</span> <span class="n">node_next</span> <span class="o">-&gt;</span> <span class="n">node_next</span><span class="o">#</span><span class="n">set_prev</span> <span class="n">node</span><span class="o">#</span><span class="n">prev</span>
       <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="k">assert</span> <span class="bp">false</span><span class="o">);</span>
    <span class="n">count</span> <span class="o">&lt;-</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span>

  <span class="c">(* Delete a node from the ring structure by value. *)</span>
  <span class="k">method</span> <span class="n">delete_value</span> <span class="k">value</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">node</span> <span class="o">=</span> <span class="n">self</span><span class="o">#</span><span class="n">search</span> <span class="k">value</span> <span class="k">in</span>
    <span class="k">match</span> <span class="n">dummy</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">ring_dummy</span> <span class="k">when</span> <span class="n">node</span> <span class="o">!=</span> <span class="n">ring_dummy</span> <span class="o">-&gt;</span>
          <span class="n">self</span><span class="o">#</span><span class="n">delete_node</span> <span class="n">node</span>
      <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span>
<span class="k">end</span>

<span class="c">(* A node in the ring structure which contains a polymorphic value. *)</span>
<span class="ow">and</span> <span class="o">[</span><span class="k">&#39;</span><span class="n">a</span><span class="o">]</span> <span class="n">ring_node</span> <span class="bp">()</span> <span class="o">=</span> <span class="k">object</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">prev</span> <span class="o">=</span> <span class="o">(</span><span class="nc">None</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">ring_node</span> <span class="n">option</span><span class="o">)</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">next</span> <span class="o">=</span> <span class="o">(</span><span class="nc">None</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">ring_node</span> <span class="n">option</span><span class="o">)</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="k">value</span> <span class="o">=</span> <span class="o">(</span><span class="nc">None</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">option</span><span class="o">)</span>
  <span class="k">method</span> <span class="n">prev</span> <span class="o">=</span> <span class="n">prev</span>
  <span class="k">method</span> <span class="n">next</span> <span class="o">=</span> <span class="n">next</span>
  <span class="k">method</span> <span class="k">value</span> <span class="o">=</span> <span class="k">value</span>
  <span class="k">method</span> <span class="n">set_prev</span> <span class="n">prev&#39;</span> <span class="o">=</span> <span class="n">prev</span> <span class="o">&lt;-</span> <span class="n">prev&#39;</span>
  <span class="k">method</span> <span class="n">set_next</span> <span class="n">next&#39;</span> <span class="o">=</span> <span class="n">next</span> <span class="o">&lt;-</span> <span class="n">next&#39;</span>
  <span class="k">method</span> <span class="n">set_value</span> <span class="k">value&#39;</span> <span class="o">=</span> <span class="k">value</span> <span class="o">&lt;-</span> <span class="k">value&#39;</span>
<span class="k">end</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN746"
>Overloading Operators</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* Create a class with &quot;compare_to&quot; and &quot;to_string&quot; methods. *)</span>
<span class="k">class</span> <span class="n">klass</span> <span class="n">name</span> <span class="n">idnum</span> <span class="o">=</span> <span class="k">object</span> <span class="o">(</span><span class="n">self</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">name</span> <span class="o">=</span> <span class="o">(</span><span class="n">name</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">idnum</span> <span class="o">=</span> <span class="o">(</span><span class="n">idnum</span> <span class="o">:</span> <span class="kt">int</span><span class="o">)</span>

  <span class="k">method</span> <span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
  <span class="k">method</span> <span class="n">idnum</span> <span class="o">=</span> <span class="n">idnum</span>

  <span class="k">method</span> <span class="n">compare_to</span> <span class="o">(</span><span class="n">other</span> <span class="o">:</span> <span class="n">klass</span><span class="o">)</span> <span class="o">=</span>
    <span class="n">compare</span>
      <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">uppercase</span> <span class="n">self</span><span class="o">#</span><span class="n">name</span><span class="o">)</span>
      <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">uppercase</span> <span class="n">other</span><span class="o">#</span><span class="n">name</span><span class="o">)</span>

  <span class="k">method</span> <span class="n">to_string</span> <span class="o">=</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;%s (%05d)&quot;</span>
      <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">capitalize</span> <span class="n">self</span><span class="o">#</span><span class="n">name</span><span class="o">)</span>
      <span class="n">self</span><span class="o">#</span><span class="n">idnum</span>
<span class="k">end</span>

<span class="c">(* Define a comparison operator that invokes a &quot;compare_to&quot; method. *)</span>
<span class="k">let</span> <span class="o">(</span> <span class="o">&lt;=&gt;</span> <span class="o">)</span> <span class="n">o1</span> <span class="n">o2</span> <span class="o">=</span> <span class="o">(</span><span class="n">o1</span> <span class="o">#</span><span class="n">compare_to</span> <span class="n">o2</span> <span class="o">:</span> <span class="kt">int</span><span class="o">)</span>

<span class="c">(* Demonstrate these two methods. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">a</span> <span class="o">=</span> <span class="k">new</span> <span class="n">klass</span> <span class="s2">&quot;test1&quot;</span> <span class="mi">5</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="n">klass</span> <span class="s2">&quot;TEST2&quot;</span> <span class="mi">10</span> <span class="k">in</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">a</span> <span class="o">&lt;=&gt;</span> <span class="n">b</span><span class="o">);</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s</span><span class="se">\n</span><span class="s2">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">a</span><span class="o">#</span><span class="n">to_string</span> <span class="n">b</span><span class="o">#</span><span class="n">to_string</span>

<span class="c">(* Define a module to contain our time type. *)</span>
<span class="k">module</span> <span class="nc">TimeNumber</span> <span class="o">=</span> <span class="k">struct</span>

  <span class="c">(* TimeNumber.t contains the time values. *)</span>
  <span class="k">class</span> <span class="n">t</span> <span class="n">hours</span> <span class="n">minutes</span> <span class="n">seconds</span> <span class="o">=</span> <span class="k">object</span> <span class="o">(</span><span class="n">self</span><span class="o">)</span>
    <span class="k">val</span> <span class="k">mutable</span> <span class="n">hours</span> <span class="o">=</span> <span class="o">(</span><span class="n">hours</span> <span class="o">:</span> <span class="kt">int</span><span class="o">)</span>
    <span class="k">val</span> <span class="k">mutable</span> <span class="n">minutes</span> <span class="o">=</span> <span class="o">(</span><span class="n">minutes</span> <span class="o">:</span> <span class="kt">int</span><span class="o">)</span>
    <span class="k">val</span> <span class="k">mutable</span> <span class="n">seconds</span> <span class="o">=</span> <span class="o">(</span><span class="n">seconds</span> <span class="o">:</span> <span class="kt">int</span><span class="o">)</span>

    <span class="k">method</span> <span class="n">hours</span> <span class="o">=</span> <span class="n">hours</span>
    <span class="k">method</span> <span class="n">minutes</span> <span class="o">=</span> <span class="n">minutes</span>
    <span class="k">method</span> <span class="n">seconds</span> <span class="o">=</span> <span class="n">seconds</span>

    <span class="k">method</span> <span class="n">set_hours</span> <span class="n">hours&#39;</span> <span class="o">=</span> <span class="n">hours</span> <span class="o">&lt;-</span> <span class="n">hours&#39;</span>
    <span class="k">method</span> <span class="n">set_minutes</span> <span class="n">minutes&#39;</span> <span class="o">=</span> <span class="n">minutes</span> <span class="o">&lt;-</span> <span class="n">minutes&#39;</span>
    <span class="k">method</span> <span class="n">set_seconds</span> <span class="n">seconds&#39;</span> <span class="o">=</span> <span class="n">seconds</span> <span class="o">&lt;-</span> <span class="n">seconds&#39;</span>

    <span class="c">(* TimeNumber.t#add adds two times together. *)</span>
    <span class="k">method</span> <span class="n">add</span> <span class="o">(</span><span class="n">other</span> <span class="o">:</span> <span class="n">t</span><span class="o">)</span> <span class="o">=</span>
      <span class="k">let</span> <span class="n">answer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">t</span>
        <span class="o">(</span><span class="n">self</span><span class="o">#</span><span class="n">hours</span> <span class="o">+</span> <span class="n">other</span><span class="o">#</span><span class="n">hours</span><span class="o">)</span>
        <span class="o">(</span><span class="n">self</span><span class="o">#</span><span class="n">minutes</span> <span class="o">+</span> <span class="n">other</span><span class="o">#</span><span class="n">minutes</span><span class="o">)</span>
        <span class="o">(</span><span class="n">self</span><span class="o">#</span><span class="n">seconds</span> <span class="o">+</span> <span class="n">other</span><span class="o">#</span><span class="n">seconds</span><span class="o">)</span> <span class="k">in</span>
      <span class="k">if</span> <span class="n">answer</span><span class="o">#</span><span class="n">seconds</span> <span class="o">&gt;=</span> <span class="mi">60</span>
      <span class="k">then</span> <span class="o">(</span><span class="n">answer</span><span class="o">#</span><span class="n">set_seconds</span> <span class="o">(</span><span class="n">answer</span><span class="o">#</span><span class="n">seconds</span> <span class="ow">mod</span> <span class="mi">60</span><span class="o">);</span>
            <span class="n">answer</span><span class="o">#</span><span class="n">set_minutes</span> <span class="o">(</span><span class="n">answer</span><span class="o">#</span><span class="n">minutes</span> <span class="o">+</span> <span class="mi">1</span><span class="o">));</span>
      <span class="k">if</span> <span class="n">answer</span><span class="o">#</span><span class="n">minutes</span> <span class="o">&gt;=</span> <span class="mi">60</span>
      <span class="k">then</span> <span class="o">(</span><span class="n">answer</span><span class="o">#</span><span class="n">set_minutes</span> <span class="o">(</span><span class="n">answer</span><span class="o">#</span><span class="n">minutes</span> <span class="ow">mod</span> <span class="mi">60</span><span class="o">);</span>
            <span class="n">answer</span><span class="o">#</span><span class="n">set_hours</span> <span class="o">(</span><span class="n">answer</span><span class="o">#</span><span class="n">hours</span> <span class="o">+</span> <span class="mi">1</span><span class="o">));</span>
      <span class="n">answer</span>
  <span class="k">end</span>

  <span class="c">(* TimeNumber.Operators is a submodule that is designed to be</span>
<span class="c">     imported using &quot;open&quot;. It redefines the built-in arithmetic</span>
<span class="c">     operators to work on TimeNumber.t values. *)</span>
  <span class="k">module</span> <span class="nc">Operators</span> <span class="o">=</span> <span class="k">struct</span>
    <span class="k">let</span> <span class="o">(</span> <span class="o">+</span> <span class="o">)</span> <span class="o">(</span><span class="n">t1</span> <span class="o">:</span> <span class="n">t</span><span class="o">)</span> <span class="o">(</span><span class="n">t2</span> <span class="o">:</span> <span class="n">t</span><span class="o">)</span> <span class="o">=</span> <span class="n">t1</span> <span class="o">#</span><span class="n">add</span> <span class="n">t2</span>
    <span class="c">(* let ( - ) (t1 : t) (t2 : t) = t1 #sub t2 *)</span>
    <span class="c">(* let ( * ) (t1 : t) (t2 : t) = t1 #mult t2 *)</span>
    <span class="c">(* let ( / ) (t1 : t) (t2 : t) = t1 #div t2 *)</span>
  <span class="k">end</span>

<span class="k">end</span>

<span class="c">(* Globally import the custom operators. This will make them work on</span>
<span class="c">   TimeNumber.t values *only* - to do regular integer addition, you</span>
<span class="c">   will now have to use Pervasives.( + ) and so on. *)</span>
<span class="k">open</span> <span class="nn">TimeNumber</span><span class="p">.</span><span class="nc">Operators</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">TimeNumber</span><span class="p">.</span><span class="n">t</span> <span class="mi">2</span> <span class="mi">59</span> <span class="mi">59</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">TimeNumber</span><span class="p">.</span><span class="n">t</span> <span class="mi">1</span> <span class="mi">5</span> <span class="mi">6</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">t3</span> <span class="o">=</span> <span class="n">t1</span> <span class="o">+</span> <span class="n">t2</span> <span class="k">in</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%02d:%02d:%02d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">t3</span><span class="o">#</span><span class="n">hours</span> <span class="n">t3</span><span class="o">#</span><span class="n">minutes</span> <span class="n">t3</span><span class="o">#</span><span class="n">seconds</span>

<span class="c">(* Locally import the custom operators using a &quot;let module&quot;. The</span>
<span class="c">   operators will only be redefined within the &quot;Local&quot; module. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">TimeNumber</span><span class="p">.</span><span class="n">t</span> <span class="mi">2</span> <span class="mi">59</span> <span class="mi">59</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">TimeNumber</span><span class="p">.</span><span class="n">t</span> <span class="mi">1</span> <span class="mi">5</span> <span class="mi">6</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">t3</span> <span class="o">=</span>
    <span class="k">let</span> <span class="k">module</span> <span class="nc">Local</span> <span class="o">=</span> <span class="k">struct</span>
      <span class="k">open</span> <span class="nn">TimeNumber</span><span class="p">.</span><span class="nc">Operators</span>
      <span class="k">let</span> <span class="n">result</span> <span class="o">=</span> <span class="n">t1</span> <span class="o">+</span> <span class="n">t2</span>
    <span class="k">end</span> <span class="k">in</span> <span class="nn">Local</span><span class="p">.</span><span class="n">result</span> <span class="k">in</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%02d:%02d:%02d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">t3</span><span class="o">#</span><span class="n">hours</span> <span class="n">t3</span><span class="o">#</span><span class="n">minutes</span> <span class="n">t3</span><span class="o">#</span><span class="n">seconds</span>

<span class="c">(* The openin syntax extension can simplify the above technique.</span>
<span class="c">   openin is available at http://alain.frisch.fr/soft.html#openin *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">TimeNumber</span><span class="p">.</span><span class="n">t</span> <span class="mi">2</span> <span class="mi">59</span> <span class="mi">59</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">TimeNumber</span><span class="p">.</span><span class="n">t</span> <span class="mi">1</span> <span class="mi">5</span> <span class="mi">6</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">t3</span> <span class="o">=</span> <span class="k">open</span> <span class="nn">TimeNumber</span><span class="p">.</span><span class="nc">Operators</span> <span class="k">in</span> <span class="n">t1</span> <span class="o">+</span> <span class="n">t2</span> <span class="k">in</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%02d:%02d:%02d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">t3</span><span class="o">#</span><span class="n">hours</span> <span class="n">t3</span><span class="o">#</span><span class="n">minutes</span> <span class="n">t3</span><span class="o">#</span><span class="n">seconds</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* show_strnum - demo operator overloading *)</span>

<span class="k">class</span> <span class="n">strnum</span> <span class="k">value</span> <span class="o">=</span> <span class="k">object</span>
  <span class="k">method</span> <span class="k">value</span> <span class="o">=</span> <span class="k">value</span>
  <span class="k">method</span> <span class="n">spaceship</span> <span class="o">(</span><span class="n">other</span> <span class="o">:</span> <span class="n">strnum</span><span class="o">)</span> <span class="o">=</span> <span class="n">compare</span> <span class="k">value</span> <span class="o">(</span><span class="n">other</span><span class="o">#</span><span class="k">value</span><span class="o">)</span>
  <span class="k">method</span> <span class="n">concat</span> <span class="o">(</span><span class="n">other</span> <span class="o">:</span> <span class="n">strnum</span><span class="o">)</span> <span class="o">=</span> <span class="k">new</span> <span class="n">strnum</span> <span class="o">(</span><span class="k">value</span> <span class="o">^</span> <span class="n">other</span><span class="o">#</span><span class="k">value</span><span class="o">)</span>
  <span class="k">method</span> <span class="n">repeat</span> <span class="n">n</span> <span class="o">=</span> <span class="k">new</span> <span class="n">strnum</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span>
                                  <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">make</span> <span class="n">n</span> <span class="k">value</span><span class="o">)))</span>
<span class="k">end</span>

<span class="k">let</span> <span class="o">(</span>  <span class="o">+</span>  <span class="o">)</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">#</span><span class="n">concat</span> <span class="n">b</span>
<span class="k">let</span> <span class="o">(</span>  <span class="o">*</span>  <span class="o">)</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">#</span><span class="n">repeat</span> <span class="n">b</span>
<span class="k">let</span> <span class="o">(</span> <span class="o">&lt;=&gt;</span> <span class="o">)</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">#</span><span class="n">spaceship</span> <span class="n">b</span>
<span class="k">let</span> <span class="o">(</span>  <span class="o">&lt;</span>  <span class="o">)</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">&lt;=&gt;</span> <span class="n">b</span> <span class="o">&lt;</span> <span class="mi">0</span>
<span class="k">let</span> <span class="o">(</span> <span class="o">&lt;=</span>  <span class="o">)</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">&lt;=&gt;</span> <span class="n">b</span> <span class="o">&lt;=</span> <span class="mi">0</span>
<span class="k">let</span> <span class="o">(</span>  <span class="o">=</span>  <span class="o">)</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">&lt;=&gt;</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">let</span> <span class="o">(</span> <span class="o">&gt;=</span>  <span class="o">)</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">&lt;=&gt;</span> <span class="n">b</span> <span class="o">&gt;=</span> <span class="mi">0</span>
<span class="k">let</span> <span class="o">(</span>  <span class="o">&gt;</span>  <span class="o">)</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">&lt;=&gt;</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="mi">0</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">x</span> <span class="o">=</span> <span class="k">new</span> <span class="n">strnum</span> <span class="s2">&quot;Red&quot;</span>
<span class="k">let</span> <span class="n">y</span> <span class="o">=</span> <span class="k">new</span> <span class="n">strnum</span> <span class="s2">&quot;Black&quot;</span>
<span class="k">let</span> <span class="n">z</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
<span class="k">let</span> <span class="n">r</span> <span class="o">=</span> <span class="n">z</span> <span class="o">*</span> <span class="mi">3</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;values are %s, %s, %s, and %s</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">x</span><span class="o">#</span><span class="k">value</span> <span class="n">y</span><span class="o">#</span><span class="k">value</span> <span class="n">z</span><span class="o">#</span><span class="k">value</span> <span class="n">r</span><span class="o">#</span><span class="k">value</span><span class="o">;</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s is %s %s</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">x</span><span class="o">#</span><span class="k">value</span> <span class="o">(</span><span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">y</span> <span class="k">then</span> <span class="s2">&quot;LT&quot;</span> <span class="k">else</span> <span class="s2">&quot;GE&quot;</span><span class="o">)</span> <span class="n">y</span><span class="o">#</span><span class="k">value</span>

<span class="c">(*</span>
<span class="c">  values are Red, Black, RedBlack, and RedBlackRedBlackRedBlack</span>
<span class="c">  Red is GE Black</span>
<span class="c">*)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* demo_fixnum - show operator overloading *)</span>

<span class="k">module</span> <span class="nc">FixNum</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">let</span> <span class="n">default_places</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>
  <span class="k">class</span> <span class="n">t</span> <span class="o">?</span><span class="n">places</span> <span class="o">(</span><span class="k">value</span> <span class="o">:</span> <span class="kt">float</span><span class="o">)</span> <span class="o">=</span> <span class="k">object</span>
    <span class="k">val</span> <span class="k">mutable</span> <span class="n">places</span> <span class="o">=</span>
      <span class="k">match</span> <span class="n">places</span> <span class="k">with</span>
        <span class="o">|</span> <span class="nc">Some</span> <span class="n">n</span> <span class="o">-&gt;</span> <span class="n">n</span>
        <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="o">!</span><span class="n">default_places</span>
    <span class="k">val</span> <span class="k">value</span> <span class="o">=</span> <span class="k">value</span>
    <span class="k">method</span> <span class="n">places</span> <span class="o">=</span> <span class="n">places</span>
    <span class="k">method</span> <span class="n">set_places</span> <span class="n">n</span> <span class="o">=</span> <span class="n">places</span> <span class="o">&lt;-</span> <span class="n">n</span>
    <span class="k">method</span> <span class="k">value</span> <span class="o">=</span> <span class="k">value</span>
    <span class="k">method</span> <span class="n">to_string</span> <span class="o">=</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;FixNum.t: %.*f&quot;</span> <span class="n">places</span> <span class="k">value</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">let</span> <span class="o">(</span> <span class="o">+</span> <span class="o">)</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span>
  <span class="k">new</span> <span class="nn">FixNum</span><span class="p">.</span><span class="n">t</span> <span class="o">~</span><span class="n">places</span><span class="o">:(</span><span class="n">max</span> <span class="n">a</span><span class="o">#</span><span class="n">places</span> <span class="n">b</span><span class="o">#</span><span class="n">places</span><span class="o">)</span> <span class="o">(</span><span class="n">a</span><span class="o">#</span><span class="k">value</span> <span class="o">+.</span> <span class="n">b</span><span class="o">#</span><span class="k">value</span><span class="o">)</span>
<span class="k">let</span> <span class="o">(</span> <span class="o">-</span> <span class="o">)</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span>
  <span class="k">new</span> <span class="nn">FixNum</span><span class="p">.</span><span class="n">t</span> <span class="o">~</span><span class="n">places</span><span class="o">:(</span><span class="n">max</span> <span class="n">a</span><span class="o">#</span><span class="n">places</span> <span class="n">b</span><span class="o">#</span><span class="n">places</span><span class="o">)</span> <span class="o">(</span><span class="n">a</span><span class="o">#</span><span class="k">value</span> <span class="o">-.</span> <span class="n">b</span><span class="o">#</span><span class="k">value</span><span class="o">)</span>
<span class="k">let</span> <span class="o">(</span> <span class="o">*</span> <span class="o">)</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span>
  <span class="k">new</span> <span class="nn">FixNum</span><span class="p">.</span><span class="n">t</span> <span class="o">~</span><span class="n">places</span><span class="o">:(</span><span class="n">max</span> <span class="n">a</span><span class="o">#</span><span class="n">places</span> <span class="n">b</span><span class="o">#</span><span class="n">places</span><span class="o">)</span> <span class="o">(</span><span class="n">a</span><span class="o">#</span><span class="k">value</span> <span class="o">*.</span> <span class="n">b</span><span class="o">#</span><span class="k">value</span><span class="o">)</span>
<span class="k">let</span> <span class="o">(</span> <span class="o">/</span> <span class="o">)</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span>
  <span class="k">new</span> <span class="nn">FixNum</span><span class="p">.</span><span class="n">t</span> <span class="o">~</span><span class="n">places</span><span class="o">:(</span><span class="n">max</span> <span class="n">a</span><span class="o">#</span><span class="n">places</span> <span class="n">b</span><span class="o">#</span><span class="n">places</span><span class="o">)</span> <span class="o">(</span><span class="n">a</span><span class="o">#</span><span class="k">value</span> <span class="o">/.</span> <span class="n">b</span><span class="o">#</span><span class="k">value</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* let () = FixNum.default_places := 5 *)</span>

<span class="k">let</span> <span class="n">x</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">FixNum</span><span class="p">.</span><span class="n">t</span> <span class="mi">40</span><span class="o">.</span>
<span class="k">let</span> <span class="n">y</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">FixNum</span><span class="p">.</span><span class="n">t</span> <span class="mi">12</span><span class="o">.</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;sum of %s and %s is %s</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">x</span><span class="o">#</span><span class="n">to_string</span> <span class="n">y</span><span class="o">#</span><span class="n">to_string</span> <span class="o">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="o">)#</span><span class="n">to_string</span><span class="o">;</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;product of %s and %s is %s</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">x</span><span class="o">#</span><span class="n">to_string</span> <span class="n">y</span><span class="o">#</span><span class="n">to_string</span> <span class="o">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="o">)#</span><span class="n">to_string</span>

<span class="k">let</span> <span class="n">z</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="n">y</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s has %d places</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">z</span><span class="o">#</span><span class="n">to_string</span> <span class="n">z</span><span class="o">#</span><span class="n">places</span><span class="o">;</span>
  <span class="k">if</span> <span class="n">z</span><span class="o">#</span><span class="n">places</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">then</span> <span class="n">z</span><span class="o">#</span><span class="n">set_places</span> <span class="mi">2</span><span class="o">;</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;div of %s by %s is %s</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">x</span><span class="o">#</span><span class="n">to_string</span> <span class="n">y</span><span class="o">#</span><span class="n">to_string</span> <span class="n">z</span><span class="o">#</span><span class="n">to_string</span><span class="o">;</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;square of that is %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">z</span> <span class="o">*</span> <span class="n">z</span><span class="o">)#</span><span class="n">to_string</span>

<span class="c">(*</span>
<span class="c">  sum of FixNum.t: 40 and FixNum.t: 12 is FixNum.t: 52</span>
<span class="c">  product of FixNum.t: 40 and FixNum.t: 12 is FixNum.t: 480</span>
<span class="c">  FixNum.t: 3 has 0 places</span>
<span class="c">  div of FixNum.t: 40 by FixNum.t: 12 is FixNum.t: 3.33</span>
<span class="c">  square of that is FixNum.t: 11.11</span>
<span class="c">*)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN749"
>Creating Magic Variables with tie</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">(* OCaml does not have anything like Perl&#39;s &quot;tie&quot; feature; you can&#39;t</span>
<span class="c">   make an identifier evaluate to anything other than itself. Since</span>
<span class="c">   &quot;tie&quot; is just syntax sugar anyway, all of the examples can be done</span>
<span class="c">   with regular classes and objects. *)</span>

<span class="k">class</span> <span class="o">[</span><span class="k">&#39;</span><span class="n">a</span><span class="o">]</span> <span class="n">value_ring</span> <span class="n">values</span> <span class="o">=</span> <span class="k">object</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">values</span> <span class="o">=</span> <span class="o">(</span><span class="n">values</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="kt">list</span><span class="o">)</span>
  <span class="k">method</span> <span class="n">get</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">values</span> <span class="k">with</span>
      <span class="o">|</span> <span class="n">h</span> <span class="o">::</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">values</span> <span class="o">&lt;-</span> <span class="n">t</span> <span class="o">@</span> <span class="o">[</span><span class="n">h</span><span class="o">];</span> <span class="n">h</span>
      <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="k">raise</span> <span class="nc">Not_found</span>
  <span class="k">method</span> <span class="n">add</span> <span class="k">value</span> <span class="o">=</span>
    <span class="n">values</span> <span class="o">&lt;-</span> <span class="k">value</span> <span class="o">::</span> <span class="n">values</span>
<span class="k">end</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">colors</span> <span class="o">=</span> <span class="k">new</span> <span class="n">value_ring</span> <span class="o">[</span><span class="s2">&quot;red&quot;</span><span class="o">;</span> <span class="s2">&quot;blue&quot;</span><span class="o">]</span> <span class="k">in</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s %s %s %s %s %s</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">colors</span><span class="o">#</span><span class="n">get</span> <span class="n">colors</span><span class="o">#</span><span class="n">get</span> <span class="n">colors</span><span class="o">#</span><span class="n">get</span>
    <span class="n">colors</span><span class="o">#</span><span class="n">get</span> <span class="n">colors</span><span class="o">#</span><span class="n">get</span> <span class="n">colors</span><span class="o">#</span><span class="n">get</span><span class="o">;</span>
  <span class="c">(* blue red blue red blue red *)</span>

  <span class="n">colors</span><span class="o">#</span><span class="n">add</span> <span class="s2">&quot;green&quot;</span><span class="o">;</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s %s %s %s %s %s</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">colors</span><span class="o">#</span><span class="n">get</span> <span class="n">colors</span><span class="o">#</span><span class="n">get</span> <span class="n">colors</span><span class="o">#</span><span class="n">get</span>
    <span class="n">colors</span><span class="o">#</span><span class="n">get</span> <span class="n">colors</span><span class="o">#</span><span class="n">get</span> <span class="n">colors</span><span class="o">#</span><span class="n">get</span>
  <span class="c">(* blue red green blue red green *)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Magic hash that autoappends. *)</span>

<span class="k">class</span> <span class="o">[</span><span class="k">&#39;</span><span class="n">a</span><span class="o">,</span> <span class="k">&#39;</span><span class="n">b</span><span class="o">]</span> <span class="n">append_hash</span> <span class="n">size</span> <span class="o">=</span> <span class="k">object</span>
  <span class="k">val</span> <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="n">size</span> <span class="o">:</span> <span class="o">(</span><span class="k">&#39;</span><span class="n">a</span><span class="o">,</span> <span class="k">&#39;</span><span class="n">b</span><span class="o">)</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">t</span><span class="o">)</span>
  <span class="k">method</span> <span class="n">get</span> <span class="n">k</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">hash</span> <span class="n">k</span>
  <span class="k">method</span> <span class="n">set</span> <span class="n">k</span> <span class="n">v</span> <span class="o">=</span>
    <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">hash</span> <span class="n">k</span>
      <span class="o">(</span><span class="k">try</span> <span class="n">v</span> <span class="o">::</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">hash</span> <span class="n">k</span> <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="o">[</span><span class="n">v</span><span class="o">])</span>
  <span class="k">method</span> <span class="n">each</span> <span class="n">f</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span> <span class="n">f</span> <span class="n">hash</span>
<span class="k">end</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">tab</span> <span class="o">=</span> <span class="k">new</span> <span class="n">append_hash</span> <span class="mi">3</span> <span class="k">in</span>
  <span class="n">tab</span><span class="o">#</span><span class="n">set</span> <span class="s2">&quot;beer&quot;</span> <span class="s2">&quot;guinness&quot;</span><span class="o">;</span>
  <span class="n">tab</span><span class="o">#</span><span class="n">set</span> <span class="s2">&quot;food&quot;</span> <span class="s2">&quot;potatoes&quot;</span><span class="o">;</span>
  <span class="n">tab</span><span class="o">#</span><span class="n">set</span> <span class="s2">&quot;food&quot;</span> <span class="s2">&quot;peas&quot;</span><span class="o">;</span>
  <span class="n">tab</span><span class="o">#</span><span class="n">each</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">k</span> <span class="n">vs</span> <span class="o">-&gt;</span>
       <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s =&gt; [%s]</span><span class="se">\n</span><span class="s2">&quot;</span>
         <span class="n">k</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot; &quot;</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="n">vs</span><span class="o">)))</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(*</span>
<span class="c">  beer =&gt; [guinness]</span>
<span class="c">  food =&gt; [potatoes peas]</span>
<span class="c">*)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* For a more lightweight syntax, you can override the .{}</span>
<span class="c">   operator--which normally works with Bigarrays--to work on</span>
<span class="c">   any object with &quot;get&quot; and &quot;set&quot; methods. *)</span>

<span class="k">module</span> <span class="nc">Bigarray</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">module</span> <span class="nc">Array1</span> <span class="o">=</span> <span class="k">struct</span>
    <span class="k">let</span> <span class="n">get</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="o">#</span><span class="n">get</span>
    <span class="k">let</span> <span class="n">set</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="o">#</span><span class="n">set</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">tab</span> <span class="o">=</span> <span class="k">new</span> <span class="n">append_hash</span> <span class="mi">3</span> <span class="k">in</span>
  <span class="n">tab</span><span class="o">.{</span><span class="s2">&quot;beer&quot;</span><span class="o">}</span> <span class="o">&lt;-</span> <span class="s2">&quot;guinness&quot;</span><span class="o">;</span>
  <span class="n">tab</span><span class="o">.{</span><span class="s2">&quot;food&quot;</span><span class="o">}</span> <span class="o">&lt;-</span> <span class="s2">&quot;potatoes&quot;</span><span class="o">;</span>
  <span class="n">tab</span><span class="o">.{</span><span class="s2">&quot;food&quot;</span><span class="o">}</span> <span class="o">&lt;-</span> <span class="s2">&quot;peas&quot;</span><span class="o">;</span>
  <span class="n">tab</span><span class="o">#</span><span class="n">each</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">k</span> <span class="n">vs</span> <span class="o">-&gt;</span>
       <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s =&gt; [%s]</span><span class="se">\n</span><span class="s2">&quot;</span>
         <span class="n">k</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot; &quot;</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="n">vs</span><span class="o">)));</span>
  <span class="n">print_endline</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">hd</span> <span class="n">tab</span><span class="o">.{</span><span class="s2">&quot;beer&quot;</span><span class="o">})</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Hash that magically folds case. *)</span>

<span class="k">class</span> <span class="o">[</span><span class="k">&#39;</span><span class="n">a</span><span class="o">]</span> <span class="n">folded_hash</span> <span class="n">size</span> <span class="o">=</span> <span class="k">object</span>
  <span class="k">val</span> <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="n">size</span> <span class="o">:</span> <span class="o">(</span><span class="kt">string</span><span class="o">,</span> <span class="k">&#39;</span><span class="n">a</span><span class="o">)</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">t</span><span class="o">)</span>
  <span class="k">method</span> <span class="n">get</span> <span class="n">k</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">hash</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">lowercase</span> <span class="n">k</span><span class="o">)</span>
  <span class="k">method</span> <span class="n">set</span> <span class="n">k</span> <span class="n">v</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">hash</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">lowercase</span> <span class="n">k</span><span class="o">)</span> <span class="n">v</span>
  <span class="k">method</span> <span class="n">each</span> <span class="n">f</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span> <span class="n">f</span> <span class="n">hash</span>
<span class="k">end</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">tab</span> <span class="o">=</span> <span class="k">new</span> <span class="n">folded_hash</span> <span class="mi">2</span> <span class="k">in</span>
  <span class="n">tab</span><span class="o">.{</span><span class="s2">&quot;VILLAIN&quot;</span><span class="o">}</span> <span class="o">&lt;-</span> <span class="s2">&quot;big &quot;</span><span class="o">;</span>
  <span class="n">tab</span><span class="o">.{</span><span class="s2">&quot;herOine&quot;</span><span class="o">}</span> <span class="o">&lt;-</span> <span class="s2">&quot;red riding hood&quot;</span><span class="o">;</span>
  <span class="n">tab</span><span class="o">.{</span><span class="s2">&quot;villain&quot;</span><span class="o">}</span> <span class="o">&lt;-</span> <span class="n">tab</span><span class="o">.{</span><span class="s2">&quot;villain&quot;</span><span class="o">}</span> <span class="o">^</span> <span class="s2">&quot;bad wolf&quot;</span><span class="o">;</span>
  <span class="n">tab</span><span class="o">#</span><span class="n">each</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s is %s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span>

<span class="c">(*</span>
<span class="c">  heroine is red riding hood</span>
<span class="c">  villain is big bad wolf</span>
<span class="c">*)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Hash that permits key *or* value lookups. *)</span>
<span class="k">class</span> <span class="o">[</span><span class="k">&#39;</span><span class="n">a</span><span class="o">]</span> <span class="n">rev_hash</span> <span class="n">size</span> <span class="o">=</span> <span class="k">object</span>
  <span class="k">val</span> <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="n">size</span> <span class="o">:</span> <span class="o">(</span><span class="k">&#39;</span><span class="n">a</span><span class="o">,</span> <span class="k">&#39;</span><span class="n">a</span><span class="o">)</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">t</span><span class="o">)</span>
  <span class="k">method</span> <span class="n">get</span> <span class="n">k</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">hash</span> <span class="n">k</span>
  <span class="k">method</span> <span class="n">set</span> <span class="n">k</span> <span class="n">v</span> <span class="o">=</span>
    <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">hash</span> <span class="n">k</span> <span class="n">v</span><span class="o">;</span>
    <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">hash</span> <span class="n">v</span> <span class="n">k</span>
  <span class="k">method</span> <span class="n">each</span> <span class="n">f</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span> <span class="n">f</span> <span class="n">hash</span>
<span class="k">end</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">tab</span> <span class="o">=</span> <span class="k">new</span> <span class="n">rev_hash</span> <span class="mi">8</span> <span class="k">in</span>
  <span class="n">tab</span><span class="o">.{`</span><span class="nc">Str</span> <span class="s2">&quot;Red&quot;</span><span class="o">}</span> <span class="o">&lt;-</span> <span class="o">`</span><span class="nc">Str</span> <span class="s2">&quot;Rojo&quot;</span><span class="o">;</span>
  <span class="n">tab</span><span class="o">.{`</span><span class="nc">Str</span> <span class="s2">&quot;Blue&quot;</span><span class="o">}</span> <span class="o">&lt;-</span> <span class="o">`</span><span class="nc">Str</span> <span class="s2">&quot;Azul&quot;</span><span class="o">;</span>
  <span class="n">tab</span><span class="o">.{`</span><span class="nc">Str</span> <span class="s2">&quot;Green&quot;</span><span class="o">}</span> <span class="o">&lt;-</span> <span class="o">`</span><span class="nc">Str</span> <span class="s2">&quot;Verde&quot;</span><span class="o">;</span>
  <span class="n">tab</span><span class="o">.{`</span><span class="nc">Str</span> <span class="s2">&quot;EVIL&quot;</span><span class="o">}</span> <span class="o">&lt;-</span> <span class="o">`</span><span class="nc">StrList</span> <span class="o">[</span> <span class="s2">&quot;No way!&quot;</span><span class="o">;</span> <span class="s2">&quot;Way!!&quot;</span> <span class="o">];</span>
  <span class="k">let</span> <span class="n">to_string</span> <span class="o">=</span> <span class="k">function</span>
    <span class="o">|</span> <span class="o">`</span><span class="nc">Str</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span>
    <span class="o">|</span> <span class="o">`</span><span class="nc">StrList</span> <span class="n">ss</span> <span class="o">-&gt;</span> <span class="s2">&quot;[&quot;</span> <span class="o">^</span> <span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot; &quot;</span> <span class="n">ss</span> <span class="o">^</span> <span class="s2">&quot;]&quot;</span> <span class="k">in</span>
  <span class="n">tab</span><span class="o">#</span><span class="n">each</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">k</span> <span class="n">v</span> <span class="o">-&gt;</span>
       <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s =&gt; %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">to_string</span> <span class="n">k</span><span class="o">)</span> <span class="o">(</span><span class="n">to_string</span> <span class="n">v</span><span class="o">))</span>

<span class="c">(*</span>
<span class="c">  Verde =&gt; Green</span>
<span class="c">  Azul =&gt; Blue</span>
<span class="c">  Green =&gt; Verde</span>
<span class="c">  Blue =&gt; Azul</span>
<span class="c">  Red =&gt; Rojo</span>
<span class="c">  [No way! Way!!] =&gt; EVIL</span>
<span class="c">  EVIL =&gt; [No way! Way!!]</span>
<span class="c">  Rojo =&gt; Red</span>
<span class="c">*)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Simple counter. *)</span>

<span class="k">class</span> <span class="n">counter</span> <span class="n">start</span> <span class="o">=</span> <span class="k">object</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="k">value</span> <span class="o">=</span> <span class="o">(</span><span class="n">start</span> <span class="o">:</span> <span class="kt">int</span><span class="o">)</span>
  <span class="k">method</span> <span class="n">next</span> <span class="o">=</span> <span class="k">value</span> <span class="o">&lt;-</span> <span class="k">value</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span> <span class="k">value</span>
<span class="k">end</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">c</span> <span class="o">=</span> <span class="k">new</span> <span class="n">counter</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Got %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">c</span><span class="o">#</span><span class="n">next</span>
  <span class="k">done</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Tee-like class that outputs to multiple channels at once. *)</span>

<span class="k">class</span> <span class="n">tee</span> <span class="n">channels</span> <span class="o">=</span> <span class="k">object</span>
  <span class="k">method</span> <span class="n">print</span> <span class="n">s</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">ch</span> <span class="o">-&gt;</span> <span class="n">output_string</span> <span class="n">ch</span> <span class="n">s</span><span class="o">)</span> <span class="n">channels</span>
<span class="k">end</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">tee</span> <span class="o">=</span> <span class="k">new</span> <span class="n">tee</span> <span class="o">[</span><span class="n">stdout</span><span class="o">;</span> <span class="n">stderr</span><span class="o">]</span> <span class="k">in</span>
  <span class="n">tee</span><span class="o">#</span><span class="n">print</span> <span class="s2">&quot;This line goes to both places.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
  <span class="n">flush_all</span> <span class="bp">()</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">tee</span> <span class="o">=</span> <span class="k">new</span> <span class="n">tee</span>
    <span class="o">(</span><span class="n">stdout</span> <span class="o">::</span>
       <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span>
          <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">init</span> <span class="mi">10</span>
             <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span>
                <span class="n">snd</span> <span class="o">(</span><span class="nn">Filename</span><span class="p">.</span><span class="n">open_temp_file</span> <span class="s2">&quot;teetest.&quot;</span> <span class="s2">&quot;&quot;</span><span class="o">)))))</span> <span class="k">in</span>
  <span class="n">tee</span><span class="o">#</span><span class="n">print</span> <span class="s2">&quot;This lines goes many places.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
  <span class="n">flush_all</span> <span class="bp">()</span></PRE
></TD
></TR
></TABLE
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="packagesetc.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="dbaccess.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Packages, Libraries, and Modules</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
>&nbsp;</TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Database Access</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>
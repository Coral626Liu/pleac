<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN""http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>File Contents</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="PLEAC-Guile 1.8"
HREF="index.html"><LINK
REL="PREVIOUS"
TITLE="File Access"
HREF="fileaccess.html"><LINK
REL="NEXT"
TITLE="Directories"
HREF="directories.html"><style type="text/css">td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
pre { line-height: 125%; }

  </style></head
><BODY TEXT="#cecece" BGCOLOR="#4f6f6f" LINK="#f5deb3" VLINK="#d5ae83"
CLASS="SECT1"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>PLEAC-Guile 1.8</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="fileaccess.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
></TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="directories.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="FILECONTENTS"
>8. File Contents</A
></H1
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN430"
>Introduction</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">;; open the file and loop through the port with read-line:</span>
<span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">p</span> <span class="p">(</span><span class="nb">open-input-file </span><span class="nv">file</span><span class="p">)))</span>
  <span class="p">(</span><span class="k">do </span><span class="p">((</span><span class="nf">line</span> <span class="p">(</span><span class="nf">read-line</span> <span class="nv">p</span><span class="p">)</span> <span class="p">(</span><span class="nf">read-line</span> <span class="nv">p</span><span class="p">)))</span>
      <span class="p">((</span><span class="nb">eof-object? </span><span class="nv">line</span><span class="p">))</span>
    <span class="p">(</span><span class="nf">format</span> <span class="no">#t</span> <span class="s">&quot;~A\n&quot;</span> <span class="p">(</span><span class="nb">string-length </span><span class="nv">line</span><span class="p">)))</span>
  <span class="p">(</span><span class="nf">close</span> <span class="nv">p</span><span class="p">))</span>

<span class="c1">;; you can use with-input-from-file to temporarily rebind stdin:</span>
<span class="p">(</span><span class="nb">with-input-from-file </span><span class="nv">file</span>
  <span class="p">(</span><span class="k">lambda </span><span class="p">()</span>
    <span class="p">(</span><span class="k">do </span><span class="p">((</span><span class="nf">line</span> <span class="p">(</span><span class="nf">read-line</span><span class="p">)</span> <span class="p">(</span><span class="nf">read-line</span><span class="p">)))</span>
        <span class="p">((</span><span class="nb">eof-object? </span><span class="nv">line</span><span class="p">))</span>
      <span class="p">(</span><span class="nf">format</span> <span class="no">#t</span> <span class="s">&quot;~A\n&quot;</span> <span class="p">(</span><span class="nb">string-length </span><span class="nv">line</span><span class="p">)))))</span>

<span class="c1">;; or define a utility procedure to do this</span>
<span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">for-each-line</span> <span class="nv">proc</span> <span class="nv">file</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">with-input-from-file </span><span class="nv">file</span>
    <span class="p">(</span><span class="k">lambda </span><span class="p">()</span>
      <span class="p">(</span><span class="k">do </span><span class="p">((</span><span class="nf">line</span> <span class="p">(</span><span class="nf">read-line</span><span class="p">)</span> <span class="p">(</span><span class="nf">read-line</span><span class="p">)))</span>
          <span class="p">((</span><span class="nb">eof-object? </span><span class="nv">line</span><span class="p">))</span>
        <span class="p">(</span><span class="nf">proc</span> <span class="nv">line</span><span class="p">)))))</span>
<span class="p">(</span><span class="nf">for-each-line</span> <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">x</span><span class="p">)</span> <span class="p">(</span><span class="nf">format</span> <span class="no">#t</span> <span class="s">&quot;~A\n&quot;</span> <span class="p">(</span><span class="nb">string-length </span><span class="nv">line</span><span class="p">)))</span> <span class="nv">file</span><span class="p">)</span>

<span class="c1">;; read in the file as a list of lines</span>
<span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">read-lines</span> <span class="nv">file</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">ls</span> <span class="o">&#39;</span><span class="p">()))</span>
    <span class="p">(</span><span class="nb">with-input-from-file </span><span class="nv">file</span>
      <span class="p">(</span><span class="k">lambda </span><span class="p">()</span>
        <span class="p">(</span><span class="k">do </span><span class="p">((</span><span class="nf">line</span> <span class="p">(</span><span class="nf">read-line</span><span class="p">)</span> <span class="p">(</span><span class="nf">read-line</span><span class="p">)))</span>
            <span class="p">((</span><span class="nb">eof-object? </span><span class="nv">line</span><span class="p">))</span>
          <span class="p">(</span><span class="k">set! </span><span class="nv">ls</span> <span class="p">(</span><span class="nb">cons </span><span class="nv">line</span> <span class="nv">ls</span><span class="p">)))</span>
        <span class="p">(</span><span class="nb">reverse </span><span class="nv">ls</span><span class="p">)))))</span>

<span class="c1">;; read in the file as a single string</span>
<span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">file-contents</span> <span class="nv">file</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">call-with-input-file </span><span class="nv">file</span>
    <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">p</span><span class="p">)</span>
      <span class="p">(</span><span class="k">let* </span><span class="p">((</span><span class="nf">size</span> <span class="p">(</span><span class="nf">stat:size</span> <span class="p">(</span><span class="nf">stat</span> <span class="nv">p</span><span class="p">)))</span>
             <span class="p">(</span><span class="nf">buf</span> <span class="p">(</span><span class="nb">make-string </span><span class="nv">size</span><span class="p">)))</span>
        <span class="p">(</span><span class="nf">read-string!/partial</span> <span class="nv">buf</span> <span class="nv">p</span><span class="p">)</span>
        <span class="nv">buf</span><span class="p">))))</span>

<span class="c1">;; use display to print human readable output</span>
<span class="p">(</span><span class="nb">display </span><span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;One&quot;</span> <span class="s">&quot;two&quot;</span> <span class="s">&quot;three&quot;</span><span class="p">)</span> <span class="nv">port</span><span class="p">)</span>  <span class="c1">; (One two three)</span>
<span class="p">(</span><span class="nb">display </span><span class="s">&quot;Baa baa black sheep.\n&quot;</span><span class="p">)</span>     <span class="c1">; Sent to default output port</span>

<span class="c1">;; use write to print machine readable output</span>
<span class="p">(</span><span class="nb">write </span><span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;One&quot;</span> <span class="s">&quot;two&quot;</span> <span class="s">&quot;three&quot;</span><span class="p">)</span> <span class="nv">port</span><span class="p">)</span>    <span class="c1">; (&quot;One&quot; &quot;two&quot; &quot;three&quot;)</span>

<span class="c1">;; use (ice-9 rw) to read/write fixed-length blocks of data:</span>
<span class="p">(</span><span class="nf">use-modules</span> <span class="p">(</span><span class="nf">ice-9</span> <span class="nv">rw</span><span class="p">))</span>
<span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">buffer</span> <span class="p">(</span><span class="nb">make-string </span><span class="mi">4096</span><span class="p">)))</span>
  <span class="p">(</span><span class="nf">read-string!/partial</span> <span class="nv">buffer</span> <span class="nv">port</span> <span class="mi">4096</span><span class="p">))</span>

<span class="c1">;; truncate-file</span>
<span class="p">(</span><span class="nf">truncate-file</span> <span class="nv">port</span> <span class="nv">length</span><span class="p">)</span>  <span class="c1">; truncate to length</span>
<span class="p">(</span><span class="nf">truncate-file</span> <span class="nv">port</span><span class="p">)</span>         <span class="c1">; truncate to current pos</span>

<span class="c1">;; ftell</span>
<span class="p">(</span><span class="k">define </span><span class="nv">pos</span> <span class="p">(</span><span class="nf">ftell</span> <span class="nv">port</span><span class="p">))</span>
<span class="p">(</span><span class="nf">format</span> <span class="no">#t</span> <span class="s">&quot;I&#39;m ~A bytes from the start of DATAFILE.\n&quot;</span> <span class="nv">pos</span><span class="p">)</span>

<span class="c1">;; seek</span>
<span class="p">(</span><span class="nf">seek</span> <span class="nv">log-port</span> <span class="mi">0</span> <span class="nv">SEEK_END</span><span class="p">)</span>      <span class="c1">; seek to end</span>
<span class="p">(</span><span class="nf">seek</span> <span class="nv">data-port</span> <span class="nv">pos</span> <span class="nv">SEEK_SET</span><span class="p">)</span>   <span class="c1">; seek to pos</span>
<span class="p">(</span><span class="nf">seek</span> <span class="nv">out-port</span> <span class="mi">-20</span> <span class="nv">SEEK_CUR</span><span class="p">)</span>    <span class="c1">; seek back 20 bytes</span>

<span class="c1">;; block read/write</span>
<span class="p">(</span><span class="nf">use-modules</span> <span class="p">(</span><span class="nf">ice-9</span> <span class="nv">rw</span><span class="p">))</span>
<span class="p">(</span><span class="nf">write-string/partial</span> <span class="nv">mystring</span> <span class="nv">data-port</span> <span class="p">(</span><span class="nb">string-length </span><span class="nv">mystring</span><span class="p">))</span>
<span class="p">(</span><span class="nf">read-string!/partial</span> <span class="nv">block</span> <span class="mi">256</span> <span class="mi">5</span><span class="p">)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN433"
>Reading Lines with Continuation Characters</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">rx</span> <span class="p">(</span><span class="nf">make-regexp</span> <span class="s">&quot;(.*)\\\\$&quot;</span><span class="p">)))</span> <span class="c1">; or &quot;(.*)\\\\\\s*$&quot;</span>
  <span class="p">(</span><span class="nb">with-input-from-file </span><span class="nv">file</span>
    <span class="p">(</span><span class="k">lambda </span><span class="p">()</span>
      <span class="p">(</span><span class="k">let </span><span class="nv">loop</span> <span class="p">((</span><span class="nf">line</span> <span class="p">(</span><span class="nf">read-line</span><span class="p">)))</span>
        <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">not </span><span class="p">(</span><span class="nb">eof-object? </span><span class="nv">line</span><span class="p">))</span>
          <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">m</span> <span class="p">(</span><span class="nf">regexp-exec</span> <span class="nv">rx</span> <span class="nv">line</span><span class="p">))</span>
                <span class="p">(</span><span class="nf">next</span> <span class="p">(</span><span class="nf">read-line</span><span class="p">)))</span>
            <span class="p">(</span><span class="k">cond </span><span class="p">((</span><span class="k">and </span><span class="nv">m</span> <span class="p">(</span><span class="nb">not </span><span class="p">(</span><span class="nb">eof-object? </span><span class="nv">next</span><span class="p">)))</span>
                   <span class="p">(</span><span class="nf">loop</span> <span class="p">(</span><span class="nb">string-append </span><span class="p">(</span><span class="nf">match:substring</span> <span class="nv">m</span> <span class="mi">1</span><span class="p">)</span> <span class="nv">next</span><span class="p">)))</span>
                  <span class="p">(</span><span class="nf">else</span>
                   <span class="c1">;; else process line here, then recurse</span>
                   <span class="p">(</span><span class="nf">loop</span> <span class="nv">next</span><span class="p">)))))))))</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN436"
>Counting Lines (or Paragraphs or Records) in a File</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="p">(</span><span class="k">do </span><span class="p">((</span><span class="nf">line</span> <span class="p">(</span><span class="nf">read-line</span> <span class="nv">p</span><span class="p">)</span> <span class="p">(</span><span class="nf">read-line</span> <span class="nv">p</span><span class="p">))</span>
     <span class="p">(</span><span class="nf">i</span> <span class="mi">0</span> <span class="p">(</span><span class="mi">1</span><span class="nv">+</span> <span class="nv">i</span><span class="p">)))</span>
    <span class="p">((</span><span class="nb">eof-object? </span><span class="nv">line</span><span class="p">)</span> <span class="nv">i</span><span class="p">))</span>

<span class="c1">;; fastest way if your terminator is a single newline</span>
<span class="p">(</span><span class="nf">use-modules</span> <span class="p">(</span><span class="nf">ice-9</span> <span class="nv">rw</span><span class="p">)</span> <span class="p">(</span><span class="nf">srfi</span> <span class="nv">srfi-13</span><span class="p">))</span>
<span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">buf</span> <span class="p">(</span><span class="nb">make-string </span><span class="p">(</span><span class="nb">expt </span><span class="mi">2</span> <span class="mi">16</span><span class="p">)))</span>
      <span class="p">(</span><span class="nf">count</span> <span class="mi">0</span><span class="p">))</span>
  <span class="p">(</span><span class="k">do </span><span class="p">((</span><span class="nf">len</span> <span class="p">(</span><span class="nf">read-string!/partial</span> <span class="nv">buf</span> <span class="nv">p</span><span class="p">)</span> <span class="p">(</span><span class="nf">read-string!/partial</span> <span class="nv">buf</span> <span class="nv">p</span><span class="p">)))</span>
      <span class="p">((</span><span class="nb">not </span><span class="nv">len</span><span class="p">)</span> <span class="nv">count</span><span class="p">)</span>
    <span class="p">(</span><span class="k">set! </span><span class="nv">count</span> <span class="p">(</span><span class="nb">+ </span><span class="nv">count</span> <span class="p">(</span><span class="nf">string-count</span> <span class="nv">buf</span> <span class="sc">#\newline</span> <span class="mi">0</span> <span class="nv">len</span><span class="p">)))))</span>

<span class="c1">;; or use port-line</span>
<span class="p">(</span><span class="k">let </span><span class="nv">loop</span> <span class="p">((</span><span class="nf">line</span> <span class="p">(</span><span class="nf">read-line</span> <span class="nv">p</span><span class="p">)))</span>
  <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">eof-object? </span><span class="nv">line</span><span class="p">)</span> <span class="p">(</span><span class="nf">port-line</span> <span class="nv">p</span><span class="p">)</span> <span class="p">(</span><span class="nf">loop</span> <span class="p">(</span><span class="nf">read-line</span> <span class="nv">p</span><span class="p">))))</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN439"
>Processing Every Word in a File</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">;; default behaviour of string-tokenize is to split on whitespace:</span>
<span class="p">(</span><span class="nf">use-modules</span> <span class="p">(</span><span class="nf">srfi</span> <span class="nv">srfi-13</span><span class="p">))</span>
<span class="p">(</span><span class="k">let </span><span class="nv">loop</span> <span class="p">((</span><span class="nf">line</span> <span class="p">(</span><span class="nf">read-line</span> <span class="nv">p</span><span class="p">)))</span>
  <span class="p">(</span><span class="k">cond </span><span class="p">((</span><span class="nb">not </span><span class="nv">eof-object?</span> <span class="nv">line</span><span class="p">)</span>
         <span class="p">(</span><span class="nb">for-each </span><span class="nv">some-function-of-word</span> <span class="p">(</span><span class="nf">string-tokenize</span> <span class="nv">line</span><span class="p">))</span>
         <span class="p">(</span><span class="nf">loop</span> <span class="p">(</span><span class="nf">read-line</span> <span class="nv">p</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">table</span> <span class="p">(</span><span class="nf">make-hash-table</span> <span class="mi">31</span><span class="p">)))</span>
  <span class="p">(</span><span class="k">let </span><span class="nv">loop</span> <span class="p">((</span><span class="nf">line</span> <span class="p">(</span><span class="nf">read-line</span> <span class="nv">p</span><span class="p">)))</span>
    <span class="p">(</span><span class="k">cond </span><span class="p">((</span><span class="nb">not </span><span class="p">(</span><span class="nb">eof-object? </span><span class="nv">line</span><span class="p">))</span>
           <span class="p">(</span><span class="nf">for-each</span>
            <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">w</span><span class="p">)</span> <span class="p">(</span><span class="nf">hash-set!</span> <span class="nv">table</span> <span class="nv">w</span> <span class="p">(</span><span class="mi">1</span><span class="nv">+</span> <span class="p">(</span><span class="nf">hash-ref</span> <span class="nv">table</span> <span class="nv">w</span> <span class="mi">0</span><span class="p">))))</span>
            <span class="p">(</span><span class="nf">string-tokenize</span> <span class="nv">line</span><span class="p">))</span>
           <span class="p">(</span><span class="nf">loop</span> <span class="p">(</span><span class="nf">read-line</span> <span class="nv">p</span><span class="p">)))))</span>
  <span class="p">(</span><span class="nf">hash-fold</span> <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">k</span> <span class="nv">v</span> <span class="nv">p</span><span class="p">)</span> <span class="p">(</span><span class="nf">format</span> <span class="no">#t</span> <span class="s">&quot;~5D ~A\n&quot;</span> <span class="nv">v</span> <span class="nv">k</span><span class="p">))</span> <span class="no">#f</span> <span class="nv">table</span><span class="p">))</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN442"
>Reading a File Backwards by Line or Paragraph</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">;; build up the list the reverse it or fold over it:</span>
<span class="p">(</span><span class="k">define </span><span class="nv">lines</span> <span class="p">(</span><span class="nf">read-lines</span> <span class="nv">file</span><span class="p">))</span>
<span class="p">(</span><span class="nb">for-each </span><span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">word</span><span class="p">)</span> <span class="nv">do-something-with-word</span><span class="p">)</span> <span class="p">(</span><span class="nb">reverse </span><span class="nv">lines</span><span class="p">))</span>
<span class="p">(</span><span class="nf">fold</span> <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">word</span> <span class="nv">acc</span><span class="p">)</span> <span class="nv">do-something-with-word</span><span class="p">)</span> <span class="no">#f</span> <span class="nv">lines</span><span class="p">)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN445"
>Trailing a Growing File</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">;; save the current position and reseek to it</span>
<span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">tail</span> <span class="nv">file</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">call-with-input-file </span><span class="nv">file</span>
    <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">p</span><span class="p">)</span>
      <span class="p">(</span><span class="k">let </span><span class="nv">loop</span> <span class="p">((</span><span class="nf">line</span> <span class="p">(</span><span class="nf">read-line</span> <span class="nv">p</span><span class="p">)))</span>
        <span class="p">(</span><span class="k">cond </span><span class="p">((</span><span class="nb">eof-object? </span><span class="nv">line</span><span class="p">)</span>
               <span class="p">(</span><span class="nf">sleep</span> <span class="nv">sometime</span><span class="p">)</span>
               <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">pos</span> <span class="p">(</span><span class="nf">ftell</span> <span class="nv">p</span><span class="p">)))</span>
                 <span class="p">(</span><span class="nf">seek</span> <span class="nv">p</span> <span class="mi">0</span> <span class="nv">SEEK_SET</span><span class="p">)</span>
                 <span class="p">(</span><span class="nf">seek</span> <span class="nv">p</span> <span class="nv">pos</span> <span class="nv">SEEK_SET</span><span class="p">)))</span>
              <span class="p">(</span><span class="nf">else</span>
               <span class="c1">;; process line</span>
               <span class="p">))</span>
        <span class="p">(</span><span class="nf">loop</span> <span class="p">(</span><span class="nf">read-line</span> <span class="nv">p</span><span class="p">))))))</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN448"
>Picking a Random Line from a File</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">rand-line</span> <span class="no">#f</span><span class="p">))</span>
  <span class="p">(</span><span class="k">let </span><span class="nv">loop</span> <span class="p">((</span><span class="nf">line</span> <span class="p">(</span><span class="nf">read-line</span> <span class="nv">p</span><span class="p">)))</span>
    <span class="p">(</span><span class="k">cond </span><span class="p">((</span><span class="nb">not </span><span class="p">(</span><span class="nb">eof-object? </span><span class="nv">line</span><span class="p">))</span>
           <span class="p">(</span><span class="k">if </span><span class="p">(</span><span class="nb">= </span><span class="mi">0</span> <span class="p">(</span><span class="nf">random</span> <span class="p">(</span><span class="nf">port-line</span> <span class="nv">p</span><span class="p">)))</span>
             <span class="p">(</span><span class="k">set! </span><span class="nv">rand-line</span> <span class="nv">line</span><span class="p">))</span>
           <span class="p">(</span><span class="nf">loop</span> <span class="p">(</span><span class="nf">read-line</span> <span class="nv">p</span><span class="p">)))))</span>
  <span class="c1">;; rand-line is the random line</span>
  <span class="p">)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN451"
>Randomizing All Lines</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="p">(</span><span class="k">define </span><span class="p">(</span><span class="nf">shuffle</span> <span class="nv">list</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">v</span> <span class="p">(</span><span class="nb">list-&gt;vector </span><span class="nv">list</span><span class="p">)))</span>
    <span class="p">(</span><span class="k">do </span><span class="p">((</span><span class="nf">i</span> <span class="p">(</span><span class="mi">1</span><span class="nv">-</span> <span class="p">(</span><span class="nb">vector-length </span><span class="nv">v</span><span class="p">))</span> <span class="p">(</span><span class="mi">1</span><span class="nv">-</span> <span class="nv">i</span><span class="p">)))</span>
        <span class="p">((</span><span class="nb">&lt; </span><span class="nv">i</span> <span class="mi">0</span><span class="p">)</span> <span class="p">(</span><span class="nb">vector-&gt;list </span><span class="nv">v</span><span class="p">))</span>
      <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">j</span> <span class="p">(</span><span class="nf">random</span> <span class="p">(</span><span class="mi">1</span><span class="nv">+</span> <span class="nv">i</span><span class="p">))))</span>
        <span class="p">(</span><span class="k">cond </span><span class="p">((</span><span class="nb">not </span><span class="p">(</span><span class="nb">= </span><span class="nv">i</span> <span class="nv">j</span><span class="p">))</span>
               <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">temp</span> <span class="p">(</span><span class="nb">vector-ref </span><span class="nv">v</span> <span class="nv">i</span><span class="p">)))</span>
                 <span class="p">(</span><span class="nb">vector-set! </span><span class="nv">v</span> <span class="nv">i</span> <span class="p">(</span><span class="nb">vector-ref </span><span class="nv">v</span> <span class="nv">j</span><span class="p">))</span>
                 <span class="p">(</span><span class="nb">vector-set! </span><span class="nv">v</span> <span class="nv">j</span> <span class="nv">temp</span><span class="p">))))))))</span>

<span class="p">(</span><span class="k">define </span><span class="nv">rand-lines</span> <span class="p">(</span><span class="nf">shuffle</span> <span class="p">(</span><span class="nf">read-lines</span> <span class="nv">file</span><span class="p">)))</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN454"
>Reading a Particular Line in a File</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">;; looking for line number desired-line-number</span>
<span class="p">(</span><span class="k">do </span><span class="p">((</span><span class="nf">line</span> <span class="p">(</span><span class="nf">read-line</span> <span class="nv">p</span><span class="p">)</span> <span class="p">(</span><span class="nf">read-line</span> <span class="nv">p</span><span class="p">)))</span>
    <span class="p">((</span><span class="nb">= </span><span class="p">((</span><span class="nf">port-line</span> <span class="nv">p</span><span class="p">)</span> <span class="nv">desired-line-number</span><span class="p">)</span> <span class="nv">line</span><span class="p">)))</span>
<span class="c1">;; or read into a list</span>
<span class="p">(</span><span class="k">define </span><span class="nv">lines</span> <span class="p">(</span><span class="nf">read-lines</span> <span class="nv">file</span><span class="p">))</span>
<span class="p">(</span><span class="nb">list-ref </span><span class="nv">lines</span> <span class="nv">desired-line-number</span><span class="p">)</span>

<span class="c1">;; @@INCOMPLETE@@</span>
<span class="c1">; (define (build-index data-file index-file)</span>
<span class="c1">;   )</span>

<span class="c1">; (define (line-with-index data-file index-file line-number)</span>
<span class="c1">;   )</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN457"
>Processing Variable-Length Text Fields</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">;; use string-tokenize with an appropriate character set</span>
<span class="p">(</span><span class="nf">use-modules</span> <span class="p">(</span><span class="nf">srfi</span> <span class="nv">srfi-13</span><span class="p">)</span> <span class="p">(</span><span class="nf">srfi</span> <span class="nv">srfi-14</span><span class="p">))</span>
<span class="p">(</span><span class="k">define </span><span class="nv">fields</span> <span class="p">(</span><span class="nf">string-tokenize</span> <span class="nv">line</span> <span class="p">(</span><span class="nf">string-&gt;charset</span> <span class="s">&quot;+-&quot;</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define </span><span class="nv">fields</span> <span class="p">(</span><span class="nf">string-tokenize</span> <span class="nv">line</span> <span class="p">(</span><span class="nf">string-&gt;charset</span> <span class="s">&quot;:&quot;</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define </span><span class="nv">fields</span> <span class="p">(</span><span class="nf">string-tokenize</span> <span class="nv">line</span><span class="p">))</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN460"
>Removing the Last Line of a File</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">p</span> <span class="p">(</span><span class="nf">open-file</span> <span class="nv">file</span> <span class="s">&quot;r+&quot;</span><span class="p">)))</span>
  <span class="p">(</span><span class="k">let </span><span class="p">((</span><span class="nf">pos</span> <span class="mi">0</span><span class="p">))</span>
    <span class="p">(</span><span class="k">let </span><span class="nv">loop</span> <span class="p">((</span><span class="nf">line</span> <span class="p">(</span><span class="nf">read-line</span> <span class="nv">p</span><span class="p">)))</span>
      <span class="p">(</span><span class="k">cond </span><span class="p">((</span><span class="nb">eof-object? </span><span class="p">(</span><span class="nb">peek-char </span><span class="nv">p</span><span class="p">))</span>
             <span class="p">(</span><span class="nf">seek</span> <span class="nv">p</span> <span class="mi">0</span> <span class="nv">SEEK_SET</span><span class="p">)</span>
             <span class="p">(</span><span class="nf">truncate-file</span> <span class="nv">p</span> <span class="nv">pos</span><span class="p">)</span>
             <span class="p">(</span><span class="nf">close</span> <span class="nv">p</span><span class="p">))</span>
            <span class="p">(</span><span class="nf">else</span>
             <span class="p">(</span><span class="k">set! </span><span class="nv">pos</span> <span class="p">(</span><span class="nf">ftell</span> <span class="nv">p</span><span class="p">))</span>
             <span class="p">(</span><span class="nf">loop</span> <span class="p">(</span><span class="nf">read-line</span> <span class="nv">p</span><span class="p">)))))))</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN463"
>Processing Binary Files</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">;; no equivalent - don&#39;t know how Guile under windows handles this</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN466"
>Using Random-Access I/O</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="p">(</span><span class="k">let* </span><span class="p">((</span><span class="nf">address</span> <span class="p">(</span><span class="nb">* </span><span class="nv">recsize</span> <span class="nv">recno</span><span class="p">))</span>
       <span class="p">(</span><span class="nf">buf</span> <span class="p">(</span><span class="nb">make-string </span><span class="nv">recsize</span><span class="p">)))</span>
  <span class="p">(</span><span class="nf">seek</span> <span class="nv">p</span> <span class="nv">address</span> <span class="nv">SEEK_SET</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">read-string!/partial</span> <span class="nv">buf</span> <span class="nv">p</span><span class="p">)</span>
  <span class="nv">buf</span><span class="p">)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN469"
>Updating a Random-Access File</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="p">(</span><span class="k">let* </span><span class="p">((</span><span class="nf">address</span> <span class="p">(</span><span class="nb">* </span><span class="nv">recsize</span> <span class="nv">recno</span><span class="p">))</span>
       <span class="p">(</span><span class="nf">buf</span> <span class="p">(</span><span class="nb">make-string </span><span class="nv">recsize</span><span class="p">)))</span>
  <span class="p">(</span><span class="nf">seek</span> <span class="nv">p</span> <span class="nv">address</span> <span class="nv">SEEK_SET</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">read-string!/partial</span> <span class="nv">buf</span> <span class="nv">p</span><span class="p">)</span>
  <span class="c1">;; modify buf, then write back with</span>
  <span class="p">(</span><span class="nf">seek</span> <span class="nv">p</span> <span class="nv">address</span> <span class="nv">SEEK_SET</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">write-string/partial</span> <span class="nv">buf</span> <span class="nv">p</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">close</span> <span class="nv">p</span><span class="p">))</span>

<span class="c1">;; @@INCOMPLETE@@</span>
<span class="c1">;; weekearly</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN472"
>Reading a String from a Binary File</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="p">(</span><span class="nf">seek</span> <span class="nv">p</span> <span class="nv">addr</span> <span class="nv">SEEK_SET</span><span class="p">)</span>
<span class="p">(</span><span class="k">define </span><span class="nv">str</span> <span class="p">(</span><span class="nf">read-delimited</span> <span class="p">(</span><span class="nb">make-string </span><span class="mi">1</span> <span class="sc">#\nul</span><span class="p">)</span> <span class="nv">p</span><span class="p">))</span>

<span class="o">#</span><span class="nv">!/usr/local/bin/guile</span> <span class="nv">-s</span>
<span class="nv">!</span><span class="o">#</span>
<span class="c1">;; bgets -- get a string from an address in a binary file</span>
<span class="p">(</span><span class="nf">use-modules</span> <span class="p">(</span><span class="nf">ice-9</span> <span class="nv">format</span><span class="p">))</span>

<span class="p">(</span><span class="k">define </span><span class="nv">args</span> <span class="p">(</span><span class="nb">cdr </span><span class="p">(</span><span class="nf">command-line</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define </span><span class="nv">file</span> <span class="p">(</span><span class="nb">car </span><span class="nv">args</span><span class="p">))</span>
<span class="p">(</span><span class="k">define </span><span class="nv">addrs</span> <span class="p">(</span><span class="nb">map </span><span class="nv">string-&gt;number</span> <span class="p">(</span><span class="nb">cdr </span><span class="nv">args</span><span class="p">)))</span>
<span class="p">(</span><span class="k">define </span><span class="nv">delims</span> <span class="p">(</span><span class="nb">make-string </span><span class="mi">1</span> <span class="sc">#\nul</span><span class="p">))</span>

<span class="p">(</span><span class="nb">call-with-input-file </span><span class="nv">file</span>
  <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">p</span><span class="p">)</span>
    <span class="p">(</span><span class="nf">for-each</span>
     <span class="p">(</span><span class="k">lambda </span><span class="p">(</span><span class="nf">addr</span><span class="p">)</span>
       <span class="p">(</span><span class="nf">seek</span> <span class="nv">p</span> <span class="nv">addr</span> <span class="nv">SEEK_SET</span><span class="p">)</span>
       <span class="p">(</span><span class="nf">format</span> <span class="no">#t</span> <span class="s">&quot;~X ~O ~D ~S\n&quot;</span> <span class="nv">addr</span> <span class="nv">addr</span> <span class="nv">addr</span>
               <span class="p">(</span><span class="nf">read-delimited</span> <span class="nv">delims</span> <span class="nv">p</span><span class="p">)))</span>
     <span class="nv">addrs</span><span class="p">)))</span>

<span class="c1">;; @@INCOMPLETE@@</span>
<span class="c1">;; strings</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN475"
>Reading Fixed-Length Records</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN478"
>Reading Configuration Files</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN481"
>Testing a File for Trustworthiness</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN484"
>Program: tailwtmp</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN487"
>Program: tctee</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN490"
>Program: laston</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
></PRE
></TD
></TR
></TABLE
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="fileaccess.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="directories.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>File Access</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
>&nbsp;</TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Directories</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>
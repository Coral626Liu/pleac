<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">

<html>
<head>
  <title></title>
  <meta http-equiv="content-type" content="text/html; charset=latin1">
  <style type="text/css">
td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
pre { line-height: 125%; }
body .hll { background-color: #ffffcc }
body  { background: #f8f8f8; }
body .c { color: #408080; font-style: italic } /* Comment */
body .err { border: 1px solid #FF0000 } /* Error */
body .k { color: #008000; font-weight: bold } /* Keyword */
body .o { color: #666666 } /* Operator */
body .cm { color: #408080; font-style: italic } /* Comment.Multiline */
body .cp { color: #BC7A00 } /* Comment.Preproc */
body .c1 { color: #408080; font-style: italic } /* Comment.Single */
body .cs { color: #408080; font-style: italic } /* Comment.Special */
body .gd { color: #A00000 } /* Generic.Deleted */
body .ge { font-style: italic } /* Generic.Emph */
body .gr { color: #FF0000 } /* Generic.Error */
body .gh { color: #000080; font-weight: bold } /* Generic.Heading */
body .gi { color: #00A000 } /* Generic.Inserted */
body .go { color: #888888 } /* Generic.Output */
body .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
body .gs { font-weight: bold } /* Generic.Strong */
body .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
body .gt { color: #0044DD } /* Generic.Traceback */
body .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
body .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
body .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
body .kp { color: #008000 } /* Keyword.Pseudo */
body .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
body .kt { color: #B00040 } /* Keyword.Type */
body .m { color: #666666 } /* Literal.Number */
body .s { color: #BA2121 } /* Literal.String */
body .na { color: #7D9029 } /* Name.Attribute */
body .nb { color: #008000 } /* Name.Builtin */
body .nc { color: #0000FF; font-weight: bold } /* Name.Class */
body .no { color: #880000 } /* Name.Constant */
body .nd { color: #AA22FF } /* Name.Decorator */
body .ni { color: #999999; font-weight: bold } /* Name.Entity */
body .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
body .nf { color: #0000FF } /* Name.Function */
body .nl { color: #A0A000 } /* Name.Label */
body .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
body .nt { color: #008000; font-weight: bold } /* Name.Tag */
body .nv { color: #19177C } /* Name.Variable */
body .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
body .w { color: #bbbbbb } /* Text.Whitespace */
body .mf { color: #666666 } /* Literal.Number.Float */
body .mh { color: #666666 } /* Literal.Number.Hex */
body .mi { color: #666666 } /* Literal.Number.Integer */
body .mo { color: #666666 } /* Literal.Number.Oct */
body .sb { color: #BA2121 } /* Literal.String.Backtick */
body .sc { color: #BA2121 } /* Literal.String.Char */
body .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
body .s2 { color: #BA2121 } /* Literal.String.Double */
body .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
body .sh { color: #BA2121 } /* Literal.String.Heredoc */
body .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
body .sx { color: #008000 } /* Literal.String.Other */
body .sr { color: #BB6688 } /* Literal.String.Regex */
body .s1 { color: #BA2121 } /* Literal.String.Single */
body .ss { color: #19177C } /* Literal.String.Symbol */
body .bp { color: #008000 } /* Name.Builtin.Pseudo */
body .vc { color: #19177C } /* Name.Variable.Class */
body .vg { color: #19177C } /* Name.Variable.Global */
body .vi { color: #19177C } /* Name.Variable.Instance */
body .il { color: #666666 } /* Literal.Number.Integer.Long */

  </style>
</head>
<body>
<h2></h2>

<div class="highlight"><pre><span class="c1">;;;; -*- common-lisp -*-</span>

<span class="c1">;;;; @@PLEAC@@_NAME</span>
<span class="c1">;;;; @@SKIP@@ Common Lisp</span>

<span class="c1">;;;; @@PLEAC@@_WEB</span>
<span class="c1">;;;; @@SKIP@@ http://www.lisp.org/</span>

<span class="c1">;;;; @@PLEAC@@_INTRO</span>
<span class="c1">;;;; @@SKIP@@ Various submissions rely on third party http://cliki.net/ASDF packages (e.g. cl-ppcre,</span>
<span class="c1">;;;; @@SKIP@@ soundex, etc) and specific helper utility functions (WHEN-LET, CHOMP, etc). Used ASDF</span>
<span class="c1">;;;; @@SKIP@@ packages are assumed to be installable via http://cliki.net/ASDF-INSTALL and helper</span>
<span class="c1">;;;; @@SKIP@@ utilities are available in the appendix.</span>
<span class="c1">;;;; @@SKIP@@ Most of the demonstrated solutions are free from low-level Common Lisp optimizations</span>
<span class="c1">;;;; @@SKIP@@ (no type declarations, missing tail-call-optimizations, etc) for the sake of simplicity.</span>
<span class="c1">;;;; @@SKIP@@ While this doesn&#39;t mean such programs would perform poorly, in certain situations</span>
<span class="c1">;;;; @@SKIP@@ particular optimizations might be necessary.</span>
<span class="c1">;;;; @@SKIP@@ It should  also be noted that,  most of the scripts are given in plain function form.</span>
<span class="c1">;;;; @@SKIP@@ For how to execute these functions using a script file, please consult to your</span>
<span class="c1">;;;; @@SKIP@@ implementation&#39;s http://en.wikipedia.org/wiki/Shebang_(Unix) documentation.</span>
<span class="c1">;;;; @@SKIP@@ (You may also be interested in trivial-shell ASDF package for a lightweight shell</span>
<span class="c1">;;;; @@SKIP@@  interaction layer.)</span>

<span class="c1">;;;; @@PLEAC@@_APPENDIX</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">chomp</span> <span class="p">(</span><span class="nb">string</span><span class="p">)</span>
  <span class="s">&quot;Similar  to Perl&#39;s chomp(),  although it  returns the  new value  of `STRING&#39;</span>
<span class="s">rather than the number of characters removed, and doesn&#39;t modify its argument.&quot;</span>
  <span class="p">(</span><span class="nb">string-right-trim</span> <span class="o">#(</span><span class="sc">#\Newline</span> <span class="sc">#\Return</span><span class="p">)</span> <span class="nb">string</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defmacro</span> <span class="nv">when-let</span> <span class="p">((</span><span class="nv">var</span> <span class="nv">value</span><span class="p">)</span> <span class="k">&amp;body</span> <span class="nv">body</span><span class="p">)</span>
  <span class="s">&quot;Evaluate  `VALUE&#39;, and  bind  it to  `VAR&#39;.  When `VALUE&#39;  evaluates to  some</span>
<span class="s">non-NIL value, evaluate `BODY&#39; in the same binding scope.&quot;</span>
  <span class="o">`</span><span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="o">,</span><span class="nv">var</span> <span class="o">,</span><span class="nv">value</span><span class="p">))</span> <span class="p">(</span><span class="nb">when</span> <span class="o">,</span><span class="nv">var</span> <span class="o">,@</span><span class="nv">body</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defmacro</span> <span class="nv">perl-grep</span> <span class="p">(</span><span class="nc">sequence</span> <span class="k">&amp;body</span> <span class="nv">predicate-body</span><span class="p">)</span>
  <span class="s">&quot;Like Perl&#39;s grep.  Predicate is a body  of code that can refer to `IT&#39; as the</span>
<span class="s">current element of the list.&quot;</span>
  <span class="o">`</span><span class="p">(</span><span class="nb">remove-if-not</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">it</span><span class="p">)</span> <span class="o">,@</span><span class="nv">predicate-body</span><span class="p">)</span> <span class="o">,</span><span class="nc">sequence</span><span class="p">))</span>

<span class="c1">;; The following could be made more efficient by using a faster TEST</span>
<span class="c1">;; function if the keys appear to be simpler.</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">mkhash</span> <span class="p">(</span><span class="k">&amp;rest</span> <span class="nv">keys/values</span><span class="p">)</span>
  <span class="s">&quot;Utility for making new EQUAL hashes easily, similar to Perl&#39;s</span>
<span class="s">built-in funcionality.&quot;</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">newhash</span> <span class="p">(</span><span class="nb">make-hash-table</span> <span class="ss">:test</span> <span class="ss">&#39;equal</span> <span class="c1">; use EQUAL so strings work as keys</span>
                                  <span class="ss">:size</span> <span class="p">(</span><span class="nb">truncate</span> <span class="p">(</span><span class="nb">/</span> <span class="p">(</span><span class="nb">length</span> <span class="nv">keys/values</span><span class="p">)</span>
                                                     <span class="mi">2</span><span class="p">)))))</span>
    <span class="p">(</span><span class="nb">loop</span>
       <span class="nv">for</span> <span class="nv">key</span> <span class="nv">in</span> <span class="nv">keys/values</span> <span class="nv">by</span> <span class="nf">#&#39;</span><span class="nb">cddr</span>
       <span class="nv">for</span> <span class="nv">value</span> <span class="nv">in</span> <span class="p">(</span><span class="nb">cdr</span> <span class="nv">keys/values</span><span class="p">)</span> <span class="nv">by</span> <span class="nf">#&#39;</span><span class="nb">cddr</span>
       <span class="nb">do</span> <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">key</span> <span class="nv">newhash</span><span class="p">)</span> <span class="nv">value</span><span class="p">))</span>
    <span class="nv">newhash</span><span class="p">))</span>

<span class="c1">;; Section 12.1 has an example usage of this, including how</span>
<span class="c1">;; *EXPORT-TAGS* should be formatted.</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">import-tags</span> <span class="p">(</span><span class="nv">package-designator</span> <span class="k">&amp;rest</span> <span class="nv">tags</span><span class="p">)</span>
  <span class="s">&quot;Helps emulate Perl&#39;s EXPORT_TAGS functionality, which has no</span>
<span class="s">equivalent in standard CL.&quot;</span>
  <span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="nv">current-package</span> <span class="vg">*package*</span><span class="p">)</span>
         <span class="p">(</span><span class="vg">*package*</span> <span class="p">(</span><span class="nb">find-package</span> <span class="nv">package-designator</span><span class="p">))</span>
         <span class="c1">;; Otherwise we&#39;ll find the *export-tags* from the &quot;calling&quot;</span>
         <span class="c1">;; package.</span>
         <span class="p">(</span><span class="nv">export-tags</span> <span class="p">(</span><span class="nb">symbol-value</span> <span class="p">(</span><span class="nb">find-symbol</span> <span class="s">&quot;*EXPORT-TAGS*&quot;</span> <span class="vg">*package*</span><span class="p">))))</span>
    <span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">tag</span> <span class="nv">tags</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">import</span> <span class="p">(</span><span class="nb">cadr</span> <span class="p">(</span><span class="nb">assoc</span> <span class="nv">tag</span> <span class="nv">export-tags</span><span class="p">))</span>
              <span class="nv">current-package</span><span class="p">))))</span>

<span class="c1">;; Like Perl&#39;s keys function.</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">hash-keys</span> <span class="p">(</span><span class="nv">hash</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">k</span> <span class="nv">being</span> <span class="k">the</span> <span class="nv">hash-keys</span> <span class="nv">of</span> <span class="nv">hash</span> <span class="nv">collect</span> <span class="nv">k</span><span class="p">))</span>

<span class="c1">;;;; @@SKIP@@ Common Lisp code makes use of the following for</span>
<span class="c1">;;;; @@SKIP@@ package/loading:</span>
<span class="c1">;;;; @@SKIP@@  (require :PACKAGENAME)</span>

<span class="c1">;;;; @@SKIP@@ SBCL code makes use of the following for package /</span>
<span class="c1">;;;; @@SKIP@@ library loading:</span>
<span class="c1">;;;; @@SKIP@@  (asdf:operate &#39;asdf:load-op :date-calc) ; load the package</span>
<span class="c1">;;;; @@SKIP@@  (use-package &#39;date-calc)                ; import the symbols</span>
<span class="c1">;;;; @@SKIP@@  (load &quot;time.lisp&quot;)              ; replace with your location of the pdl library</span>
<span class="c1">;;;; @@SKIP@@  (use-package &#39;CyberTiggyr-Time) ; for printing times in various formats</span>

<span class="c1">;;;; @@SKIP@@ Packages / libraries used include:</span>
<span class="c1">;;;; @@SKIP@@  http://cybertiggyr.com/gene/pdl/</span>
<span class="c1">;;;; @@SKIP@@  http://www.cliki.net/asdf</span>
<span class="c1">;;;; @@SKIP@@  http://www.cliki.net/cl-interpol</span>
<span class="c1">;;;; @@SKIP@@  http://www.cliki.net/cl-ppcre</span>
<span class="c1">;;;; @@SKIP@@  http://www.cliki.net/date-calc</span>
<span class="c1">;;;; @@SKIP@@  http://www.cliki.net/iterate</span>

<span class="c1">;;; @@PLEAC@@_1.0</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nb">string</span> <span class="s">&quot;\\n&quot;</span><span class="p">)</span>                     <span class="c1">; two characters, \ and an n</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nb">string</span> <span class="s">&quot;John &#39;Maddog&#39; Orwant&quot;</span><span class="p">)</span>    <span class="c1">; literal single quotes</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; newlines may be inserted literally</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nb">string</span> <span class="s">&quot;</span>
<span class="s">&quot;</span><span class="p">)</span>                                      <span class="c1">; a &quot;newline&quot; character</span>
<span class="c1">;; or by creating a string explicitly</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nb">string</span> <span class="p">(</span><span class="nb">make-string</span> <span class="mi">1</span> <span class="ss">:initial-element</span> <span class="sc">#\Newline</span><span class="p">))</span>
<span class="c1">;; or by using format with a nil output stream</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nb">string</span> <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;~%&quot;</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nb">string</span> <span class="s">&quot;John \&quot;Maddog\&quot; Orwant&quot;</span><span class="p">)</span>  <span class="c1">; literal double quotes</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nb">string</span> <span class="s">&quot;John &#39;Maddog&#39; Orwant&quot;</span><span class="p">)</span>  <span class="c1">; literal single quotes</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nb">string</span> <span class="s">&quot;</span>
<span class="s">This is a multiline string, terminated by a</span>
<span class="s">double quotation mark.</span>
<span class="s">&quot;</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; There are no CL equivalents to Perl&#39;s other ways of quoting</span>
<span class="c1">;; strings (q//, etc).</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_1.1</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; assign a substring to a variable</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">value</span> <span class="p">(</span><span class="nb">subseq</span> <span class="nb">string</span> <span class="nv">offset</span> <span class="p">(</span><span class="nb">+</span> <span class="nv">offset</span> <span class="nb">count</span><span class="p">)))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">value</span> <span class="p">(</span><span class="nb">subseq</span> <span class="nb">string</span> <span class="nv">offset</span><span class="p">))</span>

<span class="c1">;; edit a substring</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nb">string</span> <span class="p">(</span><span class="nb">concatenate</span> <span class="ss">&#39;string</span>
                          <span class="p">(</span><span class="nb">subseq</span> <span class="nb">string</span> <span class="mi">0</span> <span class="nv">offset</span><span class="p">)</span>
                          <span class="nv">newstring</span>
                          <span class="p">(</span><span class="nb">subseq</span> <span class="nb">string</span> <span class="p">(</span><span class="nb">+</span> <span class="nv">offset</span> <span class="nb">count</span><span class="p">))))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nb">string</span> <span class="p">(</span><span class="nb">concatenate</span> <span class="ss">&#39;string</span>
                          <span class="p">(</span><span class="nb">subseq</span> <span class="nb">string</span> <span class="mi">0</span> <span class="nv">offset</span><span class="p">)</span>
                          <span class="nv">newtail</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; get a 5-byte string, skip 3, then grab 2 8-byte strings, then the</span>
<span class="c1">;; rest</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">leading</span> <span class="p">(</span><span class="nb">subseq</span> <span class="nv">data</span> <span class="mi">5</span><span class="p">)</span>
      <span class="nv">s1</span> <span class="p">(</span><span class="nb">subseq</span> <span class="nv">data</span> <span class="mi">8</span> <span class="mi">8</span><span class="p">)</span>
      <span class="nv">s2</span> <span class="p">(</span><span class="nb">subseq</span> <span class="nv">data</span> <span class="mi">16</span> <span class="mi">8</span><span class="p">)</span>
      <span class="nv">trailing</span> <span class="p">(</span><span class="nb">subseq</span> <span class="nv">data</span> <span class="mi">24</span><span class="p">))</span>

<span class="c1">;; split at five byte boundries</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nb">length</span> <span class="p">(</span><span class="nb">length</span> <span class="nb">string</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">idx</span> <span class="nv">from</span> <span class="mi">0</span> <span class="nv">upto</span> <span class="nb">length</span> <span class="nv">by</span> <span class="mi">5</span>
     <span class="nv">collect</span> <span class="p">(</span><span class="nb">subseq</span> <span class="nb">string</span> <span class="nv">idx</span> <span class="p">(</span><span class="nb">min</span> <span class="nb">length</span> <span class="p">(</span><span class="nb">+</span> <span class="nv">idx</span> <span class="mi">5</span><span class="p">)))))</span>

<span class="c1">;; chop string into individual characters</span>
<span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">idx</span> <span class="nv">from</span> <span class="mi">0</span> <span class="nv">upto</span> <span class="p">(</span><span class="nb">1-</span> <span class="p">(</span><span class="nb">length</span> <span class="nb">string</span><span class="p">))</span>
      <span class="nv">collect</span> <span class="p">(</span><span class="nb">char</span> <span class="nb">string</span> <span class="nv">idx</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*string*</span> <span class="s">&quot;This is what you have&quot;</span><span class="p">)</span>
<span class="c1">;;;             +012345678901234567890  Indexing forwards  (left to right)</span>
<span class="c1">;;;              109876543210987654321- Indexing backwards (right to left)</span>

<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nb">first</span> <span class="p">(</span><span class="nb">subseq</span> <span class="vg">*string*</span> <span class="mi">0</span> <span class="mi">1</span><span class="p">))</span>                        <span class="c1">; &quot;T&quot;</span>
      <span class="p">(</span><span class="nv">start</span> <span class="p">(</span><span class="nb">subseq</span> <span class="vg">*string*</span> <span class="mi">5</span> <span class="mi">7</span><span class="p">))</span>                        <span class="c1">; &quot;is&quot;</span>
      <span class="p">(</span><span class="nb">rest</span> <span class="p">(</span><span class="nb">subseq</span> <span class="vg">*string*</span> <span class="mi">13</span><span class="p">))</span>                       <span class="c1">; &quot;you have&quot;</span>
      <span class="p">(</span><span class="nb">last</span> <span class="p">(</span><span class="nb">subseq</span> <span class="vg">*string*</span> <span class="p">(</span><span class="nb">+</span> <span class="p">(</span><span class="nb">length</span> <span class="vg">*string*</span><span class="p">)</span> <span class="mi">-1</span><span class="p">)))</span> <span class="c1">; &quot;e&quot;</span>
      <span class="p">(</span><span class="nv">end</span> <span class="p">(</span><span class="nb">subseq</span> <span class="vg">*string*</span> <span class="p">(</span><span class="nb">+</span> <span class="p">(</span><span class="nb">length</span> <span class="vg">*string*</span><span class="p">)</span> <span class="mi">-4</span><span class="p">)))</span>   <span class="c1">; &quot;have&quot;</span>
      <span class="p">(</span><span class="nv">piece</span> <span class="p">(</span><span class="nb">subseq</span> <span class="vg">*string*</span>
                     <span class="p">(</span><span class="nb">+</span> <span class="p">(</span><span class="nb">length</span> <span class="vg">*string*</span><span class="p">)</span> <span class="mi">-8</span><span class="p">)</span>
                     <span class="p">(</span><span class="nb">+</span> <span class="p">(</span><span class="nb">length</span> <span class="vg">*string*</span><span class="p">)</span> <span class="mi">-8</span> <span class="mi">3</span><span class="p">))))</span> <span class="c1">; &quot;you&quot;</span>
  <span class="p">(</span><span class="nb">list</span> <span class="nb">first</span> <span class="nv">start</span> <span class="nb">rest</span> <span class="nb">last</span> <span class="nv">end</span> <span class="nv">piece</span><span class="p">))</span>
<span class="c1">;; (&quot;T&quot; &quot;is&quot; &quot;you have&quot; &quot;e&quot; &quot;have&quot; &quot;you&quot;)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*string*</span> <span class="s">&quot;This is what you have&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nb">print</span> <span class="vg">*string*</span><span class="p">)</span>
<span class="c1">;; This is what you have</span>

<span class="c1">;; Change &quot;is&quot; to &quot;wasn&#39;t&quot;</span>
<span class="p">(</span><span class="nb">setf</span> <span class="vg">*string*</span> <span class="p">(</span><span class="nb">concatenate</span> <span class="ss">&#39;string</span>
                            <span class="p">(</span><span class="nb">subseq</span> <span class="vg">*string*</span> <span class="mi">0</span> <span class="mi">5</span><span class="p">)</span>
                            <span class="s">&quot;wasn&#39;t&quot;</span>
                            <span class="p">(</span><span class="nb">subseq</span> <span class="vg">*string*</span> <span class="p">(</span><span class="nb">+</span> <span class="mi">5</span> <span class="mi">2</span><span class="p">))))</span>
<span class="c1">;; This wasn&#39;t what you have</span>

<span class="c1">;; Replace last 12 characters</span>
<span class="p">(</span><span class="nb">setf</span> <span class="vg">*string*</span> <span class="p">(</span><span class="nb">concatenate</span> <span class="ss">&#39;string</span>
                            <span class="p">(</span><span class="nb">subseq</span> <span class="vg">*string*</span> <span class="mi">0</span> <span class="p">(</span><span class="nb">+</span> <span class="p">(</span><span class="nb">length</span> <span class="vg">*string*</span><span class="p">)</span> <span class="mi">-12</span><span class="p">))</span>
                            <span class="s">&quot;ondrous&quot;</span><span class="p">))</span>
<span class="c1">;; This wasn&#39;t wondrous</span>

<span class="c1">;; Delete first character</span>
<span class="p">(</span><span class="nb">setf</span> <span class="vg">*string*</span> <span class="p">(</span><span class="nb">subseq</span> <span class="vg">*string*</span> <span class="mi">1</span><span class="p">))</span>
<span class="c1">;; his wasn&#39;t wondrous</span>

<span class="c1">;; Delete last 10 characters</span>
<span class="p">(</span><span class="nb">setf</span> <span class="vg">*string*</span> <span class="p">(</span><span class="nb">subseq</span> <span class="vg">*string*</span> <span class="mi">0</span> <span class="p">(</span><span class="nb">+</span> <span class="p">(</span><span class="nb">length</span> <span class="vg">*string*</span><span class="p">)</span> <span class="mi">-10</span><span class="p">)))</span>
<span class="c1">;; his wasn&#39;</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; you can test substrings with the :start and :end keyword parameters</span>
<span class="c1">;; of CL-PPCRE:SCAN</span>
<span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nv">scan</span> <span class="s">&quot;pattern&quot;</span> <span class="vg">*string*</span> <span class="ss">:start</span> <span class="p">(</span><span class="nb">-</span> <span class="p">(</span><span class="nb">length</span> <span class="vg">*string*</span><span class="p">)</span> <span class="mi">10</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;Pattern matches in last 10 characters~%&quot;</span><span class="p">))</span>

<span class="c1">;; substitute &quot;at&quot; for &quot;is&quot;, restricted to first five characters</span>
<span class="p">(</span><span class="nb">concatenate</span> <span class="ss">&#39;string</span>
              <span class="p">(</span><span class="nv">regex-replace</span> <span class="s">&quot;is&quot;</span> <span class="vg">*string*</span> <span class="s">&quot;at&quot;</span>
                             <span class="ss">:start</span> <span class="mi">0</span>
                             <span class="ss">:end</span> <span class="p">(</span><span class="nb">min</span> <span class="p">(</span><span class="nb">length</span> <span class="vg">*string*</span><span class="p">)</span> <span class="mi">5</span><span class="p">))</span>
              <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">length</span> <span class="vg">*string*</span><span class="p">)</span> <span class="mi">5</span><span class="p">)</span>
                <span class="p">(</span><span class="nb">subseq</span> <span class="vg">*string*</span> <span class="mi">5</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; exchange the first and last letters in a string</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">a</span> <span class="s">&quot;make a hat&quot;</span><span class="p">))</span>
  <span class="c1">;; ROTATEF is CL&#39;s general-purpose swap macro</span>
  <span class="p">(</span><span class="nb">rotatef</span> <span class="p">(</span><span class="nb">char</span> <span class="nv">a</span> <span class="mi">0</span><span class="p">)</span> <span class="p">(</span><span class="nb">char</span> <span class="nv">a</span> <span class="p">(</span><span class="nb">1-</span> <span class="p">(</span><span class="nb">length</span> <span class="nv">a</span><span class="p">))))</span>
  <span class="p">(</span><span class="nb">princ</span> <span class="nv">a</span><span class="p">))</span>
<span class="c1">;; take a ham</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; extract column with SUBSEQ</span>
<span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="nv">a</span> <span class="s">&quot;To be or not to be&quot;</span><span class="p">)</span>
       <span class="p">(</span><span class="nv">b</span> <span class="p">(</span><span class="nb">subseq</span> <span class="nv">a</span> <span class="mi">6</span> <span class="mi">12</span><span class="p">)))</span> <span class="c1">; skip 6, grab 6</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A~%&quot;</span> <span class="nv">b</span><span class="p">)</span>
<span class="c1">;; or not</span>

  <span class="c1">;; forward 6, grab 2; backward 5, grab 2</span>
  <span class="p">(</span><span class="nb">destructuring-bind</span> <span class="p">(</span><span class="nv">b</span> <span class="nv">c</span><span class="p">)</span> <span class="o">`</span><span class="p">(</span><span class="o">,</span><span class="p">(</span><span class="nb">subseq</span> <span class="nv">a</span> <span class="mi">6</span> <span class="mi">8</span><span class="p">)</span> <span class="o">,</span><span class="p">(</span><span class="nb">subseq</span> <span class="nv">a</span> <span class="mi">3</span> <span class="mi">5</span><span class="p">))</span>
    <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A~%~A~%&quot;</span> <span class="nv">b</span> <span class="nv">c</span><span class="p">)))</span>
<span class="c1">;; or</span>
<span class="c1">;; be</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">cut2fmt</span> <span class="p">(</span><span class="k">&amp;rest</span> <span class="nv">positions</span><span class="p">)</span>
  <span class="s">&quot;Useless in CL, which lacks Perl&#39;s unpack(); here for completeness.&quot;</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">template</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="p">(</span><span class="nv">lastpos</span> <span class="mi">1</span><span class="p">))</span>
    <span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">place</span> <span class="nv">positions</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">setf</span> <span class="nv">template</span> <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;~AA~D &quot;</span> <span class="nv">template</span> <span class="p">(</span><span class="nb">-</span> <span class="nv">place</span> <span class="nv">lastpos</span><span class="p">)))</span>
      <span class="p">(</span><span class="nb">setf</span> <span class="nv">lastpos</span> <span class="nv">place</span><span class="p">))</span>
    <span class="p">(</span><span class="nb">setf</span> <span class="nv">template</span> <span class="p">(</span><span class="nb">concatenate</span> <span class="ss">&#39;string</span> <span class="nv">template</span> <span class="s">&quot;A*&quot;</span><span class="p">))</span>
    <span class="nv">template</span><span class="p">))</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">fmt</span> <span class="p">(</span><span class="nv">cut2fmt</span> <span class="mi">8</span> <span class="mi">14</span> <span class="mi">20</span> <span class="mi">26</span> <span class="mi">30</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A~%&quot;</span> <span class="nv">fmt</span><span class="p">))</span>
<span class="c1">;; A7 A6 A6 A6 A4 A*</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_1.2</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; use b if b is true, else c</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">a</span> <span class="p">(</span><span class="nb">or</span> <span class="nv">b</span> <span class="nv">c</span><span class="p">))</span>

<span class="c1">;; set x to y unless x is already true</span>
<span class="p">(</span><span class="nb">unless</span> <span class="nv">x</span> <span class="p">(</span><span class="nb">setf</span> <span class="nv">x</span> <span class="nv">y</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; use B if B is defined, otherwise C</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">a</span> <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">boundp</span> <span class="ss">&#39;b</span><span class="p">)</span> <span class="nv">b</span> <span class="nv">c</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">foo</span> <span class="p">(</span><span class="nb">or</span> <span class="nv">bar</span> <span class="s">&quot;DEFAULT VALUE&quot;</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="o">#+</span><span class="nv">sbcl</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="nv">ARGV</span> <span class="p">(</span><span class="nb">copy-seq</span> <span class="p">(</span><span class="nb">cdr</span> <span class="vg">*posix-argv*</span><span class="p">))</span> <span class="s">&quot;Arguments from shell, Perl style&quot;</span><span class="p">)</span>

<span class="p">(</span><span class="nb">setf</span> <span class="nv">dir</span> <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nb">pop</span> <span class="nv">ARGV</span><span class="p">)</span> <span class="s">&quot;/tmp&quot;</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">dir</span> <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nb">nth</span> <span class="mi">0</span> <span class="nv">ARGV</span><span class="p">)</span> <span class="s">&quot;/tmp&quot;</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">dir</span> <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">plusp</span> <span class="p">(</span><span class="nb">length</span> <span class="nv">ARGV</span><span class="p">))</span> <span class="p">(</span><span class="nb">pop</span> <span class="nv">ARGV</span><span class="p">)</span> <span class="s">&quot;/tmp&quot;</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">dir</span> <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">plusp</span> <span class="p">(</span><span class="nb">length</span> <span class="nv">ARGV</span><span class="p">))</span> <span class="p">(</span><span class="nb">nth</span> <span class="mi">0</span> <span class="nv">ARGV</span><span class="p">)</span> <span class="s">&quot;/tmp&quot;</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nb">count</span> <span class="p">(</span><span class="nb">make-hash-table</span><span class="p">))</span>
<span class="p">(</span><span class="nb">incf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="p">(</span><span class="nb">or</span> <span class="nv">shell</span> <span class="s">&quot;/bin/sh&quot;</span><span class="p">)</span> <span class="nb">count</span> <span class="mi">0</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; find the user name on Unix systems</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">user</span> <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nv">posix-getenv</span> <span class="s">&quot;USER&quot;</span><span class="p">)</span>
               <span class="p">(</span><span class="nv">posix-getenv</span> <span class="s">&quot;LOGNAME&quot;</span><span class="p">)</span>
               <span class="o">#+</span><span class="nv">sbcl</span>
               <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">uid</span> <span class="p">(</span><span class="nv">sb-posix:getuid</span><span class="p">)))</span>
                 <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nv">sb-posix:passwd-name</span> <span class="p">(</span><span class="nv">sb-posix:getpwuid</span> <span class="nv">uid</span><span class="p">))</span>
                     <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;Unknown uid number ~a&quot;</span> <span class="nv">uid</span><span class="p">)))</span>
               <span class="o">#-</span><span class="nv">sbcl</span>
               <span class="s">&quot;Unknown uid&quot;</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">starting-point</span> <span class="p">(</span><span class="nb">or</span> <span class="nv">starting-point</span> <span class="s">&quot;Greenwich&quot;</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Perl array-to-array assignment copies the array, hence the need for</span>
<span class="c1">;; COPY-SEQ below.</span>
<span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nb">plusp</span> <span class="p">(</span><span class="nb">length</span> <span class="nv">a</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">setf</span> <span class="nv">a</span> <span class="p">(</span><span class="nb">copy-seq</span> <span class="nv">b</span><span class="p">)))</span>                <span class="c1">; copy only if empty</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">a</span> <span class="p">(</span><span class="nb">copy-seq</span> <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">plusp</span> <span class="p">(</span><span class="nb">length</span> <span class="nv">b</span><span class="p">))</span>
                      <span class="nv">b</span>
                      <span class="nv">c</span><span class="p">)))</span>              <span class="c1">; assign b if nonempty, else c</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_1.3</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; There are several ways to swap variables in CL.  ROTATEF is usually</span>
<span class="c1">;; the simplest choice.</span>
<span class="p">(</span><span class="nb">rotatef</span> <span class="nv">VAR1</span> <span class="nv">VAR2</span><span class="p">)</span>
<span class="p">(</span><span class="nb">psetq</span> <span class="nv">VAR1</span> <span class="nv">VAR2</span> <span class="nv">VAR2</span> <span class="nv">VAR1</span><span class="p">)</span>
<span class="p">(</span><span class="nb">multiple-value-setq</span> <span class="p">(</span><span class="nv">VAR1</span> <span class="nv">VAR2</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">values</span> <span class="nv">VAR2</span> <span class="nv">VAR1</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">temp</span> <span class="nv">a</span>
      <span class="nv">a</span> <span class="nv">b</span>
      <span class="nv">b</span> <span class="nv">temp</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">a</span> <span class="s">&quot;alpha&quot;</span><span class="p">)</span>
      <span class="p">(</span><span class="nv">b</span> <span class="s">&quot;omega&quot;</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">rotatef</span> <span class="nv">a</span> <span class="nv">b</span><span class="p">))</span>           <span class="c1">; the first shall be last -- and versa vice</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">destructuring-bind</span> <span class="p">(</span><span class="nv">alpha</span> <span class="nv">beta</span> <span class="nv">production</span><span class="p">)</span>
    <span class="c1">;; In CL one would normally use symbols here:</span>
    <span class="c1">;; &#39;(January March August)</span>
    <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;January&quot;</span> <span class="s">&quot;March&quot;</span> <span class="s">&quot;August&quot;</span><span class="p">)</span>
  <span class="c1">;; move beta       to alpha,</span>
  <span class="c1">;; move production to beta,</span>
  <span class="c1">;; move alpha      to production</span>
  <span class="p">(</span><span class="nb">rotatef</span> <span class="nv">alpha</span> <span class="nv">beta</span> <span class="nv">production</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_1.4</span>
<span class="c1">;;-----------------------------</span>
<span class="p">(</span><span class="k">setq</span> <span class="nv">num</span> <span class="p">(</span><span class="nb">char-code</span> <span class="nb">char</span><span class="p">))</span>
<span class="p">(</span><span class="k">setq</span> <span class="nb">char</span> <span class="p">(</span><span class="nb">code-char</span> <span class="nv">num</span><span class="p">))</span>
<span class="c1">;;-----------------------------</span>
<span class="p">(</span><span class="k">setq</span> <span class="nb">char</span> <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;~c&quot;</span> <span class="p">(</span><span class="nb">code-char</span> <span class="nv">num</span><span class="p">)))</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;Number ~d is character ~c~%&quot;</span> <span class="nv">num</span> <span class="p">(</span><span class="nb">code-char</span> <span class="nv">num</span><span class="p">))</span>
<span class="c1">;; Number 101 is character e</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">setq</span> <span class="nv">ASCII</span> <span class="p">(</span><span class="nb">map</span> <span class="ss">&#39;list</span> <span class="nf">#&#39;</span><span class="nb">char-code</span> <span class="nb">string</span><span class="p">))</span>
<span class="p">(</span><span class="k">setq</span> <span class="nb">string</span> <span class="p">(</span><span class="nb">map</span> <span class="ss">&#39;string</span> <span class="nf">#&#39;</span><span class="nb">code-char</span> <span class="nv">ASCII</span><span class="p">))</span>
<span class="c1">;;-----------------------------</span>
<span class="p">(</span><span class="k">setq</span> <span class="nv">ascii-value</span> <span class="p">(</span><span class="nb">char-code</span> <span class="sc">#\e</span><span class="p">))</span>             <span class="c1">; now 101</span>
<span class="p">(</span><span class="k">setq</span> <span class="nb">character</span> <span class="p">(</span><span class="nb">code-char</span> <span class="mi">101</span><span class="p">))</span>               <span class="c1">; now #\e</span>
<span class="c1">;;-----------------------------</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;Number ~D is character ~C~%&quot;</span> <span class="mi">101</span> <span class="p">(</span><span class="nb">code-char</span> <span class="mi">101</span><span class="p">))</span>
<span class="c1">;;-----------------------------</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">ascii-character-numbers</span> <span class="p">(</span><span class="nb">map</span> <span class="ss">&#39;list</span> <span class="nf">#&#39;</span><span class="nb">char-code</span> <span class="s">&quot;sample&quot;</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~{~A~^ ~}~%&quot;</span> <span class="nv">ascii-character-numbers</span><span class="p">)</span>
<span class="c1">;; 115 97 109 112 108 101</span>
  <span class="p">(</span><span class="nb">setf</span> <span class="nv">word</span> <span class="p">(</span><span class="nb">map</span> <span class="ss">&#39;string</span> <span class="nf">#&#39;</span><span class="nb">code-char</span> <span class="nv">ascii-character-numbers</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">setf</span> <span class="nv">word</span> <span class="p">(</span><span class="nb">map</span> <span class="ss">&#39;string</span> <span class="nf">#&#39;</span><span class="nb">code-char</span> <span class="o">#(</span><span class="mi">115</span> <span class="mi">97</span> <span class="mi">109</span> <span class="mi">112</span> <span class="mi">108</span> <span class="mi">101</span><span class="p">)))</span> <span class="c1">; same</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A~%&quot;</span> <span class="nv">word</span><span class="p">))</span>
<span class="c1">;; sample</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="nv">hal</span> <span class="s">&quot;HAL&quot;</span><span class="p">)</span>
       <span class="p">(</span><span class="nv">ibm</span> <span class="p">(</span><span class="nb">map</span> <span class="ss">&#39;string</span>
                 <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nb">char</span><span class="p">)</span>
                   <span class="p">(</span><span class="nb">code-char</span> <span class="p">(</span><span class="nb">1+</span> <span class="p">(</span><span class="nb">char-code</span> <span class="nb">char</span><span class="p">))))</span> <span class="c1">; add one to each ASCII value</span>
                 <span class="nv">hal</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A~%&quot;</span> <span class="nv">ibm</span><span class="p">))</span>                <span class="c1">; prints &quot;IBM&quot;</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_1.5</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">setq</span> <span class="nc">array</span> <span class="p">(</span><span class="nb">map</span> <span class="ss">&#39;list</span> <span class="nf">#&#39;</span><span class="nb">string</span> <span class="nb">string</span><span class="p">))</span>

<span class="p">(</span><span class="k">setq</span> <span class="nc">array</span> <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nb">char</span> <span class="nv">across</span> <span class="nb">string</span>
               <span class="nv">collect</span> <span class="p">(</span><span class="nb">char-code</span> <span class="nb">char</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nv">do-matches-as-strings</span> <span class="p">(</span><span class="nv">match</span> <span class="s">&quot;(.)&quot;</span> <span class="nb">string</span><span class="p">)</span>
  <span class="c1">;; do something with MATCH</span>
  <span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">seen</span> <span class="p">(</span><span class="nb">make-hash-table</span><span class="p">))</span>
      <span class="p">(</span><span class="nb">string</span> <span class="s">&quot;an apple a day&quot;</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nb">char</span> <span class="nv">across</span> <span class="nb">string</span> <span class="nb">do</span>
       <span class="p">(</span><span class="nb">incf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nb">char</span> <span class="nv">seen</span> <span class="mi">0</span><span class="p">)))</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">chars</span> <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nb">char</span> <span class="nv">being</span> <span class="nv">each</span> <span class="nv">hash-key</span> <span class="nv">of</span> <span class="nv">seen</span>
                  <span class="nv">collect</span> <span class="nb">char</span><span class="p">)))</span>
    <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;unique chars are: ~{~C~}~%&quot;</span>
            <span class="p">(</span><span class="nb">sort</span> <span class="nv">chars</span> <span class="ss">&#39;&lt;</span> <span class="ss">:key</span> <span class="ss">&#39;char-code</span><span class="p">))))</span>
<span class="c1">;; unique chars are:  adelnpy</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nb">string</span> <span class="s">&quot;an apple a day&quot;</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;sum is ~D~%&quot;</span>
          <span class="p">(</span><span class="nb">reduce</span> <span class="nf">#&#39;</span><span class="nb">+</span> <span class="nb">string</span> <span class="ss">:key</span> <span class="nf">#&#39;</span><span class="nb">char-code</span><span class="p">)))</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nb">string</span> <span class="s">&quot;an apple a day&quot;</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;sum is ~D~%&quot;</span>
          <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nb">char</span> <span class="nv">across</span> <span class="nb">string</span>
                <span class="nv">summing</span> <span class="p">(</span><span class="nb">char-code</span> <span class="nb">char</span><span class="p">))))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nb">string</span> <span class="s">&quot;an apple a day&quot;</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;sum is ~D~%&quot;</span>
          <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nb">char</span> <span class="nv">across</span> <span class="nb">string</span>
             <span class="nv">sum</span> <span class="p">(</span><span class="nb">char-code</span> <span class="nb">char</span><span class="p">))))</span>
<span class="c1">;; prints &quot;1248&quot; if string was &quot;an apple a day&quot;</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; There&#39;s no equivalent to Perl&#39;s unpack(), this is about as close as</span>
<span class="c1">;; you can get.</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">sum</span> <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nb">char</span> <span class="nv">across</span> <span class="nb">string</span>
             <span class="nv">sum</span> <span class="p">(</span><span class="nb">char-code</span> <span class="nb">char</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; In CL it makes more sense to call this function from the REPL than</span>
<span class="c1">;; it does to put it into a separate script.  E.g.,</span>
<span class="c1">;;  &gt; (sum &quot;/tmp/xyz&quot; &quot;~/foo/bar.txt&quot;)</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">sum</span> <span class="p">(</span><span class="k">&amp;rest</span> <span class="nv">files</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">sum</span> <span class="mi">0</span><span class="p">))</span>
    <span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">filename</span> <span class="nv">files</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">with-open-file</span> <span class="p">(</span><span class="nv">file</span> <span class="nv">filename</span> <span class="ss">:element-type</span> <span class="ss">&#39;unsigned-byte</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">do</span> <span class="p">((</span><span class="nv">b</span> <span class="p">(</span><span class="nb">read-byte</span> <span class="nv">file</span> <span class="no">nil</span> <span class="ss">:eof</span><span class="p">)</span>
                <span class="p">(</span><span class="nb">read-byte</span> <span class="nv">file</span> <span class="no">nil</span> <span class="ss">:eof</span><span class="p">)))</span>
            <span class="p">((</span><span class="nb">eql</span> <span class="nv">b</span> <span class="ss">:eof</span><span class="p">))</span>
          <span class="p">(</span><span class="nb">incf</span> <span class="nv">sum</span> <span class="nv">b</span><span class="p">))))</span>
    <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">r</span> <span class="p">(</span><span class="nb">+</span> <span class="p">(</span><span class="nb">mod</span> <span class="nv">sum</span> <span class="p">(</span><span class="nb">expt</span> <span class="mi">2</span> <span class="mi">16</span><span class="p">))</span>
                <span class="p">(</span><span class="nb">truncate</span> <span class="p">(</span><span class="nb">/</span> <span class="p">(</span><span class="nb">mod</span> <span class="nv">sum</span> <span class="p">(</span><span class="nb">expt</span> <span class="mi">2</span> <span class="mi">32</span><span class="p">))</span>
                             <span class="p">(</span><span class="nb">expt</span> <span class="mi">2</span> <span class="mi">16</span><span class="p">))))))</span>
      <span class="p">(</span><span class="nb">+</span> <span class="p">(</span><span class="nb">mod</span> <span class="nv">r</span> <span class="p">(</span><span class="nb">expt</span> <span class="mi">2</span> <span class="mi">16</span><span class="p">))</span>
         <span class="p">(</span><span class="nb">truncate</span> <span class="p">(</span><span class="nb">/</span> <span class="nv">r</span> <span class="p">(</span><span class="nb">expt</span> <span class="mi">2</span> <span class="mi">16</span><span class="p">)))))))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;;CL-USER&gt; (sum &quot;/mach.sym&quot;)</span>
<span class="c1">;;24298</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;;%cksum -o 2 /mach.sym</span>
<span class="c1">;;24298 1203 /mach.sym</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">slowcat</span> <span class="p">(</span><span class="nv">number-or-filename</span> <span class="k">&amp;rest</span> <span class="nv">more-files</span><span class="p">)</span>
  <span class="s">&quot;The first argument can be a number of seconds to sleep between</span>
<span class="s">characters, otherwise it should be a file name.&quot;</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">delay</span> <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">numberp</span> <span class="nv">number-or-filename</span><span class="p">)</span> <span class="nv">number-or-filename</span> <span class="mi">1</span><span class="p">))</span>
        <span class="p">(</span><span class="nv">files</span> <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">numberp</span> <span class="nv">number-or-filename</span><span class="p">)</span> <span class="nv">more-files</span> <span class="p">(</span><span class="nb">cons</span> <span class="nv">number-or-filename</span> <span class="nv">more-files</span><span class="p">))))</span>
    <span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">filename</span> <span class="nv">files</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">with-open-file</span> <span class="p">(</span><span class="nv">file</span> <span class="nv">filename</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">do</span> <span class="p">((</span><span class="nv">c</span> <span class="p">(</span><span class="nb">read-char</span> <span class="nv">file</span> <span class="no">nil</span> <span class="ss">:eof</span><span class="p">)</span>
                <span class="p">(</span><span class="nb">read-char</span> <span class="nv">file</span> <span class="no">nil</span> <span class="ss">:eof</span><span class="p">)))</span>
            <span class="p">((</span><span class="nb">eql</span> <span class="nv">c</span> <span class="ss">:eof</span><span class="p">))</span>
          <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~C&quot;</span> <span class="nv">c</span><span class="p">)</span>
          <span class="p">(</span><span class="nb">finish-output</span><span class="p">)</span>
          <span class="p">(</span><span class="nb">sleep</span> <span class="p">(</span><span class="nb">*</span> <span class="nv">delay</span> <span class="mf">0.005</span><span class="p">)))))))</span>

<span class="c1">;;; @@PLEAC@@_1.6</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">setq</span> <span class="nv">revbytes</span> <span class="p">(</span><span class="nb">reverse</span> <span class="nb">string</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">setq</span> <span class="nv">revwords</span> <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;~{~A~^ ~}&quot;</span>
                       <span class="p">(</span><span class="nb">reverse</span> <span class="p">(</span><span class="nv">split</span> <span class="s">&quot; &quot;</span> <span class="nb">string</span><span class="p">))))</span>
<span class="p">(</span><span class="k">setq</span> <span class="nv">revwords</span> <span class="p">(</span><span class="nb">reverse</span>
                <span class="p">(</span><span class="nb">do*</span> <span class="p">((</span><span class="nv">stringstream</span> <span class="p">(</span><span class="nb">make-string-input-stream</span> <span class="nb">string</span><span class="p">))</span>
                      <span class="p">(</span><span class="nv">result</span> <span class="no">nil</span> <span class="p">(</span><span class="nb">cons</span> <span class="nv">next</span> <span class="nv">result</span><span class="p">))</span>
                      <span class="p">(</span><span class="nv">next</span> <span class="p">(</span><span class="nb">read</span> <span class="nv">stringstream</span> <span class="no">nil</span> <span class="ss">&#39;eos</span><span class="p">)</span>
                            <span class="p">(</span><span class="nb">read</span> <span class="nv">stringstream</span> <span class="no">nil</span> <span class="ss">&#39;eos</span><span class="p">)))</span>
                     <span class="p">((</span><span class="nb">equal</span> <span class="nv">next</span> <span class="ss">&#39;eos</span><span class="p">)</span>
                      <span class="p">(</span><span class="nb">reverse</span> <span class="nv">result</span><span class="p">)))))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">setq</span> <span class="nv">gnirts</span> <span class="p">(</span><span class="nb">reverse</span> <span class="nb">string</span><span class="p">))</span>          <span class="c1">; reverse letters in string</span>

<span class="p">(</span><span class="k">setq</span> <span class="nv">sdrow</span> <span class="p">(</span><span class="nb">reverse</span> <span class="nv">words</span><span class="p">))</span>            <span class="c1">; reverse elements in words</span>

<span class="p">(</span><span class="k">setq</span> <span class="nv">confused</span> <span class="p">(</span><span class="nb">reverse</span> <span class="p">(</span><span class="nb">apply</span> <span class="nf">#&#39;</span><span class="nb">concatenate</span> <span class="ss">&#39;string</span> <span class="nv">words</span><span class="p">)))</span> <span class="c1">; reverse letters in join(&quot;&quot;, @words)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">setq</span> <span class="nb">string</span> <span class="s">&quot;Yoda said, \&quot;can you see this?\&quot;&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="k">setq</span> <span class="nv">allwords</span> <span class="p">(</span><span class="nv">split</span> <span class="s">&quot; &quot;</span> <span class="nb">string</span><span class="p">))</span>
<span class="p">(</span><span class="k">setq</span> <span class="nv">revwords</span> <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;~{~A~^ ~}&quot;</span> <span class="p">(</span><span class="nb">reverse</span> <span class="nv">allwords</span><span class="p">)))</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A~%&quot;</span> <span class="nv">revwords</span><span class="p">)</span>
<span class="c1">;this?&quot; see you &quot;can said, Yoda</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">setq</span> <span class="nv">revwords</span> <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;~{~A~^ ~}&quot;</span> <span class="p">(</span><span class="nb">reverse</span> <span class="p">(</span><span class="nv">split</span> <span class="s">&quot; &quot;</span> <span class="nb">string</span><span class="p">))))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">setq</span> <span class="nv">revwords</span> <span class="p">(</span><span class="nb">apply</span> <span class="nf">#&#39;</span><span class="nb">concatenate</span> <span class="ss">&#39;string</span>
                      <span class="p">(</span><span class="nv">split</span> <span class="s">&quot;(\\s+)&quot;</span> <span class="nb">string</span> <span class="ss">:with-registers-p</span> <span class="no">t</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">palindrome-p</span> <span class="p">(</span><span class="nv">word</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">string=</span> <span class="nv">word</span> <span class="p">(</span><span class="nb">reverse</span> <span class="nv">word</span><span class="p">)))</span>
<span class="p">(</span><span class="nv">palindrome-p</span> <span class="s">&quot;reviver&quot;</span><span class="p">)</span>
<span class="c1">;; T</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">with-open-file</span> <span class="p">(</span><span class="nv">inf</span> <span class="s">&quot;/usr/share/dict/words&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">word</span> <span class="nb">=</span> <span class="p">(</span><span class="nb">read-line</span> <span class="nv">inf</span> <span class="no">nil</span> <span class="no">nil</span><span class="p">)</span>
        <span class="nv">while</span> <span class="nv">word</span>
        <span class="nb">when</span> <span class="p">(</span><span class="nb">and</span> <span class="p">(</span><span class="nb">string=</span> <span class="nv">word</span> <span class="p">(</span><span class="nb">reverse</span> <span class="nv">word</span><span class="p">))</span>
                  <span class="p">(</span><span class="nb">&gt;</span> <span class="p">(</span><span class="nb">length</span> <span class="nv">word</span><span class="p">)</span> <span class="mi">5</span><span class="p">))</span>
        <span class="nb">do</span> <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~a~%&quot;</span> <span class="nv">word</span><span class="p">)))</span>
<span class="c1">;; deedeed</span>
<span class="c1">;; degged</span>
<span class="c1">;; hallah</span>
<span class="c1">;; kakkak</span>
<span class="c1">;; murdrum</span>
<span class="c1">;; redder</span>
<span class="c1">;; repaper</span>
<span class="c1">;; retter</span>
<span class="c1">;; reviver</span>
<span class="c1">;; rotator</span>
<span class="c1">;; sooloos</span>
<span class="c1">;; tebbet</span>
<span class="c1">;; terret</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_1.7</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">tab-expand</span> <span class="p">(</span><span class="nb">string</span> <span class="k">&amp;optional</span> <span class="p">(</span><span class="nv">tabstop</span> <span class="mi">8</span><span class="p">))</span>
  <span class="p">(</span><span class="k">flet</span> <span class="p">((</span><span class="nv">needed-spaces</span> <span class="p">(</span><span class="nv">target-string</span> <span class="nv">start</span> <span class="nv">end</span> <span class="nv">match-start</span> <span class="nv">match-end</span> <span class="nv">reg-starts</span> <span class="nv">reg-ends</span><span class="p">)</span>
           <span class="p">(</span><span class="k">declare</span> <span class="p">(</span><span class="k">ignore</span> <span class="nv">target-string</span> <span class="nv">start</span> <span class="nv">end</span> <span class="nv">reg-starts</span> <span class="nv">reg-ends</span><span class="p">))</span>
           <span class="p">(</span><span class="nb">make-string</span> <span class="p">(</span><span class="nb">-</span> <span class="p">(</span><span class="nb">*</span> <span class="p">(</span><span class="nb">-</span> <span class="nv">match-end</span> <span class="nv">match-start</span><span class="p">)</span> <span class="nv">tabstop</span><span class="p">)</span>
                           <span class="p">(</span><span class="nb">mod</span> <span class="nv">match-start</span> <span class="nv">tabstop</span><span class="p">))</span>
                        <span class="ss">:initial-element</span> <span class="sc">#\Space</span><span class="p">)))</span>
    <span class="p">(</span><span class="nv">regex-replace-all</span> <span class="s">&quot;\\t+&quot;</span> <span class="nb">string</span> <span class="nf">#&#39;</span><span class="nv">needed-spaces</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">tab-unexpand</span> <span class="p">(</span><span class="nb">string</span> <span class="k">&amp;optional</span> <span class="p">(</span><span class="nv">tabstop</span> <span class="mi">8</span><span class="p">))</span>
  <span class="p">(</span><span class="k">flet</span> <span class="p">((</span><span class="nv">needed-tabs</span> <span class="p">(</span><span class="nv">target-string</span> <span class="nv">start</span> <span class="nv">end</span> <span class="nv">match-start</span> <span class="nv">match-end</span> <span class="nv">reg-starts</span> <span class="nv">reg-ends</span><span class="p">)</span>
           <span class="p">(</span><span class="k">declare</span> <span class="p">(</span><span class="k">ignore</span> <span class="nv">target-string</span> <span class="nv">start</span> <span class="nv">end</span> <span class="nv">reg-starts</span> <span class="nv">reg-ends</span><span class="p">))</span>
           <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">match-length</span> <span class="p">(</span><span class="nb">-</span> <span class="nv">match-end</span> <span class="nv">match-start</span><span class="p">)))</span>
             <span class="p">(</span><span class="nb">concatenate</span> <span class="ss">&#39;string</span>
                          <span class="p">(</span><span class="nb">make-string</span> <span class="p">(</span><span class="nb">floor</span> <span class="nv">match-length</span> <span class="nv">tabstop</span><span class="p">)</span>
                                       <span class="ss">:initial-element</span> <span class="sc">#\Tab</span><span class="p">)</span>
                          <span class="p">(</span><span class="nb">make-string</span> <span class="p">(</span><span class="nb">mod</span> <span class="nv">match-length</span> <span class="nv">tabstop</span><span class="p">)</span>
                                       <span class="ss">:initial-element</span> <span class="sc">#\Space</span><span class="p">)))))</span>
    <span class="p">(</span><span class="nv">regex-replace-all</span> <span class="s">&quot;  +&quot;</span> <span class="nb">string</span> <span class="nf">#&#39;</span><span class="nv">needed-tabs</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">line</span> <span class="nb">=</span> <span class="p">(</span><span class="nb">read-line</span> <span class="vg">*standard-input*</span> <span class="no">nil</span> <span class="no">nil</span><span class="p">)</span>
      <span class="nv">while</span> <span class="nv">line</span> <span class="nb">do</span>
      <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A~%&quot;</span> <span class="p">(</span><span class="nv">tab-expand</span> <span class="nv">line</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">line</span> <span class="nb">=</span> <span class="p">(</span><span class="nb">read-line</span> <span class="vg">*standard-input*</span> <span class="no">nil</span> <span class="no">nil</span><span class="p">)</span>
      <span class="nv">while</span> <span class="nv">line</span> <span class="nb">do</span>
      <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A~%&quot;</span> <span class="p">(</span><span class="nv">tab-unexpand</span> <span class="nv">line</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_1.8</span>
<span class="c1">;;;-----------------------------</span>

<span class="p">(</span><span class="nb">setf</span> <span class="nv">text</span> <span class="s">&quot;You owe $debt to me&quot;</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">global-deref</span> <span class="p">(</span><span class="nv">match</span> <span class="nv">var-name</span><span class="p">)</span>
  <span class="s">&quot;Helper function to simulate Perl&#39;s string interpolation in</span>
<span class="s">regexps.&quot;</span>
  <span class="p">(</span><span class="nb">write-to-string</span> <span class="p">(</span><span class="nb">symbol-value</span> <span class="p">(</span><span class="nb">intern</span> <span class="p">(</span><span class="nb">string-upcase</span> <span class="nv">var-name</span><span class="p">)))))</span>

<span class="p">(</span><span class="nb">setf</span> <span class="nv">text</span> <span class="p">(</span><span class="nv">regex-replace-all</span> <span class="s">&quot;\\$(\\w+)&quot;</span> <span class="nv">text</span> <span class="nf">#&#39;</span><span class="nv">global-deref</span>
                                       <span class="ss">:simple-calls</span> <span class="no">t</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">setq</span> <span class="nv">rows</span> <span class="mi">24</span> <span class="nv">cols</span> <span class="mi">80</span><span class="p">)</span>
<span class="p">(</span><span class="k">setq</span> <span class="nv">text</span> <span class="s">&quot;I am $rows high and $cols long&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="k">setq</span> <span class="nv">text</span> <span class="p">(</span><span class="nv">regex-replace-all</span> <span class="s">&quot;\\$(\\w+)&quot;</span> <span class="nv">text</span>
                                       <span class="nf">#&#39;</span><span class="nv">global-deref</span>
                                       <span class="ss">:simple-calls</span> <span class="no">t</span><span class="p">))</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A~%&quot;</span> <span class="nv">text</span><span class="p">)</span>
<span class="c1">;; I am 24 high and 80 long</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">text</span> <span class="s">&quot;I am 17 years old&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">text</span> <span class="p">(</span><span class="nv">regex-replace-all</span> <span class="s">&quot;(\\d+)&quot;</span> <span class="nv">text</span>
                                       <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">match</span> <span class="nv">num-str</span><span class="p">)</span>
                                         <span class="p">(</span><span class="k">declare</span> <span class="p">(</span><span class="k">ignore</span> <span class="nv">match</span><span class="p">))</span>
                                         <span class="p">(</span><span class="nb">write-to-string</span>
                                          <span class="p">(</span><span class="nb">*</span> <span class="mi">2</span> <span class="p">(</span><span class="nb">parse-integer</span> <span class="nv">num-str</span><span class="p">))))</span>
                                       <span class="ss">:simple-calls</span> <span class="no">t</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">*</span> <span class="mi">2</span> <span class="mi">17</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; expand variables in text, but put an error message in</span>
<span class="c1">;; if the variable isn&#39;t defined</span>
<span class="p">(</span><span class="k">flet</span> <span class="p">((</span><span class="nv">deref-with-err</span> <span class="p">(</span><span class="nv">match</span> <span class="nv">word</span><span class="p">)</span>
         <span class="p">(</span><span class="k">declare</span> <span class="p">(</span><span class="k">ignore</span> <span class="nv">match</span><span class="p">))</span>
         <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">word-sym</span> <span class="p">(</span><span class="nb">intern</span> <span class="p">(</span><span class="nb">string-upcase</span> <span class="nv">word</span><span class="p">))))</span>
           <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">boundp</span> <span class="nv">word-sym</span><span class="p">)</span>
               <span class="p">(</span><span class="nb">write-to-string</span> <span class="p">(</span><span class="nb">symbol-value</span> <span class="nv">word-sym</span><span class="p">))</span>
               <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;[NO VARIABLE: $~a]&quot;</span> <span class="nv">word-sym</span><span class="p">)))))</span>
  <span class="p">(</span><span class="nb">setf</span> <span class="nv">text</span> <span class="p">(</span><span class="nv">regex-replace-all</span> <span class="s">&quot;\\$(\\w+)&quot;</span> <span class="nv">text</span>
                                         <span class="nf">#&#39;</span><span class="nv">deref-with-err</span>
                                         <span class="ss">:simple-calls</span> <span class="no">t</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>


<span class="c1">;;; @@PLEAC@@_1.9</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">big</span> <span class="p">(</span><span class="nb">string-upcase</span> <span class="nv">little</span><span class="p">))</span>       <span class="c1">; &quot;bo peep&quot; -&gt; &quot;BO PEEP&quot;</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">little</span> <span class="p">(</span><span class="nb">string-downcase</span> <span class="nv">big</span><span class="p">))</span>     <span class="c1">; &quot;JOHN&quot;    -&gt; &quot;john&quot;</span>
<span class="c1">;; Reminder: the following depends on CL-INTERPOL.</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">big</span> <span class="err">#</span><span class="nv">?</span><span class="s">&quot;\U$(little)&quot;</span><span class="p">)</span>              <span class="c1">; &quot;bo peep&quot; -&gt; &quot;BO PEEP&quot;</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">little</span> <span class="err">#</span><span class="nv">?</span><span class="s">&quot;\L$(big)&quot;</span><span class="p">)</span>              <span class="c1">; &quot;JOHN&quot; -&gt; &quot;john&quot;</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">big</span> <span class="p">(</span><span class="nb">string-upcase</span> <span class="nv">little</span> <span class="ss">:end</span> <span class="mi">1</span><span class="p">)</span>    <span class="c1">; &quot;bo&quot;      -&gt; &quot;Bo&quot;</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">little</span> <span class="p">(</span><span class="nb">string-downcase</span> <span class="nv">BIG</span> <span class="ss">:end</span> <span class="mi">1</span><span class="p">))</span> <span class="c1">; &quot;BoPeep&quot;    -&gt; &quot;boPeep&quot;</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">big</span> <span class="err">#</span><span class="nv">?</span><span class="s">&quot;\u$(little)&quot;</span><span class="p">)</span>                 <span class="c1">; &quot;bo&quot;      -&gt; &quot;Bo&quot;</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">little</span> <span class="err">#</span><span class="nv">?</span><span class="s">&quot;\l$(big)&quot;</span><span class="p">)</span>                 <span class="c1">; &quot;BoPeep&quot;    -&gt; &quot;boPeep&quot;</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">beast</span> <span class="s">&quot;dromedary&quot;</span><span class="p">)</span>
<span class="c1">;; Capitalize various parts of beast</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">capit</span> <span class="p">(</span><span class="nb">string-upcase</span> <span class="nv">beast</span> <span class="ss">:end</span> <span class="mi">1</span><span class="p">))</span>      <span class="c1">; Dromedary</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">capit</span> <span class="err">#</span><span class="nv">?</span><span class="s">&quot;\u\L$(beast)&quot;</span><span class="p">)</span>                  <span class="c1">; (same)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">capall</span> <span class="p">(</span><span class="nb">string-upcase</span> <span class="nv">beast</span><span class="p">))</span>            <span class="c1">; DROMEDARY</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">capall</span> <span class="err">#</span><span class="nv">?</span><span class="s">&quot;\U$(beast)&quot;</span><span class="p">)</span>                   <span class="c1">; (same)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">caprest</span> <span class="p">(</span><span class="nb">string-downcase</span> <span class="p">(</span><span class="nb">string-upcase</span> <span class="nv">beast</span><span class="p">)</span> <span class="ss">:end</span> <span class="mi">1</span><span class="p">))</span> <span class="c1">; dROMEDARY</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">caprest</span> <span class="err">#</span><span class="nv">?</span><span class="s">&quot;\l\U$(beast)&quot;</span><span class="p">)</span>                               <span class="c1">; (same)</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; capitalize each word&#39;s first character, downcase the rest</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">text</span> <span class="s">&quot;thIS is a loNG liNE&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A~%&quot;</span> <span class="p">(</span><span class="nb">string-capitalize</span> <span class="nv">text</span><span class="p">))</span>
<span class="c1">;; This Is A Long Line</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; string= is case-sensitive, string-equal is case-insensitive</span>
<span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">string-equal</span> <span class="nv">a</span> <span class="nv">b</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;a and b are the same~%&quot;</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; It&#39;s considered bad form to perform bitwise operations on character</span>
<span class="c1">;; types, and breaks unicode-aware lisps.  Trust the compiler to</span>
<span class="c1">;; optimize.</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">randcase</span> <span class="p">(</span><span class="nb">char</span><span class="p">)</span>
  <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">&lt;</span> <span class="p">(</span><span class="nb">random</span> <span class="mi">100</span><span class="p">)</span> <span class="mi">20</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">char-upcase</span> <span class="nb">char</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">char-downcase</span> <span class="nb">char</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_1.10</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">answer</span> <span class="p">(</span><span class="nb">concatenate</span> <span class="ss">&#39;string</span> <span class="nv">var1</span> <span class="p">(</span><span class="nv">func</span><span class="p">)</span> <span class="nv">var2</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">answer</span> <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;STRING ~{~A~} MORE STRING&quot;</span> <span class="nv">list-expr</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">answer</span> <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;STRING ~A MORE STRING&quot;</span> <span class="nv">atomic-expr</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">phrase</span> <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;I have ~D guanacos.&quot;</span> <span class="p">(</span><span class="nb">1+</span> <span class="nv">n</span><span class="p">)))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">phrase</span> <span class="err">#</span><span class="nv">?</span><span class="s">&quot;I have ${(1+ n)} guanacos.&quot;</span><span class="p">)</span> <span class="c1">; uses CL-INTERPOL</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;I have ~D guanacos.~%&quot;</span> <span class="p">(</span><span class="nb">1+</span> <span class="nv">n</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nv">some-func</span> <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;What you want is ~{~A~} items&quot;</span>
                   <span class="p">(</span><span class="nv">split</span> <span class="s">&quot;:&quot;</span> <span class="nv">rec</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">text</span> <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;~</span>
<span class="s">To: ~A</span>
<span class="s">From: Your Bank</span>
<span class="s">Cc: ~{~A~^, ~}</span>
<span class="s">Date: ~A (today)</span>

<span class="s">Dear ~A,</span>

<span class="s">Today, you bounced check number ~D to us.</span>
<span class="s">Your account is now closed.</span>

<span class="s">Sincerely,</span>
<span class="s">the management</span>
<span class="s">&quot;</span>
                    <span class="nv">naughty</span>
                    <span class="p">(</span><span class="nv">get-manager-list</span> <span class="nv">naughty</span><span class="p">)</span>
                    <span class="p">(</span><span class="k">let</span> <span class="p">(</span><span class="nv">date-str</span> <span class="p">(</span><span class="nb">with-output-to-string</span> <span class="p">(</span><span class="nv">str</span><span class="p">)</span>
                                     <span class="p">(</span><span class="nv">run-program</span> <span class="s">&quot;/bin/date&quot;</span> <span class="no">nil</span>
                                                  <span class="ss">:output</span> <span class="nv">str</span><span class="p">)))</span>
                      <span class="p">(</span><span class="nb">subseq</span> <span class="nv">date-str</span> <span class="mi">0</span> <span class="p">(</span><span class="nb">1-</span> <span class="p">(</span><span class="nb">length</span> <span class="nv">date-str</span><span class="p">))))</span>
                    <span class="nv">naughty</span>
                    <span class="p">(</span><span class="nb">+</span> <span class="mi">500</span> <span class="p">(</span><span class="nb">random</span> <span class="mi">100</span><span class="p">)))))</span>
  <span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nv">send-mail</span> <span class="nv">text</span> <span class="nv">target</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">error</span> <span class="s">&quot;Couldn&#39;t send mail&quot;</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_1.11</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; all in one</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">var</span> <span class="p">(</span><span class="nv">regex-replace-all</span>
           <span class="p">(</span><span class="nv">create-scanner</span> <span class="err">#</span><span class="nv">?r</span><span class="s">&quot;^\s+&quot;</span> <span class="ss">:multi-line-mode</span> <span class="no">t</span><span class="p">)</span>
<span class="s">&quot;your text</span>
<span class="s">goes here</span>
<span class="s">&quot;</span> <span class="s">&quot;&quot;</span><span class="p">))</span>

<span class="c1">;; or with two steps</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">var</span> <span class="s">&quot;your text</span>
<span class="s">goes here</span>
<span class="s">&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">var</span> <span class="p">(</span><span class="nv">regex-replace-all</span>
           <span class="p">(</span><span class="nv">create-scanner</span> <span class="err">#</span><span class="nv">?r</span><span class="s">&quot;^\s+&quot;</span> <span class="ss">:multi-line-mode</span> <span class="no">t</span><span class="p">)</span>
           <span class="nv">var</span>
           <span class="s">&quot;&quot;</span><span class="p">))</span>
<span class="c1">;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">var</span> <span class="p">(</span><span class="nv">regex-replace-all</span>
           <span class="p">(</span><span class="nv">create-scanner</span> <span class="err">#</span><span class="nv">?r</span><span class="s">&quot;^\s+&quot;</span> <span class="ss">:multi-line-mode</span> <span class="no">t</span><span class="p">)</span>
<span class="s">&quot;    The five varieties of camelids</span>
<span class="s">    are the familiar camel, his friends</span>
<span class="s">    the llama and the alpaca, and the</span>
<span class="s">    rather less well-known guanaco</span>
<span class="s">    and vicuсa.</span>
<span class="s">&quot;</span> <span class="s">&quot;&quot;</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">fix</span> <span class="p">(</span><span class="nb">string</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">regex-replace-all</span>
   <span class="p">(</span><span class="nv">create-scanner</span> <span class="err">#</span><span class="nv">?r</span><span class="s">&quot;^\s+&quot;</span> <span class="ss">:multi-line-mode</span> <span class="no">t</span><span class="p">)</span>
   <span class="nb">string</span>
   <span class="s">&quot;&quot;</span><span class="p">))</span>

<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A~%&quot;</span> <span class="p">(</span><span class="nv">fix</span> <span class="s">&quot;    My stuff goes here</span>
<span class="s">&quot;</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="k">quote</span>
      <span class="p">(</span><span class="nv">regex-replace-all</span>
       <span class="p">(</span><span class="nv">create-scanner</span> <span class="err">#</span><span class="nv">?r</span><span class="s">&quot;\s+--&quot;</span><span class="p">)</span>
       <span class="p">(</span><span class="nv">regex-replace-all</span>
        <span class="p">(</span><span class="nv">create-scanner</span> <span class="err">#</span><span class="nv">?r</span><span class="s">&quot;^\s+&quot;</span> <span class="ss">:multi-line-mode</span> <span class="no">t</span><span class="p">)</span>
<span class="s">&quot;        ...we will have peace, when you and all your works have</span>
<span class="s">        perished--and the works of your dark master to whom you would</span>
<span class="s">        deliver us. You are a liar, Saruman, and a corrupter of mens</span>
<span class="s">        hearts.  --Theoden in /usr/src/perl/taint.c</span>
<span class="s">&quot;</span>
       <span class="s">&quot;&quot;</span><span class="p">)</span>
       <span class="s">&quot;</span>
<span class="s">--&quot;</span><span class="p">))</span>
<span class="c1">;;-----------------------------</span>
<span class="p">(</span><span class="nb">when</span> <span class="vg">*remember-the-main*</span>
  <span class="p">(</span><span class="nb">setf</span> <span class="nv">perl-main-C</span> <span class="p">(</span><span class="nv">dequote</span>
<span class="s">&quot;        @@@ int</span>
<span class="s">         @@@ runops() {</span>
<span class="s">         @@@     SAVEI32(runlevel);</span>
<span class="s">         @@@     runlevel++;</span>
<span class="s">         @@@     while ( op = (*op-&gt;op_ppaddr)() ) ;</span>
<span class="s">         @@@     TAINT_NOT;</span>
<span class="s">         @@@     return 0;</span>
<span class="s">         @@@ }</span>
<span class="s">&quot;</span>
  <span class="c1">;; add more code here if you want</span>
   <span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*poem*</span> <span class="p">(</span><span class="nv">dequote</span>
<span class="s">&quot;       Now far ahead the Road has gone,</span>
<span class="s">          And I must follow, if I can,</span>
<span class="s">       Pursuing it with eager feet,</span>
<span class="s">          Until it joins some larger way</span>
<span class="s">       Where many paths and errands meet.</span>
<span class="s">          And whither then? I cannot say.</span>
<span class="s">                --Bilbo in /usr/src/perl/pp_ctl.c</span>
<span class="s">&quot;</span><span class="p">))</span>

<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;Here&#39;s your poem:~%~%~A~%&quot;</span> <span class="vg">*poem*</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">dequote</span> <span class="p">(</span><span class="nb">string</span><span class="p">)</span>
  <span class="c1">;; Can&#39;t get multiple values returned thru the OR, hence the use of</span>
  <span class="c1">;; DESTRUCTURING-BIND instead of MULTIPLE-VALUE-BIND</span>
  <span class="p">(</span><span class="nb">destructuring-bind</span> <span class="p">(</span><span class="nv">white</span> <span class="nv">leader</span><span class="p">)</span> <span class="c1">; common whitespace and common leading string</span>
      <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nv">register-groups-bind</span> <span class="p">(</span><span class="nv">$1</span> <span class="nv">$2</span><span class="p">)</span>
              <span class="p">(</span><span class="err">#</span><span class="nv">?r/^\s*</span><span class="p">(</span><span class="nv">?:</span><span class="p">(</span><span class="nv">[^\w\s]+</span><span class="p">)(</span><span class="nv">\s*</span><span class="p">)</span><span class="o">.</span><span class="nv">*\n</span><span class="p">)(</span><span class="nv">?:\s*\1\2?.*\n</span><span class="p">)</span><span class="nv">+$/</span> <span class="nb">string</span><span class="p">)</span>
            <span class="p">(</span><span class="nb">list</span> <span class="nv">$2</span> <span class="p">(</span><span class="nv">quote-meta-chars</span> <span class="nv">$1</span><span class="p">)))</span>
          <span class="p">(</span><span class="nb">list</span> <span class="p">(</span><span class="nv">scan-to-strings</span> <span class="err">#</span><span class="nv">?r</span><span class="s">&quot;^(\s+)&quot;</span> <span class="nb">string</span><span class="p">)</span> <span class="s">&quot;&quot;</span><span class="p">))</span>
    <span class="p">(</span><span class="nv">regex-replace-all</span>
     <span class="p">(</span><span class="nv">create-scanner</span> <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="err">#</span><span class="nv">?r</span><span class="s">&quot;^\s*?~a(?:~a)?&quot;</span> <span class="nv">leader</span> <span class="nv">white</span><span class="p">)</span> <span class="ss">:multi-line-mode</span> <span class="no">t</span><span class="p">)</span>
     <span class="nb">string</span>
     <span class="s">&quot;&quot;</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_1.12</span>
<span class="p">(</span><span class="nb">defvar</span> <span class="vg">*default-line-width*</span> <span class="mi">72</span><span class="p">)</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">partition</span> <span class="p">(</span><span class="nb">list</span> <span class="nv">max-part-len</span> <span class="nv">item-offset-len</span><span class="p">)</span>
  <span class="s">&quot;Partitions supplied `LIST&#39; into list of item lists where every sublist is of</span>
<span class="s">maximum `MAX-PART-LEN&#39; size. (`ITEM-OFFSET-LEN&#39; is added to every item while</span>
<span class="s">calculating item lengths.)&quot;</span>
  <span class="p">(</span><span class="nb">destructuring-bind</span> <span class="p">(</span><span class="nv">parts</span> <span class="nv">part</span> <span class="nv">part-len</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">reduce</span>
       <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">accum</span> <span class="nv">item</span><span class="p">)</span>
         <span class="p">(</span><span class="nb">destructuring-bind</span> <span class="p">(</span><span class="nv">parts</span> <span class="nv">part</span> <span class="nv">part-len</span><span class="p">)</span> <span class="nv">accum</span>
           <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">item-len</span> <span class="p">(</span><span class="nb">+</span> <span class="p">(</span><span class="nb">length</span> <span class="nv">item</span><span class="p">)</span> <span class="nv">item-offset-len</span><span class="p">)))</span>
             <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">&lt;</span> <span class="nv">max-part-len</span> <span class="p">(</span><span class="nb">+</span> <span class="nv">part-len</span> <span class="nv">item-len</span><span class="p">))</span>
                 <span class="p">(</span><span class="nb">list</span> <span class="p">(</span><span class="nb">cons</span> <span class="p">(</span><span class="nb">nreverse</span> <span class="nv">part</span><span class="p">)</span> <span class="nv">parts</span><span class="p">)</span> <span class="p">(</span><span class="nb">list</span> <span class="nv">item</span><span class="p">)</span> <span class="nv">item-len</span><span class="p">)</span>
                 <span class="p">(</span><span class="nb">list</span> <span class="nv">parts</span> <span class="p">(</span><span class="nb">cons</span> <span class="nv">item</span> <span class="nv">part</span><span class="p">)</span> <span class="p">(</span><span class="nb">+</span> <span class="nv">part-len</span> <span class="nv">item-len</span><span class="p">))))))</span>
       <span class="nb">list</span> <span class="ss">:initial-value</span> <span class="p">(</span><span class="nb">list</span> <span class="no">nil</span> <span class="no">nil</span> <span class="mi">0</span><span class="p">))</span>
    <span class="p">(</span><span class="k">declare</span> <span class="p">(</span><span class="k">ignore</span> <span class="nv">part-len</span><span class="p">))</span>
    <span class="p">(</span><span class="nb">nreverse</span> <span class="p">(</span><span class="k">if</span> <span class="nv">part</span> <span class="p">(</span><span class="nb">cons</span> <span class="nv">part</span> <span class="nv">parts</span><span class="p">)</span> <span class="nv">parts</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">wrap-paragraph</span> <span class="p">(</span><span class="nb">string</span> <span class="k">&amp;optional</span> <span class="nv">line-width</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">with-output-to-string</span> <span class="p">(</span><span class="nv">out</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">words</span>
              <span class="p">(</span><span class="nv">partition</span>
               <span class="p">(</span><span class="nv">ppcre:split</span> <span class="s">&quot;\\s+&quot;</span> <span class="nb">string</span><span class="p">)</span>
               <span class="p">(</span><span class="nb">1+</span> <span class="p">(</span><span class="nb">or</span> <span class="nv">line-width</span> <span class="vg">*default-line-width*</span><span class="p">))</span>
               <span class="mi">1</span><span class="p">))</span>
      <span class="p">(</span><span class="nb">format</span> <span class="nv">out</span> <span class="s">&quot;~&amp;~{~A~^ ~}&quot;</span> <span class="nv">words</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">wrap-paragraphs</span> <span class="p">(</span><span class="nb">string</span> <span class="k">&amp;optional</span> <span class="nv">line-width</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;~{~A~^~%~%~}&quot;</span>
          <span class="p">(</span><span class="nb">mapcar</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">paragraph</span><span class="p">)</span> <span class="p">(</span><span class="nv">wrap-paragraph</span> <span class="nv">paragraph</span> <span class="nv">line-width</span><span class="p">))</span>
                  <span class="p">(</span><span class="nv">ppcre:split</span> <span class="s">&quot;([\\r]?\\n){2,}&quot;</span> <span class="nb">string</span><span class="p">))))</span>

<span class="p">(</span><span class="nv">wrap-paragraphs</span> <span class="s">&quot;foo0 foo1 foo2 foo3 foo5 foo6 foo7 foo8</span>
<span class="s">foo9 bar0</span>

<span class="s">bar1 bar2</span>


<span class="s">bar3 bar4 bar5 bar6</span>
<span class="s">bar7</span>
<span class="s">bar8 bar9 baz0</span>

<span class="s">baz1 baz2 baz3 baz4 baz5 baz6 baz7 baz8 baz9&quot;</span> <span class="mi">14</span><span class="p">)</span>
<span class="c1">; =&gt; &quot;foo0 foo1 foo2</span>
<span class="c1">;     foo3 foo5 foo6</span>
<span class="c1">;     foo7 foo8 foo9</span>
<span class="c1">;     bar0</span>
<span class="c1">;</span>
<span class="c1">;     bar2 bar1</span>
<span class="c1">;</span>
<span class="c1">;     bar3 bar4 bar5</span>
<span class="c1">;     bar6 bar7 bar8</span>
<span class="c1">;     baz0 bar9</span>
<span class="c1">;</span>
<span class="c1">;     baz1 baz2 baz3</span>
<span class="c1">;     baz4 baz5 baz6</span>
<span class="c1">;     baz9 baz8 baz7&quot;</span>

<span class="c1">;;; @@PLEAC@@_1.13</span>
<span class="c1">;; backslash</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">var</span> <span class="p">(</span><span class="nv">regex-replace-all</span> <span class="s">&quot;([CHARLIST])&quot;</span> <span class="nv">var</span> <span class="s">&quot;\\\1&quot;</span><span class="p">))</span>

<span class="c1">;; double</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">var</span> <span class="p">(</span><span class="nv">regex-replace-all</span> <span class="s">&quot;([CHARLIST])&quot;</span> <span class="nv">var</span> <span class="s">&quot;\\1\\1&quot;</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nb">string</span> <span class="p">(</span><span class="nv">regex-replace-all</span> <span class="s">&quot;%&quot;</span> <span class="nb">string</span> <span class="s">&quot;%%&quot;</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nb">string</span> <span class="s">&quot;Mom said, \&quot;Don&#39;t do that.\&quot;&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nb">string</span> <span class="p">(</span><span class="nv">regex-replace-all</span> <span class="s">&quot;([&#39;\&quot;])&quot;</span> <span class="nb">string</span> <span class="err">#</span><span class="nv">?r</span><span class="s">&quot;\\\1&quot;</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nb">string</span> <span class="s">&quot;Mom said, \&quot;Don&#39;t do that.\&quot;&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nb">string</span> <span class="p">(</span><span class="nv">regex-replace-all</span> <span class="s">&quot;([&#39;\&quot;])&quot;</span> <span class="nb">string</span> <span class="err">#</span><span class="nv">?r</span><span class="s">&quot;\1\1&quot;</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nb">string</span> <span class="p">(</span><span class="nv">regex-replace-all</span> <span class="err">#</span><span class="nv">?r</span><span class="s">&quot;([^A-Z])&quot;</span> <span class="nb">string</span> <span class="err">#</span><span class="nv">?r</span><span class="s">&quot;\\\1&quot;</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nb">string</span> <span class="err">#</span><span class="nv">?r</span><span class="s">&quot;this \Qis a test!\E&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nb">string</span> <span class="s">&quot;this is\\ a\\ test\\!&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nb">string</span> <span class="p">(</span><span class="nb">concatenate</span> <span class="ss">&#39;string</span> <span class="s">&quot;this &quot;</span> <span class="p">(</span><span class="nv">quote-meta-chars</span> <span class="s">&quot;is a test!&quot;</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_1.14</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nb">string</span> <span class="p">(</span><span class="nv">regex-replace</span> <span class="err">#</span><span class="nv">?r/^\s+/</span> <span class="nb">string</span> <span class="s">&quot;&quot;</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nb">string</span> <span class="p">(</span><span class="nv">regex-replace</span> <span class="err">#</span><span class="nv">?r/\s+$/</span> <span class="nb">string</span> <span class="s">&quot;&quot;</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; The closest thing to Perl&#39;s wantarray is CL&#39;s ability to return</span>
<span class="c1">;;; multiple values from a function.  Unless the caller uses</span>
<span class="c1">;;; MULTIPLE-VALUE-BIND (or, in this case, MULTIPLE-VALUE-LIST), they</span>
<span class="c1">;;; will only &quot;see&quot; the first value.  Note also that, normally, you&#39;d</span>
<span class="c1">;;; use CL&#39;s built-in STRING-TRIM function for this.</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">trim</span> <span class="p">(</span><span class="k">&amp;rest</span> <span class="nv">strings</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">values-list</span>
   <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nb">string</span> <span class="nv">in</span> <span class="nv">strings</span>
      <span class="nv">collect</span> <span class="p">(</span><span class="nv">regex-replace</span> <span class="err">#</span><span class="nv">?r/^\s+/</span>
                                      <span class="p">(</span><span class="nv">regex-replace</span> <span class="err">#</span><span class="nv">?r/\s+$/</span> <span class="nb">string</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
                                      <span class="s">&quot;&quot;</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">setf</span> <span class="nb">string</span> <span class="p">(</span><span class="nv">trim</span> <span class="nb">string</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">many</span> <span class="p">(</span><span class="nb">multiple-value-list</span> <span class="p">(</span><span class="nb">apply</span> <span class="ss">&#39;trim</span> <span class="nv">many</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; print what&#39;s typed, but surrounded by &gt;&lt; symbols</span>
<span class="p">(</span><span class="nb">loop</span>
   <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">line</span> <span class="p">(</span><span class="nb">read-line</span><span class="p">)))</span>
     <span class="p">(</span><span class="nv">chomp</span> <span class="nv">line</span><span class="p">)</span>
     <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="err">#</span><span class="nv">?</span><span class="s">&quot;&gt;$(line)&lt;~%&quot;</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_1.15</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">parse-csv</span> <span class="p">(</span><span class="nv">text</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">(</span><span class="nv">fields</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">cl-ppcre:do-register-groups</span> <span class="p">(</span><span class="nv">quoted</span> <span class="nv">unquoted</span><span class="p">)</span>
        <span class="p">(</span><span class="s">&quot;\&quot;([^\&quot;\\\\]*(?:\\\\.[^\&quot;\\\\]*)*)\&quot;,?|([^,]+),?|,&quot;</span> <span class="nv">text</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">push</span> <span class="p">(</span><span class="nb">or</span> <span class="nv">quoted</span> <span class="nv">unquoted</span><span class="p">)</span> <span class="nv">fields</span><span class="p">))</span>
    <span class="p">(</span><span class="nb">nreverse</span> <span class="nv">fields</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; CL has no obvious equivalent to Text::ParseWords</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*line*</span> <span class="s">&quot;XYZZY,\&quot;\&quot;,\&quot;O&#39;Reilly, Inc\&quot;,\&quot;Wall, Larry\&quot;,\&quot;a \\\&quot;glug\\\&quot; bit,\&quot;,5,\&quot;Error, Core Dumped\&quot;&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">fields</span> <span class="p">(</span><span class="nv">parse-csv</span> <span class="vg">*line*</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">loop</span>
     <span class="nv">for</span> <span class="nv">i</span> <span class="nv">below</span> <span class="p">(</span><span class="nb">length</span> <span class="nv">fields</span><span class="p">)</span>
     <span class="nb">do</span> <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~D : ~A~%&quot;</span> <span class="nv">i</span> <span class="p">(</span><span class="nb">elt</span> <span class="nv">fields</span> <span class="nv">i</span><span class="p">))))</span>
<span class="c1">;;0 : XYZZY</span>
<span class="c1">;;1 :</span>
<span class="c1">;;2 : O&#39;Reilly, Inc</span>
<span class="c1">;;3 : Wall, Larry</span>
<span class="c1">;;4 : a \&quot;glug\&quot; bit,</span>
<span class="c1">;;5 : 5</span>
<span class="c1">;;6 : Error, Core Dumped</span>
<span class="c1">;;;-----------------------------</span>


<span class="c1">;;; @@PLEAC@@_1.16</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">system-users</span> <span class="p">()</span>
  <span class="p">(</span><span class="nb">with-open-file</span> <span class="p">(</span><span class="nv">in</span> <span class="s">&quot;/etc/passwd&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">line</span> <span class="nb">=</span> <span class="p">(</span><span class="nb">read-line</span> <span class="nv">in</span> <span class="no">nil</span> <span class="no">nil</span><span class="p">)</span>
          <span class="nv">while</span> <span class="nv">line</span> <span class="nv">collect</span> <span class="p">(</span><span class="nv">ppcre:split</span> <span class="s">&quot;:&quot;</span> <span class="nv">line</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">soundex</span> <span class="p">(</span><span class="nb">string</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">soundex:soundex</span>
   <span class="p">(</span><span class="nb">with-output-to-string</span> <span class="p">(</span><span class="nv">out</span><span class="p">)</span>
     <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nb">char</span> <span class="nv">across</span> <span class="nb">string</span>
           <span class="nb">when</span> <span class="p">(</span><span class="nb">alphanumericp</span> <span class="nb">char</span><span class="p">)</span>
             <span class="nb">do</span> <span class="p">(</span><span class="nb">format</span> <span class="nv">out</span> <span class="s">&quot;~C&quot;</span> <span class="nb">char</span><span class="p">)))))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">lookup-user</span> <span class="p">(</span><span class="nv">user</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">user-code</span> <span class="p">(</span><span class="nv">soundex</span> <span class="nv">user</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">user-spec</span> <span class="p">(</span><span class="nv">system-users</span><span class="p">))</span>
    <span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">user-name</span> <span class="p">(</span><span class="nv">ppcre:split</span> <span class="s">&quot;\\s+&quot;</span> <span class="p">(</span><span class="nb">elt</span> <span class="nv">user-spec</span> <span class="mi">4</span><span class="p">)))</span>
      <span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nb">mismatch</span> <span class="nv">user-code</span> <span class="p">(</span><span class="nv">soundex</span> <span class="nv">user-name</span><span class="p">))</span>
        <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;User: ~S. (Matched Token: ~S.)~%&quot;</span>
                <span class="p">(</span><span class="nb">elt</span> <span class="nv">user-spec</span> <span class="mi">0</span><span class="p">)</span> <span class="nv">user-name</span><span class="p">))))))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">prompt-read</span> <span class="p">(</span><span class="nv">prompt</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">format</span> <span class="vg">*query-io*</span> <span class="s">&quot;~A: &quot;</span> <span class="nv">prompt</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">force-output</span> <span class="vg">*query-io*</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">read-line</span> <span class="vg">*query-io*</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">prompt-lookup-user</span> <span class="p">()</span>
  <span class="p">(</span><span class="nv">lookup-user</span> <span class="p">(</span><span class="nv">prompt-read</span> <span class="s">&quot;Lookup user&quot;</span><span class="p">)))</span>

<span class="c1">; TEST&gt; (prompt-lookup-user)</span>
<span class="c1">; Lookup user: volkan</span>
<span class="c1">; User: &quot;vy&quot;. (Matched Token: &quot;Volkan&quot;.)</span>


<span class="c1">;;; @@PLEAC@@_1.17</span>
<span class="p">(</span><span class="nb">defvar</span> <span class="vg">*replacements*</span>
  <span class="o">&#39;</span><span class="p">((</span><span class="s">&quot;analysed&quot;</span>        <span class="o">.</span> <span class="s">&quot;analyzed&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;built-in&quot;</span>        <span class="o">.</span> <span class="s">&quot;builtin&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;chastized&quot;</span>       <span class="o">.</span> <span class="s">&quot;chastised&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;commandline&quot;</span>     <span class="o">.</span> <span class="s">&quot;command-line&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;de-allocate&quot;</span>     <span class="o">.</span> <span class="s">&quot;deallocate&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;dropin&quot;</span>          <span class="o">.</span> <span class="s">&quot;drop-in&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;hardcode&quot;</span>        <span class="o">.</span> <span class="s">&quot;hard-code&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;meta-data&quot;</span>       <span class="o">.</span> <span class="s">&quot;metadata&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;multicharacter&quot;</span>  <span class="o">.</span> <span class="s">&quot;multi-character&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;multiway&quot;</span>        <span class="o">.</span> <span class="s">&quot;multi-way&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;non-empty&quot;</span>       <span class="o">.</span> <span class="s">&quot;nonempty&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;non-profit&quot;</span>      <span class="o">.</span> <span class="s">&quot;nonprofit&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;non-trappable&quot;</span>   <span class="o">.</span> <span class="s">&quot;nontrappable&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;pre-define&quot;</span>      <span class="o">.</span> <span class="s">&quot;predefine&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;preextend&quot;</span>       <span class="o">.</span> <span class="s">&quot;pre-extend&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;re-compiling&quot;</span>    <span class="o">.</span> <span class="s">&quot;recompiling&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;reenter&quot;</span>         <span class="o">.</span> <span class="s">&quot;re-enter&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;turnkey&quot;</span>         <span class="o">.</span> <span class="s">&quot;turn-key&quot;</span><span class="p">)))</span>

<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">scanner</span>
       <span class="p">(</span><span class="nv">ppcre:create-scanner</span>
        <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;(~{~A~^|~})&quot;</span> <span class="p">(</span><span class="nb">mapcar</span> <span class="nf">#&#39;</span><span class="nb">car</span> <span class="vg">*replacements*</span><span class="p">)))))</span>
  <span class="p">(</span><span class="nb">defun</span> <span class="nv">apply-replacements</span> <span class="p">(</span><span class="nb">string</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">ppcre:regex-replace-all</span>
     <span class="nv">scanner</span> <span class="nb">string</span>
     <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">target-string</span> <span class="nv">start</span> <span class="nv">end</span> <span class="nv">match-start</span> <span class="nv">match-end</span> <span class="nv">reg-starts</span> <span class="nv">reg-ends</span><span class="p">)</span>
       <span class="p">(</span><span class="k">declare</span> <span class="p">(</span><span class="k">ignore</span> <span class="nv">start</span> <span class="nv">end</span> <span class="nv">reg-starts</span> <span class="nv">reg-ends</span><span class="p">))</span>
       <span class="p">(</span><span class="nb">cdr</span> <span class="p">(</span><span class="nb">find</span> <span class="p">(</span><span class="nb">make-array</span> <span class="p">(</span><span class="nb">-</span> <span class="nv">match-end</span> <span class="nv">match-start</span><span class="p">)</span>
                              <span class="ss">:element-type</span> <span class="p">(</span><span class="nb">array-element-type</span> <span class="nv">target-string</span><span class="p">)</span>
                              <span class="ss">:displaced-to</span> <span class="nv">target-string</span>
                              <span class="ss">:displaced-index-offset</span> <span class="nv">match-start</span><span class="p">)</span>
                  <span class="vg">*replacements*</span> <span class="ss">:test</span> <span class="nf">#&#39;</span><span class="nb">string-equal</span> <span class="ss">:key</span> <span class="nf">#&#39;</span><span class="nb">car</span><span class="p">))))))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">replace-stream</span> <span class="p">(</span><span class="nv">in</span> <span class="nv">out</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">line</span> <span class="nb">=</span> <span class="p">(</span><span class="nb">read-line</span> <span class="nv">in</span> <span class="no">nil</span> <span class="no">nil</span><span class="p">)</span>
        <span class="nv">while</span> <span class="nv">line</span> <span class="nb">do</span> <span class="p">(</span><span class="nb">format</span> <span class="nv">out</span> <span class="s">&quot;~&amp;~A&quot;</span> <span class="p">(</span><span class="nv">apply-replacements</span> <span class="nv">line</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">with-input-from-string</span>
    <span class="p">(</span><span class="nc">stream</span>
     <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;~{~&amp;~A~}&quot;</span>
             <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;If I have analysed these built-in&quot;</span>
               <span class="s">&quot;results correctly in a chastized manner&quot;</span>
               <span class="s">&quot;from commandline&quot;</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">with-output-to-string</span> <span class="p">(</span><span class="nv">out</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">replace-stream</span> <span class="nc">stream</span> <span class="nv">out</span><span class="p">)))</span>
<span class="c1">; =&gt; &quot;If I have analyzed these builtin</span>
<span class="c1">;     results correctly in a chastised manner</span>
<span class="c1">;     from command-line&quot;</span>


<span class="c1">;;; @@PLEAC@@_1.18</span>
<span class="p">(</span><span class="nb">defvar</span> <span class="vg">*ps-fields*</span>
  <span class="o">&#39;</span><span class="p">((</span><span class="nv">flags</span>   <span class="o">.</span> <span class="nc">integer</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">uid</span>     <span class="o">.</span> <span class="nc">integer</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">pid</span>     <span class="o">.</span> <span class="nc">integer</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">ppid</span>    <span class="o">.</span> <span class="nc">integer</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">pri</span>     <span class="o">.</span> <span class="nc">integer</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">nice</span>    <span class="o">.</span> <span class="nc">integer</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">size</span>    <span class="o">.</span> <span class="nc">integer</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">rss</span>     <span class="o">.</span> <span class="nc">integer</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">wchan</span>   <span class="o">.</span> <span class="nb">string</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">stat</span>    <span class="o">.</span> <span class="nb">string</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">tty</span>     <span class="o">.</span> <span class="nb">string</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">time</span>    <span class="o">.</span> <span class="nb">string</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">command</span> <span class="o">.</span> <span class="nb">string</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">format-ps-fields</span> <span class="p">(</span><span class="nv">fields</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">mapcar</span>
   <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">field-type</span> <span class="nv">field</span><span class="p">)</span>
     <span class="p">(</span><span class="nb">ecase</span> <span class="nv">field-type</span>
       <span class="p">(</span><span class="nc">integer</span> <span class="p">(</span><span class="nb">parse-integer</span> <span class="nv">field</span> <span class="ss">:junk-allowed</span> <span class="no">t</span><span class="p">))</span>
       <span class="p">(</span><span class="nb">string</span> <span class="nv">field</span><span class="p">)))</span>
   <span class="p">(</span><span class="nb">mapcar</span> <span class="nf">#&#39;</span><span class="nb">cdr</span> <span class="vg">*ps-fields*</span><span class="p">)</span>
   <span class="nv">fields</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">ps</span> <span class="p">()</span>
  <span class="p">(</span><span class="nb">with-input-from-string</span>
      <span class="p">(</span><span class="nv">in</span>
       <span class="p">(</span><span class="nv">trivial-shell:shell-command</span>
        <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;ps -o ~{~(~A~)~^,~}&quot;</span> <span class="p">(</span><span class="nb">mapcar</span> <span class="nf">#&#39;</span><span class="nb">car</span> <span class="vg">*ps-fields*</span><span class="p">))))</span>
    <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">header</span> <span class="p">(</span><span class="nb">read-line</span> <span class="nv">in</span> <span class="no">nil</span> <span class="no">nil</span><span class="p">))</span>
          <span class="p">(</span><span class="nv">lines</span> <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">line</span> <span class="nb">=</span> <span class="p">(</span><span class="nb">read-line</span> <span class="nv">in</span> <span class="no">nil</span> <span class="no">nil</span><span class="p">)</span>
                       <span class="nv">while</span> <span class="nv">line</span> <span class="nv">collect</span> <span class="nv">line</span><span class="p">)))</span>
      <span class="p">(</span><span class="nb">values</span> <span class="p">(</span><span class="nb">mapcar</span> <span class="nf">#&#39;</span><span class="nv">format-ps-fields</span>
                      <span class="p">(</span><span class="nb">mapcar</span>
                       <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">limit</span> <span class="p">(</span><span class="nb">length</span> <span class="vg">*ps-fields*</span><span class="p">)))</span>
                         <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">line</span><span class="p">)</span> <span class="p">(</span><span class="nv">ppcre:split</span> <span class="s">&quot;\\s+&quot;</span> <span class="nv">line</span> <span class="ss">:limit</span> <span class="nv">limit</span><span class="p">)))</span>
                       <span class="nv">lines</span><span class="p">))</span>
              <span class="nv">header</span> <span class="nv">lines</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">defmacro</span> <span class="nv">ps-grep</span> <span class="p">(</span><span class="nv">expr</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">alexandria:with-unique-names</span> <span class="p">(</span><span class="nv">header-printed-p</span> <span class="nv">entries</span> <span class="nv">entry</span> <span class="nv">header</span> <span class="nv">lines</span> <span class="nv">line</span><span class="p">)</span>
    <span class="o">`</span><span class="p">(</span><span class="k">let</span> <span class="p">(</span><span class="o">,</span><span class="nv">header-printed-p</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">multiple-value-bind</span> <span class="p">(</span><span class="o">,</span><span class="nv">entries</span> <span class="o">,</span><span class="nv">header</span> <span class="o">,</span><span class="nv">lines</span><span class="p">)</span> <span class="p">(</span><span class="nv">ps</span><span class="p">)</span>
         <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="o">,</span><span class="nv">entry</span> <span class="nv">in</span> <span class="o">,</span><span class="nv">entries</span>
               <span class="nv">for</span> <span class="o">,</span><span class="nv">line</span> <span class="nv">in</span> <span class="o">,</span><span class="nv">lines</span>
               <span class="nb">when</span> <span class="p">(</span><span class="nb">destructuring-bind</span> <span class="o">,</span><span class="p">(</span><span class="nb">mapcar</span> <span class="nf">#&#39;</span><span class="nb">car</span> <span class="vg">*ps-fields*</span><span class="p">)</span> <span class="o">,</span><span class="nv">entry</span>
                      <span class="p">(</span><span class="k">declare</span> <span class="p">(</span><span class="k">ignorable</span> <span class="o">,@</span><span class="p">(</span><span class="nb">mapcar</span> <span class="nf">#&#39;</span><span class="nb">car</span> <span class="vg">*ps-fields*</span><span class="p">)))</span>
                      <span class="o">,</span><span class="nv">expr</span><span class="p">)</span>
                 <span class="nb">do</span> <span class="p">(</span><span class="nb">unless</span> <span class="o">,</span><span class="nv">header-printed-p</span>
                      <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A~%&quot;</span> <span class="o">,</span><span class="nv">header</span><span class="p">)</span>
                      <span class="p">(</span><span class="k">setq</span> <span class="o">,</span><span class="nv">header-printed-p</span> <span class="no">t</span><span class="p">))</span>
                    <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A~%&quot;</span> <span class="o">,</span><span class="nv">line</span><span class="p">))))))</span>

<span class="p">(</span><span class="nv">ps-grep</span> <span class="p">(</span><span class="nb">and</span> <span class="p">(</span><span class="nb">&lt;</span> <span class="mi">2220</span> <span class="nv">rss</span><span class="p">)</span> <span class="p">(</span><span class="nb">=</span> <span class="nv">flags</span> <span class="mi">1</span><span class="p">)))</span>
<span class="c1">; =&gt; F   UID   PID  PPID PRI  NI    SZ   RSS WCHAN  STAT TT           TIME COMMAND</span>
<span class="c1">;    1  1000  2931     1  19   0   828  2644 -      Ss   ?        00:00:03 /usr/bin/fetchmail --daemon 600 --logfile /home/vy/.fetchmail.log</span>
<span class="c1">;    1  1000  3106  3104  19   0  1700  2360 -      Ss   ?        00:00:09 SCREEN -U</span>


<span class="c1">;;; @@PLEAC@@_2.1</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">every</span> <span class="nf">#&#39;</span><span class="nb">digit-char-p</span> <span class="nb">string</span><span class="p">)</span>
    <span class="p">(</span><span class="k">progn</span>
      <span class="c1">;; is a number</span>
      <span class="p">)</span>
    <span class="p">(</span><span class="k">progn</span>
      <span class="c1">;; is not</span>
      <span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;;; Strings and numbers are separate data types in CL. These tests</span>
<span class="c1">;;; check whether a string represents a number</span>
<span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nb">every</span> <span class="nf">#&#39;</span><span class="nb">digit-char-p</span> <span class="nb">string</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">format</span> <span class="vg">*error-output*</span> <span class="s">&quot;string has nondigits&quot;</span><span class="p">))</span>
<span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nv">scan</span> <span class="s">&quot;^\\d+$&quot;</span> <span class="nb">string</span><span class="p">)</span> <span class="c1">; rejects -3</span>
  <span class="p">(</span><span class="nb">format</span> <span class="vg">*error-output*</span> <span class="s">&quot;not a natural number&quot;</span><span class="p">))</span>
<span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nv">scan</span> <span class="s">&quot;^-?\\d+$&quot;</span> <span class="nb">string</span><span class="p">)</span> <span class="c1">; rejects +3</span>
  <span class="p">(</span><span class="nb">format</span> <span class="vg">*error-output*</span> <span class="s">&quot;not an integer&quot;</span><span class="p">))</span>
<span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nv">scan</span> <span class="s">&quot;^[+-]?\\d+$&quot;</span> <span class="nb">string</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">format</span> <span class="vg">*error-output*</span> <span class="s">&quot;not an integer&quot;</span><span class="p">))</span>
<span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nv">scan</span> <span class="s">&quot;^-?(?:\\d+(?:\\.\\d*)?|\\.\\d+)$&quot;</span> <span class="nb">string</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">format</span> <span class="vg">*error-output*</span> <span class="s">&quot;not an integer&quot;</span><span class="p">))</span>
<span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nv">scan</span> <span class="s">&quot;^([+-]?)(?=\\d|\\.\\d)\\d*(\\.\\d*)?([Ee]([+-]?\\d+))?$&quot;</span>
                       <span class="nb">string</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">format</span> <span class="vg">*error-output*</span> <span class="s">&quot;not a C float&quot;</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">getnum</span> <span class="p">(</span><span class="nb">string</span><span class="p">)</span>
  <span class="s">&quot;This function is not safe to call on untrusted input.&quot;</span>
  <span class="p">(</span><span class="nb">with-input-from-string</span>
      <span class="p">(</span><span class="nv">is</span> <span class="p">(</span><span class="nv">regex-replace</span> <span class="err">#</span><span class="nv">?</span><span class="s">&quot;\s+$&quot;</span>
                                  <span class="p">(</span><span class="nv">regex-replace</span> <span class="err">#</span><span class="nv">?</span><span class="s">&quot;^\s+&quot;</span> <span class="nb">string</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="s">&quot;&quot;</span><span class="p">))</span>
    <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">num</span> <span class="p">(</span><span class="nb">read</span> <span class="nv">is</span> <span class="no">nil</span> <span class="no">nil</span> <span class="no">nil</span><span class="p">)))</span>
      <span class="p">(</span><span class="nb">and</span>
       <span class="c1">;; Make sure there&#39;s no junk following the number</span>
       <span class="p">(</span><span class="nb">eql</span> <span class="p">(</span><span class="nb">read-char</span> <span class="nv">is</span> <span class="no">nil</span> <span class="ss">:eof</span> <span class="no">nil</span><span class="p">)</span> <span class="ss">:eof</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">numberp</span> <span class="nv">num</span><span class="p">)</span>
       <span class="nv">num</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">is-numeric</span> <span class="p">(</span><span class="nb">string</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">not</span> <span class="p">(</span><span class="nb">null</span> <span class="p">(</span><span class="nv">getnum</span> <span class="nb">string</span><span class="p">))))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_2.2</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">equal-to-accuracy</span> <span class="p">(</span><span class="nv">number1</span> <span class="nv">number2</span> <span class="nv">dp</span><span class="p">)</span>
  <span class="s">&quot;Return non-nil if NUMBER1 and NUMBER2 are equal to DP number of</span>
<span class="s">decimal places.&quot;</span>
  <span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="nv">difference</span> <span class="p">(</span><span class="nb">abs</span> <span class="p">(</span><span class="nb">-</span> <span class="nv">number1</span> <span class="nv">number2</span><span class="p">)))</span>
         <span class="p">(</span><span class="nv">delta</span> <span class="p">(</span><span class="nb">expt</span> <span class="mi">10</span> <span class="p">(</span><span class="nb">-</span> <span class="nv">dp</span><span class="p">))))</span>
    <span class="p">(</span><span class="nb">&lt;</span> <span class="nv">difference</span> <span class="nv">delta</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="nv">wage</span> <span class="mi">536</span><span class="p">)</span>                       <span class="c1">; $5.36/hour</span>
       <span class="p">(</span><span class="nv">week</span> <span class="p">(</span><span class="nb">*</span> <span class="mi">40</span> <span class="nv">wage</span><span class="p">)))</span>              <span class="c1">; $214.40</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;One week&#39;s wage is: $~,2F~%&quot;</span> <span class="p">(</span><span class="nb">/</span> <span class="nv">week</span> <span class="mi">100</span><span class="p">)))</span>
<span class="c1">;;One week&#39;s wage is: $214.40</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_2.3</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">rounded</span> <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;~FORMATF&quot;</span> <span class="nv">unrounded</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="nv">a</span> <span class="mf">0.255</span><span class="p">)</span>
       <span class="p">(</span><span class="nv">b</span> <span class="p">(</span><span class="nb">/</span> <span class="p">(</span><span class="nb">fround</span> <span class="nv">a</span> <span class="mf">0.01</span><span class="p">)</span> <span class="mi">100</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;Unrounded: ~F~%Rounded: ~,2F~%&quot;</span> <span class="nv">a</span> <span class="nv">b</span><span class="p">))</span>
<span class="c1">;;Unrounded: 0.255</span>
<span class="c1">;;Rounded: 0.26</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">progn</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~&amp;number~Tint~Tfloor~Tceil~%&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">as</span> <span class="o">&#39;</span><span class="p">(</span><span class="mf">3.3</span> <span class="mf">3.5</span> <span class="mf">3.7</span> <span class="mf">-3.3</span><span class="p">)))</span>
    <span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">a</span> <span class="nv">as</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~@{~4,1F~^~T~}~%&quot;</span>
              <span class="nv">a</span>
              <span class="p">(</span><span class="nb">ftruncate</span> <span class="nv">a</span><span class="p">)</span>
              <span class="p">(</span><span class="nb">ffloor</span> <span class="nv">a</span><span class="p">)</span>
              <span class="p">(</span><span class="nb">fceiling</span> <span class="nv">a</span><span class="p">)))))</span>
<span class="c1">;;number int floor ceil</span>
<span class="c1">;; 3.3  3.0  3.0  4.0</span>
<span class="c1">;; 3.5  3.0  3.0  4.0</span>
<span class="c1">;; 3.7  3.0  3.0  4.0</span>
<span class="c1">;;-3.3 -3.0 -4.0 -3.0</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_2.4</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">dec2bin</span> <span class="p">(</span><span class="nv">dec</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;~2R&quot;</span> <span class="nv">dec</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">bin2dec</span> <span class="p">(</span><span class="nv">bin</span><span class="p">)</span>
  <span class="s">&quot;BIN is a string containing only #\1 and #\0 characters.  Returns</span>
<span class="s">its integer equivalent.&quot;</span>
  <span class="p">(</span><span class="nb">read</span> <span class="p">(</span><span class="nb">make-string-input-stream</span> <span class="p">(</span><span class="nb">concatenate</span> <span class="ss">&#39;string</span> <span class="s">&quot;#b&quot;</span> <span class="nv">bin</span><span class="p">))</span>
        <span class="no">t</span> <span class="no">nil</span> <span class="no">nil</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">num</span> <span class="p">(</span><span class="nv">bin2dec</span> <span class="s">&quot;0110110&quot;</span><span class="p">))</span>          <span class="c1">; $num is 54</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">binstr</span> <span class="p">(</span><span class="nv">dec2bin</span> <span class="mi">54</span><span class="p">))</span>              <span class="c1">; binstr is &quot;110110&quot;</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @PLEAC@@_2.5</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">seq</span> <span class="p">(</span><span class="nv">start</span> <span class="nv">end</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">i</span> <span class="nv">from</span> <span class="nv">start</span> <span class="nv">to</span> <span class="nv">end</span> <span class="nv">collect</span> <span class="nv">i</span><span class="p">))</span>

<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;Infancy is: ~{~A~^ ~}~%&quot;</span> <span class="p">(</span><span class="nv">seq</span> <span class="mi">0</span> <span class="mi">2</span><span class="p">))</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;Toddling is: ~{~A~^ ~}~%&quot;</span> <span class="p">(</span><span class="nv">seq</span> <span class="mi">3</span> <span class="mi">4</span><span class="p">))</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;Childhood is: ~{~A~^ ~}~%&quot;</span> <span class="p">(</span><span class="nv">seq</span> <span class="mi">5</span> <span class="mi">12</span><span class="p">))</span>
<span class="c1">; =&gt; Infancy is: 0 1 2</span>
<span class="c1">;    Toddling is: 3 4</span>
<span class="c1">;    Childhood is: 5 6 7 8 9 10 11 12</span>


<span class="c1">;;; @@PLEAC@@_2.6</span>
<span class="c1">;;; CL has a built in FORMAT directive (used below) to print out</span>
<span class="c1">;;; numbers as roman numerals, but doesn&#39;t have a built-in mechanism</span>
<span class="c1">;;; to convert back.  Here are some rough CL equivalents of Perl&#39;s</span>
<span class="c1">;;; Roman package.</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">romanchar-&gt;num</span> <span class="p">(</span><span class="nv">x</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">case</span> <span class="p">(</span><span class="nb">char-downcase</span> <span class="nv">x</span><span class="p">)</span>
    <span class="p">(</span><span class="sc">#\m</span> <span class="mi">1000</span><span class="p">)</span>
    <span class="p">(</span><span class="sc">#\d</span> <span class="mi">500</span><span class="p">)</span>
    <span class="p">(</span><span class="sc">#\c</span> <span class="mi">100</span><span class="p">)</span>
    <span class="p">(</span><span class="sc">#\l</span> <span class="mi">50</span><span class="p">)</span>
    <span class="p">(</span><span class="sc">#\x</span> <span class="mi">10</span><span class="p">)</span>
    <span class="p">(</span><span class="sc">#\v</span> <span class="mi">5</span><span class="p">)</span>
    <span class="p">(</span><span class="sc">#\i</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">(</span><span class="no">t</span> <span class="mi">0</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">isroman</span> <span class="p">(</span><span class="nb">string</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">every</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">c</span><span class="p">)</span>
             <span class="p">(</span><span class="nb">plusp</span> <span class="p">(</span><span class="nv">romanchar-&gt;num</span> <span class="nv">c</span><span class="p">)))</span>
         <span class="nb">string</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">arabic</span> <span class="p">(</span><span class="nb">string</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">digits</span> <span class="p">(</span><span class="nb">map</span> <span class="ss">&#39;list</span> <span class="nf">#&#39;</span><span class="nv">romanchar-&gt;num</span> <span class="nb">string</span><span class="p">)))</span>
    <span class="p">(</span><span class="nb">reduce</span> <span class="nf">#&#39;</span><span class="nb">+</span> <span class="p">(</span><span class="nb">mapcar</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">digit</span> <span class="nv">next-digit</span><span class="p">)</span>
                            <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">&lt;</span> <span class="nv">digit</span> <span class="nv">next-digit</span><span class="p">)</span>
                                <span class="p">(</span><span class="nb">-</span> <span class="nv">digit</span><span class="p">)</span>
                                <span class="nv">digit</span><span class="p">))</span>
                        <span class="nv">digits</span>
                        <span class="p">(</span><span class="nb">append</span> <span class="p">(</span><span class="nb">rest</span> <span class="nv">digits</span><span class="p">)</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">0</span><span class="p">))))))</span>

<span class="p">(</span><span class="nb">setf</span> <span class="nv">roman</span> <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;~@R&quot;</span> <span class="nv">arabic</span><span class="p">))</span>  <span class="c1">; convert to roman numerals</span>
<span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nv">isroman</span> <span class="nv">roman</span><span class="p">)</span> <span class="p">(</span><span class="nb">setf</span> <span class="nv">arabic</span> <span class="p">(</span><span class="nv">arabic</span> <span class="nv">roman</span><span class="p">)))</span> <span class="c1">; convert from roman numerals</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">roman-fifteen</span> <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;~@R&quot;</span> <span class="mi">15</span><span class="p">))</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;Roman for fifteen is ~A~%&quot;</span> <span class="nv">roman-fifteen</span><span class="p">)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">arabic-fifteen</span> <span class="p">(</span><span class="nv">arabic</span> <span class="nv">roman-fifteen</span><span class="p">))</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;Converted back, ~A is ~A~%&quot;</span> <span class="nv">roman-fifteen</span> <span class="nv">arabic-fifteen</span><span class="p">)</span>
<span class="c1">;;Roman for fifteen is XV</span>
<span class="c1">;;Converted back, XV is 15</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_2.7</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nb">random</span> <span class="p">(</span><span class="nb">+</span> <span class="p">(</span><span class="nb">random</span> <span class="p">(</span><span class="nb">+</span> <span class="nv">y</span> <span class="p">(</span><span class="nb">-</span> <span class="nv">x</span><span class="p">)</span> <span class="mi">1</span><span class="p">))</span> <span class="nv">x</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nb">random</span> <span class="p">(</span><span class="nb">+</span> <span class="p">(</span><span class="nb">random</span> <span class="mi">51</span><span class="p">)</span> <span class="mi">25</span><span class="p">))</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A~%&quot;</span> <span class="nb">random</span><span class="p">)</span>
<span class="c1">;; If you wanted to use floats...</span>
<span class="p">(</span><span class="nb">+</span> <span class="p">(</span><span class="nb">random</span> <span class="mf">51.0</span><span class="p">)</span> <span class="mf">25.0</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nb">elt</span> <span class="p">(</span><span class="nb">aref</span> <span class="nc">array</span> <span class="p">(</span><span class="nb">random</span> <span class="p">(</span><span class="nb">length</span> <span class="nc">array</span><span class="p">))))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">chars</span> <span class="s">&quot;ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz012345789!@$%^&amp;*&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">password</span> <span class="p">(</span><span class="nb">coerce</span> <span class="p">(</span><span class="nb">loop</span> <span class="nv">repeat</span> <span class="mi">8</span> <span class="nv">collect</span> <span class="p">(</span><span class="nb">aref</span> <span class="nv">chars</span> <span class="p">(</span><span class="nb">random</span> <span class="p">(</span><span class="nb">length</span> <span class="nv">chars</span><span class="p">))))</span> <span class="ss">&#39;string</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_2.8</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; CL intentionally does not have an equivalent of Perl&#39;s srand(); you</span>
<span class="c1">;; can call MAKE-RANDOM-STATE but its inner workings are not exposed.</span>
<span class="p">(</span><span class="nb">setf</span> <span class="vg">*random-state*</span> <span class="p">(</span><span class="nb">make-random-state</span> <span class="no">t</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_2.9</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; In CL, RANDOM is supposed to return a truly random,</span>
<span class="c1">;; uniformly-distributed value.</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nb">random</span> <span class="p">(</span><span class="nb">random</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_2.10</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Note: (random 1.0) is the same as calling Perl&#39;s rand() with no</span>
<span class="c1">;; arguments.</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">gaussian-rand</span> <span class="p">()</span>
  <span class="p">(</span><span class="nb">do*</span> <span class="p">((</span><span class="nv">u1</span> <span class="p">(</span><span class="nb">1-</span> <span class="p">(</span><span class="nb">*</span> <span class="mi">2</span> <span class="p">(</span><span class="nb">random</span> <span class="mf">1.0</span><span class="p">)))</span>
            <span class="p">(</span><span class="nb">1-</span> <span class="p">(</span><span class="nb">*</span> <span class="mi">2</span> <span class="p">(</span><span class="nb">random</span> <span class="mf">1.0</span><span class="p">))))</span>
        <span class="p">(</span><span class="nv">u2</span> <span class="p">(</span><span class="nb">1-</span> <span class="p">(</span><span class="nb">*</span> <span class="mi">2</span> <span class="p">(</span><span class="nb">random</span> <span class="mf">1.0</span><span class="p">)))</span>
            <span class="p">(</span><span class="nb">1-</span> <span class="p">(</span><span class="nb">*</span> <span class="mi">2</span> <span class="p">(</span><span class="nb">random</span> <span class="mf">1.0</span><span class="p">))))</span>
        <span class="p">(</span><span class="nv">w</span> <span class="p">(</span><span class="nb">+</span> <span class="p">(</span><span class="nb">*</span> <span class="nv">u1</span> <span class="nv">u1</span><span class="p">)</span> <span class="p">(</span><span class="nb">*</span> <span class="nv">u2</span> <span class="nv">u2</span><span class="p">))</span>
           <span class="p">(</span><span class="nb">+</span> <span class="p">(</span><span class="nb">*</span> <span class="nv">u1</span> <span class="nv">u1</span><span class="p">)</span> <span class="p">(</span><span class="nb">*</span> <span class="nv">u2</span> <span class="nv">u2</span><span class="p">))))</span>
       <span class="p">((</span><span class="nb">&lt;</span> <span class="nv">w</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="nv">w2</span> <span class="p">(</span><span class="nb">sqrt</span> <span class="p">(</span><span class="nb">/</span> <span class="p">(</span><span class="nb">*</span> <span class="mi">-2</span> <span class="p">(</span><span class="nb">log</span> <span class="nv">w</span><span class="p">))</span> <span class="nv">w</span><span class="p">)))</span>
               <span class="p">(</span><span class="nv">g2</span> <span class="p">(</span><span class="nb">*</span> <span class="nv">u1</span> <span class="nv">w2</span><span class="p">))</span>
               <span class="p">(</span><span class="nv">g1</span> <span class="p">(</span><span class="nb">*</span> <span class="nv">u2</span> <span class="nv">w2</span><span class="p">)))</span>
          <span class="c1">;; No need for wantarray in CL because functions can return</span>
          <span class="c1">;; multiple values.</span>
          <span class="p">(</span><span class="nb">values</span> <span class="nv">g1</span> <span class="nv">g2</span><span class="p">)))))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">weight-to-dist</span> <span class="p">(</span><span class="nv">weights</span><span class="p">)</span>
  <span class="s">&quot;Takes a hash mapping key to weight and returns a hash mapping key</span>
<span class="s">to probability.  WEIGHTS is an alist.&quot;</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">dist</span> <span class="p">(</span><span class="nb">make-hash-table</span><span class="p">))</span>
        <span class="p">(</span><span class="nv">total</span> <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="p">(</span><span class="nv">key</span> <span class="o">.</span> <span class="nv">ignored-value</span><span class="p">)</span> <span class="nv">in</span> <span class="nv">weights</span> <span class="nv">sum</span> <span class="nv">key</span><span class="p">)))</span>
    <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="p">(</span><span class="nv">key</span> <span class="o">.</span> <span class="nv">weight</span><span class="p">)</span> <span class="nv">in</span> <span class="nv">weights</span>
         <span class="nb">do</span> <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">key</span> <span class="nv">dist</span><span class="p">)</span> <span class="p">(</span><span class="nb">/</span> <span class="nv">weight</span> <span class="nv">total</span><span class="p">)))</span>
    <span class="nv">dist</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">weighted-rand</span> <span class="p">(</span><span class="nv">dist</span><span class="p">)</span>
  <span class="s">&quot;Takes a hash mapping key to probability, and returns the</span>
<span class="s">corresponding element.&quot;</span>
  <span class="p">(</span><span class="nb">loop</span>
     <span class="nv">for</span> <span class="nv">rand</span> <span class="nb">=</span> <span class="p">(</span><span class="nb">random</span> <span class="mf">1.0</span><span class="p">)</span>
     <span class="nb">do</span>
     <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">key</span> <span class="nv">being</span> <span class="k">the</span> <span class="nv">hash-keys</span> <span class="nv">of</span> <span class="nv">dist</span> <span class="nv">using</span> <span class="p">(</span><span class="nv">hash-value</span> <span class="nv">weight</span><span class="p">)</span>
        <span class="nb">do</span>
        <span class="p">(</span><span class="nb">decf</span> <span class="nv">rand</span> <span class="nv">weight</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">minusp</span> <span class="nv">rand</span><span class="p">)</span>
          <span class="p">(</span><span class="k">return-from</span> <span class="nv">weighted-rand</span> <span class="nv">key</span><span class="p">)))))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; gaussian_rand as above</span>
<span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="nv">mean</span> <span class="mi">25</span><span class="p">)</span>
       <span class="p">(</span><span class="nv">sdev</span> <span class="mi">2</span><span class="p">)</span>
       <span class="p">(</span><span class="nv">salary</span> <span class="p">(</span><span class="nb">+</span> <span class="p">(</span><span class="nb">*</span> <span class="p">(</span><span class="nv">gaussian-rand</span><span class="p">)</span> <span class="nv">sdev</span><span class="p">)</span> <span class="nv">mean</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;You have been hired at $~,2F~%&quot;</span> <span class="nv">salary</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_2.11</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">deg2rad</span> <span class="p">(</span><span class="nv">degrees</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">*</span> <span class="p">(</span><span class="nb">/</span> <span class="nv">degrees</span> <span class="mi">180</span><span class="p">)</span> <span class="nv">pi</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">rad2deg</span> <span class="p">(</span><span class="nv">radians</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">*</span> <span class="p">(</span><span class="nb">/</span> <span class="nv">radians</span> <span class="nv">pi</span><span class="p">)</span> <span class="mi">180</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">radians</span> <span class="p">(</span><span class="nv">deg2rad</span> <span class="nv">degrees</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">degrees</span> <span class="p">(</span><span class="nv">rad2deg</span> <span class="nv">radians</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; deg2rad and rad2deg defined either as above</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">degree-sine</span> <span class="p">(</span><span class="nv">degrees</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">radians</span> <span class="p">(</span><span class="nv">deg2rad</span> <span class="nv">degrees</span><span class="p">)))</span>
    <span class="p">(</span><span class="nb">sin</span> <span class="nv">radians</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_2.12</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; tangent is built in to CL</span>
<span class="p">(</span><span class="nb">tan</span> <span class="nv">theta</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">y</span> <span class="p">(</span><span class="nb">acos</span> <span class="mf">3.7</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">y</span> <span class="p">(</span><span class="nb">tan</span> <span class="p">(</span><span class="nb">/</span> <span class="nv">pi</span> <span class="mi">2</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_2.13</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">log-e</span> <span class="p">(</span><span class="nb">log</span> <span class="nv">value</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">log-10</span> <span class="p">(</span><span class="nb">log</span> <span class="nv">value</span> <span class="mi">10</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">log-base-whatever</span> <span class="p">(</span><span class="nb">log</span> <span class="nv">value</span> <span class="nv">base</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; In CL, don&#39;t need custom log_base function as LOG already does it</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">answer</span> <span class="p">(</span><span class="nb">log</span> <span class="mi">10000</span> <span class="mi">10</span><span class="p">))</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;log10(10,000) = ~D~%&quot;</span> <span class="nv">answer</span><span class="p">)</span>
<span class="c1">;; log10(10,000) = 4.0</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;log2(1024) = ~A~%&quot;</span> <span class="p">(</span><span class="nb">log</span> <span class="mi">1024</span> <span class="mi">2</span><span class="p">))</span>
<span class="c1">;; log2(1024) = 10.0</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_2.14</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">mmult</span> <span class="p">(</span><span class="nv">m1</span> <span class="nv">m2</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">check-type</span> <span class="nv">m1</span> <span class="p">(</span><span class="nc">array</span> <span class="nb">*</span> <span class="p">(</span><span class="nb">*</span> <span class="nb">*</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">check-type</span> <span class="nv">m2</span> <span class="p">(</span><span class="nc">array</span> <span class="nb">*</span> <span class="p">(</span><span class="nb">*</span> <span class="nb">*</span><span class="p">)))</span>
  <span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="nv">m1-rows</span> <span class="p">(</span><span class="nb">array-dimension</span> <span class="nv">m1</span> <span class="mi">0</span><span class="p">))</span>
         <span class="p">(</span><span class="nv">m1-columns</span> <span class="p">(</span><span class="nb">array-dimension</span> <span class="nv">m1</span> <span class="mi">1</span><span class="p">))</span>
         <span class="p">(</span><span class="nv">m2-rows</span> <span class="p">(</span><span class="nb">array-dimension</span> <span class="nv">m2</span> <span class="mi">0</span><span class="p">))</span>
         <span class="p">(</span><span class="nv">m2-columns</span> <span class="p">(</span><span class="nb">array-dimension</span> <span class="nv">m2</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nb">=</span> <span class="nv">m1-columns</span> <span class="nv">m2-rows</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">error</span> <span class="ss">&#39;simple-type-error</span>
             <span class="ss">:format-control</span> <span class="s">&quot;IndexError: matrices don&#39;t match: ~A != ~A&quot;</span>
             <span class="ss">:format-args</span> <span class="p">(</span><span class="nb">list</span> <span class="nv">m1-columns</span> <span class="nv">m2-rows</span><span class="p">)))</span>
    <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">result</span> <span class="p">(</span><span class="nb">make-array</span> <span class="p">(</span><span class="nb">list</span> <span class="nv">m1-rows</span> <span class="nv">m2-columns</span><span class="p">))))</span>
      <span class="p">(</span><span class="nb">dotimes</span> <span class="p">(</span><span class="nv">i</span> <span class="nv">m1-rows</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">dotimes</span> <span class="p">(</span><span class="nv">j</span> <span class="nv">m2-columns</span><span class="p">)</span>
          <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">aref</span> <span class="nv">result</span> <span class="nv">i</span> <span class="nv">j</span><span class="p">)</span>
                <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">k</span> <span class="nv">from</span> <span class="mi">0</span> <span class="nv">below</span> <span class="nv">m1-columns</span>
                      <span class="nv">summing</span> <span class="p">(</span><span class="nb">*</span> <span class="p">(</span><span class="nb">aref</span> <span class="nv">m1</span> <span class="nv">i</span> <span class="nv">k</span><span class="p">)</span> <span class="p">(</span><span class="nb">aref</span> <span class="nv">m2</span> <span class="nv">k</span> <span class="nv">j</span><span class="p">))))))</span>
      <span class="nv">result</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">range</span> <span class="p">(</span><span class="nv">n</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">i</span> <span class="nv">from</span> <span class="mi">0</span> <span class="nv">below</span> <span class="nv">n</span> <span class="nv">collect</span> <span class="nv">i</span><span class="p">))</span>

<span class="c1">;; This isn&#39;t really necessary in CL, but is here to match the Perl</span>
<span class="c1">;; function.</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">veclen</span> <span class="p">(</span><span class="nb">vector</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">check-type</span> <span class="nb">vector</span> <span class="kt">simple-vector</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">array-dimension</span> <span class="nb">vector</span> <span class="mi">0</span><span class="p">))</span>

<span class="c1">;; This isn&#39;t really necessary in CL, but is here to match the Perl</span>
<span class="c1">;; function.</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">matdim</span> <span class="p">(</span><span class="nv">matrix</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">values</span> <span class="p">(</span><span class="nb">array-dimension</span> <span class="nv">matrix</span> <span class="mi">0</span><span class="p">)</span>
          <span class="p">(</span><span class="nb">array-dimension</span> <span class="nv">matrix</span> <span class="mi">1</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Can&#39;t find an obvious equivalent to PDL (yet)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">x</span> <span class="l-Other">#2a</span><span class="p">((</span><span class="mi">3</span> <span class="mi">2</span> <span class="mi">3</span><span class="p">)</span>
            <span class="p">(</span><span class="mi">5</span> <span class="mi">9</span> <span class="mi">8</span><span class="p">))</span>
      <span class="nv">y</span> <span class="l-Other">#2a</span><span class="p">((</span><span class="mi">4</span> <span class="mi">7</span><span class="p">)</span>
            <span class="p">(</span><span class="mi">9</span> <span class="mi">3</span><span class="p">)</span>
            <span class="p">(</span><span class="mi">8</span> <span class="mi">1</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">setf</span> <span class="nv">z</span> <span class="p">(</span><span class="nv">mmult</span> <span class="nv">x</span> <span class="nv">y</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_2.15</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Complex numbers are built in to CL so there is no need to compute</span>
<span class="c1">;; their product by hand.</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; c = a * b using built-in CL functionality</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">c</span> <span class="p">(</span><span class="nb">*</span> <span class="nv">a</span> <span class="nv">b</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Again, no need to do complex number stuff by hand.</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">a</span> <span class="m">#c</span><span class="p">(</span><span class="mi">3</span> <span class="mi">5</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">b</span> <span class="m">#c</span><span class="p">(</span><span class="mi">2</span> <span class="mi">-2</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">c</span> <span class="p">(</span><span class="nb">*</span> <span class="nv">a</span> <span class="nv">b</span><span class="p">))</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;c = ~D+~Di~%&quot;</span> <span class="p">(</span><span class="nb">realpart</span> <span class="nv">c</span><span class="p">)</span> <span class="p">(</span><span class="nb">imagpart</span> <span class="nv">c</span><span class="p">))</span>
<span class="c1">;; c = 16+4i</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">c</span> <span class="p">(</span><span class="nb">*</span> <span class="m">#c</span><span class="p">(</span><span class="mi">3</span> <span class="mi">5</span><span class="p">)</span> <span class="m">#c</span><span class="p">(</span><span class="mi">2</span> <span class="mi">-2</span><span class="p">)))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">d</span> <span class="m">#c</span><span class="p">(</span><span class="mi">3</span> <span class="mi">4</span><span class="p">))</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">sqrt-d</span> <span class="p">(</span><span class="nb">sqrt</span> <span class="nv">d</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;sqrt(3+4i) = ~D+~Di~%&quot;</span> <span class="p">(</span><span class="nb">realpart</span> <span class="nv">sqrt-d</span><span class="p">)</span> <span class="p">(</span><span class="nb">imagpart</span> <span class="nv">sqrt-d</span><span class="p">)))</span>
<span class="c1">;; sqrt(3+4i) = 2.0+1.0i</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_2.16</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">hex</span> <span class="p">(</span><span class="nb">string</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">parse-integer</span> <span class="nb">string</span>
                 <span class="ss">:radix</span> <span class="mi">16</span>
                 <span class="ss">:start</span> <span class="mi">2</span><span class="p">))</span>             <span class="c1">; PARSE-INTEGER dislikes &quot;0x&quot;</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">oct</span> <span class="p">(</span><span class="nb">string</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">parse-integer</span> <span class="nb">string</span> <span class="ss">:radix</span> <span class="mi">8</span><span class="p">))</span>

<span class="p">(</span><span class="nb">setf</span> <span class="nc">number</span> <span class="p">(</span><span class="nv">hex</span> <span class="nv">hexadecimal</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nc">number</span> <span class="p">(</span><span class="nv">oct</span> <span class="nv">octal</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;Gimme a number in decimal, octal, or hex: &quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">num</span> <span class="p">(</span><span class="nb">read-line</span><span class="p">))</span>
<span class="p">(</span><span class="nb">when</span> <span class="nv">num</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">num</span> <span class="p">(</span><span class="nv">chomp</span> <span class="nv">num</span><span class="p">)))</span>
    <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~D ~:*~8R ~:*~X&quot;</span>
            <span class="p">(</span><span class="nb">cond</span>
              <span class="p">((</span><span class="nv">scan</span> <span class="s">&quot;^0x&quot;</span> <span class="nv">num</span><span class="p">)</span> <span class="p">(</span><span class="nv">hex</span> <span class="nv">num</span><span class="p">))</span>
              <span class="p">((</span><span class="nv">scan</span> <span class="s">&quot;^0&quot;</span> <span class="nv">num</span><span class="p">)</span> <span class="p">(</span><span class="nv">oct</span> <span class="nv">num</span><span class="p">))</span>
              <span class="p">(</span><span class="no">t</span> <span class="p">(</span><span class="nb">parse-integer</span> <span class="nv">num</span><span class="p">))))))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;Enter file permission in octal: &quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">permissions</span> <span class="p">(</span><span class="nb">read-line</span><span class="p">))</span>
<span class="p">(</span><span class="nb">unless</span> <span class="nv">permissions</span> <span class="p">(</span><span class="nb">error</span> <span class="s">&quot;Exiting...&quot;</span><span class="p">))</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">permissions</span> <span class="p">(</span><span class="nv">chomp</span> <span class="nv">permissions</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;The decimal value is ~A~%&quot;</span> <span class="p">(</span><span class="nv">oct</span> <span class="nv">permissions</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_2.17</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">comma-separated</span> <span class="p">(</span><span class="nv">input</span> <span class="k">&amp;optional</span> <span class="p">(</span><span class="nv">n-digits</span> <span class="mi">3</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">coerce</span>
   <span class="p">(</span><span class="nb">first</span>
    <span class="p">(</span><span class="nb">reduce</span>
     <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nb">char</span> <span class="nv">accum</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">format</span> <span class="vg">*trace-output*</span> <span class="s">&quot;~S, ~S~%&quot;</span> <span class="nv">accum</span> <span class="nb">char</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">destructuring-bind</span> <span class="p">(</span><span class="nv">chars</span> <span class="nv">pos</span><span class="p">)</span> <span class="nv">accum</span>
         <span class="p">(</span><span class="nb">list</span>
          <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">and</span> <span class="p">(</span><span class="nb">not</span> <span class="p">(</span><span class="nb">zerop</span> <span class="nv">pos</span><span class="p">))</span> <span class="p">(</span><span class="nb">zerop</span> <span class="p">(</span><span class="nb">mod</span> <span class="nv">pos</span> <span class="nv">n-digits</span><span class="p">)))</span>
              <span class="p">(</span><span class="nb">cons</span> <span class="nb">char</span> <span class="p">(</span><span class="nb">cons</span> <span class="sc">#\,</span> <span class="nv">chars</span><span class="p">))</span>
              <span class="p">(</span><span class="nb">cons</span> <span class="nb">char</span> <span class="nv">chars</span><span class="p">))</span>
          <span class="p">(</span><span class="nb">1+</span> <span class="nv">pos</span><span class="p">))))</span>
     <span class="p">(</span><span class="nb">coerce</span> <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;~A&quot;</span> <span class="nv">input</span><span class="p">)</span> <span class="ss">&#39;list</span><span class="p">)</span>
     <span class="ss">:initial-value</span> <span class="p">(</span><span class="nb">list</span> <span class="no">nil</span> <span class="mi">0</span><span class="p">)</span>
     <span class="ss">:from-end</span> <span class="no">t</span><span class="p">))</span>
   <span class="ss">&#39;string</span><span class="p">))</span>

<span class="c1">; (comma-separated 1234567890)   =&gt; &quot;1,234,567,890&quot;</span>
<span class="c1">; (comma-separated 1234567890 2) =&gt; &quot;12,34,56,78,90&quot;</span>


<span class="c1">;;; @@PLEAC@@_2.18</span>
<span class="c1">;;; There isn&#39;t a  Lingua::EN::Inflect like F/OSS Common Lisp  library I know of</span>
<span class="c1">;;; (as of date 2009-03-09). Below is a quick &amp; dirty implementation of its Perl</span>
<span class="c1">;;; equivalent.  On  the other hand, one  might be interested  in ~P (pluralize)</span>
<span class="c1">;;; directive of  the FORMAT  command and  its modifiers for  a quick  and cheap</span>
<span class="c1">;;; solution.</span>

<span class="p">(</span><span class="k">setq</span> <span class="vg">*pluralization-regexps*</span>
  <span class="o">&#39;</span><span class="p">((</span><span class="s">&quot;ss$&quot;</span>       <span class="o">.</span> <span class="s">&quot;sses&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;([psc]h)$&quot;</span> <span class="o">.</span> <span class="s">&quot;\\1es&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;z$&quot;</span>        <span class="o">.</span> <span class="s">&quot;zes&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;ff$&quot;</span>       <span class="o">.</span> <span class="s">&quot;ffs&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;f$&quot;</span>        <span class="o">.</span> <span class="s">&quot;ves&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;ey$&quot;</span>       <span class="o">.</span> <span class="s">&quot;eys&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;y$&quot;</span>        <span class="o">.</span> <span class="s">&quot;ies&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;ix$&quot;</span>       <span class="o">.</span> <span class="s">&quot;ices&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;([sx])$&quot;</span>   <span class="o">.</span> <span class="s">&quot;\\1es&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;$&quot;</span>         <span class="o">.</span> <span class="s">&quot;s&quot;</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">pluralize</span> <span class="p">(</span><span class="nv">noun</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">regexp</span> <span class="vg">*pluralization-regexps*</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">multiple-value-bind</span> <span class="p">(</span><span class="nv">result</span> <span class="nv">foundp</span><span class="p">)</span>
        <span class="p">(</span><span class="nv">ppcre:regex-replace</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">regexp</span><span class="p">)</span> <span class="nv">noun</span> <span class="p">(</span><span class="nb">cdr</span> <span class="nv">regexp</span><span class="p">))</span>
      <span class="p">(</span><span class="nb">when</span> <span class="nv">foundp</span> <span class="p">(</span><span class="nb">return</span> <span class="nv">result</span><span class="p">)))))</span>

<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~{~{One ~A, two ~A.~}~%~}&quot;</span>
        <span class="p">(</span><span class="nb">mapcar</span>
         <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">noun</span><span class="p">)</span> <span class="p">(</span><span class="nb">list</span> <span class="nv">noun</span> <span class="p">(</span><span class="nv">pluralize</span> <span class="nv">noun</span><span class="p">)))</span>
         <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;fish&quot;</span> <span class="s">&quot;fly&quot;</span> <span class="s">&quot;ox&quot;</span> <span class="s">&quot;species&quot;</span> <span class="s">&quot;genus&quot;</span> <span class="s">&quot;phylum&quot;</span> <span class="s">&quot;cherub&quot;</span> <span class="s">&quot;radius&quot;</span>
           <span class="s">&quot;jockey&quot;</span> <span class="s">&quot;index&quot;</span> <span class="s">&quot;matrix&quot;</span> <span class="s">&quot;mythos&quot;</span> <span class="s">&quot;phenomenon&quot;</span> <span class="s">&quot;formula&quot;</span><span class="p">)))</span>
<span class="c1">; =&gt; One fish, two fishes.</span>
<span class="c1">;    One fly, two flies.</span>
<span class="c1">;    One ox, two oxes.</span>
<span class="c1">;    One species, two specieses.</span>
<span class="c1">;    One genus, two genuses.</span>
<span class="c1">;    One phylum, two phylums.</span>
<span class="c1">;    One cherub, two cherubs.</span>
<span class="c1">;    One radius, two radiuses.</span>
<span class="c1">;    One jockey, two jockeys.</span>
<span class="c1">;    One index, two indexes.</span>
<span class="c1">;    One matrix, two matrices.</span>
<span class="c1">;    One mythos, two mythoses.</span>
<span class="c1">;    One phenomenon, two phenomenons.</span>
<span class="c1">;    One formula, two formulas.</span>


<span class="c1">;;; @@PLEAC@@_2.19</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">factorize</span> <span class="p">(</span><span class="nv">n</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">factors</span> <span class="p">(</span><span class="nb">make-hash-table</span><span class="p">))</span>
        <span class="p">(</span><span class="nv">m</span> <span class="nv">n</span><span class="p">))</span>
    <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">i</span> <span class="nv">from</span> <span class="mi">2</span>
          <span class="nv">while</span> <span class="p">(</span><span class="nb">&lt;=</span> <span class="p">(</span><span class="nb">1+</span> <span class="p">(</span><span class="nb">*</span> <span class="nv">i</span> <span class="mi">2</span><span class="p">))</span> <span class="nv">m</span><span class="p">)</span>
          <span class="nb">do</span> <span class="p">(</span><span class="nb">loop</span> <span class="nv">while</span> <span class="p">(</span><span class="nb">zerop</span> <span class="p">(</span><span class="nb">mod</span> <span class="nv">m</span> <span class="nv">i</span><span class="p">))</span>
                   <span class="nb">do</span> <span class="p">(</span><span class="k">setq</span> <span class="nv">m</span> <span class="p">(</span><span class="nb">/</span> <span class="nv">m</span> <span class="nv">i</span><span class="p">))</span>
                      <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">i</span> <span class="nv">factors</span><span class="p">)</span>
                            <span class="p">(</span><span class="nb">1+</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">i</span> <span class="nv">factors</span> <span class="mi">0</span><span class="p">)))))</span>
    <span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nb">=</span> <span class="mi">1</span> <span class="nv">m</span><span class="p">)</span> <span class="p">(</span><span class="nb">=</span> <span class="nv">n</span> <span class="nv">m</span><span class="p">))</span>
      <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">m</span> <span class="nv">factors</span><span class="p">)</span> <span class="mi">1</span><span class="p">))</span>
    <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A = ~{~{~A^~A~}~^ * ~}~%&quot;</span>
            <span class="nv">n</span> <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">factor</span> <span class="nv">being</span> <span class="nv">each</span> <span class="nv">hash-key</span> <span class="nv">of</span> <span class="nv">factors</span>
                     <span class="nv">collect</span> <span class="p">(</span><span class="nb">list</span> <span class="nv">factor</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">factor</span> <span class="nv">factors</span><span class="p">))))))</span>

<span class="c1">; (factorize 49249597168049276)</span>
<span class="c1">; =&gt; 49249597168049276 = 2^2 * 29^1 * 179^1 * 103387^1 * 22941707^1</span>


<span class="c1">;;; @@PLEAC@@_3.0</span>
<span class="c1">;;; Despite  standard Common Lisp  date &amp;  time related  functions used  in this</span>
<span class="c1">;;; chapter,  there are  also these  date &amp;  time libraries  which you  might be</span>
<span class="c1">;;; interested  in: local-time, net-telent-date,  and date-calc.   (Packages are</span>
<span class="c1">;;; available      via      ASDF-INSTALL.)       There      is      also      &lt;a</span>
<span class="c1">;;; href=&quot;http://cybertiggyr.com/gene/pdl/&quot;&gt;Parsing  Dates  in Lisp&lt;/a&gt;  webpage</span>
<span class="c1">;;; written by G. M. Stover containing some utility scripts.</span>

<span class="c1">;;; As a shortcut,  below is a small  list of available Common Lisp  date &amp; time</span>
<span class="c1">;;; builtins.</span>

<span class="c1">;;; Constant Variable &lt;a href=&quot;http://l1sp.org/cl/internal-time-units-per-second&quot;&gt;INTERNAL-TIME-UNITS-PER-SECOND&lt;/a&gt;</span>
<span class="c1">;;; Function &lt;a href=&quot;http://l1sp.org/cl/decode-universal-time&quot;&gt;DECODE-UNIVERSAL-TIME&lt;/a&gt;</span>
<span class="c1">;;; Function &lt;a href=&quot;http://l1sp.org/cl/encode-universal-time&quot;&gt;ENCODE-UNIVERSAL-TIME&lt;/a&gt;</span>
<span class="c1">;;; Function &lt;a href=&quot;http://l1sp.org/cl/get-universal-time&quot;&gt;GET-UNIVERSAL-TIME&lt;/a&gt;</span>
<span class="c1">;;; Function &lt;a href=&quot;http://l1sp.org/cl/get-decoded-time&quot;&gt;GET-DECODED-TIME&lt;/a&gt;</span>
<span class="c1">;;; Function &lt;a href=&quot;http://l1sp.org/cl/sleep&quot;&gt;SLEEP&lt;/a&gt;</span>
<span class="c1">;;; Function &lt;a href=&quot;http://l1sp.org/cl/get-internal-real-time&quot;&gt;GET-INTERNAL-REAL-TIME&lt;/a&gt;</span>
<span class="c1">;;; Function &lt;a href=&quot;http://l1sp.org/cl/get-internal-run-time&quot;&gt;GET-INTERNAL-RUN-TIME&lt;/a&gt;</span>

<span class="c1">;;; A &quot;decoded time&quot; is an ordered  series of nine values (second, minute, hour,</span>
<span class="c1">;;; day,  month, year,  dow,  daylight-p, and  timezone)  that, taken  together,</span>
<span class="c1">;;; represent a point in calendar time (ignoring leap seconds).</span>

<span class="c1">;;; &quot;Universal time&quot;  is an absolute  time represented as a  single non-negative</span>
<span class="c1">;;; integer  --- the  number  of seconds  since  midnight, January  1, 1900  GMT</span>
<span class="c1">;;; (ignoring leap seconds).</span>

<span class="p">(</span><span class="nb">get-universal-time</span><span class="p">)</span>
<span class="c1">; =&gt; 3445946614</span>

<span class="p">(</span><span class="nb">multiple-value-list</span> <span class="p">(</span><span class="nb">get-decoded-time</span><span class="p">))</span>
<span class="c1">; =&gt; (45 23 17 13 3 2009 4 NIL -2)</span>

<span class="c1">;;; Current  Common   Lisp  specification   is  lacking  of   a  day-of-the-year</span>
<span class="c1">;;; concept.   But  we   can  easily   implement   it  using   a  decoded   time</span>
<span class="c1">;;; specification.     (For     hairy    details     you     can    check     &lt;a</span>
<span class="c1">;;; href=&quot;http://en.wikipedia.org/wiki/Calculating_the_day_of_the_week&quot;&gt;related</span>
<span class="c1">;;; wikipedia page&lt;/a&gt; out.)</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">day-of-the-year</span> <span class="p">(</span><span class="k">&amp;optional</span> <span class="nv">universal-time</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="nv">decoded-time</span> <span class="p">(</span><span class="nb">multiple-value-list</span>
                           <span class="p">(</span><span class="nb">decode-universal-time</span>
                            <span class="p">(</span><span class="nb">or</span> <span class="nv">universal-time</span>
                                <span class="p">(</span><span class="nb">get-universal-time</span><span class="p">)))))</span>
         <span class="p">(</span><span class="nv">day</span>          <span class="p">(</span><span class="nb">elt</span> <span class="nv">decoded-time</span> <span class="mi">3</span><span class="p">))</span>
         <span class="p">(</span><span class="nv">month</span>        <span class="p">(</span><span class="nb">elt</span> <span class="nv">decoded-time</span> <span class="mi">4</span><span class="p">))</span>
         <span class="p">(</span><span class="nv">year</span>         <span class="p">(</span><span class="nb">elt</span> <span class="nv">decoded-time</span> <span class="mi">5</span><span class="p">)))</span>
    <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">m</span> <span class="nv">from</span> <span class="mi">2</span> <span class="nv">to</span> <span class="nv">month</span>
          <span class="nb">do</span> <span class="p">(</span><span class="nb">incf</span> <span class="nv">day</span>
                   <span class="p">(</span><span class="nb">elt</span>
                     <span class="p">(</span><span class="nb">multiple-value-list</span>
                         <span class="p">(</span><span class="nb">decode-universal-time</span>
                          <span class="p">(</span><span class="nb">-</span> <span class="p">(</span><span class="nb">encode-universal-time</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">1</span> <span class="nv">m</span> <span class="nv">year</span><span class="p">)</span>
                             <span class="p">(</span><span class="nb">*</span> <span class="mi">60</span> <span class="mi">60</span> <span class="mi">24</span><span class="p">))))</span>
                     <span class="mi">3</span><span class="p">)))</span>
    <span class="nv">day</span><span class="p">))</span>

<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;Today is day ~A of the current year.~%&quot;</span> <span class="p">(</span><span class="nv">day-of-the-year</span><span class="p">))</span>
<span class="c1">; =&gt; Today is day 72 of the current year.</span>

<span class="p">(</span><span class="nv">day-of-the-year</span> <span class="p">(</span><span class="nb">encode-universal-time</span> <span class="mi">59</span> <span class="mi">59</span> <span class="mi">23</span> <span class="mi">31</span> <span class="mi">12</span> <span class="mi">2009</span><span class="p">))</span>
<span class="c1">; =&gt; 365</span>

<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;Today is day ~A of the current year.~%&quot;</span> <span class="p">(</span><span class="nv">day-of-the-year</span><span class="p">))</span>

<span class="c1">;;; And here is a quick &amp; dirty `STRFTIME&#39; utility.</span>

<span class="p">(</span><span class="nb">defmacro</span> <span class="nv">define-time-formatters</span> <span class="p">(</span><span class="k">&amp;body</span> <span class="nv">formatter-specs</span><span class="p">)</span>
  <span class="o">`</span><span class="p">(</span><span class="nb">list</span>
    <span class="o">,@</span><span class="p">(</span><span class="nb">mapcar</span>
       <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">formatter-spec</span><span class="p">)</span>
         <span class="o">`</span><span class="p">(</span><span class="nb">cons</span>
           <span class="o">,</span><span class="p">(</span><span class="nb">first</span> <span class="nv">formatter-spec</span><span class="p">)</span>
           <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nb">second</span> <span class="nv">minute</span> <span class="nv">hour</span> <span class="nv">day</span> <span class="nv">month</span> <span class="nv">year</span> <span class="nv">dow</span> <span class="nv">daylight-p</span> <span class="nv">zone</span><span class="p">)</span>
             <span class="p">(</span><span class="k">declare</span> <span class="p">(</span><span class="k">ignorable</span> <span class="nb">second</span> <span class="nv">minute</span> <span class="nv">hour</span> <span class="nv">day</span> <span class="nv">month</span> <span class="nv">year</span> <span class="nv">dow</span> <span class="nv">daylight-p</span> <span class="nv">zone</span><span class="p">))</span>
             <span class="o">,@</span><span class="p">(</span><span class="nb">rest</span> <span class="nv">formatter-spec</span><span class="p">))))</span>
       <span class="nv">formatter-specs</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defvar</span> <span class="vg">*time-formatters*</span>
  <span class="p">(</span><span class="nv">define-time-formatters</span>
    <span class="p">(</span><span class="sc">#\a</span> <span class="p">(</span><span class="nb">elt</span> <span class="o">#(</span><span class="s">&quot;Mon&quot;</span> <span class="s">&quot;Tue&quot;</span> <span class="s">&quot;Wed&quot;</span> <span class="s">&quot;Thu&quot;</span> <span class="s">&quot;Fri&quot;</span> <span class="s">&quot;Sat&quot;</span> <span class="s">&quot;Sun&quot;</span><span class="p">)</span> <span class="nv">dow</span><span class="p">))</span>
    <span class="p">(</span><span class="sc">#\b</span> <span class="p">(</span><span class="nb">elt</span> <span class="o">#(</span><span class="s">&quot;Jan&quot;</span> <span class="s">&quot;Feb&quot;</span> <span class="s">&quot;Mar&quot;</span>
                <span class="s">&quot;Apr&quot;</span> <span class="s">&quot;May&quot;</span> <span class="s">&quot;Jun&quot;</span>
                <span class="s">&quot;Jul&quot;</span> <span class="s">&quot;Aug&quot;</span> <span class="s">&quot;Sep&quot;</span>
                <span class="s">&quot;Oct&quot;</span> <span class="s">&quot;Nov&quot;</span> <span class="s">&quot;Dec&quot;</span><span class="p">)</span>
              <span class="nv">month</span><span class="p">))</span>
    <span class="p">(</span><span class="sc">#\d</span> <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;~2,&#39;0D&quot;</span> <span class="nv">day</span><span class="p">))</span>
    <span class="p">(</span><span class="sc">#\H</span> <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;~2,&#39;0D&quot;</span> <span class="nv">hour</span><span class="p">))</span>
    <span class="p">(</span><span class="err">#</span><span class="nv">j</span>  <span class="p">(</span><span class="nv">day-of-the-year</span>
          <span class="p">(</span><span class="nb">encode-universal-time</span>
           <span class="nb">second</span> <span class="nv">minute</span> <span class="nv">hour</span> <span class="nv">day</span> <span class="nv">month</span> <span class="nv">year</span> <span class="nv">dow</span> <span class="nv">zone</span><span class="p">)))</span>
    <span class="p">(</span><span class="sc">#\m</span> <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;~2,&#39;0D&quot;</span> <span class="nv">month</span><span class="p">))</span>
    <span class="p">(</span><span class="sc">#\M</span> <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;~2,&#39;0D&quot;</span> <span class="nv">minute</span><span class="p">))</span>
    <span class="p">(</span><span class="sc">#\S</span> <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;~2,&#39;0D&quot;</span> <span class="nb">second</span><span class="p">))</span>
    <span class="p">(</span><span class="sc">#\w</span> <span class="nv">dow</span><span class="p">)</span>
    <span class="p">(</span><span class="sc">#\Y</span> <span class="nv">year</span><span class="p">)</span>
    <span class="p">(</span><span class="sc">#\z</span> <span class="nv">zone</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">strftime</span> <span class="p">(</span><span class="nb">format</span> <span class="k">&amp;optional</span> <span class="nv">universal-time</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">with-output-to-string</span> <span class="p">(</span><span class="nv">out</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">curr-index</span> <span class="nv">from</span> <span class="mi">0</span>
          <span class="nv">for</span> <span class="nv">prev-special-p</span> <span class="nb">=</span> <span class="no">nil</span> <span class="nv">then</span> <span class="nv">curr-special-p</span>
          <span class="nv">for</span> <span class="nv">curr-char</span> <span class="nv">across</span> <span class="nb">format</span>
          <span class="nv">for</span> <span class="nv">curr-special-p</span> <span class="nb">=</span> <span class="p">(</span><span class="nb">char-equal</span> <span class="sc">#\%</span> <span class="nv">curr-char</span><span class="p">)</span>
          <span class="nb">do</span> <span class="p">(</span><span class="nb">cond</span>
               <span class="p">((</span><span class="nb">or</span> <span class="p">(</span><span class="nb">and</span> <span class="nv">prev-special-p</span> <span class="nv">curr-special-p</span><span class="p">)</span>
                    <span class="p">(</span><span class="nb">not</span> <span class="p">(</span><span class="nb">or</span> <span class="nv">prev-special-p</span> <span class="nv">curr-special-p</span><span class="p">)))</span>
                <span class="p">(</span><span class="nb">format</span> <span class="nv">out</span> <span class="s">&quot;~C&quot;</span> <span class="nv">curr-char</span><span class="p">))</span>
               <span class="p">(</span><span class="nv">prev-special-p</span>
                <span class="p">(</span><span class="nb">format</span>
                 <span class="nv">out</span> <span class="s">&quot;~A&quot;</span>
                 <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">not</span> <span class="p">(</span><span class="nb">&lt;</span> <span class="nv">curr-index</span> <span class="p">(</span><span class="nb">length</span> <span class="nb">format</span><span class="p">)))</span>
                     <span class="p">(</span><span class="nb">error</span> <span class="s">&quot;Missing directive at position ~D.&quot;</span> <span class="nv">curr-index</span><span class="p">)</span>
                     <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nv">alexandria:when-let</span>
                             <span class="p">(</span><span class="nb">formatter</span>
                              <span class="p">(</span><span class="nb">find</span> <span class="nv">curr-char</span> <span class="vg">*time-formatters*</span>
                                    <span class="ss">:test</span> <span class="nf">#&#39;</span><span class="nb">char-equal</span> <span class="ss">:key</span> <span class="nf">#&#39;</span><span class="nb">car</span><span class="p">))</span>
                           <span class="p">(</span><span class="nb">apply</span>
                            <span class="p">(</span><span class="nb">cdr</span> <span class="nb">formatter</span><span class="p">)</span>
                            <span class="p">(</span><span class="nb">multiple-value-list</span>
                                <span class="p">(</span><span class="nb">decode-universal-time</span>
                                 <span class="p">(</span><span class="nb">or</span> <span class="nv">universal-time</span> <span class="p">(</span><span class="nb">get-universal-time</span><span class="p">))))))</span>
                         <span class="p">(</span><span class="nb">error</span> <span class="s">&quot;Invalid directive ~S at position ~D.&quot;</span>
                                <span class="nv">curr-char</span> <span class="nv">curr-index</span><span class="p">)))))))))</span>

<span class="p">(</span><span class="nv">strftime</span> <span class="s">&quot;%d %b, %Y, %a&quot;</span><span class="p">)</span>
<span class="c1">; =&gt; &quot;12 Apr, 2009, Thu&quot;</span>

<span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="nv">today</span>     <span class="p">(</span><span class="nb">get-universal-time</span><span class="p">))</span>
       <span class="p">(</span><span class="nv">yesterday</span> <span class="p">(</span><span class="nb">-</span> <span class="nv">today</span> <span class="p">(</span><span class="nb">*</span> <span class="mi">60</span> <span class="mi">60</span> <span class="mi">24</span><span class="p">))))</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;Today    : ~A (~A)~%Yesterday: ~A (~A)~%&quot;</span>
          <span class="p">(</span><span class="nv">strftime</span> <span class="s">&quot;%Y-%m-%d %H:%M:%S&quot;</span> <span class="nv">today</span><span class="p">)</span> <span class="nv">today</span>
          <span class="p">(</span><span class="nv">strftime</span> <span class="s">&quot;%Y-%m-%d %H:%M:%S&quot;</span> <span class="nv">yesterday</span><span class="p">)</span> <span class="nv">yesterday</span><span class="p">))</span>
<span class="c1">; =&gt; Today    : 2009-22-13 17:22:09 (3445946529)</span>
<span class="c1">;    Yesterday: 2009-22-12 17:22:09 (3445860129)</span>


<span class="c1">;;; @@PLEAC@@_3.1</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; use GET-DECODED-TIME to fetch the time</span>
<span class="p">(</span><span class="nb">multiple-value-bind</span>
      <span class="p">(</span><span class="nb">second</span> <span class="nv">minute</span> <span class="nv">hour</span> <span class="nv">date</span> <span class="nv">month</span> <span class="nv">year</span> <span class="nv">day-of-week</span> <span class="nv">dst-p</span> <span class="nv">tz</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">get-decoded-time</span><span class="p">)</span>
  <span class="nv">year</span><span class="p">)</span> <span class="c1">; prints out year using standard library</span>

<span class="c1">;; alternatively date-calc provides overlapping functionality</span>
<span class="p">(</span><span class="nb">multiple-value-bind</span> <span class="p">(</span><span class="nv">year</span> <span class="nv">month</span> <span class="nv">day</span> <span class="nv">h</span> <span class="nv">m</span> <span class="nv">s</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">today-and-now</span><span class="p">)</span>                     <span class="c1">; imported from date-calc</span>
  <span class="nv">year</span><span class="p">)</span>                                 <span class="c1">; date-calc approach</span>

<span class="c1">;; how to print out current date as &quot;YYYY-MM-DD&quot; (in approved ISO 8601 fashion)</span>
<span class="p">(</span><span class="nb">multiple-value-bind</span> <span class="p">(</span><span class="nv">year</span> <span class="nv">month</span> <span class="nv">day</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">today</span><span class="p">)</span>                             <span class="c1">;imported from date-calc</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;The current date is ~A-~2,&#39;0d-~2,&#39;0d&quot;</span> <span class="nv">year</span> <span class="nv">month</span> <span class="nv">day</span><span class="p">))</span>

<span class="c1">;; Alternatively, you could use the format-time function from the</span>
<span class="c1">;; CyberTiggyr-Time package:</span>
<span class="p">(</span><span class="nv">format-time</span> <span class="no">t</span> <span class="s">&quot;%Y-%m-%d&quot;</span> <span class="p">(</span><span class="nb">get-universal-time</span><span class="p">))</span>

<span class="c1">;; As you can see, format-time operates on epoch time</span>

<span class="c1">;;; @@PLEAC@@_3.2</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; to encode time into universal time using date-calc</span>
<span class="p">(</span><span class="nb">multiple-value-bind</span>
      <span class="p">(</span><span class="nb">second</span> <span class="nv">minute</span> <span class="nv">hour</span> <span class="nv">date</span> <span class="nv">month</span> <span class="nv">year</span> <span class="nv">day-of-week</span> <span class="nv">dst-p</span> <span class="nv">tz</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">get-decoded-time</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">encode-universal-time</span> <span class="nb">second</span> <span class="nv">minute</span> <span class="nv">hour</span> <span class="nv">date</span> <span class="nv">month</span> <span class="nv">year</span><span class="p">))</span>

<span class="c1">;; The last two return values for get-decoded-time correspond to</span>
<span class="c1">;; daylight savings and the timezone.  Both are useful for</span>
<span class="c1">;; timezone-related arithmetic.</span>

<span class="c1">;;; @@INCOMPLETE@@</span>
<span class="c1">;; An example of a GMT computation with and without daylight savings</span>
<span class="c1">;; is appropriate here since the built-in perl functions handle this.</span>

<span class="c1">;;; @@PLEAC@@_3.3</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nb">time</span> <span class="p">(</span><span class="nb">get-universal-time</span><span class="p">)))</span> <span class="c1">; get epoch seconds</span>
  <span class="p">(</span><span class="nb">multiple-value-bind</span>
      <span class="p">(</span><span class="nb">second</span> <span class="nv">minute</span> <span class="nv">hour</span> <span class="nv">day</span> <span class="nv">month</span> <span class="nv">year</span> <span class="nv">day-of-week</span> <span class="nv">dst-p</span> <span class="nv">tz</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">decode-universal-time</span> <span class="nb">time</span><span class="p">)</span> <span class="c1">; decode and...</span>
    <span class="p">(</span><span class="nb">list</span> <span class="nv">day</span> <span class="nv">month</span> <span class="nv">year</span> <span class="nv">hour</span> <span class="nv">minute</span> <span class="nb">second</span><span class="p">)))</span> <span class="c1">; return</span>

<span class="c1">;;; @@PLEAC@@_3.4</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;; when using universal time you add or subtract seconds</span>
<span class="c1">;; here we add one hour</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">firstdate</span>
       <span class="p">(</span><span class="nb">encode-universal-time</span> <span class="mi">0</span> <span class="mi">12</span> <span class="mi">6</span> <span class="mi">23</span> <span class="mi">11</span> <span class="mi">2006</span><span class="p">))</span>
      <span class="p">(</span><span class="nv">onehour</span> <span class="p">(</span><span class="nb">*</span> <span class="mi">60</span> <span class="mi">60</span> <span class="mi">1</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">+</span> <span class="nv">onehour</span> <span class="nv">firstdate</span><span class="p">))</span>

<span class="c1">;; or you could use date-calc function</span>
<span class="c1">;; here we&#39;ll add one day</span>
<span class="p">(</span><span class="nv">add-delta-ymdhms</span> <span class="mi">2006</span> <span class="mi">11</span> <span class="mi">24</span> <span class="mi">18</span> <span class="mi">12</span> <span class="mi">0</span>  <span class="mi">0</span> <span class="mi">0</span> <span class="mi">1</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1">;;; @@PLEAC@@_3.5</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; We&#39;ll use the epoch seconds to perform subtraction,</span>
<span class="c1">;; then divide by seconds per day</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nb">first</span> <span class="p">(</span><span class="nb">encode-universal-time</span> <span class="mi">52</span> <span class="mi">45</span> <span class="mi">20</span> <span class="mi">13</span> <span class="mi">12</span> <span class="mi">1901</span><span class="p">))</span>
      <span class="p">(</span><span class="nb">second</span> <span class="p">(</span><span class="nb">encode-universal-time</span> <span class="mi">7</span> <span class="mi">14</span> <span class="mi">3</span> <span class="mi">19</span> <span class="mi">1</span> <span class="mi">2038</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">float</span> <span class="p">(</span><span class="nb">/</span> <span class="p">(</span><span class="nb">-</span> <span class="nb">second</span> <span class="nb">first</span><span class="p">)</span> <span class="p">(</span><span class="nb">*</span> <span class="mi">60</span> <span class="mi">60</span> <span class="mi">24</span><span class="p">))))</span>

<span class="c1">;; method two uses delta-days from the date-calc package:</span>
<span class="p">(</span><span class="nv">delta-days</span> <span class="mi">1901</span> <span class="mi">12</span> <span class="mi">13</span> <span class="mi">2038</span> <span class="mi">1</span> <span class="mi">19</span><span class="p">)</span>

<span class="c1">;; delta-days does not yet have the granularity of seconds, minutes or hours.</span>

<span class="c1">;;; @@PLEAC@@_3.6</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; The week of the year is computed as follows:</span>
<span class="p">(</span><span class="nv">week-number</span> <span class="mi">2006</span> <span class="mi">12</span> <span class="mi">1</span><span class="p">)</span>      <span class="c1">; week-of-year is imported from date-calc</span>

<span class="c1">;; similar functions exist for day of week, day of year, etc.</span>

<span class="c1">;;; @@PLEAC@@_3.7</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nv">parse-time</span> <span class="s">&quot;2006-08-20&quot;</span><span class="p">)</span>

<span class="c1">;; PARSE-TIME can recognize many of the commonly found date formats</span>

<span class="c1">; format-time comes with several ways to format...</span>
<span class="p">(</span><span class="nv">format-time</span> <span class="no">t</span> <span class="vg">*format-time-date*</span> <span class="p">(</span><span class="nb">get-universal-time</span><span class="p">))</span>

<span class="c1">; results in: 25 Nov 2006</span>

<span class="p">(</span><span class="nv">format-time</span> <span class="no">t</span> <span class="vg">*format-time-iso8601-short*</span> <span class="p">(</span><span class="nb">get-universal-time</span><span class="p">))</span>

<span class="c1">; results in: 20061125T172917 -5</span>

<span class="p">(</span><span class="nv">format-time</span> <span class="no">t</span> <span class="s">&quot;%Y-%m-%d&quot;</span> <span class="p">(</span><span class="nb">get-universal-time</span><span class="p">))</span>

<span class="c1">; results in: 2006-11-25</span>

<span class="c1">;;; @@PLEAC@@_4.0</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">nested</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;this&quot;</span> <span class="s">&quot;that&quot;</span> <span class="s">&quot;the&quot;</span> <span class="s">&quot;other&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">nested</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;this&quot;</span> <span class="s">&quot;that&quot;</span> <span class="p">(</span><span class="s">&quot;the&quot;</span> <span class="s">&quot;other&quot;</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">tune</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;The&quot;</span> <span class="s">&quot;Star-Spangled&quot;</span> <span class="s">&quot;Banner&quot;</span><span class="p">))</span>

<span class="c1">;;; @@PLEAC@@_4.1</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">a</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;quick&quot;</span> <span class="s">&quot;brown&quot;</span> <span class="s">&quot;fox&quot;</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">a</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;Why&quot;</span> <span class="s">&quot;are&quot;</span> <span class="s">&quot;you&quot;</span> <span class="s">&quot;teasing&quot;</span> <span class="s">&quot;me?&quot;</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">lines</span> <span class="p">(</span><span class="nv">regex-replace-all</span> <span class="p">(</span><span class="nv">create-scanner</span> <span class="s">&quot;^\\s*(.+)&quot;</span> <span class="ss">:multi-line-mode</span> <span class="no">t</span> <span class="p">)</span>
<span class="s">&quot;    The boy stood on the burning deck,</span>
<span class="s">    It was as hot as glass.</span>
<span class="s">&quot;</span> <span class="s">&quot;\\1&quot;</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; You don&#39;t really need an explicit call to the CL equivalent of</span>
<span class="c1">;;; Perl&#39;s die().  Its behavior is the same by default (it does put</span>
<span class="c1">;;; you into the CL debugger, but that&#39;s not a bad thing).  You could,</span>
<span class="c1">;;; alternatively, handle this error with HANDLER-BIND or HANLDER-CASE</span>
<span class="c1">;;; if you wanted to be more precisely like the Perl version.</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">bigarray</span> <span class="o">&#39;</span><span class="p">()))</span>
  <span class="p">(</span><span class="nb">with-open-file</span> <span class="p">(</span><span class="nv">data</span> <span class="s">&quot;mydatafile&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">line</span> <span class="nb">=</span> <span class="p">(</span><span class="nb">read-line</span> <span class="nv">data</span> <span class="no">nil</span> <span class="no">nil</span><span class="p">)</span>
       <span class="nv">while</span> <span class="nv">line</span>
       <span class="nb">do</span> <span class="p">(</span><span class="nb">push</span> <span class="p">(</span><span class="nb">string-right-trim</span> <span class="o">#(</span><span class="sc">#\Newline</span> <span class="sc">#\Return</span><span class="p">)</span>
                                   <span class="nv">line</span><span class="p">)</span> <span class="nv">bigarray</span><span class="p">))))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">banner</span> <span class="s">&quot;The Mines of Moria&quot;</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">name</span> <span class="s">&quot;Gandalf&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">banner</span> <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;Speak ~A and enter!&quot;</span> <span class="nv">name</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">banner</span> <span class="s">&quot;Speak $name and welcome!&quot;</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">his-host</span> <span class="s">&quot;www.perl.com&quot;</span><span class="p">)</span>
<span class="o">#+</span><span class="nv">sbcl</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">host-info</span> <span class="p">(</span><span class="nb">with-output-to-string</span> <span class="p">(</span><span class="nv">output</span><span class="p">)</span>
                  <span class="p">(</span><span class="nv">sb-ext:run-program</span> <span class="s">&quot;nslookup&quot;</span> <span class="o">`</span><span class="p">(</span><span class="o">,</span><span class="nv">his-host</span><span class="p">)</span> <span class="ss">:search</span> <span class="no">t</span> <span class="ss">:output</span> <span class="nv">output</span><span class="p">)))</span>
<span class="c1">;; There&#39;s no equivalent to Perl&#39;s qx</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">banner</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;Costs&quot;</span> <span class="s">&quot;only&quot;</span> <span class="s">&quot;$4.95&quot;</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">banner</span> <span class="p">(</span><span class="nv">split</span> <span class="s">&quot; &quot;</span> <span class="s">&quot;Costs only $4.95&quot;</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">brax</span> <span class="o">&#39;</span><span class="p">(</span><span class="sc">#\(</span> <span class="sc">#\)</span> <span class="sc">#\&lt;</span> <span class="sc">#\&gt;</span> <span class="sc">#\{</span> <span class="sc">#\}</span> <span class="sc">#\[</span> <span class="sc">#\]</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">rings</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;Nenya&quot;</span> <span class="s">&quot;Narya&quot;</span> <span class="s">&quot;Vilya&quot;</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">tags</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;LI&quot;</span> <span class="s">&quot;TABLE&quot;</span> <span class="s">&quot;TR&quot;</span> <span class="s">&quot;TD&quot;</span> <span class="s">&quot;A&quot;</span> <span class="s">&quot;IMG&quot;</span> <span class="s">&quot;H1&quot;</span> <span class="s">&quot;P&quot;</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">sample</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;The&quot;</span> <span class="s">&quot;vertical&quot;</span> <span class="s">&quot;bar&quot;</span> <span class="s">&quot;(|)&quot;</span> <span class="s">&quot;looks&quot;</span> <span class="s">&quot;and&quot;</span> <span class="s">&quot;behaves&quot;</span> <span class="s">&quot;like&quot;</span> <span class="s">&quot;a&quot;</span> <span class="s">&quot;pipe.&quot;</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; No equivalent in CL (would just be the same as above)</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; No equivalent in CL (would just be the same as above)</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_4.2</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">commify-series</span> <span class="p">(</span><span class="nb">list</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">case</span> <span class="p">(</span><span class="nb">length</span> <span class="nb">list</span><span class="p">)</span>
    <span class="p">(</span><span class="mi">0</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="mi">1</span> <span class="p">(</span><span class="nb">car</span> <span class="nb">list</span><span class="p">))</span>
    <span class="p">(</span><span class="mi">2</span> <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;~{~A~^ and ~}&quot;</span> <span class="nb">list</span><span class="p">))</span>
    <span class="p">(</span><span class="no">t</span> <span class="p">(</span><span class="nb">concatenate</span> <span class="ss">&#39;string</span>
                    <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;~{~A~^, ~}&quot;</span> <span class="p">(</span><span class="nb">butlast</span> <span class="nb">list</span><span class="p">))</span>
                    <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot; and ~A&quot;</span> <span class="p">(</span><span class="nb">car</span> <span class="p">(</span><span class="nb">last</span> <span class="nb">list</span><span class="p">)))))))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nc">array</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;red&quot;</span> <span class="s">&quot;yellow&quot;</span> <span class="s">&quot;green&quot;</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;I have ~{~A~} marbles.~%&quot;</span> <span class="nc">array</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;I have ~{~A~^ ~} marbles.~%&quot;</span> <span class="nc">array</span><span class="p">))</span>
<span class="c1">;;I have redyellowgreen marbles.</span>
<span class="c1">;;I have red yellow green marbles.</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; <font size="-1"><a href="http://pleac.sourceforge.net/include/commonlisp/ch04/commify_series.lisp</span>">download the following standalone program</a></font>
<span class="c1">;;;; commify_series - show proper comma insertion in list output</span>

<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*lists*</span>
  <span class="o">&#39;</span><span class="p">((</span><span class="s">&quot;just one thing&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;Mutt&quot;</span> <span class="s">&quot;Jeff&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;Peter&quot;</span> <span class="s">&quot;Paul&quot;</span> <span class="s">&quot;Mary&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;To our parents&quot;</span> <span class="s">&quot;Mother Theresa&quot;</span> <span class="s">&quot;God&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;pastrami&quot;</span> <span class="s">&quot;ham and cheese&quot;</span> <span class="s">&quot;peanut butter and jelly&quot;</span> <span class="s">&quot;tuna&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;recycle tired, old phrases&quot;</span> <span class="s">&quot;ponder big, happy thoughts&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;recycle tired, old phrases&quot;</span>
     <span class="s">&quot;ponder big, happy thoughts&quot;</span>
     <span class="s">&quot;sleep and dream peacefully&quot;</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">commify_series</span> <span class="p">(</span><span class="nb">list</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">sepchar</span> <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">find-if</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nb">string</span><span class="p">)</span> 
                                  <span class="p">(</span><span class="nb">find</span> <span class="sc">#\,</span> <span class="nb">string</span><span class="p">))</span>
                              <span class="nb">list</span><span class="p">)</span>
                     <span class="s">&quot;; &quot;</span> <span class="s">&quot;, &quot;</span><span class="p">)))</span>
    <span class="p">(</span><span class="nb">case</span> <span class="p">(</span><span class="nb">length</span> <span class="nb">list</span><span class="p">)</span>
      <span class="p">(</span><span class="mi">0</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
      <span class="p">(</span><span class="mi">1</span> <span class="p">(</span><span class="nb">car</span> <span class="nb">list</span><span class="p">))</span>
      <span class="p">(</span><span class="mi">2</span> <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;~{~a~^ and ~}&quot;</span> <span class="nb">list</span><span class="p">))</span>
      <span class="p">(</span><span class="no">t</span> <span class="p">(</span><span class="nb">concatenate</span> <span class="ss">&#39;string</span>
                      <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span>
                              <span class="s">&quot;~{~}&quot;</span> 
                              <span class="p">(</span><span class="nb">concatenate</span> <span class="ss">&#39;string</span> <span class="s">&quot;~a~^&quot;</span> <span class="nv">sepchar</span><span class="p">)</span>
                              <span class="p">(</span><span class="nb">butlast</span> <span class="nb">list</span><span class="p">))</span>
                      <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot; and ~a&quot;</span> <span class="p">(</span><span class="nb">car</span> <span class="p">(</span><span class="nb">last</span> <span class="nb">list</span><span class="p">))))))))</span>

<span class="p">(</span><span class="nb">mapc</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nb">list</span><span class="p">)</span>
          <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;The list is: ~a.~%&quot;</span> <span class="p">(</span><span class="nv">commify_series</span> <span class="nb">list</span><span class="p">)))</span>
      <span class="vg">*lists*</span><span class="p">)</span>


<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_4.3</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; grow or shrink MY-ARRAY (assuming it was created with :ADJUSTABLE</span>
<span class="c1">;; set to T)</span>
<span class="p">(</span><span class="nb">adjust-array</span> <span class="nv">my-array</span> <span class="p">(</span><span class="nb">1+</span> <span class="nv">new-last-element-index-number</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; There&#39;s no auto-creation of array elements.</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*people*</span> <span class="p">(</span><span class="nb">make-array</span> <span class="mi">4</span>
                                   <span class="ss">:initial-contents</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;Crosby&quot;</span> <span class="s">&quot;Stills&quot;</span> <span class="s">&quot;Nash&quot;</span> <span class="s">&quot;Young&quot;</span><span class="p">)</span>
                                   <span class="ss">:adjustable</span> <span class="no">t</span><span class="p">))</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">what-about-that-array</span> <span class="p">()</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span>
          <span class="s">&quot;The array now has ~D elements</span>
<span class="s">The index of the last element is ~D</span>
<span class="s">Element #3 is ~A~%&quot;</span>
          <span class="p">(</span><span class="nb">length</span> <span class="vg">*people*</span><span class="p">)</span>
          <span class="p">(</span><span class="nb">1-</span> <span class="p">(</span><span class="nb">length</span> <span class="vg">*people*</span><span class="p">))</span>
          <span class="p">(</span><span class="nb">aref</span> <span class="vg">*people*</span> <span class="mi">3</span><span class="p">)))</span>
<span class="p">(</span><span class="nv">what-about-that-array</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;;The array now has 4 elements</span>
<span class="c1">;;The index of the last element is 3</span>
<span class="c1">;;Element #3 is Young</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">adjust-array</span> <span class="vg">*people*</span> <span class="p">(</span><span class="nb">1-</span> <span class="p">(</span><span class="nb">length</span> <span class="vg">*people*</span><span class="p">)))</span>
<span class="p">(</span><span class="nv">what-about-that-array</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Evaluating WHAT-ABOUT-THAT-ARRAY now results in an error because</span>
<span class="c1">;; there is no 3rd element, and, unlike Perl, CL doesn&#39;t just return</span>
<span class="c1">;; the empty string in that case.</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">adjust-array</span> <span class="vg">*people*</span> <span class="mi">10001</span><span class="p">)</span>
<span class="p">(</span><span class="nv">what-about-that-array</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;;The array now has 10001 elements</span>
<span class="c1">;;The index of the last element is 9999</span>
<span class="c1">;;Element #3 is 0</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">aref</span> <span class="vg">*people*</span> <span class="mi">10000</span><span class="p">)</span> <span class="no">nil</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_4.4</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">item</span> <span class="nb">list</span><span class="p">)</span>
  <span class="c1">;; do something with ITEM</span>
  <span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">user</span> <span class="nv">bad-users</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">complain</span> <span class="nv">user</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">var</span> <span class="p">(</span><span class="nb">sort</span> <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">x</span> <span class="nv">being</span> <span class="k">the</span> <span class="nv">hash-keys</span> <span class="nv">of</span> <span class="nv">axl</span>
                      <span class="nv">collect</span> <span class="nv">x</span><span class="p">)</span> <span class="nf">#&#39;</span><span class="nb">&lt;</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A=~A~%&quot;</span> <span class="nv">var</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">var</span> <span class="nv">ENV</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">user</span> <span class="nv">all-users</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">disk-space</span> <span class="p">(</span><span class="nv">get-usage</span> <span class="nv">user</span><span class="p">)))</span>
    <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">&gt;</span> <span class="nv">disk-space</span> <span class="nv">+max-quota+</span><span class="p">)</span>
      <span class="p">(</span><span class="nv">complain</span> <span class="nv">user</span><span class="p">))))</span>
<span class="c1">;;;-----------------------------</span>
<span class="o">#+</span><span class="nv">sbcl</span>
<span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">line</span> <span class="p">(</span><span class="nv">split</span> <span class="s">&quot;\\n&quot;</span>
                     <span class="p">(</span><span class="nb">with-output-to-string</span> <span class="p">(</span><span class="nv">output</span><span class="p">)</span>
                       <span class="p">(</span><span class="nv">sb-ext:run-program</span> <span class="s">&quot;who&quot;</span> <span class="no">nil</span> <span class="ss">:search</span> <span class="no">t</span> <span class="ss">:output</span> <span class="nv">output</span><span class="p">))))</span>
  <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nv">scan</span> <span class="s">&quot;tchrist&quot;</span> <span class="nv">line</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A~%&quot;</span> <span class="nv">line</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">line</span> <span class="nb">=</span> <span class="p">(</span><span class="nb">read-line</span> <span class="nv">fh</span> <span class="no">nil</span> <span class="ss">:eof</span> <span class="no">nil</span><span class="p">)</span> <span class="c1">; LINE is set to the line just read</span>
   <span class="nv">until</span> <span class="p">(</span><span class="nb">eq</span> <span class="nv">line</span> <span class="ss">:eof</span><span class="p">)</span>
   <span class="nb">do</span>
   <span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">chunk</span> <span class="p">(</span><span class="nv">split</span> <span class="s">&quot;\\s+&quot;</span>         <span class="c1">; LINE is split on whitespace</span>
                                        <span class="c1">; then CHUNK is set to each chunk in turn</span>
                         <span class="p">(</span><span class="nv">chomp</span> <span class="nv">line</span><span class="p">)))</span> <span class="c1">; LINE has a trailing \n removed, if it had one</span>
     <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A&quot;</span>                     <span class="c1">; CHUNK is printed</span>
             <span class="p">(</span><span class="nb">reverse</span> <span class="nv">chunk</span><span class="p">))))</span>         <span class="c1">; the characters in CHUNK are reversed</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">map</span> <span class="no">nil</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">item</span><span class="p">)</span>
             <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;i = ~A~%&quot;</span> <span class="nv">item</span><span class="p">))</span>
     <span class="nv">my-array</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">my-array</span> <span class="o">#(</span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span><span class="p">))</span>
<span class="p">(</span><span class="nb">map-into</span> <span class="nv">my-array</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">item</span><span class="p">)</span> <span class="p">(</span><span class="nb">decf</span> <span class="nv">item</span><span class="p">))</span> <span class="nv">my-array</span><span class="p">)</span>
<span class="nv">my-array</span>
<span class="c1">;; #(0 1 2)</span>

<span class="c1">;; multiply everything in a and b by seven</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">a</span> <span class="o">#(</span><span class="mf">.5</span> <span class="mi">3</span><span class="p">)</span> <span class="nv">b</span> <span class="o">#(</span><span class="mi">0</span> <span class="mi">1</span><span class="p">))</span>
<span class="p">(</span><span class="nb">map-into</span> <span class="nv">a</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">item</span><span class="p">)</span> <span class="p">(</span><span class="nb">*</span> <span class="nv">item</span> <span class="mi">7</span><span class="p">))</span> <span class="nv">a</span><span class="p">)</span>
<span class="p">(</span><span class="nb">map-into</span> <span class="nv">b</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">item</span><span class="p">)</span> <span class="p">(</span><span class="nb">*</span> <span class="nv">item</span> <span class="mi">7</span><span class="p">))</span> <span class="nv">b</span><span class="p">)</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~{~A~^ ~} ~{~A~^ ~}~%&quot;</span> <span class="p">(</span><span class="nb">coerce</span> <span class="nv">a</span> <span class="ss">&#39;list</span><span class="p">)</span> <span class="p">(</span><span class="nb">coerce</span> <span class="nv">b</span> <span class="ss">&#39;list</span><span class="p">))</span>
<span class="c1">;; 3.5 21 0 7</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; The following macro is mostly like Perl&#39;s foreach, in the sense</span>
<span class="c1">;; that you can pass in as many references to sequences or &quot;scalars&quot;</span>
<span class="c1">;; as you want and it will iterate over them and allow you to modify</span>
<span class="c1">;; them.  Unlike the Perl code, it sets the variable IT to each</span>
<span class="c1">;; element rather than $_.  Also, you have to just pass in the hash</span>
<span class="c1">;; table directly, not a flattened list of hash keys.</span>
<span class="p">(</span><span class="nb">defmacro</span> <span class="nv">perl-foreach</span> <span class="p">((</span><span class="k">&amp;rest</span> <span class="nv">refs</span><span class="p">)</span> <span class="k">&amp;body</span> <span class="nv">body</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="nv">gensyms</span> <span class="p">(</span><span class="nb">loop</span> <span class="nv">repeat</span> <span class="p">(</span><span class="nb">length</span> <span class="nv">refs</span><span class="p">)</span> <span class="nv">collect</span> <span class="p">(</span><span class="nb">gensym</span><span class="p">))))</span>
    <span class="p">(</span><span class="nb">list*</span>
     <span class="ss">&#39;let</span>
     <span class="p">(</span><span class="nb">mapcar</span> <span class="nf">#&#39;</span><span class="nb">list</span> <span class="nv">gensyms</span> <span class="nv">refs</span><span class="p">)</span>
     <span class="p">(</span><span class="nb">loop</span>
        <span class="nv">for</span> <span class="nv">ref</span> <span class="nv">in</span> <span class="nv">refs</span>
        <span class="nb">and</span> <span class="nv">indirect-ref</span> <span class="nv">in</span> <span class="nv">gensyms</span>
        <span class="nv">collect</span>
        <span class="o">`</span><span class="p">(</span><span class="nb">typecase</span> <span class="o">,</span><span class="nv">indirect-ref</span>
           <span class="p">(</span><span class="nc">hash-table</span>
            <span class="p">(</span><span class="nb">maphash</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">key</span> <span class="nv">value</span><span class="p">)</span>
                         <span class="p">(</span><span class="k">declare</span> <span class="p">(</span><span class="k">ignore</span> <span class="nv">value</span><span class="p">))</span>
                         <span class="p">(</span><span class="k">symbol-macrolet</span> <span class="p">((</span><span class="nv">it</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">key</span> <span class="o">,</span><span class="nv">indirect-ref</span><span class="p">)))</span>
                           <span class="o">,@</span><span class="nv">body</span><span class="p">))</span>
                     <span class="o">,</span><span class="nv">indirect-ref</span><span class="p">))</span>
           <span class="p">((</span><span class="nb">and</span> <span class="p">(</span><span class="nb">or</span> <span class="nb">vector</span> <span class="nb">list</span><span class="p">)</span> <span class="p">(</span><span class="nb">not</span> <span class="nb">string</span><span class="p">))</span>
            <span class="p">(</span><span class="nb">map-into</span> <span class="o">,</span><span class="nv">indirect-ref</span>
                      <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">it</span><span class="p">)</span>
                          <span class="o">,@</span><span class="nv">body</span>
                          <span class="nv">it</span><span class="p">)</span>
                      <span class="o">,</span><span class="nv">indirect-ref</span><span class="p">))</span>
           <span class="p">(</span><span class="no">t</span>
            <span class="p">(</span><span class="k">symbol-macrolet</span> <span class="p">((</span><span class="nv">it</span> <span class="o">,</span><span class="nv">ref</span><span class="p">))</span>
              <span class="o">,@</span><span class="nv">body</span><span class="p">)))))))</span>

<span class="c1">;; trim whitespace in the scalar, the list, the array, and all the</span>
<span class="c1">;; values in the hash</span>
<span class="p">(</span><span class="nv">perl-foreach</span> <span class="p">(</span><span class="nv">scalar</span> <span class="nv">my-list</span> <span class="nv">my-array</span> <span class="nv">my-hash</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">setf</span> <span class="nv">it</span> <span class="p">(</span><span class="nv">regex-replace</span> <span class="s">&quot;^\\s+&quot;</span> <span class="nv">it</span> <span class="s">&quot;&quot;</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">setf</span> <span class="nv">it</span> <span class="p">(</span><span class="nv">regex-replace</span> <span class="s">&quot;\\s+$&quot;</span> <span class="nv">it</span> <span class="s">&quot;&quot;</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; The Perl code in this subsection is Perl-specific (demonstrating</span>
<span class="c1">;; the shorthand syntax for &quot;foreach&quot;).</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_4.5</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; iterate over elements of array in ARRAYREF (but if you intend to</span>
<span class="c1">;; modify the elemnts, it will only modify non-&quot;scalar&quot; elements such</span>
<span class="c1">;; as lists, structures, etc).</span>
<span class="p">(</span><span class="nb">map</span> <span class="ss">&#39;array</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">item</span><span class="p">)</span>
                <span class="c1">;; do something with ITEM</span>
                <span class="p">)</span>
     <span class="nv">arrayref</span><span class="p">)</span>

<span class="c1">;; or you can use LOOP</span>
<span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">item</span> <span class="nv">across</span> <span class="nv">arrayref</span>
     <span class="nb">do</span> <span class="c1">;; do something with ITEM</span>
     <span class="p">)</span>

<span class="c1">;; to modify the array contents (even if they&#39;re &quot;scalars&quot; like</span>
<span class="c1">;; numbers)</span>
<span class="p">(</span><span class="nb">map-into</span> <span class="nv">arrayref</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">item</span><span class="p">)</span>
                       <span class="c1">;; do something with ITEM</span>
                       <span class="p">)</span>
          <span class="nv">arrayref</span><span class="p">)</span>

<span class="c1">;; or you can use ITER</span>
<span class="p">(</span><span class="nv">iter</span> <span class="p">(</span><span class="nv">for</span> <span class="nv">i</span> <span class="nv">index-of-vector</span> <span class="nv">arrayref</span><span class="p">)</span>
      <span class="c1">;; do something with (aref arrayref i)</span>
      <span class="p">)</span>

<span class="c1">;; As a side note, for lists you could also do the following (won&#39;t</span>
<span class="c1">;; allow modifying &quot;scalar&quot; elements of the list).</span>
<span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">item</span> <span class="nb">list</span><span class="p">)</span>
  <span class="c1">;; do something with ITEM</span>
  <span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*fruits*</span> <span class="o">#(</span><span class="s">&quot;Apple&quot;</span> <span class="s">&quot;Blackberry&quot;</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">fruit-ref</span> <span class="vg">*fruits*</span><span class="p">)</span>
<span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">fruit</span> <span class="nv">across</span> <span class="nv">fruit-ref</span>
   <span class="nb">do</span> <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A tastes good in a pie.~%&quot;</span> <span class="nv">fruit</span><span class="p">))</span>
<span class="c1">;;Apple tastes good in a pie.</span>
<span class="c1">;;Blackberry tastes good in a pie.</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">i</span> <span class="nv">below</span> <span class="p">(</span><span class="nb">length</span> <span class="nv">fruit-ref</span><span class="p">)</span>
   <span class="nb">do</span> <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A tastes good in a pie.~%&quot;</span> <span class="p">(</span><span class="nb">svref</span> <span class="nv">fruit-ref</span> <span class="nv">i</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:felines</span> <span class="vg">*namelist*</span><span class="p">)</span> <span class="vg">*rogue-cats*</span><span class="p">)</span>
<span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">cat</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:felines</span> <span class="vg">*namelist*</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A purrs hypnotically..~%&quot;</span> <span class="nv">cat</span><span class="p">))</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;--More--~%You are controlled.~%&quot;</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">i</span> <span class="nv">below</span> <span class="p">(</span><span class="nb">length</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:felines</span> <span class="vg">*namelist*</span><span class="p">))</span>
   <span class="nb">do</span> <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A purrs hypnotically..~%&quot;</span> <span class="p">(</span><span class="nb">elt</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:felines</span> <span class="vg">*namelist*</span><span class="p">)</span> <span class="nv">i</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_4.6</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*seen*</span> <span class="p">(</span><span class="nb">make-hash-table</span> <span class="ss">:test</span> <span class="ss">&#39;equal</span><span class="p">))</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*uniq*</span> <span class="o">&#39;</span><span class="p">())</span>

<span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">item</span> <span class="nv">my-list</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">item</span> <span class="vg">*seen*</span><span class="p">)</span>
    <span class="c1">;; if we are here, we have not seen it before</span>
    <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">item</span> <span class="vg">*seen*</span><span class="p">)</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">push</span> <span class="nv">item</span> <span class="vg">*uniq*</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">clrhash</span> <span class="vg">*seen*</span><span class="p">)</span>
<span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">item</span> <span class="nv">my-list</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">=</span> <span class="p">(</span><span class="nb">incf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">item</span> <span class="vg">*seen*</span> <span class="mi">0</span><span class="p">))</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">push</span> <span class="nv">item</span> <span class="vg">*uniq*</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">clrhash</span> <span class="vg">*seen*</span><span class="p">)</span>
<span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">item</span> <span class="nv">my-list</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">=</span> <span class="p">(</span><span class="nb">incf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">item</span> <span class="vg">*seen*</span> <span class="mi">0</span><span class="p">))</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">some-func</span> <span class="nv">item</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">clrhash</span> <span class="vg">*seen*</span><span class="p">)</span>
<span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">item</span> <span class="nv">my-list</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">incf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">item</span> <span class="vg">*seen*</span> <span class="mi">0</span><span class="p">)))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="vg">*uniq*</span> <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">k</span> <span class="nv">being</span> <span class="k">the</span> <span class="nv">hash-keys</span> <span class="nv">of</span> <span class="vg">*seen*</span> <span class="nv">collect</span> <span class="nv">k</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">clrhash</span> <span class="vg">*seen*</span><span class="p">)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="vg">*uniq*</span> <span class="p">(</span><span class="nv">perl-grep</span> <span class="nv">my-list</span> <span class="p">(</span><span class="nb">=</span> <span class="mi">1</span> <span class="p">(</span><span class="nb">incf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">it</span> <span class="vg">*seen*</span> <span class="mi">0</span><span class="p">)))))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; generate a list of users logged in, removing duplicates</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*ucnt*</span> <span class="p">(</span><span class="nb">make-hash-table</span> <span class="ss">:test</span> <span class="ss">&#39;equal</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defmacro</span> <span class="nv">dostream</span> <span class="p">((</span><span class="nv">var</span> <span class="nc">stream</span><span class="p">)</span> <span class="k">&amp;body</span> <span class="nv">body</span><span class="p">)</span>
  <span class="s">&quot;Like DOLIST except iterates over the lines of STREAM.  Does not</span>
<span class="s">close STREAM.&quot;</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">s</span> <span class="p">(</span><span class="nb">gensym</span> <span class="s">&quot;stream-&quot;</span><span class="p">))</span>
        <span class="p">(</span><span class="nv">eof</span> <span class="p">(</span><span class="nb">gensym</span> <span class="s">&quot;eof-&quot;</span><span class="p">)))</span>
    <span class="o">`</span><span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="o">,</span><span class="nv">s</span> <span class="o">,</span><span class="nc">stream</span><span class="p">))</span>
       <span class="p">(</span><span class="nb">do</span> <span class="p">((</span><span class="o">,</span><span class="nv">var</span> <span class="p">(</span><span class="nb">read-line</span> <span class="o">,</span><span class="nv">s</span> <span class="no">nil</span> <span class="ss">&#39;,eof</span> <span class="no">nil</span><span class="p">)</span>
                  <span class="p">(</span><span class="nb">read-line</span> <span class="o">,</span><span class="nv">s</span> <span class="no">nil</span> <span class="ss">&#39;,eof</span> <span class="no">nil</span><span class="p">)))</span>
           <span class="p">((</span><span class="nb">eql</span> <span class="o">,</span><span class="nv">var</span> <span class="ss">&#39;,eof</span><span class="p">))</span>
         <span class="o">,@</span><span class="nv">body</span><span class="p">))))</span>

<span class="o">#+</span><span class="nv">sbcl</span>
<span class="p">(</span><span class="nb">with-open-stream</span> <span class="p">(</span><span class="nv">s</span> <span class="p">(</span><span class="nv">process-output</span>
                      <span class="p">(</span><span class="nv">sb-ext:run-program</span> <span class="s">&quot;who&quot;</span> <span class="no">nil</span> <span class="ss">:search</span> <span class="no">t</span> <span class="ss">:output</span> <span class="ss">:stream</span> <span class="ss">:wait</span> <span class="no">nil</span><span class="p">)))</span>
  <span class="p">(</span><span class="nv">dostream</span> <span class="p">(</span><span class="nv">who</span> <span class="nv">s</span><span class="p">)</span>
    <span class="c1">;; kill from first space till end-of-line, yielding username</span>
    <span class="p">(</span><span class="nb">setf</span> <span class="nv">who</span> <span class="p">(</span><span class="nv">regex-replace</span> <span class="s">&quot;\\s.*$&quot;</span> <span class="nv">who</span> <span class="s">&quot;&quot;</span><span class="p">))</span>
    <span class="p">(</span><span class="nb">incf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">who</span> <span class="vg">*ucnt*</span> <span class="mi">0</span><span class="p">))))</span> <span class="c1">; record the presence of this user</span>
<span class="c1">;; extract and print unique keys</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*users*</span> <span class="p">(</span><span class="nb">sort</span> <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">k</span> <span class="nv">being</span> <span class="k">the</span> <span class="nv">hash-keys</span> <span class="nv">of</span> <span class="vg">*ucnt*</span> <span class="nv">collect</span> <span class="nv">k</span><span class="p">)</span> <span class="nf">#&#39;</span><span class="nb">string=</span><span class="p">))</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;users logged in: ~{~A~^ ~}~%&quot;</span> <span class="vg">*users*</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_4.7</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; assume A and B are already loaded</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*seen*</span> <span class="p">(</span><span class="nb">make-hash-table</span> <span class="ss">:test</span> <span class="ss">&#39;equal</span><span class="p">))</span> <span class="c1">; lookup table to test membership of B</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*a-only*</span> <span class="o">&#39;</span><span class="p">())</span>                          <span class="c1">; answer</span>

<span class="c1">;; build lookup table</span>
<span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">item</span> <span class="nv">in</span> <span class="nv">b</span> <span class="nb">do</span> <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">item</span> <span class="vg">*seen*</span><span class="p">)</span> <span class="mi">1</span><span class="p">))</span>

<span class="c1">;; find only elements in A and not in B</span>
<span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">item</span> <span class="nv">a</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">item</span> <span class="vg">*seen*</span><span class="p">)</span>
    <span class="c1">;; it&#39;s not in SEEN, so add to *A-ONLY*</span>
    <span class="p">(</span><span class="nb">push</span> <span class="nv">item</span> <span class="vg">*a-only*</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; The Perl example here isn&#39;t substantially different from the above</span>
<span class="c1">;; in CL.</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">item</span> <span class="nv">a</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">item</span> <span class="vg">*seen*</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">push</span> <span class="nv">item</span> <span class="vg">*a-only*</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">item</span> <span class="vg">*seen*</span><span class="p">)</span> <span class="mi">1</span><span class="p">))</span> <span class="c1">; mark as seen</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="s">&quot;key1&quot;</span> <span class="nv">my-hash</span><span class="p">)</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="s">&quot;key2&quot;</span> <span class="nv">my-hash</span><span class="p">)</span> <span class="mi">2</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">loop</span>
   <span class="nv">for</span> <span class="nv">key</span> <span class="nv">in</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;key1&quot;</span> <span class="s">&quot;key2&quot;</span><span class="p">)</span>
   <span class="nb">and</span> <span class="nv">value</span> <span class="nv">in</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">1</span> <span class="mi">2</span><span class="p">)</span>
   <span class="nb">do</span> <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">key</span> <span class="nv">my-hash</span><span class="p">)</span> <span class="nv">value</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">loop</span>
   <span class="nv">for</span> <span class="nv">key</span> <span class="nv">in</span> <span class="nv">b</span>
   <span class="nb">do</span> <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">key</span> <span class="nv">my-hash</span><span class="p">)</span> <span class="no">nil</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">loop</span>
   <span class="nv">for</span> <span class="nv">key</span> <span class="nv">in</span> <span class="nv">b</span>
   <span class="nb">do</span> <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">key</span> <span class="nv">my-hash</span><span class="p">)</span> <span class="p">(</span><span class="nb">loop</span> <span class="nv">repeat</span> <span class="p">(</span><span class="nb">length</span> <span class="nv">b</span><span class="p">)</span> <span class="nv">collect</span> <span class="mi">1</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_4.8</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*a*</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">1</span> <span class="mi">3</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span><span class="p">))</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*b*</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">2</span> <span class="mi">3</span> <span class="mi">5</span> <span class="mi">7</span> <span class="mi">9</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defvar</span> <span class="vg">*union*</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defvar</span> <span class="vg">*isect*</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defvar</span> <span class="vg">*diff*</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*union-hash*</span> <span class="p">(</span><span class="nb">make-hash-table</span><span class="p">))</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*isect-hash*</span> <span class="p">(</span><span class="nb">make-hash-table</span><span class="p">))</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*count*</span> <span class="p">(</span><span class="nb">make-hash-table</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; don&#39;t actually do this, use instead the built-ins shown at the end</span>
<span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">e</span> <span class="vg">*a*</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">e</span> <span class="vg">*union-hash*</span><span class="p">)</span> <span class="mi">1</span><span class="p">))</span>

<span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">e</span> <span class="vg">*b*</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">e</span> <span class="vg">*union-hash*</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">e</span> <span class="vg">*isect-hash*</span><span class="p">)</span> <span class="mi">1</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">e</span> <span class="vg">*union-hash*</span><span class="p">)</span> <span class="mi">1</span><span class="p">))</span>

<span class="p">(</span><span class="nb">setf</span> <span class="vg">*union*</span> <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">k</span> <span class="nv">being</span> <span class="k">the</span> <span class="nv">hash-keys</span> <span class="nv">of</span> <span class="vg">*union-hash*</span> <span class="nv">collect</span> <span class="nv">k</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="vg">*isect*</span> <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">k</span> <span class="nv">being</span> <span class="k">the</span> <span class="nv">hash-keys</span> <span class="nv">of</span> <span class="vg">*isect-hash*</span> <span class="nv">collect</span> <span class="nv">k</span><span class="p">))</span>

<span class="c1">;; or you could use the built ins</span>
<span class="p">(</span><span class="nb">setf</span> <span class="vg">*union*</span> <span class="p">(</span><span class="nb">union</span> <span class="vg">*a*</span> <span class="vg">*b*</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="vg">*isect*</span> <span class="p">(</span><span class="nb">intersection</span> <span class="vg">*a*</span> <span class="vg">*b*</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nv">perl-foreach</span> <span class="p">(</span><span class="vg">*a*</span> <span class="vg">*b*</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">and</span> <span class="p">(</span><span class="nb">prog1</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">it</span> <span class="vg">*union-hash*</span><span class="p">)</span>
         <span class="p">(</span><span class="nb">incf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">it</span> <span class="vg">*union-hash*</span> <span class="mi">0</span><span class="p">)))</span>
       <span class="p">(</span><span class="nb">incf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">it</span> <span class="vg">*isect-hash*</span> <span class="mi">0</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">setf</span> <span class="vg">*union*</span> <span class="p">(</span><span class="nv">hash-keys</span> <span class="vg">*union-hash*</span><span class="p">))</span> <span class="c1">; HASH-KEYS defined in Appendix</span>
<span class="p">(</span><span class="nb">setf</span> <span class="vg">*isect*</span> <span class="p">(</span><span class="nv">hash-keys</span> <span class="vg">*isect-hash*</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nv">perl-foreach</span> <span class="p">(</span><span class="vg">*a*</span> <span class="vg">*b*</span><span class="p">)</span> <span class="p">(</span><span class="nb">incf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">it</span> <span class="vg">*count*</span> <span class="mi">0</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">loop</span>
   <span class="nv">for</span> <span class="nv">e</span> <span class="nv">being</span> <span class="k">the</span> <span class="nv">hash-keys</span> <span class="nv">of</span> <span class="vg">*count*</span> <span class="nv">using</span> <span class="p">(</span><span class="nv">hash-value</span> <span class="nb">count</span><span class="p">)</span>
   <span class="nb">do</span>
   <span class="p">(</span><span class="nb">push</span> <span class="nv">e</span> <span class="vg">*union*</span><span class="p">)</span>
   <span class="p">(</span><span class="nb">case</span> <span class="nb">count</span>
     <span class="p">(</span><span class="mi">2</span> <span class="p">(</span><span class="nb">push</span> <span class="nv">e</span> <span class="vg">*isect*</span><span class="p">))</span>
     <span class="p">(</span><span class="no">t</span> <span class="p">(</span><span class="nb">push</span> <span class="nv">e</span> <span class="vg">*diff*</span><span class="p">))))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Without writing a special macro, there&#39;d be no obvious difference</span>
<span class="c1">;; from the previous example.</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_4.9</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; push</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">array1</span> <span class="p">(</span><span class="nb">append</span> <span class="nv">array1</span> <span class="nv">array2</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">array1</span> <span class="o">`</span><span class="p">(</span><span class="o">,@</span><span class="nv">array1</span> <span class="o">,@</span><span class="nv">array2</span><span class="p">))</span>
<span class="c1">;;-----------------------------</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">members</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;Time&quot;</span> <span class="s">&quot;Flies&quot;</span><span class="p">))</span>
      <span class="p">(</span><span class="nv">initiates</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;An&quot;</span> <span class="s">&quot;Arrow&quot;</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">setf</span> <span class="nv">members</span> <span class="p">(</span><span class="nb">append</span> <span class="nv">members</span> <span class="nv">initiates</span><span class="p">))</span>
<span class="c1">;; members is now (&quot;Time&quot; &quot;Flies&quot; &quot;An&quot; &quot;Arrow&quot;)</span>
<span class="c1">;;;-----------------------------</span>
  <span class="p">(</span><span class="nb">setf</span> <span class="nv">members</span> <span class="o">`</span><span class="p">(</span><span class="o">,@</span><span class="p">(</span><span class="nb">subseq</span> <span class="nv">members</span> <span class="mi">0</span> <span class="mi">2</span><span class="p">)</span> <span class="s">&quot;Like&quot;</span> <span class="o">,@</span><span class="nv">initiates</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~{~a~^ ~}~%&quot;</span> <span class="nv">members</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">setf</span> <span class="nv">members</span> <span class="o">`</span><span class="p">(</span><span class="s">&quot;Fruit&quot;</span> <span class="o">,@</span><span class="p">(</span><span class="nb">subseq</span> <span class="nv">members</span> <span class="mi">1</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">setf</span> <span class="nv">members</span> <span class="o">`</span><span class="p">(</span><span class="o">,@</span><span class="p">(</span><span class="nb">subseq</span> <span class="nv">members</span> <span class="mi">0</span> <span class="p">(</span><span class="nb">-</span> <span class="p">(</span><span class="nb">length</span> <span class="nv">members</span><span class="p">)</span> <span class="mi">2</span><span class="p">))</span> <span class="s">&quot;A&quot;</span> <span class="s">&quot;Banana&quot;</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~{~a~^ ~}~%&quot;</span> <span class="nv">members</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;;Time Flies Like An Arrow</span>
<span class="c1">;;Fruit Flies Like A Banana</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_4.10</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; reverse ARRAY into REVERSED</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">reversed</span> <span class="p">(</span><span class="nb">reverse</span> <span class="vg">*array*</span><span class="p">))</span>
<span class="c1">;;-----------------------------</span>
<span class="p">(</span><span class="nb">do</span> <span class="p">((</span><span class="nv">i</span> <span class="p">(</span><span class="nb">1-</span> <span class="p">(</span><span class="nb">array-dimension</span> <span class="vg">*array*</span> <span class="mi">0</span><span class="p">))</span> <span class="p">(</span><span class="nb">1-</span> <span class="nv">i</span><span class="p">)))</span>
    <span class="p">((</span><span class="nb">minusp</span> <span class="nv">i</span><span class="p">))</span>
  <span class="c1">;; do something with (aref array i)</span>
  <span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; two-step: sort then reverse</span>
<span class="c1">;; SORT is destructive, hence STABLE-SORT</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">ascending</span> <span class="p">(</span><span class="nb">stable-sort</span> <span class="nv">users</span> <span class="ss">&#39;string-lessp</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">descending</span> <span class="p">(</span><span class="nb">reverse</span> <span class="nv">ascending</span><span class="p">))</span>

<span class="c1">;; one-step: sort with reverse comparison</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">descending</span> <span class="p">(</span><span class="nb">reverse</span> <span class="p">(</span><span class="nb">stable-sort</span> <span class="nv">users</span> <span class="ss">&#39;string-lessp</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_4.11</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Removing N elements from front of MY-ARRAY requires 2 steps in CL.</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">front</span> <span class="p">(</span><span class="nb">subseq</span> <span class="nv">my-array</span> <span class="mi">0</span> <span class="nv">n</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">my-array</span> <span class="p">(</span><span class="nb">subseq</span> <span class="nv">my-array</span> <span class="nv">n</span><span class="p">))</span>

<span class="c1">;; We can write a macro to mimic Perl&#39;s behavior, however.</span>
<span class="p">(</span><span class="nb">defmacro</span> <span class="nv">perl-splice</span> <span class="p">(</span><span class="nv">sequence-place</span> <span class="k">&amp;optional</span> <span class="p">(</span><span class="nv">offset</span> <span class="mi">0</span><span class="p">)</span> <span class="nb">length</span> <span class="nv">replacement-sequence</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="nv">seq</span> <span class="p">(</span><span class="nb">gensym</span> <span class="s">&quot;SEQUENCE-PLACE-&quot;</span><span class="p">))</span>
         <span class="p">(</span><span class="nv">off-arg</span> <span class="p">(</span><span class="nb">gensym</span> <span class="s">&quot;OFFSET-ARG-&quot;</span><span class="p">))</span>
         <span class="p">(</span><span class="nv">off</span> <span class="p">(</span><span class="nb">gensym</span> <span class="s">&quot;OFFSET-&quot;</span><span class="p">))</span>
         <span class="p">(</span><span class="nv">len</span> <span class="p">(</span><span class="nb">gensym</span> <span class="s">&quot;LENGTH-&quot;</span><span class="p">))</span>
         <span class="p">(</span><span class="nv">end</span> <span class="p">(</span><span class="nb">gensym</span> <span class="s">&quot;END-&quot;</span><span class="p">))</span>
         <span class="p">(</span><span class="nv">rep</span> <span class="p">(</span><span class="nb">gensym</span> <span class="s">&quot;REPLACEMENT-SEQUENCE-&quot;</span><span class="p">))</span>
         <span class="p">(</span><span class="nv">left-part</span> <span class="p">(</span><span class="nb">list</span> <span class="o">`</span><span class="p">(</span><span class="nb">subseq</span> <span class="o">,</span><span class="nv">seq</span> <span class="mi">0</span> <span class="o">,</span><span class="nv">off</span><span class="p">)))</span>
         <span class="p">(</span><span class="nv">right-part</span> <span class="p">(</span><span class="nb">when</span> <span class="nb">length</span>
                       <span class="p">(</span><span class="nb">list</span> <span class="o">`</span><span class="p">(</span><span class="nb">subseq</span> <span class="o">,</span><span class="nv">seq</span> <span class="o">,</span><span class="nv">end</span><span class="p">)))))</span>
    <span class="o">`</span><span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="o">,</span><span class="nv">seq</span> <span class="o">,</span><span class="nv">sequence-place</span><span class="p">)</span>
            <span class="p">(</span><span class="o">,</span><span class="nv">off-arg</span> <span class="o">,</span><span class="nv">offset</span><span class="p">)</span>
            <span class="p">(</span><span class="o">,</span><span class="nv">off</span> <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">minusp</span> <span class="o">,</span><span class="nv">off-arg</span><span class="p">)</span>
                      <span class="p">(</span><span class="nb">+</span> <span class="p">(</span><span class="nb">length</span> <span class="o">,</span><span class="nv">seq</span><span class="p">)</span> <span class="o">,</span><span class="nv">off-arg</span><span class="p">)</span>
                      <span class="o">,</span><span class="nv">off-arg</span><span class="p">))</span>
            <span class="p">(</span><span class="o">,</span><span class="nv">len</span> <span class="o">,</span><span class="nb">length</span><span class="p">)</span>
            <span class="p">(</span><span class="o">,</span><span class="nv">end</span> <span class="p">(</span><span class="nb">when</span> <span class="o">,</span><span class="nv">len</span>
                    <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">minusp</span> <span class="o">,</span><span class="nv">len</span><span class="p">)</span>
                        <span class="p">(</span><span class="nb">+</span> <span class="p">(</span><span class="nb">length</span> <span class="o">,</span><span class="nv">seq</span><span class="p">)</span> <span class="o">,</span><span class="nv">len</span><span class="p">)</span>
                        <span class="p">(</span><span class="nb">+</span> <span class="o">,</span><span class="nv">off</span> <span class="o">,</span><span class="nv">len</span><span class="p">))))</span>
            <span class="p">(</span><span class="o">,</span><span class="nv">rep</span> <span class="o">,</span><span class="nv">replacement-sequence</span><span class="p">))</span>
       <span class="p">(</span><span class="nb">prog1</span> <span class="p">(</span><span class="nb">subseq</span> <span class="o">,</span><span class="nv">seq</span> <span class="o">,</span><span class="nv">off</span> <span class="o">,</span><span class="nv">end</span><span class="p">)</span>
         <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">or</span> <span class="o">,</span><span class="nv">rep</span> <span class="p">(</span><span class="nb">not</span> <span class="p">(</span><span class="nb">eql</span> <span class="o">,</span><span class="nv">off</span> <span class="o">,</span><span class="nv">end</span><span class="p">)))</span>
           <span class="p">(</span><span class="nb">setf</span> <span class="o">,</span><span class="nv">sequence-place</span> <span class="p">(</span><span class="nb">concatenate</span> <span class="p">(</span><span class="nb">typecase</span> <span class="o">,</span><span class="nv">seq</span>
                                                <span class="p">(</span><span class="nb">cons</span> <span class="ss">&#39;list</span><span class="p">)</span>
                                              <span class="p">(</span><span class="no">t</span> <span class="ss">&#39;vector</span><span class="p">))</span>
                                            <span class="o">,@</span><span class="nv">left-part</span>
                                            <span class="o">,</span><span class="nv">rep</span>
                                            <span class="o">,@</span><span class="nv">right-part</span><span class="p">)))))))</span>

<span class="c1">;; Now the syntax is almost exactly the same.</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">front</span> <span class="p">(</span><span class="nv">perl-splice</span> <span class="nv">my-array</span> <span class="mi">0</span> <span class="nv">n</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">end</span> <span class="p">(</span><span class="nv">perl-splice</span> <span class="nv">my-array</span> <span class="mi">0</span> <span class="p">(</span><span class="nb">-</span> <span class="nv">n</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defmacro</span> <span class="nv">shift2</span> <span class="p">(</span><span class="nc">sequence</span><span class="p">)</span>
  <span class="o">`</span><span class="p">(</span><span class="nv">perl-splice</span> <span class="o">,</span><span class="nc">sequence</span> <span class="mi">0</span> <span class="mi">2</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defmacro</span> <span class="nv">pop2</span> <span class="p">(</span><span class="nc">sequence</span><span class="p">)</span>
  <span class="o">`</span><span class="p">(</span><span class="nv">perl-splice</span> <span class="o">,</span><span class="nc">sequence</span> <span class="mi">-2</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*friends*</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">Peter</span> <span class="nv">Paul</span> <span class="nv">Mary</span> <span class="nv">Jim</span> <span class="nv">Tim</span><span class="p">))</span>

<span class="p">(</span><span class="nb">destructuring-bind</span> <span class="p">(</span><span class="nv">this</span> <span class="nv">that</span><span class="p">)</span> <span class="p">(</span><span class="nv">shift2</span> <span class="vg">*friends*</span><span class="p">)</span>
  <span class="c1">;; THIS contains PETER, THAT has PAUL, and</span>
  <span class="c1">;; *FRIENDS* has MARY, JIM, and TIM</span>
  <span class="p">)</span>

<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*beverages*</span> <span class="o">#(</span><span class="nv">Dew</span> <span class="nv">Jolt</span> <span class="nv">Cola</span> <span class="nv">Sprite</span> <span class="nv">Fresca</span><span class="p">))</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">pair</span> <span class="p">(</span><span class="nv">pop2</span> <span class="vg">*beverages*</span><span class="p">)))</span>
  <span class="c1">;; (aref pair 0) contains Sprite, (aref pair 1) has Fresca,</span>
  <span class="c1">;; and *beverages* has #(DEW JOLT COLA)</span>
  <span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">aref</span> <span class="nv">line</span> <span class="mi">5</span><span class="p">)</span> <span class="nv">my-list</span><span class="p">)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">got</span> <span class="p">(</span><span class="nv">pop2</span> <span class="p">(</span><span class="nb">aref</span> <span class="nv">line</span> <span class="mi">5</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_4.12</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">match</span> <span class="p">(</span><span class="nb">find</span> <span class="nv">item</span> <span class="vg">*sequence*</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">cond</span>
    <span class="p">(</span><span class="nv">match</span>
     <span class="c1">;; do something with MATCH</span>
     <span class="p">)</span>
    <span class="p">(</span><span class="no">t</span>
     <span class="c1">;; unfound</span>
     <span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">match-idx</span> <span class="p">(</span><span class="nb">position</span> <span class="nv">item</span> <span class="vg">*sequence*</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">cond</span>
    <span class="p">(</span><span class="nv">match-idx</span>
     <span class="c1">;; found in (elt *sequence* match-idx) (any sequence)</span>
     <span class="c1">;; or (svref *sequence* match-idx) if you know it&#39;s a vector</span>
     <span class="p">)</span>
    <span class="p">(</span><span class="no">t</span>
     <span class="c1">;; unfound</span>
     <span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defstruct</span> <span class="nv">employee</span> <span class="nv">name</span> <span class="nv">category</span><span class="p">)</span> <span class="c1">; just to make example work</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;Highest paid engineer is: ~A~%&quot;</span>
        <span class="p">(</span><span class="nv">employee-name</span> <span class="p">(</span><span class="nb">find</span> <span class="ss">&#39;engineer</span> <span class="vg">*employees*</span> <span class="ss">:key</span> <span class="ss">&#39;employee-category</span> <span class="ss">:from-end</span> <span class="no">t</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Don&#39;t do this, just intended how one could match the Perl example.</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">i</span>
       <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">idx</span> <span class="nv">below</span> <span class="p">(</span><span class="nb">length</span> <span class="vg">*array*</span><span class="p">)</span>
          <span class="c1">;;</span>
          <span class="nb">do</span> <span class="p">(</span><span class="nb">when</span> <span class="nv">criterion</span> <span class="c1">;; put criterion here</span>
               <span class="p">(</span><span class="nb">return</span> <span class="nv">idx</span><span class="p">)))))</span>
  <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">&lt;</span> <span class="nv">i</span> <span class="p">(</span><span class="nb">length</span> <span class="vg">*array*</span><span class="p">))</span>
      <span class="p">(</span><span class="k">progn</span>
        <span class="c1">;; found and I is the index</span>
        <span class="p">)</span>
      <span class="p">(</span><span class="k">progn</span>
        <span class="c1">;; not found</span>
        <span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_4.13</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">matching</span> <span class="p">(</span><span class="nb">find-if-not</span> <span class="nf">#&#39;</span><span class="nv">test</span> <span class="nb">list</span><span class="p">))</span>
<span class="c1">;;-----------------------------</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">matching</span> <span class="o">&#39;</span><span class="p">()))</span>
  <span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">item</span> <span class="nb">list</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nv">test</span> <span class="nv">item</span><span class="p">)</span> <span class="p">(</span><span class="nb">push</span> <span class="nv">item</span> <span class="nv">matching</span><span class="p">))))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">bigs</span> <span class="p">(</span><span class="nb">remove-if-not</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">num</span><span class="p">)</span> <span class="p">(</span><span class="nb">&gt;</span> <span class="nv">num</span> <span class="mi">1000000</span><span class="p">))</span> <span class="nv">nums</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">pigs</span> <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">user</span> <span class="nv">being</span> <span class="k">the</span> <span class="nv">hash-keys</span> <span class="nv">of</span> <span class="nv">users</span> <span class="nv">using</span> <span class="p">(</span><span class="nv">hash-value</span> <span class="nv">uid</span><span class="p">)</span>
              <span class="nb">when</span> <span class="p">(</span><span class="nb">&gt;</span> <span class="nv">uid</span> <span class="mf">1e7</span><span class="p">)</span>
              <span class="nv">collect</span> <span class="nv">user</span><span class="p">))</span>

<span class="c1">;;;-----------------------------</span>
<span class="o">#+</span><span class="nv">sbcl</span>
<span class="p">(</span><span class="nb">remove-if-not</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">line</span><span class="p">)</span>
                   <span class="p">(</span><span class="nv">scan</span> <span class="s">&quot;^gnat &quot;</span> <span class="nv">line</span><span class="p">))</span>
               <span class="p">(</span><span class="nv">split</span> <span class="sc">#\Newline</span>
                               <span class="p">(</span><span class="nb">with-output-to-string</span> <span class="p">(</span><span class="nv">output</span><span class="p">)</span>
                                 <span class="p">(</span><span class="nv">sb-ext:run-program</span> <span class="s">&quot;who&quot;</span> <span class="no">nil</span> <span class="ss">:search</span> <span class="no">t</span> <span class="ss">:output</span> <span class="nv">output</span><span class="p">)</span><span class="nv">q</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;;; Assumes DEFSTRUCT or DEFCLASS of EMPLOYEE with a POSITION slot.</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">engineers</span> <span class="p">(</span><span class="nb">remove</span> <span class="s">&quot;Engineer&quot;</span> <span class="nv">employees</span> <span class="ss">:key</span> <span class="nf">#&#39;</span><span class="nv">employee-position</span> <span class="ss">:test-not</span> <span class="ss">&#39;string=</span><span class="p">))</span>
<span class="c1">;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">secondary-assistance</span> <span class="p">(</span><span class="nb">remove-if-not</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">applicant</span><span class="p">)</span>
                                              <span class="p">(</span><span class="nb">and</span> <span class="p">(</span><span class="nb">&gt;=</span> <span class="p">(</span><span class="nv">applicant-income</span> <span class="nv">applicant</span><span class="p">)</span> <span class="mi">26000</span><span class="p">)</span>
                                                   <span class="p">(</span><span class="nb">&lt;</span>  <span class="p">(</span><span class="nv">applicant-income</span> <span class="nv">applicant</span><span class="p">)</span> <span class="mi">30000</span><span class="p">)))</span>
                                          <span class="nv">applicants</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_4.14</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">sorted</span> <span class="p">(</span><span class="nb">stable-sort</span> <span class="nv">unsorted</span> <span class="ss">&#39;&lt;</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; PIDS is an unsorted list of process IDs</span>
<span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">pid</span> <span class="p">(</span><span class="nb">stable-sort</span> <span class="nv">pids</span> <span class="ss">&#39;&lt;</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A~%&quot;</span> <span class="nv">pid</span><span class="p">))</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;Select a process ID to kill:~%&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">pid</span> <span class="p">(</span><span class="nb">read</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">etypecase</span> <span class="nv">pid</span>
    <span class="p">(</span><span class="nc">integer</span> <span class="p">(</span><span class="nv">sb-posix:kill</span> <span class="nv">pid</span> <span class="nv">sb-posix:sigterm</span><span class="p">)</span>
             <span class="p">(</span><span class="nb">sleep</span> <span class="mi">2</span><span class="p">)</span>
             <span class="p">(</span><span class="nb">ignore-errors</span>
               <span class="p">(</span><span class="nv">sb-posix:kill</span> <span class="nv">pid</span> <span class="nv">sb-posix:sigkill</span><span class="p">)))))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">descending</span> <span class="p">(</span><span class="nb">stable-sort</span> <span class="nv">unsorted</span> <span class="ss">&#39;&gt;</span><span class="p">))</span>
<span class="p">(</span><span class="nb">defpackage</span> <span class="ss">:sort-subs</span> <span class="p">(</span><span class="ss">:use</span> <span class="nv">cl</span><span class="p">))</span>
<span class="p">(</span><span class="nb">in-package</span> <span class="ss">:sort-subs</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">revnum</span> <span class="p">(</span><span class="nv">a</span> <span class="nv">b</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">&lt;</span> <span class="nv">b</span> <span class="nv">a</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defpackage</span> <span class="ss">:other-pack</span> <span class="p">(</span><span class="ss">:use</span> <span class="nv">cl</span><span class="p">))</span>
<span class="p">(</span><span class="nb">in-package</span> <span class="ss">:other-pack</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*all*</span> <span class="p">(</span><span class="nb">stable-sort</span> <span class="o">#(</span><span class="mi">4</span> <span class="mi">19</span> <span class="mi">8</span> <span class="mi">3</span><span class="p">)</span> <span class="ss">&#39;sort-subs::revnum</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="vg">*all*</span> <span class="p">(</span><span class="nb">stable-sort</span> <span class="o">#(</span><span class="mi">4</span> <span class="mi">19</span> <span class="mi">8</span> <span class="mi">3</span><span class="p">)</span> <span class="ss">&#39;&gt;</span><span class="p">))</span>
<span class="p">(</span><span class="nb">in-package</span> <span class="ss">:cl-user</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>


<span class="c1">;;; @@PLEAC@@_4.15</span>
<span class="c1">;;; There is nothing special about sorting  a list by computable field in Common</span>
<span class="c1">;;; Lisp. One just need to pass an appropriate `KEY&#39; function to `SORT&#39;.</span>

<span class="p">(</span><span class="nb">defvar</span> <span class="vg">*sample-list*</span>
  <span class="o">&#39;</span><span class="p">((</span><span class="mi">1</span> <span class="mi">-1</span> <span class="mf">0.1</span> <span class="s">&quot;one&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="mi">2</span> <span class="mi">-2</span> <span class="mf">0.2</span> <span class="s">&quot;two&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="mi">3</span> <span class="mi">-3</span> <span class="mf">0.3</span> <span class="s">&quot;three&quot;</span><span class="p">)))</span>

<span class="c1">;;; Just  keep in  mind that,  `SORT&#39; works  destructively. (That&#39;s  why  we use</span>
<span class="c1">;;; `COPY-LIST&#39; in the below expression.)</span>
<span class="p">(</span><span class="nb">sort</span> <span class="p">(</span><span class="nb">copy-list</span> <span class="vg">*sample-list*</span><span class="p">)</span> <span class="nf">#&#39;</span><span class="nb">&lt;</span> <span class="ss">:key</span> <span class="nf">#&#39;</span><span class="nb">first</span><span class="p">)</span>
<span class="c1">; =&gt; ((1 -1 0.1 &quot;one&quot;)</span>
<span class="c1">;     (2 -2 0.2 &quot;two&quot;)</span>
<span class="c1">;     (3 -3 0.3 &quot;three&quot;))</span>

<span class="p">(</span><span class="nb">sort</span> <span class="p">(</span><span class="nb">copy-list</span> <span class="vg">*sample-list*</span><span class="p">)</span> <span class="nf">#&#39;</span><span class="nb">string&lt;</span> <span class="ss">:key</span> <span class="nf">#&#39;</span><span class="nb">fourth</span><span class="p">)</span>
<span class="c1">; =&gt; ((1 -1 0.1 &quot;one&quot;)</span>
<span class="c1">;     (3 -3 0.3 &quot;three&quot;)</span>
<span class="c1">;     (2 -2 0.2 &quot;two&quot;))</span>

<span class="p">(</span><span class="nb">sort</span> <span class="p">(</span><span class="nb">copy-list</span> <span class="vg">*sample-list*</span><span class="p">)</span> <span class="nf">#&#39;</span><span class="nb">&lt;</span>
      <span class="ss">:key</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nb">list</span><span class="p">)</span> <span class="p">(</span><span class="nb">*</span> <span class="p">(</span><span class="nb">second</span> <span class="nb">list</span><span class="p">)</span> <span class="p">(</span><span class="nb">third</span> <span class="nb">list</span><span class="p">))))</span>
<span class="c1">; =&gt; ((3 -3 0.3 &quot;three&quot;)</span>
<span class="c1">;     (2 -2 0.2 &quot;two&quot;)</span>
<span class="c1">;     (1 -1 0.1 &quot;one&quot;))</span>


<span class="c1">;;; @@PLEAC@@_4.16</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;;; The following aren&#39;t efficient on long lists</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">circular</span> <span class="o">`</span><span class="p">(</span><span class="o">,@</span><span class="p">(</span><span class="nb">last</span> <span class="nv">circular</span><span class="p">)</span> <span class="o">,@</span><span class="p">(</span><span class="nb">nbutlast</span> <span class="nv">circular</span><span class="p">)))</span> <span class="c1">; the last shall be first</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">circular</span> <span class="o">`</span><span class="p">(</span><span class="o">,@</span><span class="p">(</span><span class="nb">cdr</span> <span class="nv">circular</span><span class="p">)</span> <span class="o">,</span><span class="p">(</span><span class="nb">car</span> <span class="nv">circular</span><span class="p">)))</span> <span class="c1">; and vice versa</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;;; There is probably a less ugly way to do this</span>
<span class="p">(</span><span class="nb">defmacro</span> <span class="nv">grab-and-rotate</span> <span class="p">(</span><span class="nb">list</span><span class="p">)</span>
  <span class="o">`</span><span class="p">(</span><span class="nb">prog1</span> <span class="p">(</span><span class="nb">car</span> <span class="o">,</span><span class="nb">list</span><span class="p">)</span>
     <span class="p">(</span><span class="nb">setf</span> <span class="o">,</span><span class="nb">list</span> <span class="o">`</span><span class="p">(</span><span class="o">,@</span><span class="p">(</span><span class="nb">cdr</span> <span class="o">,</span><span class="nb">list</span><span class="p">)</span> <span class="o">,</span><span class="p">(</span><span class="nb">car</span> <span class="o">,</span><span class="nb">list</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">processes</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">loop</span>
     <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">process</span> <span class="p">(</span><span class="nv">grab-and-rotate</span> <span class="nv">processes</span><span class="p">)))</span>
       <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;Handling process ~A~%&quot;</span> <span class="nv">process</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">sleep</span> <span class="mi">1</span><span class="p">))))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_4.17</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">fisher-yates-shuffle</span> <span class="p">(</span><span class="nb">vector</span><span class="p">)</span>
  <span class="s">&quot;Randomly shuffle elements of VECTOR.&quot;</span>
  <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">i</span> <span class="nv">from</span> <span class="p">(</span><span class="nb">1-</span> <span class="p">(</span><span class="nb">length</span> <span class="nb">vector</span><span class="p">))</span> <span class="nv">downto</span> <span class="mi">1</span>
     <span class="nv">for</span> <span class="nv">j</span> <span class="nb">=</span> <span class="p">(</span><span class="nb">random</span> <span class="nv">i</span><span class="p">)</span>
     <span class="nb">unless</span> <span class="p">(</span><span class="nb">=</span> <span class="nv">i</span> <span class="nv">j</span><span class="p">)</span>
     <span class="nb">do</span> <span class="p">(</span><span class="nb">rotatef</span> <span class="p">(</span><span class="nb">aref</span> <span class="nb">vector</span> <span class="nv">i</span><span class="p">)</span> <span class="p">(</span><span class="nb">aref</span> <span class="nb">vector</span> <span class="nv">j</span><span class="p">)))</span>
  <span class="nb">vector</span><span class="p">)</span>

<span class="p">(</span><span class="nv">fisher-yates-shuffle</span> <span class="nb">vector</span><span class="p">)</span>           <span class="c1">; permutes VECTOR in place</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">shuffle</span> <span class="p">(</span><span class="nb">vector</span><span class="p">)</span>
  <span class="s">&quot;Return a fresh permuted copy of VECTOR.&quot;</span>
  <span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="nv">n-permutations</span> <span class="p">(</span><span class="nv">factorial</span> <span class="p">(</span><span class="nb">length</span> <span class="nb">vector</span><span class="p">)))</span>
         <span class="p">(</span><span class="nv">permutation</span> <span class="p">(</span><span class="nv">nth-permutation</span> <span class="p">(</span><span class="nb">random</span> <span class="nv">n-permutations</span><span class="p">)</span>
                                       <span class="p">(</span><span class="nb">length</span> <span class="nb">vector</span><span class="p">))))</span>
    <span class="p">(</span><span class="nb">map</span> <span class="ss">&#39;vector</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">i</span><span class="p">)</span> <span class="p">(</span><span class="nb">aref</span> <span class="nb">vector</span> <span class="nv">i</span><span class="p">))</span> <span class="nv">permutation</span><span class="p">)))</span>
<span class="c1">;;;</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">naive-shuffle</span> <span class="p">(</span><span class="nb">vector</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">loop</span> <span class="nv">with</span> <span class="nv">n</span> <span class="nb">=</span> <span class="p">(</span><span class="nb">length</span> <span class="nb">vector</span><span class="p">)</span>
        <span class="nv">for</span> <span class="nv">i</span> <span class="nv">from</span> <span class="mi">0</span> <span class="nv">below</span> <span class="nv">n</span>
        <span class="nv">for</span> <span class="nv">j</span> <span class="nb">=</span> <span class="p">(</span><span class="nb">random</span> <span class="nv">n</span><span class="p">)</span>
        <span class="nb">do</span> <span class="p">(</span><span class="nb">rotatef</span> <span class="p">(</span><span class="nb">aref</span> <span class="nb">vector</span> <span class="nv">i</span><span class="p">)</span> <span class="p">(</span><span class="nb">aref</span> <span class="nb">vector</span> <span class="nv">j</span><span class="p">)))</span>
  <span class="nb">vector</span><span class="p">)</span>


<span class="c1">;;; @@PLEAC@@_4.18</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">print-matrix</span> <span class="p">(</span><span class="nv">matrix</span> <span class="nv">column-len</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;~~{~~{~~@[~~~DA~~^ ~~]~~}~~%~~}&quot;</span> <span class="nv">column-len</span><span class="p">)</span> <span class="nv">matrix</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">pop-matrix-column</span> <span class="p">(</span><span class="nv">matrix</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">when</span> <span class="nv">matrix</span>
    <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nb">elt</span> <span class="p">(</span><span class="nb">caar</span> <span class="nv">matrix</span><span class="p">)))</span>
      <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">matrix</span><span class="p">)</span> <span class="p">(</span><span class="nb">cdar</span> <span class="nv">matrix</span><span class="p">))</span>
      <span class="p">(</span><span class="nb">cons</span> <span class="nb">elt</span> <span class="p">(</span><span class="nv">pop-matrix-column</span> <span class="p">(</span><span class="nb">cdr</span> <span class="nv">matrix</span><span class="p">))))))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">transpose-matrix</span> <span class="p">(</span><span class="nv">matrix</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">matrix</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">cons</span> <span class="p">(</span><span class="nv">pop-matrix-column</span> <span class="nv">matrix</span><span class="p">)</span>
          <span class="p">(</span><span class="nv">transpose-matrix</span> <span class="nv">matrix</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">parse-matrix-row</span> <span class="p">(</span><span class="nb">string</span> <span class="k">&amp;key</span> <span class="nb">count</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">when</span> <span class="nb">string</span> <span class="p">(</span><span class="nv">ppcre:split</span> <span class="s">&quot;\\s+&quot;</span> <span class="nb">string</span> <span class="ss">:limit</span> <span class="nb">count</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">parse-matrix</span> <span class="p">(</span><span class="nc">stream</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">first-row</span> <span class="p">(</span><span class="nv">parse-matrix-row</span> <span class="p">(</span><span class="nb">read-line</span> <span class="nc">stream</span> <span class="no">nil</span> <span class="no">nil</span><span class="p">))))</span>
    <span class="p">(</span><span class="nb">when</span> <span class="nv">first-row</span>
      <span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="nv">n-columns</span> <span class="p">(</span><span class="nb">length</span> <span class="nv">first-row</span><span class="p">))</span>
             <span class="p">(</span><span class="nv">matrix</span>
              <span class="p">(</span><span class="nb">cons</span> <span class="nv">first-row</span>
                    <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">row</span> <span class="nb">=</span> <span class="p">(</span><span class="nv">parse-matrix-row</span>
                                     <span class="p">(</span><span class="nb">read-line</span> <span class="nc">stream</span> <span class="no">nil</span> <span class="no">nil</span><span class="p">)</span>
                                     <span class="ss">:count</span> <span class="nv">n-columns</span><span class="p">)</span>
                          <span class="nv">while</span> <span class="nv">row</span> <span class="nv">collect</span> <span class="nv">row</span><span class="p">)))</span>
             <span class="p">(</span><span class="nv">column-len</span>
              <span class="p">(</span><span class="nb">reduce</span> <span class="nf">#&#39;</span><span class="nb">max</span> <span class="nv">matrix</span>
                      <span class="ss">:key</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">vals</span><span class="p">)</span>
                             <span class="p">(</span><span class="nb">reduce</span> <span class="nf">#&#39;</span><span class="nb">max</span> <span class="nv">vals</span> <span class="ss">:key</span> <span class="nf">#&#39;</span><span class="nb">length</span><span class="p">)))))</span>
        <span class="p">(</span><span class="nv">print-matrix</span> <span class="p">(</span><span class="nv">transpose-matrix</span> <span class="nv">matrix</span><span class="p">)</span> <span class="nv">column-len</span><span class="p">)))))</span>

<span class="p">(</span><span class="nb">with-input-from-string</span>
    <span class="p">(</span><span class="nv">in</span> <span class="s">&quot;awk      cp       ed       login    mount    rmdir    sum</span>
<span class="s">basename csh      egrep    ls       mt       sed      sync</span>
<span class="s">cat      date     fgrep    mail     mv       sh       tar</span>
<span class="s">chgrp    dd       grep     mkdir    ps       sort     touch</span>
<span class="s">chmod    df       kill     mknod    pwd      stty     vi</span>
<span class="s">chown    echo     ln       more     rm       su&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">parse-matrix</span> <span class="nv">in</span><span class="p">))</span>
<span class="c1">; =&gt; awk      basename cat      chgrp    chmod    chown</span>
<span class="c1">;    cp       csh      date     dd       df       echo</span>
<span class="c1">;    ed       egrep    fgrep    grep     kill     ln</span>
<span class="c1">;    login    ls       mail     mkdir    mknod    more</span>
<span class="c1">;    mount    mt       mv       ps       pwd      rm</span>
<span class="c1">;    rmdir    sed      sh       sort     stty     su</span>
<span class="c1">;    sum      sync     tar      touch    vi</span>


<span class="c1">;;; @@PLEAC@@_4.19</span>
<span class="c1">;;; A naive `FACTORIAL&#39; implementation.</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">factorial</span> <span class="p">(</span><span class="nv">n</span><span class="p">)</span>
  <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">&lt;</span> <span class="nv">n</span> <span class="mi">2</span><span class="p">)</span> <span class="mi">1</span> <span class="p">(</span><span class="nb">*</span> <span class="nv">n</span> <span class="p">(</span><span class="nv">factorial</span> <span class="p">(</span><span class="nb">1-</span> <span class="nv">n</span><span class="p">)))))</span>

<span class="c1">;;; A tail-recursive derivative of the above `FACTORIAL&#39; implementation.</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">tco-factorial</span> <span class="p">(</span><span class="nv">n</span><span class="p">)</span>
  <span class="p">(</span><span class="k">labels</span> <span class="p">((</span><span class="nv">iter</span> <span class="p">(</span><span class="nv">m</span> <span class="nv">acc</span><span class="p">)</span>
             <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">&lt;</span> <span class="nv">n</span> <span class="nv">m</span><span class="p">)</span> <span class="nv">acc</span> <span class="p">(</span><span class="nv">iter</span> <span class="p">(</span><span class="nb">1+</span> <span class="nv">m</span><span class="p">)</span> <span class="p">(</span><span class="nb">*</span> <span class="nv">m</span> <span class="nv">acc</span><span class="p">)))))</span>
    <span class="p">(</span><span class="nv">iter</span> <span class="mi">1</span> <span class="mi">1</span><span class="p">)))</span>

<span class="p">(</span><span class="nv">tco-factorial</span> <span class="p">(</span><span class="nb">expt</span> <span class="mi">2</span> <span class="mi">8</span><span class="p">))</span>
<span class="c1">; =&gt; 857817775342842654119082271681232625157781520279485619859655650377269452553</span>
<span class="c1">;    147589377440291360451408450375885342336584306157196834693696475322289288497</span>
<span class="c1">;    426025679637332563368786442675207626794560187968867971521143307702077526646</span>
<span class="c1">;    451464709187326100832876325702818980773671781454170250523018608495319068138</span>
<span class="c1">;    257481070252817559459476987034665712738139286205234756808218860701203611083</span>
<span class="c1">;    152093501947437109101726968262861606263662435022840944191408424615936000000</span>
<span class="c1">;    000000000000000000000000000000000000000000000000000000000</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">permutations</span> <span class="p">(</span><span class="nv">items</span> <span class="k">&amp;key</span> <span class="nv">test</span> <span class="k">&amp;aux</span> <span class="p">(</span><span class="nv">test</span> <span class="p">(</span><span class="nb">or</span> <span class="nv">test</span> <span class="nf">#&#39;</span><span class="nb">eql</span><span class="p">)))</span>
  <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">null</span> <span class="nv">items</span><span class="p">)</span> <span class="o">&#39;</span><span class="p">(())</span>
      <span class="p">(</span><span class="nb">mapcan</span>
       <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">item</span><span class="p">)</span>
         <span class="p">(</span><span class="nb">mapcar</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">permutation</span><span class="p">)</span> <span class="p">(</span><span class="nb">cons</span> <span class="nv">item</span> <span class="nv">permutation</span><span class="p">))</span>
                 <span class="p">(</span><span class="nv">permutations</span> <span class="p">(</span><span class="nb">remove</span> <span class="nv">item</span> <span class="nv">items</span> <span class="ss">:test</span> <span class="nv">test</span><span class="p">)</span> <span class="ss">:test</span> <span class="nv">test</span><span class="p">)))</span>
       <span class="nv">items</span><span class="p">)))</span>

<span class="p">(</span><span class="nv">permutations</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;man&quot;</span> <span class="s">&quot;bites&quot;</span> <span class="s">&quot;dog&quot;</span><span class="p">)</span> <span class="ss">:test</span> <span class="nf">#&#39;</span><span class="nb">string-equal</span><span class="p">)</span>
<span class="c1">; =&gt; ((&quot;man&quot; &quot;bites&quot; &quot;dog&quot;)</span>
<span class="c1">;     (&quot;man&quot; &quot;dog&quot; &quot;bites&quot;)</span>
<span class="c1">;     (&quot;bites&quot; &quot;man&quot; &quot;dog&quot;)</span>
<span class="c1">;     (&quot;bites&quot; &quot;dog&quot; &quot;man&quot;)</span>
<span class="c1">;     (&quot;dog&quot; &quot;man&quot; &quot;bites&quot;)</span>
<span class="c1">;     (&quot;dog&quot; &quot;bites&quot; &quot;man&quot;))</span>


<span class="c1">;;; @@PLEAC@@_5.0</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">age</span> <span class="p">(</span><span class="nb">make-hash-table</span> <span class="ss">:test</span> <span class="ss">&#39;equal</span><span class="p">))</span>

<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="s">&quot;Nat&quot;</span> <span class="nv">age</span><span class="p">)</span> <span class="mi">24</span>
      <span class="p">(</span><span class="nb">gethash</span> <span class="s">&quot;Jules&quot;</span> <span class="nv">age</span><span class="p">)</span> <span class="mi">25</span>
      <span class="p">(</span><span class="nb">gethash</span> <span class="s">&quot;Josh&quot;</span> <span class="nv">age</span><span class="p">)</span> <span class="mi">17</span><span class="p">)</span>
<span class="c1">;;-----------------------------</span>
<span class="p">(</span><span class="nb">mapcar</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">l</span><span class="p">)</span>
            <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">l</span><span class="p">)</span> <span class="nv">age</span><span class="p">)</span> <span class="p">(</span><span class="nb">cdr</span> <span class="nv">l</span><span class="p">)))</span>
        <span class="o">&#39;</span><span class="p">((</span><span class="s">&quot;Nat&quot;</span> <span class="o">.</span> <span class="mi">24</span><span class="p">)</span>
          <span class="p">(</span><span class="s">&quot;Jules&quot;</span> <span class="o">.</span> <span class="mi">25</span><span class="p">)</span>
          <span class="p">(</span><span class="s">&quot;Josh&quot;</span> <span class="o">.</span> <span class="mi">17</span><span class="p">)))</span>
<span class="c1">;;-----------------------------</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*food-color*</span> <span class="p">(</span><span class="nb">make-hash-table</span> <span class="ss">:test</span> <span class="ss">&#39;equal</span><span class="p">))</span>

<span class="p">(</span><span class="nb">mapcar</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">l</span><span class="p">)</span>
            <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">l</span><span class="p">)</span> <span class="vg">*food-color*</span><span class="p">)</span> <span class="p">(</span><span class="nb">cdr</span> <span class="nv">l</span><span class="p">)))</span>
        <span class="o">&#39;</span><span class="p">((</span><span class="s">&quot;Apple&quot;</span> <span class="o">.</span> <span class="s">&quot;red&quot;</span><span class="p">)</span>
          <span class="p">(</span><span class="s">&quot;Banana&quot;</span> <span class="o">.</span> <span class="s">&quot;yellow&quot;</span><span class="p">)</span>
          <span class="p">(</span><span class="s">&quot;Lemon&quot;</span> <span class="o">.</span> <span class="s">&quot;yellow&quot;</span><span class="p">)</span>
          <span class="p">(</span><span class="s">&quot;Carrot&quot;</span> <span class="o">.</span> <span class="s">&quot;orange&quot;</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">mapcar</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">l</span><span class="p">)</span>
            <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">l</span><span class="p">)</span> <span class="vg">*food-color*</span><span class="p">)</span> <span class="p">(</span><span class="nb">cdr</span> <span class="nv">l</span><span class="p">)))</span>
        <span class="o">&#39;</span><span class="p">((</span><span class="nv">Apple</span> <span class="o">.</span> <span class="s">&quot;red&quot;</span><span class="p">)</span>
          <span class="p">(</span><span class="nv">Banana</span> <span class="o">.</span> <span class="s">&quot;yellow&quot;</span><span class="p">)</span>
          <span class="p">(</span><span class="nv">Lemon</span> <span class="o">.</span> <span class="s">&quot;yellow&quot;</span><span class="p">)</span>
          <span class="p">(</span><span class="nv">Carrot</span> <span class="o">.</span> <span class="s">&quot;orange&quot;</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">; @@PLEAC@@_5.1</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">key</span> <span class="nv">hash</span><span class="p">)</span> <span class="nv">value</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; *FOOD-COLOR* defined per the introduction</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="s">&quot;Raspberry&quot;</span> <span class="vg">*food-color*</span><span class="p">)</span> <span class="s">&quot;pink&quot;</span><span class="p">)</span>

<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;Known foods:~%~{~A~%~}&quot;</span>
        <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">f</span> <span class="nv">being</span> <span class="k">the</span> <span class="nv">hash-keys</span> <span class="nv">of</span> <span class="vg">*food-color*</span>
           <span class="nv">collect</span> <span class="nv">f</span><span class="p">))</span>
<span class="c1">;;Known foods:</span>
<span class="c1">;;Apple</span>
<span class="c1">;;Banana</span>
<span class="c1">;;Lemon</span>
<span class="c1">;;Carrot</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_5.2</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; does HASH have a value for KEY ?</span>
<span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">nth-value</span> <span class="mi">1</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">key</span> <span class="nv">hash</span><span class="p">))</span>
    <span class="p">(</span><span class="k">progn</span>
      <span class="c1">;; it exists</span>
      <span class="p">)</span>
    <span class="p">(</span><span class="k">progn</span>
      <span class="c1">;; it doesn&#39;t</span>
      <span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; *FOOD-COLOR* per the introduction</span>
<span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">name</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;Banana&quot;</span> <span class="s">&quot;Martini&quot;</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A is a ~A.~%&quot;</span>
          <span class="nv">name</span>
          <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">nth-value</span> <span class="mi">1</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">name</span> <span class="vg">*food-color*</span><span class="p">))</span>
              <span class="s">&quot;food&quot;</span> <span class="s">&quot;drink&quot;</span><span class="p">)))</span>

<span class="c1">;;Banana is a food.</span>
<span class="c1">;;Martini is a drink.</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">age</span> <span class="p">(</span><span class="nb">make-hash-table</span> <span class="ss">:test</span> <span class="ss">&#39;equal</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="s">&quot;Toddler&quot;</span> <span class="nv">age</span><span class="p">)</span> <span class="mi">3</span><span class="p">)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="s">&quot;Unborn&quot;</span> <span class="nv">age</span><span class="p">)</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="s">&quot;Phantasm&quot;</span> <span class="nv">age</span><span class="p">)</span> <span class="no">nil</span><span class="p">)</span>
<span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">thing</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;Toddler&quot;</span> <span class="s">&quot;Unborn&quot;</span> <span class="s">&quot;Phantasm&quot;</span> <span class="s">&quot;Relic&quot;</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~a: &quot;</span> <span class="nv">thing</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">multiple-value-bind</span> <span class="p">(</span><span class="nv">defined</span> <span class="nv">exists</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">gethash</span> <span class="nv">thing</span> <span class="nv">age</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">when</span> <span class="nv">exists</span>
        <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;Exists &quot;</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">when</span> <span class="nv">defined</span>
          <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;Defined &quot;</span><span class="p">)</span>
          <span class="c1">;; 0 is &quot;true&quot; in CL, so explicitly mimic Perl</span>
          <span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nb">zerop</span> <span class="nv">defined</span><span class="p">)</span>
            <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;True &quot;</span><span class="p">)))))</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~%&quot;</span><span class="p">))</span>

<span class="c1">;;Toddler: Exists Defined True</span>
<span class="c1">;;Unborn: Exists Defined</span>
<span class="c1">;;Phantasm: Exists</span>
<span class="c1">;;Relic:</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;;; @@INCOMPLETE@@</span>

<span class="c1">;;; @@PLEAC@@_5.3</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; remove KEY and its value from HASH</span>
<span class="p">(</span><span class="nb">remhash</span> <span class="nv">key</span> <span class="nv">hash</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; *FOOD-COLOR* as per Introduction</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">print-foods</span> <span class="p">()</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">foods</span> <span class="p">(</span><span class="nv">hash-keys</span> <span class="vg">*food-color*</span><span class="p">)))</span> <span class="c1">; HASH-KEYS defined in Appendix</span>
    <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;Keys: ~{~A~^ ~}~%Values: ~{~A~^ ~}~%&quot;</span>
            <span class="nv">foods</span>
            <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">food</span> <span class="nv">in</span> <span class="nv">foods</span>
               <span class="nv">collect</span> <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">food</span> <span class="vg">*food-color*</span><span class="p">)</span>
                           <span class="s">&quot;(undef)&quot;</span><span class="p">)))))</span>

<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;Initially~%&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nv">print-foods</span><span class="p">)</span>

<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~%With Banana undef~%&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="s">&quot;Banana&quot;</span> <span class="vg">*food-color*</span><span class="p">)</span>

<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~%With Banana deleted~%&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nb">remhash</span> <span class="s">&quot;Banana&quot;</span> <span class="vg">*food-color*</span><span class="p">)</span>
<span class="p">(</span><span class="nv">print-foods</span><span class="p">)</span>

<span class="c1">;; Initially</span>
<span class="c1">;; Keys: Apple Banana Lemon Carrot</span>
<span class="c1">;; Values: red yellow yellow orange</span>
<span class="c1">;;</span>
<span class="c1">;; With Banana undef</span>
<span class="c1">;; Keys: Apple Banana Lemon Carrot</span>
<span class="c1">;; Values: red (undef) yellow orange</span>
<span class="c1">;;</span>
<span class="c1">;; With Banana deleted</span>
<span class="c1">;; Keys: Apple Lemon Carrot</span>
<span class="c1">;; Values: red yellow orange</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">mapc</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">key</span><span class="p">)</span> <span class="p">(</span><span class="nb">remhash</span> <span class="nv">key</span> <span class="vg">*food-color*</span><span class="p">))</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;Banana&quot;</span> <span class="s">&quot;Apple&quot;</span> <span class="s">&quot;Cabbage&quot;</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_5.4</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">key</span> <span class="nv">being</span> <span class="k">the</span> <span class="nv">hash-keys</span> <span class="nv">of</span> <span class="nv">hash</span> <span class="nv">using</span> <span class="p">(</span><span class="nv">hash-value</span> <span class="nv">value</span><span class="p">)</span>
     <span class="c1">;; do something with KEY and VALUE</span>
     <span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">maphash</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">key</span> <span class="nv">value</span><span class="p">)</span>
             <span class="c1">;; do something with KEY and VALUE</span>
             <span class="p">)</span>
         <span class="nv">hash</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; *FOOD-COLOR* per the introduction</span>
<span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">food</span> <span class="nv">being</span> <span class="k">the</span> <span class="nv">hash-keys</span> <span class="nv">of</span> <span class="vg">*food-color*</span> <span class="nv">using</span> <span class="p">(</span><span class="nv">hash-value</span> <span class="nv">color</span><span class="p">)</span>
     <span class="nb">do</span> <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A is ~A.~%&quot;</span> <span class="nv">food</span> <span class="nv">color</span><span class="p">))</span>
<span class="c1">;; Apple is red.</span>
<span class="c1">;; Banana is yellow.</span>
<span class="c1">;; Lemon is yellow.</span>
<span class="c1">;; Carrot is orange.</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">maphash</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">food</span> <span class="nv">color</span><span class="p">)</span>
             <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A is ~A.~%&quot;</span> <span class="nv">food</span> <span class="nv">color</span><span class="p">))</span>
         <span class="vg">*food-color*</span><span class="p">)</span>
<span class="c1">;; Apple is red.</span>
<span class="c1">;; Banana is yellow.</span>
<span class="c1">;; Lemon is yellow.</span>
<span class="c1">;; Carrot is orange.</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; No equivalent</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">food</span> <span class="nv">in</span> <span class="p">(</span><span class="nb">sort</span> <span class="p">(</span><span class="nv">hash-keys</span> <span class="vg">*food-color*</span><span class="p">)</span> <span class="ss">&#39;string-lessp</span><span class="p">)</span>
   <span class="nb">do</span> <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A is ~A~%&quot;</span> <span class="nv">food</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">food</span> <span class="vg">*food-color*</span><span class="p">)))</span>
<span class="c1">;; Apple is red</span>
<span class="c1">;; Banana is yellow</span>
<span class="c1">;; Carrot is orange</span>
<span class="c1">;; Lemon is yellow</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Not sure what the following Perl is supposed to do:</span>
<span class="c1">;;while ( ($k,$v) = each %food_color ) {</span>
<span class="c1">;;    print &quot;Processing $k\n&quot;;</span>
<span class="c1">;;    keys %food_color;               # goes back to the start of %food_color</span>
<span class="c1">;;}</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">use-package</span> <span class="ss">:cl-ppcre</span><span class="p">)</span>
<span class="p">(</span><span class="nb">use-package</span> <span class="ss">:iterate</span><span class="p">)</span>

<span class="c1">;; The following handles the case that the Perl handles where there is</span>
<span class="c1">;; no filename (and it then opens &#39;-&#39;.  To do the same thing you&#39;d do</span>
<span class="c1">;; something like: (countfrom *standard-input*) and this method would</span>
<span class="c1">;; automatically get triggered instead of the one requiring a</span>
<span class="c1">;; filename.</span>
<span class="p">(</span><span class="nb">defmethod</span> <span class="nv">countfrom</span> <span class="p">((</span><span class="nc">stream</span> <span class="nc">stream</span><span class="p">))</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">from</span> <span class="p">(</span><span class="nb">make-hash-table</span> <span class="ss">:test</span> <span class="ss">&#39;equal</span><span class="p">)))</span>
    <span class="p">(</span><span class="nb">with-open-stream</span> <span class="p">(</span><span class="nv">input</span> <span class="nc">stream</span><span class="p">)</span>
      <span class="p">(</span><span class="nv">iter</span> <span class="p">(</span><span class="nv">for</span> <span class="nv">line</span> <span class="nv">in-stream</span> <span class="nv">input</span> <span class="nv">using</span> <span class="ss">&#39;read-line</span><span class="p">)</span>
            <span class="p">(</span><span class="nv">register-groups-bind</span> <span class="p">(</span><span class="nv">person</span><span class="p">)</span> <span class="p">(</span><span class="s">&quot;^From: (.*)\\s&quot;</span> <span class="nv">line</span><span class="p">)</span>
              <span class="p">(</span><span class="nb">incf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">person</span> <span class="nv">from</span> <span class="mi">0</span><span class="p">)))))</span>
    <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">person</span> <span class="nv">in</span> <span class="p">(</span><span class="nb">sort</span> <span class="p">(</span><span class="nv">hash-keys</span> <span class="nv">from</span><span class="p">)</span> <span class="ss">&#39;string-lessp</span><span class="p">)</span>
       <span class="nb">do</span> <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A: ~A~%&quot;</span> <span class="nv">person</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">person</span> <span class="nv">from</span><span class="p">)))))</span>

<span class="c1">;; This method is a bit of a hack in that it shouldn&#39;t really assume</span>
<span class="c1">;; that the string designates a filename, but for the purposes of this</span>
<span class="c1">;; example that seems ok.  Note that it just calls OPEN directly</span>
<span class="c1">;; without WITH-OPEN-FILE because it knows that the STREAM version of</span>
<span class="c1">;; this method will always close it.</span>
<span class="p">(</span><span class="nb">defmethod</span> <span class="nv">countfrom</span> <span class="p">((</span><span class="nv">filename</span> <span class="nb">string</span><span class="p">))</span>
  <span class="p">(</span><span class="nv">countfrom</span> <span class="p">(</span><span class="nb">open</span> <span class="nv">filename</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>


<span class="c1">;;; @@PLEAC@@_5.5</span>
<span class="p">(</span><span class="nb">defvar</span> <span class="vg">*table*</span> <span class="p">(</span><span class="nb">make-hash-table</span> <span class="ss">:test</span> <span class="nf">#&#39;</span><span class="nb">equal</span><span class="p">))</span>

<span class="p">(</span><span class="nb">dotimes</span> <span class="p">(</span><span class="nv">i</span> <span class="mi">10</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;~R&quot;</span> <span class="nv">i</span><span class="p">)</span> <span class="vg">*table*</span><span class="p">)</span> <span class="nv">i</span><span class="p">))</span>

<span class="p">(</span><span class="nb">maphash</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">key</span> <span class="nv">val</span><span class="p">)</span> <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A~%&quot;</span> <span class="p">(</span><span class="nb">cons</span> <span class="nv">key</span> <span class="nv">val</span><span class="p">)))</span> <span class="vg">*table*</span><span class="p">)</span>
<span class="c1">; =&gt; (&quot;nine&quot;  . 9)</span>
<span class="c1">;    (&quot;eight&quot; . 8)</span>
<span class="c1">;    (&quot;seven&quot; . 7)</span>
<span class="c1">;    (&quot;six&quot;   . 6)</span>
<span class="c1">;    (&quot;five&quot;  . 5)</span>
<span class="c1">;    (&quot;four&quot;  . 4)</span>
<span class="c1">;    (&quot;three&quot; . 3)</span>
<span class="c1">;    (&quot;two&quot;   . 2)</span>
<span class="c1">;    (&quot;one&quot;   . 1)</span>
<span class="c1">;    (&quot;zero&quot;  . 0)</span>

<span class="c1">;;; Unfortunately there doesn&#39;t exist a  `FORMAT&#39; directive for hash tables. But</span>
<span class="c1">;;; one can easily override existing `PRINT-OBJECT&#39; method for hash tables.</span>

<span class="c1">;;; @@PLEAC@@_5.6</span>
<span class="c1">;;; There doesn&#39;t exist a portable way of preserving insertion order of contents</span>
<span class="c1">;;; of a hash table in Common Lisp.   (Neither there is a rational behind such a</span>
<span class="c1">;;; feature, IMHO.)  On the  other hand, one  can keep  a history of  hash table</span>
<span class="c1">;;; modifications separately.</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">make-ordered-hash-table</span> <span class="p">(</span><span class="k">&amp;rest</span> <span class="nv">make-hash-table-args</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">cons</span> <span class="p">(</span><span class="nb">apply</span> <span class="nf">#&#39;</span><span class="nb">make-hash-table</span> <span class="nv">make-hash-table-args</span><span class="p">)</span> <span class="mi">0</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">setkey</span> <span class="p">(</span><span class="nv">table</span> <span class="nv">key</span> <span class="nv">val</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">key</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">table</span><span class="p">))</span> <span class="p">(</span><span class="nb">cons</span> <span class="p">(</span><span class="nb">incf</span> <span class="p">(</span><span class="nb">cdr</span> <span class="nv">table</span><span class="p">))</span> <span class="nv">val</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">remkey</span> <span class="p">(</span><span class="nv">table</span> <span class="nv">key</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">remhash</span> <span class="nv">key</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">table</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">getkey</span> <span class="p">(</span><span class="nv">table</span> <span class="nv">key</span> <span class="k">&amp;optional</span> <span class="nv">default</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="nv">missing-key</span> <span class="p">(</span><span class="nb">gensym</span><span class="p">))</span>
         <span class="p">(</span><span class="nv">val</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">key</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">table</span><span class="p">)</span> <span class="nv">missing-key</span><span class="p">)))</span>
    <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">eql</span> <span class="nv">missing-key</span> <span class="nv">val</span><span class="p">)</span> <span class="nv">default</span> <span class="p">(</span><span class="nb">cdr</span> <span class="nv">val</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">keys</span> <span class="p">(</span><span class="nv">table</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">(</span><span class="nv">key-id-pairs</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">maphash</span>
     <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">key</span> <span class="nv">val</span><span class="p">)</span> <span class="p">(</span><span class="nb">push</span> <span class="p">(</span><span class="nb">cons</span> <span class="nv">key</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">val</span><span class="p">))</span> <span class="nv">key-id-pairs</span><span class="p">))</span>
     <span class="p">(</span><span class="nb">car</span> <span class="nv">table</span><span class="p">))</span>
    <span class="p">(</span><span class="nb">mapcar</span> <span class="nf">#&#39;</span><span class="nb">car</span> <span class="p">(</span><span class="nb">sort</span> <span class="nv">key-id-pairs</span> <span class="nf">#&#39;</span><span class="nb">&lt;</span> <span class="ss">:key</span> <span class="nf">#&#39;</span><span class="nb">cdr</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">defvar</span> <span class="vg">*table*</span> <span class="p">(</span><span class="nv">make-ordered-hash-table</span><span class="p">))</span>

<span class="p">(</span><span class="nb">dotimes</span> <span class="p">(</span><span class="nv">i</span> <span class="mi">10</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">setkey</span> <span class="vg">*table*</span> <span class="p">(</span><span class="nb">/</span> <span class="p">(</span><span class="nb">1+</span> <span class="nv">i</span><span class="p">))</span> <span class="nv">i</span><span class="p">))</span>

<span class="p">(</span><span class="nv">keys</span> <span class="vg">*table*</span><span class="p">)</span>
<span class="c1">; =&gt; (1 1/2 1/3 1/4 1/5 1/6 1/7 1/8 1/9 1/10)</span>

<span class="p">(</span><span class="nv">setkey</span> <span class="vg">*table*</span> <span class="p">(</span><span class="nb">/</span> <span class="mi">2</span><span class="p">)</span> <span class="mi">20</span><span class="p">)</span>
<span class="p">(</span><span class="nv">setkey</span> <span class="vg">*table*</span> <span class="p">(</span><span class="nb">/</span> <span class="mi">4</span><span class="p">)</span> <span class="mi">40</span><span class="p">)</span>
<span class="p">(</span><span class="nv">remkey</span> <span class="vg">*table*</span> <span class="p">(</span><span class="nb">/</span> <span class="mi">6</span><span class="p">))</span>

<span class="p">(</span><span class="nv">keys</span> <span class="vg">*table*</span><span class="p">)</span>
<span class="c1">; =&gt; (1 1/3 1/5 1/7 1/8 1/9 1/10 1/2 1/4)</span>


<span class="c1">;;; @@PLEAC@@_5.7</span>
<span class="c1">;;; You can  easily create hash tables  using multiple values per  key. For this</span>
<span class="c1">;;; purpose you  just need to increase  the verbosity of the  used test function</span>
<span class="c1">;;; during hash table creation.</span>

<span class="p">(</span><span class="nb">defvar</span> <span class="vg">*employee-table*</span> <span class="p">(</span><span class="nb">make-hash-table</span> <span class="ss">:test</span> <span class="nf">#&#39;</span><span class="nb">equal</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defvar</span> <span class="vg">*employee-list*</span>
  <span class="o">&#39;</span><span class="p">((</span><span class="s">&quot;R&amp;D&quot;</span>   <span class="s">&quot;Bob&quot;</span>   <span class="s">&quot;1000&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;R&amp;D&quot;</span>   <span class="s">&quot;Trudy&quot;</span> <span class="s">&quot;1001&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;R&amp;D&quot;</span>   <span class="s">&quot;Alice&quot;</span> <span class="s">&quot;1002&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;Sales&quot;</span> <span class="s">&quot;Bob&quot;</span>   <span class="s">&quot;2001&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;Sales&quot;</span> <span class="s">&quot;Jane&quot;</span>  <span class="s">&quot;2003&quot;</span><span class="p">)))</span>

<span class="c1">;;; Pay attention that  we have to &quot;Bob&quot;s in  different departments. We&#39;ll place</span>
<span class="c1">;;; employees into  the `*EMPLOYEE-TABLE*&#39; using  these two (name  &amp; department)</span>
<span class="c1">;;; identifier fields.</span>

<span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">employee</span> <span class="vg">*employee-list*</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">destructuring-bind</span> <span class="p">(</span><span class="nv">dept</span> <span class="nv">name</span> <span class="nv">phone</span><span class="p">)</span> <span class="nv">employee</span>
    <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="p">(</span><span class="nb">list</span> <span class="nv">dept</span> <span class="nv">name</span><span class="p">)</span> <span class="vg">*employee-table*</span><span class="p">)</span>
          <span class="nv">phone</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">maphash</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">key</span> <span class="nv">val</span><span class="p">)</span> <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~S =&gt; ~S~%&quot;</span> <span class="nv">key</span> <span class="nv">val</span><span class="p">))</span>
         <span class="vg">*employee-table*</span><span class="p">)</span>
<span class="c1">; =&gt; (&quot;R&amp;D&quot; &quot;Bob&quot;)    =&gt; &quot;1000&quot;</span>
<span class="c1">;    (&quot;R&amp;D&quot; &quot;Trudy&quot;)  =&gt; &quot;1001&quot;</span>
<span class="c1">;    (&quot;R&amp;D&quot; &quot;Alice&quot;)  =&gt; &quot;1002&quot;</span>
<span class="c1">;    (&quot;Sales&quot; &quot;Bob&quot;)  =&gt; &quot;2001&quot;</span>
<span class="c1">;    (&quot;Sales&quot; &quot;Jane&quot;) =&gt; &quot;2003&quot;</span>


<span class="c1">;;; @@PLEAC@@_5.8</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">reverse-hash-table</span> <span class="p">(</span><span class="nv">old-table</span> <span class="k">&amp;key</span> <span class="nv">test</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">new-table</span>
         <span class="p">(</span><span class="nb">make-hash-table</span>
          <span class="ss">:test</span> <span class="p">(</span><span class="nb">or</span> <span class="nv">test</span> <span class="p">(</span><span class="nb">hash-table-test</span> <span class="nv">old-table</span><span class="p">))</span>
          <span class="ss">:size</span> <span class="p">(</span><span class="nb">hash-table-size</span> <span class="nv">old-table</span><span class="p">))))</span>
    <span class="p">(</span><span class="nb">maphash</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">key</span> <span class="nv">val</span><span class="p">)</span>
               <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">val</span> <span class="nv">new-table</span><span class="p">)</span> <span class="nv">key</span><span class="p">))</span>
             <span class="nv">old-table</span><span class="p">)</span>
    <span class="nv">new-table</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defvar</span> <span class="vg">*table*</span> <span class="p">(</span><span class="nb">make-hash-table</span><span class="p">))</span>

<span class="p">(</span><span class="nb">dotimes</span> <span class="p">(</span><span class="nv">i</span> <span class="mi">10</span><span class="p">)</span> <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="p">(</span><span class="nb">/</span> <span class="p">(</span><span class="nb">1+</span> <span class="nv">i</span><span class="p">))</span> <span class="vg">*table*</span><span class="p">)</span> <span class="nv">i</span><span class="p">))</span>

<span class="p">(</span><span class="nb">maphash</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">key</span> <span class="nv">val</span><span class="p">)</span> <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~S =&gt; ~S~%&quot;</span> <span class="nv">key</span> <span class="nv">val</span><span class="p">))</span>
         <span class="vg">*table*</span><span class="p">)</span>
<span class="c1">; =&gt; 1    =&gt; 0</span>
<span class="c1">;    1/2  =&gt; 1</span>
<span class="c1">;    1/3  =&gt; 2</span>
<span class="c1">;    1/4  =&gt; 3</span>
<span class="c1">;    1/5  =&gt; 4</span>
<span class="c1">;    1/6  =&gt; 5</span>
<span class="c1">;    1/7  =&gt; 6</span>
<span class="c1">;    1/8  =&gt; 7</span>
<span class="c1">;    1/9  =&gt; 8</span>
<span class="c1">;    1/10 =&gt; 9</span>

<span class="p">(</span><span class="nb">maphash</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">key</span> <span class="nv">val</span><span class="p">)</span> <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~S =&gt; ~S~%&quot;</span> <span class="nv">key</span> <span class="nv">val</span><span class="p">))</span>
         <span class="p">(</span><span class="nv">reverse-hash-table</span> <span class="vg">*table*</span><span class="p">))</span>
<span class="c1">; =&gt; 0 =&gt; 1</span>
<span class="c1">;    1 =&gt; 1/2</span>
<span class="c1">;    2 =&gt; 1/3</span>
<span class="c1">;    3 =&gt; 1/4</span>
<span class="c1">;    4 =&gt; 1/5</span>
<span class="c1">;    5 =&gt; 1/6</span>
<span class="c1">;    6 =&gt; 1/7</span>
<span class="c1">;    7 =&gt; 1/8</span>
<span class="c1">;    8 =&gt; 1/9</span>
<span class="c1">;    9 =&gt; 1/10</span>


<span class="c1">;;; @@PLEAC@@_5.9</span>
<span class="c1">;;; One cannot (and shouldn&#39;t) make assumptions  on the order of the elements in</span>
<span class="c1">;;; a hash table in  Common Lisp. Anyway, while you&#39;re here, below  is a quick &amp;</span>
<span class="c1">;;; dirty solution.</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">ordered-keys</span> <span class="p">(</span><span class="nv">table</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">sort</span>
   <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">key</span> <span class="nv">being</span> <span class="nv">each</span> <span class="nv">hash-key</span> <span class="nv">of</span> <span class="nv">table</span>
         <span class="nv">collect</span> <span class="nv">key</span><span class="p">)</span>
   <span class="nf">#&#39;</span><span class="nb">&lt;</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defvar</span> <span class="vg">*table*</span> <span class="p">(</span><span class="nb">make-hash-table</span><span class="p">))</span>

<span class="p">(</span><span class="nb">dotimes</span> <span class="p">(</span><span class="nv">i</span> <span class="mi">10</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span>  <span class="p">(</span><span class="nb">/</span> <span class="p">(</span><span class="nb">1+</span> <span class="nv">i</span><span class="p">))</span> <span class="vg">*table*</span><span class="p">)</span> <span class="nv">i</span><span class="p">))</span>

<span class="p">(</span><span class="nv">ordered-keys</span> <span class="vg">*table*</span><span class="p">)</span>
<span class="c1">; =&gt; (1/10 1/9 1/8 1/7 1/6 1/5 1/4 1/3 1/2 1)</span>


<span class="c1">;;; @@PLEAC@@_5.10</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">merge-hash-tables</span> <span class="p">(</span><span class="k">&amp;rest</span> <span class="nv">tables</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nb">union</span>
         <span class="p">(</span><span class="nb">make-hash-table</span>
          <span class="ss">:test</span> <span class="p">(</span><span class="nb">first</span>
                 <span class="p">(</span><span class="nb">sort</span> <span class="p">(</span><span class="nb">mapcar</span> <span class="nf">#&#39;</span><span class="nb">hash-table-test</span> <span class="nv">tables</span><span class="p">)</span> <span class="nf">#&#39;</span><span class="nb">&gt;</span>
                       <span class="ss">:key</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">test</span><span class="p">)</span>
                              <span class="p">(</span><span class="nb">ecase</span> <span class="nv">test</span>
                                <span class="p">(</span><span class="nb">eq</span> <span class="mi">0</span><span class="p">)</span>
                                <span class="p">(</span><span class="nb">eql</span> <span class="mi">1</span><span class="p">)</span>
                                <span class="p">(</span><span class="nb">equal</span> <span class="mi">2</span><span class="p">)</span>
                                <span class="p">(</span><span class="nb">equalp</span> <span class="mi">3</span><span class="p">)))))</span>
          <span class="ss">:size</span> <span class="p">(</span><span class="nb">reduce</span> <span class="nf">#&#39;</span><span class="nb">max</span> <span class="p">(</span><span class="nb">mapcar</span> <span class="nf">#&#39;</span><span class="nb">hash-table-size</span> <span class="nv">tables</span><span class="p">)))))</span>
    <span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">table</span> <span class="nv">tables</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">maphash</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">key</span> <span class="nv">val</span><span class="p">)</span> <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">key</span> <span class="nb">union</span><span class="p">)</span> <span class="nv">val</span><span class="p">))</span> <span class="nv">table</span><span class="p">))</span>
    <span class="nb">union</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defvar</span> <span class="vg">*table-x*</span> <span class="p">(</span><span class="nb">make-hash-table</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defvar</span> <span class="vg">*table-y*</span> <span class="p">(</span><span class="nb">make-hash-table</span> <span class="ss">:test</span> <span class="nf">#&#39;</span><span class="nb">equal</span><span class="p">))</span>

<span class="p">(</span><span class="nb">dotimes</span> <span class="p">(</span><span class="nv">i</span> <span class="mi">5</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">i</span> <span class="vg">*table-x*</span><span class="p">)</span> <span class="p">(</span><span class="nb">*</span> <span class="mi">10</span> <span class="nv">i</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">gethash</span> <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;~R&quot;</span> <span class="nv">i</span><span class="p">)</span> <span class="vg">*table-y*</span><span class="p">)</span> <span class="nv">i</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defvar</span> <span class="vg">*table-u*</span> <span class="p">(</span><span class="nv">merge-hash-tables</span> <span class="vg">*table-x*</span> <span class="vg">*table-y*</span><span class="p">))</span>

<span class="p">(</span><span class="nb">maphash</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">key</span> <span class="nv">val</span><span class="p">)</span> <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~10S =&gt; ~S~%&quot;</span> <span class="nv">key</span> <span class="nv">val</span><span class="p">))</span> <span class="vg">*table-u*</span><span class="p">)</span>
<span class="c1">; =&gt; 0       =&gt; 0</span>
<span class="c1">;    1       =&gt; 10</span>
<span class="c1">;    2       =&gt; 20</span>
<span class="c1">;    3       =&gt; 30</span>
<span class="c1">;    4       =&gt; 40</span>
<span class="c1">;    &quot;zero&quot;  =&gt; 0</span>
<span class="c1">;    &quot;one&quot;   =&gt; 1</span>
<span class="c1">;    &quot;two&quot;   =&gt; 2</span>
<span class="c1">;    &quot;three&quot; =&gt; 3</span>
<span class="c1">;    &quot;four&quot;  =&gt; 4</span>


<span class="c1">;;; @@PLEAC@@_5.11</span>
<span class="c1">;;; Before  going  into  the  details   about  how  to  find  intersections  and</span>
<span class="c1">;;; differences between two hash tables,  one should note the existence of below</span>
<span class="c1">;;; functions operating on lists.</span>

<span class="c1">;;; Function &lt;a href=&quot;http://l1sp.org/cl/set-exclusive-or&quot;&gt;SET-EXCLUSIVE-OR&lt;/a&gt;, &lt;a href=&quot;http://l1sp.org/cl/nset-exclusive-or&quot;&gt;NSET-EXCLUSIVE-OR&lt;/a&gt;</span>
<span class="c1">;;; Function &lt;a href=&quot;http://l1sp.org/cl/set-difference&quot;&gt;SET-DIFFERENCE&lt;/a&gt;, &lt;a href=&quot;http://l1sp.org/cl/nset-difference&quot;&gt;NSET-DIFFERENCE&lt;/a&gt;</span>
<span class="c1">;;; Function &lt;a href=&quot;http://l1sp.org/cl/intersection&quot;&gt;INTERSECTION&lt;/a&gt;, &lt;a href=&quot;http://l1sp.org/cl/nintersection&quot;&gt;NINTERSECTION&lt;/a&gt;</span>
<span class="c1">;;; Function &lt;a href=&quot;http://l1sp.org/cl/union&quot;&gt;UNION&lt;/a&gt;, &lt;a href=&quot;http://l1sp.org/cl/nunion&quot;&gt;NUNION&lt;/a&gt;</span>

<span class="c1">;;; While  a hash  table implementation  of above  set operations  would perform</span>
<span class="c1">;;; better  for large  data sets,  people  report that  above functions  perform</span>
<span class="c1">;;; better than hash tables for collections of size 20-30 elements. On the other</span>
<span class="c1">;;; hand, it&#39;s  obvious that  working with  lists is much  more suitable  to the</span>
<span class="c1">;;; nature of a lisp program.</span>

<span class="c1">;;; Simple &amp; Clean Hash Table Intersection/Difference Implementations</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">hash-table-keys</span> <span class="p">(</span><span class="nv">table</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">key</span> <span class="nv">being</span> <span class="nv">each</span> <span class="nv">hash-key</span> <span class="nv">of</span> <span class="nv">table</span>
        <span class="nv">collect</span> <span class="nv">key</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">key-intersection</span> <span class="p">(</span><span class="nv">u</span> <span class="nv">v</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">intersection</span>
   <span class="p">(</span><span class="nv">hash-table-keys</span> <span class="nv">u</span><span class="p">)</span> <span class="p">(</span><span class="nv">hash-table-keys</span> <span class="nv">v</span><span class="p">)</span>
   <span class="ss">:test</span> <span class="p">(</span><span class="nb">hash-table-test</span> <span class="nv">u</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">key-difference</span> <span class="p">(</span><span class="nv">u</span> <span class="nv">v</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">set-difference</span>
   <span class="p">(</span><span class="nv">hash-table-keys</span> <span class="nv">u</span><span class="p">)</span> <span class="p">(</span><span class="nv">hash-table-keys</span> <span class="nv">v</span><span class="p">)</span>
   <span class="ss">:test</span> <span class="p">(</span><span class="nb">hash-table-test</span> <span class="nv">u</span><span class="p">)))</span>


<span class="c1">;;; Hairy Hash Table Intersection/Difference Implementations</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">hairy-key-frequency</span> <span class="p">(</span><span class="nv">tables</span> <span class="k">&amp;key</span> <span class="p">(</span><span class="nv">test</span> <span class="ss">&#39;eql</span><span class="p">))</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">frequency</span> <span class="p">(</span><span class="nb">make-hash-table</span> <span class="ss">:test</span> <span class="nv">test</span><span class="p">)))</span>
    <span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">table</span> <span class="nv">tables</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">maphash</span>
       <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">key</span> <span class="nv">val</span><span class="p">)</span>
         <span class="p">(</span><span class="k">declare</span> <span class="p">(</span><span class="k">ignore</span> <span class="nv">val</span><span class="p">))</span>
         <span class="p">(</span><span class="nb">incf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">key</span> <span class="nv">frequency</span> <span class="mi">0</span><span class="p">)))</span>
       <span class="nv">table</span><span class="p">))</span>
    <span class="nv">frequency</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defmacro</span> <span class="nv">with-table-test-consistency</span> <span class="p">((</span><span class="nv">tables</span> <span class="nv">test</span><span class="p">)</span> <span class="k">&amp;body</span> <span class="nv">body</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">alexandria:with-unique-names</span> <span class="p">(</span><span class="nv">table</span><span class="p">)</span>
    <span class="o">`</span><span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="o">,</span><span class="nv">test</span> <span class="p">(</span><span class="nb">hash-table-test</span> <span class="p">(</span><span class="nb">first</span> <span class="o">,</span><span class="nv">tables</span><span class="p">))))</span>
       <span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nb">every</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="o">,</span><span class="nv">table</span><span class="p">)</span> <span class="p">(</span><span class="nb">eql</span> <span class="p">(</span><span class="nb">hash-table-test</span> <span class="o">,</span><span class="nv">table</span><span class="p">)</span> <span class="o">,</span><span class="nv">test</span><span class="p">))</span>
                      <span class="p">(</span><span class="nb">rest</span> <span class="o">,</span><span class="nv">tables</span><span class="p">))</span>
         <span class="p">(</span><span class="nb">error</span> <span class="s">&quot;Inconsistent test functions! (Expecting ~S.)&quot;</span> <span class="o">,</span><span class="nv">test</span><span class="p">))</span>
       <span class="o">,@</span><span class="nv">body</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">hairy-key-frequency-filter</span> <span class="p">(</span><span class="nv">tables</span> <span class="nv">pred</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">when</span> <span class="nv">tables</span>
    <span class="p">(</span><span class="nv">with-table-test-consistency</span> <span class="p">(</span><span class="nv">tables</span> <span class="nv">test</span><span class="p">)</span>
      <span class="p">(</span><span class="k">let</span> <span class="p">(</span><span class="nv">accum</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">maphash</span>
         <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">key</span> <span class="nv">val</span><span class="p">)</span> <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">funcall</span> <span class="nv">pred</span> <span class="nv">val</span><span class="p">)</span> <span class="p">(</span><span class="nb">push</span> <span class="nv">key</span> <span class="nv">accum</span><span class="p">)))</span>
         <span class="p">(</span><span class="nv">hairy-key-frequency</span> <span class="nv">tables</span> <span class="ss">:test</span> <span class="nv">test</span><span class="p">))</span>
        <span class="nv">accum</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">hairy-key-intersection</span> <span class="p">(</span><span class="k">&amp;rest</span> <span class="nv">tables</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">hairy-key-frequency-filter</span> <span class="nv">tables</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">val</span><span class="p">)</span> <span class="p">(</span><span class="nb">&lt;</span> <span class="mi">1</span> <span class="nv">val</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">hairy-key-difference</span> <span class="p">(</span><span class="k">&amp;rest</span> <span class="nv">tables</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">hairy-key-frequency-filter</span> <span class="nv">tables</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">val</span><span class="p">)</span> <span class="p">(</span><span class="nb">&lt;</span> <span class="nv">val</span> <span class="mi">2</span><span class="p">))))</span>


<span class="c1">;;; Example Usage</span>

<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">u</span> <span class="p">(</span><span class="nb">make-hash-table</span><span class="p">))</span>
      <span class="p">(</span><span class="nv">v</span> <span class="p">(</span><span class="nb">make-hash-table</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">i</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span><span class="p">))</span> <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">i</span> <span class="nv">u</span><span class="p">)</span> <span class="no">t</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">i</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span><span class="p">))</span> <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">i</span> <span class="nv">v</span><span class="p">)</span> <span class="no">t</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">list</span> <span class="ss">:simple</span> <span class="p">(</span><span class="nb">list</span> <span class="ss">:intersection</span> <span class="p">(</span><span class="nv">key-intersection</span> <span class="nv">u</span> <span class="nv">v</span><span class="p">)</span>
                      <span class="ss">:difference</span>   <span class="p">(</span><span class="nv">key-difference</span> <span class="nv">u</span> <span class="nv">v</span><span class="p">))</span>
        <span class="ss">:hairy</span>  <span class="p">(</span><span class="nb">list</span> <span class="ss">:intersection</span> <span class="p">(</span><span class="nv">hairy-key-intersection</span> <span class="nv">u</span> <span class="nv">v</span><span class="p">)</span>
                      <span class="ss">:difference</span>   <span class="p">(</span><span class="nv">hairy-key-difference</span> <span class="nv">u</span> <span class="nv">v</span><span class="p">))))</span>
<span class="c1">; =&gt; (:SIMPLE (:INTERSECTION (5 4 3) :DIFFERENCE (2 1))</span>
<span class="c1">;     :HAIRY  (:INTERSECTION (5 4 3) :DIFFERENCE (7 6 2 1)))</span>


<span class="c1">;;; @@PLEAC@@_5.12</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">consume-stream</span> <span class="p">(</span><span class="nc">stream</span> <span class="k">&amp;key</span> <span class="p">(</span><span class="nv">buffer-size</span> <span class="mi">8192</span><span class="p">))</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">buffer</span>
         <span class="p">(</span><span class="nb">make-sequence</span>
          <span class="o">`</span><span class="p">(</span><span class="nb">vector</span> <span class="o">,</span><span class="p">(</span><span class="nb">stream-element-type</span> <span class="nc">stream</span><span class="p">))</span>
          <span class="nv">buffer-size</span><span class="p">)))</span>
    <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">pos</span> <span class="nb">=</span> <span class="p">(</span><span class="nb">read-sequence</span> <span class="nv">buffer</span> <span class="nc">stream</span><span class="p">)</span>
          <span class="nv">until</span> <span class="p">(</span><span class="nb">zerop</span> <span class="nv">pos</span><span class="p">)</span> <span class="nv">sum</span> <span class="nv">pos</span><span class="p">)))</span>

<span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="nv">streams</span> <span class="p">(</span><span class="nb">mapcar</span> <span class="nf">#&#39;</span><span class="nb">open</span> <span class="p">(</span><span class="nb">list</span> <span class="s">&quot;/etc/passwd&quot;</span> <span class="s">&quot;/etc/motd&quot;</span> <span class="s">&quot;/etc/fstab&quot;</span><span class="p">))))</span>
  <span class="p">(</span><span class="k">unwind-protect</span>
       <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">table</span> <span class="p">(</span><span class="nb">make-hash-table</span><span class="p">)))</span>
         <span class="c1">;; Place `(STREAM . PATHNAME)&#39; pairs as table key and values.</span>
         <span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nc">stream</span> <span class="nv">streams</span><span class="p">)</span>
           <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nc">stream</span> <span class="nv">table</span><span class="p">)</span> <span class="p">(</span><span class="nb">pathname</span> <span class="nc">stream</span><span class="p">)))</span>
         <span class="c1">;; Let&#39;s find the sizes of the streams.</span>
         <span class="p">(</span><span class="k">let</span> <span class="p">(</span><span class="nv">accum</span><span class="p">)</span>
           <span class="p">(</span><span class="nb">maphash</span>
            <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">key</span> <span class="nv">val</span><span class="p">)</span> <span class="p">(</span><span class="nb">push</span> <span class="p">(</span><span class="nb">cons</span> <span class="nv">val</span> <span class="p">(</span><span class="nv">consume-stream</span> <span class="nv">key</span><span class="p">))</span> <span class="nv">accum</span><span class="p">))</span>
            <span class="nv">table</span><span class="p">)</span>
           <span class="nv">accum</span><span class="p">))</span>
    <span class="c1">;; Don&#39;t forget to close open file streams.</span>
    <span class="p">(</span><span class="nb">mapcar</span> <span class="nf">#&#39;</span><span class="nb">close</span> <span class="nv">streams</span><span class="p">)))</span>
<span class="c1">; =&gt; ((#P&quot;/etc/fstab&quot;  . 488)</span>
<span class="c1">;     (#P&quot;/etc/motd&quot;   . 351)</span>
<span class="c1">;     (#P&quot;/etc/passwd&quot; . 1232))</span>


<span class="c1">;;; @@PLEAC@@_5.13</span>
<span class="c1">;;; In Common Lisp,  you can create hash tables of  previously known sizes using</span>
<span class="c1">;;; `SIZE&#39;             keyword             supplied            to             &lt;a</span>
<span class="c1">;;; href=&quot;http://l1sp.org/cl/make-hash-table&quot;&gt;`MAKE-HASH-TABLE&#39;&lt;/a&gt;.    (Moreover</span>
<span class="c1">;;; there are `REHASH-SIZE&#39;  and `REHASH-THRESHOLD&#39; keyword parameters available</span>
<span class="c1">;;; which  might  interest  you.) But  once  you  created  a hash  table,  these</span>
<span class="c1">;;; configurations  stay as  is;  in  other words  later  modifications are  not</span>
<span class="c1">;;; allowed.</span>


<span class="c1">;;; @@PLEAC@@_5.14</span>
<span class="c1">;;; See  `HAIRY-KEY-FREQUENCY&#39;  in  &quot;Hairy  Hash  Table  Intersection/Difference</span>
<span class="c1">;;; Implementations&quot;.</span>


<span class="c1">;;; @@PLEAC@@_5.15</span>
<span class="c1">;;; We construct  the family  tree (in s-expressions)  extracted from  the given</span>
<span class="c1">;;; parent-child relationship table.</span>

<span class="p">(</span><span class="nb">defvar</span> <span class="vg">*relations*</span>
  <span class="o">&#39;</span><span class="p">((</span><span class="s">&quot;Cain&quot;</span>      <span class="o">.</span> <span class="s">&quot;Adam&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;Abel&quot;</span>      <span class="o">.</span> <span class="s">&quot;Adam&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;Seth&quot;</span>      <span class="o">.</span> <span class="s">&quot;Adam&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;Enoch&quot;</span>     <span class="o">.</span> <span class="s">&quot;Cain&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;Irad&quot;</span>      <span class="o">.</span> <span class="s">&quot;Enoch&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;Mehujael&quot;</span>  <span class="o">.</span> <span class="s">&quot;Irad&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;Methusael&quot;</span> <span class="o">.</span> <span class="s">&quot;Mehujael&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;Lamech&quot;</span>    <span class="o">.</span> <span class="s">&quot;Methusael&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;Jabal&quot;</span>     <span class="o">.</span> <span class="s">&quot;Lamech&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;Jubal&quot;</span>     <span class="o">.</span> <span class="s">&quot;Lamech&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;Tubalcain&quot;</span> <span class="o">.</span> <span class="s">&quot;Lamech&quot;</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">construct-relation-tree</span> <span class="p">(</span><span class="nv">rels</span><span class="p">)</span>
  <span class="p">(</span><span class="k">labels</span> <span class="p">((</span><span class="nv">construct</span> <span class="p">(</span><span class="nv">parent</span><span class="p">)</span>
             <span class="p">(</span><span class="nb">cons</span> <span class="nv">parent</span>
                   <span class="p">(</span><span class="nb">mapcar</span> <span class="nf">#&#39;</span><span class="nv">construct</span>
                           <span class="p">(</span><span class="nb">mapcar</span> <span class="nf">#&#39;</span><span class="nb">car</span>
                                   <span class="p">(</span><span class="nb">remove</span> <span class="nv">parent</span> <span class="nv">rels</span>
                                           <span class="ss">:key</span> <span class="nf">#&#39;</span><span class="nb">cdr</span>
                                           <span class="ss">:test</span> <span class="p">(</span><span class="nb">complement</span> <span class="nf">#&#39;</span><span class="nb">string-equal</span><span class="p">)))))))</span>
    <span class="p">(</span><span class="nb">mapcar</span> <span class="nf">#&#39;</span><span class="nv">construct</span>
            <span class="p">(</span><span class="nb">remove-duplicates</span>
             <span class="p">(</span><span class="nb">mapcar</span> <span class="nf">#&#39;</span><span class="nb">cdr</span>
                     <span class="p">(</span><span class="nb">remove-if</span>
                      <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">pair</span><span class="p">)</span>
                        <span class="p">(</span><span class="nb">find</span> <span class="p">(</span><span class="nb">cdr</span> <span class="nv">pair</span><span class="p">)</span> <span class="nv">rels</span> <span class="ss">:test</span> <span class="nf">#&#39;</span><span class="nb">string-equal</span> <span class="ss">:key</span> <span class="nf">#&#39;</span><span class="nb">car</span><span class="p">))</span>
                      <span class="nv">rels</span><span class="p">))</span>
             <span class="ss">:test</span> <span class="nf">#&#39;</span><span class="nb">string-equal</span><span class="p">))))</span>

<span class="p">(</span><span class="nv">construct-relation-tree</span> <span class="vg">*relations*</span><span class="p">)</span>
<span class="c1">; =&gt; ((&quot;Adam&quot;</span>
<span class="c1">;      (&quot;Cain&quot;</span>
<span class="c1">;       (&quot;Enoch&quot;</span>
<span class="c1">;        (&quot;Irad&quot;</span>
<span class="c1">;         (&quot;Mehujael&quot; (&quot;Methusael&quot; (&quot;Lamech&quot; (&quot;Jabal&quot;) (&quot;Jubal&quot;) (&quot;Tubalcain&quot;)))))))</span>
<span class="c1">;      (&quot;Abel&quot;)</span>
<span class="c1">;      (&quot;Seth&quot;)))</span>

<span class="c1">;;; In a similar way, we can  construct the dependency tree between C source and</span>
<span class="c1">;;; header files.</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">parse-file-dependencies</span> <span class="p">(</span><span class="nb">pathname</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">(</span><span class="nv">deps</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">with-open-file</span> <span class="p">(</span><span class="nv">in</span> <span class="nb">pathname</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">line</span> <span class="nb">=</span> <span class="p">(</span><span class="nb">read-line</span> <span class="nv">in</span> <span class="no">nil</span> <span class="no">nil</span><span class="p">)</span>
            <span class="nv">while</span> <span class="nv">line</span>
            <span class="nb">do</span> <span class="p">(</span><span class="nv">ppcre:do-scans</span>
                   <span class="p">(</span><span class="nv">m-s</span> <span class="nv">m-e</span> <span class="nv">r-ss</span> <span class="nv">r-es</span>
                    <span class="s">&quot;\\s*#\\s*include\\s*[&lt;\&quot;]([^&gt;\&quot;]+)[&gt;\&quot;]&quot;</span> <span class="nv">line</span><span class="p">)</span>
                 <span class="p">(</span><span class="nb">push</span> <span class="p">(</span><span class="nb">subseq</span> <span class="nv">line</span> <span class="p">(</span><span class="nb">elt</span> <span class="nv">r-ss</span> <span class="mi">0</span><span class="p">)</span> <span class="p">(</span><span class="nb">elt</span> <span class="nv">r-es</span> <span class="mi">0</span><span class="p">))</span> <span class="nv">deps</span><span class="p">))))</span>
    <span class="nv">deps</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">construct-file-relations</span> <span class="p">(</span><span class="nv">pathnames</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">mapcan</span>
   <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">child</span><span class="p">)</span>
     <span class="p">(</span><span class="nb">mapcar</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">parent</span><span class="p">)</span>
               <span class="p">(</span><span class="nb">cons</span>
                <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;~A.~A&quot;</span> <span class="p">(</span><span class="nb">pathname-name</span> <span class="nv">child</span><span class="p">)</span> <span class="p">(</span><span class="nb">pathname-type</span> <span class="nv">child</span><span class="p">))</span>
                <span class="nv">parent</span><span class="p">))</span>
             <span class="p">(</span><span class="nv">parse-file-dependencies</span> <span class="nv">child</span><span class="p">)))</span>
   <span class="nv">pathnames</span><span class="p">))</span>

<span class="p">(</span><span class="nv">construct-file-relations</span>
 <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;/tmp/c/hello.c&quot;</span> <span class="s">&quot;/tmp/c/hello.h&quot;</span> <span class="s">&quot;/tmp/c/main.c&quot;</span><span class="p">))</span>
<span class="c1">; =&gt; ((&quot;hello.c&quot; . &quot;hello.h&quot;)</span>
<span class="c1">;     (&quot;hello.c&quot; . &quot;stdio.h&quot;)</span>
<span class="c1">;     (&quot;main.c&quot; . &quot;hello.h&quot;)</span>
<span class="c1">;     (&quot;main.c&quot; . &quot;stdlib.h&quot;)</span>
<span class="c1">;     (&quot;main.c&quot; . &quot;stdio.h&quot;))</span>

<span class="p">(</span><span class="nv">construct-relation-tree</span>
 <span class="p">(</span><span class="nv">construct-file-relations</span>
  <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;/tmp/c/hello.c&quot;</span> <span class="s">&quot;/tmp/c/hello.h&quot;</span> <span class="s">&quot;/tmp/c/main.c&quot;</span><span class="p">)))</span>
<span class="c1">; =&gt; ((&quot;hello.h&quot; (&quot;hello.c&quot;) (&quot;main.c&quot;))</span>
<span class="c1">;     (&quot;stdlib.h&quot; (&quot;main.c&quot;))</span>
<span class="c1">;     (&quot;stdio.h&quot; (&quot;hello.c&quot;) (&quot;main.c&quot;)))</span>

<span class="c1">;;; Actually, whole PLEAC  example was related with hash  tables in its original</span>
<span class="c1">;;; demonstration.  But  the more I  think about it,  the more I find  that list</span>
<span class="c1">;;; structures are  more suitable for  this kind of  a tasks. But it  is obvious</span>
<span class="c1">;;; that, `REMOVE-DUPLICATES&#39; kind of  tricks will perform poorly when duplicate</span>
<span class="c1">;;; eliminations will consume the majority  of the computation power and in such</span>
<span class="c1">;;; a situation you&#39;ll inevitably need hash tables.</span>


<span class="c1">;;; @@PLEAC@@_5.16</span>
<span class="p">(</span><span class="nb">defstruct</span> <span class="nv">hash-branch</span> <span class="p">(</span><span class="nv">weight</span> <span class="mi">0</span><span class="p">)</span> <span class="p">(</span><span class="nv">tree</span> <span class="no">nil</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">hash-tree-add</span> <span class="p">(</span><span class="nv">branch</span> <span class="nv">path</span> <span class="nv">weight</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">branch</span> <span class="p">(</span><span class="nb">or</span> <span class="nv">branch</span> <span class="p">(</span><span class="nv">make-hash-branch</span><span class="p">))))</span>
    <span class="p">(</span><span class="nb">prog1</span> <span class="nv">branch</span>
      <span class="p">(</span><span class="nb">incf</span> <span class="p">(</span><span class="nv">hash-branch-weight</span> <span class="nv">branch</span><span class="p">)</span> <span class="nv">weight</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">when</span> <span class="nv">path</span>
        <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">hash-branch-tree</span> <span class="nv">branch</span><span class="p">)</span>
              <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nv">hash-branch-tree</span> <span class="nv">branch</span><span class="p">)</span>
                  <span class="p">(</span><span class="nb">make-hash-table</span> <span class="ss">:test</span> <span class="nf">#&#39;</span><span class="nb">equal</span><span class="p">)))</span>
        <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="p">(</span><span class="nb">first</span> <span class="nv">path</span><span class="p">)</span> <span class="p">(</span><span class="nv">hash-branch-tree</span> <span class="nv">branch</span><span class="p">))</span>
              <span class="p">(</span><span class="nv">hash-tree-add</span>
               <span class="p">(</span><span class="nb">gethash</span> <span class="p">(</span><span class="nb">first</span> <span class="nv">path</span><span class="p">)</span> <span class="p">(</span><span class="nv">hash-branch-tree</span> <span class="nv">branch</span><span class="p">))</span>
               <span class="p">(</span><span class="nb">rest</span> <span class="nv">path</span><span class="p">)</span> <span class="nv">weight</span><span class="p">))))))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">hash-tree-&gt;list-tree</span> <span class="p">(</span><span class="nv">branch</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">when</span> <span class="nv">branch</span>
    <span class="p">(</span><span class="nb">cons</span> <span class="p">(</span><span class="nv">hash-branch-weight</span> <span class="nv">branch</span><span class="p">)</span>
          <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">tree</span> <span class="p">(</span><span class="nv">hash-branch-tree</span> <span class="nv">branch</span><span class="p">))</span>
                <span class="p">(</span><span class="nv">accum</span><span class="p">))</span>
            <span class="p">(</span><span class="nb">when</span> <span class="nv">tree</span>
              <span class="p">(</span><span class="nb">maphash</span>
               <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">key</span> <span class="nv">val</span><span class="p">)</span>
                 <span class="p">(</span><span class="nb">push</span> <span class="p">(</span><span class="nb">cons</span> <span class="nv">key</span> <span class="p">(</span><span class="nv">hash-tree-&gt;list-tree</span> <span class="nv">val</span><span class="p">))</span> <span class="nv">accum</span><span class="p">))</span>
               <span class="nv">tree</span><span class="p">)</span>
              <span class="nv">accum</span><span class="p">)))))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">print-list-tree</span> <span class="p">(</span><span class="nv">branches</span> <span class="k">&amp;optional</span> <span class="p">(</span><span class="nv">depth</span> <span class="mi">0</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">branch</span> <span class="p">(</span><span class="nb">sort</span> <span class="p">(</span><span class="nb">copy-list</span> <span class="nv">branches</span><span class="p">)</span> <span class="nf">#&#39;</span><span class="nb">&gt;</span> <span class="ss">:key</span> <span class="nf">#&#39;</span><span class="nb">second</span><span class="p">))</span>
    <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~8D |&quot;</span> <span class="p">(</span><span class="nb">second</span> <span class="nv">branch</span><span class="p">))</span>
    <span class="p">(</span><span class="nb">loop</span> <span class="nv">repeat</span> <span class="nv">depth</span> <span class="nb">do</span> <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;--&quot;</span><span class="p">))</span>
    <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;-&gt; ~A~%&quot;</span> <span class="p">(</span><span class="nb">first</span> <span class="nv">branch</span><span class="p">))</span>
    <span class="p">(</span><span class="nv">print-list-tree</span> <span class="p">(</span><span class="nb">cddr</span> <span class="nv">branch</span><span class="p">)</span> <span class="p">(</span><span class="nb">1+</span> <span class="nv">depth</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">du-output-&gt;size-path-pair</span> <span class="p">(</span><span class="nb">string</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">with-input-from-string</span> <span class="p">(</span><span class="nv">in</span> <span class="nb">string</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">line</span> <span class="nb">=</span> <span class="p">(</span><span class="nb">read-line</span> <span class="nv">in</span> <span class="no">nil</span> <span class="no">nil</span><span class="p">)</span>
          <span class="nv">while</span> <span class="nv">line</span>
          <span class="nv">collect</span> <span class="p">(</span><span class="nv">ppcre:register-groups-bind</span> <span class="p">(</span><span class="nv">size</span> <span class="nv">path</span><span class="p">)</span>
                      <span class="p">(</span><span class="s">&quot;^\(\[^\\s\]+\)\\s+\(\[^\\s\]+\)$&quot;</span> <span class="nv">line</span><span class="p">)</span>
                    <span class="p">(</span><span class="nb">cons</span> <span class="p">(</span><span class="nb">parse-integer</span> <span class="nv">size</span><span class="p">)</span>
                          <span class="p">(</span><span class="nb">delete-if</span> <span class="nf">#&#39;</span><span class="nb">zerop</span> <span class="p">(</span><span class="nv">ppcre:split</span> <span class="s">&quot;/&quot;</span> <span class="nv">path</span><span class="p">)</span>
                                     <span class="ss">:key</span> <span class="nf">#&#39;</span><span class="nb">length</span><span class="p">))))))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">du-output-&gt;list-tree</span> <span class="p">(</span><span class="nb">string</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">branch</span> <span class="p">(</span><span class="nv">make-hash-branch</span><span class="p">)))</span>
    <span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">size-path-pair</span> <span class="p">(</span><span class="nv">du-output-&gt;size-path-pair</span> <span class="nb">string</span><span class="p">))</span>
      <span class="p">(</span><span class="nv">hash-tree-add</span> <span class="nv">branch</span> <span class="p">(</span><span class="nb">cdr</span> <span class="nv">size-path-pair</span><span class="p">)</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">size-path-pair</span><span class="p">)))</span>
    <span class="p">(</span><span class="nb">rest</span> <span class="p">(</span><span class="nv">hash-tree-&gt;list-tree</span> <span class="nv">branch</span><span class="p">))))</span>

<span class="p">(</span><span class="nv">du-output-&gt;list-tree</span>
  <span class="p">(</span><span class="nv">trivial-shell:shell-command</span> <span class="s">&quot;du -ab /tmp/c&quot;</span><span class="p">))</span>
<span class="c1">; =&gt; ((&quot;tmp&quot; 21026</span>
<span class="c1">;      (&quot;c&quot; 21026 (&quot;hello.h&quot; 71) (&quot;hello.c&quot; 128) (&quot;main.c&quot; 123) (&quot;main&quot; 9168)</span>
<span class="c1">;       (&quot;out&quot; 1212 (&quot;stdout&quot; 44) (&quot;stderr&quot; 246) (&quot;debug&quot; 256)))))</span>

<span class="p">(</span><span class="nv">print-list-tree</span>
 <span class="p">(</span><span class="nv">du-output-&gt;list-tree</span>
  <span class="p">(</span><span class="nv">trivial-shell:shell-command</span> <span class="s">&quot;du -ab /tmp/c&quot;</span><span class="p">)))</span>
<span class="c1">; =&gt;    21026 |-&gt; tmp</span>
<span class="c1">;       21026 |---&gt; c</span>
<span class="c1">;        9168 |-----&gt; main</span>
<span class="c1">;        1212 |-----&gt; out</span>
<span class="c1">;         256 |-------&gt; debug</span>
<span class="c1">;         246 |-------&gt; stderr</span>
<span class="c1">;          44 |-------&gt; stdout</span>
<span class="c1">;         128 |-----&gt; hello.c</span>
<span class="c1">;         123 |-----&gt; main.c</span>
<span class="c1">;          71 |-----&gt; hello.h</span>


<span class="c1">;;; @@PLEAC@@_6.0</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Note that the following do not modify STRING, which may be</span>
<span class="c1">;; different from how the Perl snippet works.</span>
<span class="p">(</span><span class="nb">use-package</span> <span class="ss">:cl-ppcre</span><span class="p">)</span>         <span class="c1">; assumed by all of section 6.0&#39;s code</span>
<span class="p">(</span><span class="nv">scan</span> <span class="nv">pattern</span> <span class="nb">string</span><span class="p">)</span>
<span class="p">(</span><span class="nv">regex-replace</span> <span class="nv">pattern</span> <span class="nb">string</span> <span class="nv">replacement</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nv">scan</span> <span class="s">&quot;sheep&quot;</span> <span class="nv">meadow</span><span class="p">)</span>   <span class="c1">; Non-nil if MEADOW contains &quot;sheep&quot;</span>
<span class="p">(</span><span class="nb">not</span> <span class="p">(</span><span class="nv">scan</span> <span class="s">&quot;sheep&quot;</span> <span class="nv">meadow</span><span class="p">))</span> <span class="c1">; Non-nil if MEADOW doesn&#39;t contain &quot;sheep&quot;</span>
<span class="p">(</span><span class="nv">regex-replace</span> <span class="s">&quot;old&quot;</span> <span class="nv">meadow</span> <span class="s">&quot;new&quot;</span><span class="p">)</span> <span class="c1">; Replace &quot;old&quot; with &quot;new&quot; in MEADOW</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Fine bovines demand fine toreadors.</span>
<span class="c1">;; Muskoxen are a polar ovibovine species.</span>
<span class="c1">;; Grooviness went out of fashion decades ago.</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Ovines are found typically in oviaries.</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nv">scan</span> <span class="p">(</span><span class="nv">create-scanner</span> <span class="s">&quot;\\bovines?\\b&quot;</span> <span class="ss">:case-insensitive-mode</span> <span class="no">t</span><span class="p">)</span>
                     <span class="nv">meadow</span><span class="p">)</span>
           <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;Here be sheep!&quot;</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">my-string</span> <span class="s">&quot;good food&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">my-string</span> <span class="p">(</span><span class="nv">regex-replace</span> <span class="s">&quot;o*&quot;</span> <span class="nv">my-string</span> <span class="s">&quot;e&quot;</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Not sure how to reproduce the same output.  The above</span>
<span class="c1">;; REGEX-REPLACE just prepends &quot;e&quot; every time (but I&#39;m not</span>
<span class="c1">;; sure that&#39;s wrong).</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">with-input-from-string</span> <span class="p">(</span><span class="nv">s</span> <span class="s">&quot;ababacaca</span>
<span class="s">&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">match</span> <span class="p">(</span><span class="nv">scan-to-strings</span> <span class="s">&quot;(a|ba|b)+(a|ac)+&quot;</span> <span class="p">(</span><span class="nb">read-line</span> <span class="nv">s</span><span class="p">))))</span>
    <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A~%&quot;</span> <span class="nv">match</span><span class="p">)))</span>
<span class="c1">;; ababa</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;;% echo ababacaca |</span>
<span class="c1">;;    awk &#39;match($0,/(a|ba|b)+(a|ac)+/) { print substr($0, RSTART, RLENGTH) }&#39;</span>
<span class="c1">;;ababacaca</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Since there is no magic $_ variable in CL, using MY-STRING as an</span>
<span class="c1">;; example.</span>
<span class="p">(</span><span class="nv">register-groups-bind</span> <span class="p">(</span><span class="nv">num</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;(\\d+)&quot;</span> <span class="nv">some-string</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;Found number ~A~%&quot;</span> <span class="nv">num</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Again, MY-STRING is a placeholder for $_.</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*numbers*</span> <span class="p">(</span><span class="nb">mapcar</span> <span class="nf">#&#39;</span><span class="nb">parse-integer</span> <span class="p">(</span><span class="nv">all-matches-as-strings</span> <span class="s">&quot;(\\d+)&quot;</span> <span class="nv">my-string</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*digits*</span> <span class="s">&quot;1234567890&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*nonlap*</span> <span class="p">(</span><span class="nv">all-matches-as-strings</span> <span class="s">&quot;(\\d\\d\\d)&quot;</span> <span class="vg">*digits*</span><span class="p">))</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*yeslap*</span> <span class="p">(</span><span class="nv">all-matches-as-strings</span> <span class="s">&quot;(?=\\d\\d\\d)&quot;</span> <span class="vg">*digits*</span><span class="p">))</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;Non-overlapping:  ~{~A~^ ~}~%Overlapping:      ~{~A~^ ~}~%&quot;</span>
        <span class="vg">*nonlap*</span> <span class="vg">*yeslap*</span><span class="p">)</span>
<span class="c1">;; Non-overlapping:  123 456 789</span>
<span class="c1">;; Overlapping:</span>

<span class="c1">;; Note that CL-PPCRE seems to treat ?= differently from Perl, hence</span>
<span class="c1">;; the lack of output for Overlapping.</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; CL-PPCRE doesn&#39;t support $` etc after a match (it does for</span>
<span class="c1">;; REGEX-REPLACE but that wouldn&#39;t work here.</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_6.1</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">dst</span> <span class="p">(</span><span class="nv">regex-replace</span> <span class="s">&quot;that&quot;</span> <span class="nv">src</span> <span class="s">&quot;this&quot;</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; No difference from previous.</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; strip to basename</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*progname*</span> <span class="p">(</span><span class="nv">regex-replace</span> <span class="s">&quot;^.*/&quot;</span> <span class="p">(</span><span class="nb">car</span> <span class="vg">*posix-argv*</span><span class="p">)</span> <span class="s">&quot;&quot;</span><span class="p">))</span>

<span class="c1">;; Make All Words Title-Cased</span>
<span class="c1">;; Unfortunately \u and \L aren&#39;t supported by CL-PPCRE (AFAICT), but</span>
<span class="c1">;; CL does have built-in support for capitalization.</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*capword*</span> <span class="p">(</span><span class="nb">string-capitalize</span> <span class="vg">*word*</span><span class="p">))</span>

<span class="c1">;; /usr/man/man3/foo.1 changes to /usr/man/cat3/foo.1</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*catpage*</span> <span class="p">(</span><span class="nv">regex-replace</span> <span class="s">&quot;man(?=\\d)&quot;</span> <span class="vg">*manpage*</span> <span class="s">&quot;cat&quot;</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*bindirs*</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;/usr/bin&quot;</span> <span class="s">&quot;/bin&quot;</span> <span class="s">&quot;/usr/local/bin&quot;</span><span class="p">))</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*libdirs*</span> <span class="p">(</span><span class="nb">mapcar</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">dir</span><span class="p">)</span> <span class="p">(</span><span class="nv">regex-replace</span> <span class="s">&quot;bin&quot;</span> <span class="nv">dir</span> <span class="s">&quot;lib&quot;</span><span class="p">))</span> <span class="vg">*bindirs*</span><span class="p">))</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~{~A~^ ~}~%&quot;</span> <span class="vg">*libdirs*</span><span class="p">)</span>
<span class="c1">;; /usr/lib /lib /usr/local/lib</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">a</span> <span class="p">(</span><span class="nv">regex-replace-all</span> <span class="s">&quot;x&quot;</span> <span class="nv">b</span> <span class="s">&quot;y&quot;</span><span class="p">))</span>  <span class="c1">; copy B and then change A</span>
<span class="c1">;; CL-PPCRE doesn&#39;t support returning the count of changed characters.</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_6.2</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nv">scan</span> <span class="s">&quot;^[A-Za-z]+$&quot;</span> <span class="nv">var</span><span class="p">)</span>
  <span class="c1">;; it is purely alphabetic</span>
  <span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nv">scan</span> <span class="s">&quot;^[^\\W\\d_]+$&quot;</span> <span class="nv">var</span><span class="p">)</span>
  <span class="c1">;; it is purely alphabetic</span>
  <span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; This seems to work without setting the locale.  Not sure why but</span>
<span class="c1">;; there ya&#39; go.</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">data</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;silly&quot;</span> <span class="s">&quot;faзade&quot;</span> <span class="s">&quot;coцperate&quot;</span> <span class="s">&quot;niсo&quot;</span> <span class="s">&quot;Renйe&quot;</span> <span class="s">&quot;Moliиre&quot;</span> <span class="s">&quot;hжmoglobin&quot;</span> <span class="s">&quot;naпve&quot;</span> <span class="s">&quot;tschья&quot;</span>
              <span class="s">&quot;random!stuff#here&quot;</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">word</span> <span class="nv">in</span> <span class="nv">data</span>
        <span class="nb">do</span> <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nv">scan</span> <span class="s">&quot;^[^\W\d_]+$&quot;</span> <span class="nv">word</span><span class="p">)</span>
               <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A: alphabetic~%&quot;</span> <span class="nv">word</span><span class="p">)</span>
               <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A: line noise~%&quot;</span> <span class="nv">word</span><span class="p">))))</span>
<span class="c1">;;silly: alphabetic</span>
<span class="c1">;;faзade: line noise</span>
<span class="c1">;;coцperate: alphabetic</span>
<span class="c1">;;niсo: alphabetic</span>
<span class="c1">;;Renйe: alphabetic</span>
<span class="c1">;;Moliиre: alphabetic</span>
<span class="c1">;;hжmoglobin: alphabetic</span>
<span class="c1">;;naпve: alphabetic</span>
<span class="c1">;;tschья: alphabetic</span>
<span class="c1">;;random!stuff#here: line noise</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_6.3</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; &quot;\\S+&quot;               ; as many non-whitespace bytes as possible</span>
<span class="c1">;; &quot;[A-Za-z&#39;-]+&quot;        ; as many letters, apostrophes, and hyphens</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; &quot;\\b([A-Za-z]+)\\b&quot;            ; usually best</span>
<span class="c1">;; &quot;\\s([A-Za-z]+)\\s&quot;            ; fails at ends or w/ punctuation</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_6.4</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; It makes more sense for this just to be a function in CL rather</span>
<span class="c1">;; than a separate &quot;script&quot;.</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">hostname-&gt;address</span> <span class="p">(</span><span class="nv">hostname</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;~{~A~^.~}&quot;</span>
          <span class="p">(</span><span class="nb">or</span>
           <span class="p">(</span><span class="nb">ignore-errors</span> <span class="p">(</span><span class="nb">concatenate</span> <span class="ss">&#39;list</span>
                                       <span class="p">(</span><span class="nv">sb-bsd-sockets:host-ent-address</span>
                                        <span class="p">(</span><span class="nv">sb-bsd-sockets:get-host-by-name</span> <span class="nv">hostname</span><span class="p">))))</span>
           <span class="p">(</span><span class="nb">list</span> <span class="s">&quot;???&quot;</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">resname</span> <span class="p">(</span><span class="nc">stream</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">matcher</span> <span class="p">(</span><span class="nv">create-scanner</span>
                  <span class="s">&quot;    (     # capture the hostname in $1</span>
<span class="s">        (?:                 # these parens for grouping only</span>
<span class="s">            (?! [-_]  )     # lookahead for neither underscore nor dash</span>
<span class="s">            [\\w-] +        # hostname component</span>
<span class="s">            \\.             # and the domain dot</span>
<span class="s">        ) +                 # now repeat that whole thing a bunch of times</span>
<span class="s">        [A-Za-z]            # next must be a letter</span>
<span class="s">        [\\w-] +            # now trailing domain part</span>
<span class="s">    )                       # end of $1 capture&quot;</span> <span class="ss">:extended-mode</span> <span class="no">t</span><span class="p">)))</span>
    <span class="p">(</span><span class="nv">iter</span> <span class="p">(</span><span class="nv">for</span> <span class="nv">line</span> <span class="nv">in-stream</span> <span class="nc">stream</span> <span class="nv">using</span> <span class="ss">&#39;read-line</span><span class="p">)</span>
          <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A&quot;</span>
                  <span class="p">(</span><span class="nv">regex-replace-all</span>
                   <span class="nv">matcher</span>
                   <span class="nv">line</span>
                   <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">target-string</span> <span class="nv">start</span> <span class="nv">end</span>
                                            <span class="nv">match-start</span> <span class="nv">match-end</span>
                                            <span class="nv">reg-starts</span> <span class="nv">reg-ends</span><span class="p">)</span>
                       <span class="p">(</span><span class="k">declare</span> <span class="p">(</span><span class="k">ignore</span> <span class="nv">start</span> <span class="nv">end</span> <span class="nv">reg-starts</span> <span class="nv">reg-ends</span><span class="p">))</span>
                       <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">hostname</span> <span class="p">(</span><span class="nb">subseq</span> <span class="nv">target-string</span> <span class="nv">match-start</span> <span class="nv">match-end</span><span class="p">)))</span>
                         <span class="p">(</span><span class="nb">concatenate</span> <span class="ss">&#39;string</span> <span class="nv">hostname</span> <span class="s">&quot; [&quot;</span> <span class="p">(</span><span class="nv">hostname-&gt;address</span> <span class="nv">hostname</span><span class="p">)</span> <span class="s">&quot;]&quot;</span><span class="p">))))))))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nv">regex-replace-all</span>
 <span class="p">(</span><span class="nv">create-scanner</span>
  <span class="s">&quot;                  # replace</span>
<span class="s">  \\#                #   a pound sign</span>
<span class="s">  (\\w+)             #   the variable name</span>
<span class="s">  \\#                #   another pound sign&quot;</span>
  <span class="ss">:extended-mode</span> <span class="no">t</span><span class="p">)</span>
 <span class="nv">my-string</span>                         <span class="c1">; using this instead of implicit $_</span>
 <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">target-string</span> <span class="nv">start</span> <span class="nv">end</span> <span class="nv">match-start</span> <span class="nv">match-end</span> <span class="nv">reg-starts</span> <span class="nv">reg-ends</span><span class="p">)</span>
     <span class="p">(</span><span class="k">declare</span> <span class="p">(</span><span class="k">ignore</span> <span class="nv">start</span> <span class="nv">end</span> <span class="nv">reg-starts</span> <span class="nv">reg-ends</span><span class="p">))</span>
     <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">symb</span> <span class="p">(</span><span class="nb">string-upcase</span> <span class="p">(</span><span class="nb">subseq</span> <span class="nv">target-string</span> <span class="p">(</span><span class="nb">elt</span> <span class="nv">reg-starts</span> <span class="mi">0</span><span class="p">)</span> <span class="p">(</span><span class="nb">elt</span> <span class="nv">reg-ends</span> <span class="mi">0</span><span class="p">)))))</span>
       <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;~A&quot;</span> <span class="p">(</span><span class="nb">symbol-value</span> <span class="p">(</span><span class="nb">intern</span> <span class="nv">symb</span><span class="p">))))))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; I&#39;m not sure there&#39;s any way to do this in CL.  There&#39;s</span>
<span class="c1">;; no guarantee that a local variable hasn&#39;t been optimized</span>
<span class="c1">;; away, for example.  EVAL operates in the null lexical</span>
<span class="c1">;; environment, so can&#39;t be used for this purpose.</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_7.0</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">with-open-file</span> <span class="p">(</span><span class="nv">input</span> <span class="s">&quot;/usr/local/widgets/data&quot;</span><span class="p">)</span>
  <span class="c1">;; No need for &quot;die&quot; like call here b/c WITH-OPEN-FILE will do it</span>
  <span class="c1">;; automatically.</span>
  <span class="p">(</span><span class="nv">iter</span> <span class="p">(</span><span class="nv">for</span> <span class="nv">line</span> <span class="nv">in-stream</span> <span class="nv">input</span> <span class="nv">using</span> <span class="ss">&#39;read-line</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nv">scan</span> <span class="s">&quot;blue&quot;</span> <span class="nv">line</span><span class="p">)</span>
          <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A~%&quot;</span> <span class="nv">line</span><span class="p">)))</span>
  <span class="c1">;; No need for explicit CLOSE here b/c WITH-OPEN-FILE will do it</span>
  <span class="c1">;; automatically.</span>
  <span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">var</span> <span class="vg">*standard-input*</span><span class="p">))</span>
  <span class="p">(</span><span class="nv">mysub</span> <span class="nv">var</span> <span class="nv">logfile</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; The Perl example here is showing the &quot;object-oriented&quot; style of</span>
<span class="c1">;; file manipulation.  In CL it isn&#39;t any different than the above.</span>
<span class="c1">;; However we will use this opportunity to demonstrate how to</span>
<span class="c1">;; &quot;manually&quot; open/close a file without WITH-OPEN-FILE.</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">input</span> <span class="p">(</span><span class="nb">open</span> <span class="s">&quot;/usr/local/widgets/data&quot;</span><span class="p">)))</span>
  <span class="p">(</span><span class="nv">iter</span> <span class="p">(</span><span class="nv">for</span> <span class="nv">line</span> <span class="nv">in-stream</span> <span class="nv">input</span> <span class="nv">using</span> <span class="ss">&#39;read-line</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">setf</span> <span class="nv">line</span> <span class="p">(</span><span class="nv">chomp</span> <span class="nv">line</span><span class="p">))</span>
        <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nv">scan</span> <span class="s">&quot;blue&quot;</span> <span class="nv">line</span><span class="p">)</span>
          <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A~%&quot;</span> <span class="nv">line</span><span class="p">)))</span>
  <span class="c1">;; Don&#39;t do this, either use WITH-OPEN-FILE or use UNWIND-PROTECT as</span>
  <span class="c1">;; illustrated later.</span>
  <span class="p">(</span><span class="nb">close</span> <span class="nv">line</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">unwind-protect</span>
    <span class="p">(</span><span class="k">progn</span>
      <span class="p">(</span><span class="nv">iter</span> <span class="p">(</span><span class="nv">for</span> <span class="nv">line</span> <span class="nv">in-stream</span> <span class="vg">*standard-input*</span> <span class="nv">using</span> <span class="ss">&#39;read-line</span><span class="p">)</span>
            <span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nv">scan</span> <span class="s">&quot;\\d&quot;</span> <span class="nv">line</span><span class="p">)</span>
              <span class="p">(</span><span class="nb">warn</span> <span class="s">&quot;No digit found.~%&quot;</span><span class="p">))</span>
            <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;Read: ~A~%&quot;</span> <span class="nv">line</span><span class="p">)))</span>
  <span class="c1">;; Not normally a good idea to do the following; just matching the</span>
  <span class="c1">;; Perl.</span>
  <span class="p">(</span><span class="nb">close</span> <span class="vg">*standard-output*</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; No need for explicit die, OPEN will throw an exception.</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*logfile*</span> <span class="p">(</span><span class="nb">open</span> <span class="s">&quot;/tmp/log&quot;</span> <span class="ss">:direction</span> <span class="ss">:output</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">close</span> <span class="vg">*fh*</span><span class="p">)</span>                            <span class="c1">; no need for die()</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="vg">*standard-output*</span> <span class="vg">*logfile*</span><span class="p">))</span>    <span class="c1">; switch to *LOGFILE* for output</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;Countdown initiated ...~%&quot;</span><span class="p">))</span>
<span class="c1">;; return to original output</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;You have 30 seconds to reach minimum safety distance.~%&quot;</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_7.1</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; For reading is the default, no need for &quot;&lt;&quot; or equivalent.  No need</span>
<span class="c1">;; for explicit die()-like call either.  Note also that you should use</span>
<span class="c1">;; WITH-OPEN-FILE instead of a raw OPEN wherever possible.</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*source*</span> <span class="p">(</span><span class="nb">open</span> <span class="nv">path</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*sink*</span> <span class="p">(</span><span class="nb">open</span> <span class="nv">path</span> <span class="ss">:direction</span> <span class="ss">:output</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="o">#+</span><span class="nv">sbcl</span>
<span class="p">(</span><span class="k">progn</span>
  <span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*source*</span> <span class="p">(</span><span class="nv">sb-posix:open</span> <span class="nv">path</span> <span class="nv">sb-posix:o-rdonly</span><span class="p">))</span>

  <span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*sink*</span> <span class="p">(</span><span class="nv">sb-posix:open</span> <span class="nv">path</span> <span class="nv">sb-posix:o-wronly</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; There is no equivalent of Perl&#39;s &quot;object-oriented&quot; file interface</span>
<span class="c1">;; (arguably, the standard mechanism is already object-oriented).</span>
<span class="c1">;;;-----------------------------</span>
<span class="o">#+</span><span class="nv">sbcl</span>
<span class="p">(</span><span class="k">progn</span>
  <span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*filehandle*</span> <span class="p">(</span><span class="nv">sb-posix:open</span> <span class="nv">name</span> <span class="nv">flags</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*filehandle*</span> <span class="p">(</span><span class="nv">sb-posix:open</span> <span class="nv">name</span> <span class="nv">flags</span> <span class="nv">perms</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*fh*</span> <span class="p">(</span><span class="nb">open</span> <span class="nv">path</span><span class="p">))</span>
<span class="o">#+</span><span class="nv">sbcl</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*fh*</span> <span class="p">(</span><span class="nv">sb-posix:open</span> <span class="nv">path</span> <span class="nv">sb-posix:o-rdonly</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*fh*</span> <span class="p">(</span><span class="nb">open</span> <span class="nv">path</span> <span class="ss">:direction</span> <span class="ss">:output</span><span class="p">))</span>
<span class="o">#+</span><span class="nv">sbcl</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*fh*</span> <span class="p">(</span><span class="nv">sb-posix:open</span> <span class="nv">path</span> <span class="p">(</span><span class="nb">logior</span> <span class="nv">sb-posix:o-wronly</span>
                                               <span class="nv">sb-posix:o-trunc</span>
                                               <span class="nv">sb-posix:o-creat</span><span class="p">)</span>
                                  <span class="mo">#o600</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="o">#+</span><span class="nv">sbcl</span>
<span class="p">(</span><span class="k">progn</span>
  <span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*fh*</span> <span class="p">(</span><span class="nv">sb-posix:open</span> <span class="nv">path</span> <span class="p">(</span><span class="nb">logior</span> <span class="nv">sb-posix:o-wronly</span>
                                                 <span class="nv">sb-posix:o-excl</span>
                                                 <span class="nv">sb-posix:o-creat</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*fh*</span> <span class="p">(</span><span class="nv">sb-posix:open</span> <span class="nv">path</span> <span class="p">(</span><span class="nb">logior</span> <span class="nv">sb-posix:o-wronly</span>
                                                 <span class="nv">sb-posix:o-excl</span>
                                                 <span class="nv">sb-posix:o-creat</span><span class="p">)</span>
                                    <span class="mo">#o600</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*fh*</span> <span class="p">(</span><span class="nb">open</span> <span class="nv">path</span> <span class="ss">:direction</span> <span class="ss">:output</span>
                              <span class="ss">:if-exists</span> <span class="ss">:append</span>
                              <span class="ss">:if-does-not-exist</span> <span class="ss">:create</span><span class="p">))</span>
<span class="o">#+</span><span class="nv">sbcl</span>
<span class="p">(</span><span class="k">progn</span>
  <span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*fh*</span> <span class="p">(</span><span class="nv">sb-posix:open</span> <span class="nv">path</span> <span class="p">(</span><span class="nb">logior</span> <span class="nv">sb-posix:o-wronly</span>
                                                 <span class="nv">sb-posix:o-append</span>
                                                 <span class="nv">sb-posix:o-creat</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*fh*</span> <span class="p">(</span><span class="nv">sb-posix:open</span> <span class="nv">path</span> <span class="p">(</span><span class="nb">logior</span> <span class="nv">sb-posix:o-wronly</span>
                                                 <span class="nv">sb-posix:o-append</span>
                                                 <span class="nv">sb-posix:o-creat</span><span class="p">)</span>
                                    <span class="mo">#o600</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*fh*</span> <span class="p">(</span><span class="nv">sb-posix:open</span> <span class="nv">path</span> <span class="p">(</span><span class="nb">logior</span> <span class="nv">sb-posix:o-wronly</span> <span class="nv">sb-posix:o-append</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*fh*</span> <span class="p">(</span><span class="nb">open</span> <span class="nv">path</span> <span class="ss">:direction</span> <span class="ss">:io</span> <span class="ss">:if-exists</span> <span class="ss">:overwrite</span><span class="p">))</span>
<span class="o">#+</span><span class="nv">sbcl</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*fh*</span> <span class="p">(</span><span class="nv">sb-posix:open</span> <span class="nv">path</span> <span class="nv">sb-posix:o-rdwr</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="o">#+</span><span class="nv">sbcl</span>
<span class="p">(</span><span class="k">progn</span>
  <span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*fh*</span> <span class="p">(</span><span class="nv">sb-posix:open</span> <span class="nv">path</span> <span class="p">(</span><span class="nb">logior</span> <span class="nv">sb-posix:o-rdwr</span>
                                                 <span class="nv">sb-posix:o-creat</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*fh*</span> <span class="p">(</span><span class="nv">sb-posix:open</span> <span class="nv">path</span> <span class="p">(</span><span class="nb">logior</span> <span class="nv">sb-posix:o-rdwr</span>
                                                 <span class="nv">sb-posix:o-creat</span><span class="p">)</span>
                                    <span class="mo">#o600</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="o">#+</span><span class="nv">sbcl</span>
<span class="p">(</span><span class="k">progn</span>
  <span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*fh*</span> <span class="p">(</span><span class="nv">sb-posix:open</span> <span class="nv">path</span> <span class="p">(</span><span class="nb">logior</span> <span class="nv">sb-posix:o-rdwr</span>
                                                 <span class="nv">sb-posix:o-excl</span>
                                                 <span class="nv">sb-posix:o-creat</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*fh*</span> <span class="p">(</span><span class="nv">sb-posix:open</span> <span class="nv">path</span> <span class="p">(</span><span class="nb">logior</span> <span class="nv">sb-posix:o-rdwr</span>
                                                 <span class="nv">sb-posix:o-excl</span>
                                                 <span class="nv">sb-posix:o-creat</span><span class="p">)</span>
                                    <span class="mo">#o600</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_7.2</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; The machinations that the Perl example is doing is dealing with the</span>
<span class="c1">;; fact that Perl normally ignores leading whitespace in a filename.</span>
<span class="c1">;; This shouldn&#39;t be necessary in CL (since the filename doesn&#39;t also</span>
<span class="c1">;; contain the input mode, as it does in Perl), but the following</span>
<span class="c1">;; example illustrates how to do the same thing anyway.</span>
<span class="p">(</span><span class="nb">setf</span> <span class="vg">*filename*</span> <span class="p">(</span><span class="nv">regex-replace</span> <span class="s">&quot;^(\\s)&quot;</span> <span class="vg">*filename*</span> <span class="s">&quot;./$1&quot;</span><span class="p">))</span>
<span class="c1">;; I&#39;m not sure what the \0 being appended in the Perl example is for,</span>
<span class="c1">;; but SBCL, at least, doesn&#39;t seem to even allow NUL in a namestring</span>
<span class="c1">;; (filename), so it&#39;s not shown here.</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*handle*</span> <span class="p">(</span><span class="nb">open</span> <span class="vg">*filename*</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="o">#+</span><span class="nv">sbcl</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*handle*</span> <span class="p">(</span><span class="nv">sb-posix:open</span> <span class="vg">*filename*</span> <span class="nv">sb-posix:o-rdonly</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*filename*</span> <span class="p">(</span><span class="nb">second</span> <span class="vg">*posix-argv*</span><span class="p">))</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*input*</span> <span class="p">(</span><span class="nb">open</span> <span class="vg">*filename*</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*output*</span> <span class="p">(</span><span class="nb">open</span> <span class="vg">*filename*</span> <span class="ss">:direction</span> <span class="ss">:output</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="o">#+</span><span class="nv">sbcl</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*output*</span> <span class="p">(</span><span class="nv">sb-posix:open</span> <span class="vg">*filename*</span> <span class="p">(</span><span class="nb">logior</span> <span class="nv">sb-posix:o-wronly</span>
                                                         <span class="nv">sb-posix:o-trunc</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="vg">*file*</span> <span class="p">(</span><span class="nv">regex-replace</span> <span class="s">&quot;^(\\s)&quot;</span> <span class="vg">*file*</span> <span class="s">&quot;./$1&quot;</span><span class="p">))</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*output*</span> <span class="p">(</span><span class="nb">open</span> <span class="vg">*file*</span> <span class="ss">:direction</span> <span class="ss">:output</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_7.3</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;;; @@INCOMPLETE@@</span>
<span class="c1">;;; @@INCOMPLETE@@</span>


<span class="c1">;;; @@PLEAC@@_7.4</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;; You should not normally do this in CL.  However the example below</span>
<span class="c1">;; does roughly the same thing as the Perl and is a crude example of</span>
<span class="c1">;; how you can handle exceptions in CL.</span>
<span class="p">(</span><span class="nb">handler-case</span>
    <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">file</span> <span class="p">(</span><span class="nb">open</span> <span class="vg">*path*</span><span class="p">)))</span>
      <span class="c1">;; use FILE</span>
      <span class="p">)</span>
  <span class="c1">;; Catch &quot;all&quot; exceptions (CONDITION is the base class of all</span>
  <span class="c1">;; &quot;exceptions&quot; in CL).</span>
  <span class="p">(</span><span class="kt">condition</span> <span class="p">(</span><span class="nv">msg</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">format</span> <span class="vg">*error-output*</span> <span class="s">&quot;~&amp;Couldn&#39;t open ~A for reading : ~A~%&quot;</span> <span class="vg">*path*</span> <span class="nv">msg</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_7.6</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*data*</span> <span class="s">&quot;</span>
<span class="s">Your data goes here</span>
<span class="s">&quot;</span><span class="p">)</span>

<span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">line</span> <span class="nv">in</span> <span class="p">(</span><span class="nv">split</span> <span class="sc">#\Newline</span> <span class="vg">*data*</span><span class="p">)</span>
     <span class="nb">do</span>
     <span class="p">(</span><span class="k">progn</span>
       <span class="c1">;; process the line</span>
       <span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; The Perl example here would be the same as the above.</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; There&#39;s no equivalent to how DATA is used here.  E.g., there&#39;s no</span>
<span class="c1">;; standard way to get the currently executing &quot;script&quot; file.</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_7.18</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">loop</span>
   <span class="nv">for</span> <span class="nv">filehandle</span> <span class="nv">in</span> <span class="vg">*filehandles*</span> <span class="c1">; *FILEHANDLES* is list of STREAM objects</span>
   <span class="nb">do</span> <span class="p">(</span><span class="nb">princ</span> <span class="nv">stuff-to-print</span> <span class="nv">filehandle</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;;; @@INCOMPLETE@@</span>


<span class="c1">;;; @@PLEAC@@_8.2</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Should we count the last line, if it does not end with a newline?</span>
<span class="c1">;; This version counts:</span>
<span class="p">(</span><span class="nb">with-open-file</span> <span class="p">(</span><span class="nc">stream</span> <span class="l-Other">#p&quot;numbers.html&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">line</span> <span class="nb">=</span> <span class="p">(</span><span class="nb">read-line</span> <span class="nc">stream</span> <span class="no">nil</span><span class="p">)</span>
        <span class="nv">while</span> <span class="nv">line</span>
        <span class="nb">count</span> <span class="no">t</span><span class="p">))</span>
<span class="c1">;; and this does not:</span>
<span class="p">(</span><span class="nb">with-open-file</span> <span class="p">(</span><span class="nc">stream</span> <span class="l-Other">#p&quot;numbers.html&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="p">(</span><span class="nv">line</span> <span class="nv">missing-newline-p</span><span class="p">)</span> <span class="nb">=</span>
            <span class="p">(</span><span class="nb">multiple-value-list</span> <span class="p">(</span><span class="nb">read-line</span> <span class="nc">stream</span> <span class="no">nil</span><span class="p">))</span>
        <span class="nv">while</span> <span class="nv">line</span>
        <span class="nb">count</span> <span class="p">(</span><span class="nb">not</span> <span class="nv">missing-newline-p</span><span class="p">)))</span>
<span class="c1">;;; @@INCOMPLETE@@</span>

<span class="c1">;;; @@PLEAC@@_10.0</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*greeted*</span> <span class="mi">0</span><span class="p">)</span>              <span class="c1">; global variable</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">hello</span> <span class="p">()</span>
  <span class="p">(</span><span class="nb">incf</span> <span class="vg">*greeted*</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;hi there!~%&quot;</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nv">hello</span><span class="p">)</span>           <span class="c1">; call subroutine hello with no arguments/parameters</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_10.1</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; It would be strange to declare arguments using &amp;rest when you know</span>
<span class="c1">;; there are exactly two, in CL, but you could, if you wanted to</span>
<span class="c1">;; emulate what the Perl example does.</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">hypotenuse</span> <span class="p">(</span><span class="k">&amp;rest</span> <span class="nv">args</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">sqrt</span> <span class="p">(</span><span class="nb">+</span> <span class="p">(</span><span class="nb">expt</span> <span class="p">(</span><span class="nb">elt</span> <span class="nv">args</span> <span class="mi">0</span><span class="p">)</span> <span class="mi">2</span><span class="p">)</span>
           <span class="p">(</span><span class="nb">expt</span> <span class="p">(</span><span class="nb">elt</span> <span class="nv">args</span> <span class="mi">1</span><span class="p">)</span> <span class="mi">2</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">setf</span> <span class="nv">diag</span> <span class="p">(</span><span class="nv">hypotenuse</span> <span class="mi">3</span> <span class="mi">4</span><span class="p">))</span>            <span class="c1">; DIAG is 5.0</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">hypotenuse</span> <span class="p">(</span><span class="nv">side1</span> <span class="nv">side2</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">sqrt</span> <span class="p">(</span><span class="nb">+</span> <span class="p">(</span><span class="nb">expt</span> <span class="nv">side1</span> <span class="mi">2</span><span class="p">)</span>
           <span class="p">(</span><span class="nb">expt</span> <span class="nv">side2</span> <span class="mi">2</span><span class="p">))))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~D~%&quot;</span> <span class="p">(</span><span class="nb">truncate</span> <span class="p">(</span><span class="nv">hypotenuse</span> <span class="mi">3</span> <span class="mi">4</span><span class="p">)))</span> <span class="c1">; prints 5</span>

<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">a</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">3</span> <span class="mi">4</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~D~%&quot;</span> <span class="p">(</span><span class="nb">truncate</span> <span class="p">(</span><span class="nb">apply</span> <span class="ss">&#39;hypotenuse</span> <span class="nv">a</span><span class="p">))))</span> <span class="c1">; prints 5</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">both</span> <span class="p">(</span><span class="nb">append</span> <span class="nv">men</span> <span class="nv">women</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">both</span> <span class="o">`</span><span class="p">(</span><span class="o">,@</span><span class="nv">men</span> <span class="o">,@</span><span class="nv">women</span><span class="p">))</span> <span class="c1">; alternative way of doing the same thing</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">nums</span> <span class="o">&#39;</span><span class="p">(</span><span class="mf">1.4</span> <span class="mf">3.5</span> <span class="mf">6.7</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">ints</span> <span class="p">(</span><span class="nb">apply</span> <span class="ss">&#39;int-all</span> <span class="nv">nums</span><span class="p">))</span>       <span class="c1">; NUMS unchanged</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">int-all</span> <span class="p">(</span><span class="k">&amp;rest</span> <span class="nv">retlist</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">n</span> <span class="nv">in</span> <span class="nv">retlist</span> <span class="nv">collect</span> <span class="p">(</span><span class="nb">truncate</span> <span class="nv">n</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">nums</span> <span class="o">&#39;</span><span class="p">(</span><span class="mf">1.4</span> <span class="mf">3.5</span> <span class="mf">6.7</span><span class="p">))</span>
<span class="p">(</span><span class="nv">trunc-em</span> <span class="nv">nums</span><span class="p">)</span>                         <span class="c1">; NUMS now (1 3 6)</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">trunc-em</span> <span class="p">(</span><span class="nv">reals</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">map-into</span> <span class="nv">reals</span> <span class="ss">&#39;truncate</span> <span class="nv">reals</span><span class="p">))</span>     <span class="c1">; truncate each element of arg list</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_10.2</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">somefunc</span> <span class="p">()</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">(</span><span class="nv">variable</span>              <span class="c1">; VARIABLE is invisible outside SOMEFUNC</span>
        <span class="nv">another</span> <span class="nv">an-array</span> <span class="nv">a-hash</span><span class="p">)</span>    <span class="c1">; declaring many variables at once</span>
    <span class="c1">;; ...</span>
    <span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">destructuring-bind</span> <span class="p">(</span><span class="nv">name</span> <span class="nv">age</span><span class="p">)</span> <span class="vg">*posix-argv*</span>
  <span class="c1">;; Use NAME, AGE here</span>
  <span class="p">)</span>

<span class="p">(</span><span class="nb">setf</span> <span class="nv">start</span> <span class="p">(</span><span class="nv">fetch-time</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">destructuring-bind</span> <span class="p">(</span><span class="nv">a</span> <span class="nv">b</span><span class="p">)</span> <span class="nv">pair</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">c</span> <span class="p">(</span><span class="nv">fetch-time</span><span class="p">)))</span>
    <span class="c1">;; ...</span>
    <span class="p">))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">check-x</span> <span class="p">(</span><span class="nv">x</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">y</span> <span class="s">&quot;whatever&quot;</span><span class="p">))</span>
    <span class="p">(</span><span class="nv">run-check</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">when</span> <span class="kt">condition</span>
      <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;got ~A~%&quot;</span> <span class="nv">x</span><span class="p">))))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">save-array</span> <span class="p">(</span><span class="k">&amp;rest</span> <span class="nv">arguments</span><span class="p">)</span>
  <span class="c1">;; There&#39;s probably a better way to do this.</span>
  <span class="p">(</span><span class="nb">setf</span> <span class="vg">*global-array*</span> <span class="p">(</span><span class="nb">append</span> <span class="vg">*global-array*</span> <span class="p">(</span><span class="nb">copy-seq</span> <span class="nv">arguments</span><span class="p">))))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_10.3</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">let</span> <span class="p">(</span><span class="nv">variable</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">defun</span> <span class="nv">mysub</span> <span class="p">()</span>
    <span class="c1">;; ... accessing VARIABLE</span>
    <span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">variable</span> <span class="mi">1</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">defun</span> <span class="nv">othersub</span> <span class="p">()</span>
    <span class="c1">;; ... accessing VARIABLE</span>
    <span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">counter</span> <span class="mi">0</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">defun</span> <span class="nv">next-counter</span> <span class="p">()</span>
    <span class="p">(</span><span class="nb">incf</span> <span class="nv">counter</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">counter</span> <span class="mi">42</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">defun</span> <span class="nv">next-counter</span> <span class="p">()</span>
    <span class="p">(</span><span class="nb">incf</span> <span class="nv">counter</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">defun</span> <span class="nv">prev-counter</span> <span class="p">()</span>
    <span class="p">(</span><span class="nb">decf</span> <span class="nv">counter</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_10.4</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; There is no standard equivalent of Perl&#39;s caller(), in CL.</span>
<span class="c1">;; Functions can get inlined (among other things), so it&#39;s not even</span>
<span class="c1">;; clear what something like caller() should actually return, anyway.</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_10.5</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nv">array-diff</span> <span class="nv">array1</span> <span class="nv">array2</span><span class="p">)</span>              <span class="c1">; params are already references</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">a</span> <span class="o">#(</span><span class="mi">1</span> <span class="mi">2</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">b</span> <span class="o">#(</span><span class="mi">5</span> <span class="mi">8</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">c</span> <span class="p">(</span><span class="nv">add-vecpair</span> <span class="nv">a</span> <span class="nv">b</span><span class="p">))</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~{~A~^ ~}~%&quot;</span> <span class="p">(</span><span class="nb">map</span> <span class="ss">&#39;list</span> <span class="ss">&#39;identity</span> <span class="nv">c</span><span class="p">))</span>
<span class="c1">;; 6 10</span>

<span class="c1">;; This function would be simpler with lists instead of arrays, or the</span>
<span class="c1">;; use of the SERIES package.  We&#39;re using arrays because the Perl</span>
<span class="c1">;; does.</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">add-vecpair</span> <span class="p">(</span><span class="nv">x</span> <span class="nv">y</span><span class="p">)</span>        <span class="c1">; assumes both vectors the same length</span>
  <span class="p">(</span><span class="nb">map-into</span> <span class="p">(</span><span class="nb">make-array</span> <span class="p">(</span><span class="nb">length</span> <span class="nv">x</span><span class="p">))</span>
            <span class="ss">&#39;+</span> <span class="nv">x</span> <span class="nv">y</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Normally one would use CHECK-TYPE or ASSERT here, but this example</span>
<span class="c1">;; is trying to match the Perl.</span>
<span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nb">and</span> <span class="p">(</span><span class="nb">typep</span> <span class="nv">x</span> <span class="ss">&#39;vector</span><span class="p">)</span>
             <span class="p">(</span><span class="nb">typep</span> <span class="nv">y</span> <span class="ss">&#39;vector</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">error</span> <span class="s">&quot;usage: add_vecpair VECTOR1 VECTOR2&quot;</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_10.6</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; There is no equivalent to Perl&#39;s wantarray() in CL.  The most</span>
<span class="c1">;; similar language feature is CL&#39;s ability to return multiple values,</span>
<span class="c1">;; which the caller may choose to ignore.</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_10.7</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nv">thefunc</span> <span class="ss">:increment</span> <span class="s">&quot;20s&quot;</span> <span class="ss">:start</span> <span class="s">&quot;+5m&quot;</span> <span class="ss">:finish</span> <span class="s">&quot;+30m&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nv">thefunc</span> <span class="ss">:start</span> <span class="s">&quot;+5m&quot;</span> <span class="ss">:finish</span> <span class="s">&quot;+30m&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nv">thefunc</span> <span class="ss">:finish</span> <span class="s">&quot;+30m&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nv">thefunc</span> <span class="ss">:start</span> <span class="s">&quot;+5m&quot;</span> <span class="ss">:increment</span> <span class="s">&quot;15s&quot;</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; &amp;allow-other-keys is used to emulate the Perl example&#39;s use of @_</span>
<span class="c1">;; in the %args hash.</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">thefunc</span> <span class="p">(</span><span class="k">&amp;key</span> <span class="p">(</span><span class="nv">increment</span> <span class="s">&quot;10s&quot;</span><span class="p">)</span> <span class="nv">finish</span> <span class="nv">start</span> <span class="k">&amp;allow-other-keys</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nv">scan</span> <span class="s">&quot;m$&quot;</span> <span class="nv">increment</span><span class="p">)</span>
    <span class="c1">;; ...</span>
    <span class="p">))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_10.8</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Use of gensym here is unusual, just trying to mimic the Perl (there</span>
<span class="c1">;; is probably a better way to do that, too).  Also, normally you&#39;d do</span>
<span class="c1">;; MULTIPLE-VALUE-BIND.</span>
<span class="p">(</span><span class="nb">multiple-value-setq</span> <span class="p">(</span><span class="nv">a</span> <span class="o">#.</span><span class="p">(</span><span class="nb">gensym</span><span class="p">)</span> <span class="nv">c</span><span class="p">)</span> <span class="p">(</span><span class="nv">func</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; I don&#39;t know of a quicker built-in way to do exactly what the Perl</span>
<span class="c1">;; is doing here.  There is NTH-VALUE but it only returns one value.</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">results</span> <span class="p">(</span><span class="nb">multiple-value-list</span> <span class="p">(</span><span class="nv">func</span><span class="p">))))</span>
  <span class="p">(</span><span class="nb">setf</span> <span class="nv">a</span> <span class="p">(</span><span class="nb">elt</span> <span class="nv">results</span> <span class="mi">0</span><span class="p">)</span>
        <span class="nv">c</span> <span class="p">(</span><span class="nb">elt</span> <span class="nv">results</span> <span class="mi">2</span><span class="p">)))</span>

<span class="c1">;; However you can easily define a macro that does roughly the same</span>
<span class="c1">;; thing.</span>
<span class="p">(</span><span class="nb">defmacro</span> <span class="nv">nth-values</span> <span class="p">((</span><span class="k">&amp;rest</span> <span class="nv">positions</span><span class="p">)</span> <span class="k">&amp;body</span> <span class="nv">body</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">results</span> <span class="p">(</span><span class="nb">gensym</span> <span class="s">&quot;results-&quot;</span><span class="p">)))</span>
    <span class="o">`</span><span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="o">,</span><span class="nv">results</span> <span class="p">(</span><span class="nb">multiple-value-list</span> <span class="o">,@</span><span class="nv">body</span><span class="p">)))</span>
       <span class="p">(</span><span class="nb">values</span>
        <span class="o">,@</span><span class="p">(</span><span class="nb">mapcar</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">pos</span><span class="p">)</span> <span class="o">`</span><span class="p">(</span><span class="nb">elt</span> <span class="o">,</span><span class="nv">results</span> <span class="o">,</span><span class="nv">pos</span><span class="p">))</span> <span class="nv">positions</span><span class="p">)))))</span>

<span class="p">(</span><span class="nb">multiple-value-setq</span> <span class="p">(</span><span class="nv">a</span> <span class="nv">c</span><span class="p">)</span> <span class="p">(</span><span class="nv">nth-values</span> <span class="p">(</span><span class="mi">0</span> <span class="mi">2</span><span class="p">)</span> <span class="p">(</span><span class="nv">func</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="o">#+</span><span class="nv">sbcl</span>
<span class="p">(</span><span class="nb">multiple-value-setq</span> <span class="p">(</span><span class="nv">dev</span> <span class="nv">ino</span> <span class="nv">dummy</span> <span class="nv">dummy</span> <span class="nv">uid</span><span class="p">)</span>  <span class="p">(</span><span class="nv">sb-unix:unix-stat</span> <span class="nv">filename</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="o">#+</span><span class="nv">sbcl</span>
<span class="p">(</span><span class="nb">multiple-value-setq</span> <span class="p">(</span><span class="nv">dev</span> <span class="nv">ino</span> <span class="o">#.</span><span class="p">(</span><span class="nb">gensym</span><span class="p">)</span> <span class="o">#.</span><span class="p">(</span><span class="nb">gensym</span><span class="p">)</span> <span class="nv">uid</span><span class="p">)</span>  <span class="p">(</span><span class="nv">sb-unix:unix-stat</span> <span class="nv">filename</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Using the non-standard NTH-VALUES macro defined above.</span>
<span class="o">#+</span><span class="nv">sbcl</span>
<span class="p">(</span><span class="nb">multiple-value-setq</span> <span class="p">(</span><span class="nv">dev</span> <span class="nv">ino</span> <span class="nv">uid</span> <span class="nv">gid</span><span class="p">)</span> <span class="p">(</span><span class="nv">nth-values</span> <span class="p">(</span><span class="mi">0</span> <span class="mi">1</span> <span class="mi">4</span> <span class="mi">5</span><span class="p">)</span> <span class="p">(</span><span class="nv">sb-unix:unix-stat</span> <span class="nv">filename</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_10.9</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">multiple-value-setq</span> <span class="p">(</span><span class="nc">array</span> <span class="nv">hash</span><span class="p">)</span> <span class="p">(</span><span class="nv">somefunc</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">somefunc</span> <span class="p">()</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nc">array</span> <span class="p">(</span><span class="nb">make-array</span> <span class="o">...</span><span class="p">))</span>
        <span class="p">(</span><span class="nv">hash</span> <span class="p">(</span><span class="nb">make-hash-table</span> <span class="o">...</span><span class="p">)))</span>
    <span class="c1">;; ...</span>
    <span class="p">(</span><span class="nb">values</span> <span class="nc">array</span> <span class="nv">hash</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">fn</span> <span class="p">()</span>
  <span class="c1">;; ...</span>
  <span class="p">(</span><span class="nb">values</span> <span class="nv">a</span> <span class="nv">b</span> <span class="nv">c</span><span class="p">))</span>                 <span class="c1">; assuming a, b and c are all hashes</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">multiple-value-setq</span> <span class="p">(</span><span class="nv">h0</span> <span class="nv">h1</span> <span class="nv">h2</span><span class="p">)</span> <span class="p">(</span><span class="nv">fn</span><span class="p">))</span>   <span class="c1">; unlike Perl example, not &quot;wrong&quot;</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">list-of-hashes</span> <span class="p">(</span><span class="nb">multiple-value-list</span> <span class="p">(</span><span class="nv">fn</span><span class="p">)))</span> <span class="c1">; eg: (gethash &quot;keystring&quot; (elt list-of-hashes 2))</span>
<span class="p">(</span><span class="nb">multiple-value-setq</span> <span class="p">(</span><span class="nv">r0</span> <span class="nv">r1</span> <span class="nv">r2</span><span class="p">)</span> <span class="p">(</span><span class="nv">fn</span><span class="p">))</span> <span class="c1">; everything&#39;s a reference, no difference from previous</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_10.10</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; In CL everything returns a value.</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">empty-retval</span> <span class="p">())</span>                 <span class="c1">; returns nil</span>
<span class="c1">;; If you want to distinguish between returning &quot;empty&quot; vs &quot;undefined&quot;</span>
<span class="c1">;; then you can return return a second value indicating which.</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">empty-retval</span> <span class="p">()</span>
  <span class="p">(</span><span class="nb">values</span> <span class="no">nil</span> <span class="no">nil</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">a</span> <span class="p">(</span><span class="nv">yourfunc</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">when</span> <span class="nv">a</span>
    <span class="c1">;; ...</span>
    <span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; The following are all the same, just mirroring the Perl here.</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">a</span> <span class="p">(</span><span class="nv">sfunc</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">unless</span> <span class="nv">a</span>
    <span class="p">(</span><span class="nb">error</span> <span class="s">&quot;sfunc failed&quot;</span><span class="p">)))</span>

<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">a</span> <span class="p">(</span><span class="nv">afunc</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">unless</span> <span class="nv">a</span>
    <span class="p">(</span><span class="nb">error</span> <span class="s">&quot;afunc failed&quot;</span><span class="p">)))</span>

<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">a</span> <span class="p">(</span><span class="nv">hfunc</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">unless</span> <span class="nv">a</span>
    <span class="p">(</span><span class="nb">error</span> <span class="s">&quot;hfunc failed&quot;</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Note: this is for illustrating the use of OR and ERROR, there is no</span>
<span class="c1">;; built-in ioctl or strerror in CL.</span>
<span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nv">ioctl</span> <span class="o">...</span><span class="p">)</span> <span class="p">(</span><span class="nb">error</span> <span class="s">&quot;can&#39;t ioctl: ~A&quot;</span> <span class="nv">strerror</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_10.11</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">results</span> <span class="p">(</span><span class="nv">myfunc</span> <span class="mi">3</span> <span class="mi">5</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Unlike Perl, you can&#39;t call functions without using outer parens</span>
<span class="c1">;; (unless you develop macros to let you do so in specific</span>
<span class="c1">;; circumstances)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">results</span> <span class="p">(</span><span class="nv">myfunc</span> <span class="mi">3</span> <span class="mi">5</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">results</span> <span class="o">`</span><span class="p">(</span><span class="o">,@</span><span class="p">(</span><span class="nv">myfunc</span> <span class="mi">3</span><span class="p">)</span> <span class="mi">5</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">lock-sh</span> <span class="p">()</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">lock-ex</span> <span class="p">()</span> <span class="mi">2</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">lock-un</span> <span class="p">()</span> <span class="mi">4</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">mypush</span> <span class="p">(</span><span class="nb">list</span> <span class="k">&amp;rest</span> <span class="nv">remainder</span><span class="p">)</span>
  <span class="c1">;; ...</span>
  <span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nv">mypush</span> <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">&gt;</span> <span class="nv">x</span> <span class="mi">10</span><span class="p">)</span> <span class="nv">a</span> <span class="nv">b</span><span class="p">)</span> <span class="mi">3</span> <span class="mi">5</span><span class="p">)</span>          <span class="c1">; unlike Perl, not wrong</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Params are already passed as references in CL</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">hpush</span> <span class="p">(</span><span class="nv">href</span> <span class="k">&amp;rest</span> <span class="nv">keys-and-values</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">loop</span>
     <span class="nv">for</span> <span class="nv">k</span> <span class="nv">in</span> <span class="nv">keys-and-values</span> <span class="nv">by</span> <span class="nf">#&#39;</span><span class="nb">cddr</span>
     <span class="nv">for</span> <span class="nv">v</span> <span class="nv">in</span> <span class="p">(</span><span class="nb">cdr</span> <span class="nv">keys-and-values</span><span class="p">)</span> <span class="nv">by</span> <span class="nf">#&#39;</span><span class="nb">cddr</span>
     <span class="nb">do</span> <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">k</span> <span class="nv">href</span><span class="p">)</span> <span class="nv">v</span><span class="p">))</span>
  <span class="nv">href</span><span class="p">)</span>                                 <span class="c1">; return this for caller&#39;s convenience</span>

<span class="p">(</span><span class="nv">hpush</span> <span class="nv">pieces</span> <span class="s">&quot;queen&quot;</span> <span class="mi">9</span> <span class="s">&quot;rook&quot;</span> <span class="mi">5</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_10.12</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">error</span> <span class="s">&quot;some message&quot;</span><span class="p">)</span>                  <span class="c1">; raise exception</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">multiple-value-bind</span> <span class="p">(</span><span class="nv">result</span> <span class="kt">condition</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">ignore-errors</span> <span class="p">(</span><span class="nb">eval</span> <span class="p">(</span><span class="nv">func</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">when</span> <span class="kt">condition</span> <span class="p">(</span><span class="nb">warn</span> <span class="s">&quot;func raised an exception: ~A&quot;</span> <span class="kt">condition</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">multiple-value-bind</span> <span class="p">(</span><span class="nv">result</span> <span class="kt">condition</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">ignore-errors</span> <span class="p">(</span><span class="nb">eval</span> <span class="p">(</span><span class="nb">setf</span> <span class="nv">val</span> <span class="p">(</span><span class="nv">func</span><span class="p">))))</span>
  <span class="p">(</span><span class="nb">when</span> <span class="kt">condition</span> <span class="p">(</span><span class="nb">warn</span> <span class="s">&quot;func blew up: ~A&quot;</span> <span class="kt">condition</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">multiple-value-bind</span> <span class="p">(</span><span class="nv">result</span> <span class="kt">condition</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">ignore-errors</span> <span class="p">(</span><span class="nb">eval</span> <span class="p">(</span><span class="nb">setf</span> <span class="nv">val</span> <span class="p">(</span><span class="nv">func</span><span class="p">))))</span>
  <span class="p">(</span><span class="nb">when</span> <span class="kt">condition</span> <span class="p">(</span><span class="nb">warn</span> <span class="s">&quot;func blew up: ~A&quot;</span> <span class="kt">condition</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">multiple-value-bind</span> <span class="p">(</span><span class="nv">result</span> <span class="kt">condition</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">ignore-errors</span> <span class="p">(</span><span class="nb">eval</span> <span class="p">(</span><span class="nb">setf</span> <span class="nv">val</span> <span class="p">(</span><span class="nv">func</span><span class="p">))))</span>
  <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">and</span> <span class="kt">condition</span>
             <span class="p">(</span><span class="nb">not</span> <span class="p">(</span><span class="nv">scan</span> <span class="s">&quot;Full moon&quot;</span>
                                 <span class="c1">;; There&#39;s probably a better way to</span>
                                 <span class="c1">;; do this.</span>
                                 <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;~A&quot;</span> <span class="kt">condition</span><span class="p">))))</span>
    <span class="p">(</span><span class="nb">warn</span> <span class="s">&quot;func blew up: ~A&quot;</span> <span class="kt">condition</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; No equivalent to wantarray().</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_10.13</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*age*</span> <span class="mi">18</span><span class="p">)</span>                 <span class="c1">; global variable</span>
<span class="p">(</span><span class="nb">when</span> <span class="nv">CONDITION</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="vg">*age*</span> <span class="mi">23</span><span class="p">))</span>
    <span class="p">(</span><span class="nv">func</span><span class="p">)</span>                              <span class="c1">; sees temporary value of 23</span>
    <span class="p">))</span> <span class="c1">; restore old value at block exit</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">para</span> <span class="p">(</span><span class="nv">get-paragraph</span> <span class="nv">fh</span><span class="p">))</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">get-paragraph</span> <span class="p">(</span><span class="nv">fh</span><span class="p">)</span>
  <span class="c1">;; Skip leading newlines.</span>
  <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">peek</span> <span class="nb">=</span> <span class="p">(</span><span class="nb">peek-char</span> <span class="no">nil</span> <span class="nv">fh</span> <span class="no">nil</span> <span class="no">nil</span><span class="p">)</span>
     <span class="nv">while</span> <span class="p">(</span><span class="nb">and</span> <span class="nv">peek</span> <span class="p">(</span><span class="nb">eql</span> <span class="nv">peek</span> <span class="sc">#\Newline</span><span class="p">))</span>
     <span class="nb">do</span> <span class="p">(</span><span class="nb">read-char</span> <span class="nv">fh</span> <span class="no">nil</span> <span class="no">nil</span><span class="p">))</span>
  <span class="p">(</span><span class="nv">chomp</span>
   <span class="p">(</span><span class="nb">coerce</span> <span class="p">(</span><span class="nb">loop</span>
              <span class="nv">for</span> <span class="nv">c</span> <span class="nb">=</span> <span class="p">(</span><span class="nb">read-char</span> <span class="nv">fh</span> <span class="no">nil</span> <span class="ss">:eof</span><span class="p">)</span>
              <span class="nv">until</span> <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nb">eq</span> <span class="nv">c</span> <span class="ss">:eof</span><span class="p">)</span>
                        <span class="p">(</span><span class="nb">and</span> <span class="p">(</span><span class="nb">eql</span> <span class="nv">c</span> <span class="sc">#\Newline</span><span class="p">)</span>
                             <span class="p">(</span><span class="nb">eql</span> <span class="p">(</span><span class="nb">peek-char</span> <span class="no">nil</span> <span class="nv">fh</span> <span class="no">nil</span> <span class="sc">#\Newline</span><span class="p">)</span>
                                  <span class="sc">#\Newline</span><span class="p">)))</span>
              <span class="nv">collect</span> <span class="nv">c</span><span class="p">)</span>
           <span class="ss">&#39;string</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">contents</span> <span class="p">(</span><span class="nv">get-motd</span><span class="p">))</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">get-motd</span> <span class="p">()</span>
  <span class="p">(</span><span class="nb">with-open-file</span> <span class="p">(</span><span class="nv">motd</span> <span class="s">&quot;/etc/motd&quot;</span><span class="p">)</span> <span class="c1">; will do die()-like stuff automatically</span>
    <span class="p">(</span><span class="nb">coerce</span> <span class="p">(</span><span class="nb">loop</span>
               <span class="nv">for</span> <span class="nv">c</span> <span class="nb">=</span> <span class="p">(</span><span class="nb">read-char</span> <span class="nv">motd</span> <span class="no">nil</span> <span class="ss">:eof</span><span class="p">)</span>
               <span class="nv">until</span> <span class="p">(</span><span class="nb">eq</span> <span class="nv">c</span> <span class="ss">:eof</span><span class="p">)</span>
               <span class="nv">collect</span> <span class="nv">c</span><span class="p">)</span>
            <span class="ss">&#39;string</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Note: in the spirit of the Perl, this section should be done using</span>
<span class="c1">;; LET and DECLARE SPECIAL but I couldn&#39;t get that to work.</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*nums*</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">my-second</span> <span class="p">()</span>     <span class="c1">; don&#39;t redefine CL&#39;s standard SECOND function</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~{~A~^ ~}~%&quot;</span> <span class="vg">*nums*</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">my-first</span> <span class="p">()</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="vg">*nums*</span> <span class="p">(</span><span class="nb">copy-list</span> <span class="vg">*nums*</span><span class="p">)))</span>
    <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">elt</span> <span class="vg">*nums*</span> <span class="mi">3</span><span class="p">)</span> <span class="mf">3.14159</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">my-second</span><span class="p">)))</span>

<span class="p">(</span><span class="nv">my-second</span><span class="p">)</span>
<span class="c1">;; 0 1 2 3 4 5</span>
<span class="p">(</span><span class="nv">my-first</span><span class="p">)</span>
<span class="c1">;; 0 1 2 3.14159 4 5</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; No obvious equivalent to %SIG</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;;-----------------------------</span>
<span class="c1">;;; @@INCOMPLETE@@</span>

<span class="c1">;;; @@PLEAC@@_10.14</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">fmakunbound</span> <span class="ss">&#39;grow</span><span class="p">)</span> <span class="c1">; not sure this is necessary, but more like the Perl</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">symbol-function</span> <span class="ss">&#39;grow</span><span class="p">)</span> <span class="nf">#&#39;</span><span class="nv">expand</span><span class="p">)</span>
<span class="p">(</span><span class="nv">grow</span><span class="p">)</span>                                  <span class="c1">; calls EXPAND</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">one:var</span> <span class="nv">two:table</span><span class="p">)</span>                <span class="c1">; make ONE:VAR alias for TWO:TABLE</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">symbol-function</span> <span class="ss">&#39;one:big</span><span class="p">)</span> <span class="nf">#&#39;</span><span class="nv">two:small</span><span class="p">)</span> <span class="c1">; make ONE:BIG alias for TWO:SMALL</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">fred</span> <span class="nf">#&#39;</span><span class="nv">barney</span><span class="p">))</span>              <span class="c1">; temporarily alias FRED to BARNEY</span>
  <span class="c1">;; ...</span>
  <span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nb">string</span> <span class="p">(</span><span class="nv">red</span> <span class="s">&quot;careful here&quot;</span><span class="p">))</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A&quot;</span> <span class="nb">string</span><span class="p">)</span>
<span class="c1">;; &lt;FONT COLOR=&#39;red&#39;&gt;careful here&lt;/FONT&gt;</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">red</span> <span class="p">(</span><span class="nb">string</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">concatenate</span> <span class="ss">&#39;string</span> <span class="s">&quot;&lt;FONT COLOR=&#39;red&#39;&gt;&quot;</span> <span class="nb">string</span> <span class="s">&quot;&lt;/FONT&gt;&quot;</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defmacro</span> <span class="nv">color-font</span> <span class="p">(</span><span class="nv">color</span><span class="p">)</span>
  <span class="o">`</span><span class="p">(</span><span class="nb">defun</span> <span class="o">,</span><span class="p">(</span><span class="nb">intern</span> <span class="p">(</span><span class="nb">string-upcase</span> <span class="nv">color</span><span class="p">))</span> <span class="p">(</span><span class="nb">string</span><span class="p">)</span>
     <span class="p">(</span><span class="nb">concatenate</span> <span class="ss">&#39;string</span> <span class="s">&quot;&lt;FONT COLOR=&#39;&quot;</span> <span class="o">,</span><span class="nv">color</span> <span class="s">&quot;&#39;&gt;&quot;</span> <span class="nb">string</span> <span class="s">&quot;&lt;/FONT&gt;&quot;</span><span class="p">)))</span>

<span class="p">(</span><span class="nv">color-font</span> <span class="s">&quot;red&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nv">color-font</span> <span class="s">&quot;green&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nv">color-font</span> <span class="s">&quot;blue&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nv">color-font</span> <span class="s">&quot;purple&quot;</span><span class="p">)</span>
<span class="c1">;; etc</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defmacro</span> <span class="nv">color-fonts</span> <span class="p">(</span><span class="k">&amp;rest</span> <span class="nv">colors</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">append</span> <span class="o">&#39;</span><span class="p">(</span><span class="k">progn</span><span class="p">)</span>
          <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">color</span> <span class="nv">in</span> <span class="nv">colors</span>
             <span class="nv">collect</span> <span class="o">`</span><span class="p">(</span><span class="nv">color-font</span> <span class="o">,</span><span class="nv">color</span><span class="p">))))</span>

<span class="p">(</span><span class="nv">color-fonts</span> <span class="s">&quot;red&quot;</span> <span class="s">&quot;green&quot;</span> <span class="s">&quot;blue&quot;</span> <span class="s">&quot;yellow&quot;</span> <span class="s">&quot;orange&quot;</span> <span class="s">&quot;purple&quot;</span> <span class="s">&quot;violet&quot;</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_10.16</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">outer</span> <span class="p">(</span><span class="nv">arg</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="nv">x</span> <span class="p">(</span><span class="nb">+</span> <span class="nv">arg</span> <span class="mi">35</span><span class="p">))</span>
         <span class="c1">;; You&#39;re much less likely to do this accidentally in CL, but</span>
         <span class="c1">;; I&#39;m trying to match the spirit of the Perl example.</span>
         <span class="p">(</span><span class="nv">inner</span> <span class="p">(</span><span class="k">block</span> <span class="no">nil</span>
                  <span class="p">(</span><span class="nb">return</span> <span class="p">(</span><span class="nb">*</span> <span class="nv">x</span> <span class="mi">19</span><span class="p">)))))</span>  <span class="c1">; WRONG</span>
    <span class="p">(</span><span class="nb">+</span> <span class="nv">x</span> <span class="p">(</span><span class="nv">inner</span><span class="p">))))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">outer</span> <span class="p">(</span><span class="nv">arg</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">x</span> <span class="p">(</span><span class="nb">+</span> <span class="nv">arg</span> <span class="mi">35</span><span class="p">)))</span>
    <span class="p">(</span><span class="k">flet</span> <span class="p">((</span><span class="nv">inner</span> <span class="p">()</span> <span class="p">(</span><span class="nb">*</span> <span class="nv">x</span> <span class="mi">19</span><span class="p">)))</span>
      <span class="p">(</span><span class="nb">+</span> <span class="nv">x</span> <span class="p">(</span><span class="nv">inner</span><span class="p">)))))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_10.17</span>
<span class="c1">;;;-----------------------------</span>

<span class="p">(</span><span class="nb">defgeneric</span> <span class="nv">cmp</span> <span class="p">(</span><span class="nv">a</span> <span class="nv">b</span><span class="p">)</span>
  <span class="p">(</span><span class="ss">:documentation</span> <span class="s">&quot;Vaguely like Perl&#39;s cmp() function.&quot;</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defmethod</span> <span class="nv">cmp</span> <span class="p">((</span><span class="nv">a</span> <span class="nb">string</span><span class="p">)</span> <span class="p">(</span><span class="nv">b</span> <span class="nb">string</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">cond</span>
    <span class="p">((</span><span class="nb">string=</span> <span class="nv">a</span> <span class="nv">b</span><span class="p">)</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">((</span><span class="nb">string-lessp</span> <span class="nv">a</span> <span class="nv">b</span><span class="p">)</span> <span class="mi">-1</span><span class="p">)</span>
    <span class="p">(</span><span class="no">t</span> <span class="mi">1</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defmethod</span> <span class="nv">cmp</span> <span class="p">((</span><span class="nv">a</span> <span class="nc">number</span><span class="p">)</span> <span class="p">(</span><span class="nv">b</span> <span class="nc">number</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">cond</span>
    <span class="p">((</span><span class="nb">=</span> <span class="nv">a</span> <span class="nv">b</span><span class="p">)</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">((</span><span class="nb">&lt;</span> <span class="nv">a</span> <span class="nv">b</span><span class="p">)</span> <span class="mi">-1</span><span class="p">)</span>
    <span class="p">(</span><span class="no">t</span> <span class="mi">1</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defmethod</span> <span class="nv">cmp</span> <span class="p">(</span><span class="nv">a</span> <span class="nv">b</span><span class="p">)</span>
  <span class="mi">0</span><span class="p">)</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">bysub1</span> <span class="p">(</span><span class="k">&amp;rest</span> <span class="nv">filenames</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">sub</span> <span class="p">(</span><span class="nb">make-array</span> <span class="mi">0</span> <span class="ss">:fill-pointer</span> <span class="mi">0</span><span class="p">))</span>
        <span class="p">(</span><span class="nv">msgs</span> <span class="p">(</span><span class="nb">make-array</span> <span class="mi">0</span> <span class="ss">:fill-pointer</span> <span class="mi">0</span><span class="p">)))</span>
    <span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">filename</span> <span class="nv">filenames</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">with-open-file</span> <span class="p">(</span><span class="nv">file</span> <span class="nv">filename</span><span class="p">)</span>
        <span class="c1">;; GET-PARAGRAPH defined in section 10.13</span>
        <span class="p">(</span><span class="nb">loop</span>
           <span class="nv">for</span> <span class="nv">paragraph</span> <span class="nb">=</span> <span class="p">(</span><span class="nv">get-paragraph</span> <span class="nv">file</span><span class="p">)</span>
           <span class="nv">until</span> <span class="p">(</span><span class="nb">string-equal</span> <span class="nv">paragraph</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
           <span class="nb">do</span> <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nv">scan</span> <span class="p">(</span><span class="nv">create-scanner</span> <span class="err">#</span><span class="nv">?r</span><span class="s">&quot;^From&quot;</span> <span class="ss">:multi-line-mode</span> <span class="no">t</span><span class="p">)</span>
                          <span class="nv">paragraph</span><span class="p">)</span>
                <span class="p">(</span><span class="nb">vector-push-extend</span>
                 <span class="p">(</span><span class="nb">or</span>
                  <span class="p">(</span><span class="nv">register-groups-bind</span> <span class="p">(</span><span class="nv">subject</span><span class="p">)</span>
                      <span class="p">((</span><span class="nv">create-scanner</span> <span class="err">#</span><span class="nv">?r/^Subject:\s*</span><span class="p">(</span><span class="nv">?:Re:\s*</span><span class="p">)</span><span class="nb">*</span><span class="p">(</span><span class="o">.</span><span class="nb">*</span><span class="p">)</span><span class="nb">/</span>
                                       <span class="ss">:case-insensitive-mode</span> <span class="no">t</span> <span class="ss">:multi-line-mode</span> <span class="no">t</span><span class="p">)</span>
                       <span class="nv">paragraph</span><span class="p">)</span>
                    <span class="p">(</span><span class="nb">string-downcase</span> <span class="nv">subject</span><span class="p">))</span>
                  <span class="s">&quot;&quot;</span><span class="p">)</span>
                 <span class="nv">sub</span><span class="p">))</span>
           <span class="p">(</span><span class="nb">vector-push-extend</span> <span class="nv">paragraph</span> <span class="nv">msgs</span><span class="p">))))</span>
    <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">indices</span> <span class="p">(</span><span class="nb">make-array</span> <span class="p">(</span><span class="nb">length</span> <span class="nv">msgs</span><span class="p">)</span>
                               <span class="ss">:initial-contents</span> <span class="p">(</span><span class="nb">loop</span>
                                                    <span class="nv">for</span> <span class="nv">i</span> <span class="nv">below</span> <span class="p">(</span><span class="nb">length</span> <span class="nv">msgs</span><span class="p">)</span>
                                                    <span class="nv">collect</span> <span class="nv">i</span><span class="p">))))</span>
      <span class="p">(</span><span class="nb">sort</span> <span class="nv">indices</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">a</span> <span class="nv">b</span><span class="p">)</span>
                        <span class="p">(</span><span class="nb">case</span> <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">and</span> <span class="p">(</span><span class="nb">&lt;</span> <span class="nv">a</span> <span class="p">(</span><span class="nb">length</span> <span class="nv">sub</span><span class="p">))</span> <span class="p">(</span><span class="nb">&lt;</span> <span class="nv">b</span> <span class="p">(</span><span class="nb">length</span> <span class="nv">sub</span><span class="p">)))</span>
                                  <span class="p">(</span><span class="nv">cmp</span> <span class="p">(</span><span class="nb">aref</span> <span class="nv">sub</span> <span class="nv">a</span><span class="p">)</span> <span class="p">(</span><span class="nb">aref</span> <span class="nv">sub</span> <span class="nv">b</span><span class="p">))</span>
                                  <span class="mi">0</span><span class="p">)</span>
                          <span class="p">(</span><span class="mi">0</span> <span class="p">(</span><span class="nb">&lt;</span> <span class="nv">a</span> <span class="nv">b</span><span class="p">))</span>
                          <span class="p">(</span><span class="mi">-1</span> <span class="no">t</span><span class="p">))))</span>
      <span class="p">(</span><span class="nb">map</span> <span class="no">nil</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">i</span><span class="p">)</span>
                   <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A~%&quot;</span> <span class="p">(</span><span class="nb">aref</span> <span class="nv">msgs</span> <span class="nv">i</span><span class="p">)))</span>
           <span class="nv">indices</span><span class="p">))))</span>

<span class="c1">;; bysub2 illustrates a Perl-specific idiom and will be skipped.</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">print-hash-table</span> <span class="p">(</span><span class="nv">hashtable</span><span class="p">)</span>
  <span class="s">&quot;Useful for debugging.&quot;</span>
  <span class="p">(</span><span class="nb">loop</span>
     <span class="nv">for</span> <span class="nv">key</span> <span class="nv">being</span> <span class="k">the</span> <span class="nv">hash-keys</span> <span class="nv">of</span> <span class="nv">hashtable</span> <span class="nv">using</span> <span class="p">(</span><span class="nv">hash-value</span> <span class="nv">value</span><span class="p">)</span>
     <span class="nb">do</span> <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A: ~A~%&quot;</span> <span class="nv">key</span> <span class="nv">value</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">bysub3</span> <span class="p">(</span><span class="k">&amp;rest</span> <span class="nv">filenames</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">msgs</span> <span class="p">(</span><span class="nb">make-array</span> <span class="mi">0</span> <span class="ss">:fill-pointer</span> <span class="mi">0</span><span class="p">)))</span>
    <span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">filename</span> <span class="nv">filenames</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">with-open-file</span> <span class="p">(</span><span class="nv">file</span> <span class="nv">filename</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">loop</span>
           <span class="nv">for</span> <span class="nv">paragraph</span> <span class="nb">=</span> <span class="p">(</span><span class="nv">get-paragraph</span> <span class="nv">file</span><span class="p">)</span>
           <span class="nv">until</span> <span class="p">(</span><span class="nb">string-equal</span> <span class="nv">paragraph</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
           <span class="nb">do</span>
           <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nv">scan</span> <span class="p">(</span><span class="nv">create-scanner</span> <span class="err">#</span><span class="nv">?r</span><span class="s">&quot;^From&quot;</span> <span class="ss">:multi-line-mode</span> <span class="no">t</span><span class="p">)</span>
                       <span class="nv">paragraph</span><span class="p">)</span>
             <span class="p">(</span><span class="nb">vector-push-extend</span>
              <span class="p">(</span><span class="nv">mkhash</span>                   <span class="c1">; MKHASH defined in appendix</span>
               <span class="ss">:subject</span> <span class="p">(</span><span class="nv">register-groups-bind</span> <span class="p">(</span><span class="nv">subject</span><span class="p">)</span>
                            <span class="p">((</span><span class="nv">create-scanner</span> <span class="err">#</span><span class="nv">?r/^Subject:\s*</span><span class="p">(</span><span class="nv">?:Re:\s*</span><span class="p">)</span><span class="nb">*</span><span class="p">(</span><span class="o">.</span><span class="nb">*</span><span class="p">)</span><span class="nb">/</span>
                                             <span class="ss">:case-insensitive-mode</span> <span class="no">t</span> <span class="ss">:multi-line-mode</span> <span class="no">t</span><span class="p">)</span> <span class="nv">paragraph</span><span class="p">)</span>
                          <span class="p">(</span><span class="nb">string-downcase</span> <span class="nv">subject</span><span class="p">))</span>
               <span class="ss">:number</span> <span class="p">(</span><span class="nb">fill-pointer</span> <span class="nv">msgs</span><span class="p">)</span>
               <span class="ss">:text</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
              <span class="nv">msgs</span><span class="p">))</span>
           <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">mail-record</span> <span class="p">(</span><span class="nb">aref</span> <span class="nv">msgs</span> <span class="p">(</span><span class="nb">1-</span> <span class="p">(</span><span class="nb">fill-pointer</span> <span class="nv">msgs</span><span class="p">)))))</span>
             <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:text</span> <span class="nv">mail-record</span><span class="p">)</span> <span class="p">(</span><span class="nb">concatenate</span> <span class="ss">&#39;string</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:text</span> <span class="nv">mail-record</span><span class="p">)</span> <span class="nv">paragraph</span><span class="p">))))))</span>
    <span class="p">(</span><span class="nb">map</span> <span class="no">nil</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">msg</span><span class="p">)</span>
                 <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A&quot;</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:text</span> <span class="nv">msg</span><span class="p">)))</span>
         <span class="p">(</span><span class="nb">sort</span> <span class="nv">msgs</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">a</span> <span class="nv">b</span><span class="p">)</span>
                        <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">subject-a</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:subject</span> <span class="nv">a</span><span class="p">))</span>
                              <span class="p">(</span><span class="nv">subject-b</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:subject</span> <span class="nv">b</span><span class="p">)))</span>
                          <span class="p">(</span><span class="nb">case</span> <span class="p">(</span><span class="nv">cmp</span> <span class="nv">subject-a</span> <span class="nv">subject-b</span><span class="p">)</span>
                            <span class="p">(</span><span class="mi">0</span> <span class="p">(</span><span class="nb">&lt;</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:number</span> <span class="nv">a</span><span class="p">)</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:number</span> <span class="nv">b</span><span class="p">)))</span>
                            <span class="p">(</span><span class="mi">-1</span> <span class="no">t</span><span class="p">))))))))</span>

<span class="c1">;; Can be downloaded using ASDF-INSTALL</span>
<span class="p">(</span><span class="nb">require</span> <span class="ss">:metatilities</span><span class="p">)</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">datesort</span> <span class="p">(</span><span class="k">&amp;rest</span> <span class="nv">filenames</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">msgs</span> <span class="p">(</span><span class="nb">make-array</span> <span class="mi">0</span> <span class="ss">:fill-pointer</span> <span class="mi">0</span><span class="p">)))</span>
    <span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">filename</span> <span class="nv">filenames</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">with-open-file</span> <span class="p">(</span><span class="nv">file</span> <span class="nv">filename</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">loop</span>
           <span class="nv">for</span> <span class="nv">paragraph</span> <span class="nb">=</span> <span class="p">(</span><span class="nv">get-paragraph</span> <span class="nv">file</span><span class="p">)</span>
           <span class="nv">until</span> <span class="p">(</span><span class="nb">string-equal</span> <span class="nv">paragraph</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
           <span class="nb">do</span>
           <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nv">scan</span> <span class="p">(</span><span class="nv">create-scanner</span> <span class="err">#</span><span class="nv">?r</span><span class="s">&quot;^From&quot;</span> <span class="ss">:multi-line-mode</span> <span class="no">t</span><span class="p">)</span>
                       <span class="nv">paragraph</span><span class="p">)</span>
             <span class="p">(</span><span class="nb">vector-push-extend</span>
              <span class="p">(</span><span class="nv">mkhash</span>
               <span class="ss">:subject</span> <span class="p">(</span><span class="nv">register-groups-bind</span> <span class="p">(</span><span class="nv">subject</span><span class="p">)</span>
                            <span class="p">((</span><span class="nv">create-scanner</span> <span class="err">#</span><span class="nv">?r/^Subject:\s*</span><span class="p">(</span><span class="nv">?:Re:\s*</span><span class="p">)</span><span class="nb">*</span><span class="p">(</span><span class="o">.</span><span class="nb">*</span><span class="p">)</span><span class="nb">/</span>
                                             <span class="ss">:case-insensitive-mode</span> <span class="no">t</span> <span class="ss">:multi-line-mode</span> <span class="no">t</span><span class="p">)</span> <span class="nv">paragraph</span><span class="p">)</span>
                          <span class="p">(</span><span class="nb">string-downcase</span> <span class="nv">subject</span><span class="p">))</span>
               <span class="ss">:number</span> <span class="p">(</span><span class="nb">fill-pointer</span> <span class="nv">msgs</span><span class="p">)</span>
               <span class="c1">;; Need IGNORE-ERRORS because PARSE-DATE-AND-TIME can</span>
               <span class="c1">;; signal conditions</span>
               <span class="ss">:date</span> <span class="p">(</span><span class="nb">ignore-errors</span>
                       <span class="p">(</span><span class="nv">metatilities:parse-date-and-time</span>
                        <span class="p">(</span><span class="nv">register-groups-bind</span> <span class="p">(</span><span class="nv">date</span><span class="p">)</span>
                            <span class="p">((</span><span class="nv">create-scanner</span> <span class="err">#</span><span class="nv">?r/^Date:\s*</span><span class="p">(</span><span class="o">.</span><span class="nb">*</span><span class="p">)</span><span class="nb">/</span> <span class="ss">:multi-line-mode</span> <span class="no">t</span><span class="p">)</span> <span class="nv">paragraph</span><span class="p">)</span>
                          <span class="p">(</span><span class="nb">car</span> <span class="p">(</span><span class="nv">split</span> <span class="err">#</span><span class="nv">?r</span><span class="s">&quot;\s+\(&quot;</span> <span class="nv">date</span><span class="p">)))))</span>
               <span class="ss">:text</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
              <span class="nv">msgs</span><span class="p">))</span>
           <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">mail-record</span> <span class="p">(</span><span class="nb">aref</span> <span class="nv">msgs</span> <span class="p">(</span><span class="nb">1-</span> <span class="p">(</span><span class="nb">fill-pointer</span> <span class="nv">msgs</span><span class="p">)))))</span>
             <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:text</span> <span class="nv">mail-record</span><span class="p">)</span> <span class="p">(</span><span class="nb">concatenate</span> <span class="ss">&#39;string</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:text</span> <span class="nv">mail-record</span><span class="p">)</span> <span class="nv">paragraph</span><span class="p">))))))</span>
    <span class="p">(</span><span class="nb">map</span> <span class="no">nil</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">msg</span><span class="p">)</span>
                 <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A&quot;</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:text</span> <span class="nv">msg</span><span class="p">)))</span>
         <span class="p">(</span><span class="nb">sort</span> <span class="nv">msgs</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">a</span> <span class="nv">b</span><span class="p">)</span>
                        <span class="p">(</span><span class="nb">case</span> <span class="p">(</span><span class="nv">cmp</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:subject</span> <span class="nv">a</span><span class="p">)</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:subject</span> <span class="nv">b</span><span class="p">))</span>
                          <span class="p">(</span><span class="mi">-1</span> <span class="no">t</span><span class="p">)</span>
                          <span class="p">(</span><span class="mi">0</span> <span class="p">(</span><span class="nb">case</span> <span class="p">(</span><span class="nv">cmp</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:date</span> <span class="nv">a</span><span class="p">)</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:date</span> <span class="nv">b</span><span class="p">))</span>
                               <span class="p">(</span><span class="mi">-1</span> <span class="no">t</span><span class="p">)</span>
                               <span class="p">(</span><span class="mi">0</span> <span class="p">(</span><span class="nb">&lt;</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:number</span> <span class="nv">a</span><span class="p">)</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:number</span> <span class="nv">b</span><span class="p">)))))))))))</span>

<span class="c1">;;; @@PLEAC@@_11.0</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; In CL you don&#39;t need extra syntax to treat variables (symbols) as</span>
<span class="c1">;; references, they already work that way.</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A&quot;</span> <span class="nv">sref</span><span class="p">)</span> <span class="c1">; prints the value that the reference SREF refers to</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">sref</span> <span class="mi">3</span><span class="p">)</span>                           <span class="c1">; assigns SREF&#39;s referent</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; The Perl subsection here isn&#39;t any different from the above, in CL.</span>
<span class="c1">;;print ${$sref};             # prints the scalar $sref refers to</span>
<span class="c1">;;${$sref} = 3;               # assigns to $sref&#39;s referent</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; We&#39;re calling this MY-AREF instead of AREF to avoid confusion with</span>
<span class="c1">;; CL&#39;s built-in AREF function.</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">my-aref</span> <span class="nc">array</span><span class="p">)</span>       <span class="c1">; no special synatx needed to get reference</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Not sure what the Perl here is trying to show.  Probably has no</span>
<span class="c1">;; realistic equivalent in CL.</span>
<span class="c1">;; $pi = \3.14159;</span>
<span class="c1">;; $$pi = 4;           # runtime error</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">my-aref</span> <span class="o">#(</span><span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span><span class="p">))</span> <span class="c1">; new array (no &quot;anonymous&quot; distinction in CL)</span>
<span class="c1">;; MKHASH defined in appendix, not standard CL</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">href</span> <span class="p">(</span><span class="nv">mkhash</span> <span class="s">&quot;How&quot;</span> <span class="s">&quot;Now&quot;</span> <span class="s">&quot;Brown&quot;</span> <span class="s">&quot;Cow&quot;</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">makunbound</span> <span class="ss">&#39;my-aref</span><span class="p">)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">my-aref</span> <span class="o">#(</span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span><span class="p">))</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A&quot;</span> <span class="nv">my-aref</span><span class="p">)</span>
<span class="c1">;; #(1 2 3)</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Perl doesn&#39;t support &quot;rectangular&quot; multi-dimensional arrays (i.e.,</span>
<span class="c1">;; a continuous block of memory with all cells preallocated), instead</span>
<span class="c1">;; it supports &quot;jagged&quot; arrays (i.e., arrays of references to other</span>
<span class="c1">;; arrays).  CL supports rectangular arrays by default, but there&#39;s</span>
<span class="c1">;; nothing stopping you from using jagged arrays instead, since CL</span>
<span class="c1">;; arrays can contain anything.  In this example we&#39;ll assume jagged</span>
<span class="c1">;; arrays, to match the Perl example&#39;s semantics.</span>

<span class="c1">;; You could go like this, but it is a lot of typing and is confusing</span>
<span class="c1">;; to read.</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">aref</span> <span class="p">(</span><span class="nb">aref</span> <span class="p">(</span><span class="nb">aref</span> <span class="p">(</span><span class="nb">aref</span> <span class="nv">a</span> <span class="mi">4</span><span class="p">)</span> <span class="mi">23</span><span class="p">)</span> <span class="mi">53</span><span class="p">)</span> <span class="mi">21</span><span class="p">)</span> <span class="s">&quot;fred&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A&quot;</span> <span class="p">(</span><span class="nb">aref</span> <span class="p">(</span><span class="nb">aref</span> <span class="p">(</span><span class="nb">aref</span> <span class="p">(</span><span class="nb">aref</span> <span class="nv">a</span> <span class="mi">4</span><span class="p">)</span> <span class="mi">23</span><span class="p">)</span> <span class="mi">53</span><span class="p">)</span> <span class="mi">21</span><span class="p">))</span>
<span class="c1">;; fred</span>

<span class="c1">;; An AREF-like macro to handle jagged arrays will save typing/errors.</span>
<span class="p">(</span><span class="nb">defmacro</span> <span class="nv">perl-aref</span> <span class="p">(</span><span class="nc">array</span> <span class="k">&amp;rest</span> <span class="nv">subscripts</span><span class="p">)</span>
  <span class="s">&quot;Allows AREF-like access to arrays-of-refrences (as opposed to true</span>
<span class="s">multidimensional arrays.)&quot;</span>
  <span class="p">(</span><span class="k">labels</span> <span class="p">((</span><span class="nv">make-arefs</span> <span class="p">(</span><span class="nc">array</span> <span class="nv">subscripts</span><span class="p">)</span>
             <span class="p">(</span><span class="k">if</span> <span class="nv">subscripts</span>
                 <span class="p">(</span><span class="nv">make-arefs</span> <span class="o">`</span><span class="p">(</span><span class="nb">aref</span> <span class="o">,</span><span class="nc">array</span> <span class="o">,</span><span class="p">(</span><span class="nb">car</span> <span class="nv">subscripts</span><span class="p">))</span> <span class="p">(</span><span class="nb">cdr</span> <span class="nv">subscripts</span><span class="p">))</span>
                 <span class="nc">array</span><span class="p">)))</span>
    <span class="p">(</span><span class="nv">make-arefs</span> <span class="nc">array</span> <span class="nv">subscripts</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">perl-aref</span> <span class="nv">a</span> <span class="mi">4</span> <span class="mi">23</span> <span class="mi">53</span> <span class="mi">21</span><span class="p">)</span> <span class="s">&quot;fred&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A&quot;</span> <span class="p">(</span><span class="nv">perl-aref</span> <span class="nv">a</span> <span class="mi">4</span> <span class="mi">23</span> <span class="mi">53</span> <span class="mi">21</span><span class="p">))</span>
<span class="c1">;; fred</span>

<span class="c1">;; Each of the following will print out the entire substructure.</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A&quot;</span> <span class="p">(</span><span class="nv">perl-aref</span> <span class="nv">a</span> <span class="mi">4</span> <span class="mi">23</span> <span class="mi">53</span><span class="p">))</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A&quot;</span> <span class="p">(</span><span class="nv">perl-aref</span> <span class="nv">a</span> <span class="mi">4</span> <span class="mi">23</span><span class="p">))</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A&quot;</span> <span class="p">(</span><span class="nv">perl-aref</span> <span class="nv">a</span> <span class="mi">4</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">op-cit</span> <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nv">cite</span> <span class="nv">ibid</span><span class="p">)</span> <span class="p">(</span><span class="nb">error</span> <span class="s">&quot;couldn&#39;t make a reference&quot;</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; MKHASH defined in appendix</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">nat</span> <span class="p">(</span><span class="nv">mkhash</span> <span class="s">&quot;Name&quot;</span> <span class="s">&quot;Leonhard Euler&quot;</span>
                  <span class="s">&quot;Address&quot;</span> <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;1729 Ramanujan Lane~%Mathworld, PI 31416&quot;</span><span class="p">)</span>
                  <span class="s">&quot;Birthday&quot;</span> <span class="mh">#x5bb5580</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_11.1</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">my-aref</span> <span class="nc">array</span><span class="p">)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">anon-array</span> <span class="o">#(</span><span class="mi">1</span> <span class="mi">3</span> <span class="mi">5</span> <span class="mi">7</span> <span class="mi">9</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">anon-copy</span> <span class="p">(</span><span class="nb">copy-seq</span> <span class="nv">my-array</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">implicit-creation</span> <span class="p">(</span><span class="nb">copy-seq</span> <span class="o">#(</span><span class="mi">2</span> <span class="mi">4</span> <span class="mi">6</span> <span class="mi">8</span> <span class="mi">10</span><span class="p">)))</span> <span class="c1">; not sure this is what the Perl means</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">vector-push-extend</span> <span class="mi">11</span> <span class="nv">anon-array</span><span class="p">)</span>      <span class="c1">; ANON-ARRAY must have fill pointer (unlike above)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">two</span> <span class="p">(</span><span class="nb">aref</span> <span class="nv">implicit-creation</span> <span class="mi">0</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">last-idx</span> <span class="p">(</span><span class="nb">1-</span> <span class="p">(</span><span class="nb">length</span> <span class="nv">my-aref</span><span class="p">)))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">num-items</span> <span class="p">(</span><span class="nb">length</span> <span class="nv">my-aref</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; check wehther SOMEREF contains a simple array reference</span>
<span class="p">(</span><span class="nb">check-type</span> <span class="nv">someref</span> <span class="kt">simple-vector</span><span class="p">)</span> <span class="c1">; CHECK-TYPE does a die() implicitly, if necessary</span>

<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~{~A~^ ~}~%&quot;</span> <span class="p">(</span><span class="nb">coerce</span> <span class="nv">array-ref</span> <span class="ss">&#39;list</span><span class="p">))</span>

<span class="c1">;; SORT modifies the original array so we use STABLE-SORT to be more</span>
<span class="c1">;; like the Perl example.</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">order</span> <span class="p">(</span><span class="nb">stable-sort</span> <span class="nv">array-ref</span> <span class="ss">&#39;&lt;</span><span class="p">))</span>

<span class="c1">;; Only works if ARRAY-REF has a fill-pointer</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">array-ref</span> <span class="p">(</span><span class="nb">make-array</span> <span class="mi">0</span> <span class="ss">:adjustable</span> <span class="no">t</span> <span class="ss">:fill-pointer</span> <span class="mi">0</span><span class="p">))</span> <span class="c1">; for example</span>
<span class="p">(</span><span class="nb">vector-push-extend</span> <span class="nv">item</span> <span class="nv">array-ref</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">array-ref</span> <span class="p">()</span>
  <span class="c1">;; This is probably the closest to what the Perl would return.</span>
  <span class="p">(</span><span class="nb">make-array</span> <span class="mi">0</span> <span class="ss">:adjustable</span> <span class="no">t</span> <span class="ss">:fill-pointer</span> <span class="mi">0</span><span class="p">))</span>

<span class="p">(</span><span class="nb">setf</span> <span class="nv">aref1</span> <span class="p">(</span><span class="nv">array-ref</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">aref2</span> <span class="p">(</span><span class="nv">array-ref</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A&quot;</span> <span class="p">(</span><span class="nb">aref</span> <span class="nv">array-ref</span> <span class="nv">n</span><span class="p">))</span>      <span class="c1">; access item in position N, works on any array</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A&quot;</span> <span class="p">(</span><span class="nb">svref</span> <span class="nv">array-ref</span> <span class="nv">n</span><span class="p">))</span> <span class="c1">; access item in position N, possibly fastest, only</span>
                                    <span class="c1">; works on type SIMPLE-VECTOR (single-dimensional arrays)</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A&quot;</span> <span class="p">(</span><span class="nb">elt</span> <span class="nv">array-ref</span> <span class="nv">n</span><span class="p">))</span>       <span class="c1">; same, works on any sequence type, but possibly slower</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">pie</span> <span class="o">#(</span><span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span> <span class="mi">9</span><span class="p">))</span>
<span class="p">(</span><span class="nb">make-array</span> <span class="mi">3</span> <span class="ss">:displaced-to</span> <span class="nv">pie</span> <span class="ss">:displaced-index-offset</span> <span class="mi">3</span><span class="p">)</span> <span class="c1">; array slice</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">subseq</span> <span class="nv">pie</span> <span class="mi">3</span> <span class="mi">6</span><span class="p">)</span> <span class="o">#(</span><span class="s">&quot;blackberry&quot;</span> <span class="s">&quot;blueberry&quot;</span> <span class="s">&quot;pumpkin&quot;</span><span class="p">))</span> <span class="c1">; note 6 instead of 5, not a typo</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">sliceref</span> <span class="p">(</span><span class="nb">make-array</span> <span class="mi">3</span> <span class="ss">:displaced-to</span> <span class="nv">pie</span> <span class="ss">:displaced-index-offset</span> <span class="mi">3</span><span class="p">))</span> <span class="c1">; not wrong</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">map</span> <span class="no">nil</span>
     <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">item</span><span class="p">)</span>
         <span class="c1">;; ITEM has data</span>
         <span class="p">)</span>
     <span class="nv">array-ref</span><span class="p">)</span>

<span class="p">(</span><span class="nb">dotimes</span> <span class="p">(</span><span class="nv">idx</span> <span class="p">(</span><span class="nb">array-dimension</span> <span class="nv">array-ref</span> <span class="mi">0</span><span class="p">))</span>
  <span class="c1">;; (svref array-ref idx) has data</span>
  <span class="p">)</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_11.2</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Note: HASH must be creaed with :TEST &#39;EQUAL</span>
<span class="p">(</span><span class="nb">push</span> <span class="s">&quot;new value&quot;</span> <span class="p">(</span><span class="nb">gethash</span> <span class="s">&quot;KEYNAME&quot;</span> <span class="nv">hash</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">loop</span>
   <span class="nv">for</span> <span class="nb">string</span> <span class="nv">being</span> <span class="k">the</span> <span class="nv">hash-keys</span> <span class="nv">of</span> <span class="nv">hash</span>
   <span class="nb">do</span> <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A: ~A~%&quot;</span> <span class="nb">string</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nb">string</span> <span class="nv">hash</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="s">&quot;a key&quot;</span> <span class="nv">hash</span><span class="p">)</span> <span class="o">#(</span><span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span><span class="p">))</span>  <span class="c1">; anonymous array</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="s">&quot;a key&quot;</span> <span class="nv">hash</span><span class="p">)</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span><span class="p">))</span>  <span class="c1">; ...or a list would work too</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nb">values</span> <span class="p">(</span><span class="nb">gethash</span> <span class="s">&quot;a key&quot;</span> <span class="nv">hash</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">push</span> <span class="nv">value</span> <span class="p">(</span><span class="nb">gethash</span> <span class="s">&quot;a key&quot;</span> <span class="nv">hash</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">residents</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nc">number</span> <span class="nv">phone2name</span><span class="p">))</span> <span class="c1">; will be NIL if not found</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; The Perl example would translate to the same thing as the previous</span>
<span class="c1">;; subsection in CL (since GETHASH returns NIL when there is no value,</span>
<span class="c1">;; and NIL is the empty list).  However, to match the &quot;sprit&quot; of the</span>
<span class="c1">;; Perl example (and return an empty array instead of an empty list),</span>
<span class="c1">;; you could do the following, which takes advantage of the fact that</span>
<span class="c1">;; GETHASH returns a second value indicating whether or not the hash</span>
<span class="c1">;; key actually has a value.</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">residents</span> <span class="p">(</span><span class="nb">multiple-value-bind</span> <span class="p">(</span><span class="nv">value</span> <span class="nv">exists</span><span class="p">)</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nc">number</span> <span class="nv">phone2name</span><span class="p">)</span>
                  <span class="p">(</span><span class="k">if</span> <span class="nv">exists</span>
                      <span class="nv">value</span>
                      <span class="o">#(</span><span class="p">))))</span>
<span class="c1">;;;-----------------------------</span>


<span class="c1">;;; @@PLEAC@@_11.3</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">href</span> <span class="nv">hash</span><span class="p">)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">anon-hash</span> <span class="p">(</span><span class="nv">mkhash</span> <span class="s">&quot;key1&quot;</span> <span class="s">&quot;value1&quot;</span> <span class="s">&quot;key2&quot;</span> <span class="s">&quot;value2&quot;</span> <span class="o">...</span><span class="p">))</span> <span class="c1">; MKHASH defined in appendix</span>

<span class="c1">;; Couldn&#39;t find anything like this in standard CL.  Someone please</span>
<span class="c1">;; correct me if I&#39;m wrong.</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">copy-hash-table</span> <span class="p">(</span><span class="nc">hash-table</span><span class="p">)</span>
  <span class="s">&quot;Make shallow copy of HASH.&quot;</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">newhash</span> <span class="p">(</span><span class="nb">make-hash-table</span> <span class="ss">:test</span> <span class="p">(</span><span class="nb">hash-table-test</span> <span class="nc">hash-table</span><span class="p">)</span>
                                  <span class="ss">:size</span> <span class="p">(</span><span class="nb">hash-table-size</span> <span class="nc">hash-table</span><span class="p">))))</span>
    <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">key</span> <span class="nv">being</span> <span class="k">the</span> <span class="nv">hash-keys</span> <span class="nv">of</span> <span class="nc">hash-table</span> <span class="nv">using</span> <span class="p">(</span><span class="nv">hash-value</span> <span class="nv">value</span><span class="p">)</span>
         <span class="nb">do</span> <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">key</span> <span class="nv">newhash</span><span class="p">)</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">key</span> <span class="nc">hash-table</span><span class="p">)))</span>
    <span class="nv">newhash</span><span class="p">))</span>

<span class="p">(</span><span class="nb">setf</span> <span class="nv">anonymous-hash-copy</span> <span class="p">(</span><span class="nv">copy-hash-table</span> <span class="nv">hash</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">hash</span> <span class="nv">href</span><span class="p">)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">value</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">key</span> <span class="nv">href</span><span class="p">))</span>

<span class="p">(</span><span class="nb">setf</span> <span class="nv">slice</span> <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">key</span> <span class="nv">in</span> <span class="p">(</span><span class="nb">list</span> <span class="nv">key1</span> <span class="nv">key2</span> <span class="nv">key3</span><span class="p">)</span>
                 <span class="nv">collect</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">key</span> <span class="nv">href</span><span class="p">)))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">keys</span> <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">key</span> <span class="nv">being</span> <span class="k">the</span> <span class="nv">hash-keys</span> <span class="nv">of</span> <span class="nv">href</span> <span class="nv">collect</span> <span class="nv">key</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">check-type</span> <span class="nv">someref</span> <span class="nc">hash-table</span><span class="p">)</span> <span class="c1">; CHECK-TYPE does a die() implicitly, if necessary</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">href</span> <span class="p">(</span><span class="nb">list</span> <span class="nv">env</span> <span class="nv">inc</span><span class="p">))</span> <span class="c1">; ENV and INC don&#39;t exist in CL, just matching the Perl</span>
  <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">key</span> <span class="nv">being</span> <span class="k">the</span> <span class="nv">hash-keys</span> <span class="nv">of</span> <span class="nv">href</span> <span class="nv">using</span> <span class="p">(</span><span class="nv">hash-value</span> <span class="nv">value</span><span class="p">)</span>
       <span class="nb">do</span> <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A =&gt; ~A~%&quot;</span> <span class="nv">key</span> <span class="nv">value</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nb">values</span> <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">key</span> <span class="nv">in</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;key1&quot;</span> <span class="s">&quot;key2&quot;</span> <span class="s">&quot;key3&quot;</span><span class="p">)</span>
                <span class="nv">collect</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">key</span> <span class="nv">hash-ref</span><span class="p">)))</span>

<span class="c1">;; The following will NOT work like the Perl example, VAL is a copy of</span>
<span class="c1">;; the hash value because numeric values are copied.</span>
<span class="p">(</span><span class="nb">dolist</span> <span class="nv">val</span> <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">key</span> <span class="nv">in</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;key1&quot;</span> <span class="s">&quot;key2&quot;</span> <span class="s">&quot;key3&quot;</span><span class="p">)</span>
               <span class="nv">collect</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">key</span> <span class="nv">hash-ref</span><span class="p">))</span>
        <span class="p">(</span><span class="nb">incf</span> <span class="nv">val</span> <span class="mi">7</span><span class="p">))</span>              <span class="c1">; does NOT modify hash table at all</span>

<span class="c1">;; You&#39;d have to do something like this instead.</span>
<span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">key</span> <span class="nv">in</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;key1&quot;</span> <span class="s">&quot;key2&quot;</span> <span class="s">&quot;key3&quot;</span><span class="p">)</span>
   <span class="nb">do</span> <span class="p">(</span><span class="nb">incf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">key</span> <span class="nv">hash-ref</span> <span class="mi">0</span><span class="p">)</span> <span class="mi">7</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_11.4</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; If you want to be able to call the function using the alias like</span>
<span class="c1">;; &quot;normal&quot; (i.e., as the first element of a form) SETF its</span>
<span class="c1">;; SYMBOL-FUNCTION:</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">symbol-function</span> <span class="ss">&#39;cref</span><span class="p">)</span> <span class="nf">#&#39;</span><span class="nv">func</span><span class="p">)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">symbol-function</span> <span class="ss">&#39;cref</span><span class="p">)</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="o">...</span><span class="p">)))</span>

<span class="c1">;; If you do the following instead, you&#39;ll have to use APPLY and/or</span>
<span class="c1">;; FUNCALL.</span>
<span class="p">(</span><span class="nb">setf</span> <span class="ss">&#39;cref2</span> <span class="nf">#&#39;</span><span class="nv">func</span><span class="p">)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="ss">&#39;cref2</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="o">...</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">returned</span> <span class="p">(</span><span class="nv">cref</span> <span class="o">...</span><span class="p">))</span>
<span class="c1">;; If you have a list of arguments (more like the Perl example):</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">returned</span> <span class="p">(</span><span class="nb">apply</span> <span class="ss">&#39;cref</span> <span class="nv">arguments</span><span class="p">))</span>
<span class="c1">;; Or you can use FUNCALL (not that you really need to in this case)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">returned</span> <span class="p">(</span><span class="nb">funcall</span> <span class="ss">&#39;cref</span> <span class="o">...</span><span class="p">))</span>

<span class="c1">;; If you didn&#39;t use SYMBOL-FUNCTION, then you can do the following:</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">returned</span> <span class="p">(</span><span class="nb">apply</span> <span class="nv">cref</span> <span class="nv">arguments</span><span class="p">))</span> <span class="c1">; note the lack of a &#39; in front of CREF</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">returned</span> <span class="p">(</span><span class="nb">funcall</span> <span class="nv">cref</span> <span class="o">...</span><span class="p">))</span>      <span class="c1">; ditto</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">thefunc</span> <span class="p">()</span>
  <span class="c1">;; ...</span>
  <span class="p">)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">funcname</span> <span class="s">&quot;THEFUNC&quot;</span><span class="p">)</span>  <span class="c1">; upper-case to pick up correct symbol name</span>
<span class="p">(</span><span class="nb">funcall</span> <span class="p">(</span><span class="nb">intern</span> <span class="nv">funcname</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; MKHASH defined in appendix</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*commands*</span>
  <span class="p">(</span><span class="nv">mkhash</span> <span class="s">&quot;happy&quot;</span> <span class="nf">#&#39;</span><span class="nv">joy</span>
          <span class="s">&quot;sad&quot;</span> <span class="nf">#&#39;</span><span class="nv">sullen</span>
          <span class="s">&quot;done&quot;</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">()</span> <span class="p">(</span><span class="nb">error</span> <span class="s">&quot;See ya!&quot;</span><span class="p">))</span>
          <span class="s">&quot;mad&quot;</span> <span class="nf">#&#39;</span><span class="nv">angry</span><span class="p">))</span>

<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;How are you?&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="nb">string</span> <span class="p">(</span><span class="nv">chomp</span> <span class="p">(</span><span class="nb">read-line</span><span class="p">)))</span> <span class="c1">; CHOMP defined in appendix</span>
       <span class="p">(</span><span class="nv">command</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nb">string</span> <span class="vg">*commands*</span><span class="p">)))</span>
  <span class="p">(</span><span class="k">if</span> <span class="nv">command</span>
      <span class="p">(</span><span class="nb">funcall</span> <span class="nv">command</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;No such command: ~A~%&quot;</span> <span class="nb">string</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">counter-maker</span> <span class="p">()</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">start</span> <span class="mi">0</span><span class="p">))</span>
    <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">()</span>
        <span class="p">(</span><span class="nb">prog1</span> <span class="nv">start</span>                       <span class="c1">; return value of START prior to increment</span>
          <span class="p">(</span><span class="nb">incf</span> <span class="nv">start</span><span class="p">)))))</span>

<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">symbol-function</span> <span class="ss">&#39;counter</span><span class="p">)</span> <span class="p">(</span><span class="nv">counter-maker</span><span class="p">))</span>

<span class="p">(</span><span class="nb">loop</span> <span class="nv">repeat</span> <span class="mi">5</span> <span class="nb">do</span> <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A~%&quot;</span> <span class="p">(</span><span class="nv">counter</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">symbol-function</span> <span class="ss">&#39;counter1</span><span class="p">)</span> <span class="p">(</span><span class="nv">counter-maker</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">symbol-function</span> <span class="ss">&#39;counter2</span><span class="p">)</span> <span class="p">(</span><span class="nv">counter-maker</span><span class="p">))</span>

<span class="p">(</span><span class="nb">loop</span> <span class="nv">repeat</span> <span class="mi">5</span> <span class="nb">do</span> <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A~%&quot;</span> <span class="p">(</span><span class="nv">counter1</span><span class="p">)))</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A ~A~%&quot;</span> <span class="p">(</span><span class="nv">counter1</span><span class="p">)</span> <span class="p">(</span><span class="nv">counter2</span><span class="p">))</span>
<span class="c1">;; 0</span>
<span class="c1">;; 1</span>
<span class="c1">;; 2</span>
<span class="c1">;; 3</span>
<span class="c1">;; 4</span>
<span class="c1">;; 5 0</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">timestamp</span> <span class="p">()</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">start-time</span> <span class="p">(</span><span class="nb">get-universal-time</span><span class="p">)))</span>
    <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">()</span>
        <span class="p">(</span><span class="nb">-</span> <span class="p">(</span><span class="nb">get-universal-time</span><span class="p">)</span> <span class="nv">start-time</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">symbol-function</span> <span class="ss">&#39;early</span><span class="p">)</span> <span class="p">(</span><span class="nv">timestamp</span><span class="p">))</span>
<span class="p">(</span><span class="nb">sleep</span> <span class="mi">20</span><span class="p">)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">symbol-function</span> <span class="ss">&#39;later</span><span class="p">)</span> <span class="p">(</span><span class="nv">timestamp</span><span class="p">))</span>
<span class="p">(</span><span class="nb">sleep</span> <span class="mi">10</span><span class="p">)</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;It&#39;s been ~D seconds since early.~%&quot;</span> <span class="p">(</span><span class="nv">early</span><span class="p">))</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;It&#39;s been ~D seconds since later.~%&quot;</span> <span class="p">(</span><span class="nv">later</span><span class="p">))</span>
<span class="c1">;; It&#39;s been 30 seconds since early.</span>
<span class="c1">;; It&#39;s been 10 seconds since later.</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_11.5</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Although you can&#39;t get a reference directly to the scalar that a</span>
<span class="c1">;; symbol points to (at least, not if it&#39;s a number or character), you</span>
<span class="c1">;; can just refer to the symbol itself, for largely the same effect.</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">scalar-ref</span> <span class="ss">&#39;scalar</span><span class="p">)</span>               <span class="c1">; get reference to symbol</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Not sure what this was trying to demonstrate.</span>
<span class="c1">;;undef $anon_scalar_ref;</span>
<span class="c1">;;$$anon_scalar_ref = 15;</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; There&#39;s no way to do this in CL that I know of.</span>
<span class="c1">;;$anon_scalar_ref = \15;</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A&quot;</span> <span class="p">(</span><span class="nb">symbol-value</span> <span class="nv">scalar-ref</span><span class="p">))</span> <span class="c1">; dereference it</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">symbol-value</span> <span class="nv">scalar-ref</span><span class="p">)</span> <span class="p">(</span><span class="nb">concatenate</span> <span class="ss">&#39;string</span> <span class="p">(</span><span class="nb">symbol-value</span> <span class="nv">scalar-ref</span><span class="p">)</span> <span class="s">&quot;string&quot;</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; This is a BAD idea in CL.  Symbols are relatively expensive, there</span>
<span class="c1">;; is no guarantee that name collisions won&#39;t happen, possible memory</span>
<span class="c1">;; leak issues, etc.</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">symbol-number</span> <span class="mi">-1</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">defun</span> <span class="nv">new-anon-symbol</span> <span class="p">()</span>
    <span class="p">(</span><span class="nb">intern</span> <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;_NEWANONSYM~D&quot;</span> <span class="p">(</span><span class="nb">incf</span> <span class="nv">symbol-number</span><span class="p">)))))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">sref</span> <span class="p">(</span><span class="nv">new-anon-symbol</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">symbol-value</span> <span class="nv">sref</span><span class="p">)</span> <span class="mi">3</span><span class="p">)</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;Three = ~A~%&quot;</span> <span class="p">(</span><span class="nb">symbol-value</span> <span class="nv">sref</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">my-array</span> <span class="p">(</span><span class="nb">vector</span> <span class="p">(</span><span class="nv">new-anon-symbol</span><span class="p">)</span> <span class="p">(</span><span class="nv">new-anon-symbol</span><span class="p">)))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">symbol-value</span> <span class="p">(</span><span class="nb">svref</span> <span class="nv">my-array</span> <span class="mi">0</span><span class="p">))</span> <span class="mf">6.02e23</span>
      <span class="p">(</span><span class="nb">symbol-value</span> <span class="p">(</span><span class="nb">svref</span> <span class="nv">my-array</span> <span class="mi">1</span><span class="p">))</span> <span class="s">&quot;avocado&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;ARRAY contains: ~{~A~^, ~}~%&quot;</span> <span class="p">(</span><span class="nb">map</span> <span class="ss">&#39;list</span> <span class="ss">&#39;symbol-value</span> <span class="nc">array</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">var</span> <span class="p">(</span><span class="nb">with-output-to-string</span> <span class="p">(</span><span class="nv">output</span><span class="p">)</span>
            <span class="p">(</span><span class="nv">sb-ext:run-program</span> <span class="s">&quot;uptime&quot;</span> <span class="no">nil</span> <span class="ss">:search</span> <span class="no">t</span> <span class="ss">:output</span> <span class="nv">output</span><span class="p">)))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">vref</span> <span class="ss">&#39;var</span><span class="p">)</span>
<span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nv">scan</span> <span class="s">&quot;load&quot;</span> <span class="p">(</span><span class="nb">symbol-value</span> <span class="nv">vref</span><span class="p">)))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">symbol-value</span> <span class="nv">vref</span><span class="p">)</span> <span class="p">(</span><span class="nv">chomp</span> <span class="p">(</span><span class="nb">symbol-value</span> <span class="nv">vref</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; check whether SOMEREF contains a reference to a symbol, which we&#39;re</span>
<span class="c1">;; using instead of Perl&#39;s scalar references.</span>
<span class="p">(</span><span class="nb">check-type</span> <span class="nv">someref</span> <span class="ss">&#39;symbol</span><span class="p">)</span>            <span class="c1">; does the die() for us</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_11.6</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">array-of-scalar-refs</span> <span class="p">(</span><span class="nb">vector</span> <span class="ss">&#39;a</span> <span class="ss">&#39;b</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Note that because #() quotes its contents, A and B refer to the</span>
<span class="c1">;; symbols A and B, not their values, which is the closest</span>
<span class="c1">;; approximation to what the Perl is doing.</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">array-of-scalar-refs</span> <span class="o">#(</span><span class="nv">a</span> <span class="nv">b</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">symbol-value</span> <span class="p">(</span><span class="nb">aref</span> <span class="nv">array-of-scalar-refs</span> <span class="mi">1</span><span class="p">))</span> <span class="mi">12</span><span class="p">)</span> <span class="c1">; B = 12</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">setq</span> <span class="nv">a</span> <span class="mi">1</span> <span class="nv">b</span> <span class="mi">2</span> <span class="nv">c</span> <span class="mi">3</span> <span class="nv">d</span> <span class="mi">4</span><span class="p">)</span>                  <span class="c1">; initialize</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">my-array</span> <span class="p">(</span><span class="nb">vector</span> <span class="ss">&#39;a</span> <span class="ss">&#39;b</span> <span class="ss">&#39;c</span> <span class="ss">&#39;d</span><span class="p">))</span>    <span class="c1">; refs to each symbol</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">my-array</span> <span class="o">#(</span><span class="nv">a</span> <span class="nv">b</span> <span class="nv">c</span> <span class="nv">d</span><span class="p">))</span>              <span class="c1">; same thing!</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">my-array</span> <span class="p">(</span><span class="nb">loop</span> <span class="nv">repeat</span> <span class="mi">4</span> <span class="nv">collect</span> <span class="p">(</span><span class="nv">new-anon-symbol</span><span class="p">)))</span> <span class="c1">; allocate 4 anon symbols</span>

<span class="p">(</span><span class="nb">incf</span> <span class="p">(</span><span class="nb">symbol-value</span> <span class="p">(</span><span class="nb">aref</span> <span class="nv">my-array</span> <span class="mi">2</span><span class="p">))</span> <span class="mi">9</span><span class="p">)</span> <span class="c1">; C now 12</span>

<span class="p">(</span><span class="k">symbol-macrolet</span> <span class="p">((</span><span class="nv">element</span> <span class="p">(</span><span class="nb">symbol-value</span> <span class="p">(</span><span class="nb">aref</span> <span class="nv">my-array</span> <span class="p">(</span><span class="nb">1-</span> <span class="p">(</span><span class="nb">length</span> <span class="nv">my-array</span><span class="p">))))))</span>
  <span class="p">(</span><span class="nb">setf</span> <span class="nv">element</span> <span class="p">(</span><span class="nb">*</span> <span class="nv">element</span> <span class="mi">5</span><span class="p">))</span>          <span class="c1">; D now 20</span>
  <span class="p">(</span><span class="nb">setf</span> <span class="nv">element</span> <span class="p">(</span><span class="nb">*</span> <span class="nv">element</span> <span class="mi">5</span><span class="p">)))</span>         <span class="c1">; D now 100</span>

<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">tmp</span> <span class="p">(</span><span class="nb">aref</span> <span class="nv">my-array</span> <span class="p">(</span><span class="nb">1-</span> <span class="p">(</span><span class="nb">length</span> <span class="nv">my-array</span><span class="p">)))))</span>   <span class="c1">; using temporary</span>
  <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">symbol-value</span> <span class="nv">tmp</span><span class="p">)</span> <span class="p">(</span><span class="nb">*</span> <span class="mi">5</span> <span class="p">(</span><span class="nb">symbol-value</span> <span class="nv">tmp</span><span class="p">))))</span> <span class="c1">; D now 500</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Note that PI is built in to CL.</span>
<span class="p">(</span><span class="nb">map</span> <span class="ss">&#39;nil</span>
     <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">sref</span><span class="p">)</span>
         <span class="s">&quot;Replace with spherical volumes.&quot;</span>
         <span class="p">(</span><span class="k">symbol-macrolet</span> <span class="p">((</span><span class="nv">element</span> <span class="p">(</span><span class="nb">symbol-value</span> <span class="nv">sref</span><span class="p">)))</span>
           <span class="p">(</span><span class="nb">setf</span> <span class="nv">element</span> <span class="p">(</span><span class="nb">*</span> <span class="p">(</span><span class="nb">expt</span> <span class="nv">element</span> <span class="mi">3</span><span class="p">)</span>
                            <span class="p">(</span><span class="nb">*</span> <span class="m">4/3</span> <span class="nv">pi</span><span class="p">)))))</span>
     <span class="nv">my-array</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_11.7</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">c1</span> <span class="p">(</span><span class="nv">mkcounter</span> <span class="mi">20</span><span class="p">)</span>
      <span class="nv">c2</span> <span class="p">(</span><span class="nv">mkcounter</span> <span class="mi">77</span><span class="p">))</span>

<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;next c1: ~d~%&quot;</span> <span class="p">(</span><span class="nb">funcall</span> <span class="p">(</span><span class="nb">gethash</span> <span class="s">&quot;NEXT&quot;</span> <span class="nv">c1</span><span class="p">)))</span> <span class="c1">; 21</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;next c2: ~d~%&quot;</span> <span class="p">(</span><span class="nb">funcall</span> <span class="p">(</span><span class="nb">gethash</span> <span class="s">&quot;NEXT&quot;</span> <span class="nv">c2</span><span class="p">)))</span> <span class="c1">; 78</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;next c1: ~d~%&quot;</span> <span class="p">(</span><span class="nb">funcall</span> <span class="p">(</span><span class="nb">gethash</span> <span class="s">&quot;NEXT&quot;</span> <span class="nv">c1</span><span class="p">)))</span> <span class="c1">; 22</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;last c1: ~d~%&quot;</span> <span class="p">(</span><span class="nb">funcall</span> <span class="p">(</span><span class="nb">gethash</span> <span class="s">&quot;PREV&quot;</span> <span class="nv">c1</span><span class="p">)))</span> <span class="c1">; 21</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;old  c2: ~d~%&quot;</span> <span class="p">(</span><span class="nb">funcall</span> <span class="p">(</span><span class="nb">gethash</span> <span class="s">&quot;RESET&quot;</span> <span class="nv">c2</span><span class="p">)))</span> <span class="c1">; 77</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">mkcounter</span> <span class="p">(</span><span class="nv">start</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="nb">count</span> <span class="nv">start</span><span class="p">)</span>
         <span class="p">(</span><span class="nv">bundle</span>
          <span class="c1">;; MKHASH defined in appendix</span>
          <span class="p">(</span><span class="nv">mkhash</span>
           <span class="s">&quot;NEXT&quot;</span>   <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">()</span> <span class="p">(</span><span class="nb">incf</span> <span class="nb">count</span><span class="p">))</span>
           <span class="s">&quot;PREV&quot;</span>   <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">()</span> <span class="p">(</span><span class="nb">decf</span> <span class="nb">count</span><span class="p">))</span>
           <span class="s">&quot;GET&quot;</span>    <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">()</span> <span class="nb">count</span><span class="p">)</span>
           <span class="s">&quot;SET&quot;</span>    <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">new-count</span><span class="p">)</span> <span class="p">(</span><span class="nb">setf</span> <span class="nb">count</span> <span class="nv">new-count</span><span class="p">))</span>
           <span class="s">&quot;BUMP&quot;</span>   <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">delta</span><span class="p">)</span> <span class="p">(</span><span class="nb">incf</span> <span class="nb">count</span> <span class="nv">delta</span><span class="p">))</span>
           <span class="s">&quot;RESET&quot;</span>  <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">()</span> <span class="p">(</span><span class="nb">setf</span> <span class="nb">count</span> <span class="nv">start</span><span class="p">)))))</span>
    <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="s">&quot;LAST&quot;</span> <span class="nv">bundle</span><span class="p">)</span> <span class="p">(</span><span class="nb">gethash</span> <span class="s">&quot;PREV&quot;</span> <span class="nv">bundle</span><span class="p">))</span>
    <span class="nv">bundle</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_11.8</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Methods in CL are generic functions that can be specialized on any</span>
<span class="c1">;; of their arguments.  The technique that the Perl code is using to</span>
<span class="c1">;; allow calling meth() without the $obj-&gt; is needless in CL.  You can</span>
<span class="c1">;; make a reference to a method, the same way you might make a</span>
<span class="c1">;; referece a normal function.  There&#39;s not much point in doing this,</span>
<span class="c1">;; normally.</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">symbol-function</span> <span class="ss">&#39;mref</span><span class="p">)</span> <span class="nf">#&#39;</span><span class="nv">meth</span><span class="p">)</span>
<span class="c1">;; later...</span>
<span class="p">(</span><span class="nv">mref</span> <span class="s">&quot;args&quot;</span> <span class="s">&quot;go&quot;</span> <span class="s">&quot;here&quot;</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">symbol-funtion</span> <span class="ss">&#39;sref</span><span class="p">)</span> <span class="nf">#&#39;</span><span class="nv">meth</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_11.9</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; MKHASH defined in appendix</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">record</span> <span class="p">(</span><span class="nv">mkhash</span>
              <span class="ss">:name</span>    <span class="s">&quot;Jason&quot;</span>
              <span class="ss">:empno</span>   <span class="mi">132</span>
              <span class="ss">:title</span>   <span class="s">&quot;deputy peon&quot;</span>
              <span class="ss">:age</span>     <span class="mi">23</span>
              <span class="ss">:salary</span>  <span class="mi">37000</span>
              <span class="ss">:pals</span>    <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;Norbert&quot;</span> <span class="s">&quot;Rhys&quot;</span> <span class="s">&quot;Phineas&quot;</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;I am ~A, and my pals are ~{~A~^, ~}~%&quot;</span>
        <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:name</span> <span class="nv">record</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:pals</span> <span class="nv">record</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*byname*</span> <span class="p">(</span><span class="nb">make-hash-table</span> <span class="ss">:test</span> <span class="ss">&#39;equal</span><span class="p">))</span>
<span class="c1">;; store record</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:name</span> <span class="nv">record</span><span class="p">)</span> <span class="vg">*byname*</span><span class="p">)</span> <span class="nv">record</span><span class="p">)</span>

<span class="c1">;; later on, look up by name</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">rp</span> <span class="p">(</span><span class="nb">gethash</span> <span class="s">&quot;Aron&quot;</span> <span class="vg">*byname*</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">when</span> <span class="nv">rp</span>
    <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;Aron is employee number ~D~%&quot;</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:empno</span> <span class="nv">rp</span><span class="p">))))</span>

<span class="c1">;; give jason a new pal</span>
<span class="p">(</span><span class="nb">push</span> <span class="s">&quot;Theodore&quot;</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:pals</span> <span class="p">(</span><span class="nb">gethash</span> <span class="s">&quot;Jason&quot;</span> <span class="vg">*byname*</span><span class="p">)))</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;Jason now has ~D pals~%&quot;</span> <span class="p">(</span><span class="nb">length</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:pals</span> <span class="p">(</span><span class="nb">gethash</span> <span class="s">&quot;Jason&quot;</span> <span class="vg">*byname*</span><span class="p">))))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Go through all records</span>
<span class="p">(</span><span class="nb">maphash</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">name</span> <span class="nv">record</span><span class="p">)</span>
             <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A is employee number ~D~%&quot;</span> <span class="nv">name</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:empno</span> <span class="nv">record</span><span class="p">)))</span>
         <span class="vg">*byname*</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; store record</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*employees*</span> <span class="p">(</span><span class="nb">make-array</span> <span class="mi">0</span> <span class="ss">:adjustable</span> <span class="no">t</span><span class="p">))</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">empno</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:empno</span> <span class="nv">record</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nb">array-in-bounds-p</span> <span class="vg">*employees*</span> <span class="nv">empno</span><span class="p">)</span>
    <span class="c1">;; :INITIAL-ELEMENT used to prevent array from being extended with 0&#39;s</span>
    <span class="p">(</span><span class="nb">adjust-array</span> <span class="vg">*employees*</span> <span class="p">(</span><span class="nb">1+</span> <span class="nv">empno</span><span class="p">)</span> <span class="ss">:initial-element</span> <span class="no">nil</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">aref</span> <span class="vg">*employees*</span> <span class="nv">empno</span><span class="p">)</span> <span class="nv">record</span><span class="p">))</span>

<span class="c1">;; lookup by id</span>
<span class="p">(</span><span class="nv">when-let</span> <span class="p">(</span><span class="nv">rp</span> <span class="p">(</span><span class="nb">aref</span> <span class="vg">*employees*</span> <span class="mi">132</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;employee 132 is ~A~%&quot;</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:name</span> <span class="nv">rp</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; The use of SYMBOL-MACROLET saves us from repeating a complicated</span>
<span class="c1">;; expression multiple times.  Could also define a macro to make this</span>
<span class="c1">;; easier.</span>
<span class="p">(</span><span class="k">symbol-macrolet</span> <span class="p">((</span><span class="nv">salary</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:salary</span> <span class="p">(</span><span class="nb">gethash</span> <span class="s">&quot;Jason&quot;</span> <span class="vg">*byname*</span><span class="p">))))</span>
  <span class="p">(</span><span class="nb">setf</span> <span class="nv">salary</span> <span class="p">(</span><span class="nb">*</span> <span class="nv">salary</span> <span class="mf">1.035</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">peons</span> <span class="p">(</span><span class="nb">remove-if-not</span>
             <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">employee</span><span class="p">)</span>
                 <span class="p">(</span><span class="nb">and</span> <span class="nv">employee</span>
                      <span class="p">(</span><span class="nv">scan</span> <span class="p">(</span><span class="nv">create-scanner</span> <span class="s">&quot;peon&quot;</span> <span class="ss">:case-insensitive-mode</span> <span class="no">t</span><span class="p">)</span>
                                     <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:title</span> <span class="nv">employee</span><span class="p">))))</span>
             <span class="vg">*employees*</span><span class="p">))</span>
<span class="c1">;; Or:</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">peons</span> <span class="p">(</span><span class="nv">perl-grep</span> <span class="vg">*employees*</span>
              <span class="p">(</span><span class="nb">and</span> <span class="nv">it</span>
                   <span class="p">(</span><span class="nv">scan</span> <span class="p">(</span><span class="nv">create-scanner</span> <span class="s">&quot;peon&quot;</span> <span class="ss">:case-insensitive-mode</span> <span class="no">t</span><span class="p">)</span>
                                  <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:title</span> <span class="nv">it</span><span class="p">)))))</span>

<span class="p">(</span><span class="nb">setf</span> <span class="nv">tsevens</span> <span class="p">(</span><span class="nb">remove-if-not</span>
               <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">employee</span><span class="p">)</span>
                   <span class="p">(</span><span class="nb">and</span> <span class="nv">employee</span>
                        <span class="p">(</span><span class="nb">=</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:age</span> <span class="nv">employee</span><span class="p">)</span>
                           <span class="mi">27</span><span class="p">)))</span>
               <span class="vg">*employees*</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">hash-slice</span> <span class="p">(</span><span class="nv">hash</span> <span class="k">&amp;rest</span> <span class="nv">keys</span><span class="p">)</span>
  <span class="s">&quot;Meant to emulate Perl&#39;s built-in hash slicing feature.&quot;</span>
  <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">key</span> <span class="nv">in</span> <span class="nv">keys</span> <span class="nv">collect</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">key</span> <span class="nv">hash</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">rp</span> <span class="p">(</span><span class="nb">sort</span> <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">v</span> <span class="nv">being</span> <span class="k">the</span> <span class="nv">hash-values</span> <span class="nv">of</span> <span class="vg">*byname*</span> <span class="nv">collect</span> <span class="nv">v</span><span class="p">)</span>
                 <span class="ss">&#39;string-lessp</span>
                 <span class="ss">:key</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">hash</span><span class="p">)</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:age</span> <span class="nv">hash</span><span class="p">))))</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A is employee number ~D.~%&quot;</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:name</span> <span class="nv">rp</span><span class="p">)</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:age</span> <span class="nv">rp</span><span class="p">))</span>
  <span class="c1">;; or with a hash slice on the reference (note that we&#39;re using the</span>
  <span class="c1">;; non-standard HASH-SLICE function defined above, whereas Perl</span>
  <span class="c1">;; has a built-in to do it).</span>
  <span class="p">(</span><span class="nb">apply</span> <span class="ss">&#39;format</span> <span class="no">t</span> <span class="s">&quot;~A is employee number ~D.~%&quot;</span> <span class="p">(</span><span class="nv">hash-slice</span> <span class="nv">rp</span> <span class="ss">:name</span> <span class="ss">:age</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; use BYAGE, an array of lists of records</span>
<span class="p">(</span><span class="nb">push</span> <span class="nv">record</span> <span class="p">(</span><span class="nb">aref</span> <span class="vg">*byage*</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:age</span> <span class="nv">record</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">dotimes</span> <span class="p">(</span><span class="nv">age</span> <span class="p">(</span><span class="nb">length</span> <span class="vg">*byage*</span><span class="p">))</span>
  <span class="p">(</span><span class="nv">when-let</span> <span class="p">(</span><span class="nv">records</span> <span class="p">(</span><span class="nb">aref</span> <span class="vg">*byage*</span> <span class="nv">age</span><span class="p">))</span>
    <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;Age ~D: &quot;</span> <span class="nv">age</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">rp</span> <span class="nv">records</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A &quot;</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:name</span> <span class="nv">rp</span><span class="p">)))</span>
    <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~%&quot;</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">dotimes</span> <span class="p">(</span><span class="nv">age</span> <span class="p">(</span><span class="nb">length</span> <span class="vg">*byage*</span><span class="p">))</span>
  <span class="p">(</span><span class="nv">when-let</span> <span class="p">(</span><span class="nv">records</span> <span class="p">(</span><span class="nb">aref</span> <span class="vg">*byage*</span> <span class="nv">age</span><span class="p">))</span>
    <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;Age ~D: ~{~A~^, ~}~%&quot;</span> <span class="nv">age</span> <span class="p">(</span><span class="nb">map</span> <span class="ss">&#39;list</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">employee</span><span class="p">)</span>
                                                        <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:name</span> <span class="nv">employee</span><span class="p">))</span>
                                              <span class="p">(</span><span class="nb">aref</span> <span class="vg">*byage*</span> <span class="nv">age</span><span class="p">)))))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_11.10</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; FieldName: Value</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Using list instead of array since random access not required.</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*list-of-records*</span> <span class="no">nil</span><span class="p">)</span>

<span class="p">(</span><span class="nb">map</span> <span class="no">nil</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">record</span><span class="p">)</span>
             <span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">key</span> <span class="p">(</span><span class="nb">sort</span> <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">k</span> <span class="nv">being</span> <span class="k">the</span> <span class="nv">hash-keys</span> <span class="nv">of</span> <span class="nv">record</span> <span class="nv">collect</span> <span class="nv">k</span><span class="p">)</span>
                                <span class="ss">&#39;string-lessp</span> <span class="ss">:key</span> <span class="ss">&#39;symbol-name</span><span class="p">))</span>
               <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A: ~A~%&quot;</span> <span class="nv">key</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">key</span> <span class="nv">record</span><span class="p">)))</span>
             <span class="p">(</span><span class="nb">terpri</span><span class="p">))</span>                  <span class="c1">; same as (format t &quot;~%&quot;)</span>
     <span class="vg">*list-of-records*</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; GET-PARAGRAPH defined above</span>
<span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">filename</span> <span class="nv">filenames</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">with-open-file</span> <span class="p">(</span><span class="nv">file</span> <span class="nv">filename</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">loop</span>
       <span class="nv">for</span> <span class="nv">paragraph</span> <span class="nb">=</span> <span class="p">(</span><span class="nv">get-paragraph</span> <span class="nv">file</span><span class="p">)</span>
       <span class="nv">until</span> <span class="p">(</span><span class="nb">string-equal</span> <span class="nv">paragraph</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
       <span class="nb">do</span>
       <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">fields</span>
              <span class="p">(</span><span class="nv">split</span> <span class="p">(</span><span class="nv">create-scanner</span> <span class="s">&quot;^([^:]+):\\s*&quot;</span> <span class="ss">:multi-line-mode</span> <span class="no">t</span><span class="p">)</span>
                              <span class="nv">paragraph</span> <span class="ss">:with-registers-p</span> <span class="no">t</span><span class="p">)))</span>
         <span class="p">(</span><span class="nb">push</span> <span class="p">(</span><span class="nb">apply</span> <span class="ss">&#39;mkhash</span> <span class="p">(</span><span class="nb">cdr</span> <span class="nv">fields</span><span class="p">))</span> <span class="vg">*list-of-records*</span><span class="p">)))))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_11.15</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; Binary trees example</span>
<span class="p">(</span><span class="nb">deftype</span> <span class="nv">tree</span> <span class="p">()</span> <span class="o">&#39;</span><span class="p">(</span><span class="nb">or</span> <span class="nb">null</span> <span class="nv">tree-node</span><span class="p">))</span>
<span class="p">(</span><span class="nb">defstruct</span> <span class="p">(</span><span class="nv">tree-node</span>
             <span class="p">(</span><span class="ss">:conc-name</span> <span class="ss">#:tree-</span><span class="p">))</span>
  <span class="nv">value</span>
  <span class="c1">;; subtrees</span>
  <span class="p">(</span><span class="nv">left</span> <span class="no">nil</span> <span class="ss">:type</span> <span class="nv">tree</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">right</span> <span class="no">nil</span> <span class="ss">:type</span> <span class="nv">tree</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">tree-insert</span> <span class="p">(</span><span class="nv">tree</span> <span class="nv">value</span><span class="p">)</span>
  <span class="s">&quot;Return TREE with destructively inserted VALUE.&quot;</span>
  <span class="p">(</span><span class="k">declare</span> <span class="p">(</span><span class="k">type</span> <span class="nv">tree</span> <span class="nv">tree</span><span class="p">))</span>
  <span class="p">(</span><span class="k">if</span> <span class="nv">tree</span>
      <span class="p">(</span><span class="k">progn</span> <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">&lt;</span> <span class="nv">value</span> <span class="p">(</span><span class="nv">tree-value</span> <span class="nv">tree</span><span class="p">))</span>
                 <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">tree-left</span> <span class="nv">tree</span><span class="p">)</span>
                       <span class="p">(</span><span class="nv">tree-insert</span> <span class="p">(</span><span class="nv">tree-left</span> <span class="nv">tree</span><span class="p">)</span> <span class="nv">value</span><span class="p">))</span>
                 <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">tree-right</span> <span class="nv">tree</span><span class="p">)</span>
                       <span class="p">(</span><span class="nv">tree-insert</span> <span class="p">(</span><span class="nv">tree-right</span> <span class="nv">tree</span><span class="p">)</span> <span class="nv">value</span><span class="p">)))</span>
             <span class="nv">tree</span><span class="p">)</span>
      <span class="p">(</span><span class="nv">make-tree-node</span> <span class="ss">:value</span> <span class="nv">value</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">print-tree-in-order</span> <span class="p">(</span><span class="nv">tree</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">when</span> <span class="nv">tree</span>
    <span class="p">(</span><span class="nv">print-tree-in-order</span> <span class="p">(</span><span class="nv">tree-left</span> <span class="nv">tree</span><span class="p">))</span>
    <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~S &quot;</span> <span class="p">(</span><span class="nv">tree-value</span> <span class="nv">tree</span><span class="p">))</span>
    <span class="p">(</span><span class="nv">print-tree-in-order</span> <span class="p">(</span><span class="nv">tree-right</span> <span class="nv">tree</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">print-tree-in-preorder</span> <span class="p">(</span><span class="nv">tree</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">when</span> <span class="nv">tree</span>
    <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~S &quot;</span> <span class="p">(</span><span class="nv">tree-value</span> <span class="nv">tree</span><span class="p">))</span>
    <span class="p">(</span><span class="nv">print-tree-in-preorder</span> <span class="p">(</span><span class="nv">tree-left</span> <span class="nv">tree</span><span class="p">))</span>
    <span class="p">(</span><span class="nv">print-tree-in-preorder</span> <span class="p">(</span><span class="nv">tree-right</span> <span class="nv">tree</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">print-tree-in-postorder</span> <span class="p">(</span><span class="nv">tree</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">when</span> <span class="nv">tree</span>
    <span class="p">(</span><span class="nv">print-tree-in-postorder</span> <span class="p">(</span><span class="nv">tree-left</span> <span class="nv">tree</span><span class="p">))</span>
    <span class="p">(</span><span class="nv">print-tree-in-postorder</span> <span class="p">(</span><span class="nv">tree-right</span> <span class="nv">tree</span><span class="p">))</span>
    <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~S &quot;</span> <span class="p">(</span><span class="nv">tree-value</span> <span class="nv">tree</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">search-tree</span> <span class="p">(</span><span class="nv">tree</span> <span class="nv">value</span><span class="p">)</span>
  <span class="s">&quot;Return a subtree of TREE with the specified VALUE in root.&quot;</span>
  <span class="p">(</span><span class="nb">when</span> <span class="nv">tree</span>
    <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">=</span> <span class="p">(</span><span class="nv">tree-value</span> <span class="nv">tree</span><span class="p">)</span> <span class="nv">value</span><span class="p">)</span>
        <span class="nv">tree</span>
        <span class="p">(</span><span class="nv">search-tree</span> <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">&lt;</span> <span class="nv">value</span> <span class="p">(</span><span class="nv">tree-value</span> <span class="nv">tree</span><span class="p">))</span>
                         <span class="p">(</span><span class="nv">tree-left</span> <span class="nv">tree</span><span class="p">)</span>
                         <span class="p">(</span><span class="nv">tree-right</span> <span class="nv">tree</span><span class="p">))</span>
                     <span class="nv">value</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">test-trees</span> <span class="p">()</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">tree</span> <span class="no">nil</span><span class="p">))</span>
    <span class="p">(</span><span class="nb">dotimes</span> <span class="p">(</span><span class="nv">i</span> <span class="mi">20</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">setf</span> <span class="nv">tree</span> <span class="p">(</span><span class="nv">tree-insert</span> <span class="nv">tree</span> <span class="p">(</span><span class="nb">random</span> <span class="mi">1000</span><span class="p">))))</span>
    <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~&amp;Pre order: &quot;</span><span class="p">)</span> <span class="p">(</span><span class="nv">print-tree-in-preorder</span> <span class="nv">tree</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~&amp;In order:  &quot;</span><span class="p">)</span> <span class="p">(</span><span class="nv">print-tree-in-order</span> <span class="nv">tree</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~&amp;Postorder: &quot;</span><span class="p">)</span> <span class="p">(</span><span class="nv">print-tree-in-postorder</span> <span class="nv">tree</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">terpri</span><span class="p">)</span>

    <span class="p">(</span><span class="nb">loop</span> <span class="nb">do</span>
         <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~&amp;Search? &quot;</span><span class="p">)</span>
         <span class="p">(</span><span class="nb">finish-output</span><span class="p">)</span>
         <span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="nv">eof</span> <span class="p">(</span><span class="nb">gensym</span><span class="p">))</span> <span class="c1">; some hard-to-enter object</span>
                <span class="p">(</span><span class="nv">value</span> <span class="p">(</span><span class="nb">read</span> <span class="vg">*standard-input*</span> <span class="no">nil</span> <span class="nv">eof</span><span class="p">)))</span>
           <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">eq</span> <span class="nv">value</span> <span class="nv">eof</span><span class="p">)</span> <span class="p">(</span><span class="nb">loop-finish</span><span class="p">))</span>
           <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">found</span> <span class="p">(</span><span class="nv">search-tree</span> <span class="nv">tree</span> <span class="nv">value</span><span class="p">)))</span>
             <span class="p">(</span><span class="k">if</span> <span class="nv">found</span>
                 <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;Found ~S at ~S~%&quot;</span> <span class="nv">value</span> <span class="nv">found</span><span class="p">)</span>
                 <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;No ~S in tree~%&quot;</span> <span class="nv">value</span><span class="p">)))))))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_12.0</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defpackage</span> <span class="ss">:alpha</span> <span class="p">(</span><span class="ss">:use</span> <span class="ss">:cl</span><span class="p">))</span>
<span class="p">(</span><span class="nb">in-package</span> <span class="ss">:alpha</span><span class="p">)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">name</span> <span class="s">&quot;first&quot;</span><span class="p">)</span>

<span class="p">(</span><span class="nb">defpackage</span> <span class="ss">:omega</span> <span class="p">(</span><span class="ss">:use</span> <span class="ss">:cl</span><span class="p">))</span>
<span class="p">(</span><span class="nb">in-package</span> <span class="ss">:omega</span><span class="p">)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">name</span> <span class="s">&quot;last&quot;</span><span class="p">)</span>

<span class="p">(</span><span class="nb">in-package</span> <span class="ss">:cl-user</span><span class="p">)</span> <span class="c1">; default package, kinda like Perl&#39;s &#39;main&#39; package</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;Alpha is ~A, omega is ~A.~%&quot;</span> <span class="nv">alpha::name</span> <span class="nv">omega::name</span><span class="p">)</span>
<span class="c1">;; Alpha is first, omega is last.</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">load</span> <span class="s">&quot;FileHandle.lisp&quot;</span><span class="p">)</span>                <span class="c1">; run-time load</span>
<span class="p">(</span><span class="nb">load</span> <span class="s">&quot;FileHandle.fasl&quot;</span><span class="p">)</span>        <span class="c1">; explicitly load pre-compiled version</span>
<span class="p">(</span><span class="nb">load</span> <span class="s">&quot;FileHandle&quot;</span><span class="p">)</span>          <span class="c1">; same as previous two, will prefer .fasl</span>
<span class="p">(</span><span class="nb">require</span> <span class="ss">:FileHandle</span><span class="p">)</span>                   <span class="c1">; similar, still run-time</span>

<span class="c1">;; Could use LOAD here instead of REQUIRE; it&#39;s the EVAL-WHEN that</span>
<span class="c1">;; makes this compile-time.  Note that it&#39;s fairly unusual to do this</span>
<span class="c1">;; explicitly with EVAL-WHEN.  Instead, one normally ensures that the</span>
<span class="c1">;; requisite packages have already been loaded before attempting to</span>
<span class="c1">;; compile a file, e.g., using a build system such as ASDF.</span>
<span class="p">(</span><span class="k">eval-when</span> <span class="p">(</span><span class="ss">:compile-toplevel</span> <span class="ss">:load-toplevel</span> <span class="ss">:execute</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">require</span> <span class="ss">:FileHandle</span><span class="p">))</span>                <span class="c1">; compile-time</span>

<span class="c1">;; The Cards::Poker example is no different than the above in CL.  CL</span>
<span class="c1">;; has no in-built hierarchicalp package system, hence no translation</span>
<span class="c1">;; of &quot;::&quot; into a directory separator, etc.</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defpackage</span> <span class="ss">:cards.poker</span>
  <span class="p">(</span><span class="ss">:use</span> <span class="ss">:cl</span><span class="p">)</span>                            <span class="c1">; equivalent to Perl line 2</span>
  <span class="p">(</span><span class="ss">:export</span> <span class="ss">:shuffle</span> <span class="ss">:*card-deck*</span><span class="p">))</span>      <span class="c1">; line 4</span>
<span class="p">(</span><span class="nb">in-package</span> <span class="ss">:cards.poker</span><span class="p">)</span>               <span class="c1">; line 1</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*card-deck*</span> <span class="no">nil</span><span class="p">)</span>          <span class="c1">; line 5</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">shuffle</span> <span class="p">())</span>                      <span class="c1">; line 6</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_12.1</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defpackage</span> <span class="ss">:your-module</span> <span class="p">(</span><span class="ss">:use</span> <span class="ss">:cl</span><span class="p">)</span>
            <span class="p">(</span><span class="ss">:export</span> <span class="o">...</span><span class="p">))</span>              <span class="c1">; one way to export</span>
<span class="p">(</span><span class="nb">in-package</span> <span class="ss">:your-module</span><span class="p">)</span>

<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*version*</span> <span class="mf">1.00</span><span class="p">)</span> <span class="c1">; not standard CL, but one could ascribe meaning by convention</span>

<span class="p">(</span><span class="nb">export</span> <span class="o">&#39;</span><span class="p">(</span><span class="o">...</span><span class="p">))</span>                         <span class="c1">; another way to export</span>

<span class="c1">;; There is no built-in equivalent to EXPORT_OK.  EXPORT_TAGS also has</span>
<span class="c1">;; no standard CL counterpart, but something similar can easily be</span>
<span class="c1">;; implemented.  See IMPORT-TAGS, defined in the appendix.</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*export-tags*</span>
  <span class="o">&#39;</span><span class="p">(</span><span class="ss">:TAG1</span> <span class="p">(</span> <span class="o">...</span> <span class="p">)</span>
    <span class="ss">:TAG2</span> <span class="p">(</span> <span class="o">...</span> <span class="p">)))</span>

<span class="c1">;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="c1">;; your code goes here</span>
<span class="c1">;;;;;;;;;;;;;;;;;;;;;;;;</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defpackage</span> <span class="ss">:my-package</span> <span class="p">(</span><span class="ss">:use</span> <span class="nv">cl</span><span class="p">)</span>
            <span class="p">(</span><span class="ss">:use</span> <span class="ss">:your-module</span><span class="p">))</span> <span class="c1">; Import default symbols into my package.</span>
<span class="p">(</span><span class="nb">defpackage</span> <span class="ss">:my-package</span> <span class="p">(</span><span class="ss">:use</span> <span class="nv">cl</span><span class="p">)</span>
            <span class="p">(</span><span class="ss">:import-from</span> <span class="ss">:your-module</span> <span class="o">...</span><span class="p">))</span> <span class="c1">; Import listed symbols into my package.</span>
<span class="c1">;; Or at some point in my-package do this:</span>
<span class="p">(</span><span class="nb">in-package</span> <span class="ss">:my-package</span><span class="p">)</span>
<span class="p">(</span><span class="nb">import</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">your-module:symbol1</span> <span class="nv">your-module:symbol2</span> <span class="o">...</span><span class="p">))</span> <span class="c1">; Import listed symbols into my package.</span>
<span class="p">(</span><span class="nb">defpackage</span> <span class="ss">:my-package</span> <span class="p">(</span><span class="ss">:use</span> <span class="nv">cl</span><span class="p">)</span>
            <span class="p">(</span><span class="ss">:import-from</span> <span class="ss">:your-module</span><span class="p">))</span> <span class="c1">; Do not import any symbols</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">export</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">f1</span> <span class="nv">f2</span> <span class="nv">my-list</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; No equivalent to EXPORT_OK</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">import</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">your-module:op-func</span> <span class="nv">your-module:your-table</span> <span class="nv">your-module:f1</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; From within the package you want to import into, do this</span>
<span class="c1">;; (IMPORT-TAGS defined in appendix, not standard CL).</span>
<span class="p">(</span><span class="nv">import-tags</span> <span class="ss">:your-module</span> <span class="ss">:DEFAULT</span><span class="p">)</span>
<span class="p">(</span><span class="nb">import</span> <span class="ss">&#39;your-module:your-table</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*export-tags*</span>
  <span class="o">&#39;</span><span class="p">((</span><span class="ss">:functions</span> <span class="p">(</span><span class="nv">f1</span> <span class="nv">f2</span> <span class="nv">op-func</span><span class="p">))</span>
    <span class="p">(</span><span class="ss">:variables</span> <span class="p">(</span><span class="nv">your-list</span> <span class="nv">your-table</span><span class="p">))))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nv">import-tags</span> <span class="ss">:your-module</span> <span class="ss">:functions</span><span class="p">)</span>
<span class="p">(</span><span class="nb">import</span> <span class="ss">&#39;your-module:your-table</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_12.2</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; In the following example, EVAL-WHEN is like the Perl example&#39;s</span>
<span class="c1">;; BEGIN.</span>
<span class="p">(</span><span class="k">eval-when</span> <span class="p">(</span><span class="ss">:compile-toplevel</span> <span class="ss">:load-toplevel</span> <span class="ss">:execute</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">multiple-value-bind</span> <span class="p">(</span><span class="nv">retval</span> <span class="nv">why-not</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">ignore-errors</span> <span class="p">(</span><span class="nb">require</span> <span class="ss">:mod</span><span class="p">))</span>    <span class="c1">; no import</span>
    <span class="p">(</span><span class="nb">when</span> <span class="nv">why-not</span>
      <span class="p">(</span><span class="nb">warn</span> <span class="s">&quot;couldn&#39;t load :mod: ~A&quot;</span> <span class="nv">why-not</span><span class="p">))))</span>

<span class="c1">;; Note that there is no &quot;use&quot; in CL, but you can REQUIRE and then</span>
<span class="c1">;; USE-PACKAGE if it was successful.</span>
<span class="p">(</span><span class="k">eval-when</span> <span class="p">(</span><span class="ss">:compile-toplevel</span> <span class="ss">:load-toplevel</span> <span class="ss">:execute</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">multiple-value-bind</span> <span class="p">(</span><span class="nv">retval</span> <span class="nv">why-not</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">ignore-errors</span> <span class="p">(</span><span class="nb">require</span> <span class="ss">:mod</span><span class="p">))</span>
    <span class="p">(</span><span class="k">if</span> <span class="nv">why-not</span>
      <span class="p">(</span><span class="nb">warn</span> <span class="s">&quot;couldn&#39;t load :mod: ~A&quot;</span> <span class="nv">why-not</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">use-package</span> <span class="ss">:mod</span><span class="p">))))</span>             <span class="c1">; imports into current package</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;; This code is written in order to be as much like the Perl example</span>
<span class="c1">;; as possible, and likely isn&#39;t what you&#39;d use in practice.  Normally</span>
<span class="c1">;; you&#39;d just take advantage of the existing features of, for example,</span>
<span class="c1">;; ASDF.</span>
<span class="p">(</span><span class="k">eval-when</span> <span class="p">(</span><span class="ss">:compile-toplevel</span> <span class="ss">:load-toplevel</span> <span class="ss">:execute</span><span class="p">)</span>

  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">dbs</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">giant.eenie</span> <span class="nv">giant.meanie</span> <span class="nv">mouse.mynie</span> <span class="nv">moe</span><span class="p">))</span>
        <span class="nv">found</span><span class="p">)</span>

    <span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">module</span> <span class="nv">dbs</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">multiple-value-bind</span> <span class="p">(</span><span class="nv">_</span> <span class="nv">why-not</span><span class="p">)</span>
          <span class="p">(</span><span class="nb">ignore-errors</span> <span class="p">(</span><span class="nb">require</span> <span class="nv">module</span><span class="p">))</span>
        <span class="p">(</span><span class="nb">unless</span> <span class="nv">why-not</span>
          <span class="p">(</span><span class="k">let</span> <span class="p">(</span><span class="nv">import-fn</span><span class="p">)</span>
            <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="vg">*package*</span> <span class="p">(</span><span class="nb">find-package</span> <span class="nv">module</span><span class="p">)))</span>
              <span class="c1">;; The following line assumes the module defines</span>
              <span class="c1">;; MY-IMPORT (note it can&#39;t be called IMPORT b/c that</span>
              <span class="c1">;; clashes with CL&#39;s built-in IMPORT).</span>
              <span class="p">(</span><span class="nb">setf</span> <span class="nv">import-fn</span> <span class="p">(</span><span class="nb">symbol-function</span> <span class="p">(</span><span class="nb">find-symbol</span> <span class="s">&quot;MY-IMPORT&quot;</span><span class="p">)))</span>
            <span class="p">(</span><span class="nb">funcall</span> <span class="nv">import-fn</span><span class="p">)))</span>
          <span class="p">(</span><span class="nb">setf</span> <span class="nv">found</span> <span class="no">t</span><span class="p">)</span>
          <span class="p">(</span><span class="nb">return</span><span class="p">))))</span>

    <span class="p">(</span><span class="nb">unless</span> <span class="nv">found</span> <span class="p">(</span><span class="nb">error</span> <span class="s">&quot;None of ~{~A~^ ~} loaded&quot;</span> <span class="nv">dbs</span><span class="p">))))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_12.3</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">eval-when</span> <span class="p">(</span><span class="ss">:compile-toplevel</span> <span class="ss">:load-toplevel</span> <span class="ss">:execute</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nb">and</span> <span class="p">(</span><span class="nb">=</span> <span class="mi">3</span> <span class="p">(</span><span class="nb">length</span> <span class="vg">*posix-argv*</span><span class="p">))</span> <span class="c1">; Perl skips past executable</span>
               <span class="p">(</span><span class="nb">=</span> <span class="mi">2</span> <span class="p">(</span><span class="nb">length</span> <span class="p">(</span><span class="nv">perl-grep</span> <span class="vg">*posix-argv*</span> <span class="c1">; PERL-GREP defined in Appendix</span>
                              <span class="p">(</span><span class="nv">scan</span> <span class="s">&quot;^\\d+$&quot;</span> <span class="nv">it</span><span class="p">)))))</span>
    <span class="p">(</span><span class="nb">error</span> <span class="s">&quot;usage: ~A num1 num2&quot;</span> <span class="p">(</span><span class="nb">car</span> <span class="vg">*posix-argv*</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">require</span> <span class="ss">:some.module</span><span class="p">)</span>
<span class="p">(</span><span class="nb">require</span> <span class="ss">:more.modules</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; This would be silly since CL&#39;s numbers already are &quot;big&quot;.</span>
<span class="p">(</span><span class="nb">when</span> <span class="nv">opt-b</span> <span class="p">(</span><span class="nb">require</span> <span class="ss">:math.bigint</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; The following is just to make the examples work.</span>
<span class="p">(</span><span class="nb">defpackage</span> <span class="ss">:fcntl</span> <span class="p">(</span><span class="ss">:use</span> <span class="nv">cl</span><span class="p">))</span>
<span class="p">(</span><span class="nb">in-package</span> <span class="ss">:fcntl</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defconstant</span> <span class="nv">+O-EXCL+</span> <span class="mh">#x800</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defconstant</span> <span class="nv">+O-CREAT+</span> <span class="mh">#x200</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defconstant</span> <span class="nv">+O-RDWR+</span> <span class="mh">#x2</span><span class="p">)</span>

<span class="p">(</span><span class="nb">export</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">+O-EXCL+</span> <span class="nv">+O-CREAT+</span> <span class="nv">+O-RDWR+</span><span class="p">))</span>
<span class="p">(</span><span class="nb">provide</span> <span class="ss">&#39;fcntl</span><span class="p">)</span>

<span class="p">(</span><span class="nb">defpackage</span> <span class="ss">:my-package</span>
  <span class="p">(</span><span class="ss">:use</span> <span class="nv">cl</span><span class="p">)</span>
  <span class="p">(</span><span class="ss">:import-from</span> <span class="ss">:fcntl</span> <span class="nv">+O-EXCL+</span> <span class="nv">+O-CREAT+</span> <span class="nv">+O-RDWR+</span><span class="p">))</span>
<span class="p">(</span><span class="nb">in-package</span> <span class="ss">:my-package</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">require</span> <span class="ss">:fcntl</span><span class="p">)</span>
<span class="p">(</span><span class="nb">import</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">fcntl:+O-EXCL+</span> <span class="nv">fcntl:+O-CREAT+</span> <span class="nv">fcntl:+O-RDWR+</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">in-package</span> <span class="nv">cl-user</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">load-module</span> <span class="p">(</span><span class="nv">module</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">require</span> <span class="nv">module</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">import</span> <span class="nv">module</span><span class="p">))</span>                      <span class="c1">; WRONG</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nv">load-module</span> <span class="ss">:fcntl</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">fcntl:+O-EXCL+</span> <span class="nv">fcntl:+O-CREAT+</span> <span class="nv">fcntl:+O-RDWR+</span><span class="p">))</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">load-module</span> <span class="p">(</span><span class="nv">module</span> <span class="nv">symbols</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">require</span> <span class="nv">module</span><span class="p">)</span>
  <span class="c1">;; No need for die because REQUIRE will do it for us.</span>
  <span class="p">(</span><span class="nb">import</span> <span class="nv">symbols</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; CL doesn&#39;t have anything like Perl&#39;s autouse, as far as I can tell.</span>
<span class="c1">;; The following is a rough implementation of it.  Usage:</span>
<span class="c1">;;   (autouse &#39;my-package (xyz abc))</span>
<span class="c1">;; Where XYZ and ABC are functions defined within MY-PACKAGE.</span>
<span class="p">(</span><span class="nb">defmacro</span> <span class="nv">autouse</span> <span class="p">(</span><span class="nv">pack</span> <span class="nv">symbols</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">list*</span>
   <span class="ss">&#39;progn</span>
   <span class="p">(</span><span class="nb">loop</span>
      <span class="nv">for</span> <span class="nv">symb</span> <span class="nv">in</span> <span class="nv">symbols</span>
      <span class="nv">collect</span>
        <span class="o">`</span><span class="p">(</span><span class="nb">defun</span> <span class="o">,</span><span class="nv">symb</span> <span class="p">(</span><span class="k">&amp;rest</span> <span class="nv">args</span><span class="p">)</span>
           <span class="p">(</span><span class="nb">require</span> <span class="ss">&#39;,pack</span><span class="p">)</span>
           <span class="p">(</span><span class="nb">apply</span> <span class="p">(</span><span class="nb">find-symbol</span> <span class="o">,</span><span class="p">(</span><span class="nb">symbol-name</span> <span class="nv">symb</span><span class="p">)</span> <span class="ss">&#39;,pack</span><span class="p">)</span> <span class="nv">args</span><span class="p">)))))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_12.4</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defpackage</span> <span class="ss">:alpha</span> <span class="p">(</span><span class="ss">:use</span> <span class="ss">:cl</span><span class="p">))</span>
<span class="p">(</span><span class="nb">in-package</span> <span class="ss">:alpha</span><span class="p">)</span>

<span class="p">(</span><span class="nb">defparameter</span> <span class="nv">aa</span> <span class="mi">10</span><span class="p">)</span>
<span class="p">(</span><span class="nb">export</span> <span class="ss">&#39;aa</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="nv">x</span> <span class="s">&quot;azure&quot;</span><span class="p">)</span>

<span class="p">(</span><span class="nb">defpackage</span> <span class="ss">:beta</span> <span class="p">(</span><span class="ss">:use</span> <span class="ss">:cl</span><span class="p">))</span>
<span class="p">(</span><span class="nb">in-package</span> <span class="ss">:beta</span><span class="p">)</span>

<span class="p">(</span><span class="nb">defparameter</span> <span class="nv">bb</span> <span class="mi">20</span><span class="p">)</span>
<span class="p">(</span><span class="nb">export</span> <span class="ss">&#39;bb</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="nv">x</span> <span class="s">&quot;blue&quot;</span><span class="p">)</span>

<span class="p">(</span><span class="nb">in-package</span> <span class="ss">:cl-user</span><span class="p">)</span>         <span class="c1">; closest thing to Perl&#39;s &#39;main&#39; package</span>
<span class="c1">;; Unlike the Perl example, without the explict EXPORT and IMPORT the</span>
<span class="c1">;; symbols won&#39;t be visible in the CL-USER package.</span>
<span class="p">(</span><span class="nb">import</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">alpha:aa</span> <span class="nv">beta:bb</span><span class="p">))</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A, ~A, ~A, ~A, ~A~%&quot;</span> <span class="nv">aa</span> <span class="nv">bb</span> <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">boundp</span> <span class="ss">&#39;x</span><span class="p">)</span> <span class="nv">x</span> <span class="s">&quot;&quot;</span><span class="p">)</span> <span class="nv">alpha::x</span> <span class="nv">beta::x</span><span class="p">)</span>
<span class="c1">;; 10, 20, , azure, blue</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; flipper.lisp</span>
<span class="p">(</span><span class="nb">defpackage</span> <span class="ss">:flipper</span>
  <span class="p">(</span><span class="ss">:use</span> <span class="nv">cl</span> <span class="nv">cl-ppcre</span><span class="p">)</span>
  <span class="p">(</span><span class="ss">:export</span> <span class="nv">flip-words</span> <span class="nv">flip-boundary</span><span class="p">))</span>
<span class="p">(</span><span class="nb">in-package</span> <span class="ss">:flipper</span><span class="p">)</span>

<span class="p">(</span><span class="nb">defvar</span> <span class="vg">*separatrix*</span> <span class="sc">#\Space</span><span class="p">)</span> <span class="c1">; default to blank; must precede functions</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">flip-boundary</span> <span class="p">(</span><span class="k">&amp;optional</span> <span class="nv">separatrix</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">prog1</span> <span class="vg">*separatrix*</span>
    <span class="p">(</span><span class="nb">when</span> <span class="nv">separatrix</span>
      <span class="p">(</span><span class="nb">setf</span> <span class="vg">*separatrix*</span> <span class="nv">separatrix</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">flip-words</span> <span class="p">(</span><span class="nv">line</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">words</span> <span class="p">(</span><span class="nv">split</span> <span class="vg">*separatrix*</span> <span class="nv">line</span><span class="p">)))</span>
    <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;~~{~~A~~^~A~~}&quot;</span> <span class="vg">*separatrix*</span><span class="p">)</span> <span class="p">(</span><span class="nb">reverse</span> <span class="nv">words</span><span class="p">))))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_12.5</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; #. forces *PACKAGE* to be evaluated at compile-time, so that it</span>
<span class="c1">;; won&#39;t pick up the dynamic value of *PACKAGE* (i.e., the package of</span>
<span class="c1">;; the calling function, which may be different.)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">this-pack</span> <span class="o">#.</span><span class="vg">*package*</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; As long as the following does not appear at the &quot;top level&quot; of the</span>
<span class="c1">;; file, it will contain the current package (i.e., the &quot;outermost&quot;</span>
<span class="c1">;; calling function&#39;s, assuming it hasn&#39;t been rebound explicitly.)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">that-pack</span> <span class="vg">*package*</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;I am in package *package*~%&quot;</span><span class="p">)</span>        <span class="c1">; WRONG!</span>
<span class="c1">;; I am in package *package*</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defpackage</span> <span class="ss">:alpha</span> <span class="p">(</span><span class="ss">:use</span> <span class="nv">cl</span> <span class="nv">beta</span><span class="p">))</span>
<span class="p">(</span><span class="nb">in-package</span> <span class="ss">:alpha</span><span class="p">)</span>

<span class="c1">;; As (I think) the Perl example does, this presupposes that TEMP is</span>
<span class="c1">;; set to an already-open stream (in BETA), e.g.:</span>
<span class="c1">;;  (setf temp (open &quot;/usr/share/dict/words&quot;))</span>
<span class="p">(</span><span class="nv">runit</span> <span class="s">&quot;(setf line (read-line temp))&quot;</span><span class="p">)</span>

<span class="p">(</span><span class="nb">defpackage</span> <span class="ss">:beta</span>
  <span class="p">(</span><span class="ss">:use</span> <span class="nv">cl</span><span class="p">)</span>
  <span class="p">(</span><span class="ss">:export</span> <span class="nv">runit</span><span class="p">))</span>
<span class="p">(</span><span class="nb">in-package</span> <span class="ss">:beta</span><span class="p">)</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">runit</span> <span class="p">(</span><span class="nv">codestr</span><span class="p">)</span>
  <span class="c1">;; The following is not a good idea, but is intended to make this</span>
  <span class="c1">;; example work the way the Perl one does, by causing the EVAL to</span>
  <span class="c1">;; occur in the context of this package (BETA) rather than the</span>
  <span class="c1">;; caller&#39;s (ALPHA&#39;s).</span>
  <span class="p">(</span><span class="nb">in-package</span> <span class="o">#.</span><span class="p">(</span><span class="nb">package-name</span> <span class="vg">*package*</span><span class="p">))</span>
  <span class="c1">;; EVAL will throw an error if there&#39;s any problems, no need to do</span>
  <span class="c1">;; it explicitly like the Perl does.</span>
  <span class="p">(</span><span class="nb">eval</span> <span class="p">(</span><span class="nb">read-from-string</span> <span class="nv">codestr</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defpackage</span> <span class="ss">:beta</span>
  <span class="p">(</span><span class="ss">:use</span> <span class="nv">cl</span><span class="p">)</span>
  <span class="p">(</span><span class="ss">:export</span> <span class="nv">runit</span><span class="p">))</span>
<span class="p">(</span><span class="nb">in-package</span> <span class="ss">:beta</span><span class="p">)</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">runit</span> <span class="p">(</span><span class="nv">codestr</span><span class="p">)</span>
  <span class="c1">;; CL is essentially the reverse of Perl in this regard, the default</span>
  <span class="c1">;; behavior already works the right way without the need to use</span>
  <span class="c1">;; something like Perl&#39;s &#39;caller&#39;.</span>
  <span class="p">(</span><span class="nb">eval</span> <span class="p">(</span><span class="nb">read-from-string</span> <span class="nv">codestr</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defpackage</span> <span class="ss">:alpha</span> <span class="p">(</span><span class="ss">:use</span> <span class="nv">cl</span> <span class="nv">beta</span><span class="p">))</span>
<span class="p">(</span><span class="nb">in-package</span> <span class="ss">:alpha</span><span class="p">)</span>

<span class="p">(</span><span class="nv">runit</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">()</span> <span class="p">(</span><span class="nb">setf</span> <span class="nv">line</span> <span class="p">(</span><span class="nb">read-line</span> <span class="nv">temp</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">defpackage</span> <span class="ss">:beta</span>
  <span class="p">(</span><span class="ss">:use</span> <span class="nv">cl</span><span class="p">)</span>
  <span class="p">(</span><span class="ss">:export</span> <span class="nv">runit</span><span class="p">))</span>
<span class="p">(</span><span class="nb">in-package</span> <span class="ss">:beta</span><span class="p">)</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">runit</span> <span class="p">(</span><span class="nv">coderef</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">funcall</span> <span class="nv">coderef</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">in-package</span> <span class="nv">cl-user</span><span class="p">)</span>

<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*fh*</span> <span class="p">(</span><span class="nb">open</span> <span class="s">&quot;/etc/services&quot;</span><span class="p">))</span> <span class="c1">; don&#39;t have /etc/termcap on my machine</span>
<span class="p">(</span><span class="nb">multiple-value-setq</span> <span class="p">(</span><span class="nv">a</span> <span class="nv">b</span> <span class="nv">c</span><span class="p">)</span> <span class="p">(</span><span class="nb">values-list</span> <span class="p">(</span><span class="nv">nreadline</span> <span class="mi">3</span> <span class="s">&quot;*fh*&quot;</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">nreadline</span> <span class="p">(</span><span class="nb">count</span> <span class="nv">handle</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nb">plusp</span> <span class="nb">count</span><span class="p">)</span> <span class="p">(</span><span class="nb">error</span> <span class="s">&quot;COUNT must be &gt; 0&quot;</span><span class="p">))</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">handle</span> <span class="p">(</span><span class="nb">symbol-value</span> <span class="p">(</span><span class="nb">find-symbol</span> <span class="p">(</span><span class="nb">string-upcase</span> <span class="nv">handle</span><span class="p">)))))</span>
    <span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nb">open-stream-p</span> <span class="nv">handle</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">error</span> <span class="s">&quot;need open filehandle&quot;</span><span class="p">))</span>
    <span class="p">(</span><span class="nb">loop</span>
       <span class="nv">repeat</span> <span class="nb">count</span>
       <span class="nv">collect</span> <span class="p">(</span><span class="nb">read-line</span> <span class="nv">handle</span><span class="p">))))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_12.7</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; In section 12.7 we assume the use of ASDF, which is the de facto</span>
<span class="c1">;; standard package mechanism.</span>
<span class="p">(</span><span class="nb">loop</span>
   <span class="nv">for</span> <span class="nv">path</span> <span class="nv">in</span> <span class="nv">asdf:*central-registry*</span>
   <span class="nv">for</span> <span class="nv">i</span> <span class="nv">from</span> <span class="mi">0</span>
   <span class="nb">do</span> <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~D ~A~%&quot;</span> <span class="nv">i</span> <span class="nv">path</span><span class="p">))</span>
<span class="c1">;;0 /Users/mongo/moogle-code/cl-fnord/</span>
<span class="c1">;;1 /Users/mongo/common-lisp.net/cl-zztop/trunk/</span>
<span class="c1">;;2 (MERGE-PATHNAMES .sbcl/systems/ (USER-HOMEDIR-PATHNAME))</span>
<span class="c1">;;3 (LET ((HOME (POSIX-GETENV SBCL_HOME)))</span>
<span class="c1">;;    (WHEN HOME (MERGE-PATHNAMES site-systems/ (TRUENAME HOME))))</span>
<span class="c1">;;4 *DEFAULT-PATHNAME-DEFAULTS*</span>

<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">pushnew</span> <span class="s">&quot;/projects/spectre/lib&quot;</span> <span class="nv">asdf:*central-registry*</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">require</span> <span class="ss">:find-bin</span><span class="p">)</span>
<span class="p">(</span><span class="nb">pushnew</span> <span class="nv">find-bin::*bin*</span> <span class="nv">asdf:*central-registry*</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">shadowing-import</span> <span class="nv">find-bin::*bin*</span><span class="p">)</span>
<span class="p">(</span><span class="nb">pushnew</span> <span class="p">(</span><span class="nb">concatenate</span> <span class="ss">&#39;string</span> <span class="vg">*bin*</span> <span class="s">&quot;/../lib&quot;</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_13.0</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; In CL you don&#39;t &quot;bless&quot; hash tables (or other data structures), as</span>
<span class="c1">;; classes, you just create instances which manage their own storage.</span>
<span class="c1">;; See section 13.1 for an example of how to create a more Perl-like</span>
<span class="c1">;; object, if you want to.</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">obj</span> <span class="p">(</span><span class="nb">make-instance</span> <span class="ss">&#39;data::encoder</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">obj</span> <span class="o">#(</span><span class="mi">3</span> <span class="mi">5</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A ~A~%&quot;</span> <span class="p">(</span><span class="nb">type-of</span> <span class="nv">obj</span><span class="p">)</span> <span class="p">(</span><span class="nb">aref</span> <span class="nv">obj</span> <span class="mi">1</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">setf</span> <span class="nv">obj</span> <span class="p">(</span><span class="nb">make-instance</span> <span class="ss">&#39;human::cannibal</span><span class="p">))</span>
  <span class="c1">;; This part isn&#39;t exactly like the Perl, there&#39;s no way to reuse</span>
  <span class="c1">;; the array as the underlying storage for the class (as far as I</span>
  <span class="c1">;; know).</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A~%&quot;</span> <span class="p">(</span><span class="nb">type-of</span> <span class="nv">obj</span><span class="p">)))</span>
<span class="c1">;; (SIMPLE-VECTOR 2) 5</span>
<span class="c1">;; CANNIBAL</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">slot-value</span> <span class="nv">obj</span> <span class="ss">&#39;stomach</span><span class="p">)</span> <span class="s">&quot;Empty&quot;</span> <span class="c1">; directly accessing an object&#39;s contents</span>
      <span class="p">(</span><span class="nb">slot-value</span> <span class="nv">obj</span> <span class="ss">&#39;NAME</span><span class="p">)</span> <span class="s">&quot;Thag&quot;</span><span class="p">)</span> <span class="c1">; uppercase field name to make it stand out (optional)</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; The following won&#39;t run (due to data::encoder being fake), it just</span>
<span class="c1">;; illustrates the syntax of calling a method.</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">encoded</span> <span class="p">(</span><span class="nv">encode</span> <span class="nv">obj</span> <span class="s">&quot;data&quot;</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Not really different from the above, but more in the spirit of the</span>
<span class="c1">;; Perl example.</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">encoded</span> <span class="p">(</span><span class="nv">data::encode</span> <span class="nv">obj</span> <span class="s">&quot;data&quot;</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; This is already built in to CL, MAKE-INSTANCE, no need to define it</span>
<span class="c1">;; ourselves.</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">object</span> <span class="p">(</span><span class="nb">make-instance</span> <span class="ss">&#39;my-class</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; No difference from above</span>
<span class="c1">;; $object = Class::new(&quot;Class&quot;);</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Note: haven&#39;t checked whether the following is the best way to do</span>
<span class="c1">;; the following.  It does seem to work tho.</span>

<span class="c1">;; The following will only get called if the type is a class.</span>
<span class="p">(</span><span class="nb">defmethod</span> <span class="nv">class-only-method</span> <span class="p">((</span><span class="nc">class</span> <span class="nc">standard-class</span><span class="p">))</span>
  <span class="c1">;; more code here</span>
  <span class="p">)</span>
<span class="c1">;; Or you could just write a function</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">class-only-method</span> <span class="p">(</span><span class="nc">class</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">check-type</span> <span class="nc">class</span> <span class="nc">standard-class</span><span class="p">)</span>
  <span class="c1">;; more code here</span>
  <span class="p">)</span>

<span class="c1">;; For more specific classes</span>
<span class="p">(</span><span class="nb">defmethod</span> <span class="nv">my-class-only-method</span> <span class="p">((</span><span class="nc">class</span> <span class="p">(</span><span class="nb">eql</span> <span class="p">(</span><span class="nb">find-class</span> <span class="ss">&#39;my-class</span><span class="p">))))</span>
  <span class="c1">;; more code here</span>
  <span class="p">)</span>
<span class="c1">;; Or you could just write a function</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">my-class-only-method</span> <span class="p">(</span><span class="nc">class</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">check-type</span> <span class="nc">class</span> <span class="o">#.</span><span class="p">(</span><span class="nb">find-class</span> <span class="ss">&#39;my-class</span><span class="p">))</span>
  <span class="c1">;; more code here</span>
  <span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*lector*</span> <span class="p">(</span><span class="nb">make-instance</span> <span class="ss">&#39;human::cannibal</span><span class="p">))</span>
<span class="p">(</span><span class="nv">feed</span> <span class="vg">*lector*</span> <span class="s">&quot;Zak&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nv">move</span> <span class="vg">*lector*</span> <span class="s">&quot;New York&quot;</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; No difference from previous subsection.</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">format</span> <span class="vg">*error-output*</span> <span class="s">&quot;stuff here~%&quot;</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Not sure what the Perl was trying to show here</span>
<span class="p">(</span><span class="nv">move</span> <span class="p">(</span><span class="nb">slot-value</span> <span class="nv">obj</span> <span class="ss">&#39;field</span><span class="p">))</span>
<span class="p">(</span><span class="nv">move</span> <span class="p">(</span><span class="nb">aref</span> <span class="nv">ary</span> <span class="nv">i</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">slot-value</span> <span class="p">(</span><span class="nv">move</span> <span class="nv">obj</span><span class="p">)</span> <span class="ss">&#39;field</span><span class="p">)</span>
<span class="p">(</span><span class="nb">aref</span> <span class="p">(</span><span class="nv">move</span> <span class="nv">ary</span><span class="p">)</span> <span class="nv">i</span><span class="p">)</span>           <span class="c1">; won&#39;t work if ARY is actually an array</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Not sure what the Perl code was trying to show</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_13.1</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; This entire subsection is specific to Perl&#39;s object system (or lack</span>
<span class="c1">;; thereof), so it&#39;s difficult to write analogous CL code for it.</span>
<span class="c1">;; Most of the examples would be done in CL using MAKE-INSTANCE (or a</span>
<span class="c1">;; custom function wrapping MAKE-INSTANCE).</span>

<span class="c1">;; For the example of an initialization routine, here is one standard</span>
<span class="c1">;; way to do it.</span>
<span class="p">(</span><span class="nb">defmethod</span> <span class="nb">initialize-instance</span> <span class="ss">:after</span> <span class="p">((</span><span class="nv">obj</span> <span class="nv">my-class</span><span class="p">)</span> <span class="k">&amp;rest</span> <span class="nv">init-args</span><span class="p">)</span>
  <span class="s">&quot;Initialize an object of MY-CLASS&quot;</span>
  <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">slot-value</span> <span class="nv">obj</span> <span class="ss">&#39;SOMETHING</span><span class="p">)</span> <span class="ss">&#39;mumble</span>
        <span class="p">(</span><span class="nb">slot-value</span> <span class="nv">obj</span> <span class="ss">&#39;SOMETHING-ELSE</span><span class="p">)</span> <span class="ss">&#39;bumble</span><span class="p">)</span>
  <span class="c1">;; ... etc</span>
  <span class="p">)</span>

<span class="c1">;; On the other hand, it wouldn&#39;t be sporting not to at least try to</span>
<span class="c1">;; mimic the Perl examples, so here goes.</span>

<span class="c1">;; The following will be used in subsequent examples that attempt to</span>
<span class="c1">;; be like Perl.</span>
<span class="p">(</span><span class="nb">defclass</span> <span class="nv">perl-object</span> <span class="p">()</span>
  <span class="p">((</span><span class="nv">_hash</span> <span class="ss">:initform</span> <span class="p">(</span><span class="nb">make-hash-table</span><span class="p">)</span>
          <span class="ss">:type</span> <span class="nc">hash-table</span><span class="p">))</span>
  <span class="p">(</span><span class="ss">:documentation</span> <span class="s">&quot;Can be used as a mixin class to make your class</span>
<span class="s">  more Perl-like, or can be used directly.&quot;</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defmethod</span> <span class="nb">slot-missing</span> <span class="p">(</span><span class="nc">class</span> <span class="p">(</span><span class="nv">instance</span> <span class="nv">perl-object</span><span class="p">)</span> <span class="nv">slot-name</span> <span class="nv">operation</span>
                         <span class="k">&amp;optional</span> <span class="p">(</span><span class="nv">new-value</span> <span class="no">nil</span> <span class="nv">new-value-supplied-p</span><span class="p">))</span>
  <span class="p">(</span><span class="k">symbol-macrolet</span> <span class="p">((</span><span class="nv">hash-place</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">slot-name</span> <span class="p">(</span><span class="nb">slot-value</span> <span class="nv">instance</span> <span class="ss">&#39;_hash</span><span class="p">))))</span>
    <span class="p">(</span><span class="k">if</span> <span class="nv">new-value-supplied-p</span>
        <span class="p">(</span><span class="nb">setf</span> <span class="nv">hash-place</span> <span class="nv">new-value</span><span class="p">)</span>
        <span class="nv">hash-place</span><span class="p">)))</span>

<span class="c1">;; Here&#39;s an example of how to use PERL-OBJECT as a &quot;mixin&quot; class to</span>
<span class="c1">;; make your class Perl-like (i.e., able to store arbitrary slots in</span>
<span class="c1">;; an underlying hash).</span>
<span class="p">(</span><span class="nb">defclass</span> <span class="nv">my-perlish-class</span> <span class="p">(</span><span class="nv">perl-object</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">a</span> <span class="nv">b</span> <span class="nv">c</span><span class="p">))</span>

<span class="c1">;; Simliar to the new() function in the Perl.</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">perl-new</span> <span class="p">(</span><span class="nc">class</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">assert</span> <span class="p">(</span><span class="nb">subtypep</span> <span class="nc">class</span> <span class="ss">&#39;perl-object</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">make-instance</span> <span class="nc">class</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; No difference</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; No difference</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">new</span> <span class="p">()</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">self</span> <span class="p">(</span><span class="nb">make-instance</span> <span class="ss">&#39;perl-object</span><span class="p">)))</span> <span class="c1">; allocate perl-object w/ anonymous hash</span>
    <span class="c1">;; init two sample attributes/data members/fields</span>
    <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">slot-value</span> <span class="nv">self</span> <span class="ss">&#39;START</span><span class="p">)</span> <span class="p">(</span><span class="nb">get-universal-time</span><span class="p">)</span>
          <span class="p">(</span><span class="nb">slot-value</span> <span class="nv">self</span> <span class="ss">&#39;AGE</span><span class="p">)</span> <span class="mi">0</span><span class="p">)</span>
    <span class="nv">self</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">new</span> <span class="p">(</span><span class="nv">classname</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">assert</span> <span class="p">(</span><span class="nb">subtypep</span> <span class="nv">classname</span> <span class="ss">&#39;perl-object</span><span class="p">))</span> <span class="c1">; Make sure it is of the right type</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">self</span> <span class="p">(</span><span class="nb">make-instance</span> <span class="nv">classname</span><span class="p">)))</span> <span class="c1">; Allocate new memory</span>
    <span class="c1">;; init data fields</span>
    <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">slot-value</span> <span class="nv">self</span> <span class="ss">&#39;START</span><span class="p">)</span> <span class="p">(</span><span class="nb">get-universal-time</span><span class="p">)</span>
          <span class="p">(</span><span class="nb">slot-value</span> <span class="nv">self</span> <span class="ss">&#39;AGE</span><span class="p">)</span> <span class="mi">0</span><span class="p">)</span>
    <span class="nv">self</span><span class="p">))</span>                              <span class="c1">; And give it back</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">new</span> <span class="p">(</span><span class="nv">classname</span> <span class="k">&amp;rest</span> <span class="nv">initargs</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">assert</span> <span class="p">(</span><span class="nb">subtypep</span> <span class="nv">classname</span> <span class="ss">&#39;perl-object</span><span class="p">))</span> <span class="c1">; Make sure it is of the right type</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">self</span> <span class="p">(</span><span class="nb">make-instance</span> <span class="nv">classname</span><span class="p">)))</span> <span class="c1">; Allocate new memory</span>
    <span class="c1">;; init data fields</span>
    <span class="p">(</span><span class="nb">apply</span> <span class="ss">&#39;_init</span> <span class="nv">self</span> <span class="nv">initargs</span><span class="p">)</span>
    <span class="nv">self</span><span class="p">))</span>                              <span class="c1">; And give it back</span>

<span class="c1">;; &quot;private&quot; method to initialize fields.  It always sets START to the</span>
<span class="c1">;; current time, and AGE to 0.  If called with arguments, _init</span>
<span class="c1">;; interprets them as key+value pairs to initialize the object with.</span>
<span class="c1">;; Note that you have to define this for each individual class you</span>
<span class="c1">;; want to have it called upon.  In the example below I used</span>
<span class="c1">;; MY-PERLISH-CLASS, you&#39;d obviously have to change that to whatever</span>
<span class="c1">;; your class was called.</span>
<span class="p">(</span><span class="nb">defmethod</span> <span class="nv">_init</span> <span class="p">((</span><span class="nv">self</span> <span class="nv">my-perlish-class</span><span class="p">)</span> <span class="k">&amp;rest</span> <span class="nv">args</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">slot-value</span> <span class="nv">self</span> <span class="ss">&#39;start</span><span class="p">)</span> <span class="p">(</span><span class="nb">get-universal-time</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">slot-value</span> <span class="nv">self</span> <span class="ss">&#39;age</span><span class="p">)</span> <span class="mi">0</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">loop</span>
     <span class="nv">for</span> <span class="nv">key</span> <span class="nv">in</span> <span class="nv">args</span> <span class="nv">by</span> <span class="nf">#&#39;</span><span class="nb">cddr</span>
     <span class="nv">for</span> <span class="nv">value</span> <span class="nv">in</span> <span class="p">(</span><span class="nb">cdr</span> <span class="nv">args</span><span class="p">)</span> <span class="nv">by</span> <span class="nf">#&#39;</span><span class="nb">cddr</span>
     <span class="nb">do</span>
       <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">slot-value</span> <span class="nv">self</span> <span class="nv">key</span><span class="p">)</span> <span class="nv">value</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_13.2</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;; CL has no equivalent to Perl&#39;s DESTROY.  Classes that need similar</span>
<span class="c1">;; functionality should provide a WITH- macro to handle automatically</span>
<span class="c1">;; freeing up the resources in exceptional circumstances.  Here&#39;s a</span>
<span class="c1">;; skeleton implementation of a macro that one might provide with</span>
<span class="c1">;; one&#39;s class.</span>
<span class="p">(</span><span class="nb">defmacro</span> <span class="nv">with-my-class</span> <span class="p">((</span><span class="nv">my-obj</span> <span class="k">&amp;rest</span> <span class="nv">initargs</span><span class="p">)</span> <span class="k">&amp;body</span> <span class="nv">body</span><span class="p">)</span>
  <span class="o">`</span><span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="o">,</span><span class="nv">my-obj</span> <span class="p">(</span><span class="nb">make-instance</span> <span class="ss">&#39;my-class</span> <span class="o">,@</span><span class="nv">initargs</span><span class="p">)))</span>
     <span class="p">(</span><span class="k">unwind-protect</span>
          <span class="p">(</span><span class="k">progn</span> <span class="o">,@</span><span class="nv">body</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">close</span> <span class="o">,</span><span class="nv">my-obj</span><span class="p">))))</span> <span class="c1">; CLOSE is just an example, should be</span>
                          <span class="c1">; whatever is necessary</span>

<span class="c1">;; Even if a condition is signaled, the cleanup code will be called, as in:</span>
<span class="c1">;;</span>
<span class="c1">;; (with-my-class (obj foo bar)</span>
<span class="c1">;;    (/ 3 0))</span>

<span class="c1">;; If you&#39;re willing to use a non-standard extension, you can use,</span>
<span class="c1">;; e.g., SBCL&#39;s SB-EXT:FINALIZE</span>
<span class="c1">;;; @@INCOMPLETE@@</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_13.3</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Don&#39;t do the following, it&#39;s just here to match the Perl snippet.</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">get-name</span> <span class="p">(</span><span class="nv">self</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">slot-value</span> <span class="nv">self</span> <span class="ss">&#39;name</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">set-name</span> <span class="p">(</span><span class="nv">self</span> <span class="nv">value</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">slot-value</span> <span class="nv">self</span> <span class="ss">&#39;name</span><span class="p">)</span> <span class="nv">value</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; The following is the recommended way to do what the Perl example is</span>
<span class="c1">;; doing and is normally preferred to the previous example.  It</span>
<span class="c1">;; creates a method called NAME which does, essentially, the same</span>
<span class="c1">;; thing as the name() function in the example.</span>
<span class="p">(</span><span class="nb">defclass</span> <span class="nv">my-class</span> <span class="p">()</span>
  <span class="p">((</span><span class="nv">name</span> <span class="ss">:accessor</span> <span class="nv">name</span><span class="p">)))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">name</span> <span class="nv">my-obj</span><span class="p">)</span> <span class="ss">&#39;foo</span>                <span class="c1">; just an example</span>
      <span class="nv">val</span> <span class="p">(</span><span class="nv">name</span> <span class="nv">my-obj</span><span class="p">))</span>                <span class="c1">; just an example</span>

<span class="c1">;; Just for the record, you could also do this (don&#39;t actually do it,</span>
<span class="c1">;; this is just to illustrate :READER and :WRITER).</span>
<span class="p">(</span><span class="nb">defclass</span> <span class="nv">my-class</span> <span class="p">()</span>
  <span class="p">((</span><span class="nv">name</span> <span class="ss">:reader</span> <span class="nv">get-name</span> <span class="ss">:writer</span> <span class="nv">set-name</span><span class="p">)))</span>
<span class="p">(</span><span class="nv">set-name</span> <span class="ss">&#39;foo</span> <span class="nv">my-obj</span><span class="p">)</span>                      <span class="c1">; just an example</span>
<span class="p">(</span><span class="nv">get-name</span> <span class="nv">my-obj</span><span class="p">)</span>                           <span class="c1">; just an example</span>

<span class="c1">;; You could also do the same thing as the previous example manually.</span>
<span class="p">(</span><span class="nb">defclass</span> <span class="nv">my-class</span> <span class="p">()</span>
  <span class="p">(</span><span class="nv">name</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defmethod</span> <span class="nv">get-name</span> <span class="p">((</span><span class="nv">my-obj</span> <span class="nv">my-class</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">slot-value</span> <span class="nv">my-obj</span> <span class="ss">&#39;name</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defmethod</span> <span class="nv">set-name</span> <span class="p">((</span><span class="nv">my-obj</span> <span class="nv">my-class</span><span class="p">)</span> <span class="nv">value</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">slot-value</span> <span class="nv">my-obj</span> <span class="ss">&#39;name</span><span class="p">)</span> <span class="nv">value</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">age</span> <span class="p">(</span><span class="nv">obj</span> <span class="k">&amp;optional</span> <span class="p">(</span><span class="nv">value</span> <span class="no">nil</span> <span class="nv">value-supplied-p</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">prog1</span> <span class="p">(</span><span class="nb">slot-value</span> <span class="nv">obj</span> <span class="ss">&#39;age</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">when</span> <span class="nv">value-supplied-p</span>
      <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">slot-value</span> <span class="nv">obj</span> <span class="ss">&#39;age</span><span class="p">)</span> <span class="nv">value</span><span class="p">))))</span>
<span class="c1">;; sample call of get and set: happy birthday!</span>
<span class="p">(</span><span class="nv">age</span> <span class="nv">obj</span> <span class="p">(</span><span class="nb">1+</span> <span class="p">(</span><span class="nv">age</span> <span class="nv">obj</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defclass</span> <span class="nv">person</span> <span class="p">()</span>
  <span class="p">((</span><span class="nv">name</span> <span class="ss">:accessor</span> <span class="nv">name</span><span class="p">)</span>
   <span class="p">(</span><span class="nv">age</span> <span class="ss">:accessor</span> <span class="nv">age</span><span class="p">)</span>
   <span class="p">(</span><span class="nv">peers</span> <span class="ss">:accessor</span> <span class="nv">peers</span><span class="p">)))</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*him*</span> <span class="p">(</span><span class="nb">make-instance</span> <span class="ss">&#39;person</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">slot-value</span> <span class="vg">*him*</span> <span class="ss">&#39;name</span><span class="p">)</span> <span class="s">&quot;Sylvester&quot;</span>
      <span class="p">(</span><span class="nb">slot-value</span> <span class="vg">*him*</span> <span class="ss">&#39;age</span><span class="p">)</span> <span class="mi">23</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Naming this different from Perl snippet, to avoid clashing with</span>
<span class="c1">;; NAME accessor above.</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">person-name</span> <span class="p">(</span><span class="nv">self</span> <span class="k">&amp;optional</span> <span class="p">(</span><span class="nv">value</span> <span class="no">nil</span> <span class="nv">value-supplied-p</span><span class="p">))</span>
  <span class="p">(</span><span class="k">if</span> <span class="nv">value-supplied-p</span>
      <span class="p">(</span><span class="k">progn</span>
        <span class="c1">;; CL doesn&#39;t have an equivalent of -w (which turns on $^W,</span>
        <span class="c1">;; AFAICT), so we always warn.</span>
        <span class="p">(</span><span class="nb">and</span> <span class="p">(</span><span class="nv">scan</span> <span class="s">&quot;[^\\s\\w&#39;-]&quot;</span> <span class="nv">value</span><span class="p">)</span> <span class="p">(</span><span class="nb">warn</span> <span class="s">&quot;funny characters in name&quot;</span><span class="p">))</span>
        <span class="p">(</span><span class="nb">and</span> <span class="p">(</span><span class="nv">scan</span> <span class="s">&quot;\\d&quot;</span> <span class="nv">value</span><span class="p">)</span> <span class="p">(</span><span class="nb">warn</span> <span class="s">&quot;numbers in name&quot;</span><span class="p">))</span>
        <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nv">scan</span> <span class="s">&quot;\\S+(\\s+\\S+)+&quot;</span> <span class="nv">value</span><span class="p">)</span> <span class="p">(</span><span class="nb">warn</span> <span class="s">&quot;prefer multiword name&quot;</span><span class="p">))</span>
        <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nv">scan</span> <span class="s">&quot;\\S&quot;</span> <span class="nv">value</span><span class="p">)</span> <span class="p">(</span><span class="nb">warn</span> <span class="s">&quot;name is blank&quot;</span><span class="p">))</span>
        <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">name</span> <span class="nv">self</span><span class="p">)</span> <span class="p">(</span><span class="nb">string-upcase</span> <span class="nv">value</span><span class="p">)))</span>
      <span class="p">(</span><span class="nv">name</span> <span class="nv">self</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Most of this subsection (NAME, AGE, PEERS) is already implemented</span>
<span class="c1">;; by the DEFCLASS above.</span>
<span class="p">(</span><span class="nb">defmethod</span> <span class="nv">exclaim</span> <span class="p">((</span><span class="nv">self</span> <span class="nv">person</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">with-accessors</span> <span class="p">((</span><span class="nv">name</span> <span class="nv">name</span><span class="p">)</span> <span class="p">(</span><span class="nv">age</span> <span class="nv">age</span><span class="p">)</span> <span class="p">(</span><span class="nv">peers</span> <span class="nv">peers</span><span class="p">))</span> <span class="nv">self</span>
    <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span>
            <span class="s">&quot;Hi, I&#39;m ~A, age ~D, working with ~{~A~^, ~}&quot;</span>
            <span class="nv">name</span> <span class="nv">age</span> <span class="nv">peers</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defmethod</span> <span class="nv">happy-birthday</span> <span class="p">((</span><span class="nv">self</span> <span class="nv">person</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">incf</span> <span class="p">(</span><span class="nv">age</span> <span class="nv">self</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>


<span class="c1">;;; @@PLEAC@@_13.4</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defclass</span> <span class="nv">person</span> <span class="p">()</span>
  <span class="p">((</span><span class="nv">gender</span> <span class="ss">:accessor</span> <span class="nv">gender</span> <span class="ss">:initarg</span> <span class="ss">:gender</span><span class="p">)))</span>

<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">body-count</span> <span class="mi">0</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">defun</span> <span class="nv">population</span> <span class="p">()</span>
    <span class="nv">body-count</span><span class="p">)</span>

  <span class="p">(</span><span class="nb">defmethod</span> <span class="nb">initialize-instance</span> <span class="ss">:after</span> <span class="p">((</span><span class="nv">self</span> <span class="nv">person</span><span class="p">)</span> <span class="k">&amp;rest</span> <span class="nv">initargs</span><span class="p">)</span>
    <span class="p">(</span><span class="k">declare</span> <span class="p">(</span><span class="k">ignore</span> <span class="nv">initargs</span><span class="p">))</span>
    <span class="p">(</span><span class="nb">incf</span> <span class="nv">body-count</span><span class="p">))</span>

  <span class="c1">;; Note that using standard CL you would have to arrange for this to</span>
  <span class="c1">;; be called somehow.  It won&#39;t be called automatically by the</span>
  <span class="c1">;; garbage collector, as it would in Perl.</span>
  <span class="p">(</span><span class="nb">defmethod</span> <span class="nv">destroy</span> <span class="p">((</span><span class="nv">self</span> <span class="nv">person</span><span class="p">))</span>
    <span class="p">(</span><span class="k">declare</span> <span class="p">(</span><span class="k">ignore</span> <span class="nv">self</span><span class="p">))</span>
    <span class="p">(</span><span class="nb">decf</span> <span class="nv">body-count</span><span class="p">))</span>
  <span class="p">)</span>

<span class="p">(</span><span class="nb">defvar</span> <span class="vg">*people*</span> <span class="no">nil</span><span class="p">)</span>
<span class="p">(</span><span class="nb">loop</span> <span class="nv">repeat</span> <span class="mi">10</span> <span class="nb">do</span> <span class="p">(</span><span class="nb">push</span> <span class="p">(</span><span class="nb">make-instance</span> <span class="ss">&#39;person</span><span class="p">)</span> <span class="vg">*people*</span><span class="p">))</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;There are ~D people alive.~%&quot;</span> <span class="p">(</span><span class="nv">population</span><span class="p">))</span>
<span class="c1">;; There are 10 people alive.</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*him*</span> <span class="p">(</span><span class="nb">make-instance</span> <span class="ss">&#39;person</span> <span class="ss">:gender</span> <span class="ss">:male</span><span class="p">))</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*her*</span> <span class="p">(</span><span class="nb">make-instance</span> <span class="ss">&#39;person</span> <span class="ss">:gender</span> <span class="ss">:female</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nv">fixed-array-max-bounds</span> <span class="mi">100</span><span class="p">)</span>            <span class="c1">; set for whole class</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*alpha*</span> <span class="p">(</span><span class="nb">make-instance</span> <span class="ss">&#39;fixed-array</span><span class="p">))</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;Bound on *alpha* is ~D~%&quot;</span> <span class="p">(</span><span class="nv">max-bounds</span> <span class="vg">*alpha*</span><span class="p">))</span>
<span class="c1">;; Bound on *alpha* is 100</span>

<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*beta*</span> <span class="p">(</span><span class="nb">make-instance</span> <span class="ss">&#39;fixed-array</span><span class="p">))</span>
<span class="p">(</span><span class="nv">max-bounds</span> <span class="vg">*beta*</span> <span class="mi">50</span><span class="p">)</span>                  <span class="c1">; still sets for whole class</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;Bound on *alpha* is ~D~%&quot;</span> <span class="p">(</span><span class="nv">max-bounds</span> <span class="vg">*alpha*</span><span class="p">))</span>
<span class="c1">;; Bound on *alpha* is 50</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defclass</span> <span class="nv">fixed-array</span> <span class="p">()</span> <span class="p">())</span>

<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">bounds</span> <span class="mi">7</span><span class="p">))</span>
  <span class="p">(</span><span class="k">macrolet</span> <span class="p">((</span><span class="nv">bounds-body</span> <span class="p">()</span>
               <span class="o">`</span><span class="p">(</span><span class="k">if</span> <span class="nv">value-supplied-p</span>
                    <span class="p">(</span><span class="nb">setf</span> <span class="nv">bounds</span> <span class="nv">value</span><span class="p">)</span>
                    <span class="nv">bounds</span><span class="p">)))</span>

    <span class="p">(</span><span class="nb">defmethod</span> <span class="nv">max-bounds</span> <span class="p">((</span><span class="nv">fixed-array</span> <span class="nv">fixed-array</span><span class="p">)</span> <span class="k">&amp;optional</span> <span class="p">(</span><span class="nv">value</span> <span class="no">nil</span> <span class="nv">value-supplied-p</span><span class="p">))</span>
      <span class="p">(</span><span class="nv">bounds-body</span><span class="p">))</span>

    <span class="c1">;; Don&#39;t need this, except to be a little more like the Perl code</span>
    <span class="p">(</span><span class="nb">defun</span> <span class="nv">fixed-array-max-bounds</span> <span class="p">(</span><span class="k">&amp;optional</span> <span class="p">(</span><span class="nv">value</span> <span class="no">nil</span> <span class="nv">value-supplied-p</span><span class="p">))</span>
      <span class="p">(</span><span class="nv">bounds-body</span><span class="p">))</span>
    <span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Already implemented in previous snippet</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Don&#39;t do this.  To match the Perl code we have to redefine the</span>
<span class="c1">;; above so that FIXED-ARRAY takes a reference to BOUNDS.  The easiest</span>
<span class="c1">;; way to do that is to make BOUNDS a symbol, there&#39;s no direct way to</span>
<span class="c1">;; store a reference to a number in CL since a number can be passed</span>
<span class="c1">;; around by value.</span>
<span class="p">(</span><span class="nb">defclass</span> <span class="nv">fixed-array</span> <span class="p">()</span> <span class="p">(</span><span class="nv">max-bounds-ref</span><span class="p">))</span>

<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">bounds-sym</span> <span class="p">(</span><span class="nb">gensym</span> <span class="s">&quot;BOUNDS-&quot;</span><span class="p">)))</span> <span class="c1">; a symbol, so we can store a ref to int</span>
  <span class="p">(</span><span class="k">eval-when</span> <span class="p">(</span><span class="ss">:compile-toplevel</span> <span class="ss">:load-toplevel</span> <span class="ss">:execute</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">symbol-value</span> <span class="nv">bounds-sym</span><span class="p">)</span> <span class="mi">7</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">defmethod</span> <span class="nb">initialize-instance</span> <span class="ss">:after</span> <span class="p">((</span><span class="nv">self</span> <span class="nv">fixed-array</span><span class="p">)</span> <span class="k">&amp;rest</span> <span class="nv">initargs</span><span class="p">)</span>
    <span class="p">(</span><span class="k">declare</span> <span class="p">(</span><span class="k">ignore</span> <span class="nv">initargs</span><span class="p">))</span>
    <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">slot-value</span> <span class="nv">self</span> <span class="ss">&#39;max-bounds-ref</span><span class="p">)</span> <span class="nv">bounds-sym</span><span class="p">))</span>

  <span class="p">(</span><span class="nb">defmethod</span> <span class="nv">max-bounds</span> <span class="p">((</span><span class="nv">fixed-array</span> <span class="nv">fixed-array</span><span class="p">)</span> <span class="k">&amp;optional</span> <span class="p">(</span><span class="nv">value</span> <span class="no">nil</span> <span class="nv">value-supplied-p</span><span class="p">))</span>
    <span class="p">(</span><span class="k">if</span> <span class="nv">value-supplied-p</span>
        <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">symbol-value</span> <span class="p">(</span><span class="nb">slot-value</span> <span class="nv">fixed-array</span> <span class="ss">&#39;max-bounds-ref</span><span class="p">))</span> <span class="nv">value</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">symbol-value</span> <span class="p">(</span><span class="nb">slot-value</span> <span class="nv">fixed-array</span> <span class="ss">&#39;max-bounds-ref</span><span class="p">))))</span>

  <span class="p">(</span><span class="nb">defun</span> <span class="nv">fixed-array-max-bounds</span> <span class="p">(</span><span class="k">&amp;optional</span> <span class="p">(</span><span class="nv">value</span> <span class="no">nil</span> <span class="nv">value-supplied-p</span><span class="p">))</span>
    <span class="p">(</span><span class="k">if</span> <span class="nv">value-supplied-p</span>
        <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">symbol-value</span> <span class="nv">bounds-sym</span><span class="p">)</span> <span class="nv">value</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">symbol-value</span> <span class="nv">bounds-sym</span><span class="p">))))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_13.5</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; The closest thing to this example would be CL&#39;s built-in</span>
<span class="c1">;; structures, which are simpler than CLOS objects and which by</span>
<span class="c1">;; default store their slots in vectors.</span>

<span class="p">(</span><span class="nb">defstruct</span> <span class="nv">person</span>
  <span class="nv">name</span>
  <span class="nv">age</span>
  <span class="p">(</span><span class="nv">peers</span> <span class="no">nil</span> <span class="ss">:type</span> <span class="nb">list</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*p*</span> <span class="p">(</span><span class="nv">make-person</span><span class="p">))</span>     <span class="c1">; allocate an empty Person struct</span>

<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">person-name</span> <span class="vg">*p*</span><span class="p">)</span> <span class="s">&quot;Jason Smythe&quot;</span><span class="p">)</span> <span class="c1">; set its name field</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">person-age</span> <span class="vg">*p*</span><span class="p">)</span> <span class="mi">13</span><span class="p">)</span>              <span class="c1">; set its age field</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">person-peers</span> <span class="vg">*p*</span><span class="p">)</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;Wilbur&quot;</span> <span class="s">&quot;Ralph&quot;</span> <span class="s">&quot;Fred&quot;</span><span class="p">))</span> <span class="c1">; set its peers field</span>

<span class="c1">;; fetch various values, including the zeroth friend</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;At age ~D, ~A&#39;s first friend is ~A.~%&quot;</span>
        <span class="p">(</span><span class="nv">person-age</span> <span class="vg">*p*</span><span class="p">)</span>
        <span class="p">(</span><span class="nv">person-name</span> <span class="vg">*p*</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">car</span> <span class="p">(</span><span class="nv">person-peers</span> <span class="vg">*p*</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defstruct</span> <span class="nv">person</span> <span class="nv">name</span> <span class="nv">age</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defstruct</span> <span class="nv">family</span>
  <span class="p">(</span><span class="nv">head</span> <span class="p">(</span><span class="nv">make-person</span><span class="p">)</span> <span class="ss">:type</span> <span class="nv">person</span><span class="p">)</span>
  <span class="nv">address</span>
  <span class="p">(</span><span class="nv">members</span> <span class="no">nil</span> <span class="ss">:type</span> <span class="nb">list</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*folks*</span> <span class="p">(</span><span class="nv">make-family</span><span class="p">))</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*dad*</span> <span class="p">(</span><span class="nv">family-head</span> <span class="vg">*folks*</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">person-name</span> <span class="vg">*dad*</span><span class="p">)</span> <span class="s">&quot;John&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">person-age</span> <span class="vg">*dad*</span><span class="p">)</span> <span class="mi">34</span><span class="p">)</span>

<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A&#39;s age is ~D~%&quot;</span>
        <span class="p">(</span><span class="nv">person-name</span> <span class="p">(</span><span class="nv">family-head</span> <span class="vg">*folks*</span><span class="p">))</span>
        <span class="p">(</span><span class="nv">person-age</span> <span class="p">(</span><span class="nv">family-head</span> <span class="vg">*folks*</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; You can use DEFMETHOD on any type, not just CLOS objects.</span>
<span class="p">(</span><span class="nb">defmethod</span> <span class="nv">age</span> <span class="p">((</span><span class="nv">person</span> <span class="nv">person</span><span class="p">)</span> <span class="k">&amp;optional</span> <span class="p">(</span><span class="nv">value</span> <span class="no">nil</span> <span class="nv">value-supplied-p</span><span class="p">))</span>
  <span class="p">(</span><span class="k">if</span> <span class="nv">value-supplied-p</span>
      <span class="p">(</span><span class="k">progn</span>
        <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">person-age</span> <span class="nv">person</span><span class="p">)</span>
              <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">stringp</span> <span class="nv">value</span><span class="p">)</span>
                  <span class="p">(</span><span class="k">progn</span>
                    <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">not</span> <span class="p">(</span><span class="nv">scan</span> <span class="s">&quot;^\\d+&quot;</span> <span class="nv">value</span><span class="p">))</span>
                      <span class="p">(</span><span class="nb">warn</span> <span class="s">&quot;age `~A&#39; isn&#39;t numeric&quot;</span> <span class="nv">value</span><span class="p">))</span>
                    <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">age</span> <span class="p">(</span><span class="nb">parse-integer</span> <span class="nv">value</span> <span class="ss">:junk-allowed</span> <span class="no">t</span><span class="p">)))</span>
                      <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">&gt;</span> <span class="nv">age</span> <span class="mi">150</span><span class="p">)</span>
                        <span class="p">(</span><span class="nb">warn</span> <span class="s">&quot;age `~D&#39; is unreasonable&quot;</span> <span class="nv">age</span><span class="p">))</span>
                      <span class="nv">age</span><span class="p">))</span>
                  <span class="nv">value</span><span class="p">)))</span>
      <span class="p">(</span><span class="nv">person-age</span> <span class="nv">person</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; No equivalent to $^W</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; There&#39;s still no equivalent to $^W, but the following illustrates</span>
<span class="c1">;; how you could do the rest of what the Perl does.</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">gripe</span> <span class="p">(</span><span class="k">if</span> <span class="vg">*should-warn*</span> <span class="nf">#&#39;</span><span class="nb">warn</span> <span class="nf">#&#39;</span><span class="nb">error</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">not</span> <span class="p">(</span><span class="nv">scan</span> <span class="s">&quot;^\\d+&quot;</span> <span class="nv">value</span><span class="p">))</span>
    <span class="p">(</span><span class="nb">funcall</span> <span class="nv">gripe</span> <span class="s">&quot;age `~A&#39; isn&#39;t numeric&quot;</span> <span class="nv">value</span><span class="p">))</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">age</span> <span class="p">(</span><span class="nb">parse-integer</span> <span class="nv">value</span> <span class="ss">:junk-allowed</span> <span class="no">t</span><span class="p">)))</span>
                      <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">&gt;</span> <span class="nv">age</span> <span class="mi">150</span><span class="p">)</span>
                        <span class="p">(</span><span class="nb">funcall</span> <span class="nv">gripe</span> <span class="s">&quot;age `~D&#39; is unreasonable&quot;</span> <span class="nv">age</span><span class="p">))</span>
                      <span class="nv">age</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Just use DEFSTRUCT as you did above.</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defstruct</span> <span class="nv">card</span> <span class="nv">name</span> <span class="nv">color</span> <span class="nv">cost</span> <span class="k">type</span> <span class="nv">release</span> <span class="nv">text</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Don&#39;t do this.  Very little point, just defining this macro so that</span>
<span class="c1">;; the Perl example can be matched.</span>
<span class="p">(</span><span class="nb">defmacro</span> <span class="nv">defstruct*</span> <span class="p">(</span><span class="nv">name</span> <span class="nv">slots</span><span class="p">)</span>
  <span class="o">`</span><span class="p">(</span><span class="nb">defstruct</span> <span class="o">,</span><span class="nv">name</span> <span class="o">,@</span><span class="nv">slots</span><span class="p">))</span>

<span class="p">(</span><span class="nv">defstruct*</span> <span class="nv">card</span> <span class="o">#.</span><span class="p">(</span><span class="nb">mapcar</span> <span class="nf">#&#39;</span><span class="nb">identity</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">name</span> <span class="nv">color</span> <span class="nv">cost</span> <span class="k">type</span> <span class="nv">release</span> <span class="nv">text</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nv">defstruct*</span> <span class="nv">hostent</span> <span class="o">#.</span><span class="p">(</span><span class="nb">mapcar</span> <span class="nf">#&#39;</span><span class="nb">identity</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">name</span>
                                           <span class="p">(</span><span class="nv">aliases</span> <span class="no">nil</span> <span class="ss">:type</span> <span class="nb">list</span><span class="p">)</span>
                                           <span class="nv">addrtype</span>
                                           <span class="nb">length</span>
                                           <span class="p">(</span><span class="nv">addr-list</span> <span class="no">nil</span> <span class="ss">:type</span> <span class="nb">list</span><span class="p">))))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; What is this supposed to mean?</span>
<span class="c1">;;#define h_type h_addrtype</span>
<span class="c1">;;#define h_addr h_addr_list[0]</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; make (hostent-addr hostent-object) same as (hostent-addr-list hostent-object)</span>

<span class="c1">;; The following has to be a macro so that all the SETF-related stuff</span>
<span class="c1">;; will work correctly.</span>
<span class="p">(</span><span class="nb">defmacro</span> <span class="nv">hostent-addr</span> <span class="p">(</span><span class="nv">hostent-object</span><span class="p">)</span>
  <span class="o">`</span><span class="p">(</span><span class="nv">hostent-addr-list</span> <span class="o">,</span><span class="nv">hostent-object</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Not sure what the corresponding Perl snippet was trying to show.</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_13.6</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Skipping this snippet due to Perl-specificity</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">ob1</span> <span class="p">(</span><span class="nb">make-instance</span> <span class="ss">&#39;some-class</span><span class="p">))</span>
<span class="c1">;; later on</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">ob2</span> <span class="p">(</span><span class="nb">make-instance</span> <span class="p">(</span><span class="nb">class-of</span> <span class="nv">ob1</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; It&#39;s a little unclear what the original Perl is doing.  E.g., I</span>
<span class="c1">;; have no idea what PARENT is supposed to be.</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">new-from-proto</span> <span class="p">(</span><span class="nv">proto</span><span class="p">)</span>
  <span class="c1">;; We don&#39;t need to do all the fancy stuff the Perl code does to get</span>
  <span class="c1">;; the superclass&#39; initializers (equivalent of &#39;new&#39;) to run,</span>
  <span class="c1">;; they&#39;ll be run automatically by MAKE-INSTANCE.</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">self</span> <span class="p">(</span><span class="nb">make-instance</span> <span class="p">(</span><span class="nb">class-of</span> <span class="nv">proto</span><span class="p">))))</span>
    <span class="c1">;; The following two lines presume that the class being</span>
    <span class="c1">;; instantiated either has START and AGE accessors defined, or</span>
    <span class="c1">;; else inherits the PERL-OBJECT mixin defined earlier in this</span>
    <span class="c1">;; chapter, so that any accessor will work.</span>
    <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">slot-value</span> <span class="nv">self</span> <span class="ss">&#39;start</span><span class="p">)</span> <span class="p">(</span><span class="nb">get-universal-time</span><span class="p">)</span> <span class="c1">; init data fields</span>
          <span class="p">(</span><span class="nb">slot-value</span> <span class="nv">self</span> <span class="ss">&#39;age</span><span class="p">)</span> <span class="mi">0</span><span class="p">)</span>
    <span class="nv">self</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_13.7</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">methname</span> <span class="ss">&#39;flicker</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">funcall</span> <span class="nv">methname</span> <span class="nv">obj</span> <span class="mi">10</span><span class="p">))</span>            <span class="c1">; calls (flicker obj 10)</span>

<span class="c1">;; call three methods on the object, by name</span>
<span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">m</span> <span class="nv">in</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">start</span> <span class="nv">run</span> <span class="nv">stop</span><span class="p">)</span>
     <span class="nb">do</span> <span class="p">(</span><span class="nb">funcall</span> <span class="nv">m</span> <span class="nv">obj</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; There is no need to do this in CL, in fact in general it won&#39;t work</span>
<span class="c1">;; because CLOS supports multi-methods, so the method does not</span>
<span class="c1">;; &quot;belong&quot; to any one object or class.</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*fn-ref*</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="k">&amp;rest</span> <span class="nv">args</span><span class="p">)</span> <span class="p">(</span><span class="nb">apply</span> <span class="ss">&#39;my-method</span> <span class="nv">args</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">funcall</span> <span class="vg">*fn-ref*</span> <span class="nv">obj</span> <span class="mi">10</span> <span class="s">&quot;fred&quot;</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nv">my-method</span> <span class="nv">obj</span> <span class="mi">10</span> <span class="s">&quot;fred&quot;</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; There is no equivalent of the Perl snippet because methods don&#39;t</span>
<span class="c1">;; &quot;belong&quot; to a single class.  The following is about as close as you</span>
<span class="c1">;; can get but it only works if there is a specific method defined for</span>
<span class="c1">;; that class and you know which argument(s) are specialized.</span>
<span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">typep</span> <span class="p">(</span><span class="nb">type-of</span> <span class="nv">obj</span><span class="p">)</span> <span class="nv">obj-target</span><span class="p">)</span>
  <span class="c1">;; Find a 3-arg method with the first one specialized to the type of</span>
  <span class="c1">;; OBJ.</span>
  <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">find-method</span> <span class="nf">#&#39;</span><span class="nv">my-method</span> <span class="o">&#39;</span><span class="p">()</span> <span class="p">(</span><span class="nb">list</span> <span class="p">(</span><span class="nb">type-of</span> <span class="nv">obj</span><span class="p">)</span> <span class="no">t</span> <span class="no">t</span><span class="p">))</span>
    <span class="p">(</span><span class="nb">apply</span> <span class="nf">#&#39;</span><span class="nv">my-method</span> <span class="nv">obj-target</span> <span class="nv">arguments</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_13.8</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">typep</span> <span class="nv">obj</span> <span class="ss">&#39;http:message</span><span class="p">)</span>
<span class="c1">;; There is no equivalent to Per&#39;s can() method, as described earlier</span>
<span class="c1">;; methods don&#39;t belong to a single class.  You could use FIND-METHOD</span>
<span class="c1">;; as the final example in section 13.7 above shows, althouth that&#39;s</span>
<span class="c1">;; not recommended.</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">has-io</span> <span class="p">(</span><span class="nb">typep</span> <span class="nv">fd</span> <span class="ss">&#39;io:handle</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">itza-handle</span> <span class="p">(</span><span class="nb">typep</span> <span class="nv">fd</span> <span class="ss">&#39;io:handle</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; No equivalent.  You could use the following after verifying that</span>
<span class="c1">;; OBJ was of the right type.</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">his-print-method</span> <span class="nf">#&#39;</span><span class="nv">as-string</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; There&#39;s no standardized support for versions in CL.</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_13.9</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defclass</span> <span class="nv">person</span> <span class="p">()</span>
  <span class="p">((</span><span class="nv">name</span> <span class="ss">:accessor</span> <span class="nv">name</span> <span class="ss">:initarg</span> <span class="ss">:name</span><span class="p">)</span>
   <span class="p">(</span><span class="nv">age</span> <span class="ss">:accessor</span> <span class="nv">age</span> <span class="ss">:initarg</span> <span class="ss">:age</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">dude</span> <span class="p">(</span><span class="nb">make-instance</span> <span class="ss">&#39;person</span> <span class="ss">:name</span> <span class="s">&quot;Jason&quot;</span> <span class="ss">:age</span> <span class="mi">23</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A is age ~D.~%&quot;</span> <span class="p">(</span><span class="nv">name</span> <span class="nv">dude</span><span class="p">)</span> <span class="p">(</span><span class="nv">age</span> <span class="nv">dude</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defclass</span> <span class="nv">employee</span> <span class="p">(</span><span class="nv">person</span><span class="p">)</span>
  <span class="p">())</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">empl</span> <span class="p">(</span><span class="nb">make-instance</span> <span class="ss">&#39;employee</span> <span class="ss">:name</span> <span class="s">&quot;Jason&quot;</span> <span class="ss">:age</span> <span class="mi">23</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A is age ~D.~%&quot;</span> <span class="p">(</span><span class="nv">name</span> <span class="nv">empl</span><span class="p">)</span> <span class="p">(</span><span class="nv">age</span> <span class="nv">empl</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; No equivalent to this &quot;wrong&quot; Perl snippet.</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_13.10</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defmethod</span> <span class="nv">meth</span> <span class="p">((</span><span class="nv">self</span> <span class="nv">my-class</span><span class="p">))</span>
  <span class="c1">;; Normally this will result in calling the &quot;superclass&quot; as you</span>
  <span class="c1">;; might think of it in, say, Java.  Note though that CLOS supports</span>
  <span class="c1">;; multiple inheritance, aspect-oriented programming, and various</span>
  <span class="c1">;; other extensions, so CALL-NEXT-METHOD won&#39;t *always* do that.</span>
  <span class="p">(</span><span class="nb">call-next-method</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nv">meth</span> <span class="nv">self</span><span class="p">)</span>                        <span class="c1">; call wherever first METH is found</span>

<span class="c1">;; I can&#39;t find any obvious way to do the other examples, you can find</span>
<span class="c1">;; a method with FIND-METHOD but there isn&#39;t an obviuos way to call it</span>
<span class="c1">;; directly on an object.</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Don&#39;t need to define new(), use MAKE-INSTANCE.</span>

<span class="c1">;; Don&#39;t need to define _init(), just add an INITIALIZE-INSTANCE</span>
<span class="c1">;; method, which will be called automatically and which won&#39;t prevent</span>
<span class="c1">;; other stuff from running.</span>
<span class="p">(</span><span class="nb">defmethod</span> <span class="nb">initialize-instance</span> <span class="ss">:after</span> <span class="p">((</span><span class="nv">self</span> <span class="nv">my-class</span><span class="p">)</span> <span class="k">&amp;rest</span> <span class="nv">initargs</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">with-slots</span> <span class="p">(</span><span class="nv">start</span> <span class="nv">age</span> <span class="nv">extra</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">start</span> <span class="nv">self</span><span class="p">)</span> <span class="p">(</span><span class="nb">get-decoded-time</span><span class="p">)</span> <span class="c1">; init data fields</span>
            <span class="p">(</span><span class="nv">age</span> <span class="nv">self</span><span class="p">)</span>   <span class="mi">0</span>
            <span class="p">(</span><span class="nv">extra</span> <span class="nv">self</span><span class="p">)</span> <span class="nv">initargs</span>       <span class="c1">; anything extra</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*obj*</span> <span class="p">(</span><span class="nb">make-instance</span> <span class="ss">&#39;widget</span> <span class="ss">:haircolor</span> <span class="ss">:red</span> <span class="ss">:freckles</span> <span class="mi">121</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; The perl snippet is doing something that&#39;s done automatically by</span>
<span class="c1">;; CLOS (i.e., all inherited INITIALIZE-INSTANCE methods will be</span>
<span class="c1">;; called automatically).</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_13.11</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;; The equivalent of AUTOLOAD is CLOS&#39;s SLOT-MISSING functionality,</span>
<span class="c1">;; used to define PERL-OBJECT, above.  In order to add the ok_field</span>
<span class="c1">;; behavior, we&#39;ll subclass it here.</span>
<span class="p">(</span><span class="nb">defclass</span> <span class="nv">person</span> <span class="p">(</span><span class="nv">perl-object</span><span class="p">)</span>
  <span class="p">((</span><span class="nv">ok-field</span> <span class="ss">:initform</span> <span class="p">(</span><span class="nv">mkhash</span> <span class="ss">&#39;name</span> <span class="no">t</span> <span class="ss">&#39;age</span> <span class="no">t</span> <span class="ss">&#39;peers</span> <span class="no">t</span> <span class="ss">&#39;parent</span> <span class="no">t</span><span class="p">)</span>
             <span class="ss">:type</span> <span class="nc">hash-table</span>
             <span class="ss">:allocation</span> <span class="ss">:class</span><span class="p">)))</span>

<span class="c1">;; This isn&#39;t *exactly* like the Perl snippet, e.g., it doesn&#39;t do the</span>
<span class="c1">;; uppercase checking or checking for DESTROY.  However, since CL</span>
<span class="c1">;; isn&#39;t case-sensitive and methods are kept separate from slots,</span>
<span class="c1">;; there&#39;s no need to do either of those things.</span>
<span class="c1">;;</span>
<span class="c1">;; This method &quot;intercepts&quot; SLOT-MISSING, which is normally handled by</span>
<span class="c1">;; PERL-OBJECT and lets the call through if the slot name is valid.</span>
<span class="p">(</span><span class="nb">defmethod</span> <span class="nb">slot-missing</span> <span class="p">(</span><span class="nc">class</span> <span class="p">(</span><span class="nv">instance</span> <span class="nv">person</span><span class="p">)</span> <span class="nv">slot-name</span> <span class="nv">operation</span>
                         <span class="k">&amp;optional</span> <span class="nv">new-value</span><span class="p">)</span>
  <span class="p">(</span><span class="k">declare</span> <span class="p">(</span><span class="k">ignore</span> <span class="nv">new-value</span> <span class="nv">operation</span><span class="p">))</span>
  <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">slot-name</span> <span class="p">(</span><span class="nb">slot-value</span> <span class="nv">instance</span> <span class="ss">&#39;ok-field</span><span class="p">))</span>
      <span class="p">(</span><span class="nb">call-next-method</span><span class="p">)</span>                <span class="c1">; ok, pass control to PERL-OBJECT</span>
      <span class="p">(</span><span class="nb">error</span> <span class="s">&quot;invalid attribute method ~A&quot;</span> <span class="nv">slot-name</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">dad</span> <span class="p">(</span><span class="nb">make-instance</span> <span class="ss">&#39;person</span><span class="p">))</span>
      <span class="p">(</span><span class="nv">kid</span> <span class="p">(</span><span class="nb">make-instance</span> <span class="ss">&#39;person</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">slot-value</span> <span class="nv">dad</span> <span class="ss">&#39;name</span><span class="p">)</span> <span class="s">&quot;Jason&quot;</span>
        <span class="p">(</span><span class="nb">slot-value</span> <span class="nv">dad</span> <span class="ss">&#39;age</span><span class="p">)</span> <span class="mi">23</span>
        <span class="p">(</span><span class="nb">slot-value</span> <span class="nv">kid</span> <span class="ss">&#39;name</span><span class="p">)</span> <span class="s">&quot;Rachel&quot;</span>
        <span class="p">(</span><span class="nb">slot-value</span> <span class="nv">kid</span> <span class="ss">&#39;age</span><span class="p">)</span> <span class="mi">2</span>
        <span class="p">(</span><span class="nb">slot-value</span> <span class="nv">kid</span> <span class="ss">&#39;parent</span><span class="p">)</span> <span class="nv">dad</span>
        <span class="p">)</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;Kid&#39;s parent is ~A~%&quot;</span> <span class="p">(</span><span class="nb">slot-value</span> <span class="p">(</span><span class="nb">slot-value</span> <span class="nv">kid</span> <span class="ss">&#39;parent</span><span class="p">)</span> <span class="ss">&#39;name</span><span class="p">)))</span>
<span class="c1">;; Kid&#39;s parent is Jason</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; The above SLOT-MISSING definition already works the same way as</span>
<span class="c1">;; this Perl snippet.</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_13.12</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; With respect to this particular Perl snippet, there&#39;s no need to</span>
<span class="c1">;; define Employee::age as its equivalent is automatically defined by</span>
<span class="c1">;; the DEFCLASS below.</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defpackage</span> <span class="ss">:person</span> <span class="p">(</span><span class="ss">:use</span> <span class="nv">cl</span><span class="p">))</span>
<span class="p">(</span><span class="nb">in-package</span> <span class="nv">person</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defclass</span> <span class="nv">person</span> <span class="p">()</span>
  <span class="p">((</span><span class="nv">name</span> <span class="ss">:accessor</span> <span class="nv">name</span><span class="p">)</span>
   <span class="p">(</span><span class="nv">age</span> <span class="ss">:accessor</span> <span class="nv">age</span><span class="p">)</span>
   <span class="p">(</span><span class="nv">peers</span> <span class="ss">:accessor</span> <span class="nv">peers</span><span class="p">)</span>
   <span class="p">(</span><span class="nv">parent</span> <span class="ss">:accessor</span> <span class="nv">parent</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">export</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">person</span> <span class="nv">name</span> <span class="nv">age</span> <span class="nv">peers</span> <span class="nv">parent</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defpackage</span> <span class="ss">:employee</span> <span class="p">(</span><span class="ss">:use</span> <span class="nv">cl</span><span class="p">))</span>
<span class="p">(</span><span class="nb">in-package</span> <span class="nv">employee</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defclass</span> <span class="nv">employee</span> <span class="p">(</span><span class="nv">person:person</span><span class="p">)</span>
  <span class="p">((</span><span class="nv">salary</span> <span class="ss">:accessor</span> <span class="nv">salary</span><span class="p">)</span>
   <span class="p">(</span><span class="nv">age</span> <span class="ss">:accessor</span> <span class="nv">age</span><span class="p">)</span>
   <span class="p">(</span><span class="nv">boss</span> <span class="ss">:accessor</span> <span class="nv">boss</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">export</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">employee</span> <span class="nv">salary</span> <span class="nv">age</span> <span class="nv">boss</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; The &quot;data inheritance problem&quot;, as far as I can tell, is</span>
<span class="c1">;; automatically solved by CL in a similar manner to what the Perl is</span>
<span class="c1">;; doing.  Being automatic, there is no need to define a custom class</span>
<span class="c1">;; like Class::Attributes.  By putting the different classes into</span>
<span class="c1">;; different packages, CL automatically distinguishes the slots by the</span>
<span class="c1">;; package name.</span>
<span class="c1">;;</span>
<span class="c1">;; E.g., the above definitions allow you to write (employee:age obj) or</span>
<span class="c1">;; (person:age obj) and they access distinct slots.</span>
<span class="c1">;;</span>
<span class="c1">;; If you *do* want the AGE slot to be shared by the superclasses, you</span>
<span class="c1">;; should put the DEFCLASS forms in the same package.</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_13.13</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">next</span> <span class="nv">node</span><span class="p">)</span> <span class="nv">node</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defclass</span> <span class="nv">node</span> <span class="p">()</span>
  <span class="p">((</span><span class="nv">next</span> <span class="ss">:accessor</span> <span class="nv">next</span> <span class="ss">:type</span> <span class="nv">node</span><span class="p">)</span>
   <span class="p">(</span><span class="nv">prev</span> <span class="ss">:accessor</span> <span class="nv">prev</span> <span class="ss">:type</span> <span class="nv">node</span><span class="p">)</span>
   <span class="p">(</span><span class="nv">value</span> <span class="ss">:accessor</span> <span class="nv">value</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defclass</span> <span class="nv">ring</span> <span class="p">()</span>
  <span class="p">((</span><span class="nv">dummy</span> <span class="ss">:accessor</span> <span class="nv">dummy</span> <span class="ss">:type</span> <span class="nv">node</span><span class="p">)</span>
   <span class="p">(</span><span class="nv">ring-count</span> <span class="ss">:accessor</span> <span class="nv">ring-count</span> <span class="ss">:type</span> <span class="nc">number</span> <span class="ss">:initform</span> <span class="mi">0</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defmethod</span> <span class="nb">initialize-instance</span> <span class="ss">:after</span> <span class="p">((</span><span class="nv">self</span> <span class="nv">ring</span><span class="p">)</span> <span class="k">&amp;rest</span> <span class="nv">init-args</span><span class="p">)</span>
  <span class="p">(</span><span class="k">declare</span> <span class="p">(</span><span class="k">ignore</span> <span class="nv">init-args</span><span class="p">))</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">dummy</span> <span class="p">(</span><span class="nb">make-instance</span> <span class="ss">&#39;node</span><span class="p">)))</span>
    <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">next</span> <span class="nv">dummy</span><span class="p">)</span> <span class="nv">dummy</span>
          <span class="p">(</span><span class="nv">prev</span> <span class="nv">dummy</span><span class="p">)</span> <span class="nv">dummy</span>
          <span class="p">(</span><span class="nv">value</span> <span class="nv">dummy</span><span class="p">)</span> <span class="ss">&#39;dummy</span><span class="p">)</span>         <span class="c1">; so PRINT-OBJECT works</span>
    <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">dummy</span> <span class="nv">self</span><span class="p">)</span> <span class="nv">dummy</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">i</span> <span class="nv">below</span> <span class="mi">20</span>
   <span class="nb">do</span> <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">r</span> <span class="p">(</span><span class="nb">make-instance</span> <span class="ss">&#39;ring</span><span class="p">)))</span>
        <span class="p">(</span><span class="nb">loop</span> <span class="nv">repeat</span> <span class="mi">1000</span>
           <span class="nb">do</span> <span class="p">(</span><span class="nv">insert</span> <span class="nv">r</span> <span class="nv">i</span><span class="p">))))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Note unlike Perl this isn&#39;t called automatically by CL when the</span>
<span class="c1">;; object is collected, however some CL implementations provide an</span>
<span class="c1">;; extension that could be used to &quot;register&quot; this function as such.</span>
<span class="c1">;; Also, depending on the sophistication of your implementation&#39;s</span>
<span class="c1">;; garbage collector, it might not be necessary to even have this</span>
<span class="c1">;; method (since the object doesn&#39;t hang on to any external</span>
<span class="c1">;; resources).</span>
<span class="p">(</span><span class="nb">defmethod</span> <span class="nv">destroy</span> <span class="p">((</span><span class="nv">ring</span> <span class="nv">ring</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">node</span> <span class="nb">=</span> <span class="p">(</span><span class="nv">next</span> <span class="p">(</span><span class="nv">dummy</span> <span class="nv">ring</span><span class="p">))</span> <span class="nv">then</span> <span class="p">(</span><span class="nv">next</span> <span class="nv">node</span><span class="p">)</span>
       <span class="nv">until</span> <span class="p">(</span><span class="nb">eq</span> <span class="nv">node</span> <span class="p">(</span><span class="nv">dummy</span> <span class="nv">ring</span><span class="p">))</span>
       <span class="nb">do</span> <span class="p">(</span><span class="nv">delete-node</span> <span class="nv">ring</span> <span class="nv">node</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">prev</span> <span class="p">(</span><span class="nv">dummy</span> <span class="nv">ring</span><span class="p">))</span> <span class="no">nil</span>
        <span class="p">(</span><span class="nv">next</span> <span class="p">(</span><span class="nv">dummy</span> <span class="nv">ring</span><span class="p">))</span> <span class="no">nil</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defmethod</span> <span class="nv">delete-node</span> <span class="p">((</span><span class="nv">ring</span> <span class="nv">ring</span><span class="p">)</span> <span class="p">(</span><span class="nv">node</span> <span class="nv">node</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">next</span> <span class="p">(</span><span class="nv">prev</span> <span class="nv">node</span><span class="p">))</span> <span class="p">(</span><span class="nv">next</span> <span class="nv">node</span><span class="p">)</span>
        <span class="p">(</span><span class="nv">prev</span> <span class="p">(</span><span class="nv">next</span> <span class="nv">node</span><span class="p">))</span> <span class="p">(</span><span class="nv">prev</span> <span class="nv">node</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">decf</span> <span class="p">(</span><span class="nv">ring-count</span> <span class="nv">ring</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defmethod</span> <span class="nv">ring-search</span> <span class="p">((</span><span class="nv">ring</span> <span class="nv">ring</span><span class="p">)</span> <span class="nv">value</span> <span class="k">&amp;key</span> <span class="p">(</span><span class="nv">test</span> <span class="ss">&#39;eql</span><span class="p">))</span>
  <span class="s">&quot;Find VALUE in the RING structure, returning a NODE.&quot;</span>
  <span class="p">(</span><span class="nb">loop</span>
     <span class="nv">for</span> <span class="nv">node</span> <span class="nb">=</span> <span class="p">(</span><span class="nv">next</span> <span class="p">(</span><span class="nv">dummy</span> <span class="nv">ring</span><span class="p">))</span> <span class="nv">then</span> <span class="p">(</span><span class="nv">next</span> <span class="nv">node</span><span class="p">)</span>
     <span class="nv">until</span> <span class="p">(</span><span class="nb">eq</span> <span class="nv">node</span> <span class="p">(</span><span class="nv">dummy</span> <span class="nv">ring</span><span class="p">))</span>
     <span class="nb">do</span> <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">funcall</span> <span class="nv">test</span> <span class="p">(</span><span class="nv">value</span> <span class="nv">node</span><span class="p">)</span> <span class="nv">value</span><span class="p">)</span>
          <span class="p">(</span><span class="k">return-from</span> <span class="nv">ring-search</span> <span class="nv">node</span><span class="p">)))</span>
  <span class="p">(</span><span class="nv">dummy</span> <span class="nv">ring</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defmethod</span> <span class="nv">insert</span> <span class="p">((</span><span class="nv">ring</span> <span class="nv">ring</span><span class="p">)</span> <span class="nv">value</span><span class="p">)</span>
  <span class="s">&quot;Insert VALUE into the RING structure.&quot;</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">node</span> <span class="p">(</span><span class="nb">make-instance</span> <span class="ss">&#39;node</span><span class="p">)))</span>
    <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nv">value</span> <span class="nv">node</span><span class="p">)</span> <span class="nv">value</span>
          <span class="p">(</span><span class="nv">next</span> <span class="nv">node</span><span class="p">)</span> <span class="p">(</span><span class="nv">next</span> <span class="p">(</span><span class="nv">dummy</span> <span class="nv">ring</span><span class="p">))</span>
          <span class="p">(</span><span class="nv">prev</span> <span class="p">(</span><span class="nv">next</span> <span class="p">(</span><span class="nv">dummy</span> <span class="nv">ring</span><span class="p">)))</span> <span class="nv">node</span>
          <span class="p">(</span><span class="nv">next</span> <span class="p">(</span><span class="nv">dummy</span> <span class="nv">ring</span><span class="p">))</span> <span class="nv">node</span>
          <span class="p">(</span><span class="nv">prev</span> <span class="nv">node</span><span class="p">)</span> <span class="p">(</span><span class="nv">dummy</span> <span class="nv">ring</span><span class="p">))</span>
    <span class="p">(</span><span class="nb">incf</span> <span class="p">(</span><span class="nv">ring-count</span> <span class="nv">ring</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">defmethod</span> <span class="nv">delete-value</span> <span class="p">((</span><span class="nv">ring</span> <span class="nv">ring</span><span class="p">)</span> <span class="nv">value</span> <span class="k">&amp;key</span> <span class="p">(</span><span class="nv">test</span> <span class="ss">&#39;eql</span><span class="p">))</span>
  <span class="s">&quot;Delete a node from the RING structure by VALUE.&quot;</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">node</span> <span class="p">(</span><span class="nv">ring-search</span> <span class="nv">ring</span> <span class="nv">value</span> <span class="ss">:test</span> <span class="nv">test</span><span class="p">)))</span>
    <span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nb">eq</span> <span class="nv">node</span> <span class="p">(</span><span class="nv">dummy</span> <span class="nv">ring</span><span class="p">))</span>
      <span class="p">(</span><span class="nv">delete-node</span> <span class="nv">ring</span> <span class="nv">node</span><span class="p">))))</span>

<span class="c1">;; just for debugging</span>
<span class="p">(</span><span class="nb">defmethod</span> <span class="nb">print-object</span> <span class="p">((</span><span class="nv">node</span> <span class="nv">node</span><span class="p">)</span> <span class="nc">stream</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">format</span> <span class="nc">stream</span> <span class="s">&quot;#&lt;NODE ~A&gt;&quot;</span> <span class="p">(</span><span class="nv">value</span> <span class="nv">node</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defmethod</span> <span class="nb">print-object</span> <span class="p">((</span><span class="nv">ring</span> <span class="nv">ring</span><span class="p">)</span> <span class="nc">stream</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">format</span> <span class="nc">stream</span> <span class="s">&quot;#&lt;RING&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">do</span> <span class="p">((</span><span class="nv">node</span> <span class="p">(</span><span class="nv">next</span> <span class="p">(</span><span class="nv">dummy</span> <span class="nv">ring</span><span class="p">))</span> <span class="p">(</span><span class="nv">next</span> <span class="nv">node</span><span class="p">)))</span>
      <span class="p">((</span><span class="nb">eq</span> <span class="nv">node</span> <span class="p">(</span><span class="nv">dummy</span> <span class="nv">ring</span><span class="p">)))</span>
    <span class="p">(</span><span class="nb">format</span> <span class="nc">stream</span> <span class="s">&quot; ~A&quot;</span> <span class="nv">node</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">format</span> <span class="nc">stream</span> <span class="s">&quot;&gt;&quot;</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_13.14</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; In CL there is no distinction between operators and functions.</span>
<span class="c1">;; However, functions can be &quot;overloaded&quot; by using DEFMETHOD.</span>

<span class="p">(</span><span class="nb">defmethod</span> <span class="nv">&lt;=&gt;</span> <span class="p">((</span><span class="nv">s1</span> <span class="nc">hash-table</span><span class="p">)</span> <span class="p">(</span><span class="nv">s2</span> <span class="nc">hash-table</span><span class="p">))</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">s1</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">&#39;name</span> <span class="nv">s1</span><span class="p">))</span>
        <span class="p">(</span><span class="nv">s2</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">&#39;name</span> <span class="nv">s2</span><span class="p">)))</span>
    <span class="p">(</span><span class="nb">case</span> <span class="p">(</span><span class="nb">string-lessp</span> <span class="nv">s1</span> <span class="nv">s2</span><span class="p">)</span>
      <span class="p">(</span><span class="no">nil</span> <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">string=</span> <span class="nv">s1</span> <span class="nv">s2</span><span class="p">)</span>
               <span class="mi">0</span>
               <span class="mi">1</span><span class="p">))</span>
      <span class="p">(</span><span class="no">t</span> <span class="mi">-1</span><span class="p">))))</span>

<span class="c1">;; TODO: write a reader macro for &quot;-like stuff.</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; The following allows us to implement MY-PLUS without having to</span>
<span class="c1">;; prefix most of the function calls, etc, with CL:, which gets</span>
<span class="c1">;; old fast.</span>
<span class="p">(</span><span class="nb">defpackage</span> <span class="ss">:time-number-internal</span> <span class="p">(</span><span class="ss">:use</span> <span class="nv">cl</span><span class="p">))</span>

<span class="c1">;; The following package is where we define the method.  It doesn&#39;t</span>
<span class="c1">;; use the CL package, so that + can be redefined (redefining anything</span>
<span class="c1">;; in the CL package is disallowed by the standard).</span>
<span class="p">(</span><span class="nb">defpackage</span> <span class="ss">:time-number</span><span class="p">)</span>

<span class="p">(</span><span class="nb">in-package</span> <span class="nv">time-number</span><span class="p">)</span>

<span class="p">(</span><span class="nv">cl:defclass</span> <span class="nv">time-number</span> <span class="p">()</span>
  <span class="p">((</span><span class="nv">seconds</span> <span class="ss">:accessor</span> <span class="nv">seconds</span> <span class="ss">:initform</span> <span class="mi">0</span> <span class="ss">:initarg</span> <span class="ss">:seconds</span><span class="p">)</span>
   <span class="p">(</span><span class="nv">minutes</span> <span class="ss">:accessor</span> <span class="nv">minutes</span> <span class="ss">:initform</span> <span class="mi">0</span> <span class="ss">:initarg</span> <span class="ss">:minutes</span><span class="p">)</span>
   <span class="p">(</span><span class="nv">hours</span> <span class="ss">:accessor</span> <span class="nv">hours</span> <span class="ss">:initform</span> <span class="mi">0</span> <span class="ss">:initarg</span> <span class="ss">:hours</span><span class="p">)</span>
   <span class="p">))</span>

<span class="p">(</span><span class="nv">cl:defmethod</span> <span class="nb">+</span> <span class="p">((</span><span class="nv">left</span> <span class="nv">time-number</span><span class="p">)</span> <span class="p">(</span><span class="nv">right</span> <span class="nv">time-number</span><span class="p">))</span>
  <span class="p">(</span><span class="nv">time-number-internal::my-plus</span> <span class="nv">left</span> <span class="nv">right</span><span class="p">))</span>

<span class="p">(</span><span class="nv">cl:export</span> <span class="ss">&#39;time-number</span><span class="p">)</span>

<span class="c1">;; There&#39;s no need to do anything like &quot;use overload&quot;, you can just</span>
<span class="c1">;; use DEFMETHOD directly, as shown below.</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">in-package</span> <span class="nv">time-number-internal</span><span class="p">)</span>

<span class="c1">;; The following can safely assume that LEFT and RIGHT are TIME-NUMBER</span>
<span class="c1">;; objects, since this is only called by the TIME-NUMBER:+ method</span>
<span class="c1">;; specialized on TIME-NUMBER.</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">my-plus</span> <span class="p">(</span><span class="nv">left</span> <span class="nv">right</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">answer</span> <span class="p">(</span><span class="nb">make-instance</span> <span class="ss">&#39;time-number:time-number</span><span class="p">)))</span>
    <span class="p">(</span><span class="nb">with-accessors</span> <span class="p">((</span><span class="nv">answer-seconds</span> <span class="nv">seconds</span><span class="p">)</span> <span class="p">(</span><span class="nv">answer-minutes</span> <span class="nv">minutes</span><span class="p">)</span> <span class="p">(</span><span class="nv">answer-hours</span> <span class="nv">hours</span><span class="p">))</span> <span class="nv">answer</span>
      <span class="p">(</span><span class="nb">setf</span> <span class="nv">answer-seconds</span> <span class="p">(</span><span class="nb">+</span> <span class="p">(</span><span class="nv">seconds</span> <span class="nv">left</span><span class="p">)</span>
                              <span class="p">(</span><span class="nv">seconds</span> <span class="nv">right</span><span class="p">))</span>
            <span class="nv">answer-minutes</span> <span class="p">(</span><span class="nb">+</span> <span class="p">(</span><span class="nv">minutes</span> <span class="nv">left</span><span class="p">)</span>
                              <span class="p">(</span><span class="nv">minutes</span> <span class="nv">right</span><span class="p">))</span>
            <span class="nv">answer-hours</span> <span class="p">(</span><span class="nb">+</span> <span class="p">(</span><span class="nv">hours</span> <span class="nv">left</span><span class="p">)</span>
                            <span class="p">(</span><span class="nv">hours</span> <span class="nv">right</span><span class="p">)))</span>
      <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">&gt;=</span> <span class="nv">answer-seconds</span> <span class="mi">60</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">setf</span> <span class="nv">answer-seconds</span> <span class="p">(</span><span class="nb">mod</span> <span class="nv">answer-seconds</span> <span class="mi">60</span><span class="p">))</span>
        <span class="p">(</span><span class="nb">incf</span> <span class="nv">answer-minutes</span><span class="p">))</span>
      <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">&gt;=</span> <span class="nv">answer-minutes</span> <span class="mi">60</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">setf</span> <span class="nv">answer-minutes</span> <span class="p">(</span><span class="nb">mod</span> <span class="nv">answer-minutes</span> <span class="mi">60</span><span class="p">))</span>
        <span class="p">(</span><span class="nb">incf</span> <span class="nv">answer-hours</span><span class="p">)))</span>
    <span class="nv">answer</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;;; @@INCOMPLETE@@</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; @@PLEAC@@_18.1</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">use-package</span> <span class="ss">:sb-bsd-sockets</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*addresses*</span> <span class="p">(</span><span class="nv">host-ent-addresses</span> <span class="p">(</span><span class="nv">get-host-by-name</span> <span class="nv">name</span><span class="p">)))</span>
<span class="c1">;; *addresses* is a list of IP addresses (#(192 48 96 9) #(192 48 96 23))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">inet-ntoa</span> <span class="p">(</span><span class="nv">packed-address</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;~{~D~^.~}&quot;</span> <span class="p">(</span><span class="nb">coerce</span> <span class="nv">packed-address</span> <span class="ss">&#39;list</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*address*</span> <span class="p">(</span><span class="nv">inet-ntoa</span> <span class="p">(</span><span class="nv">make-inet-address</span> <span class="vg">*name*</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">use-package</span> <span class="ss">:sb-bsd-sockets</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*name*</span> <span class="p">(</span><span class="nv">get-host-by-address</span> <span class="o">#(</span><span class="mi">192</span> <span class="mi">48</span> <span class="mi">96</span> <span class="mi">9</span><span class="p">)))</span>
<span class="c1">;; *NAME* is the hostname &quot;ftp.uu.net&quot;</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">use-package</span> <span class="ss">:sb-bsd-sockets</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*packed-address*</span> <span class="p">(</span><span class="nv">make-inet-address</span> <span class="s">&quot;208.146.140.1&quot;</span><span class="p">))</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*ascii-address*</span> <span class="p">(</span><span class="nv">inet-ntoa</span> <span class="vg">*packed-address*</span><span class="p">))</span> <span class="c1">; INET-NTOA defined above</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">use-package</span> <span class="ss">:sb-bsd-sockets</span><span class="p">)</span>
<span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="nv">packed</span> <span class="p">(</span><span class="nv">get-host-by-name</span> <span class="vg">*hostname*</span><span class="p">))</span> <span class="c1">; no need for die, will signal a condition</span>
       <span class="p">(</span><span class="nv">address</span> <span class="p">(</span><span class="nv">host-ent-address</span> <span class="nv">packed</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;I will use ~A as the address for ~A~%&quot;</span> <span class="nv">address</span> <span class="vg">*hostname*</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; *address* is the IP address I&#39;m checking, like &quot;128.138.243.20&quot;</span>
<span class="p">(</span><span class="nb">use-package</span> <span class="ss">:sb-bsd-sockets</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*name*</span> <span class="p">(</span><span class="nv">host-ent-name</span>
                      <span class="p">(</span><span class="nv">get-host-by-address</span> <span class="p">(</span><span class="nv">make-inet-address</span> <span class="vg">*address*</span><span class="p">))))</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*addresses*</span> <span class="p">(</span><span class="nv">host-ent-addresses</span> <span class="p">(</span><span class="nv">get-host-by-name</span> <span class="vg">*name*</span><span class="p">)))</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*found*</span> <span class="p">(</span><span class="nb">member</span> <span class="vg">*address*</span> <span class="vg">*addresses*</span> <span class="ss">:test</span> <span class="ss">&#39;equal</span> <span class="ss">:key</span> <span class="ss">&#39;inet-ntoa</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;;; @@INCOMPLETE@@</span>
<span class="c1">;;;-----------------------------</span>
</pre></div>
</body>
</html>

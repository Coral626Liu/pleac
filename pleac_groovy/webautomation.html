<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN""http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>Web Automation</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="PLEAC-Groovy"
HREF="index.html"><LINK
REL="PREVIOUS"
TITLE="CGI Programming"
HREF="cgiprogramming.html"><LINK
REL="NEXT"
TITLE="Helpers"
HREF="a1102.html"><style type="text/css">td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
pre { line-height: 125%; }

  </style></head
><BODY TEXT="#cecece" BGCOLOR="#4f6f6f" LINK="#f5deb3" VLINK="#d5ae83"
CLASS="SECT1"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>PLEAC-Groovy</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="cgiprogramming.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
></TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="a1102.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="WEBAUTOMATION"
>20. Web Automation</A
></H1
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1054"
>Introduction</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">//----------------------------------------------------------------------------------</span>
<span class="c1">// Many packages are available for simulating a browser. A good starting point:</span>
<span class="c1">// http://groovy.codehaus.org/Testing+Web+Applications</span>
<span class="c1">//----------------------------------------------------------------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1057"
>Fetching a URL from a Perl Script</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">//----------------------------------------------------------------------------------</span>
<span class="c1">// for non-binary content</span>
<span class="n">urlStr</span> <span class="o">=</span> <span class="s1">&#39;http://groovy.codehaus.org&#39;</span>
<span class="n">content</span> <span class="o">=</span> <span class="k">new</span> <span class="n">URL</span><span class="o">(</span><span class="n">urlStr</span><span class="o">).</span><span class="na">text</span>
<span class="n">println</span> <span class="n">content</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="c1">// =&gt; 34824</span>

<span class="c1">// for binary content</span>
<span class="n">urlStr</span> <span class="o">=</span> <span class="s1">&#39;http://groovy.codehaus.org/download/attachments/1871/gina_3d.gif&#39;</span>
<span class="n">bytes</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ByteArrayOutputStream</span><span class="o">()</span>
<span class="n">bytes</span> <span class="o">&lt;&lt;</span> <span class="k">new</span> <span class="n">URL</span><span class="o">(</span><span class="n">urlStr</span><span class="o">).</span><span class="na">openStream</span><span class="o">()</span>
<span class="n">println</span> <span class="n">bytes</span><span class="o">.</span><span class="na">size</span><span class="o">()</span> <span class="c1">// =&gt; 6066</span>

<span class="c1">// various forms of potential error checking</span>
<span class="k">try</span> <span class="o">{</span>
    <span class="k">new</span> <span class="nf">URL</span><span class="o">(</span><span class="s1">&#39;x:y:z&#39;</span><span class="o">)</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">MalformedURLException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">println</span> <span class="n">ex</span><span class="o">.</span><span class="na">message</span> <span class="c1">// =&gt; unknown protocol: x</span>
<span class="o">}</span>
<span class="k">try</span> <span class="o">{</span>
    <span class="k">new</span> <span class="nf">URL</span><span class="o">(</span><span class="s1">&#39;cnn.com/not.there&#39;</span><span class="o">)</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">MalformedURLException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">println</span> <span class="n">ex</span><span class="o">.</span><span class="na">message</span> <span class="c1">// =&gt; no protocol: cnn.com/not.there</span>
<span class="o">}</span>
<span class="k">try</span> <span class="o">{</span>
    <span class="n">content</span> <span class="o">=</span> <span class="k">new</span> <span class="n">URL</span><span class="o">(</span><span class="s1">&#39;http://cnn.com/not.there&#39;</span><span class="o">).</span><span class="na">text</span>
<span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">FileNotFoundException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">println</span> <span class="s2">&quot;Couldn&#39;t find: &quot;</span> <span class="o">+</span> <span class="n">ex</span><span class="o">.</span><span class="na">message</span>
    <span class="c1">// =&gt; Couldn&#39;t find: http://www.cnn.com/not.there</span>
<span class="o">}</span>

<span class="c1">// titleBytes example</span>
<span class="kt">def</span> <span class="nf">titleBytes</span><span class="o">(</span><span class="n">urlStr</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">lineCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="kt">def</span> <span class="n">byteCount</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">new</span> <span class="nf">URL</span><span class="o">(</span><span class="n">urlStr</span><span class="o">).</span><span class="na">eachLine</span><span class="o">{</span> <span class="n">line</span> <span class="o">-&gt;</span>
        <span class="n">lineCount</span><span class="o">++;</span> <span class="n">byteCount</span> <span class="o">+=</span> <span class="n">line</span><span class="o">.</span><span class="na">size</span><span class="o">()</span>
    <span class="o">}</span>
    <span class="n">println</span> <span class="s2">&quot;$urlStr =&gt; ($lineCount lines, $byteCount bytes)&quot;</span>
<span class="o">}</span>
<span class="n">titleBytes</span><span class="o">(</span><span class="s1">&#39;http://www.tpj.com/&#39;</span><span class="o">)</span>
<span class="c1">// http://www.tpj.com/ =&gt; (677 lines, 25503 bytes)</span>
<span class="c1">//----------------------------------------------------------------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1060"
>Automating Form Submission</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">//----------------------------------------------------------------------------------</span>
<span class="c1">// using HtmlUnit (htmlunit.sf.net)</span>
<span class="kn">import</span> <span class="nn">com.gargoylesoftware.htmlunit.WebClient</span>

<span class="kt">def</span> <span class="n">webClient</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WebClient</span><span class="o">()</span>
<span class="kt">def</span> <span class="n">page</span> <span class="o">=</span> <span class="n">webClient</span><span class="o">.</span><span class="na">getPage</span><span class="o">(</span><span class="s1">&#39;http://search.cpan.org/&#39;</span><span class="o">)</span>
<span class="c1">// check page title</span>
<span class="k">assert</span> <span class="n">page</span><span class="o">.</span><span class="na">titleText</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s1">&#39;The CPAN Search Site&#39;</span><span class="o">)</span>
<span class="c1">// fill in form and submit it</span>
<span class="kt">def</span> <span class="n">form</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="na">getFormByName</span><span class="o">(</span><span class="s1">&#39;f&#39;</span><span class="o">)</span>
<span class="kt">def</span> <span class="n">field</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="na">getInputByName</span><span class="o">(</span><span class="s1">&#39;query&#39;</span><span class="o">)</span>
<span class="n">field</span><span class="o">.</span><span class="na">setValueAttribute</span><span class="o">(</span><span class="s1">&#39;DB_File&#39;</span><span class="o">)</span>
<span class="kt">def</span> <span class="n">button</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="na">getInputByValue</span><span class="o">(</span><span class="s1">&#39;CPAN Search&#39;</span><span class="o">)</span>
<span class="kt">def</span> <span class="n">result</span> <span class="o">=</span> <span class="n">button</span><span class="o">.</span><span class="na">click</span><span class="o">()</span>
<span class="c1">// check search result has at least one link ending in DB_File.pm</span>
<span class="k">assert</span> <span class="n">result</span><span class="o">.</span><span class="na">anchors</span><span class="o">.</span><span class="na">any</span><span class="o">{</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.</span><span class="na">hrefAttribute</span><span class="o">.</span><span class="na">endsWith</span><span class="o">(</span><span class="s1">&#39;DB_File.pm&#39;</span><span class="o">)</span> <span class="o">}</span>

<span class="c1">// fields must be properly escaped</span>
<span class="n">println</span> <span class="n">URLEncoder</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="s">/&quot;this isn&#39;t &lt;EASY&gt;&amp;&lt;FUN&gt;&quot;/</span><span class="o">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="o">)</span>
<span class="c1">// =&gt; %22this+isn%27t+%3CEASY%3E%26%3CFUN%3E%22</span>

<span class="c1">// proxies can be taken from environment, or specified</span>
<span class="c1">//System.properties.putAll( [&quot;http.proxyHost&quot;:&quot;proxy-host&quot;, &quot;http.proxyPort&quot;:&quot;proxy-port&quot;,</span>
<span class="c1">//    &quot;http.proxyUserName&quot;:&quot;user-name&quot;, &quot;http.proxyPassword&quot;:&quot;proxy-passwd&quot;] )</span>
<span class="c1">//----------------------------------------------------------------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1063"
>Extracting URLs</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">//----------------------------------------------------------------------------------</span>
<span class="c1">// using HtmlUnit (htmlunit.sf.net)</span>
<span class="kn">import</span> <span class="nn">com.gargoylesoftware.htmlunit.WebClient</span>

<span class="n">client</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WebClient</span><span class="o">()</span>
<span class="n">html</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">getPage</span><span class="o">(</span><span class="s1">&#39;http://www.perl.com/CPAN/&#39;</span><span class="o">)</span>
<span class="n">println</span> <span class="n">page</span><span class="o">.</span><span class="na">anchors</span><span class="o">.</span><span class="na">collect</span><span class="o">{</span> <span class="n">it</span><span class="o">.</span><span class="na">hrefAttribute</span> <span class="o">}.</span><span class="na">sort</span><span class="o">().</span><span class="na">unique</span><span class="o">().</span><span class="na">join</span><span class="o">(</span><span class="s1">&#39;\n&#39;</span><span class="o">)</span>
<span class="c1">// =&gt;</span>
<span class="c1">// disclaimer.html</span>
<span class="c1">// http://bookmarks.cpan.org/</span>
<span class="c1">// http://faq.perl.org/</span>
<span class="c1">// mailto:cpan@perl.org</span>
<span class="c1">// ...</span>
<span class="c1">//----------------------------------------------------------------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1066"
>Converting ASCII to HTML</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">//----------------------------------------------------------------------------------</span>
<span class="c1">// split paragraphs</span>
<span class="n">LS</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">properties</span><span class="o">.</span><span class="s1">&#39;line.separator&#39;</span>
<span class="k">new</span> <span class="nf">File</span><span class="o">(</span><span class="n">args</span><span class="o">[</span><span class="mi">0</span><span class="o">]).</span><span class="na">text</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s2">&quot;$LS$LS&quot;</span><span class="o">).</span><span class="na">each</span><span class="o">{</span> <span class="n">para</span> <span class="o">-&gt;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">para</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s2">&quot; &quot;</span><span class="o">))</span> <span class="n">println</span> <span class="s2">&quot;&lt;pre&gt;\n$para\n&lt;/pre&gt;&quot;</span>
    <span class="k">else</span> <span class="o">{</span>
        <span class="n">para</span> <span class="o">=</span> <span class="n">para</span><span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">/(?m)^(&gt;.*?)$/</span><span class="o">,</span> <span class="s">/$1&lt;br \/</span><span class="o">&gt;</span><span class="s">/)            // quoted text</span>
<span class="s">        para = para.replaceAll(/</span><span class="o">&lt;</span><span class="nl">URL:</span><span class="o">(.*)&gt;</span><span class="s">/, /</span><span class="o">&lt;</span><span class="n">a</span> <span class="n">href</span><span class="o">=</span><span class="s2">&quot;$1&quot;</span><span class="o">&gt;</span><span class="n">$1</span><span class="o">&lt;</span><span class="err">\</span><span class="s">/a&gt;/</span><span class="o">)</span>   <span class="c1">// embedded URL</span>
        <span class="n">para</span> <span class="o">=</span> <span class="n">para</span><span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">/(http:\S+)/</span><span class="o">,</span> <span class="s">/&lt;a href=&quot;$1&quot;&gt;$1&lt;\/</span><span class="n">a</span><span class="o">&gt;</span><span class="s">/)   // guessed URL</span>
<span class="s">        para = para.replaceAll(&#39;\\*(\\S+)\\*&#39;, /</span><span class="o">&lt;</span><span class="n">strong</span><span class="o">&gt;</span><span class="n">$1</span><span class="o">&lt;</span><span class="err">\</span><span class="s">/strong&gt;/</span><span class="o">)</span> <span class="c1">// this is *bold* here</span>
        <span class="n">para</span> <span class="o">=</span> <span class="n">para</span><span class="o">.</span><span class="na">replaceAll</span><span class="o">(</span><span class="s">/\b_(\S+)_\b/</span><span class="o">,</span> <span class="s">/&lt;em&gt;$1&lt;\/</span><span class="n">em</span><span class="o">&gt;</span><span class="s">/)          // this is _italic_ here</span>
<span class="s">        println &quot;&lt;p&gt;\n$para\n&lt;/</span><span class="n">p</span><span class="o">&gt;</span><span class="s2">&quot;                                     // add paragraph tags</span>
<span class="s2">    }</span>
<span class="s2">}</span>

<span class="s2">def encodeEmail(email) {</span>
<span class="s2">    println &quot;</span><span class="o">&lt;</span><span class="n">table</span><span class="o">&gt;</span><span class="s2">&quot;</span>
<span class="s2">    email = URLEncoder.encode(email)</span>
<span class="s2">    email = text.replaceAll(/(\n[ \t]+)/, / . /)   // continuation lines</span>
<span class="s2">    email = text.replaceAll(/(?m)^(\S+?:)\s*(.*?)$/,</span>
<span class="s2">                  /&lt;tr&gt;&lt;th align=&quot;</span><span class="n">left</span><span class="s2">&quot;&gt;$1&lt;\/th&gt;&lt;td&gt;$2&lt;\/td&gt;&lt;\/tr&gt;/);</span>
<span class="s2">    println email</span>
<span class="s2">    println &quot;</span><span class="o">&lt;</span><span class="s">/table&gt;&quot;</span>
<span class="s">}</span>
<span class="s">//----------------------------------------------------------------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1069"
>Converting HTML to ASCII</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="s"></span><span class="s">//----------------------------------------------------------------------------------</span>
<span class="s">// using CyberNeko Parser (people.apache.org/</span><span class="o">~</span><span class="n">andyc</span><span class="s">/neko/</span><span class="n">doc</span><span class="o">)</span>
<span class="n">parser</span> <span class="o">=</span> <span class="k">new</span> <span class="n">org</span><span class="o">.</span><span class="na">cyberneko</span><span class="o">.</span><span class="na">html</span><span class="o">.</span><span class="na">parsers</span><span class="o">.</span><span class="na">SAXParser</span><span class="o">()</span>
<span class="n">parser</span><span class="o">.</span><span class="na">setFeature</span><span class="o">(</span><span class="s1">&#39;http://xml.org/sax/features/namespaces&#39;</span><span class="o">,</span> <span class="kc">false</span><span class="o">)</span>
<span class="n">page</span> <span class="o">=</span> <span class="k">new</span> <span class="n">XmlParser</span><span class="o">(</span><span class="n">parser</span><span class="o">).</span><span class="na">parse</span><span class="o">(</span><span class="s1">&#39;http://www.perl.com/CPAN/&#39;</span><span class="o">)</span>
<span class="n">page</span><span class="o">.</span><span class="na">depthFirst</span><span class="o">().</span><span class="na">each</span><span class="o">{</span> <span class="n">println</span> <span class="n">it</span><span class="o">.</span><span class="na">text</span><span class="o">()</span> <span class="o">}</span>
<span class="c1">//----------------------------------------------------------------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1072"
>Extracting or Removing HTML Tags</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">//----------------------------------------------------------------------------------</span>
<span class="c1">// removing tags, see 20.5</span>

<span class="c1">// extracting tags: htitle using cyberneko and XmlSlurper</span>
<span class="n">parser</span> <span class="o">=</span> <span class="k">new</span> <span class="n">org</span><span class="o">.</span><span class="na">cyberneko</span><span class="o">.</span><span class="na">html</span><span class="o">.</span><span class="na">parsers</span><span class="o">.</span><span class="na">SAXParser</span><span class="o">()</span>
<span class="n">parser</span><span class="o">.</span><span class="na">setFeature</span><span class="o">(</span><span class="s1">&#39;http://xml.org/sax/features/namespaces&#39;</span><span class="o">,</span> <span class="kc">false</span><span class="o">)</span>
<span class="n">page</span> <span class="o">=</span> <span class="k">new</span> <span class="n">XmlParser</span><span class="o">(</span><span class="n">parser</span><span class="o">).</span><span class="na">parse</span><span class="o">(</span><span class="s1">&#39;http://www.perl.com/CPAN/&#39;</span><span class="o">)</span>
<span class="n">println</span> <span class="n">page</span><span class="o">.</span><span class="na">HEAD</span><span class="o">.</span><span class="na">TITLE</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="na">text</span><span class="o">()</span>

<span class="c1">// extracting tags: htitle using HtmlUnit</span>
<span class="n">client</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WebClient</span><span class="o">()</span>
<span class="n">html</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">getPage</span><span class="o">(</span><span class="s1">&#39;http://www.perl.com/CPAN/&#39;</span><span class="o">)</span>
<span class="n">println</span> <span class="n">html</span><span class="o">.</span><span class="na">titleText</span>
<span class="c1">//----------------------------------------------------------------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1075"
>Finding Stale Links</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">//----------------------------------------------------------------------------------</span>
<span class="kn">import</span> <span class="nn">com.gargoylesoftware.htmlunit.WebClient</span>

<span class="n">client</span> <span class="o">=</span> <span class="k">new</span> <span class="n">WebClient</span><span class="o">()</span>
<span class="n">page</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">getPage</span><span class="o">(</span><span class="s1">&#39;http://www.perl.com/CPAN/&#39;</span><span class="o">)</span>
<span class="n">page</span><span class="o">.</span><span class="na">anchors</span><span class="o">.</span><span class="na">each</span><span class="o">{</span>
    <span class="n">checkUrl</span><span class="o">(</span><span class="n">page</span><span class="o">,</span> <span class="n">it</span><span class="o">.</span><span class="na">hrefAttribute</span><span class="o">)</span>
<span class="o">}</span>

<span class="kt">def</span> <span class="nf">checkUrl</span><span class="o">(</span><span class="n">page</span><span class="o">,</span> <span class="n">url</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="n">print</span> <span class="s2">&quot;$url &quot;</span>
        <span class="n">qurl</span> <span class="o">=</span> <span class="n">page</span><span class="o">.</span><span class="na">getFullyQualifiedUrl</span><span class="o">(</span><span class="n">url</span><span class="o">)</span>
        <span class="n">client</span><span class="o">.</span><span class="na">getPage</span><span class="o">(</span><span class="n">qurl</span><span class="o">)</span>
        <span class="n">println</span> <span class="s1">&#39;OK&#39;</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">println</span> <span class="s1">&#39;BAD&#39;</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="c1">// =&gt;</span>
<span class="c1">// modules/index.html OK</span>
<span class="c1">// RECENT.html OK</span>
<span class="c1">// http://search.cpan.org/recent OK</span>
<span class="c1">// http://mirrors.cpan.org/ OK</span>
<span class="c1">// http://perldoc.perl.org/ OK</span>
<span class="c1">// mailto:cpan@perl.org BAD</span>
<span class="c1">// http://www.csc.fi/suomi/funet/verkko.html.en/ BAD</span>
<span class="c1">// ...</span>
<span class="c1">//----------------------------------------------------------------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1078"
>Finding Fresh Links</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">//----------------------------------------------------------------------------------</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.httpclient.HttpClient</span>
<span class="kn">import</span> <span class="nn">org.apache.commons.httpclient.methods.HeadMethod</span>
<span class="kn">import</span> <span class="nn">java.text.DateFormat</span>

<span class="n">urls</span> <span class="o">=</span> <span class="o">[</span>
    <span class="s2">&quot;http://www.apache.org/&quot;</span><span class="o">,</span>
    <span class="s2">&quot;http://www.perl.org/&quot;</span><span class="o">,</span>
    <span class="s2">&quot;http://www.python.org/&quot;</span><span class="o">,</span>
    <span class="s2">&quot;http://www.ora.com/&quot;</span><span class="o">,</span>
    <span class="s2">&quot;http://jakarta.apache.org/&quot;</span><span class="o">,</span>
    <span class="s2">&quot;http://www.w3.org/&quot;</span>
<span class="o">]</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">DateFormat</span><span class="o">.</span><span class="na">getDateTimeInstance</span><span class="o">(</span><span class="n">DateFormat</span><span class="o">.</span><span class="na">FULL</span><span class="o">,</span> <span class="n">DateFormat</span><span class="o">.</span><span class="na">MEDIUM</span><span class="o">)</span>
<span class="n">client</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HttpClient</span><span class="o">()</span>
<span class="n">urlInfo</span> <span class="o">=</span> <span class="o">[:]</span>
<span class="n">urls</span><span class="o">.</span><span class="na">each</span><span class="o">{</span> <span class="n">url</span> <span class="o">-&gt;</span>
    <span class="n">head</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HeadMethod</span><span class="o">(</span><span class="n">url</span><span class="o">)</span>
    <span class="n">client</span><span class="o">.</span><span class="na">executeMethod</span><span class="o">(</span><span class="n">head</span><span class="o">)</span>
    <span class="n">lastModified</span> <span class="o">=</span> <span class="n">head</span><span class="o">.</span><span class="na">getResponseHeader</span><span class="o">(</span><span class="s2">&quot;last-modified&quot;</span><span class="o">)?.</span><span class="na">value</span>
    <span class="n">urlInfo</span><span class="o">[</span><span class="n">df</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">lastModified</span><span class="o">)]=</span><span class="n">url</span>
<span class="o">}</span>

<span class="n">urlInfo</span><span class="o">.</span><span class="na">keySet</span><span class="o">().</span><span class="na">sort</span><span class="o">().</span><span class="na">each</span><span class="o">{</span> <span class="n">key</span> <span class="o">-&gt;</span>
    <span class="n">println</span> <span class="s2">&quot;$key ${urlInfo[key]}&quot;</span>
<span class="o">}</span>
<span class="c1">// =&gt;</span>
<span class="c1">// Sun Jan 07 21:48:15 EST 2007 http://www.apache.org/</span>
<span class="c1">// Sat Jan 13 12:44:32 EST 2007 http://jakarta.apache.org/</span>
<span class="c1">// Fri Jan 19 14:50:13 EST 2007 http://www.w3.org/</span>
<span class="c1">// Fri Jan 19 19:28:35 EST 2007 http://www.python.org/</span>
<span class="c1">// Sat Jan 20 09:36:08 EST 2007 http://www.ora.com/</span>
<span class="c1">// Sat Jan 20 13:25:53 EST 2007 http://www.perl.org/</span>
<span class="c1">//----------------------------------------------------------------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1081"
>Creating HTML Templates</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">//----------------------------------------------------------------------------------</span>
<span class="c1">// GString version (variables must be predefined):</span>
<span class="n">username</span> <span class="o">=</span> <span class="s1">&#39;Tom&#39;</span>
<span class="n">count</span> <span class="o">=</span> <span class="mi">99</span>
<span class="n">total</span> <span class="o">=</span> <span class="mi">999</span>
<span class="n">htmlStr</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;!-- simple.template for internal template() function --&gt;</span>
<span class="s2">&lt;HTML&gt;&lt;HEAD&gt;&lt;TITLE&gt;Report for $username&lt;/TITLE&gt;&lt;/HEAD&gt;</span>
<span class="s2">&lt;BODY&gt;&lt;H1&gt;Report for $username&lt;/H1&gt;</span>
<span class="s2">$username logged in $count times, for a total of $total minutes.</span>
<span class="s2">&quot;&quot;&quot;</span>
<span class="n">println</span> <span class="n">htmlStr</span>

<span class="c1">// SimpleTemplateEngine version:</span>
<span class="kt">def</span> <span class="n">html</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">&lt;!-- simple.template for internal template() function --&gt;</span>
<span class="s1">&lt;HTML&gt;&lt;HEAD&gt;&lt;TITLE&gt;Report for $username&lt;/TITLE&gt;&lt;/HEAD&gt;</span>
<span class="s1">&lt;BODY&gt;&lt;H1&gt;Report for $username&lt;/H1&gt;</span>
<span class="s1">$username logged in $count times, for a total of $total minutes.</span>
<span class="s1">&#39;&#39;&#39;</span>

<span class="kt">def</span> <span class="n">engine</span> <span class="o">=</span> <span class="k">new</span> <span class="n">groovy</span><span class="o">.</span><span class="na">text</span><span class="o">.</span><span class="na">SimpleTemplateEngine</span><span class="o">()</span>
<span class="kt">def</span> <span class="n">reader</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringReader</span><span class="o">(</span><span class="n">html</span><span class="o">)</span>
<span class="kt">def</span> <span class="n">template</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="na">createTemplate</span><span class="o">(</span><span class="n">reader</span><span class="o">)</span>
<span class="n">println</span> <span class="n">template</span><span class="o">.</span><span class="na">make</span><span class="o">(</span><span class="nl">username:</span><span class="s2">&quot;Peter&quot;</span><span class="o">,</span> <span class="nl">count:</span><span class="s2">&quot;23&quot;</span><span class="o">,</span> <span class="nl">total:</span> <span class="s2">&quot;1234&quot;</span><span class="o">)</span>

<span class="c1">// SQL version</span>
<span class="kn">import</span> <span class="nn">groovy.sql.Sql</span>
<span class="n">user</span> <span class="o">=</span> <span class="s1">&#39;Peter&#39;</span>
<span class="kt">def</span> <span class="n">sql</span> <span class="o">=</span> <span class="n">Sql</span><span class="o">.</span><span class="na">newInstance</span><span class="o">(</span><span class="s1">&#39;jdbc:mysql://localhost:3306/mydb&#39;</span><span class="o">,</span> <span class="s1">&#39;dbuser&#39;</span><span class="o">,</span>
                      <span class="s1">&#39;dbpass&#39;</span><span class="o">,</span> <span class="s1">&#39;com.mysql.jdbc.Driver&#39;</span><span class="o">)</span>
<span class="n">sql</span><span class="o">.</span><span class="na">query</span><span class="o">(</span><span class="s2">&quot;SELECT COUNT(duration),SUM(duration) FROM logins WHERE username=&#39;$user&#39;&quot;</span><span class="o">)</span> <span class="o">{</span> <span class="n">answer</span> <span class="o">-&gt;</span>
    <span class="n">println</span> <span class="o">(</span><span class="n">template</span><span class="o">.</span><span class="na">make</span><span class="o">(</span><span class="nl">username:</span><span class="n">user</span><span class="o">,</span> <span class="nl">count:</span><span class="n">answer</span><span class="o">[</span><span class="mi">0</span><span class="o">],</span> <span class="nl">total:</span><span class="n">answer</span><span class="o">[</span><span class="mi">1</span><span class="o">]))</span>
<span class="o">}</span>
<span class="c1">//----------------------------------------------------------------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1084"
>Mirroring Web Pages</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">//----------------------------------------------------------------------------------</span>
<span class="c1">// using built-in connection features</span>
<span class="n">urlStr</span> <span class="o">=</span> <span class="s1">&#39;http://jakarta.apache.org/&#39;</span>
<span class="n">url</span> <span class="o">=</span> <span class="k">new</span> <span class="n">URL</span><span class="o">(</span><span class="n">urlStr</span><span class="o">)</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="na">openConnection</span><span class="o">()</span>
<span class="n">connection</span><span class="o">.</span><span class="na">ifModifiedSince</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Date</span><span class="o">(</span><span class="mi">2007</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="mi">18</span><span class="o">).</span><span class="na">time</span>
<span class="n">connection</span><span class="o">.</span><span class="na">connect</span><span class="o">()</span>
<span class="n">println</span> <span class="n">connection</span><span class="o">.</span><span class="na">responseCode</span>

<span class="c1">// manually setting header field</span>
<span class="n">connection</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="na">openConnection</span><span class="o">()</span>
<span class="n">df</span> <span class="o">=</span> <span class="k">new</span> <span class="n">java</span><span class="o">.</span><span class="na">text</span><span class="o">.</span><span class="na">SimpleDateFormat</span> <span class="o">(</span><span class="s2">&quot;EEE, dd MMM yyyy HH:mm:ss &#39;GMT&#39;&quot;</span><span class="o">)</span>
<span class="n">df</span><span class="o">.</span><span class="na">setTimeZone</span><span class="o">(</span><span class="n">TimeZone</span><span class="o">.</span><span class="na">getTimeZone</span><span class="o">(</span><span class="s1">&#39;GMT&#39;</span><span class="o">))</span>
<span class="n">connection</span><span class="o">.</span><span class="na">setRequestProperty</span><span class="o">(</span><span class="s2">&quot;If-Modified-Since&quot;</span><span class="o">,</span><span class="n">df</span><span class="o">.</span><span class="na">format</span><span class="o">(</span><span class="k">new</span> <span class="n">Date</span><span class="o">(</span><span class="mi">2007</span><span class="o">,</span><span class="mi">1</span><span class="o">,</span><span class="mi">18</span><span class="o">)));</span>
<span class="n">connection</span><span class="o">.</span><span class="na">connect</span><span class="o">()</span>
<span class="n">println</span> <span class="n">connection</span><span class="o">.</span><span class="na">responseCode</span>
<span class="c1">//----------------------------------------------------------------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1087"
>Creating a Robot</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">//----------------------------------------------------------------------------------</span>
<span class="c1">// The website http://www.robotstxt.org/wc/active/html/ lists many available robots</span>
<span class="c1">// including Java ones which can be used from Groovy. In particular, j-spider</span>
<span class="c1">// allows you to:</span>
<span class="c1">// + Check your site for errors (internal server errors, ...)</span>
<span class="c1">// + Outgoing and/or internal link checking</span>
<span class="c1">// + Analyze your site structure (creating a sitemap, ...)</span>
<span class="c1">// + Download complete web sites</span>
<span class="c1">// most of its functionality is available by tweaking appropriate configuration</span>
<span class="c1">// files and then running it as a standalone application but you can also write</span>
<span class="c1">// your own java classes.</span>
<span class="c1">//----------------------------------------------------------------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1090"
>Parsing a Web Server Log File</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">//----------------------------------------------------------------------------------</span>
<span class="c1">// sample data, use &#39;LOGFILE = new File(args[0]).text&#39; or similar</span>
<span class="n">LOGFILE</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">127.0.0.1 - - [04/Sep/2005:20:50:31 +0200] &quot;GET /bus HTTP/1.1&quot; 301 303</span>
<span class="s1">127.0.0.1 - - [04/Sep/2005:20:50:31 +0200] &quot;GET /bus HTTP/1.1&quot; 301 303 &quot;-&quot; &quot;Opera/8.02 (X11; Linux i686; U; en)&quot;</span>
<span class="s1">192.168.0.1 - - [04/Sep/2005:20:50:36 +0200] &quot;GET /bus/libjs/layersmenu-library.js HTTP/1.1&quot; 200 6228</span>
<span class="s1">192.168.0.1 - - [04/Sep/2005:20:50:36 +0200] &quot;GET /bus/libjs/layersmenu-library.js HTTP/1.1&quot; 200 6228 &quot;http://localhost/bus/&quot; &quot;Opera/8.02 (X11; Linux i686; U; en)&quot;</span>
<span class="s1">&#39;&#39;&#39;</span>

<span class="c1">// similar to perl version:</span>
<span class="n">fields</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;client&#39;</span><span class="o">,</span><span class="s1">&#39;identuser&#39;</span><span class="o">,</span><span class="s1">&#39;authuser&#39;</span><span class="o">,</span><span class="s1">&#39;date&#39;</span><span class="o">,</span><span class="s1">&#39;time&#39;</span><span class="o">,</span><span class="s1">&#39;tz&#39;</span><span class="o">,</span><span class="s1">&#39;method&#39;</span><span class="o">,</span><span class="s1">&#39;url&#39;</span><span class="o">,</span><span class="s1">&#39;protocol&#39;</span><span class="o">,</span><span class="s1">&#39;status&#39;</span><span class="o">,</span><span class="s1">&#39;bytes&#39;</span><span class="o">]</span>
<span class="n">regex</span> <span class="o">=</span> <span class="s">/^(\S+) (\S+) (\S+) \[([^:]+):(\d+:\d+:\d+) ([^\]]+)\] &quot;(\S+) (.*?) (\S+)&quot; (\S+) (\S+).*$/</span>

<span class="n">LOGFILE</span><span class="o">.</span><span class="na">trim</span><span class="o">().</span><span class="na">split</span><span class="o">(</span><span class="s1">&#39;\n&#39;</span><span class="o">).</span><span class="na">each</span><span class="o">{</span> <span class="n">line</span> <span class="o">-&gt;</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">line</span> <span class="o">=~</span> <span class="n">regex</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">m</span><span class="o">.</span><span class="na">matches</span><span class="o">())</span> <span class="o">{</span>
        <span class="k">for</span> <span class="o">(</span><span class="n">idx</span> <span class="k">in</span> <span class="mi">0</span><span class="o">..&lt;</span><span class="n">fields</span><span class="o">.</span><span class="na">size</span><span class="o">())</span> <span class="o">{</span> <span class="n">println</span> <span class="s2">&quot;${fields[idx]}=${m[0][idx+1]}&quot;</span> <span class="o">}</span>
        <span class="n">println</span><span class="o">()</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="c1">//----------------------------------------------------------------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1093"
>Processing Server Logs</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">//----------------------------------------------------------------------------------</span>
<span class="c1">// sample data, use &#39;LOGFILE = new File(args[0]).text&#39; or similar</span>
<span class="n">LOGFILE</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">204.31.113.138 - - [03/Jul/1996:06:56:12 -0800] &quot;POST /forms/login.jsp HTTP/1.0&quot; 200 5593</span>
<span class="s1">fcrawler.looksmart.com - - [26/Apr/2000:00:00:12 -0400] &quot;GET /contacts.html HTTP/1.0&quot; 200 4595 &quot;-&quot; &quot;FAST-WebCrawler/2.1-pre2 (ashen@looksmart.net)&quot;</span>
<span class="s1">fcrawler.looksmart.com - - [26/Apr/2000:00:17:19 -0400] &quot;GET /news/news.html HTTP/1.0&quot; 200 16716 &quot;-&quot; &quot;FAST-WebCrawler/2.1-pre2 (ashen@looksmart.net)&quot;</span>
<span class="s1">ppp931.on.bellglobal.com - - [26/Apr/2000:00:16:12 -0400] &quot;GET /download/windows/asctab31.zip HTTP/1.0&quot; 200 1540096 &quot;http://www.htmlgoodies.com/downloads/freeware/webdevelopment/15.html&quot; &quot;Mozilla/4.7 [en]C-SYMPA  (Win95; U)&quot;</span>
<span class="s1">123.123.123.123 - - [26/Apr/2000:00:23:48 -0400] &quot;GET /pics/wpaper.gif HTTP/1.0&quot; 200 6248 &quot;http://www.jafsoft.com/asctortf/&quot; &quot;Mozilla/4.05 (Macintosh; I; PPC)&quot;</span>
<span class="s1">123.123.123.123 - - [26/Apr/2000:00:23:47 -0400] &quot;GET /asctortf/ HTTP/1.0&quot; 200 8130 &quot;http://search.netscape.com/Computers/Data_Formats/Document/Text/RTF&quot; &quot;Mozilla/4.05 (Macintosh; I; PPC)&quot;</span>
<span class="s1">123.123.123.123 - - [26/Apr/2000:00:23:48 -0400] &quot;GET /pics/5star2000.gif HTTP/1.0&quot; 200 4005 &quot;http://www.jafsoft.com/asctortf/&quot; &quot;Mozilla/4.05 (Macintosh; I; PPC)&quot;</span>
<span class="s1">123.123.123.123 - - [27/Apr/2000:00:23:50 -0400] &quot;GET /pics/5star.gif HTTP/1.0&quot; 200 1031 &quot;http://www.jafsoft.com/asctortf/&quot; &quot;Mozilla/4.05 (Macintosh; I; PPC)&quot;</span>
<span class="s1">123.123.123.123 - - [27/Apr/2000:00:23:51 -0400] &quot;GET /pics/a2hlogo.jpg HTTP/1.0&quot; 200 4282 &quot;http://www.jafsoft.com/asctortf/&quot; &quot;Mozilla/4.05 (Macintosh; I; PPC)&quot;</span>
<span class="s1">123.123.123.123 - - [27/Apr/2000:00:23:51 -0400] &quot;GET /cgi-bin/newcount?jafsof3&amp;width=4&amp;font=digital&amp;noshow HTTP/1.0&quot; 200 36 &quot;http://www.jafsoft.com/asctortf/&quot; &quot;Mozilla/4.05 (Macintosh; I; PPC)&quot;</span>
<span class="s1">127.0.0.1 - frank [10/Oct/2000:13:55:36 -0700] &quot;GET /apache_pb.gif HTTP/1.0&quot; 200 2326</span>
<span class="s1">127.0.0.1 - - [04/Sep/2005:20:50:31 +0200] &quot;GET / HTTP/1.1&quot; 200 1927</span>
<span class="s1">127.0.0.1 - - [04/Sep/2005:20:50:31 +0200] &quot;GET /bus HTTP/1.1&quot; 301 303 &quot;-&quot; &quot;Opera/8.02 (X11; Linux i686; U; en)&quot;</span>
<span class="s1">192.168.0.1 - - [05/Sep/2005:20:50:36 +0200] &quot;GET /bus/libjs/layersmenu-library.js HTTP/1.1&quot; 200 6228</span>
<span class="s1">192.168.0.1 - - [05/Sep/2005:20:50:36 +0200] &quot;GET /bus/libjs/layersmenu-library.js HTTP/1.1&quot; 200 6228 &quot;http://localhost/bus/&quot; &quot;Opera/8.02 (X11; Linux i686; U; en)&quot;</span>
<span class="s1">&#39;&#39;&#39;</span>

<span class="n">fields</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;client&#39;</span><span class="o">,</span><span class="s1">&#39;identuser&#39;</span><span class="o">,</span><span class="s1">&#39;authuser&#39;</span><span class="o">,</span><span class="s1">&#39;date&#39;</span><span class="o">,</span><span class="s1">&#39;time&#39;</span><span class="o">,</span><span class="s1">&#39;tz&#39;</span><span class="o">,</span><span class="s1">&#39;method&#39;</span><span class="o">,</span><span class="s1">&#39;url&#39;</span><span class="o">,</span><span class="s1">&#39;protocol&#39;</span><span class="o">,</span><span class="s1">&#39;status&#39;</span><span class="o">,</span><span class="s1">&#39;bytes&#39;</span><span class="o">]</span>
<span class="n">regex</span> <span class="o">=</span> <span class="s">/^(\S+) (\S+) (\S+) \[([^:]+):(\d+:\d+:\d+) ([^\]]+)\] &quot;(\S+) (.*?) (\S+)&quot; (\S+) (\S+).*$/</span>

<span class="kd">class</span> <span class="nc">Summary</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">hosts</span> <span class="o">=</span> <span class="o">[:]</span>
    <span class="kt">def</span> <span class="n">what</span> <span class="o">=</span> <span class="o">[:]</span>
    <span class="kt">def</span> <span class="n">accessCount</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="kt">def</span> <span class="n">postCount</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="kt">def</span> <span class="n">homeCount</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="kt">def</span> <span class="n">totalBytes</span> <span class="o">=</span> <span class="mi">0</span>
<span class="o">}</span>
<span class="n">totals</span> <span class="o">=</span> <span class="o">[:]</span>
<span class="n">LOGFILE</span><span class="o">.</span><span class="na">trim</span><span class="o">().</span><span class="na">split</span><span class="o">(</span><span class="s1">&#39;\n&#39;</span><span class="o">).</span><span class="na">each</span><span class="o">{</span> <span class="n">line</span> <span class="o">-&gt;</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">line</span> <span class="o">=~</span> <span class="n">regex</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">m</span><span class="o">.</span><span class="na">matches</span><span class="o">())</span> <span class="o">{</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">m</span><span class="o">[</span><span class="mi">0</span><span class="o">][</span><span class="n">fields</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="s1">&#39;date&#39;</span><span class="o">)+</span><span class="mi">1</span><span class="o">]</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">totals</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">date</span><span class="o">,</span> <span class="k">new</span> <span class="n">Summary</span><span class="o">())</span>
        <span class="n">s</span><span class="o">.</span><span class="na">accessCount</span><span class="o">++</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">m</span><span class="o">[</span><span class="mi">0</span><span class="o">][</span><span class="n">fields</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="s1">&#39;method&#39;</span><span class="o">)+</span><span class="mi">1</span><span class="o">]</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="o">)</span> <span class="n">s</span><span class="o">.</span><span class="na">postCount</span><span class="o">++</span>
        <span class="n">s</span><span class="o">.</span><span class="na">totalBytes</span> <span class="o">+=</span> <span class="o">(</span><span class="n">m</span><span class="o">[</span><span class="mi">0</span><span class="o">][</span><span class="n">fields</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="s1">&#39;bytes&#39;</span><span class="o">)+</span><span class="mi">1</span><span class="o">]).</span><span class="na">toInteger</span><span class="o">()</span>
        <span class="kt">def</span> <span class="n">url</span> <span class="o">=</span> <span class="n">m</span><span class="o">[</span><span class="mi">0</span><span class="o">][</span><span class="n">fields</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="s1">&#39;url&#39;</span><span class="o">)+</span><span class="mi">1</span><span class="o">]</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">url</span> <span class="o">==</span> <span class="s1">&#39;/&#39;</span><span class="o">)</span> <span class="n">s</span><span class="o">.</span><span class="na">homeCount</span><span class="o">++</span>
        <span class="n">s</span><span class="o">.</span><span class="na">what</span><span class="o">[</span><span class="n">url</span><span class="o">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">what</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">url</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="kt">def</span> <span class="n">host</span> <span class="o">=</span> <span class="n">m</span><span class="o">[</span><span class="mi">0</span><span class="o">][</span><span class="n">fields</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="s1">&#39;client&#39;</span><span class="o">)+</span><span class="mi">1</span><span class="o">]</span>
        <span class="n">s</span><span class="o">.</span><span class="na">hosts</span><span class="o">[</span><span class="n">host</span><span class="o">]</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="na">hosts</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">host</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="n">report</span><span class="o">(</span><span class="s1">&#39;Date&#39;</span><span class="o">,</span><span class="s1">&#39;Hosts&#39;</span><span class="o">,</span><span class="s1">&#39;Accesses&#39;</span><span class="o">,</span><span class="s1">&#39;Unidocs&#39;</span><span class="o">,</span><span class="s1">&#39;POST&#39;</span><span class="o">,</span><span class="s1">&#39;Home&#39;</span><span class="o">,</span><span class="s1">&#39;Bytes&#39;</span><span class="o">)</span>
<span class="n">totals</span><span class="o">.</span><span class="na">each</span><span class="o">{</span> <span class="n">key</span><span class="o">,</span> <span class="n">s</span> <span class="o">-&gt;</span>
    <span class="n">report</span><span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="na">hosts</span><span class="o">.</span><span class="na">size</span><span class="o">(),</span> <span class="n">s</span><span class="o">.</span><span class="na">accessCount</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="na">what</span><span class="o">.</span><span class="na">size</span><span class="o">(),</span> <span class="n">s</span><span class="o">.</span><span class="na">postCount</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="na">homeCount</span><span class="o">,</span> <span class="n">s</span><span class="o">.</span><span class="na">totalBytes</span><span class="o">)</span>
<span class="o">}</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">totals</span><span class="o">.</span><span class="na">values</span><span class="o">()</span>
<span class="n">report</span><span class="o">(</span><span class="s1">&#39;Grand Total&#39;</span><span class="o">,</span> <span class="n">v</span><span class="o">.</span><span class="na">sum</span><span class="o">{</span><span class="n">it</span><span class="o">.</span><span class="na">hosts</span><span class="o">.</span><span class="na">size</span><span class="o">()},</span> <span class="n">v</span><span class="o">.</span><span class="na">sum</span><span class="o">{</span><span class="n">it</span><span class="o">.</span><span class="na">accessCount</span><span class="o">},</span> <span class="n">v</span><span class="o">.</span><span class="na">sum</span><span class="o">{</span><span class="n">it</span><span class="o">.</span><span class="na">what</span><span class="o">.</span><span class="na">size</span><span class="o">()},</span>
        <span class="n">v</span><span class="o">.</span><span class="na">sum</span><span class="o">{</span><span class="n">it</span><span class="o">.</span><span class="na">postCount</span><span class="o">},</span> <span class="n">v</span><span class="o">.</span><span class="na">sum</span><span class="o">{</span><span class="n">it</span><span class="o">.</span><span class="na">homeCount</span><span class="o">},</span> <span class="n">v</span><span class="o">.</span><span class="na">sum</span><span class="o">{</span><span class="n">it</span><span class="o">.</span><span class="na">totalBytes</span><span class="o">}</span> <span class="o">)</span>

<span class="kt">def</span> <span class="nf">report</span><span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">c</span><span class="o">,</span> <span class="n">d</span><span class="o">,</span> <span class="n">e</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">g</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">printf</span> <span class="o">(</span><span class="s2">&quot;%12s %6s %8s %8s %8s %8s %10s\n&quot;</span><span class="o">,</span> <span class="o">[</span><span class="n">a</span><span class="o">,</span><span class="n">b</span><span class="o">,</span><span class="n">c</span><span class="o">,</span><span class="n">d</span><span class="o">,</span><span class="n">e</span><span class="o">,</span><span class="n">f</span><span class="o">,</span><span class="n">g</span><span class="o">])</span>
<span class="o">}</span>
<span class="c1">// =&gt;</span>
<span class="c1">//         Date  Hosts Accesses  Unidocs     POST     Home      Bytes</span>
<span class="c1">//  03/Jul/1996      1        1        1        1        0       5593</span>
<span class="c1">//  10/Oct/2000      1        1        1        0        0       2326</span>
<span class="c1">//  04/Sep/2005      1        2        2        0        1       2230</span>
<span class="c1">//  05/Sep/2005      1        2        1        0        0      12456</span>
<span class="c1">//  26/Apr/2000      3        6        6        0        0    1579790</span>
<span class="c1">//  27/Apr/2000      1        3        3        0        0       5349</span>
<span class="c1">//  Grand Total      8       15       14        1        1    1607744</span>


<span class="c1">// Some open source log processing packages in Java:</span>
<span class="c1">// http://www.generationjava.com/projects/logview/index.shtml</span>
<span class="c1">// http://ostermiller.org/webalizer/</span>
<span class="c1">// http://jxla.nvdcms.org/en/index.xml</span>
<span class="c1">// http://polliwog.sourceforge.net/index.html</span>
<span class="c1">// as well as textual reports, most of these can produce graphical reports</span>
<span class="c1">// Most have their own configuration information and Java extension points.</span>
<span class="c1">//----------------------------------------------------------------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1096"
>Program: htmlsub</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">//----------------------------------------------------------------------------------</span>
 <span class="kn">import</span> <span class="nn">org.cyberneko.html.filters.Writer</span>
 <span class="kn">import</span> <span class="nn">org.cyberneko.html.filters.DefaultFilter</span>
 <span class="kn">import</span> <span class="nn">org.apache.xerces.xni.parser.XMLDocumentFilter</span>
 <span class="kn">import</span> <span class="nn">org.apache.xerces.xni.*</span>
 <span class="kn">import</span> <span class="nn">org.cyberneko.html.parsers.DOMParser</span>
 <span class="kn">import</span> <span class="nn">org.xml.sax.InputSource</span>

 <span class="n">input</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1"> &lt;HTML&gt;&lt;HEAD&gt;&lt;TITLE&gt;Hi!&lt;/TITLE&gt;&lt;/HEAD&gt;&lt;BODY&gt;</span>
<span class="s1"> &lt;H1&gt;Welcome to Scooby World!&lt;/H1&gt;</span>
<span class="s1"> I have &lt;A HREF=&quot;pictures.html&quot;&gt;pictures&lt;/A&gt; of the crazy dog</span>
<span class="s1"> himself. Here&#39;</span><span class="n">s</span> <span class="n">one</span><span class="o">!&lt;</span><span class="n">P</span><span class="o">&gt;</span>
 <span class="o">&lt;</span><span class="n">IMG</span> <span class="n">SRC</span><span class="o">=</span><span class="s2">&quot;scooby.jpg&quot;</span> <span class="n">ALT</span><span class="o">=</span><span class="s2">&quot;Good doggy!&quot;</span><span class="o">&gt;&lt;</span><span class="n">P</span><span class="o">&gt;</span>
 <span class="o">&lt;</span><span class="n">BLINK</span><span class="o">&gt;</span><span class="n">He</span><span class="s1">&#39;s my hero!&lt;/BLINK&gt; I would like to meet him some day,</span>
<span class="s1"> and get my picture taken with him.&lt;P&gt;</span>
<span class="s1"> P.S. I am deathly ill. &lt;A HREF=&quot;shergold.html&quot;&gt;Please send</span>
<span class="s1"> cards&lt;/A&gt;.</span>
<span class="s1"> &lt;/BODY&gt;&lt;/HTML&gt;</span>
<span class="s1"> &#39;&#39;&#39;</span>

 <span class="kd">class</span> <span class="nc">WordReplaceFilter</span> <span class="kd">extends</span> <span class="n">DefaultFilter</span> <span class="o">{</span>
     <span class="kd">private</span> <span class="n">before</span><span class="o">,</span> <span class="n">after</span>
     <span class="n">WordReplaceFilter</span><span class="o">(</span><span class="n">b</span><span class="o">,</span> <span class="n">a</span><span class="o">)</span> <span class="o">{</span> <span class="n">before</span> <span class="o">=</span> <span class="n">b</span><span class="o">;</span> <span class="n">after</span> <span class="o">=</span> <span class="n">a</span> <span class="o">}</span>
     <span class="kt">void</span> <span class="nf">characters</span><span class="o">(</span><span class="n">XMLString</span> <span class="n">text</span><span class="o">,</span> <span class="n">Augmentations</span> <span class="n">augs</span><span class="o">)</span> <span class="o">{</span>
         <span class="kt">char</span><span class="o">[]</span> <span class="n">c</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="na">toString</span><span class="o">().</span><span class="na">replaceAll</span><span class="o">(</span><span class="n">before</span><span class="o">,</span> <span class="n">after</span><span class="o">)</span>
         <span class="kd">super</span><span class="o">.</span><span class="na">characters</span><span class="o">(</span><span class="k">new</span> <span class="n">XMLString</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="mi">0</span><span class="o">,</span> <span class="n">c</span><span class="o">.</span><span class="na">size</span><span class="o">()),</span> <span class="n">augs</span><span class="o">)</span>
     <span class="o">}</span>
     <span class="kt">void</span> <span class="nf">setProperty</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">,</span> <span class="n">Object</span> <span class="n">o</span><span class="o">){}</span>
 <span class="o">}</span>
 <span class="n">XMLDocumentFilter</span><span class="o">[]</span> <span class="n">filters</span> <span class="o">=</span> <span class="o">[</span>
     <span class="k">new</span> <span class="nf">WordReplaceFilter</span><span class="o">(</span><span class="s">/(?sm)picture/</span><span class="o">,</span> <span class="s">/photo/</span><span class="o">),</span>
     <span class="k">new</span> <span class="nf">Writer</span><span class="o">()</span>
 <span class="o">]</span>
 <span class="n">parser</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DOMParser</span><span class="o">()</span>
 <span class="n">parser</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s2">&quot;http://cyberneko.org/html/properties/filters&quot;</span><span class="o">,</span> <span class="n">filters</span><span class="o">)</span>
 <span class="n">parser</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="k">new</span> <span class="n">InputSource</span><span class="o">(</span><span class="k">new</span> <span class="n">StringReader</span><span class="o">(</span><span class="n">input</span><span class="o">)))</span>
<span class="c1">//----------------------------------------------------------------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1099"
>Program: hrefsub</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">//----------------------------------------------------------------------------------</span>
<span class="kn">import</span> <span class="nn">org.cyberneko.html.filters.Writer</span>
<span class="kn">import</span> <span class="nn">org.cyberneko.html.filters.DefaultFilter</span>
<span class="kn">import</span> <span class="nn">org.apache.xerces.xni.parser.XMLDocumentFilter</span>
<span class="kn">import</span> <span class="nn">org.apache.xerces.xni.*</span>
<span class="kn">import</span> <span class="nn">org.cyberneko.html.parsers.DOMParser</span>
<span class="kn">import</span> <span class="nn">org.xml.sax.InputSource</span>

<span class="n">input</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">&lt;HTML&gt;&lt;HEAD&gt;&lt;TITLE&gt;Hi!&lt;/TITLE&gt;&lt;/HEAD&gt;&lt;BODY&gt;</span>
<span class="s1">&lt;H1&gt;Welcome to Scooby World!&lt;/H1&gt;</span>
<span class="s1">I have &lt;A HREF=&quot;pictures.html&quot;&gt;pictures&lt;/A&gt; of the crazy dog</span>
<span class="s1">himself. Here&#39;</span><span class="n">s</span> <span class="n">one</span><span class="o">!&lt;</span><span class="n">P</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">IMG</span> <span class="n">SRC</span><span class="o">=</span><span class="s2">&quot;scooby.jpg&quot;</span> <span class="n">ALT</span><span class="o">=</span><span class="s2">&quot;Good doggy!&quot;</span><span class="o">&gt;&lt;</span><span class="n">P</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">BLINK</span><span class="o">&gt;</span><span class="n">He</span><span class="s1">&#39;s my hero!&lt;/BLINK&gt; I would like to meet him some day,</span>
<span class="s1">and get my picture taken with him.&lt;P&gt;</span>
<span class="s1">P.S. I am deathly ill. &lt;A HREF=&quot;shergold.html&quot;&gt;Please send</span>
<span class="s1">cards&lt;/A&gt;.</span>
<span class="s1">&lt;/BODY&gt;&lt;/HTML&gt;</span>
<span class="s1">&#39;&#39;&#39;</span>

<span class="kd">class</span> <span class="nc">HrefReplaceFilter</span> <span class="kd">extends</span> <span class="n">DefaultFilter</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="n">before</span><span class="o">,</span> <span class="n">after</span>
    <span class="n">HrefReplaceFilter</span><span class="o">(</span><span class="n">b</span><span class="o">,</span> <span class="n">a</span><span class="o">)</span> <span class="o">{</span> <span class="n">before</span> <span class="o">=</span> <span class="n">b</span><span class="o">;</span> <span class="n">after</span> <span class="o">=</span> <span class="n">a</span> <span class="o">}</span>
    <span class="kt">void</span> <span class="nf">startElement</span><span class="o">(</span><span class="n">QName</span> <span class="n">element</span><span class="o">,</span> <span class="n">XMLAttributes</span> <span class="n">attributes</span><span class="o">,</span> <span class="n">Augmentations</span> <span class="n">augs</span><span class="o">)</span> <span class="o">{</span>
        <span class="kt">def</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="na">getIndex</span><span class="o">(</span><span class="s1">&#39;href&#39;</span><span class="o">)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">{</span>
            <span class="kt">def</span> <span class="n">newtext</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="na">getValue</span><span class="o">(</span><span class="n">idx</span><span class="o">).</span><span class="na">replaceAll</span><span class="o">(</span><span class="n">before</span><span class="o">,</span> <span class="n">after</span><span class="o">)</span>
            <span class="n">attributes</span><span class="o">.</span><span class="na">setValue</span><span class="o">(</span><span class="n">idx</span><span class="o">,</span> <span class="n">URLEncoder</span><span class="o">.</span><span class="na">encode</span><span class="o">(</span><span class="n">newtext</span><span class="o">))</span>
        <span class="o">}</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">startElement</span><span class="o">(</span><span class="n">element</span><span class="o">,</span> <span class="n">attributes</span><span class="o">,</span> <span class="n">augs</span><span class="o">)</span>
    <span class="o">}</span>
    <span class="kt">void</span> <span class="nf">setProperty</span><span class="o">(</span><span class="n">String</span> <span class="n">s</span><span class="o">,</span> <span class="n">Object</span> <span class="n">o</span><span class="o">){}</span>
<span class="o">}</span>
<span class="n">XMLDocumentFilter</span><span class="o">[]</span> <span class="n">myfilters</span> <span class="o">=</span> <span class="o">[</span>
    <span class="k">new</span> <span class="nf">HrefReplaceFilter</span><span class="o">(</span><span class="s">/shergold.html/</span><span class="o">,</span> <span class="s">/cards.html/</span><span class="o">),</span>
    <span class="k">new</span> <span class="nf">Writer</span><span class="o">()</span>
<span class="o">]</span>
<span class="n">parser</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DOMParser</span><span class="o">()</span>
<span class="n">parser</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="s2">&quot;http://cyberneko.org/html/properties/filters&quot;</span><span class="o">,</span> <span class="n">myfilters</span><span class="o">)</span>
<span class="n">parser</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="k">new</span> <span class="n">InputSource</span><span class="o">(</span><span class="k">new</span> <span class="n">StringReader</span><span class="o">(</span><span class="n">input</span><span class="o">)))</span>
<span class="c1">//----------------------------------------------------------------------------------</span>
</pre></div>
</body>
</html></PRE
></TD
></TR
></TABLE
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="cgiprogramming.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="a1102.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>CGI Programming</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
>&nbsp;</TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Helpers</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN""http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>Dates and Times</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="PLEAC-Groovy"
HREF="index.html"><LINK
REL="PREVIOUS"
TITLE="Numbers"
HREF="numbers.html"><LINK
REL="NEXT"
TITLE="Arrays"
HREF="arrays.html"><style type="text/css">td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
pre { line-height: 125%; }

  </style></head
><BODY TEXT="#cecece" BGCOLOR="#4f6f6f" LINK="#f5deb3" VLINK="#d5ae83"
CLASS="SECT1"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>PLEAC-Groovy</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="numbers.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
></TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="arrays.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="DATESANDTIMES"
>3. Dates and Times</A
></H1
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN132"
>Introduction</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="s"></span><span class="s">//----------------------------------------------------------------------------------</span>
<span class="s">// use Date to get the current time</span>
<span class="s">println new Date()</span>
<span class="s">// =&gt; Mon Jan 01 07:12:32 EST 2007</span>
<span class="s">// use Calendar to compute year, month, day, hour, minute, and second values</span>
<span class="s">cal = Calendar.instance</span>
<span class="s">println &#39;Today is day &#39; + cal.get(Calendar.DAY_OF_YEAR) + &#39; of the current year.&#39;</span>
<span class="s">// =&gt; Today is day 1 of the current year.</span>
<span class="s">// there are other Java Date/Time packages with extended capabilities, e.g.:</span>
<span class="s">//     http://joda-time.sourceforge.net/</span>
<span class="s">// there is a special Grails (grails.codehaus.org) time DSL (see below)</span>
<span class="s">//----------------------------------------------------------------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN135"
>Finding Today's Date</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="s"></span><span class="s">//----------------------------------------------------------------------------------</span>
<span class="s">cal = Calendar.instance</span>
<span class="s">Y = cal.get(Calendar.YEAR)</span>
<span class="s">M = cal.get(Calendar.MONTH) + 1</span>
<span class="s">D = cal.get(Calendar.DATE)</span>
<span class="s">println &quot;The current date is $Y $M $D&quot;</span>
<span class="s">// =&gt; The current date is 2006 04 28</span>
<span class="s">//----------------------------------------------------------------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN138"
>Converting DMYHMS to Epoch Seconds</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="s"></span><span class="s">//----------------------------------------------------------------------------------</span>
<span class="s">// create a calendar with current time and time zone</span>
<span class="s">cal = Calendar.instance</span>
<span class="s">// set time zone using long or short timezone values</span>
<span class="s">cal.timeZone = TimeZone.getTimeZone(&quot;America/Los_Angeles&quot;)</span>
<span class="s">cal.timeZone = TimeZone.getTimeZone(&quot;UTC&quot;)</span>
<span class="s">// set date fields one at a time</span>
<span class="s">cal.set(Calendar.MONTH, Calendar.DECEMBER)</span>
<span class="s">// or several together</span>
<span class="s">//calendar.set(year, month - 1, day, hour, minute, second)</span>
<span class="s">// get time in seconds since EPOCH</span>
<span class="s">long time = cal.time.time / 1000</span>
<span class="s">println time</span>
<span class="s">// =&gt; 1196522682</span>
<span class="s">//----------------------------------------------------------------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN141"
>Converting Epoch Seconds to DMYHMS</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="s"></span><span class="s">//----------------------------------------------------------------------------------</span>
<span class="s">// create a calendar with current time and time zone</span>
<span class="s">cal = Calendar.instance</span>
<span class="s">// set time</span>
<span class="s">cal.time = new Date(time * 1000)</span>
<span class="s">// get date fields</span>
<span class="s">println(&#39;Dateline: &#39;</span>
<span class="s">    + cal.get(Calendar.HOUR_OF_DAY) + &#39;:&#39;</span>
<span class="s">    + cal.get(Calendar.MINUTE) + &#39;:&#39;</span>
<span class="s">    + cal.get(Calendar.SECOND) + &#39;-&#39;</span>
<span class="s">    + cal.get(Calendar.YEAR) + &#39;/&#39;</span>
<span class="s">    + (cal.get(Calendar.MONTH) + 1) + &#39;/&#39;</span>
<span class="s">    + cal.get(Calendar.DATE))</span>
<span class="s">// =&gt; Dateline: 7:33:16-2007/1/1</span>
<span class="s">//----------------------------------------------------------------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN144"
>Adding to or Subtracting from a Date</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="s"></span><span class="s">//----------------------------------------------------------------------------------</span>
<span class="s">import java.text.SimpleDateFormat</span>
<span class="s">long difference = 100</span>
<span class="s">long after = time + difference</span>
<span class="s">long before = time - difference</span>

<span class="s">// any field of a calendar is incrementable via add() and roll() methods</span>
<span class="s">cal = Calendar.instance</span>
<span class="s">df = new SimpleDateFormat()</span>
<span class="s">printCal = {cal -&gt; df.format(cal.time)}</span>
<span class="s">cal.set(2000, 0, 1, 00, 01, 0)</span>
<span class="s">assert printCal(cal) == &#39;1/01/00 00:01&#39;</span>
<span class="s">// roll minute back by 2 but don&#39;t adjust other fields</span>
<span class="s">cal.roll(Calendar.MINUTE, -2)</span>
<span class="s">assert printCal(cal) == &#39;1/01/00 00:59&#39;</span>
<span class="s">// adjust hour back 1 and adjust other fields if needed</span>
<span class="s">cal.add(Calendar.HOUR, -1)</span>
<span class="s">assert printCal(cal) == &#39;31/12/99 23:59&#39;</span>

<span class="s">// larger example</span>
<span class="s">cal.timeZone = TimeZone.getTimeZone(&quot;UTC&quot;)</span>
<span class="s">cal.set(1973, 0, 18, 3, 45, 50)</span>
<span class="s">cal.add(Calendar.DATE, 55)</span>
<span class="s">cal.add(Calendar.HOUR_OF_DAY, 2)</span>
<span class="s">cal.add(Calendar.MINUTE, 17)</span>
<span class="s">cal.add(Calendar.SECOND, 5)</span>
<span class="s">assert printCal(cal) == &#39;14/03/73 16:02&#39;</span>

<span class="s">// alternatively, work with epoch times</span>
<span class="s">long birthTime = 96176750359       // 18/Jan/1973, 3:45:50 am</span>
<span class="s">long interval = 5 +                // 5 second</span>
<span class="s">                17 * 60 +          // 17 minute</span>
<span class="s">                2  * 60 * 60 +     // 2 hour</span>
<span class="s">                55 * 60 * 60 * 24  // and 55 day</span>
<span class="s">then = new Date(birthTime + interval * 1000)</span>
<span class="s">assert df.format(then) == &#39;14/03/73 16:02&#39;</span>

<span class="s">// Alternatively, the Google Data module has a category with DSL-like time support:</span>
<span class="s">// http://docs.codehaus.org/display/GROOVY/Google+Data+Support</span>
<span class="s">// which supports the following syntax</span>
<span class="s">// def interval = 5.seconds + 17.minutes + 2.hours + 55.days</span>
<span class="s">//----------------------------------------------------------------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN147"
>Difference of Two Dates</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="s"></span><span class="s">//----------------------------------------------------------------------------------</span>
<span class="s">bree = 361535725  // 16 Jun 1981, 4:35:25</span>
<span class="s">nat  =  96201950  // 18 Jan 1973, 3:45:50</span>
<span class="s">difference = bree - nat</span>
<span class="s">println &quot;There were $difference seconds between Nat and Bree&quot;</span>
<span class="s">// =&gt; There were 265333775 seconds between Nat and Bree</span>
<span class="s">seconds    =  difference % 60</span>
<span class="s">difference = (difference - seconds) / 60</span>
<span class="s">minutes    =  difference % 60</span>
<span class="s">difference = (difference - minutes) / 60</span>
<span class="s">hours      =  difference % 24</span>
<span class="s">difference = (difference - hours)   / 24</span>
<span class="s">days       =  difference % 7</span>
<span class="s">weeks      = (difference - days)    /  7</span>
<span class="s">println &quot;($weeks weeks, $days days, $hours:$minutes:$seconds)&quot;</span>
<span class="s">// =&gt; (438 weeks, 4 days, 23:49:35)</span>
<span class="s">//----------------------------------------------------------------------------------</span>
<span class="s">cal = Calendar.getInstance(TimeZone.getTimeZone(&quot;UTC&quot;))</span>
<span class="s">cal.set(1981, 5, 16)  // 16 Jun 1981</span>
<span class="s">date1 = cal.time</span>
<span class="s">cal.set(1973, 0, 18)  // 18 Jan 1973</span>
<span class="s">date2 = cal.time</span>
<span class="s">difference = Math.abs(date2.time - date1.time)</span>
<span class="s">days = difference / (1000 * 60 * 60 * 24)</span>
<span class="s">assert days == 3071</span>
<span class="s">//----------------------------------------------------------------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN150"
>Day in a Week/Month/Year or Week Number</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="s"></span><span class="s">//----------------------------------------------------------------------------------</span>
<span class="s">// create a calendar with current time and time zone</span>
<span class="s">cal = Calendar.instance</span>
<span class="s">cal.set(1981, 5, 16)</span>
<span class="s">yearDay = cal.get(Calendar.DAY_OF_YEAR);</span>
<span class="s">year = cal.get(Calendar.YEAR);</span>
<span class="s">yearWeek = cal.get(Calendar.WEEK_OF_YEAR);</span>
<span class="s">df1 = new SimpleDateFormat(&quot;dd/MMM/yy&quot;)</span>
<span class="s">df2 = new SimpleDateFormat(&quot;EEEE&quot;)</span>
<span class="s">print(df1.format(cal.time) + &#39; was a &#39; + df2.format(cal.time))</span>
<span class="s">println &quot; and was day number $yearDay and week number $yearWeek of $year&quot;</span>
<span class="s">// =&gt; 16/Jun/81 was a Tuesday and was day number 167 and week number 25 of 1981</span>
<span class="s">//----------------------------------------------------------------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN153"
>Parsing Dates and Times from Strings</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="s"></span><span class="s">//----------------------------------------------------------------------------------</span>
<span class="s">input = &quot;1998-06-03&quot;</span>
<span class="s">df1 = new SimpleDateFormat(&quot;yyyy-MM-dd&quot;)</span>
<span class="s">date = df1.parse(input)</span>
<span class="s">df2 = new SimpleDateFormat(&quot;MMM/dd/yyyy&quot;)</span>
<span class="s">println &#39;Date was &#39; + df2.format(date)</span>
<span class="s">// =&gt; Date was Jun/03/1998</span>
<span class="s">//----------------------------------------------------------------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN156"
>Printing a Date</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="s"></span><span class="s">//----------------------------------------------------------------------------------</span>
<span class="s">import java.text.DateFormat</span>
<span class="s">df = new SimpleDateFormat(&#39;E M d hh:mm:ss z yyyy&#39;)</span>
<span class="s">cal.set(2007, 0, 1)</span>
<span class="s">println &#39;Customized format gives: &#39; + df.format(cal.time)</span>
<span class="s">// =&gt; Mon 1 1 09:02:29 EST 2007 (differs depending on your timezone)</span>
<span class="s">df = DateFormat.getDateInstance(DateFormat.FULL, Locale.FRANCE)</span>
<span class="s">println &#39;Customized format gives: &#39; + df.format(cal.time)</span>
<span class="s">// =&gt; lundi 1 janvier 2007</span>
<span class="s">//----------------------------------------------------------------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN159"
>High-Resolution Timers</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="s"></span><span class="s">//----------------------------------------------------------------------------------</span>
<span class="s">// script:</span>
<span class="s">println &#39;Press return when ready&#39;</span>
<span class="s">before = System.currentTimeMillis()</span>
<span class="s">input = new BufferedReader(new InputStreamReader(System.in)).readLine()</span>
<span class="s">after = System.currentTimeMillis()</span>
<span class="s">elapsed = (after - before) / 1000</span>
<span class="s">println &quot;You took $elapsed seconds.&quot;</span>
<span class="s">// =&gt; You took2.313 seconds.</span>

<span class="s">// take mean sorting time</span>
<span class="s">size = 500; number = 100; total = 0</span>
<span class="s">for (i in 0..&lt;number) {</span>
<span class="s">    array = []</span>
<span class="s">    size.times{ array &lt;&lt; Math.random() }</span>
<span class="s">    doubles = array as double[]</span>
<span class="s">    // sort it</span>
<span class="s">    long t0 = System.currentTimeMillis()</span>
<span class="s">    Arrays.sort(doubles)</span>
<span class="s">    long t1 = System.currentTimeMillis()</span>
<span class="s">    total += (t1 - t0)</span>
<span class="s">}</span>
<span class="s">println &quot;On average, sorting $size random numbers takes ${total / number} milliseconds&quot;</span>
<span class="s">// =&gt; On average, sorting 500 random numbers takes 0.32 milliseconds</span>
<span class="s">//----------------------------------------------------------------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN162"
>Short Sleeps</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="s"></span><span class="s">//----------------------------------------------------------------------------------</span>
<span class="s">delayMillis = 50</span>
<span class="s">Thread.sleep(delayMillis)</span>
<span class="s">//----------------------------------------------------------------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN165"
>Program: hopdelta</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="s"></span><span class="s">//----------------------------------------------------------------------------------</span>
<span class="s">// this could be done more simply using JavaMail&#39;s getAllHeaderLines() but is shown</span>
<span class="s">// in long hand for illustrative purposes</span>
<span class="s">sampleMessage = &#39;&#39;&#39;Delivered-To: alias-someone@somewhere.com.au</span>
<span class="s">Received: (qmail 27284 invoked from network); 30 Dec 2006 15:16:26 -0000</span>
<span class="s">Received: from unknown (HELO lists-outbound.sourceforge.net) (66.35.250.225)</span>
<span class="s">  by bne012m.server-web.com with SMTP; 30 Dec 2006 15:16:25 -0000</span>
<span class="s">Received: from sc8-sf-list2-new.sourceforge.net (sc8-sf-list2-new-b.sourceforge.net [10.3.1.94])</span>
<span class="s">    by sc8-sf-spam2.sourceforge.net (Postfix) with ESMTP</span>
<span class="s">    id D8CCBFDE3; Sat, 30 Dec 2006 07:16:24 -0800 (PST)</span>
<span class="s">Received: from sc8-sf-mx1-b.sourceforge.net ([10.3.1.91]</span>
<span class="s">    helo=mail.sourceforge.net)</span>
<span class="s">    by sc8-sf-list2-new.sourceforge.net with esmtp (Exim 4.43)</span>
<span class="s">    id 1H0fwX-0003c0-GA</span>
<span class="s">    for pleac-discuss@lists.sourceforge.net; Sat, 30 Dec 2006 07:16:20 -0800</span>
<span class="s">Received: from omta05ps.mx.bigpond.com ([144.140.83.195])</span>
<span class="s">    by mail.sourceforge.net with esmtp (Exim 4.44) id 1H0fwY-0005D4-DD</span>
<span class="s">    for pleac-discuss@lists.sourceforge.net; Sat, 30 Dec 2006 07:16:19 -0800</span>
<span class="s">Received: from win2K001 ([138.130.127.127]) by omta05ps.mx.bigpond.com</span>
<span class="s">    with SMTP</span>
<span class="s">    id &lt;20061230151611.XVWL19269.omta05ps.mx.bigpond.com@win2K001&gt;;</span>
<span class="s">    Sat, 30 Dec 2006 15:16:11 +0000</span>
<span class="s">From: someone@somewhere.com</span>
<span class="s">To: &lt;pleac-discuss@lists.sourceforge.net&gt;</span>
<span class="s">Date: Sun, 31 Dec 2006 02:14:57 +1100</span>
<span class="s">Subject: Re: [Pleac-discuss] C/Posix/GNU - @@pleac@@_10x</span>
<span class="s">Content-Type: text/plain; charset=&quot;us-ascii&quot;</span>
<span class="s">Content-Transfer-Encoding: 7bit</span>
<span class="s">Sender: pleac-discuss-bounces@lists.sourceforge.net</span>
<span class="s">Errors-To: pleac-discuss-bounces@lists.sourceforge.net</span>

<span class="s">----- Original Message -----</span>
<span class="s">From: someone@somewhere.com</span>
<span class="s">To: otherperson@somewhereelse.com</span>
<span class="s">Cc: &lt;pleac-discuss@lists.sourceforge.net&gt;</span>
<span class="s">Sent: Wednesday, December 27, 2006 9:18 AM</span>
<span class="s">Subject: Re: [Pleac-discuss] C/Posix/GNU - @@pleac@@_10x</span>

<span class="s">I really like that description of PLEAC.</span>
<span class="s">&#39;&#39;&#39;</span>
<span class="s">expected = &#39;&#39;&#39;</span>
<span class="s">Sender                    Recipient                 Time              Delta</span>
<span class="s">&lt;origin&gt;                  somewhere.com             01:14:57 06/12/31 </span>
<span class="s">win2K001                  omta05ps.mx.bigpond.com   01:14:57 06/12/31 1m 14s</span>
<span class="s">omta05ps.mx.bigpond.com   mail.sourceforge.net      01:16:11 06/12/31 8s</span>
<span class="s">sc8-sf-mx1-b.sourceforge. sc8-sf-list2-new.sourcefo 01:16:19 06/12/31 1s</span>
<span class="s">sc8-sf-list2-new.sourcefo sc8-sf-spam2.sourceforge. 01:16:20 06/12/31 4s</span>
<span class="s">unknown                   bne012m.server-web.com    01:16:24 06/12/31 1s</span>
<span class="s">&#39;&#39;&#39;</span>

<span class="s">class MailHopDelta {</span>
<span class="s">    def headers, firstSender, firstDate, out</span>

<span class="s">    MailHopDelta(mail) {</span>
<span class="s">        extractHeaders(mail)</span>
<span class="s">        out = new StringBuffer()</span>
<span class="s">        def m = (mail =~ /(?m)^Date:\s+(.*)/)</span>
<span class="s">        firstDate = parseDate(m[0][1])</span>
<span class="s">        firstSender = (mail =~ /(?m)^From.*\@([^\s&gt;]*)/)[0][1]</span>
<span class="s">        out(&#39;Sender Recipient Time Delta&#39;.split(&#39; &#39;))</span>
<span class="s">    }</span>

<span class="s">    def parseDate(date) {</span>
<span class="s">        try {</span>
<span class="s">            return new SimpleDateFormat(&#39;EEE, dd MMM yyyy hh:mm:ss Z&#39;).parse(date)</span>
<span class="s">        } catch(java.text.ParseException ex) {}</span>
<span class="s">        try {</span>
<span class="s">            return new SimpleDateFormat(&#39;dd MMM yyyy hh:mm:ss Z&#39;).parse(date)</span>
<span class="s">        } catch(java.text.ParseException ex) {}</span>
<span class="s">        try {</span>
<span class="s">            return DateFormat.getDateInstance(DateFormat.FULL).parse(date)</span>
<span class="s">        } catch(java.text.ParseException ex) {}</span>
<span class="s">        DateFormat.getDateInstance(DateFormat.LONG).parse(date)</span>
<span class="s">    }</span>

<span class="s">    def extractHeaders(mail) {</span>
<span class="s">        headers = []</span>
<span class="s">        def isHeader = true</span>
<span class="s">        def currentHeader = &#39;&#39;</span>
<span class="s">        mail.split(&#39;\n&#39;).each{ line -&gt;</span>
<span class="s">            if (!isHeader) return</span>
<span class="s">            switch(line) {</span>
<span class="s">                case ~/^\s*$/:</span>
<span class="s">                    isHeader = false</span>
<span class="s">                    if (currentHeader) headers &lt;&lt; currentHeader</span>
<span class="s">                    break</span>
<span class="s">                case ~/^\s+.*/:</span>
<span class="s">                    currentHeader += line; break</span>
<span class="s">                default:</span>
<span class="s">                    if (currentHeader) headers &lt;&lt; currentHeader</span>
<span class="s">                    currentHeader = line</span>
<span class="s">            }</span>
<span class="s">        }</span>
<span class="s">    }</span>

<span class="s">    def out(line) {</span>
<span class="s">        out &lt;&lt; line[0][0..&lt;[25,line[0].size()].min()].padRight(26)</span>
<span class="s">        out &lt;&lt; line[1][0..&lt;[25,line[1].size()].min()].padRight(26)</span>
<span class="s">        out &lt;&lt; line[2].padRight(17) + &#39; &#39;</span>
<span class="s">        out &lt;&lt; line[3] + &#39;\n&#39;</span>
<span class="s">    }</span>

<span class="s">    def prettyDate(date) {</span>
<span class="s">        new SimpleDateFormat(&#39;hh:mm:ss yy/MM/dd&#39;).format(date)</span>
<span class="s">    }</span>

<span class="s">    def process() {</span>
<span class="s">        out([&#39;&lt;origin&gt;&#39;, firstSender, prettyDate(firstDate), &#39;&#39;])</span>
<span class="s">        def prevDate = firstDate</span>
<span class="s">        headers.grep(~/^Received:\sfrom.*/).reverseEach{ hop -&gt;</span>
<span class="s">            def from = (hop =~ /from\s+(\S+)|\((.*?)\)/)[0][1]</span>
<span class="s">            def by   = (hop =~ /by\s+(\S+\.\S+)/)[0][1]</span>
<span class="s">            def hopDate = parseDate(hop[hop.lastIndexOf(&#39;;&#39;)+2..-1])</span>
<span class="s">            out([from, by, prettyDate(prevDate), prettyDelta(hopDate.time - prevDate.time)])</span>
<span class="s">            prevDate = hopDate</span>
<span class="s">        }</span>
<span class="s">        return out.toString()</span>
<span class="s">    }</span>

<span class="s">    def prettyField(secs, sign, ch, multiplier, sb) {</span>
<span class="s">        def whole = (int)(secs / multiplier)</span>
<span class="s">        if (!whole) return 0</span>
<span class="s">        sb &lt;&lt; &#39;&#39; + (sign * whole) + ch + &#39; &#39;</span>
<span class="s">        return whole * multiplier</span>
<span class="s">    }</span>

<span class="s">    def prettyDelta(millis) {</span>
<span class="s">        def sign = millis &lt; 0 ? -1 : 1</span>
<span class="s">        def secs = (int)Math.abs(millis/1000)</span>
<span class="s">        def sb = new StringBuffer()</span>
<span class="s">        secs -= prettyField(secs, sign, &#39;d&#39;, 60 * 60 * 24, sb)</span>
<span class="s">        secs -= prettyField(secs, sign, &#39;h&#39;, 60 * 60, sb)</span>
<span class="s">        secs -= prettyField(secs, sign, &#39;m&#39;, 60, sb)</span>
<span class="s">        prettyField(secs, sign, &#39;s&#39;, 1, sb)</span>
<span class="s">        return sb.toString().trim()</span>
<span class="s">    }</span>
<span class="s">}</span>

<span class="s">assert &#39;\n&#39; + new MailHopDelta(sampleMessage).process() == expected</span>
<span class="s">//----------------------------------------------------------------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="numbers.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="arrays.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Numbers</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
>&nbsp;</TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Arrays</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>
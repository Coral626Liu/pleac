<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN""http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>CGI Programming</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="PLEAC-Groovy"
HREF="index.html"><LINK
REL="PREVIOUS"
TITLE="Internet Services"
HREF="internetservices.html"><LINK
REL="NEXT"
TITLE="Web Automation"
HREF="webautomation.html"><style type="text/css">td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
pre { line-height: 125%; }

  </style></head
><BODY TEXT="#cecece" BGCOLOR="#4f6f6f" LINK="#f5deb3" VLINK="#d5ae83"
CLASS="SECT1"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>PLEAC-Groovy</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="internetservices.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
></TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="webautomation.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="CGIPROGRAMMING"
>19. CGI Programming</A
></H1
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1007"
>Introduction</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">//----------------------------------------------------------------------------------</span>
<span class="c1">// URLs have the same form as in Perl</span>

<span class="c1">// Invoking dynamic content is done through the same standard urls:</span>
<span class="c1">// http://mox.perl.com/cgi-bin/program?name=Johann&amp;born=1685</span>
<span class="c1">// http://mox.perl.com/cgi-bin/program</span>

<span class="c1">// Groovy has Groovelets and GSP page support built-in. For a full</span>
<span class="c1">// web framework, see Grails: http://grails.codehaus.org/</span>
<span class="c1">//----------------------------------------------------------------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1010"
>Writing a CGI Script</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">//----------------------------------------------------------------------------------</span>
<span class="c1">// as a plain groovelet</span>
<span class="n">param</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s1">&#39;PARAM_NAME&#39;</span><span class="o">)</span>
<span class="n">println</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">&lt;html&gt;&lt;head&gt;</span>
<span class="s2">&lt;title&gt;Howdy there!&lt;/title&gt;</span>
<span class="s2">&lt;/head&gt;</span>
<span class="s2">&lt;body&gt;</span>
<span class="s2">&lt;p&gt;</span>
<span class="s2">You typed: $param</span>
<span class="s2">&lt;/p&gt;</span>
<span class="s2">&lt;/body&gt;</span>
<span class="s2">&lt;/html&gt;</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="c1">// as a groovelet using markup builder</span>
<span class="kn">import</span> <span class="nn">groovy.xml.MarkupBuilder</span>
<span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringWriter</span><span class="o">()</span>
<span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MarkupBuilder</span><span class="o">(</span><span class="n">writer</span><span class="o">)</span>
<span class="n">builder</span><span class="o">.</span><span class="na">html</span> <span class="o">{</span>
    <span class="n">head</span> <span class="o">{</span>
        <span class="n">title</span> <span class="s1">&#39;Howdy there!&#39;</span>
    <span class="o">}</span>
    <span class="n">body</span> <span class="o">{</span>
        <span class="n">p</span><span class="o">(</span><span class="s1">&#39;You typed: &#39;</span> <span class="o">+</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s1">&#39;PARAM_NAME&#39;</span><span class="o">))</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="n">println</span> <span class="n">writer</span><span class="o">.</span><span class="na">toString</span><span class="o">()</span>

<span class="c1">// as a GSP page:</span>
<span class="o">&lt;</span><span class="n">html</span><span class="o">&gt;&lt;</span><span class="n">head</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">title</span><span class="o">&gt;</span><span class="n">Howdy</span> <span class="n">there</span><span class="o">!&lt;</span><span class="s">/title&gt;</span>
<span class="s">&lt;/</span><span class="n">head</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">body</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">p</span><span class="o">&gt;</span>
<span class="n">You</span> <span class="nl">typed:</span> <span class="n">$</span><span class="o">{</span><span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s1">&#39;PARAM_NAME&#39;</span><span class="o">)}</span>
<span class="o">&lt;</span><span class="s">/p&gt;</span>
<span class="s">&lt;/</span><span class="n">body</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="s">/html&gt;</span>

<span class="s">// Request parameters are often encoded by the browser before</span>
<span class="s">// sending to the server and usually can be printed out as is.</span>
<span class="s">// If you need to convert, use commons lang StringEscapeUtils#escapeHtml()</span>
<span class="s">// and StringEscapeUtils#unescapeHtml().</span>

<span class="s">// Getting parameters:</span>
<span class="s">who = request.getParameter(&#39;Name&#39;)</span>
<span class="s">phone = request.getParameter(&#39;Number&#39;)</span>
<span class="s">picks = request.getParameterValues(&#39;Choices&#39;) // String array or null</span>

<span class="s">// Changing headers:</span>
<span class="s">response.setContentType(&#39;text/</span><span class="n">html</span><span class="o">;</span><span class="n">charset</span><span class="o">=</span><span class="n">UTF</span><span class="o">-</span><span class="mi">8</span><span class="s1">&#39;)</span>
<span class="s1">response.setContentType(&#39;</span><span class="n">text</span><span class="s">/plain&#39;)</span>
<span class="s">response.setContentType(&#39;text/</span><span class="n">plain</span><span class="s1">&#39;)</span>
<span class="s1">response.setHeader(&#39;</span><span class="n">Cache</span><span class="o">-</span><span class="n">control</span><span class="s1">&#39;, &#39;</span><span class="n">no</span><span class="o">-</span><span class="n">cache</span><span class="s1">&#39;)</span>
<span class="s1">response.setDateHeader(&#39;</span><span class="n">Expires</span><span class="s1">&#39;, System.currentTimeMillis() + 3*24*60*60*1000)</span>
<span class="s1">//----------------------------------------------------------------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1013"
>Redirecting Error Messages</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="s1"></span><span class="s1">//----------------------------------------------------------------------------------</span>
<span class="s1">// The Java Servlet API has a special log() method for writing to the</span>
<span class="s1">// web server log.</span>

<span class="s1">// To send errors to custom HTML pages, update the web.xml deployment</span>
<span class="s1">// descriptor to include one or more &lt;error-page&gt; elements, e.g.:</span>
<span class="s1">&lt;error-page&gt;</span>
<span class="s1">    &lt;error-code&gt;404&lt;/error-code&gt;</span>
<span class="s1">    &lt;location&gt;/404.html&lt;/location&gt;</span>
<span class="s1">&lt;/error-page&gt;</span>
<span class="s1">&lt;error-page&gt;</span>
<span class="s1">    &lt;exception-type&gt;java.lang.NullPointerException&lt;/exception-type&gt;</span>
<span class="s1">    &lt;location&gt;/NpeError.gsp&lt;/location&gt;</span>
<span class="s1">&lt;/error-page&gt;</span>

<span class="s1">// Another trick is to catch an exception within the servlet/gsp code</span>
<span class="s1">// and print it out into the HTML as a comment.</span>
<span class="s1">//----------------------------------------------------------------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1016"
>Fixing a 500 Server Error</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="s1"></span><span class="s1">//----------------------------------------------------------------------------------</span>
<span class="s1">// 500 errors could occur if you have compile errors in your script.</span>
<span class="s1">// Pre-compile with your IDE or groovyc.</span>

<span class="s1">// You can use an expando, mock or map to run your scripts outside</span>
<span class="s1">// the web container environment. If you use Jetty as your container</span>
<span class="s1">// it has a special servlet tester, for more details:</span>
<span class="s1">// http://blogs.webtide.com/gregw/2006/12/16/1166307599250.html</span>
<span class="s1">//----------------------------------------------------------------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1019"
>Writing a Safe CGI Program</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="s1"></span><span class="s1">//----------------------------------------------------------------------------------</span>
<span class="s1">// Web servers should be invoked with an appropriate Java security policy in place.</span>
<span class="s1">// This can be used to limit possible actions from hacking attempts.</span>

<span class="s1">// Normal practices limit hacking exposure. The JDBC API encourages the use</span>
<span class="s1">// of Prepared queries rather than encouraging practices which lead to SQL</span>
<span class="s1">// injection. Using system or exec is rarely used either as Java provides</span>
<span class="s1">// cross-platform mechanisms for most operating system level functionality.</span>

<span class="s1">// Other security measures should be complemented with SSL and authentication.</span>
<span class="s1">//----------------------------------------------------------------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1022"
>Making CGI Scripts Efficient</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="s1"></span><span class="s1">//----------------------------------------------------------------------------------</span>
<span class="s1">// Within the servlet element of your web.xml, there is a &lt;load-on-startup&gt; element.</span>
<span class="s1">// Use that on a per servlet basis to pre-load whichever servlets you like.</span>
<span class="s1">//----------------------------------------------------------------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1025"
>Executing Commands Without Shell Escapes</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="s1"></span><span class="s1">//----------------------------------------------------------------------------------</span>
<span class="s1">// As discussed in 19.3 and 19.4:</span>
<span class="s1">// Web servers should be invoked with an appropriate Java security policy in place.</span>
<span class="s1">// This can be used to limit possible actions from hacking attempts.</span>

<span class="s1">// Normal practices limit hacking exposure. The JDBC API encourages the use</span>
<span class="s1">// of Prepared queries rather than encouraging practices which lead to SQL</span>
<span class="s1">// injection. Using system or exec is rarely used either as Java provides</span>
<span class="s1">// cross-platform mechanisms for most operating system level functionality.</span>

<span class="s1">// In addition, if authentication is used, security can be locked down at a</span>
<span class="s1">// very fine-grained level on a per servlet action or per user (with JAAS) basis.</span>
<span class="s1">//----------------------------------------------------------------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1028"
>Formatting Lists and Tables with HTML Shortcuts</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="s1"></span><span class="s1">//----------------------------------------------------------------------------------</span>
<span class="s1">import groovy.xml.*</span>
<span class="s1">// using a builder:</span>
<span class="s1">Closure markup = {</span>
<span class="s1">    ol {</span>
<span class="s1">        [&#39;</span><span class="n">red</span><span class="s1">&#39;,&#39;</span><span class="n">blue</span><span class="s1">&#39;,&#39;</span><span class="n">green</span><span class="s1">&#39;].each{ li(it) }</span>
<span class="s1">    }</span>
<span class="s1">}</span>
<span class="s1">println new StreamingMarkupBuilder().bind(markup).toString()</span>
<span class="s1">// =&gt; &lt;ol&gt;&lt;li&gt;red&lt;/li&gt;&lt;li&gt;blue&lt;/li&gt;&lt;li&gt;green&lt;/li&gt;&lt;/ol&gt;</span>

<span class="s1">names = &#39;</span><span class="n">Larry</span> <span class="n">Moe</span> <span class="n">Curly</span><span class="s1">&#39;.split(&#39;</span> <span class="s1">&#39;)</span>
<span class="s1">markup = {</span>
<span class="s1">    ul {</span>
<span class="s1">        names.each{ li(type:&#39;</span><span class="n">disc</span><span class="s1">&#39;, it) }</span>
<span class="s1">    }</span>
<span class="s1">}</span>
<span class="s1">println new StreamingMarkupBuilder().bind(markup).toString()</span>
<span class="s1">// &lt;ul&gt;&lt;li type=&quot;disc&quot;&gt;Larry&lt;/li&gt;&lt;li type=&quot;disc&quot;&gt;Moe&lt;/li&gt;</span>
<span class="s1">//     &lt;li type=&quot;disc&quot;&gt;Curly&lt;/li&gt;&lt;/ul&gt;</span>
<span class="s1">//-----------------------------</span>

<span class="s1">m = { li(&quot;alpha&quot;) }</span>
<span class="s1">println new StreamingMarkupBuilder().bind(m).toString()</span>
<span class="s1">//     &lt;li&gt;alpha&lt;/li&gt;</span>

<span class="s1">m = { [&#39;</span><span class="n">alpha</span><span class="s1">&#39;,&#39;</span><span class="n">omega</span><span class="s1">&#39;].each { li(it) } }</span>
<span class="s1">println new StreamingMarkupBuilder().bind(m).toString()</span>
<span class="s1">//     &lt;li&gt;alpha&lt;/li&gt; &lt;li&gt;omega&lt;/li&gt;</span>
<span class="s1">//-----------------------------</span>

<span class="s1">states = [</span>
<span class="s1">    &quot;Wisconsin&quot;:  [ &quot;Superior&quot;, &quot;Lake Geneva&quot;, &quot;Madison&quot; ],</span>
<span class="s1">    &quot;Colorado&quot;:   [ &quot;Denver&quot;, &quot;Fort Collins&quot;, &quot;Boulder&quot; ],</span>
<span class="s1">    &quot;Texas&quot;:      [ &quot;Plano&quot;, &quot;Austin&quot;, &quot;Fort Stockton&quot; ],</span>
<span class="s1">    &quot;California&quot;: [ &quot;Sebastopol&quot;, &quot;Santa Rosa&quot;, &quot;Berkeley&quot; ],</span>
<span class="s1">]</span>

<span class="s1">writer = new StringWriter()</span>
<span class="s1">builder = new MarkupBuilder(writer)</span>
<span class="s1">builder.table{</span>
<span class="s1">    caption(&#39;</span><span class="n">Cities</span> <span class="n">I</span> <span class="n">Have</span> <span class="n">Known</span><span class="s1">&#39;)</span>
<span class="s1">    tr{ th(&#39;</span><span class="n">State</span><span class="s1">&#39;); th(colspan:3, &#39;</span><span class="n">Cities</span><span class="s1">&#39;) }</span>
<span class="s1">    states.keySet().sort().each{ state -&gt;</span>
<span class="s1">        tr{</span>
<span class="s1">            th(state)</span>
<span class="s1">            states[state].sort().each{ td(it) }</span>
<span class="s1">        }</span>
<span class="s1">    }</span>
<span class="s1">}</span>
<span class="s1">println writer.toString()</span>
<span class="s1">// =&gt;</span>
<span class="s1">// &lt;table&gt;</span>
<span class="s1">//   &lt;caption&gt;Cities I Have Known&lt;/caption&gt;</span>
<span class="s1">//   &lt;tr&gt;</span>
<span class="s1">//     &lt;th&gt;State&lt;/th&gt;</span>
<span class="s1">//     &lt;th colspan=&#39;</span><span class="mi">3</span><span class="s1">&#39;&gt;Cities&lt;/th&gt;</span>
<span class="s1">//   &lt;/tr&gt;</span>
<span class="s1">//   &lt;tr&gt;</span>
<span class="s1">//     &lt;th&gt;California&lt;/th&gt;</span>
<span class="s1">//     &lt;td&gt;Berkeley&lt;/td&gt;</span>
<span class="s1">//     &lt;td&gt;Santa Rosa&lt;/td&gt;</span>
<span class="s1">//     &lt;td&gt;Sebastopol&lt;/td&gt;</span>
<span class="s1">//   &lt;/tr&gt;</span>
<span class="s1">//   &lt;tr&gt;</span>
<span class="s1">//     &lt;th&gt;Colorado&lt;/th&gt;</span>
<span class="s1">//     &lt;td&gt;Boulder&lt;/td&gt;</span>
<span class="s1">//     &lt;td&gt;Denver&lt;/td&gt;</span>
<span class="s1">//     &lt;td&gt;Fort Collins&lt;/td&gt;</span>
<span class="s1">//   &lt;/tr&gt;</span>
<span class="s1">//   &lt;tr&gt;</span>
<span class="s1">//     &lt;th&gt;Texas&lt;/th&gt;</span>
<span class="s1">//     &lt;td&gt;Austin&lt;/td&gt;</span>
<span class="s1">//     &lt;td&gt;Fort Stockton&lt;/td&gt;</span>
<span class="s1">//     &lt;td&gt;Plano&lt;/td&gt;</span>
<span class="s1">//   &lt;/tr&gt;</span>
<span class="s1">//   &lt;tr&gt;</span>
<span class="s1">//     &lt;th&gt;Wisconsin&lt;/th&gt;</span>
<span class="s1">//     &lt;td&gt;Lake Geneva&lt;/td&gt;</span>
<span class="s1">//     &lt;td&gt;Madison&lt;/td&gt;</span>
<span class="s1">//     &lt;td&gt;Superior&lt;/td&gt;</span>
<span class="s1">//   &lt;/tr&gt;</span>
<span class="s1">// &lt;/table&gt;</span>

<span class="s1">import groovy.sql.Sql</span>
<span class="s1">import groovy.xml.MarkupBuilder</span>

<span class="s1">dbHandle = null</span>
<span class="s1">dbUrl = &#39;</span><span class="nl">jdbc:hsqldb:</span><span class="o">...</span><span class="s1">&#39;</span>
<span class="s1">def getDb(){</span>
<span class="s1">    if (dbHandle) return dbHandle</span>
<span class="s1">    def source = new org.hsqldb.jdbc.jdbcDataSource()</span>
<span class="s1">    source.database = dbUrl</span>
<span class="s1">    source.user = &#39;</span><span class="n">sa</span><span class="s1">&#39;</span>
<span class="s1">    source.password = &#39;&#39;</span>
<span class="s1">    dbHandle = new Sql(source)</span>
<span class="s1">    return dbHandle</span>
<span class="s1">}</span>

<span class="s1">def findByLimit(limit) {</span>
<span class="s1">    db.rows &quot;SELECT name,salary FROM employees where salary &gt; $limit&quot;</span>
<span class="s1">}</span>

<span class="s1">limit = request.getParameter(&#39;</span><span class="n">LIMIT</span><span class="s1">&#39;)</span>
<span class="s1">writer = new StringWriter()</span>
<span class="s1">builder = new MarkupBuilder(writer)</span>
<span class="s1">builder.html {</span>
<span class="s1">    head { title(&#39;</span><span class="n">Salary</span> <span class="n">Query</span><span class="s1">&#39;) }</span>
<span class="s1">    h1(&#39;</span><span class="n">Search</span><span class="s1">&#39;)</span>
<span class="s1">    form{</span>
<span class="s1">        p(&#39;</span><span class="n">Enter</span> <span class="n">minimum</span> <span class="n">salary</span><span class="s1">&#39;)</span>
<span class="s1">        input(type:&#39;</span><span class="n">text</span><span class="s1">&#39;, name:&#39;</span><span class="n">LIMIT</span><span class="s1">&#39;)</span>
<span class="s1">        input(type:&#39;</span><span class="n">submit</span><span class="s1">&#39;)</span>
<span class="s1">    }</span>
<span class="s1">    if (limit) {</span>
<span class="s1">        h1(&#39;</span><span class="n">Results</span><span class="s1">&#39;)</span>
<span class="s1">        table(border:1){</span>
<span class="s1">            findByLimit(limit).each{ row -&gt;</span>
<span class="s1">                tr{ td(row.name); td(row.salary) }</span>
<span class="s1">            }</span>
<span class="s1">        }</span>
<span class="s1">    }</span>
<span class="s1">}</span>
<span class="s1">println writer.toString()</span>
<span class="s1">//----------------------------------------------------------------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1031"
>Redirecting to a Different Location</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="s1"></span><span class="s1">//----------------------------------------------------------------------------------</span>
<span class="s1">// The preferred way to redirect to resources within the web application:</span>
<span class="s1">dispatcher = request.getRequestDispatcher(&#39;</span><span class="n">hello</span><span class="o">.</span><span class="na">gsp</span><span class="s1">&#39;)</span>
<span class="s1">dispatcher.forward(request, response)</span>
<span class="s1">// Old versions of web containers allowed this mechanism to also redirect</span>
<span class="s1">// to external resources but this was deemed a potential security risk.</span>

<span class="s1">// The suggested way to external sites (less efficient for internal resources):</span>
<span class="s1">response.sendRedirect(&quot;http://www.perl.com/CPAN/&quot;)</span>

<span class="s1">// set cookie and forward</span>
<span class="s1">oreo = new Cookie(&#39;</span><span class="n">filling</span><span class="s1">&#39;, &#39;</span><span class="n">vanilla</span> <span class="n">creme</span><span class="s1">&#39;)</span>
<span class="s1">THREE_MONTHS = 3 * 30 * 24 * 60 * 60</span>
<span class="s1">oreo.maxAge = THREE_MONTHS</span>
<span class="s1">oreo.domain = &#39;</span><span class="o">.</span><span class="na">pleac</span><span class="o">.</span><span class="na">sourceforge</span><span class="o">.</span><span class="na">net</span><span class="s1">&#39;</span>
<span class="s1">whither = &#39;</span><span class="nl">http:</span><span class="c1">//pleac.sourceforge.net/pleac_ruby/cgiprogramming.html&#39;</span>
<span class="n">response</span><span class="o">.</span><span class="na">addCookie</span><span class="o">(</span><span class="n">oreo</span><span class="o">)</span>
<span class="n">response</span><span class="o">.</span><span class="na">sendRedirect</span><span class="o">(</span><span class="n">whither</span><span class="o">)</span>

<span class="c1">// forward based on user agent</span>
<span class="n">dir</span> <span class="o">=</span> <span class="s1">&#39;http://www.science.uva.nl/%7Emes/jargon&#39;</span>
<span class="n">agent</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="s1">&#39;user-agent&#39;</span><span class="o">)</span>
<span class="n">menu</span> <span class="o">=</span> <span class="o">[</span>
    <span class="o">[</span><span class="s">/Mac/</span><span class="o">,</span> <span class="s1">&#39;m/macintrash.html&#39;</span><span class="o">],</span>
    <span class="o">[</span><span class="s">/Win(dows )?NT/</span><span class="o">,</span> <span class="s1">&#39;e/evilandrude.html&#39;</span><span class="o">],</span>
    <span class="o">[</span><span class="s">/Win|MSIE|WebTV/</span><span class="o">,</span> <span class="s1">&#39;m/microslothwindows.html&#39;</span><span class="o">],</span>
    <span class="o">[</span><span class="s">/Linux/</span><span class="o">,</span> <span class="s1">&#39;l/linux.html&#39;</span><span class="o">],</span>
    <span class="o">[</span><span class="s">/HP-UX/</span><span class="o">,</span> <span class="s1">&#39;h/hpsux.html&#39;</span><span class="o">],</span>
    <span class="o">[</span><span class="s">/SunOS/</span><span class="o">,</span> <span class="s1">&#39;s/scumos.html&#39;</span><span class="o">],</span>
<span class="o">]</span>
<span class="n">page</span> <span class="o">=</span> <span class="s1">&#39;a/aportraitofj.randomhacker.html&#39;</span>
<span class="n">menu</span><span class="o">.</span><span class="na">each</span><span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">agent</span> <span class="o">=~</span> <span class="n">it</span><span class="o">[</span><span class="mi">0</span><span class="o">])</span> <span class="n">page</span> <span class="o">=</span> <span class="n">it</span><span class="o">[</span><span class="mi">1</span><span class="o">]</span>
<span class="o">}</span>
<span class="n">response</span><span class="o">.</span><span class="na">sendRedirect</span><span class="o">(</span><span class="s2">&quot;$dir/$page&quot;</span><span class="o">)</span>

<span class="c1">// no response output</span>
<span class="n">response</span><span class="o">.</span><span class="na">sendError</span><span class="o">(</span><span class="mi">204</span><span class="o">,</span> <span class="s1">&#39;No Response&#39;</span><span class="o">)</span>
<span class="c1">//----------------------------------------------------------------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1034"
>Debugging the Raw HTTP Exchange</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">//----------------------------------------------------------------------------------</span>
<span class="c1">// Consider TCPMON or similar: http://ws.apache.org/commons/tcpmon/</span>
<span class="c1">//----------------------------------------------------------------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1037"
>Managing Cookies</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">//----------------------------------------------------------------------------------</span>
<span class="c1">// helper method</span>
<span class="kn">import</span> <span class="nn">javax.servlet.http.Cookie</span>
<span class="kn">import</span> <span class="nn">groovy.xml.MarkupBuilder</span>

<span class="kt">def</span> <span class="nf">getCookieValue</span><span class="o">(</span><span class="n">cookies</span><span class="o">,</span> <span class="n">cookieName</span><span class="o">,</span> <span class="n">defaultValue</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">cookies</span><span class="o">)</span> <span class="k">for</span> <span class="o">(</span><span class="n">i</span> <span class="k">in</span> <span class="mi">0</span><span class="o">..&lt;</span><span class="n">cookies</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">cookieName</span> <span class="o">==</span> <span class="n">cookies</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">name</span><span class="o">)</span> <span class="k">return</span> <span class="n">cookies</span><span class="o">[</span><span class="n">i</span><span class="o">].</span><span class="na">value</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">defaultValue</span>
<span class="o">}</span>

<span class="n">prefValue</span> <span class="o">=</span> <span class="n">getCookieValue</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">cookies</span><span class="o">,</span> <span class="s1">&#39;preference_name&#39;</span><span class="o">,</span> <span class="s1">&#39;default&#39;</span><span class="o">)</span>
<span class="n">cookie</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Cookie</span><span class="o">(</span><span class="s1">&#39;preference name&#39;</span><span class="o">,</span><span class="s2">&quot;whatever you&#39;d like&quot;</span><span class="o">)</span>
<span class="n">SECONDS_PER_YEAR</span> <span class="o">=</span> <span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">365</span>
<span class="n">cookie</span><span class="o">.</span><span class="na">maxAge</span> <span class="o">=</span> <span class="n">SECONDS_PER_YEAR</span> <span class="o">*</span> <span class="mi">2</span>
<span class="n">response</span><span class="o">.</span><span class="na">addCookie</span><span class="o">(</span><span class="n">cookie</span><span class="o">)</span>

<span class="n">cookname</span> <span class="o">=</span> <span class="s1">&#39;fav_ice_cream&#39;</span>
<span class="n">favorite</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s1">&#39;flavor&#39;</span><span class="o">)</span>
<span class="n">tasty</span>    <span class="o">=</span> <span class="n">getCookieValue</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">cookies</span><span class="o">,</span> <span class="n">cookname</span><span class="o">,</span> <span class="s1">&#39;mint&#39;</span><span class="o">)</span>

<span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringWriter</span><span class="o">()</span>
<span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MarkupBuilder</span><span class="o">(</span><span class="n">writer</span><span class="o">)</span>
<span class="n">builder</span><span class="o">.</span><span class="na">html</span> <span class="o">{</span>
    <span class="n">head</span> <span class="o">{</span> <span class="n">title</span><span class="o">(</span><span class="s1">&#39;Ice Cookies&#39;</span><span class="o">)</span> <span class="o">}</span>
    <span class="n">body</span> <span class="o">{</span>
        <span class="n">h1</span><span class="o">(</span><span class="s1">&#39;Hello Ice Cream&#39;</span><span class="o">)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">favorite</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">p</span><span class="o">(</span><span class="s2">&quot;You chose as your favorite flavor &#39;$favorite&#39;.&quot;</span><span class="o">)</span>
            <span class="n">cookie</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Cookie</span><span class="o">(</span><span class="n">cookname</span><span class="o">,</span> <span class="n">favorite</span><span class="o">)</span>
            <span class="n">ONE_HOUR</span> <span class="o">=</span> <span class="mi">3600</span> <span class="c1">// secs</span>
            <span class="n">cookie</span><span class="o">.</span><span class="na">maxAge</span> <span class="o">=</span> <span class="n">ONE_HOUR</span>
            <span class="n">response</span><span class="o">.</span><span class="na">addCookie</span><span class="o">(</span><span class="n">cookie</span><span class="o">)</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="n">hr</span><span class="o">()</span>
            <span class="n">form</span> <span class="o">{</span>
                <span class="n">p</span><span class="o">(</span><span class="s1">&#39;Please select a flavor: &#39;</span><span class="o">)</span>
                <span class="n">input</span><span class="o">(</span><span class="nl">type:</span><span class="s1">&#39;text&#39;</span><span class="o">,</span> <span class="nl">name:</span><span class="s1">&#39;flavor&#39;</span><span class="o">,</span> <span class="nl">value:</span><span class="n">tasty</span><span class="o">)</span>
            <span class="o">}</span>
            <span class="n">hr</span><span class="o">()</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="n">println</span> <span class="n">writer</span><span class="o">.</span><span class="na">toString</span><span class="o">()</span>
<span class="c1">//----------------------------------------------------------------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1040"
>Creating Sticky Widgets</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">//----------------------------------------------------------------------------------</span>
<span class="kn">import</span> <span class="nn">groovy.xml.MarkupBuilder</span>
<span class="c1">// On Linux systems replace with: &quot;who&quot;.execute().text</span>
<span class="n">fakedWhoInput</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">root tty1 Nov 2 17:57</span>
<span class="s1">hermie tty3 Nov 2 18:43</span>
<span class="s1">hermie tty4 Nov 1 20:01</span>
<span class="s1">sigmund tty2 Nov 2 18:08</span>
<span class="s1">&#39;&#39;&#39;</span><span class="o">.</span><span class="na">trim</span><span class="o">().</span><span class="na">split</span><span class="o">(</span><span class="s">/\n/</span><span class="o">)</span>
<span class="n">name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s1">&#39;WHO&#39;</span><span class="o">)</span>
<span class="k">if</span> <span class="o">(!</span><span class="n">name</span><span class="o">)</span> <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
<span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringWriter</span><span class="o">()</span>
<span class="k">new</span> <span class="nf">MarkupBuilder</span><span class="o">(</span><span class="n">writer</span><span class="o">).</span><span class="na">html</span><span class="o">{</span>
    <span class="n">head</span><span class="o">{</span> <span class="n">title</span><span class="o">(</span><span class="s1">&#39;Query Users&#39;</span><span class="o">)</span> <span class="o">}</span>
    <span class="n">body</span><span class="o">{</span>
        <span class="n">h1</span><span class="o">(</span><span class="s1">&#39;Search&#39;</span><span class="o">)</span>
        <span class="n">form</span><span class="o">{</span>
            <span class="n">p</span><span class="o">(</span><span class="s1">&#39;Which User?&#39;</span><span class="o">)</span>
            <span class="n">input</span><span class="o">(</span><span class="nl">type:</span><span class="s1">&#39;text&#39;</span><span class="o">,</span> <span class="nl">name:</span><span class="s1">&#39;WHO&#39;</span><span class="o">,</span> <span class="nl">value:</span><span class="n">name</span><span class="o">)</span>
            <span class="n">input</span><span class="o">(</span><span class="nl">type:</span><span class="s1">&#39;submit&#39;</span><span class="o">)</span>
        <span class="o">}</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">name</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">h1</span><span class="o">(</span><span class="s1">&#39;Results&#39;</span><span class="o">)</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">fakedWhoInput</span><span class="o">.</span><span class="na">grep</span><span class="o">(~</span><span class="s">/^$name\s.*/</span><span class="o">)</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">lines</span><span class="o">)</span> <span class="n">message</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="na">join</span><span class="o">(</span><span class="s1">&#39;\n&#39;</span><span class="o">)</span>
            <span class="k">else</span> <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;$name is not logged in&quot;</span>
            <span class="n">pre</span><span class="o">(</span><span class="n">message</span><span class="o">)</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="n">println</span> <span class="n">writer</span><span class="o">.</span><span class="na">toString</span><span class="o">()</span>
<span class="c1">// if you need to escape special symbols, e.g. &#39;&lt;&#39; or &#39;&gt;&#39; use commons lang StringEscapeUtils</span>
<span class="c1">//----------------------------------------------------------------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1043"
>Writing a Multiscreen CGI Script</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">//----------------------------------------------------------------------------------</span>
<span class="c1">// frameworks typically do this for you, but shown here are the manual steps</span>
<span class="c1">// even when doing it manually, you would probably use session variables</span>

<span class="c1">// setting a hidden field</span>
<span class="n">input</span><span class="o">(</span><span class="nl">type:</span><span class="s1">&#39;hidden&#39;</span><span class="o">,</span> <span class="nl">value:</span><span class="s1">&#39;bacon&#39;</span><span class="o">)</span>

<span class="c1">// setting a value on the submit</span>
<span class="n">input</span><span class="o">(</span><span class="nl">type:</span><span class="s1">&#39;submit&#39;</span><span class="o">,</span> <span class="nl">name:</span><span class="s2">&quot;.State&quot;</span><span class="o">,</span> <span class="nl">value:</span><span class="s1">&#39;Checkout&#39;</span><span class="o">)</span>

<span class="c1">// determining &#39;mode&#39;</span>
<span class="n">page</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s1">&#39;.State&#39;</span><span class="o">)</span>
<span class="k">if</span> <span class="o">(!</span><span class="n">page</span><span class="o">)</span> <span class="n">page</span> <span class="o">=</span> <span class="s1">&#39;Default&#39;</span>

<span class="c1">// forking with if chain</span>
<span class="k">if</span> <span class="o">(</span><span class="n">page</span> <span class="o">==</span> <span class="s2">&quot;Default&quot;</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">frontPage</span><span class="o">()</span>
<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">page</span> <span class="o">==</span> <span class="s2">&quot;Checkout&quot;</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">checkout</span><span class="o">()</span>
<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
    <span class="n">noSuchPage</span><span class="o">()</span>
<span class="o">}</span>

<span class="c1">// forking with map</span>
<span class="n">states</span> <span class="o">=</span> <span class="o">[</span>
    <span class="nl">Default:</span>  <span class="k">this</span><span class="o">.&amp;</span><span class="n">frontPage</span><span class="o">,</span>
    <span class="nl">Shirt:</span>    <span class="k">this</span><span class="o">.&amp;</span><span class="n">tShirt</span><span class="o">,</span>
    <span class="nl">Sweater:</span>  <span class="k">this</span><span class="o">.&amp;</span><span class="n">sweater</span><span class="o">,</span>
    <span class="nl">Checkout:</span> <span class="k">this</span><span class="o">.&amp;</span><span class="n">checkout</span><span class="o">,</span>
    <span class="nl">Card:</span>     <span class="k">this</span><span class="o">.&amp;</span><span class="n">creditCard</span><span class="o">,</span>
    <span class="nl">Order:</span>    <span class="k">this</span><span class="o">.&amp;</span><span class="n">order</span><span class="o">,</span>
    <span class="nl">Cancel:</span>   <span class="k">this</span><span class="o">.&amp;</span><span class="n">frontPage</span><span class="o">,</span>
<span class="o">]</span>

<span class="c1">// calling each to allow hidden variable saving</span>
<span class="n">states</span><span class="o">.</span><span class="na">each</span><span class="o">{</span> <span class="n">key</span><span class="o">,</span> <span class="n">closure</span> <span class="o">-&gt;</span>
    <span class="n">closure</span><span class="o">(</span><span class="n">page</span> <span class="o">==</span> <span class="n">key</span><span class="o">)</span>
<span class="o">}</span>

<span class="c1">// exemplar method</span>
<span class="kt">def</span> <span class="nf">tShirt</span><span class="o">(</span><span class="n">active</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">sizes</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;XL&#39;</span><span class="o">,</span> <span class="s1">&#39;L&#39;</span><span class="o">,</span> <span class="s1">&#39;M&#39;</span><span class="o">,</span> <span class="s1">&#39;S&#39;</span><span class="o">]</span>
    <span class="kt">def</span> <span class="n">colors</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;Black&#39;</span><span class="o">,</span> <span class="s1">&#39;White&#39;</span><span class="o">]</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">active</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">hidden</span><span class="o">(</span><span class="s2">&quot;size&quot;</span><span class="o">)</span>
        <span class="n">hidden</span><span class="o">(</span><span class="s2">&quot;color&quot;</span><span class="o">)</span>
        <span class="k">return</span>
    <span class="o">}</span>
    <span class="n">p</span><span class="o">(</span><span class="s2">&quot;You want to buy a t-shirt?&quot;</span><span class="o">);</span>
    <span class="n">label</span><span class="o">(</span><span class="s2">&quot;Size:  &quot;</span><span class="o">);</span>     <span class="n">dropDown</span><span class="o">(</span><span class="s2">&quot;size&quot;</span><span class="o">,</span> <span class="n">sizes</span><span class="o">)</span>
    <span class="n">label</span><span class="o">(</span><span class="s2">&quot;Color: &quot;</span><span class="o">);</span>     <span class="n">dropDown</span><span class="o">(</span><span class="s2">&quot;color&quot;</span><span class="o">,</span> <span class="n">colors</span><span class="o">)</span>
    <span class="n">shopMenu</span><span class="o">()</span>
<span class="o">}</span>

<span class="c1">// kicking off processing</span>
<span class="n">html</span><span class="o">{</span>
    <span class="n">head</span><span class="o">{</span> <span class="n">title</span><span class="o">(</span><span class="s1">&#39;chemiserie store&#39;</span><span class="o">)</span> <span class="o">}</span>
    <span class="n">body</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">states</span><span class="o">[</span><span class="n">page</span><span class="o">])</span> <span class="n">process</span><span class="o">(</span><span class="n">page</span><span class="o">)</span>
        <span class="k">else</span> <span class="nf">noSuchPage</span><span class="o">()</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="c1">//----------------------------------------------------------------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1046"
>Saving a Form to a File or Mail Pipe</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">//----------------------------------------------------------------------------------</span>
<span class="c1">// get request parameters as map</span>
<span class="n">map</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">parameterMap</span>

<span class="c1">// save to file</span>
<span class="k">new</span> <span class="nf">File</span><span class="o">(</span><span class="n">filename</span><span class="o">).</span><span class="na">withOutputStream</span><span class="o">{</span> <span class="n">fos</span> <span class="o">-&gt;</span>
    <span class="n">oos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="n">fos</span><span class="o">)</span>
    <span class="n">oos</span><span class="o">.</span><span class="na">writeObject</span><span class="o">(</span><span class="n">map</span><span class="o">)</span>
    <span class="n">oos</span><span class="o">.</span><span class="na">close</span><span class="o">()</span>
<span class="o">}</span>

<span class="c1">// convert to text</span>
<span class="n">sb</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringBuffer</span><span class="o">()</span>
<span class="n">map</span><span class="o">.</span><span class="na">each</span><span class="o">{</span> <span class="n">k</span><span class="o">,</span><span class="n">v</span> <span class="o">-&gt;</span> <span class="n">sb</span> <span class="o">&lt;&lt;</span> <span class="s2">&quot;$k=$v&quot;</span> <span class="o">}</span>
<span class="n">text</span> <span class="o">=</span> <span class="n">sb</span><span class="o">.</span><span class="na">toString</span><span class="o">()</span>
<span class="c1">// to send text via email, see 18.3</span>
<span class="c1">//----------------------------------------------------------------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1049"
>Program: chemiserie</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">//----------------------------------------------------------------------------------</span>
<span class="c1">// you wouldn&#39;t normally do it this way, consider a framework like Grails</span>
<span class="c1">// even when doing it by hand, you would probably use session variables</span>
<span class="kn">import</span> <span class="nn">groovy.xml.MarkupBuilder</span>

<span class="n">page</span> <span class="o">=</span> <span class="n">param</span><span class="o">(</span><span class="s1">&#39;.State&#39;</span><span class="o">,</span> <span class="s1">&#39;Default&#39;</span><span class="o">)</span>

<span class="n">states</span> <span class="o">=</span> <span class="o">[</span>
    <span class="nl">Default:</span>  <span class="k">this</span><span class="o">.&amp;</span><span class="n">frontPage</span><span class="o">,</span>
    <span class="nl">Shirt:</span>    <span class="k">this</span><span class="o">.&amp;</span><span class="n">shirt</span><span class="o">,</span>
    <span class="nl">Sweater:</span>  <span class="k">this</span><span class="o">.&amp;</span><span class="n">sweater</span><span class="o">,</span>
    <span class="nl">Checkout:</span> <span class="k">this</span><span class="o">.&amp;</span><span class="n">checkout</span><span class="o">,</span>
    <span class="nl">Card:</span>     <span class="k">this</span><span class="o">.&amp;</span><span class="n">creditCard</span><span class="o">,</span>
    <span class="nl">Order:</span>    <span class="k">this</span><span class="o">.&amp;</span><span class="n">order</span><span class="o">,</span>
    <span class="nl">Cancel:</span>   <span class="k">this</span><span class="o">.&amp;</span><span class="n">frontPage</span><span class="o">,</span>
<span class="o">]</span>

<span class="n">writer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">StringWriter</span><span class="o">()</span>
<span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MarkupBuilder</span><span class="o">(</span><span class="n">writer</span><span class="o">)</span>
<span class="n">b</span><span class="o">.</span><span class="na">html</span><span class="o">{</span>
    <span class="n">head</span><span class="o">{</span> <span class="n">title</span><span class="o">(</span><span class="s1">&#39;chemiserie store&#39;</span><span class="o">)</span> <span class="o">}</span>
    <span class="n">body</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">states</span><span class="o">[</span><span class="n">page</span><span class="o">])</span> <span class="n">process</span><span class="o">(</span><span class="n">page</span><span class="o">)</span>
        <span class="k">else</span> <span class="nf">noSuchPage</span><span class="o">()</span>
    <span class="o">}</span>
<span class="o">}</span>
<span class="n">println</span> <span class="n">writer</span><span class="o">.</span><span class="na">toString</span><span class="o">()</span>

<span class="kt">def</span> <span class="nf">process</span><span class="o">(</span><span class="n">page</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">b</span><span class="o">.</span><span class="na">form</span><span class="o">{</span>
        <span class="n">states</span><span class="o">.</span><span class="na">each</span><span class="o">{</span> <span class="n">key</span><span class="o">,</span> <span class="n">closure</span> <span class="o">-&gt;</span>
            <span class="n">closure</span><span class="o">(</span><span class="n">page</span> <span class="o">==</span> <span class="n">key</span><span class="o">)</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>

<span class="kt">def</span> <span class="nf">noSuchPage</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">b</span><span class="o">.</span><span class="na">p</span><span class="o">(</span><span class="s1">&#39;Unknown request&#39;</span><span class="o">)</span>
    <span class="n">reset</span><span class="o">(</span><span class="s1">&#39;Click here to start over&#39;</span><span class="o">)</span>
<span class="o">}</span>

<span class="kt">def</span> <span class="nf">shopMenu</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">b</span><span class="o">.</span><span class="na">p</span><span class="o">()</span>
    <span class="n">toPage</span><span class="o">(</span><span class="s2">&quot;Shirt&quot;</span><span class="o">)</span>
    <span class="n">toPage</span><span class="o">(</span><span class="s2">&quot;Sweater&quot;</span><span class="o">)</span>
    <span class="n">toPage</span><span class="o">(</span><span class="s2">&quot;Checkout&quot;</span><span class="o">)</span>
    <span class="n">reset</span><span class="o">(</span><span class="s1">&#39;Empty My Shopping Cart&#39;</span><span class="o">)</span>
<span class="o">}</span>

<span class="kt">def</span> <span class="nf">frontPage</span><span class="o">(</span><span class="n">active</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">active</span><span class="o">)</span> <span class="k">return</span>
    <span class="n">b</span><span class="o">.</span><span class="na">h1</span><span class="o">(</span><span class="s1">&#39;Hi!&#39;</span><span class="o">)</span>
    <span class="n">b</span><span class="o">.</span><span class="na">p</span><span class="o">(</span><span class="s1">&#39;Welcome to our Shirt Shop! Please make your selection from the menu below.&#39;</span><span class="o">)</span>
    <span class="n">shopMenu</span><span class="o">()</span>
<span class="o">}</span>

<span class="kt">def</span> <span class="nf">shirt</span><span class="o">(</span><span class="n">active</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">sizes</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;XL&#39;</span><span class="o">,</span> <span class="s1">&#39;L&#39;</span><span class="o">,</span> <span class="s1">&#39;M&#39;</span><span class="o">,</span> <span class="s1">&#39;S&#39;</span><span class="o">]</span>
    <span class="kt">def</span> <span class="n">colors</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;Black&#39;</span><span class="o">,</span> <span class="s1">&#39;White&#39;</span><span class="o">]</span>
    <span class="kt">def</span> <span class="n">count</span> <span class="o">=</span> <span class="n">param</span><span class="o">(</span><span class="s1">&#39;shirt_count&#39;</span><span class="o">,</span><span class="mi">0</span><span class="o">)</span>
    <span class="kt">def</span> <span class="n">color</span> <span class="o">=</span> <span class="n">param</span><span class="o">(</span><span class="s1">&#39;shirt_color&#39;</span><span class="o">)</span>
    <span class="kt">def</span> <span class="n">size</span> <span class="o">=</span> <span class="n">param</span><span class="o">(</span><span class="s1">&#39;shirt_size&#39;</span><span class="o">)</span>
    <span class="c1">// sanity check</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">count</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!(</span><span class="n">color</span> <span class="k">in</span> <span class="n">colors</span><span class="o">))</span> <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
        <span class="k">if</span> <span class="o">(!(</span><span class="n">size</span> <span class="k">in</span> <span class="n">sizes</span><span class="o">))</span> <span class="n">size</span> <span class="o">=</span> <span class="n">sizes</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">active</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">size</span><span class="o">)</span> <span class="n">hidden</span><span class="o">(</span><span class="s2">&quot;shirt_size&quot;</span><span class="o">,</span> <span class="n">size</span><span class="o">)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">color</span><span class="o">)</span> <span class="n">hidden</span><span class="o">(</span><span class="s2">&quot;shirt_color&quot;</span><span class="o">,</span> <span class="n">color</span><span class="o">)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">count</span><span class="o">)</span> <span class="n">hidden</span><span class="o">(</span><span class="s2">&quot;shirt_count&quot;</span><span class="o">,</span> <span class="n">count</span><span class="o">)</span>
        <span class="k">return</span>
    <span class="o">}</span>
    <span class="n">b</span><span class="o">.</span><span class="na">h1</span> <span class="s1">&#39;T-Shirt&#39;</span>
    <span class="n">b</span><span class="o">.</span><span class="na">p</span> <span class="s1">&#39;&#39;&#39;What a shirt! This baby is decked out with all the options.</span>
<span class="s1">        It comes with full luxury interior, cotton trim, and a collar</span>
<span class="s1">        to make your eyes water! Unit price: $33.00&#39;&#39;&#39;</span>
    <span class="n">b</span><span class="o">.</span><span class="na">h2</span> <span class="s1">&#39;Options&#39;</span>
    <span class="n">label</span><span class="o">(</span><span class="s2">&quot;How Many?&quot;</span><span class="o">);</span>  <span class="n">textfield</span><span class="o">(</span><span class="s2">&quot;shirt_count&quot;</span><span class="o">)</span>
    <span class="n">label</span><span class="o">(</span><span class="s2">&quot;Size?&quot;</span><span class="o">);</span>      <span class="n">dropDown</span><span class="o">(</span><span class="s2">&quot;shirt_size&quot;</span><span class="o">,</span> <span class="n">sizes</span><span class="o">)</span>
    <span class="n">label</span><span class="o">(</span><span class="s2">&quot;Color?&quot;</span><span class="o">);</span>     <span class="n">dropDown</span><span class="o">(</span><span class="s2">&quot;shirt_color&quot;</span><span class="o">,</span> <span class="n">colors</span><span class="o">)</span>
    <span class="n">shopMenu</span><span class="o">()</span>
<span class="o">}</span>

<span class="kt">def</span> <span class="nf">sweater</span><span class="o">(</span><span class="n">active</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">sizes</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;XL&#39;</span><span class="o">,</span> <span class="s1">&#39;L&#39;</span><span class="o">,</span> <span class="s1">&#39;M&#39;</span><span class="o">]</span>
    <span class="kt">def</span> <span class="n">colors</span> <span class="o">=</span> <span class="o">[</span><span class="s1">&#39;Chartreuse&#39;</span><span class="o">,</span> <span class="s1">&#39;Puce&#39;</span><span class="o">,</span> <span class="s1">&#39;Lavender&#39;</span><span class="o">]</span>
    <span class="kt">def</span> <span class="n">count</span> <span class="o">=</span> <span class="n">param</span><span class="o">(</span><span class="s1">&#39;sweater_count&#39;</span><span class="o">,</span><span class="mi">0</span><span class="o">)</span>
    <span class="kt">def</span> <span class="n">color</span> <span class="o">=</span> <span class="n">param</span><span class="o">(</span><span class="s1">&#39;sweater_color&#39;</span><span class="o">)</span>
    <span class="kt">def</span> <span class="n">size</span> <span class="o">=</span> <span class="n">param</span><span class="o">(</span><span class="s1">&#39;sweater_size&#39;</span><span class="o">)</span>
    <span class="c1">// sanity check</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">count</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(!(</span><span class="n">color</span> <span class="k">in</span> <span class="n">colors</span><span class="o">))</span> <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
        <span class="k">if</span> <span class="o">(!(</span><span class="n">size</span> <span class="k">in</span> <span class="n">sizes</span><span class="o">))</span> <span class="n">size</span> <span class="o">=</span> <span class="n">sizes</span><span class="o">[</span><span class="mi">0</span><span class="o">]</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">active</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">size</span><span class="o">)</span> <span class="n">hidden</span><span class="o">(</span><span class="s2">&quot;sweater_size&quot;</span><span class="o">,</span> <span class="n">size</span><span class="o">)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">color</span><span class="o">)</span> <span class="n">hidden</span><span class="o">(</span><span class="s2">&quot;sweater_color&quot;</span><span class="o">,</span> <span class="n">color</span><span class="o">)</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">count</span><span class="o">)</span> <span class="n">hidden</span><span class="o">(</span><span class="s2">&quot;sweater_count&quot;</span><span class="o">,</span> <span class="n">count</span><span class="o">)</span>
        <span class="k">return</span>
    <span class="o">}</span>
    <span class="n">b</span><span class="o">.</span><span class="na">h1</span><span class="o">(</span><span class="s2">&quot;Sweater&quot;</span><span class="o">)</span>
    <span class="n">b</span><span class="o">.</span><span class="na">p</span><span class="o">(</span><span class="s2">&quot;Nothing implies preppy elegance more than this fine &quot;</span> <span class="o">+</span>
        <span class="s2">&quot;sweater. Made by peasant workers from black market silk, &quot;</span> <span class="o">+</span>
        <span class="s2">&quot;it slides onto your lean form and cries out ``Take me, &quot;</span> <span class="o">+</span>
        <span class="s2">&quot;for I am a god!&#39;&#39;. Unit price: \$49.99.&quot;</span><span class="o">)</span>
    <span class="n">b</span><span class="o">.</span><span class="na">h2</span><span class="o">(</span><span class="s2">&quot;Options&quot;</span><span class="o">)</span>
    <span class="n">label</span><span class="o">(</span><span class="s2">&quot;How Many?&quot;</span><span class="o">);</span> <span class="n">textfield</span><span class="o">(</span><span class="s2">&quot;sweater_count&quot;</span><span class="o">)</span>
    <span class="n">label</span><span class="o">(</span><span class="s2">&quot;Size?&quot;</span><span class="o">);</span> <span class="n">dropDown</span><span class="o">(</span><span class="s2">&quot;sweater_size&quot;</span><span class="o">,</span> <span class="n">sizes</span><span class="o">)</span>
    <span class="n">label</span><span class="o">(</span><span class="s2">&quot;Color?&quot;</span><span class="o">);</span> <span class="n">dropDown</span><span class="o">(</span><span class="s2">&quot;sweater_color&quot;</span><span class="o">,</span> <span class="n">colors</span><span class="o">)</span>
    <span class="n">shopMenu</span><span class="o">()</span>
<span class="o">}</span>

<span class="kt">def</span> <span class="nf">checkout</span><span class="o">(</span><span class="n">active</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">active</span><span class="o">)</span> <span class="k">return</span>
    <span class="n">b</span><span class="o">.</span><span class="na">h1</span><span class="o">(</span><span class="s2">&quot;Order Confirmation&quot;</span><span class="o">)</span>
    <span class="n">b</span><span class="o">.</span><span class="na">p</span><span class="o">(</span><span class="s2">&quot;You ordered the following:&quot;</span><span class="o">)</span>
    <span class="n">orderText</span><span class="o">()</span>
    <span class="n">b</span><span class="o">.</span><span class="na">p</span><span class="o">(</span><span class="s2">&quot;Is this right? Select &#39;Card&#39; to pay for the items&quot;</span> <span class="o">+</span>
        <span class="s2">&quot;or &#39;Shirt&#39; or &#39;Sweater&#39; to continue shopping.&quot;</span><span class="o">)</span>
    <span class="n">toPage</span><span class="o">(</span><span class="s2">&quot;Card&quot;</span><span class="o">)</span>
    <span class="n">toPage</span><span class="o">(</span><span class="s2">&quot;Shirt&quot;</span><span class="o">)</span>
    <span class="n">toPage</span><span class="o">(</span><span class="s2">&quot;Sweater&quot;</span><span class="o">)</span>
<span class="o">}</span>

<span class="kt">def</span> <span class="nf">creditCard</span><span class="o">(</span><span class="n">active</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">widgets</span> <span class="o">=</span> <span class="s1">&#39;Name Address1 Address2 City Zip State Phone Card Expiry&#39;</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s1">&#39; &#39;</span><span class="o">)</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">active</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">widgets</span><span class="o">.</span><span class="na">each</span><span class="o">{</span> <span class="n">hidden</span><span class="o">(</span><span class="n">it</span><span class="o">)</span> <span class="o">}</span>
        <span class="k">return</span>
    <span class="o">}</span>
    <span class="n">b</span><span class="o">.</span><span class="na">pre</span><span class="o">{</span>
        <span class="n">label</span><span class="o">(</span><span class="s2">&quot;Name: &quot;</span><span class="o">);</span>          <span class="n">textfield</span><span class="o">(</span><span class="s2">&quot;Name&quot;</span><span class="o">)</span>
        <span class="n">label</span><span class="o">(</span><span class="s2">&quot;Address: &quot;</span><span class="o">);</span>       <span class="n">textfield</span><span class="o">(</span><span class="s2">&quot;Address1&quot;</span><span class="o">)</span>
        <span class="n">label</span><span class="o">(</span><span class="s2">&quot; &quot;</span><span class="o">);</span>               <span class="n">textfield</span><span class="o">(</span><span class="s2">&quot;Address2&quot;</span><span class="o">)</span>
        <span class="n">label</span><span class="o">(</span><span class="s2">&quot;City: &quot;</span><span class="o">);</span>          <span class="n">textfield</span><span class="o">(</span><span class="s2">&quot;City&quot;</span><span class="o">)</span>
        <span class="n">label</span><span class="o">(</span><span class="s2">&quot;Zip: &quot;</span><span class="o">);</span>           <span class="n">textfield</span><span class="o">(</span><span class="s2">&quot;Zip&quot;</span><span class="o">)</span>
        <span class="n">label</span><span class="o">(</span><span class="s2">&quot;State: &quot;</span><span class="o">);</span>         <span class="n">textfield</span><span class="o">(</span><span class="s2">&quot;State&quot;</span><span class="o">)</span>
        <span class="n">label</span><span class="o">(</span><span class="s2">&quot;Phone: &quot;</span><span class="o">);</span>         <span class="n">textfield</span><span class="o">(</span><span class="s2">&quot;Phone&quot;</span><span class="o">)</span>
        <span class="n">label</span><span class="o">(</span><span class="s2">&quot;Credit Card #: &quot;</span><span class="o">);</span> <span class="n">textfield</span><span class="o">(</span><span class="s2">&quot;Card&quot;</span><span class="o">)</span>
        <span class="n">label</span><span class="o">(</span><span class="s2">&quot;Expiry: &quot;</span><span class="o">);</span>        <span class="n">textfield</span><span class="o">(</span><span class="s2">&quot;Expiry&quot;</span><span class="o">)</span>
    <span class="o">}</span>
    <span class="n">b</span><span class="o">.</span><span class="na">p</span><span class="o">(</span><span class="s2">&quot;Click on &#39;Order&#39; to order the items. Click on &#39;Cancel&#39; to return shopping.&quot;</span><span class="o">)</span>
    <span class="n">toPage</span><span class="o">(</span><span class="s2">&quot;Order&quot;</span><span class="o">)</span>
    <span class="n">toPage</span><span class="o">(</span><span class="s2">&quot;Cancel&quot;</span><span class="o">)</span>
<span class="o">}</span>

<span class="kt">def</span> <span class="nf">order</span><span class="o">(</span><span class="n">active</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">active</span><span class="o">)</span> <span class="k">return</span>
    <span class="n">b</span><span class="o">.</span><span class="na">h1</span><span class="o">(</span><span class="s2">&quot;Ordered!&quot;</span><span class="o">)</span>
    <span class="n">b</span><span class="o">.</span><span class="na">p</span><span class="o">(</span><span class="s2">&quot;You have ordered the following items:&quot;</span><span class="o">)</span>
    <span class="n">orderText</span><span class="o">()</span>
    <span class="n">reset</span><span class="o">(</span><span class="s1">&#39;Begin Again&#39;</span><span class="o">)</span>
<span class="o">}</span>

<span class="kt">def</span> <span class="nf">orderText</span><span class="o">()</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">shirts</span> <span class="o">=</span> <span class="n">param</span><span class="o">(</span><span class="s1">&#39;shirt_count&#39;</span><span class="o">)</span>
    <span class="kt">def</span> <span class="n">sweaters</span> <span class="o">=</span> <span class="n">param</span><span class="o">(</span><span class="s1">&#39;sweater_count&#39;</span><span class="o">)</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">shirts</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">b</span><span class="o">.</span><span class="na">p</span><span class="o">(</span><span class="s2">&quot;&quot;&quot;You have ordered ${param(&#39;shirt_count&#39;)}</span>
<span class="s2">            shirts of size ${param(&#39;shirt_size&#39;)}</span>
<span class="s2">            and color ${param(&quot;</span><span class="n">shirt_color</span><span class="s2">&quot;)}.&quot;&quot;&quot;</span><span class="o">)</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">sweaters</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">b</span><span class="o">.</span><span class="na">p</span><span class="o">(</span><span class="s2">&quot;&quot;&quot;You have ordered ${param(&#39;sweater_count&#39;)}</span>
<span class="s2">        sweaters of size ${param(&#39;sweater_size&#39;)}</span>
<span class="s2">        and color ${param(&#39;sweater_color&#39;)}.&quot;&quot;&quot;</span><span class="o">)</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(!</span><span class="n">sweaters</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">shirts</span><span class="o">)</span> <span class="n">b</span><span class="o">.</span><span class="na">p</span><span class="o">(</span><span class="s2">&quot;Nothing!&quot;</span><span class="o">)</span>
    <span class="n">b</span><span class="o">.</span><span class="na">p</span><span class="o">(</span><span class="s2">&quot;For a total cost of ${calcPrice()}&quot;</span><span class="o">)</span>
<span class="o">}</span>

<span class="kt">def</span> <span class="nf">label</span><span class="o">(</span><span class="n">text</span><span class="o">)</span> <span class="o">{</span> <span class="n">b</span><span class="o">.</span><span class="na">span</span><span class="o">(</span><span class="n">text</span><span class="o">)</span> <span class="o">}</span>
<span class="kt">def</span> <span class="nf">reset</span><span class="o">(</span><span class="n">text</span><span class="o">)</span> <span class="o">{</span> <span class="n">b</span><span class="o">.</span><span class="na">a</span><span class="o">(</span><span class="nl">href:</span><span class="n">request</span><span class="o">.</span><span class="na">requestURI</span><span class="o">,</span><span class="n">text</span><span class="o">)</span> <span class="o">}</span>
<span class="kt">def</span> <span class="nf">toPage</span><span class="o">(</span><span class="n">name</span><span class="o">)</span> <span class="o">{</span> <span class="n">b</span><span class="o">.</span><span class="na">input</span><span class="o">(</span><span class="nl">type:</span><span class="s1">&#39;submit&#39;</span><span class="o">,</span> <span class="nl">name:</span><span class="s1">&#39;.State&#39;</span><span class="o">,</span> <span class="nl">value:</span><span class="n">name</span><span class="o">)</span> <span class="o">}</span>
<span class="kt">def</span> <span class="nf">dropDown</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">values</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">b</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="nl">name:</span><span class="n">name</span><span class="o">){</span>
        <span class="n">values</span><span class="o">.</span><span class="na">each</span><span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">param</span><span class="o">(</span><span class="n">name</span><span class="o">)==</span><span class="n">it</span><span class="o">)</span> <span class="n">option</span><span class="o">(</span><span class="nl">value:</span><span class="n">it</span><span class="o">,</span> <span class="nl">selected:</span><span class="kc">true</span><span class="o">,</span> <span class="n">it</span><span class="o">)</span>
            <span class="k">else</span> <span class="nf">option</span><span class="o">(</span><span class="nl">value:</span><span class="n">it</span><span class="o">,</span> <span class="n">it</span><span class="o">)</span>
        <span class="o">}</span>
    <span class="o">}</span>
    <span class="n">b</span><span class="o">.</span><span class="na">br</span><span class="o">()</span>
<span class="o">}</span>
<span class="kt">def</span> <span class="nf">hidden</span><span class="o">(</span><span class="n">name</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">binding</span><span class="o">.</span><span class="na">variables</span><span class="o">.</span><span class="na">containsKey</span><span class="o">(</span><span class="n">name</span><span class="o">))</span> <span class="n">v</span> <span class="o">=</span> <span class="n">binding</span><span class="o">[</span><span class="n">name</span><span class="o">]</span>
    <span class="k">else</span> <span class="n">v</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
    <span class="n">hidden</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">v</span><span class="o">)</span>
<span class="o">}</span>
<span class="kt">def</span> <span class="nf">hidden</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span> <span class="n">b</span><span class="o">.</span><span class="na">input</span><span class="o">(</span><span class="nl">type:</span><span class="s1">&#39;hidden&#39;</span><span class="o">,</span> <span class="nl">name:</span><span class="n">name</span><span class="o">,</span> <span class="nl">value:</span><span class="n">value</span><span class="o">)</span> <span class="o">}</span>
<span class="kt">def</span> <span class="nf">textfield</span><span class="o">(</span><span class="n">name</span><span class="o">)</span> <span class="o">{</span> <span class="n">b</span><span class="o">.</span><span class="na">input</span><span class="o">(</span><span class="nl">type:</span><span class="s1">&#39;text&#39;</span><span class="o">,</span> <span class="nl">name:</span><span class="n">name</span><span class="o">,</span> <span class="nl">value:</span><span class="n">param</span><span class="o">(</span><span class="n">name</span><span class="o">,</span><span class="s1">&#39;&#39;</span><span class="o">));</span> <span class="n">b</span><span class="o">.</span><span class="na">br</span><span class="o">()</span> <span class="o">}</span>
<span class="kt">def</span> <span class="nf">param</span><span class="o">(</span><span class="n">name</span><span class="o">)</span> <span class="o">{</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="n">name</span><span class="o">)</span> <span class="o">}</span>
<span class="kt">def</span> <span class="nf">param</span><span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">defValue</span><span class="o">)</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">val</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="n">name</span><span class="o">)</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">val</span><span class="o">)</span> <span class="k">return</span> <span class="n">val</span> <span class="k">else</span> <span class="k">return</span> <span class="n">defValue</span>
<span class="o">}</span>

<span class="kt">def</span> <span class="nf">calcPrice</span><span class="o">()</span> <span class="o">{</span>
    <span class="kt">def</span> <span class="n">shirts</span> <span class="o">=</span> <span class="n">param</span><span class="o">(</span><span class="s1">&#39;shirt_count&#39;</span><span class="o">,</span> <span class="mi">0</span><span class="o">).</span><span class="na">toInteger</span><span class="o">()</span>
    <span class="kt">def</span> <span class="n">sweaters</span> <span class="o">=</span> <span class="n">param</span><span class="o">(</span><span class="s1">&#39;sweater_count&#39;</span><span class="o">,</span> <span class="mi">0</span><span class="o">).</span><span class="na">toInteger</span><span class="o">()</span>
    <span class="k">return</span> <span class="o">(</span><span class="n">shirts</span> <span class="o">*</span> <span class="mi">33</span> <span class="o">+</span> <span class="n">sweaters</span> <span class="o">*</span> <span class="mf">49.99</span><span class="o">).</span><span class="na">toString</span><span class="o">()</span>
<span class="o">}</span>
<span class="c1">//----------------------------------------------------------------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="internetservices.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="webautomation.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Internet Services</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
>&nbsp;</TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Web Automation</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>
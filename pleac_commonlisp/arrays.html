<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN""http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>Arrays</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="PLEAC-Common Lisp"
HREF="index.html"><LINK
REL="PREVIOUS"
TITLE="Dates and Times"
HREF="datesandtimes.html"><LINK
REL="NEXT"
TITLE="Hashes"
HREF="hashes.html"><style type="text/css">td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
pre { line-height: 125%; }

  </style></head
><BODY TEXT="#cecece" BGCOLOR="#4f6f6f" LINK="#f5deb3" VLINK="#d5ae83"
CLASS="SECT1"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>PLEAC-Common Lisp</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="datesandtimes.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
></TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="hashes.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="ARRAYS"
>4. Arrays</A
></H1
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN170"
>Introduction</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">nested</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;this&quot;</span> <span class="s">&quot;that&quot;</span> <span class="s">&quot;the&quot;</span> <span class="s">&quot;other&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">nested</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;this&quot;</span> <span class="s">&quot;that&quot;</span> <span class="p">(</span><span class="s">&quot;the&quot;</span> <span class="s">&quot;other&quot;</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">tune</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;The&quot;</span> <span class="s">&quot;Star-Spangled&quot;</span> <span class="s">&quot;Banner&quot;</span><span class="p">))</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN173"
>Specifying a List In Your Program</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">a</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;quick&quot;</span> <span class="s">&quot;brown&quot;</span> <span class="s">&quot;fox&quot;</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">a</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;Why&quot;</span> <span class="s">&quot;are&quot;</span> <span class="s">&quot;you&quot;</span> <span class="s">&quot;teasing&quot;</span> <span class="s">&quot;me?&quot;</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">lines</span> <span class="p">(</span><span class="nv">regex-replace-all</span> <span class="p">(</span><span class="nv">create-scanner</span> <span class="s">&quot;^\\s*(.+)&quot;</span> <span class="ss">:multi-line-mode</span> <span class="no">t</span> <span class="p">)</span>
<span class="s">&quot;    The boy stood on the burning deck,</span>
<span class="s">    It was as hot as glass.</span>
<span class="s">&quot;</span> <span class="s">&quot;\\1&quot;</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;; You don&#39;t really need an explicit call to the CL equivalent of</span>
<span class="c1">;;; Perl&#39;s die().  Its behavior is the same by default (it does put</span>
<span class="c1">;;; you into the CL debugger, but that&#39;s not a bad thing).  You could,</span>
<span class="c1">;;; alternatively, handle this error with HANDLER-BIND or HANLDER-CASE</span>
<span class="c1">;;; if you wanted to be more precisely like the Perl version.</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">bigarray</span> <span class="o">&#39;</span><span class="p">()))</span>
  <span class="p">(</span><span class="nb">with-open-file</span> <span class="p">(</span><span class="nv">data</span> <span class="s">&quot;mydatafile&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">line</span> <span class="nb">=</span> <span class="p">(</span><span class="nb">read-line</span> <span class="nv">data</span> <span class="no">nil</span> <span class="no">nil</span><span class="p">)</span>
       <span class="nv">while</span> <span class="nv">line</span>
       <span class="nb">do</span> <span class="p">(</span><span class="nb">push</span> <span class="p">(</span><span class="nb">string-right-trim</span> <span class="o">#(</span><span class="sc">#\Newline</span> <span class="sc">#\Return</span><span class="p">)</span>
                                   <span class="nv">line</span><span class="p">)</span> <span class="nv">bigarray</span><span class="p">))))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">banner</span> <span class="s">&quot;The Mines of Moria&quot;</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">name</span> <span class="s">&quot;Gandalf&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">banner</span> <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;Speak ~A and enter!&quot;</span> <span class="nv">name</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">banner</span> <span class="s">&quot;Speak $name and welcome!&quot;</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">his-host</span> <span class="s">&quot;www.perl.com&quot;</span><span class="p">)</span>
<span class="o">#+</span><span class="nv">sbcl</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">host-info</span> <span class="p">(</span><span class="nb">with-output-to-string</span> <span class="p">(</span><span class="nv">output</span><span class="p">)</span>
                  <span class="p">(</span><span class="nv">sb-ext:run-program</span> <span class="s">&quot;nslookup&quot;</span> <span class="o">`</span><span class="p">(</span><span class="o">,</span><span class="nv">his-host</span><span class="p">)</span> <span class="ss">:search</span> <span class="no">t</span> <span class="ss">:output</span> <span class="nv">output</span><span class="p">)))</span>
<span class="c1">;; There&#39;s no equivalent to Perl&#39;s qx</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">banner</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;Costs&quot;</span> <span class="s">&quot;only&quot;</span> <span class="s">&quot;$4.95&quot;</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">banner</span> <span class="p">(</span><span class="nv">split</span> <span class="s">&quot; &quot;</span> <span class="s">&quot;Costs only $4.95&quot;</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">brax</span> <span class="o">&#39;</span><span class="p">(</span><span class="sc">#\(</span> <span class="sc">#\)</span> <span class="sc">#\&lt;</span> <span class="sc">#\&gt;</span> <span class="sc">#\{</span> <span class="sc">#\}</span> <span class="sc">#\[</span> <span class="sc">#\]</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">rings</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;Nenya&quot;</span> <span class="s">&quot;Narya&quot;</span> <span class="s">&quot;Vilya&quot;</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">tags</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;LI&quot;</span> <span class="s">&quot;TABLE&quot;</span> <span class="s">&quot;TR&quot;</span> <span class="s">&quot;TD&quot;</span> <span class="s">&quot;A&quot;</span> <span class="s">&quot;IMG&quot;</span> <span class="s">&quot;H1&quot;</span> <span class="s">&quot;P&quot;</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">sample</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;The&quot;</span> <span class="s">&quot;vertical&quot;</span> <span class="s">&quot;bar&quot;</span> <span class="s">&quot;(|)&quot;</span> <span class="s">&quot;looks&quot;</span> <span class="s">&quot;and&quot;</span> <span class="s">&quot;behaves&quot;</span> <span class="s">&quot;like&quot;</span> <span class="s">&quot;a&quot;</span> <span class="s">&quot;pipe.&quot;</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; No equivalent in CL (would just be the same as above)</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; No equivalent in CL (would just be the same as above)</span>
<span class="c1">;;;-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN176"
>Printing a List with Commas</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">commify-series</span> <span class="p">(</span><span class="nb">list</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">case</span> <span class="p">(</span><span class="nb">length</span> <span class="nb">list</span><span class="p">)</span>
    <span class="p">(</span><span class="mi">0</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="mi">1</span> <span class="p">(</span><span class="nb">car</span> <span class="nb">list</span><span class="p">))</span>
    <span class="p">(</span><span class="mi">2</span> <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;~{~A~^ and ~}&quot;</span> <span class="nb">list</span><span class="p">))</span>
    <span class="p">(</span><span class="no">t</span> <span class="p">(</span><span class="nb">concatenate</span> <span class="ss">&#39;string</span>
                    <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;~{~A~^, ~}&quot;</span> <span class="p">(</span><span class="nb">butlast</span> <span class="nb">list</span><span class="p">))</span>
                    <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot; and ~A&quot;</span> <span class="p">(</span><span class="nb">car</span> <span class="p">(</span><span class="nb">last</span> <span class="nb">list</span><span class="p">)))))))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nc">array</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;red&quot;</span> <span class="s">&quot;yellow&quot;</span> <span class="s">&quot;green&quot;</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;I have ~{~A~} marbles.~%&quot;</span> <span class="nc">array</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;I have ~{~A~^ ~} marbles.~%&quot;</span> <span class="nc">array</span><span class="p">))</span>
<span class="c1">;;I have redyellowgreen marbles.</span>
<span class="c1">;;I have red yellow green marbles.</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; <font size="-1"><a href="http://pleac.sourceforge.net/include/commonlisp/ch04/commify_series.lisp</span>">download the following standalone program</a></font>
<span class="c1">;;;; commify_series - show proper comma insertion in list output</span>

<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*lists*</span>
  <span class="o">&#39;</span><span class="p">((</span><span class="s">&quot;just one thing&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;Mutt&quot;</span> <span class="s">&quot;Jeff&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;Peter&quot;</span> <span class="s">&quot;Paul&quot;</span> <span class="s">&quot;Mary&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;To our parents&quot;</span> <span class="s">&quot;Mother Theresa&quot;</span> <span class="s">&quot;God&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;pastrami&quot;</span> <span class="s">&quot;ham and cheese&quot;</span> <span class="s">&quot;peanut butter and jelly&quot;</span> <span class="s">&quot;tuna&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;recycle tired, old phrases&quot;</span> <span class="s">&quot;ponder big, happy thoughts&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="s">&quot;recycle tired, old phrases&quot;</span>
     <span class="s">&quot;ponder big, happy thoughts&quot;</span>
     <span class="s">&quot;sleep and dream peacefully&quot;</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">commify_series</span> <span class="p">(</span><span class="nb">list</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">sepchar</span> <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">find-if</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nb">string</span><span class="p">)</span> 
                                  <span class="p">(</span><span class="nb">find</span> <span class="sc">#\,</span> <span class="nb">string</span><span class="p">))</span>
                              <span class="nb">list</span><span class="p">)</span>
                     <span class="s">&quot;; &quot;</span> <span class="s">&quot;, &quot;</span><span class="p">)))</span>
    <span class="p">(</span><span class="nb">case</span> <span class="p">(</span><span class="nb">length</span> <span class="nb">list</span><span class="p">)</span>
      <span class="p">(</span><span class="mi">0</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
      <span class="p">(</span><span class="mi">1</span> <span class="p">(</span><span class="nb">car</span> <span class="nb">list</span><span class="p">))</span>
      <span class="p">(</span><span class="mi">2</span> <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;~{~a~^ and ~}&quot;</span> <span class="nb">list</span><span class="p">))</span>
      <span class="p">(</span><span class="no">t</span> <span class="p">(</span><span class="nb">concatenate</span> <span class="ss">&#39;string</span>
                      <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span>
                              <span class="s">&quot;~{~}&quot;</span> 
                              <span class="p">(</span><span class="nb">concatenate</span> <span class="ss">&#39;string</span> <span class="s">&quot;~a~^&quot;</span> <span class="nv">sepchar</span><span class="p">)</span>
                              <span class="p">(</span><span class="nb">butlast</span> <span class="nb">list</span><span class="p">))</span>
                      <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot; and ~a&quot;</span> <span class="p">(</span><span class="nb">car</span> <span class="p">(</span><span class="nb">last</span> <span class="nb">list</span><span class="p">))))))))</span>

<span class="p">(</span><span class="nb">mapc</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nb">list</span><span class="p">)</span>
          <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;The list is: ~a.~%&quot;</span> <span class="p">(</span><span class="nv">commify_series</span> <span class="nb">list</span><span class="p">)))</span>
      <span class="vg">*lists*</span><span class="p">)</span>


<span class="c1">;;;-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN179"
>Changing Array Size</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">;;;-----------------------------</span>
<span class="c1">;; grow or shrink MY-ARRAY (assuming it was created with :ADJUSTABLE</span>
<span class="c1">;; set to T)</span>
<span class="p">(</span><span class="nb">adjust-array</span> <span class="nv">my-array</span> <span class="p">(</span><span class="nb">1+</span> <span class="nv">new-last-element-index-number</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; There&#39;s no auto-creation of array elements.</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*people*</span> <span class="p">(</span><span class="nb">make-array</span> <span class="mi">4</span>
                                   <span class="ss">:initial-contents</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;Crosby&quot;</span> <span class="s">&quot;Stills&quot;</span> <span class="s">&quot;Nash&quot;</span> <span class="s">&quot;Young&quot;</span><span class="p">)</span>
                                   <span class="ss">:adjustable</span> <span class="no">t</span><span class="p">))</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">what-about-that-array</span> <span class="p">()</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span>
          <span class="s">&quot;The array now has ~D elements</span>
<span class="s">The index of the last element is ~D</span>
<span class="s">Element #3 is ~A~%&quot;</span>
          <span class="p">(</span><span class="nb">length</span> <span class="vg">*people*</span><span class="p">)</span>
          <span class="p">(</span><span class="nb">1-</span> <span class="p">(</span><span class="nb">length</span> <span class="vg">*people*</span><span class="p">))</span>
          <span class="p">(</span><span class="nb">aref</span> <span class="vg">*people*</span> <span class="mi">3</span><span class="p">)))</span>
<span class="p">(</span><span class="nv">what-about-that-array</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;;The array now has 4 elements</span>
<span class="c1">;;The index of the last element is 3</span>
<span class="c1">;;Element #3 is Young</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">adjust-array</span> <span class="vg">*people*</span> <span class="p">(</span><span class="nb">1-</span> <span class="p">(</span><span class="nb">length</span> <span class="vg">*people*</span><span class="p">)))</span>
<span class="p">(</span><span class="nv">what-about-that-array</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Evaluating WHAT-ABOUT-THAT-ARRAY now results in an error because</span>
<span class="c1">;; there is no 3rd element, and, unlike Perl, CL doesn&#39;t just return</span>
<span class="c1">;; the empty string in that case.</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">adjust-array</span> <span class="vg">*people*</span> <span class="mi">10001</span><span class="p">)</span>
<span class="p">(</span><span class="nv">what-about-that-array</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;;The array now has 10001 elements</span>
<span class="c1">;;The index of the last element is 9999</span>
<span class="c1">;;Element #3 is 0</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">aref</span> <span class="vg">*people*</span> <span class="mi">10000</span><span class="p">)</span> <span class="no">nil</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN182"
>Doing Something with Every Element in a List</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">item</span> <span class="nb">list</span><span class="p">)</span>
  <span class="c1">;; do something with ITEM</span>
  <span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">user</span> <span class="nv">bad-users</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">complain</span> <span class="nv">user</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">var</span> <span class="p">(</span><span class="nb">sort</span> <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">x</span> <span class="nv">being</span> <span class="k">the</span> <span class="nv">hash-keys</span> <span class="nv">of</span> <span class="nv">axl</span>
                      <span class="nv">collect</span> <span class="nv">x</span><span class="p">)</span> <span class="nf">#&#39;</span><span class="nb">&lt;</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A=~A~%&quot;</span> <span class="nv">var</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">var</span> <span class="nv">ENV</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">user</span> <span class="nv">all-users</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">disk-space</span> <span class="p">(</span><span class="nv">get-usage</span> <span class="nv">user</span><span class="p">)))</span>
    <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">&gt;</span> <span class="nv">disk-space</span> <span class="nv">+max-quota+</span><span class="p">)</span>
      <span class="p">(</span><span class="nv">complain</span> <span class="nv">user</span><span class="p">))))</span>
<span class="c1">;;;-----------------------------</span>
<span class="o">#+</span><span class="nv">sbcl</span>
<span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">line</span> <span class="p">(</span><span class="nv">split</span> <span class="s">&quot;\\n&quot;</span>
                     <span class="p">(</span><span class="nb">with-output-to-string</span> <span class="p">(</span><span class="nv">output</span><span class="p">)</span>
                       <span class="p">(</span><span class="nv">sb-ext:run-program</span> <span class="s">&quot;who&quot;</span> <span class="no">nil</span> <span class="ss">:search</span> <span class="no">t</span> <span class="ss">:output</span> <span class="nv">output</span><span class="p">))))</span>
  <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nv">scan</span> <span class="s">&quot;tchrist&quot;</span> <span class="nv">line</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A~%&quot;</span> <span class="nv">line</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">line</span> <span class="nb">=</span> <span class="p">(</span><span class="nb">read-line</span> <span class="nv">fh</span> <span class="no">nil</span> <span class="ss">:eof</span> <span class="no">nil</span><span class="p">)</span> <span class="c1">; LINE is set to the line just read</span>
   <span class="nv">until</span> <span class="p">(</span><span class="nb">eq</span> <span class="nv">line</span> <span class="ss">:eof</span><span class="p">)</span>
   <span class="nb">do</span>
   <span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">chunk</span> <span class="p">(</span><span class="nv">split</span> <span class="s">&quot;\\s+&quot;</span>         <span class="c1">; LINE is split on whitespace</span>
                                        <span class="c1">; then CHUNK is set to each chunk in turn</span>
                         <span class="p">(</span><span class="nv">chomp</span> <span class="nv">line</span><span class="p">)))</span> <span class="c1">; LINE has a trailing \n removed, if it had one</span>
     <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A&quot;</span>                     <span class="c1">; CHUNK is printed</span>
             <span class="p">(</span><span class="nb">reverse</span> <span class="nv">chunk</span><span class="p">))))</span>         <span class="c1">; the characters in CHUNK are reversed</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">map</span> <span class="no">nil</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">item</span><span class="p">)</span>
             <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;i = ~A~%&quot;</span> <span class="nv">item</span><span class="p">))</span>
     <span class="nv">my-array</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">my-array</span> <span class="o">#(</span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span><span class="p">))</span>
<span class="p">(</span><span class="nb">map-into</span> <span class="nv">my-array</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">item</span><span class="p">)</span> <span class="p">(</span><span class="nb">decf</span> <span class="nv">item</span><span class="p">))</span> <span class="nv">my-array</span><span class="p">)</span>
<span class="nv">my-array</span>
<span class="c1">;; #(0 1 2)</span>

<span class="c1">;; multiply everything in a and b by seven</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">a</span> <span class="o">#(</span><span class="mf">.5</span> <span class="mi">3</span><span class="p">)</span> <span class="nv">b</span> <span class="o">#(</span><span class="mi">0</span> <span class="mi">1</span><span class="p">))</span>
<span class="p">(</span><span class="nb">map-into</span> <span class="nv">a</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">item</span><span class="p">)</span> <span class="p">(</span><span class="nb">*</span> <span class="nv">item</span> <span class="mi">7</span><span class="p">))</span> <span class="nv">a</span><span class="p">)</span>
<span class="p">(</span><span class="nb">map-into</span> <span class="nv">b</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">item</span><span class="p">)</span> <span class="p">(</span><span class="nb">*</span> <span class="nv">item</span> <span class="mi">7</span><span class="p">))</span> <span class="nv">b</span><span class="p">)</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~{~A~^ ~} ~{~A~^ ~}~%&quot;</span> <span class="p">(</span><span class="nb">coerce</span> <span class="nv">a</span> <span class="ss">&#39;list</span><span class="p">)</span> <span class="p">(</span><span class="nb">coerce</span> <span class="nv">b</span> <span class="ss">&#39;list</span><span class="p">))</span>
<span class="c1">;; 3.5 21 0 7</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; The following macro is mostly like Perl&#39;s foreach, in the sense</span>
<span class="c1">;; that you can pass in as many references to sequences or &quot;scalars&quot;</span>
<span class="c1">;; as you want and it will iterate over them and allow you to modify</span>
<span class="c1">;; them.  Unlike the Perl code, it sets the variable IT to each</span>
<span class="c1">;; element rather than $_.  Also, you have to just pass in the hash</span>
<span class="c1">;; table directly, not a flattened list of hash keys.</span>
<span class="p">(</span><span class="nb">defmacro</span> <span class="nv">perl-foreach</span> <span class="p">((</span><span class="k">&amp;rest</span> <span class="nv">refs</span><span class="p">)</span> <span class="k">&amp;body</span> <span class="nv">body</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="nv">gensyms</span> <span class="p">(</span><span class="nb">loop</span> <span class="nv">repeat</span> <span class="p">(</span><span class="nb">length</span> <span class="nv">refs</span><span class="p">)</span> <span class="nv">collect</span> <span class="p">(</span><span class="nb">gensym</span><span class="p">))))</span>
    <span class="p">(</span><span class="nb">list*</span>
     <span class="ss">&#39;let</span>
     <span class="p">(</span><span class="nb">mapcar</span> <span class="nf">#&#39;</span><span class="nb">list</span> <span class="nv">gensyms</span> <span class="nv">refs</span><span class="p">)</span>
     <span class="p">(</span><span class="nb">loop</span>
        <span class="nv">for</span> <span class="nv">ref</span> <span class="nv">in</span> <span class="nv">refs</span>
        <span class="nb">and</span> <span class="nv">indirect-ref</span> <span class="nv">in</span> <span class="nv">gensyms</span>
        <span class="nv">collect</span>
        <span class="o">`</span><span class="p">(</span><span class="nb">typecase</span> <span class="o">,</span><span class="nv">indirect-ref</span>
           <span class="p">(</span><span class="nc">hash-table</span>
            <span class="p">(</span><span class="nb">maphash</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">key</span> <span class="nv">value</span><span class="p">)</span>
                         <span class="p">(</span><span class="k">declare</span> <span class="p">(</span><span class="k">ignore</span> <span class="nv">value</span><span class="p">))</span>
                         <span class="p">(</span><span class="k">symbol-macrolet</span> <span class="p">((</span><span class="nv">it</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">key</span> <span class="o">,</span><span class="nv">indirect-ref</span><span class="p">)))</span>
                           <span class="o">,@</span><span class="nv">body</span><span class="p">))</span>
                     <span class="o">,</span><span class="nv">indirect-ref</span><span class="p">))</span>
           <span class="p">((</span><span class="nb">and</span> <span class="p">(</span><span class="nb">or</span> <span class="nb">vector</span> <span class="nb">list</span><span class="p">)</span> <span class="p">(</span><span class="nb">not</span> <span class="nb">string</span><span class="p">))</span>
            <span class="p">(</span><span class="nb">map-into</span> <span class="o">,</span><span class="nv">indirect-ref</span>
                      <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">it</span><span class="p">)</span>
                          <span class="o">,@</span><span class="nv">body</span>
                          <span class="nv">it</span><span class="p">)</span>
                      <span class="o">,</span><span class="nv">indirect-ref</span><span class="p">))</span>
           <span class="p">(</span><span class="no">t</span>
            <span class="p">(</span><span class="k">symbol-macrolet</span> <span class="p">((</span><span class="nv">it</span> <span class="o">,</span><span class="nv">ref</span><span class="p">))</span>
              <span class="o">,@</span><span class="nv">body</span><span class="p">)))))))</span>

<span class="c1">;; trim whitespace in the scalar, the list, the array, and all the</span>
<span class="c1">;; values in the hash</span>
<span class="p">(</span><span class="nv">perl-foreach</span> <span class="p">(</span><span class="nv">scalar</span> <span class="nv">my-list</span> <span class="nv">my-array</span> <span class="nv">my-hash</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">setf</span> <span class="nv">it</span> <span class="p">(</span><span class="nv">regex-replace</span> <span class="s">&quot;^\\s+&quot;</span> <span class="nv">it</span> <span class="s">&quot;&quot;</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">setf</span> <span class="nv">it</span> <span class="p">(</span><span class="nv">regex-replace</span> <span class="s">&quot;\\s+$&quot;</span> <span class="nv">it</span> <span class="s">&quot;&quot;</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; The Perl code in this subsection is Perl-specific (demonstrating</span>
<span class="c1">;; the shorthand syntax for &quot;foreach&quot;).</span>
<span class="c1">;;;-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN185"
>Iterating Over an Array by Reference</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">;;;-----------------------------</span>
<span class="c1">;; iterate over elements of array in ARRAYREF (but if you intend to</span>
<span class="c1">;; modify the elemnts, it will only modify non-&quot;scalar&quot; elements such</span>
<span class="c1">;; as lists, structures, etc).</span>
<span class="p">(</span><span class="nb">map</span> <span class="ss">&#39;array</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">item</span><span class="p">)</span>
                <span class="c1">;; do something with ITEM</span>
                <span class="p">)</span>
     <span class="nv">arrayref</span><span class="p">)</span>

<span class="c1">;; or you can use LOOP</span>
<span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">item</span> <span class="nv">across</span> <span class="nv">arrayref</span>
     <span class="nb">do</span> <span class="c1">;; do something with ITEM</span>
     <span class="p">)</span>

<span class="c1">;; to modify the array contents (even if they&#39;re &quot;scalars&quot; like</span>
<span class="c1">;; numbers)</span>
<span class="p">(</span><span class="nb">map-into</span> <span class="nv">arrayref</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">item</span><span class="p">)</span>
                       <span class="c1">;; do something with ITEM</span>
                       <span class="p">)</span>
          <span class="nv">arrayref</span><span class="p">)</span>

<span class="c1">;; or you can use ITER</span>
<span class="p">(</span><span class="nv">iter</span> <span class="p">(</span><span class="nv">for</span> <span class="nv">i</span> <span class="nv">index-of-vector</span> <span class="nv">arrayref</span><span class="p">)</span>
      <span class="c1">;; do something with (aref arrayref i)</span>
      <span class="p">)</span>

<span class="c1">;; As a side note, for lists you could also do the following (won&#39;t</span>
<span class="c1">;; allow modifying &quot;scalar&quot; elements of the list).</span>
<span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">item</span> <span class="nb">list</span><span class="p">)</span>
  <span class="c1">;; do something with ITEM</span>
  <span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*fruits*</span> <span class="o">#(</span><span class="s">&quot;Apple&quot;</span> <span class="s">&quot;Blackberry&quot;</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">fruit-ref</span> <span class="vg">*fruits*</span><span class="p">)</span>
<span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">fruit</span> <span class="nv">across</span> <span class="nv">fruit-ref</span>
   <span class="nb">do</span> <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A tastes good in a pie.~%&quot;</span> <span class="nv">fruit</span><span class="p">))</span>
<span class="c1">;;Apple tastes good in a pie.</span>
<span class="c1">;;Blackberry tastes good in a pie.</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">i</span> <span class="nv">below</span> <span class="p">(</span><span class="nb">length</span> <span class="nv">fruit-ref</span><span class="p">)</span>
   <span class="nb">do</span> <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A tastes good in a pie.~%&quot;</span> <span class="p">(</span><span class="nb">svref</span> <span class="nv">fruit-ref</span> <span class="nv">i</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:felines</span> <span class="vg">*namelist*</span><span class="p">)</span> <span class="vg">*rogue-cats*</span><span class="p">)</span>
<span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">cat</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:felines</span> <span class="vg">*namelist*</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A purrs hypnotically..~%&quot;</span> <span class="nv">cat</span><span class="p">))</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;--More--~%You are controlled.~%&quot;</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">i</span> <span class="nv">below</span> <span class="p">(</span><span class="nb">length</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:felines</span> <span class="vg">*namelist*</span><span class="p">))</span>
   <span class="nb">do</span> <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A purrs hypnotically..~%&quot;</span> <span class="p">(</span><span class="nb">elt</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:felines</span> <span class="vg">*namelist*</span><span class="p">)</span> <span class="nv">i</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN188"
>Extracting Unique Elements from a List</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*seen*</span> <span class="p">(</span><span class="nb">make-hash-table</span> <span class="ss">:test</span> <span class="ss">&#39;equal</span><span class="p">))</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*uniq*</span> <span class="o">&#39;</span><span class="p">())</span>

<span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">item</span> <span class="nv">my-list</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">item</span> <span class="vg">*seen*</span><span class="p">)</span>
    <span class="c1">;; if we are here, we have not seen it before</span>
    <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">item</span> <span class="vg">*seen*</span><span class="p">)</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">push</span> <span class="nv">item</span> <span class="vg">*uniq*</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">clrhash</span> <span class="vg">*seen*</span><span class="p">)</span>
<span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">item</span> <span class="nv">my-list</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">=</span> <span class="p">(</span><span class="nb">incf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">item</span> <span class="vg">*seen*</span> <span class="mi">0</span><span class="p">))</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">push</span> <span class="nv">item</span> <span class="vg">*uniq*</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">clrhash</span> <span class="vg">*seen*</span><span class="p">)</span>
<span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">item</span> <span class="nv">my-list</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">=</span> <span class="p">(</span><span class="nb">incf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">item</span> <span class="vg">*seen*</span> <span class="mi">0</span><span class="p">))</span> <span class="mi">1</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">some-func</span> <span class="nv">item</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">clrhash</span> <span class="vg">*seen*</span><span class="p">)</span>
<span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">item</span> <span class="nv">my-list</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">incf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">item</span> <span class="vg">*seen*</span> <span class="mi">0</span><span class="p">)))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="vg">*uniq*</span> <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">k</span> <span class="nv">being</span> <span class="k">the</span> <span class="nv">hash-keys</span> <span class="nv">of</span> <span class="vg">*seen*</span> <span class="nv">collect</span> <span class="nv">k</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">clrhash</span> <span class="vg">*seen*</span><span class="p">)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="vg">*uniq*</span> <span class="p">(</span><span class="nv">perl-grep</span> <span class="nv">my-list</span> <span class="p">(</span><span class="nb">=</span> <span class="mi">1</span> <span class="p">(</span><span class="nb">incf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">it</span> <span class="vg">*seen*</span> <span class="mi">0</span><span class="p">)))))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; generate a list of users logged in, removing duplicates</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*ucnt*</span> <span class="p">(</span><span class="nb">make-hash-table</span> <span class="ss">:test</span> <span class="ss">&#39;equal</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defmacro</span> <span class="nv">dostream</span> <span class="p">((</span><span class="nv">var</span> <span class="nc">stream</span><span class="p">)</span> <span class="k">&amp;body</span> <span class="nv">body</span><span class="p">)</span>
  <span class="s">&quot;Like DOLIST except iterates over the lines of STREAM.  Does not</span>
<span class="s">close STREAM.&quot;</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">s</span> <span class="p">(</span><span class="nb">gensym</span> <span class="s">&quot;stream-&quot;</span><span class="p">))</span>
        <span class="p">(</span><span class="nv">eof</span> <span class="p">(</span><span class="nb">gensym</span> <span class="s">&quot;eof-&quot;</span><span class="p">)))</span>
    <span class="o">`</span><span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="o">,</span><span class="nv">s</span> <span class="o">,</span><span class="nc">stream</span><span class="p">))</span>
       <span class="p">(</span><span class="nb">do</span> <span class="p">((</span><span class="o">,</span><span class="nv">var</span> <span class="p">(</span><span class="nb">read-line</span> <span class="o">,</span><span class="nv">s</span> <span class="no">nil</span> <span class="ss">&#39;,eof</span> <span class="no">nil</span><span class="p">)</span>
                  <span class="p">(</span><span class="nb">read-line</span> <span class="o">,</span><span class="nv">s</span> <span class="no">nil</span> <span class="ss">&#39;,eof</span> <span class="no">nil</span><span class="p">)))</span>
           <span class="p">((</span><span class="nb">eql</span> <span class="o">,</span><span class="nv">var</span> <span class="ss">&#39;,eof</span><span class="p">))</span>
         <span class="o">,@</span><span class="nv">body</span><span class="p">))))</span>

<span class="o">#+</span><span class="nv">sbcl</span>
<span class="p">(</span><span class="nb">with-open-stream</span> <span class="p">(</span><span class="nv">s</span> <span class="p">(</span><span class="nv">process-output</span>
                      <span class="p">(</span><span class="nv">sb-ext:run-program</span> <span class="s">&quot;who&quot;</span> <span class="no">nil</span> <span class="ss">:search</span> <span class="no">t</span> <span class="ss">:output</span> <span class="ss">:stream</span> <span class="ss">:wait</span> <span class="no">nil</span><span class="p">)))</span>
  <span class="p">(</span><span class="nv">dostream</span> <span class="p">(</span><span class="nv">who</span> <span class="nv">s</span><span class="p">)</span>
    <span class="c1">;; kill from first space till end-of-line, yielding username</span>
    <span class="p">(</span><span class="nb">setf</span> <span class="nv">who</span> <span class="p">(</span><span class="nv">regex-replace</span> <span class="s">&quot;\\s.*$&quot;</span> <span class="nv">who</span> <span class="s">&quot;&quot;</span><span class="p">))</span>
    <span class="p">(</span><span class="nb">incf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">who</span> <span class="vg">*ucnt*</span> <span class="mi">0</span><span class="p">))))</span> <span class="c1">; record the presence of this user</span>
<span class="c1">;; extract and print unique keys</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*users*</span> <span class="p">(</span><span class="nb">sort</span> <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">k</span> <span class="nv">being</span> <span class="k">the</span> <span class="nv">hash-keys</span> <span class="nv">of</span> <span class="vg">*ucnt*</span> <span class="nv">collect</span> <span class="nv">k</span><span class="p">)</span> <span class="nf">#&#39;</span><span class="nb">string=</span><span class="p">))</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;users logged in: ~{~A~^ ~}~%&quot;</span> <span class="vg">*users*</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN191"
>Finding Elements in One Array but Not Another</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">;;;-----------------------------</span>
<span class="c1">;; assume A and B are already loaded</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*seen*</span> <span class="p">(</span><span class="nb">make-hash-table</span> <span class="ss">:test</span> <span class="ss">&#39;equal</span><span class="p">))</span> <span class="c1">; lookup table to test membership of B</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*a-only*</span> <span class="o">&#39;</span><span class="p">())</span>                          <span class="c1">; answer</span>

<span class="c1">;; build lookup table</span>
<span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">item</span> <span class="nv">in</span> <span class="nv">b</span> <span class="nb">do</span> <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">item</span> <span class="vg">*seen*</span><span class="p">)</span> <span class="mi">1</span><span class="p">))</span>

<span class="c1">;; find only elements in A and not in B</span>
<span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">item</span> <span class="nv">a</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">item</span> <span class="vg">*seen*</span><span class="p">)</span>
    <span class="c1">;; it&#39;s not in SEEN, so add to *A-ONLY*</span>
    <span class="p">(</span><span class="nb">push</span> <span class="nv">item</span> <span class="vg">*a-only*</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; The Perl example here isn&#39;t substantially different from the above</span>
<span class="c1">;; in CL.</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">item</span> <span class="nv">a</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">item</span> <span class="vg">*seen*</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">push</span> <span class="nv">item</span> <span class="vg">*a-only*</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">item</span> <span class="vg">*seen*</span><span class="p">)</span> <span class="mi">1</span><span class="p">))</span> <span class="c1">; mark as seen</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="s">&quot;key1&quot;</span> <span class="nv">my-hash</span><span class="p">)</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="s">&quot;key2&quot;</span> <span class="nv">my-hash</span><span class="p">)</span> <span class="mi">2</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">loop</span>
   <span class="nv">for</span> <span class="nv">key</span> <span class="nv">in</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;key1&quot;</span> <span class="s">&quot;key2&quot;</span><span class="p">)</span>
   <span class="nb">and</span> <span class="nv">value</span> <span class="nv">in</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">1</span> <span class="mi">2</span><span class="p">)</span>
   <span class="nb">do</span> <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">key</span> <span class="nv">my-hash</span><span class="p">)</span> <span class="nv">value</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">loop</span>
   <span class="nv">for</span> <span class="nv">key</span> <span class="nv">in</span> <span class="nv">b</span>
   <span class="nb">do</span> <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">key</span> <span class="nv">my-hash</span><span class="p">)</span> <span class="no">nil</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">loop</span>
   <span class="nv">for</span> <span class="nv">key</span> <span class="nv">in</span> <span class="nv">b</span>
   <span class="nb">do</span> <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">key</span> <span class="nv">my-hash</span><span class="p">)</span> <span class="p">(</span><span class="nb">loop</span> <span class="nv">repeat</span> <span class="p">(</span><span class="nb">length</span> <span class="nv">b</span><span class="p">)</span> <span class="nv">collect</span> <span class="mi">1</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN194"
>Computing Union, Intersection, or Difference of Unique Lists</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*a*</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">1</span> <span class="mi">3</span> <span class="mi">5</span> <span class="mi">6</span> <span class="mi">7</span> <span class="mi">8</span><span class="p">))</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*b*</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">2</span> <span class="mi">3</span> <span class="mi">5</span> <span class="mi">7</span> <span class="mi">9</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defvar</span> <span class="vg">*union*</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defvar</span> <span class="vg">*isect*</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defvar</span> <span class="vg">*diff*</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*union-hash*</span> <span class="p">(</span><span class="nb">make-hash-table</span><span class="p">))</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*isect-hash*</span> <span class="p">(</span><span class="nb">make-hash-table</span><span class="p">))</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*count*</span> <span class="p">(</span><span class="nb">make-hash-table</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; don&#39;t actually do this, use instead the built-ins shown at the end</span>
<span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">e</span> <span class="vg">*a*</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">e</span> <span class="vg">*union-hash*</span><span class="p">)</span> <span class="mi">1</span><span class="p">))</span>

<span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">e</span> <span class="vg">*b*</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">e</span> <span class="vg">*union-hash*</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">e</span> <span class="vg">*isect-hash*</span><span class="p">)</span> <span class="mi">1</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">e</span> <span class="vg">*union-hash*</span><span class="p">)</span> <span class="mi">1</span><span class="p">))</span>

<span class="p">(</span><span class="nb">setf</span> <span class="vg">*union*</span> <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">k</span> <span class="nv">being</span> <span class="k">the</span> <span class="nv">hash-keys</span> <span class="nv">of</span> <span class="vg">*union-hash*</span> <span class="nv">collect</span> <span class="nv">k</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="vg">*isect*</span> <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">k</span> <span class="nv">being</span> <span class="k">the</span> <span class="nv">hash-keys</span> <span class="nv">of</span> <span class="vg">*isect-hash*</span> <span class="nv">collect</span> <span class="nv">k</span><span class="p">))</span>

<span class="c1">;; or you could use the built ins</span>
<span class="p">(</span><span class="nb">setf</span> <span class="vg">*union*</span> <span class="p">(</span><span class="nb">union</span> <span class="vg">*a*</span> <span class="vg">*b*</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="vg">*isect*</span> <span class="p">(</span><span class="nb">intersection</span> <span class="vg">*a*</span> <span class="vg">*b*</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nv">perl-foreach</span> <span class="p">(</span><span class="vg">*a*</span> <span class="vg">*b*</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">and</span> <span class="p">(</span><span class="nb">prog1</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">it</span> <span class="vg">*union-hash*</span><span class="p">)</span>
         <span class="p">(</span><span class="nb">incf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">it</span> <span class="vg">*union-hash*</span> <span class="mi">0</span><span class="p">)))</span>
       <span class="p">(</span><span class="nb">incf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">it</span> <span class="vg">*isect-hash*</span> <span class="mi">0</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">setf</span> <span class="vg">*union*</span> <span class="p">(</span><span class="nv">hash-keys</span> <span class="vg">*union-hash*</span><span class="p">))</span> <span class="c1">; HASH-KEYS defined in Appendix</span>
<span class="p">(</span><span class="nb">setf</span> <span class="vg">*isect*</span> <span class="p">(</span><span class="nv">hash-keys</span> <span class="vg">*isect-hash*</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nv">perl-foreach</span> <span class="p">(</span><span class="vg">*a*</span> <span class="vg">*b*</span><span class="p">)</span> <span class="p">(</span><span class="nb">incf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">it</span> <span class="vg">*count*</span> <span class="mi">0</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">loop</span>
   <span class="nv">for</span> <span class="nv">e</span> <span class="nv">being</span> <span class="k">the</span> <span class="nv">hash-keys</span> <span class="nv">of</span> <span class="vg">*count*</span> <span class="nv">using</span> <span class="p">(</span><span class="nv">hash-value</span> <span class="nb">count</span><span class="p">)</span>
   <span class="nb">do</span>
   <span class="p">(</span><span class="nb">push</span> <span class="nv">e</span> <span class="vg">*union*</span><span class="p">)</span>
   <span class="p">(</span><span class="nb">case</span> <span class="nb">count</span>
     <span class="p">(</span><span class="mi">2</span> <span class="p">(</span><span class="nb">push</span> <span class="nv">e</span> <span class="vg">*isect*</span><span class="p">))</span>
     <span class="p">(</span><span class="no">t</span> <span class="p">(</span><span class="nb">push</span> <span class="nv">e</span> <span class="vg">*diff*</span><span class="p">))))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Without writing a special macro, there&#39;d be no obvious difference</span>
<span class="c1">;; from the previous example.</span>
<span class="c1">;;;-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN197"
>Appending One Array to Another</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">;;;-----------------------------</span>
<span class="c1">;; push</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">array1</span> <span class="p">(</span><span class="nb">append</span> <span class="nv">array1</span> <span class="nv">array2</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">array1</span> <span class="o">`</span><span class="p">(</span><span class="o">,@</span><span class="nv">array1</span> <span class="o">,@</span><span class="nv">array2</span><span class="p">))</span>
<span class="c1">;;-----------------------------</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">members</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;Time&quot;</span> <span class="s">&quot;Flies&quot;</span><span class="p">))</span>
      <span class="p">(</span><span class="nv">initiates</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;An&quot;</span> <span class="s">&quot;Arrow&quot;</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">setf</span> <span class="nv">members</span> <span class="p">(</span><span class="nb">append</span> <span class="nv">members</span> <span class="nv">initiates</span><span class="p">))</span>
<span class="c1">;; members is now (&quot;Time&quot; &quot;Flies&quot; &quot;An&quot; &quot;Arrow&quot;)</span>
<span class="c1">;;;-----------------------------</span>
  <span class="p">(</span><span class="nb">setf</span> <span class="nv">members</span> <span class="o">`</span><span class="p">(</span><span class="o">,@</span><span class="p">(</span><span class="nb">subseq</span> <span class="nv">members</span> <span class="mi">0</span> <span class="mi">2</span><span class="p">)</span> <span class="s">&quot;Like&quot;</span> <span class="o">,@</span><span class="nv">initiates</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~{~a~^ ~}~%&quot;</span> <span class="nv">members</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">setf</span> <span class="nv">members</span> <span class="o">`</span><span class="p">(</span><span class="s">&quot;Fruit&quot;</span> <span class="o">,@</span><span class="p">(</span><span class="nb">subseq</span> <span class="nv">members</span> <span class="mi">1</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">setf</span> <span class="nv">members</span> <span class="o">`</span><span class="p">(</span><span class="o">,@</span><span class="p">(</span><span class="nb">subseq</span> <span class="nv">members</span> <span class="mi">0</span> <span class="p">(</span><span class="nb">-</span> <span class="p">(</span><span class="nb">length</span> <span class="nv">members</span><span class="p">)</span> <span class="mi">2</span><span class="p">))</span> <span class="s">&quot;A&quot;</span> <span class="s">&quot;Banana&quot;</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~{~a~^ ~}~%&quot;</span> <span class="nv">members</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;;Time Flies Like An Arrow</span>
<span class="c1">;;Fruit Flies Like A Banana</span>
<span class="c1">;;;-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN200"
>Reversing an Array</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">;;;-----------------------------</span>
<span class="c1">;; reverse ARRAY into REVERSED</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">reversed</span> <span class="p">(</span><span class="nb">reverse</span> <span class="vg">*array*</span><span class="p">))</span>
<span class="c1">;;-----------------------------</span>
<span class="p">(</span><span class="nb">do</span> <span class="p">((</span><span class="nv">i</span> <span class="p">(</span><span class="nb">1-</span> <span class="p">(</span><span class="nb">array-dimension</span> <span class="vg">*array*</span> <span class="mi">0</span><span class="p">))</span> <span class="p">(</span><span class="nb">1-</span> <span class="nv">i</span><span class="p">)))</span>
    <span class="p">((</span><span class="nb">minusp</span> <span class="nv">i</span><span class="p">))</span>
  <span class="c1">;; do something with (aref array i)</span>
  <span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; two-step: sort then reverse</span>
<span class="c1">;; SORT is destructive, hence STABLE-SORT</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">ascending</span> <span class="p">(</span><span class="nb">stable-sort</span> <span class="nv">users</span> <span class="ss">&#39;string-lessp</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">descending</span> <span class="p">(</span><span class="nb">reverse</span> <span class="nv">ascending</span><span class="p">))</span>

<span class="c1">;; one-step: sort with reverse comparison</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">descending</span> <span class="p">(</span><span class="nb">reverse</span> <span class="p">(</span><span class="nb">stable-sort</span> <span class="nv">users</span> <span class="ss">&#39;string-lessp</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN203"
>Processing Multiple Elements of an Array</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">;;;-----------------------------</span>
<span class="c1">;; Removing N elements from front of MY-ARRAY requires 2 steps in CL.</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">front</span> <span class="p">(</span><span class="nb">subseq</span> <span class="nv">my-array</span> <span class="mi">0</span> <span class="nv">n</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">my-array</span> <span class="p">(</span><span class="nb">subseq</span> <span class="nv">my-array</span> <span class="nv">n</span><span class="p">))</span>

<span class="c1">;; We can write a macro to mimic Perl&#39;s behavior, however.</span>
<span class="p">(</span><span class="nb">defmacro</span> <span class="nv">perl-splice</span> <span class="p">(</span><span class="nv">sequence-place</span> <span class="k">&amp;optional</span> <span class="p">(</span><span class="nv">offset</span> <span class="mi">0</span><span class="p">)</span> <span class="nb">length</span> <span class="nv">replacement-sequence</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="nv">seq</span> <span class="p">(</span><span class="nb">gensym</span> <span class="s">&quot;SEQUENCE-PLACE-&quot;</span><span class="p">))</span>
         <span class="p">(</span><span class="nv">off-arg</span> <span class="p">(</span><span class="nb">gensym</span> <span class="s">&quot;OFFSET-ARG-&quot;</span><span class="p">))</span>
         <span class="p">(</span><span class="nv">off</span> <span class="p">(</span><span class="nb">gensym</span> <span class="s">&quot;OFFSET-&quot;</span><span class="p">))</span>
         <span class="p">(</span><span class="nv">len</span> <span class="p">(</span><span class="nb">gensym</span> <span class="s">&quot;LENGTH-&quot;</span><span class="p">))</span>
         <span class="p">(</span><span class="nv">end</span> <span class="p">(</span><span class="nb">gensym</span> <span class="s">&quot;END-&quot;</span><span class="p">))</span>
         <span class="p">(</span><span class="nv">rep</span> <span class="p">(</span><span class="nb">gensym</span> <span class="s">&quot;REPLACEMENT-SEQUENCE-&quot;</span><span class="p">))</span>
         <span class="p">(</span><span class="nv">left-part</span> <span class="p">(</span><span class="nb">list</span> <span class="o">`</span><span class="p">(</span><span class="nb">subseq</span> <span class="o">,</span><span class="nv">seq</span> <span class="mi">0</span> <span class="o">,</span><span class="nv">off</span><span class="p">)))</span>
         <span class="p">(</span><span class="nv">right-part</span> <span class="p">(</span><span class="nb">when</span> <span class="nb">length</span>
                       <span class="p">(</span><span class="nb">list</span> <span class="o">`</span><span class="p">(</span><span class="nb">subseq</span> <span class="o">,</span><span class="nv">seq</span> <span class="o">,</span><span class="nv">end</span><span class="p">)))))</span>
    <span class="o">`</span><span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="o">,</span><span class="nv">seq</span> <span class="o">,</span><span class="nv">sequence-place</span><span class="p">)</span>
            <span class="p">(</span><span class="o">,</span><span class="nv">off-arg</span> <span class="o">,</span><span class="nv">offset</span><span class="p">)</span>
            <span class="p">(</span><span class="o">,</span><span class="nv">off</span> <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">minusp</span> <span class="o">,</span><span class="nv">off-arg</span><span class="p">)</span>
                      <span class="p">(</span><span class="nb">+</span> <span class="p">(</span><span class="nb">length</span> <span class="o">,</span><span class="nv">seq</span><span class="p">)</span> <span class="o">,</span><span class="nv">off-arg</span><span class="p">)</span>
                      <span class="o">,</span><span class="nv">off-arg</span><span class="p">))</span>
            <span class="p">(</span><span class="o">,</span><span class="nv">len</span> <span class="o">,</span><span class="nb">length</span><span class="p">)</span>
            <span class="p">(</span><span class="o">,</span><span class="nv">end</span> <span class="p">(</span><span class="nb">when</span> <span class="o">,</span><span class="nv">len</span>
                    <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">minusp</span> <span class="o">,</span><span class="nv">len</span><span class="p">)</span>
                        <span class="p">(</span><span class="nb">+</span> <span class="p">(</span><span class="nb">length</span> <span class="o">,</span><span class="nv">seq</span><span class="p">)</span> <span class="o">,</span><span class="nv">len</span><span class="p">)</span>
                        <span class="p">(</span><span class="nb">+</span> <span class="o">,</span><span class="nv">off</span> <span class="o">,</span><span class="nv">len</span><span class="p">))))</span>
            <span class="p">(</span><span class="o">,</span><span class="nv">rep</span> <span class="o">,</span><span class="nv">replacement-sequence</span><span class="p">))</span>
       <span class="p">(</span><span class="nb">prog1</span> <span class="p">(</span><span class="nb">subseq</span> <span class="o">,</span><span class="nv">seq</span> <span class="o">,</span><span class="nv">off</span> <span class="o">,</span><span class="nv">end</span><span class="p">)</span>
         <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">or</span> <span class="o">,</span><span class="nv">rep</span> <span class="p">(</span><span class="nb">not</span> <span class="p">(</span><span class="nb">eql</span> <span class="o">,</span><span class="nv">off</span> <span class="o">,</span><span class="nv">end</span><span class="p">)))</span>
           <span class="p">(</span><span class="nb">setf</span> <span class="o">,</span><span class="nv">sequence-place</span> <span class="p">(</span><span class="nb">concatenate</span> <span class="p">(</span><span class="nb">typecase</span> <span class="o">,</span><span class="nv">seq</span>
                                                <span class="p">(</span><span class="nb">cons</span> <span class="ss">&#39;list</span><span class="p">)</span>
                                              <span class="p">(</span><span class="no">t</span> <span class="ss">&#39;vector</span><span class="p">))</span>
                                            <span class="o">,@</span><span class="nv">left-part</span>
                                            <span class="o">,</span><span class="nv">rep</span>
                                            <span class="o">,@</span><span class="nv">right-part</span><span class="p">)))))))</span>

<span class="c1">;; Now the syntax is almost exactly the same.</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">front</span> <span class="p">(</span><span class="nv">perl-splice</span> <span class="nv">my-array</span> <span class="mi">0</span> <span class="nv">n</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">end</span> <span class="p">(</span><span class="nv">perl-splice</span> <span class="nv">my-array</span> <span class="mi">0</span> <span class="p">(</span><span class="nb">-</span> <span class="nv">n</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defmacro</span> <span class="nv">shift2</span> <span class="p">(</span><span class="nc">sequence</span><span class="p">)</span>
  <span class="o">`</span><span class="p">(</span><span class="nv">perl-splice</span> <span class="o">,</span><span class="nc">sequence</span> <span class="mi">0</span> <span class="mi">2</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defmacro</span> <span class="nv">pop2</span> <span class="p">(</span><span class="nc">sequence</span><span class="p">)</span>
  <span class="o">`</span><span class="p">(</span><span class="nv">perl-splice</span> <span class="o">,</span><span class="nc">sequence</span> <span class="mi">-2</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*friends*</span> <span class="o">&#39;</span><span class="p">(</span><span class="nv">Peter</span> <span class="nv">Paul</span> <span class="nv">Mary</span> <span class="nv">Jim</span> <span class="nv">Tim</span><span class="p">))</span>

<span class="p">(</span><span class="nb">destructuring-bind</span> <span class="p">(</span><span class="nv">this</span> <span class="nv">that</span><span class="p">)</span> <span class="p">(</span><span class="nv">shift2</span> <span class="vg">*friends*</span><span class="p">)</span>
  <span class="c1">;; THIS contains PETER, THAT has PAUL, and</span>
  <span class="c1">;; *FRIENDS* has MARY, JIM, and TIM</span>
  <span class="p">)</span>

<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*beverages*</span> <span class="o">#(</span><span class="nv">Dew</span> <span class="nv">Jolt</span> <span class="nv">Cola</span> <span class="nv">Sprite</span> <span class="nv">Fresca</span><span class="p">))</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">pair</span> <span class="p">(</span><span class="nv">pop2</span> <span class="vg">*beverages*</span><span class="p">)))</span>
  <span class="c1">;; (aref pair 0) contains Sprite, (aref pair 1) has Fresca,</span>
  <span class="c1">;; and *beverages* has #(DEW JOLT COLA)</span>
  <span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">aref</span> <span class="nv">line</span> <span class="mi">5</span><span class="p">)</span> <span class="nv">my-list</span><span class="p">)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">got</span> <span class="p">(</span><span class="nv">pop2</span> <span class="p">(</span><span class="nb">aref</span> <span class="nv">line</span> <span class="mi">5</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN206"
>Finding the First List Element That Passes a Test</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">match</span> <span class="p">(</span><span class="nb">find</span> <span class="nv">item</span> <span class="vg">*sequence*</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">cond</span>
    <span class="p">(</span><span class="nv">match</span>
     <span class="c1">;; do something with MATCH</span>
     <span class="p">)</span>
    <span class="p">(</span><span class="no">t</span>
     <span class="c1">;; unfound</span>
     <span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">match-idx</span> <span class="p">(</span><span class="nb">position</span> <span class="nv">item</span> <span class="vg">*sequence*</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">cond</span>
    <span class="p">(</span><span class="nv">match-idx</span>
     <span class="c1">;; found in (elt *sequence* match-idx) (any sequence)</span>
     <span class="c1">;; or (svref *sequence* match-idx) if you know it&#39;s a vector</span>
     <span class="p">)</span>
    <span class="p">(</span><span class="no">t</span>
     <span class="c1">;; unfound</span>
     <span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defstruct</span> <span class="nv">employee</span> <span class="nv">name</span> <span class="nv">category</span><span class="p">)</span> <span class="c1">; just to make example work</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;Highest paid engineer is: ~A~%&quot;</span>
        <span class="p">(</span><span class="nv">employee-name</span> <span class="p">(</span><span class="nb">find</span> <span class="ss">&#39;engineer</span> <span class="vg">*employees*</span> <span class="ss">:key</span> <span class="ss">&#39;employee-category</span> <span class="ss">:from-end</span> <span class="no">t</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Don&#39;t do this, just intended how one could match the Perl example.</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">i</span>
       <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">idx</span> <span class="nv">below</span> <span class="p">(</span><span class="nb">length</span> <span class="vg">*array*</span><span class="p">)</span>
          <span class="c1">;;</span>
          <span class="nb">do</span> <span class="p">(</span><span class="nb">when</span> <span class="nv">criterion</span> <span class="c1">;; put criterion here</span>
               <span class="p">(</span><span class="nb">return</span> <span class="nv">idx</span><span class="p">)))))</span>
  <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">&lt;</span> <span class="nv">i</span> <span class="p">(</span><span class="nb">length</span> <span class="vg">*array*</span><span class="p">))</span>
      <span class="p">(</span><span class="k">progn</span>
        <span class="c1">;; found and I is the index</span>
        <span class="p">)</span>
      <span class="p">(</span><span class="k">progn</span>
        <span class="c1">;; not found</span>
        <span class="p">)))</span>
<span class="c1">;;;-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN209"
>Finding All Elements in an Array Matching Certain Criteria</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">matching</span> <span class="p">(</span><span class="nb">find-if-not</span> <span class="nf">#&#39;</span><span class="nv">test</span> <span class="nb">list</span><span class="p">))</span>
<span class="c1">;;-----------------------------</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">matching</span> <span class="o">&#39;</span><span class="p">()))</span>
  <span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">item</span> <span class="nb">list</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nv">test</span> <span class="nv">item</span><span class="p">)</span> <span class="p">(</span><span class="nb">push</span> <span class="nv">item</span> <span class="nv">matching</span><span class="p">))))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">bigs</span> <span class="p">(</span><span class="nb">remove-if-not</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">num</span><span class="p">)</span> <span class="p">(</span><span class="nb">&gt;</span> <span class="nv">num</span> <span class="mi">1000000</span><span class="p">))</span> <span class="nv">nums</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">pigs</span> <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">user</span> <span class="nv">being</span> <span class="k">the</span> <span class="nv">hash-keys</span> <span class="nv">of</span> <span class="nv">users</span> <span class="nv">using</span> <span class="p">(</span><span class="nv">hash-value</span> <span class="nv">uid</span><span class="p">)</span>
              <span class="nb">when</span> <span class="p">(</span><span class="nb">&gt;</span> <span class="nv">uid</span> <span class="mf">1e7</span><span class="p">)</span>
              <span class="nv">collect</span> <span class="nv">user</span><span class="p">))</span>

<span class="c1">;;;-----------------------------</span>
<span class="o">#+</span><span class="nv">sbcl</span>
<span class="p">(</span><span class="nb">remove-if-not</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">line</span><span class="p">)</span>
                   <span class="p">(</span><span class="nv">scan</span> <span class="s">&quot;^gnat &quot;</span> <span class="nv">line</span><span class="p">))</span>
               <span class="p">(</span><span class="nv">split</span> <span class="sc">#\Newline</span>
                               <span class="p">(</span><span class="nb">with-output-to-string</span> <span class="p">(</span><span class="nv">output</span><span class="p">)</span>
                                 <span class="p">(</span><span class="nv">sb-ext:run-program</span> <span class="s">&quot;who&quot;</span> <span class="no">nil</span> <span class="ss">:search</span> <span class="no">t</span> <span class="ss">:output</span> <span class="nv">output</span><span class="p">)</span><span class="nv">q</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;;; Assumes DEFSTRUCT or DEFCLASS of EMPLOYEE with a POSITION slot.</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">engineers</span> <span class="p">(</span><span class="nb">remove</span> <span class="s">&quot;Engineer&quot;</span> <span class="nv">employees</span> <span class="ss">:key</span> <span class="nf">#&#39;</span><span class="nv">employee-position</span> <span class="ss">:test-not</span> <span class="ss">&#39;string=</span><span class="p">))</span>
<span class="c1">;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">secondary-assistance</span> <span class="p">(</span><span class="nb">remove-if-not</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">applicant</span><span class="p">)</span>
                                              <span class="p">(</span><span class="nb">and</span> <span class="p">(</span><span class="nb">&gt;=</span> <span class="p">(</span><span class="nv">applicant-income</span> <span class="nv">applicant</span><span class="p">)</span> <span class="mi">26000</span><span class="p">)</span>
                                                   <span class="p">(</span><span class="nb">&lt;</span>  <span class="p">(</span><span class="nv">applicant-income</span> <span class="nv">applicant</span><span class="p">)</span> <span class="mi">30000</span><span class="p">)))</span>
                                          <span class="nv">applicants</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN212"
>Sorting an Array Numerically</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">sorted</span> <span class="p">(</span><span class="nb">stable-sort</span> <span class="nv">unsorted</span> <span class="ss">&#39;&lt;</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; PIDS is an unsorted list of process IDs</span>
<span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">pid</span> <span class="p">(</span><span class="nb">stable-sort</span> <span class="nv">pids</span> <span class="ss">&#39;&lt;</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A~%&quot;</span> <span class="nv">pid</span><span class="p">))</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;Select a process ID to kill:~%&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">pid</span> <span class="p">(</span><span class="nb">read</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">etypecase</span> <span class="nv">pid</span>
    <span class="p">(</span><span class="nc">integer</span> <span class="p">(</span><span class="nv">sb-posix:kill</span> <span class="nv">pid</span> <span class="nv">sb-posix:sigterm</span><span class="p">)</span>
             <span class="p">(</span><span class="nb">sleep</span> <span class="mi">2</span><span class="p">)</span>
             <span class="p">(</span><span class="nb">ignore-errors</span>
               <span class="p">(</span><span class="nv">sb-posix:kill</span> <span class="nv">pid</span> <span class="nv">sb-posix:sigkill</span><span class="p">)))))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">descending</span> <span class="p">(</span><span class="nb">stable-sort</span> <span class="nv">unsorted</span> <span class="ss">&#39;&gt;</span><span class="p">))</span>
<span class="p">(</span><span class="nb">defpackage</span> <span class="ss">:sort-subs</span> <span class="p">(</span><span class="ss">:use</span> <span class="nv">cl</span><span class="p">))</span>
<span class="p">(</span><span class="nb">in-package</span> <span class="ss">:sort-subs</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">revnum</span> <span class="p">(</span><span class="nv">a</span> <span class="nv">b</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">&lt;</span> <span class="nv">b</span> <span class="nv">a</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defpackage</span> <span class="ss">:other-pack</span> <span class="p">(</span><span class="ss">:use</span> <span class="nv">cl</span><span class="p">))</span>
<span class="p">(</span><span class="nb">in-package</span> <span class="ss">:other-pack</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*all*</span> <span class="p">(</span><span class="nb">stable-sort</span> <span class="o">#(</span><span class="mi">4</span> <span class="mi">19</span> <span class="mi">8</span> <span class="mi">3</span><span class="p">)</span> <span class="ss">&#39;sort-subs::revnum</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="vg">*all*</span> <span class="p">(</span><span class="nb">stable-sort</span> <span class="o">#(</span><span class="mi">4</span> <span class="mi">19</span> <span class="mi">8</span> <span class="mi">3</span><span class="p">)</span> <span class="ss">&#39;&gt;</span><span class="p">))</span>
<span class="p">(</span><span class="nb">in-package</span> <span class="ss">:cl-user</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN215"
>Sorting a List by Computable Field</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">;;; There is nothing special about sorting  a list by computable field in Common</span>
<span class="c1">;;; Lisp. One just need to pass an appropriate `KEY&#39; function to `SORT&#39;.</span>

<span class="p">(</span><span class="nb">defvar</span> <span class="vg">*sample-list*</span>
  <span class="o">&#39;</span><span class="p">((</span><span class="mi">1</span> <span class="mi">-1</span> <span class="mf">0.1</span> <span class="s">&quot;one&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="mi">2</span> <span class="mi">-2</span> <span class="mf">0.2</span> <span class="s">&quot;two&quot;</span><span class="p">)</span>
    <span class="p">(</span><span class="mi">3</span> <span class="mi">-3</span> <span class="mf">0.3</span> <span class="s">&quot;three&quot;</span><span class="p">)))</span>

<span class="c1">;;; Just  keep in  mind that,  `SORT&#39; works  destructively. (That&#39;s  why  we use</span>
<span class="c1">;;; `COPY-LIST&#39; in the below expression.)</span>
<span class="p">(</span><span class="nb">sort</span> <span class="p">(</span><span class="nb">copy-list</span> <span class="vg">*sample-list*</span><span class="p">)</span> <span class="nf">#&#39;</span><span class="nb">&lt;</span> <span class="ss">:key</span> <span class="nf">#&#39;</span><span class="nb">first</span><span class="p">)</span>
<span class="c1">; =&gt; ((1 -1 0.1 &quot;one&quot;)</span>
<span class="c1">;     (2 -2 0.2 &quot;two&quot;)</span>
<span class="c1">;     (3 -3 0.3 &quot;three&quot;))</span>

<span class="p">(</span><span class="nb">sort</span> <span class="p">(</span><span class="nb">copy-list</span> <span class="vg">*sample-list*</span><span class="p">)</span> <span class="nf">#&#39;</span><span class="nb">string&lt;</span> <span class="ss">:key</span> <span class="nf">#&#39;</span><span class="nb">fourth</span><span class="p">)</span>
<span class="c1">; =&gt; ((1 -1 0.1 &quot;one&quot;)</span>
<span class="c1">;     (3 -3 0.3 &quot;three&quot;)</span>
<span class="c1">;     (2 -2 0.2 &quot;two&quot;))</span>

<span class="p">(</span><span class="nb">sort</span> <span class="p">(</span><span class="nb">copy-list</span> <span class="vg">*sample-list*</span><span class="p">)</span> <span class="nf">#&#39;</span><span class="nb">&lt;</span>
      <span class="ss">:key</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nb">list</span><span class="p">)</span> <span class="p">(</span><span class="nb">*</span> <span class="p">(</span><span class="nb">second</span> <span class="nb">list</span><span class="p">)</span> <span class="p">(</span><span class="nb">third</span> <span class="nb">list</span><span class="p">))))</span>
<span class="c1">; =&gt; ((3 -3 0.3 &quot;three&quot;)</span>
<span class="c1">;     (2 -2 0.2 &quot;two&quot;)</span>
<span class="c1">;     (1 -1 0.1 &quot;one&quot;))</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN218"
>Implementing a Circular List</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">;;;-----------------------------</span>
<span class="c1">;;; The following aren&#39;t efficient on long lists</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">circular</span> <span class="o">`</span><span class="p">(</span><span class="o">,@</span><span class="p">(</span><span class="nb">last</span> <span class="nv">circular</span><span class="p">)</span> <span class="o">,@</span><span class="p">(</span><span class="nb">nbutlast</span> <span class="nv">circular</span><span class="p">)))</span> <span class="c1">; the last shall be first</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">circular</span> <span class="o">`</span><span class="p">(</span><span class="o">,@</span><span class="p">(</span><span class="nb">cdr</span> <span class="nv">circular</span><span class="p">)</span> <span class="o">,</span><span class="p">(</span><span class="nb">car</span> <span class="nv">circular</span><span class="p">)))</span> <span class="c1">; and vice versa</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;;; There is probably a less ugly way to do this</span>
<span class="p">(</span><span class="nb">defmacro</span> <span class="nv">grab-and-rotate</span> <span class="p">(</span><span class="nb">list</span><span class="p">)</span>
  <span class="o">`</span><span class="p">(</span><span class="nb">prog1</span> <span class="p">(</span><span class="nb">car</span> <span class="o">,</span><span class="nb">list</span><span class="p">)</span>
     <span class="p">(</span><span class="nb">setf</span> <span class="o">,</span><span class="nb">list</span> <span class="o">`</span><span class="p">(</span><span class="o">,@</span><span class="p">(</span><span class="nb">cdr</span> <span class="o">,</span><span class="nb">list</span><span class="p">)</span> <span class="o">,</span><span class="p">(</span><span class="nb">car</span> <span class="o">,</span><span class="nb">list</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">processes</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">loop</span>
     <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">process</span> <span class="p">(</span><span class="nv">grab-and-rotate</span> <span class="nv">processes</span><span class="p">)))</span>
       <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;Handling process ~A~%&quot;</span> <span class="nv">process</span><span class="p">)</span>
       <span class="p">(</span><span class="nb">sleep</span> <span class="mi">1</span><span class="p">))))</span>
<span class="c1">;;;-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN221"
>Randomizing an Array</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">fisher-yates-shuffle</span> <span class="p">(</span><span class="nb">vector</span><span class="p">)</span>
  <span class="s">&quot;Randomly shuffle elements of VECTOR.&quot;</span>
  <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">i</span> <span class="nv">from</span> <span class="p">(</span><span class="nb">1-</span> <span class="p">(</span><span class="nb">length</span> <span class="nb">vector</span><span class="p">))</span> <span class="nv">downto</span> <span class="mi">1</span>
     <span class="nv">for</span> <span class="nv">j</span> <span class="nb">=</span> <span class="p">(</span><span class="nb">random</span> <span class="nv">i</span><span class="p">)</span>
     <span class="nb">unless</span> <span class="p">(</span><span class="nb">=</span> <span class="nv">i</span> <span class="nv">j</span><span class="p">)</span>
     <span class="nb">do</span> <span class="p">(</span><span class="nb">rotatef</span> <span class="p">(</span><span class="nb">aref</span> <span class="nb">vector</span> <span class="nv">i</span><span class="p">)</span> <span class="p">(</span><span class="nb">aref</span> <span class="nb">vector</span> <span class="nv">j</span><span class="p">)))</span>
  <span class="nb">vector</span><span class="p">)</span>

<span class="p">(</span><span class="nv">fisher-yates-shuffle</span> <span class="nb">vector</span><span class="p">)</span>           <span class="c1">; permutes VECTOR in place</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">shuffle</span> <span class="p">(</span><span class="nb">vector</span><span class="p">)</span>
  <span class="s">&quot;Return a fresh permuted copy of VECTOR.&quot;</span>
  <span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="nv">n-permutations</span> <span class="p">(</span><span class="nv">factorial</span> <span class="p">(</span><span class="nb">length</span> <span class="nb">vector</span><span class="p">)))</span>
         <span class="p">(</span><span class="nv">permutation</span> <span class="p">(</span><span class="nv">nth-permutation</span> <span class="p">(</span><span class="nb">random</span> <span class="nv">n-permutations</span><span class="p">)</span>
                                       <span class="p">(</span><span class="nb">length</span> <span class="nb">vector</span><span class="p">))))</span>
    <span class="p">(</span><span class="nb">map</span> <span class="ss">&#39;vector</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">i</span><span class="p">)</span> <span class="p">(</span><span class="nb">aref</span> <span class="nb">vector</span> <span class="nv">i</span><span class="p">))</span> <span class="nv">permutation</span><span class="p">)))</span>
<span class="c1">;;;</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">naive-shuffle</span> <span class="p">(</span><span class="nb">vector</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">loop</span> <span class="nv">with</span> <span class="nv">n</span> <span class="nb">=</span> <span class="p">(</span><span class="nb">length</span> <span class="nb">vector</span><span class="p">)</span>
        <span class="nv">for</span> <span class="nv">i</span> <span class="nv">from</span> <span class="mi">0</span> <span class="nv">below</span> <span class="nv">n</span>
        <span class="nv">for</span> <span class="nv">j</span> <span class="nb">=</span> <span class="p">(</span><span class="nb">random</span> <span class="nv">n</span><span class="p">)</span>
        <span class="nb">do</span> <span class="p">(</span><span class="nb">rotatef</span> <span class="p">(</span><span class="nb">aref</span> <span class="nb">vector</span> <span class="nv">i</span><span class="p">)</span> <span class="p">(</span><span class="nb">aref</span> <span class="nb">vector</span> <span class="nv">j</span><span class="p">)))</span>
  <span class="nb">vector</span><span class="p">)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN224"
>Program: words</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="p">(</span><span class="nb">defun</span> <span class="nv">print-matrix</span> <span class="p">(</span><span class="nv">matrix</span> <span class="nv">column-len</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;~~{~~{~~@[~~~DA~~^ ~~]~~}~~%~~}&quot;</span> <span class="nv">column-len</span><span class="p">)</span> <span class="nv">matrix</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">pop-matrix-column</span> <span class="p">(</span><span class="nv">matrix</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">when</span> <span class="nv">matrix</span>
    <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nb">elt</span> <span class="p">(</span><span class="nb">caar</span> <span class="nv">matrix</span><span class="p">)))</span>
      <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">matrix</span><span class="p">)</span> <span class="p">(</span><span class="nb">cdar</span> <span class="nv">matrix</span><span class="p">))</span>
      <span class="p">(</span><span class="nb">cons</span> <span class="nb">elt</span> <span class="p">(</span><span class="nv">pop-matrix-column</span> <span class="p">(</span><span class="nb">cdr</span> <span class="nv">matrix</span><span class="p">))))))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">transpose-matrix</span> <span class="p">(</span><span class="nv">matrix</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">matrix</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">cons</span> <span class="p">(</span><span class="nv">pop-matrix-column</span> <span class="nv">matrix</span><span class="p">)</span>
          <span class="p">(</span><span class="nv">transpose-matrix</span> <span class="nv">matrix</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">parse-matrix-row</span> <span class="p">(</span><span class="nb">string</span> <span class="k">&amp;key</span> <span class="nb">count</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">when</span> <span class="nb">string</span> <span class="p">(</span><span class="nv">ppcre:split</span> <span class="s">&quot;\\s+&quot;</span> <span class="nb">string</span> <span class="ss">:limit</span> <span class="nb">count</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">parse-matrix</span> <span class="p">(</span><span class="nc">stream</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">first-row</span> <span class="p">(</span><span class="nv">parse-matrix-row</span> <span class="p">(</span><span class="nb">read-line</span> <span class="nc">stream</span> <span class="no">nil</span> <span class="no">nil</span><span class="p">))))</span>
    <span class="p">(</span><span class="nb">when</span> <span class="nv">first-row</span>
      <span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="nv">n-columns</span> <span class="p">(</span><span class="nb">length</span> <span class="nv">first-row</span><span class="p">))</span>
             <span class="p">(</span><span class="nv">matrix</span>
              <span class="p">(</span><span class="nb">cons</span> <span class="nv">first-row</span>
                    <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">row</span> <span class="nb">=</span> <span class="p">(</span><span class="nv">parse-matrix-row</span>
                                     <span class="p">(</span><span class="nb">read-line</span> <span class="nc">stream</span> <span class="no">nil</span> <span class="no">nil</span><span class="p">)</span>
                                     <span class="ss">:count</span> <span class="nv">n-columns</span><span class="p">)</span>
                          <span class="nv">while</span> <span class="nv">row</span> <span class="nv">collect</span> <span class="nv">row</span><span class="p">)))</span>
             <span class="p">(</span><span class="nv">column-len</span>
              <span class="p">(</span><span class="nb">reduce</span> <span class="nf">#&#39;</span><span class="nb">max</span> <span class="nv">matrix</span>
                      <span class="ss">:key</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">vals</span><span class="p">)</span>
                             <span class="p">(</span><span class="nb">reduce</span> <span class="nf">#&#39;</span><span class="nb">max</span> <span class="nv">vals</span> <span class="ss">:key</span> <span class="nf">#&#39;</span><span class="nb">length</span><span class="p">)))))</span>
        <span class="p">(</span><span class="nv">print-matrix</span> <span class="p">(</span><span class="nv">transpose-matrix</span> <span class="nv">matrix</span><span class="p">)</span> <span class="nv">column-len</span><span class="p">)))))</span>

<span class="p">(</span><span class="nb">with-input-from-string</span>
    <span class="p">(</span><span class="nv">in</span> <span class="s">&quot;awk      cp       ed       login    mount    rmdir    sum</span>
<span class="s">basename csh      egrep    ls       mt       sed      sync</span>
<span class="s">cat      date     fgrep    mail     mv       sh       tar</span>
<span class="s">chgrp    dd       grep     mkdir    ps       sort     touch</span>
<span class="s">chmod    df       kill     mknod    pwd      stty     vi</span>
<span class="s">chown    echo     ln       more     rm       su&quot;</span><span class="p">)</span>
  <span class="p">(</span><span class="nv">parse-matrix</span> <span class="nv">in</span><span class="p">))</span>
<span class="c1">; =&gt; awk      basename cat      chgrp    chmod    chown</span>
<span class="c1">;    cp       csh      date     dd       df       echo</span>
<span class="c1">;    ed       egrep    fgrep    grep     kill     ln</span>
<span class="c1">;    login    ls       mail     mkdir    mknod    more</span>
<span class="c1">;    mount    mt       mv       ps       pwd      rm</span>
<span class="c1">;    rmdir    sed      sh       sort     stty     su</span>
<span class="c1">;    sum      sync     tar      touch    vi</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN227"
>Program: permute</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">;;; A naive `FACTORIAL&#39; implementation.</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">factorial</span> <span class="p">(</span><span class="nv">n</span><span class="p">)</span>
  <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">&lt;</span> <span class="nv">n</span> <span class="mi">2</span><span class="p">)</span> <span class="mi">1</span> <span class="p">(</span><span class="nb">*</span> <span class="nv">n</span> <span class="p">(</span><span class="nv">factorial</span> <span class="p">(</span><span class="nb">1-</span> <span class="nv">n</span><span class="p">)))))</span>

<span class="c1">;;; A tail-recursive derivative of the above `FACTORIAL&#39; implementation.</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">tco-factorial</span> <span class="p">(</span><span class="nv">n</span><span class="p">)</span>
  <span class="p">(</span><span class="k">labels</span> <span class="p">((</span><span class="nv">iter</span> <span class="p">(</span><span class="nv">m</span> <span class="nv">acc</span><span class="p">)</span>
             <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">&lt;</span> <span class="nv">n</span> <span class="nv">m</span><span class="p">)</span> <span class="nv">acc</span> <span class="p">(</span><span class="nv">iter</span> <span class="p">(</span><span class="nb">1+</span> <span class="nv">m</span><span class="p">)</span> <span class="p">(</span><span class="nb">*</span> <span class="nv">m</span> <span class="nv">acc</span><span class="p">)))))</span>
    <span class="p">(</span><span class="nv">iter</span> <span class="mi">1</span> <span class="mi">1</span><span class="p">)))</span>

<span class="p">(</span><span class="nv">tco-factorial</span> <span class="p">(</span><span class="nb">expt</span> <span class="mi">2</span> <span class="mi">8</span><span class="p">))</span>
<span class="c1">; =&gt; 857817775342842654119082271681232625157781520279485619859655650377269452553</span>
<span class="c1">;    147589377440291360451408450375885342336584306157196834693696475322289288497</span>
<span class="c1">;    426025679637332563368786442675207626794560187968867971521143307702077526646</span>
<span class="c1">;    451464709187326100832876325702818980773671781454170250523018608495319068138</span>
<span class="c1">;    257481070252817559459476987034665712738139286205234756808218860701203611083</span>
<span class="c1">;    152093501947437109101726968262861606263662435022840944191408424615936000000</span>
<span class="c1">;    000000000000000000000000000000000000000000000000000000000</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">permutations</span> <span class="p">(</span><span class="nv">items</span> <span class="k">&amp;key</span> <span class="nv">test</span> <span class="k">&amp;aux</span> <span class="p">(</span><span class="nv">test</span> <span class="p">(</span><span class="nb">or</span> <span class="nv">test</span> <span class="nf">#&#39;</span><span class="nb">eql</span><span class="p">)))</span>
  <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">null</span> <span class="nv">items</span><span class="p">)</span> <span class="o">&#39;</span><span class="p">(())</span>
      <span class="p">(</span><span class="nb">mapcan</span>
       <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">item</span><span class="p">)</span>
         <span class="p">(</span><span class="nb">mapcar</span> <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">permutation</span><span class="p">)</span> <span class="p">(</span><span class="nb">cons</span> <span class="nv">item</span> <span class="nv">permutation</span><span class="p">))</span>
                 <span class="p">(</span><span class="nv">permutations</span> <span class="p">(</span><span class="nb">remove</span> <span class="nv">item</span> <span class="nv">items</span> <span class="ss">:test</span> <span class="nv">test</span><span class="p">)</span> <span class="ss">:test</span> <span class="nv">test</span><span class="p">)))</span>
       <span class="nv">items</span><span class="p">)))</span>

<span class="p">(</span><span class="nv">permutations</span> <span class="o">&#39;</span><span class="p">(</span><span class="s">&quot;man&quot;</span> <span class="s">&quot;bites&quot;</span> <span class="s">&quot;dog&quot;</span><span class="p">)</span> <span class="ss">:test</span> <span class="nf">#&#39;</span><span class="nb">string-equal</span><span class="p">)</span>
<span class="c1">; =&gt; ((&quot;man&quot; &quot;bites&quot; &quot;dog&quot;)</span>
<span class="c1">;     (&quot;man&quot; &quot;dog&quot; &quot;bites&quot;)</span>
<span class="c1">;     (&quot;bites&quot; &quot;man&quot; &quot;dog&quot;)</span>
<span class="c1">;     (&quot;bites&quot; &quot;dog&quot; &quot;man&quot;)</span>
<span class="c1">;     (&quot;dog&quot; &quot;man&quot; &quot;bites&quot;)</span>
<span class="c1">;     (&quot;dog&quot; &quot;bites&quot; &quot;man&quot;))</span></PRE
></TD
></TR
></TABLE
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="datesandtimes.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="hashes.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Dates and Times</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
>&nbsp;</TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Hashes</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>
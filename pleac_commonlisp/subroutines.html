<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN""http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>Subroutines</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="PLEAC-Common Lisp"
HREF="index.html"><LINK
REL="PREVIOUS"
TITLE="Directories"
HREF="directories.html"><LINK
REL="NEXT"
TITLE="References and Records"
HREF="referencesandrecords.html"><style type="text/css">td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
pre { line-height: 125%; }

  </style></head
><BODY TEXT="#cecece" BGCOLOR="#4f6f6f" LINK="#f5deb3" VLINK="#d5ae83"
CLASS="SECT1"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>PLEAC-Common Lisp</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="directories.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
></TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="referencesandrecords.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="SUBROUTINES"
>10. Subroutines</A
></H1
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN536"
>Introduction</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*greeted*</span> <span class="mi">0</span><span class="p">)</span>              <span class="c1">; global variable</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">hello</span> <span class="p">()</span>
  <span class="p">(</span><span class="nb">incf</span> <span class="vg">*greeted*</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;hi there!~%&quot;</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nv">hello</span><span class="p">)</span>           <span class="c1">; call subroutine hello with no arguments/parameters</span>
<span class="c1">;;;-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN539"
>Accessing Subroutine Arguments</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">;;;-----------------------------</span>
<span class="c1">;; It would be strange to declare arguments using &amp;rest when you know</span>
<span class="c1">;; there are exactly two, in CL, but you could, if you wanted to</span>
<span class="c1">;; emulate what the Perl example does.</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">hypotenuse</span> <span class="p">(</span><span class="k">&amp;rest</span> <span class="nv">args</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">sqrt</span> <span class="p">(</span><span class="nb">+</span> <span class="p">(</span><span class="nb">expt</span> <span class="p">(</span><span class="nb">elt</span> <span class="nv">args</span> <span class="mi">0</span><span class="p">)</span> <span class="mi">2</span><span class="p">)</span>
           <span class="p">(</span><span class="nb">expt</span> <span class="p">(</span><span class="nb">elt</span> <span class="nv">args</span> <span class="mi">1</span><span class="p">)</span> <span class="mi">2</span><span class="p">))))</span>

<span class="p">(</span><span class="nb">setf</span> <span class="nv">diag</span> <span class="p">(</span><span class="nv">hypotenuse</span> <span class="mi">3</span> <span class="mi">4</span><span class="p">))</span>            <span class="c1">; DIAG is 5.0</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">hypotenuse</span> <span class="p">(</span><span class="nv">side1</span> <span class="nv">side2</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">sqrt</span> <span class="p">(</span><span class="nb">+</span> <span class="p">(</span><span class="nb">expt</span> <span class="nv">side1</span> <span class="mi">2</span><span class="p">)</span>
           <span class="p">(</span><span class="nb">expt</span> <span class="nv">side2</span> <span class="mi">2</span><span class="p">))))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~D~%&quot;</span> <span class="p">(</span><span class="nb">truncate</span> <span class="p">(</span><span class="nv">hypotenuse</span> <span class="mi">3</span> <span class="mi">4</span><span class="p">)))</span> <span class="c1">; prints 5</span>

<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">a</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">3</span> <span class="mi">4</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~D~%&quot;</span> <span class="p">(</span><span class="nb">truncate</span> <span class="p">(</span><span class="nb">apply</span> <span class="ss">&#39;hypotenuse</span> <span class="nv">a</span><span class="p">))))</span> <span class="c1">; prints 5</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">both</span> <span class="p">(</span><span class="nb">append</span> <span class="nv">men</span> <span class="nv">women</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">both</span> <span class="o">`</span><span class="p">(</span><span class="o">,@</span><span class="nv">men</span> <span class="o">,@</span><span class="nv">women</span><span class="p">))</span> <span class="c1">; alternative way of doing the same thing</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">nums</span> <span class="o">&#39;</span><span class="p">(</span><span class="mf">1.4</span> <span class="mf">3.5</span> <span class="mf">6.7</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">ints</span> <span class="p">(</span><span class="nb">apply</span> <span class="ss">&#39;int-all</span> <span class="nv">nums</span><span class="p">))</span>       <span class="c1">; NUMS unchanged</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">int-all</span> <span class="p">(</span><span class="k">&amp;rest</span> <span class="nv">retlist</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">n</span> <span class="nv">in</span> <span class="nv">retlist</span> <span class="nv">collect</span> <span class="p">(</span><span class="nb">truncate</span> <span class="nv">n</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">nums</span> <span class="o">&#39;</span><span class="p">(</span><span class="mf">1.4</span> <span class="mf">3.5</span> <span class="mf">6.7</span><span class="p">))</span>
<span class="p">(</span><span class="nv">trunc-em</span> <span class="nv">nums</span><span class="p">)</span>                         <span class="c1">; NUMS now (1 3 6)</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">trunc-em</span> <span class="p">(</span><span class="nv">reals</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">map-into</span> <span class="nv">reals</span> <span class="ss">&#39;truncate</span> <span class="nv">reals</span><span class="p">))</span>     <span class="c1">; truncate each element of arg list</span>
<span class="c1">;;;-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN542"
>Making Variables Private to a Function</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">somefunc</span> <span class="p">()</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">(</span><span class="nv">variable</span>              <span class="c1">; VARIABLE is invisible outside SOMEFUNC</span>
        <span class="nv">another</span> <span class="nv">an-array</span> <span class="nv">a-hash</span><span class="p">)</span>    <span class="c1">; declaring many variables at once</span>
    <span class="c1">;; ...</span>
    <span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">destructuring-bind</span> <span class="p">(</span><span class="nv">name</span> <span class="nv">age</span><span class="p">)</span> <span class="vg">*posix-argv*</span>
  <span class="c1">;; Use NAME, AGE here</span>
  <span class="p">)</span>

<span class="p">(</span><span class="nb">setf</span> <span class="nv">start</span> <span class="p">(</span><span class="nv">fetch-time</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">destructuring-bind</span> <span class="p">(</span><span class="nv">a</span> <span class="nv">b</span><span class="p">)</span> <span class="nv">pair</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">c</span> <span class="p">(</span><span class="nv">fetch-time</span><span class="p">)))</span>
    <span class="c1">;; ...</span>
    <span class="p">))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">check-x</span> <span class="p">(</span><span class="nv">x</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">y</span> <span class="s">&quot;whatever&quot;</span><span class="p">))</span>
    <span class="p">(</span><span class="nv">run-check</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">when</span> <span class="kt">condition</span>
      <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;got ~A~%&quot;</span> <span class="nv">x</span><span class="p">))))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">save-array</span> <span class="p">(</span><span class="k">&amp;rest</span> <span class="nv">arguments</span><span class="p">)</span>
  <span class="c1">;; There&#39;s probably a better way to do this.</span>
  <span class="p">(</span><span class="nb">setf</span> <span class="vg">*global-array*</span> <span class="p">(</span><span class="nb">append</span> <span class="vg">*global-array*</span> <span class="p">(</span><span class="nb">copy-seq</span> <span class="nv">arguments</span><span class="p">))))</span>
<span class="c1">;;;-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN545"
>Creating Persistent Private Variables</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">let</span> <span class="p">(</span><span class="nv">variable</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">defun</span> <span class="nv">mysub</span> <span class="p">()</span>
    <span class="c1">;; ... accessing VARIABLE</span>
    <span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">variable</span> <span class="mi">1</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">defun</span> <span class="nv">othersub</span> <span class="p">()</span>
    <span class="c1">;; ... accessing VARIABLE</span>
    <span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">counter</span> <span class="mi">0</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">defun</span> <span class="nv">next-counter</span> <span class="p">()</span>
    <span class="p">(</span><span class="nb">incf</span> <span class="nv">counter</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">counter</span> <span class="mi">42</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">defun</span> <span class="nv">next-counter</span> <span class="p">()</span>
    <span class="p">(</span><span class="nb">incf</span> <span class="nv">counter</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">defun</span> <span class="nv">prev-counter</span> <span class="p">()</span>
    <span class="p">(</span><span class="nb">decf</span> <span class="nv">counter</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN548"
>Determining Current Function Name</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">;;;-----------------------------</span>
<span class="c1">;; There is no standard equivalent of Perl&#39;s caller(), in CL.</span>
<span class="c1">;; Functions can get inlined (among other things), so it&#39;s not even</span>
<span class="c1">;; clear what something like caller() should actually return, anyway.</span>
<span class="c1">;;;-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN551"
>Passing Arrays and Hashes by Reference</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nv">array-diff</span> <span class="nv">array1</span> <span class="nv">array2</span><span class="p">)</span>              <span class="c1">; params are already references</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">a</span> <span class="o">#(</span><span class="mi">1</span> <span class="mi">2</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">b</span> <span class="o">#(</span><span class="mi">5</span> <span class="mi">8</span><span class="p">))</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">c</span> <span class="p">(</span><span class="nv">add-vecpair</span> <span class="nv">a</span> <span class="nv">b</span><span class="p">))</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~{~A~^ ~}~%&quot;</span> <span class="p">(</span><span class="nb">map</span> <span class="ss">&#39;list</span> <span class="ss">&#39;identity</span> <span class="nv">c</span><span class="p">))</span>
<span class="c1">;; 6 10</span>

<span class="c1">;; This function would be simpler with lists instead of arrays, or the</span>
<span class="c1">;; use of the SERIES package.  We&#39;re using arrays because the Perl</span>
<span class="c1">;; does.</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">add-vecpair</span> <span class="p">(</span><span class="nv">x</span> <span class="nv">y</span><span class="p">)</span>        <span class="c1">; assumes both vectors the same length</span>
  <span class="p">(</span><span class="nb">map-into</span> <span class="p">(</span><span class="nb">make-array</span> <span class="p">(</span><span class="nb">length</span> <span class="nv">x</span><span class="p">))</span>
            <span class="ss">&#39;+</span> <span class="nv">x</span> <span class="nv">y</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Normally one would use CHECK-TYPE or ASSERT here, but this example</span>
<span class="c1">;; is trying to match the Perl.</span>
<span class="p">(</span><span class="nb">unless</span> <span class="p">(</span><span class="nb">and</span> <span class="p">(</span><span class="nb">typep</span> <span class="nv">x</span> <span class="ss">&#39;vector</span><span class="p">)</span>
             <span class="p">(</span><span class="nb">typep</span> <span class="nv">y</span> <span class="ss">&#39;vector</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">error</span> <span class="s">&quot;usage: add_vecpair VECTOR1 VECTOR2&quot;</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN554"
>Detecting Return Context</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">;;;-----------------------------</span>
<span class="c1">;; There is no equivalent to Perl&#39;s wantarray() in CL.  The most</span>
<span class="c1">;; similar language feature is CL&#39;s ability to return multiple values,</span>
<span class="c1">;; which the caller may choose to ignore.</span>
<span class="c1">;;;-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN557"
>Passing by Named Parameter</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nv">thefunc</span> <span class="ss">:increment</span> <span class="s">&quot;20s&quot;</span> <span class="ss">:start</span> <span class="s">&quot;+5m&quot;</span> <span class="ss">:finish</span> <span class="s">&quot;+30m&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nv">thefunc</span> <span class="ss">:start</span> <span class="s">&quot;+5m&quot;</span> <span class="ss">:finish</span> <span class="s">&quot;+30m&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nv">thefunc</span> <span class="ss">:finish</span> <span class="s">&quot;+30m&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nv">thefunc</span> <span class="ss">:start</span> <span class="s">&quot;+5m&quot;</span> <span class="ss">:increment</span> <span class="s">&quot;15s&quot;</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; &amp;allow-other-keys is used to emulate the Perl example&#39;s use of @_</span>
<span class="c1">;; in the %args hash.</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">thefunc</span> <span class="p">(</span><span class="k">&amp;key</span> <span class="p">(</span><span class="nv">increment</span> <span class="s">&quot;10s&quot;</span><span class="p">)</span> <span class="nv">finish</span> <span class="nv">start</span> <span class="k">&amp;allow-other-keys</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nv">scan</span> <span class="s">&quot;m$&quot;</span> <span class="nv">increment</span><span class="p">)</span>
    <span class="c1">;; ...</span>
    <span class="p">))</span>
<span class="c1">;;;-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN560"
>Skipping Selected Return Values</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">;;;-----------------------------</span>
<span class="c1">;; Use of gensym here is unusual, just trying to mimic the Perl (there</span>
<span class="c1">;; is probably a better way to do that, too).  Also, normally you&#39;d do</span>
<span class="c1">;; MULTIPLE-VALUE-BIND.</span>
<span class="p">(</span><span class="nb">multiple-value-setq</span> <span class="p">(</span><span class="nv">a</span> <span class="o">#.</span><span class="p">(</span><span class="nb">gensym</span><span class="p">)</span> <span class="nv">c</span><span class="p">)</span> <span class="p">(</span><span class="nv">func</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; I don&#39;t know of a quicker built-in way to do exactly what the Perl</span>
<span class="c1">;; is doing here.  There is NTH-VALUE but it only returns one value.</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">results</span> <span class="p">(</span><span class="nb">multiple-value-list</span> <span class="p">(</span><span class="nv">func</span><span class="p">))))</span>
  <span class="p">(</span><span class="nb">setf</span> <span class="nv">a</span> <span class="p">(</span><span class="nb">elt</span> <span class="nv">results</span> <span class="mi">0</span><span class="p">)</span>
        <span class="nv">c</span> <span class="p">(</span><span class="nb">elt</span> <span class="nv">results</span> <span class="mi">2</span><span class="p">)))</span>

<span class="c1">;; However you can easily define a macro that does roughly the same</span>
<span class="c1">;; thing.</span>
<span class="p">(</span><span class="nb">defmacro</span> <span class="nv">nth-values</span> <span class="p">((</span><span class="k">&amp;rest</span> <span class="nv">positions</span><span class="p">)</span> <span class="k">&amp;body</span> <span class="nv">body</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">results</span> <span class="p">(</span><span class="nb">gensym</span> <span class="s">&quot;results-&quot;</span><span class="p">)))</span>
    <span class="o">`</span><span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="o">,</span><span class="nv">results</span> <span class="p">(</span><span class="nb">multiple-value-list</span> <span class="o">,@</span><span class="nv">body</span><span class="p">)))</span>
       <span class="p">(</span><span class="nb">values</span>
        <span class="o">,@</span><span class="p">(</span><span class="nb">mapcar</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">pos</span><span class="p">)</span> <span class="o">`</span><span class="p">(</span><span class="nb">elt</span> <span class="o">,</span><span class="nv">results</span> <span class="o">,</span><span class="nv">pos</span><span class="p">))</span> <span class="nv">positions</span><span class="p">)))))</span>

<span class="p">(</span><span class="nb">multiple-value-setq</span> <span class="p">(</span><span class="nv">a</span> <span class="nv">c</span><span class="p">)</span> <span class="p">(</span><span class="nv">nth-values</span> <span class="p">(</span><span class="mi">0</span> <span class="mi">2</span><span class="p">)</span> <span class="p">(</span><span class="nv">func</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="o">#+</span><span class="nv">sbcl</span>
<span class="p">(</span><span class="nb">multiple-value-setq</span> <span class="p">(</span><span class="nv">dev</span> <span class="nv">ino</span> <span class="nv">dummy</span> <span class="nv">dummy</span> <span class="nv">uid</span><span class="p">)</span>  <span class="p">(</span><span class="nv">sb-unix:unix-stat</span> <span class="nv">filename</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="o">#+</span><span class="nv">sbcl</span>
<span class="p">(</span><span class="nb">multiple-value-setq</span> <span class="p">(</span><span class="nv">dev</span> <span class="nv">ino</span> <span class="o">#.</span><span class="p">(</span><span class="nb">gensym</span><span class="p">)</span> <span class="o">#.</span><span class="p">(</span><span class="nb">gensym</span><span class="p">)</span> <span class="nv">uid</span><span class="p">)</span>  <span class="p">(</span><span class="nv">sb-unix:unix-stat</span> <span class="nv">filename</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Using the non-standard NTH-VALUES macro defined above.</span>
<span class="o">#+</span><span class="nv">sbcl</span>
<span class="p">(</span><span class="nb">multiple-value-setq</span> <span class="p">(</span><span class="nv">dev</span> <span class="nv">ino</span> <span class="nv">uid</span> <span class="nv">gid</span><span class="p">)</span> <span class="p">(</span><span class="nv">nth-values</span> <span class="p">(</span><span class="mi">0</span> <span class="mi">1</span> <span class="mi">4</span> <span class="mi">5</span><span class="p">)</span> <span class="p">(</span><span class="nv">sb-unix:unix-stat</span> <span class="nv">filename</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN563"
>Returning More Than One Array or Hash</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">multiple-value-setq</span> <span class="p">(</span><span class="nc">array</span> <span class="nv">hash</span><span class="p">)</span> <span class="p">(</span><span class="nv">somefunc</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">somefunc</span> <span class="p">()</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nc">array</span> <span class="p">(</span><span class="nb">make-array</span> <span class="o">...</span><span class="p">))</span>
        <span class="p">(</span><span class="nv">hash</span> <span class="p">(</span><span class="nb">make-hash-table</span> <span class="o">...</span><span class="p">)))</span>
    <span class="c1">;; ...</span>
    <span class="p">(</span><span class="nb">values</span> <span class="nc">array</span> <span class="nv">hash</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">fn</span> <span class="p">()</span>
  <span class="c1">;; ...</span>
  <span class="p">(</span><span class="nb">values</span> <span class="nv">a</span> <span class="nv">b</span> <span class="nv">c</span><span class="p">))</span>                 <span class="c1">; assuming a, b and c are all hashes</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">multiple-value-setq</span> <span class="p">(</span><span class="nv">h0</span> <span class="nv">h1</span> <span class="nv">h2</span><span class="p">)</span> <span class="p">(</span><span class="nv">fn</span><span class="p">))</span>   <span class="c1">; unlike Perl example, not &quot;wrong&quot;</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">list-of-hashes</span> <span class="p">(</span><span class="nb">multiple-value-list</span> <span class="p">(</span><span class="nv">fn</span><span class="p">)))</span> <span class="c1">; eg: (gethash &quot;keystring&quot; (elt list-of-hashes 2))</span>
<span class="p">(</span><span class="nb">multiple-value-setq</span> <span class="p">(</span><span class="nv">r0</span> <span class="nv">r1</span> <span class="nv">r2</span><span class="p">)</span> <span class="p">(</span><span class="nv">fn</span><span class="p">))</span> <span class="c1">; everything&#39;s a reference, no difference from previous</span>
<span class="c1">;;;-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN566"
>Returning Failure</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">;;;-----------------------------</span>
<span class="c1">;; In CL everything returns a value.</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">empty-retval</span> <span class="p">())</span>                 <span class="c1">; returns nil</span>
<span class="c1">;; If you want to distinguish between returning &quot;empty&quot; vs &quot;undefined&quot;</span>
<span class="c1">;; then you can return return a second value indicating which.</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">empty-retval</span> <span class="p">()</span>
  <span class="p">(</span><span class="nb">values</span> <span class="no">nil</span> <span class="no">nil</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">a</span> <span class="p">(</span><span class="nv">yourfunc</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">when</span> <span class="nv">a</span>
    <span class="c1">;; ...</span>
    <span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; The following are all the same, just mirroring the Perl here.</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">a</span> <span class="p">(</span><span class="nv">sfunc</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">unless</span> <span class="nv">a</span>
    <span class="p">(</span><span class="nb">error</span> <span class="s">&quot;sfunc failed&quot;</span><span class="p">)))</span>

<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">a</span> <span class="p">(</span><span class="nv">afunc</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">unless</span> <span class="nv">a</span>
    <span class="p">(</span><span class="nb">error</span> <span class="s">&quot;afunc failed&quot;</span><span class="p">)))</span>

<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">a</span> <span class="p">(</span><span class="nv">hfunc</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">unless</span> <span class="nv">a</span>
    <span class="p">(</span><span class="nb">error</span> <span class="s">&quot;hfunc failed&quot;</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Note: this is for illustrating the use of OR and ERROR, there is no</span>
<span class="c1">;; built-in ioctl or strerror in CL.</span>
<span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nv">ioctl</span> <span class="o">...</span><span class="p">)</span> <span class="p">(</span><span class="nb">error</span> <span class="s">&quot;can&#39;t ioctl: ~A&quot;</span> <span class="nv">strerror</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN569"
>Prototyping Functions</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">results</span> <span class="p">(</span><span class="nv">myfunc</span> <span class="mi">3</span> <span class="mi">5</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Unlike Perl, you can&#39;t call functions without using outer parens</span>
<span class="c1">;; (unless you develop macros to let you do so in specific</span>
<span class="c1">;; circumstances)</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">results</span> <span class="p">(</span><span class="nv">myfunc</span> <span class="mi">3</span> <span class="mi">5</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">results</span> <span class="o">`</span><span class="p">(</span><span class="o">,@</span><span class="p">(</span><span class="nv">myfunc</span> <span class="mi">3</span><span class="p">)</span> <span class="mi">5</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">lock-sh</span> <span class="p">()</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">lock-ex</span> <span class="p">()</span> <span class="mi">2</span><span class="p">)</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">lock-un</span> <span class="p">()</span> <span class="mi">4</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">mypush</span> <span class="p">(</span><span class="nb">list</span> <span class="k">&amp;rest</span> <span class="nv">remainder</span><span class="p">)</span>
  <span class="c1">;; ...</span>
  <span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nv">mypush</span> <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">&gt;</span> <span class="nv">x</span> <span class="mi">10</span><span class="p">)</span> <span class="nv">a</span> <span class="nv">b</span><span class="p">)</span> <span class="mi">3</span> <span class="mi">5</span><span class="p">)</span>          <span class="c1">; unlike Perl, not wrong</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Params are already passed as references in CL</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">hpush</span> <span class="p">(</span><span class="nv">href</span> <span class="k">&amp;rest</span> <span class="nv">keys-and-values</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">loop</span>
     <span class="nv">for</span> <span class="nv">k</span> <span class="nv">in</span> <span class="nv">keys-and-values</span> <span class="nv">by</span> <span class="nf">#&#39;</span><span class="nb">cddr</span>
     <span class="nv">for</span> <span class="nv">v</span> <span class="nv">in</span> <span class="p">(</span><span class="nb">cdr</span> <span class="nv">keys-and-values</span><span class="p">)</span> <span class="nv">by</span> <span class="nf">#&#39;</span><span class="nb">cddr</span>
     <span class="nb">do</span> <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="nv">k</span> <span class="nv">href</span><span class="p">)</span> <span class="nv">v</span><span class="p">))</span>
  <span class="nv">href</span><span class="p">)</span>                                 <span class="c1">; return this for caller&#39;s convenience</span>

<span class="p">(</span><span class="nv">hpush</span> <span class="nv">pieces</span> <span class="s">&quot;queen&quot;</span> <span class="mi">9</span> <span class="s">&quot;rook&quot;</span> <span class="mi">5</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN572"
>Handling Exceptions</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">error</span> <span class="s">&quot;some message&quot;</span><span class="p">)</span>                  <span class="c1">; raise exception</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">multiple-value-bind</span> <span class="p">(</span><span class="nv">result</span> <span class="kt">condition</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">ignore-errors</span> <span class="p">(</span><span class="nb">eval</span> <span class="p">(</span><span class="nv">func</span><span class="p">)))</span>
  <span class="p">(</span><span class="nb">when</span> <span class="kt">condition</span> <span class="p">(</span><span class="nb">warn</span> <span class="s">&quot;func raised an exception: ~A&quot;</span> <span class="kt">condition</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">multiple-value-bind</span> <span class="p">(</span><span class="nv">result</span> <span class="kt">condition</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">ignore-errors</span> <span class="p">(</span><span class="nb">eval</span> <span class="p">(</span><span class="nb">setf</span> <span class="nv">val</span> <span class="p">(</span><span class="nv">func</span><span class="p">))))</span>
  <span class="p">(</span><span class="nb">when</span> <span class="kt">condition</span> <span class="p">(</span><span class="nb">warn</span> <span class="s">&quot;func blew up: ~A&quot;</span> <span class="kt">condition</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">multiple-value-bind</span> <span class="p">(</span><span class="nv">result</span> <span class="kt">condition</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">ignore-errors</span> <span class="p">(</span><span class="nb">eval</span> <span class="p">(</span><span class="nb">setf</span> <span class="nv">val</span> <span class="p">(</span><span class="nv">func</span><span class="p">))))</span>
  <span class="p">(</span><span class="nb">when</span> <span class="kt">condition</span> <span class="p">(</span><span class="nb">warn</span> <span class="s">&quot;func blew up: ~A&quot;</span> <span class="kt">condition</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">multiple-value-bind</span> <span class="p">(</span><span class="nv">result</span> <span class="kt">condition</span><span class="p">)</span>
    <span class="p">(</span><span class="nb">ignore-errors</span> <span class="p">(</span><span class="nb">eval</span> <span class="p">(</span><span class="nb">setf</span> <span class="nv">val</span> <span class="p">(</span><span class="nv">func</span><span class="p">))))</span>
  <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nb">and</span> <span class="kt">condition</span>
             <span class="p">(</span><span class="nb">not</span> <span class="p">(</span><span class="nv">scan</span> <span class="s">&quot;Full moon&quot;</span>
                                 <span class="c1">;; There&#39;s probably a better way to</span>
                                 <span class="c1">;; do this.</span>
                                 <span class="p">(</span><span class="nb">format</span> <span class="no">nil</span> <span class="s">&quot;~A&quot;</span> <span class="kt">condition</span><span class="p">))))</span>
    <span class="p">(</span><span class="nb">warn</span> <span class="s">&quot;func blew up: ~A&quot;</span> <span class="kt">condition</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; No equivalent to wantarray().</span>
<span class="c1">;;;-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN575"
>Saving Global Values</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*age*</span> <span class="mi">18</span><span class="p">)</span>                 <span class="c1">; global variable</span>
<span class="p">(</span><span class="nb">when</span> <span class="nv">CONDITION</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="vg">*age*</span> <span class="mi">23</span><span class="p">))</span>
    <span class="p">(</span><span class="nv">func</span><span class="p">)</span>                              <span class="c1">; sees temporary value of 23</span>
    <span class="p">))</span> <span class="c1">; restore old value at block exit</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">para</span> <span class="p">(</span><span class="nv">get-paragraph</span> <span class="nv">fh</span><span class="p">))</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">get-paragraph</span> <span class="p">(</span><span class="nv">fh</span><span class="p">)</span>
  <span class="c1">;; Skip leading newlines.</span>
  <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">peek</span> <span class="nb">=</span> <span class="p">(</span><span class="nb">peek-char</span> <span class="no">nil</span> <span class="nv">fh</span> <span class="no">nil</span> <span class="no">nil</span><span class="p">)</span>
     <span class="nv">while</span> <span class="p">(</span><span class="nb">and</span> <span class="nv">peek</span> <span class="p">(</span><span class="nb">eql</span> <span class="nv">peek</span> <span class="sc">#\Newline</span><span class="p">))</span>
     <span class="nb">do</span> <span class="p">(</span><span class="nb">read-char</span> <span class="nv">fh</span> <span class="no">nil</span> <span class="no">nil</span><span class="p">))</span>
  <span class="p">(</span><span class="nv">chomp</span>
   <span class="p">(</span><span class="nb">coerce</span> <span class="p">(</span><span class="nb">loop</span>
              <span class="nv">for</span> <span class="nv">c</span> <span class="nb">=</span> <span class="p">(</span><span class="nb">read-char</span> <span class="nv">fh</span> <span class="no">nil</span> <span class="ss">:eof</span><span class="p">)</span>
              <span class="nv">until</span> <span class="p">(</span><span class="nb">or</span> <span class="p">(</span><span class="nb">eq</span> <span class="nv">c</span> <span class="ss">:eof</span><span class="p">)</span>
                        <span class="p">(</span><span class="nb">and</span> <span class="p">(</span><span class="nb">eql</span> <span class="nv">c</span> <span class="sc">#\Newline</span><span class="p">)</span>
                             <span class="p">(</span><span class="nb">eql</span> <span class="p">(</span><span class="nb">peek-char</span> <span class="no">nil</span> <span class="nv">fh</span> <span class="no">nil</span> <span class="sc">#\Newline</span><span class="p">)</span>
                                  <span class="sc">#\Newline</span><span class="p">)))</span>
              <span class="nv">collect</span> <span class="nv">c</span><span class="p">)</span>
           <span class="ss">&#39;string</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">contents</span> <span class="p">(</span><span class="nv">get-motd</span><span class="p">))</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">get-motd</span> <span class="p">()</span>
  <span class="p">(</span><span class="nb">with-open-file</span> <span class="p">(</span><span class="nv">motd</span> <span class="s">&quot;/etc/motd&quot;</span><span class="p">)</span> <span class="c1">; will do die()-like stuff automatically</span>
    <span class="p">(</span><span class="nb">coerce</span> <span class="p">(</span><span class="nb">loop</span>
               <span class="nv">for</span> <span class="nv">c</span> <span class="nb">=</span> <span class="p">(</span><span class="nb">read-char</span> <span class="nv">motd</span> <span class="no">nil</span> <span class="ss">:eof</span><span class="p">)</span>
               <span class="nv">until</span> <span class="p">(</span><span class="nb">eq</span> <span class="nv">c</span> <span class="ss">:eof</span><span class="p">)</span>
               <span class="nv">collect</span> <span class="nv">c</span><span class="p">)</span>
            <span class="ss">&#39;string</span><span class="p">)))</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; Note: in the spirit of the Perl, this section should be done using</span>
<span class="c1">;; LET and DECLARE SPECIAL but I couldn&#39;t get that to work.</span>
<span class="p">(</span><span class="nb">defparameter</span> <span class="vg">*nums*</span> <span class="o">&#39;</span><span class="p">(</span><span class="mi">0</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span> <span class="mi">4</span> <span class="mi">5</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">my-second</span> <span class="p">()</span>     <span class="c1">; don&#39;t redefine CL&#39;s standard SECOND function</span>
  <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~{~A~^ ~}~%&quot;</span> <span class="vg">*nums*</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">my-first</span> <span class="p">()</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="vg">*nums*</span> <span class="p">(</span><span class="nb">copy-list</span> <span class="vg">*nums*</span><span class="p">)))</span>
    <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">elt</span> <span class="vg">*nums*</span> <span class="mi">3</span><span class="p">)</span> <span class="mf">3.14159</span><span class="p">)</span>
    <span class="p">(</span><span class="nv">my-second</span><span class="p">)))</span>

<span class="p">(</span><span class="nv">my-second</span><span class="p">)</span>
<span class="c1">;; 0 1 2 3 4 5</span>
<span class="p">(</span><span class="nv">my-first</span><span class="p">)</span>
<span class="c1">;; 0 1 2 3.14159 4 5</span>
<span class="c1">;;;-----------------------------</span>
<span class="c1">;; No obvious equivalent to %SIG</span>
<span class="c1">;;;-----------------------------</span>

<span class="c1">;;;-----------------------------</span>
<span class="c1">;;; @@INCOMPLETE@@</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN578"
>Redefining a Function</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">fmakunbound</span> <span class="ss">&#39;grow</span><span class="p">)</span> <span class="c1">; not sure this is necessary, but more like the Perl</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">symbol-function</span> <span class="ss">&#39;grow</span><span class="p">)</span> <span class="nf">#&#39;</span><span class="nv">expand</span><span class="p">)</span>
<span class="p">(</span><span class="nv">grow</span><span class="p">)</span>                                  <span class="c1">; calls EXPAND</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nv">one:var</span> <span class="nv">two:table</span><span class="p">)</span>                <span class="c1">; make ONE:VAR alias for TWO:TABLE</span>
<span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">symbol-function</span> <span class="ss">&#39;one:big</span><span class="p">)</span> <span class="nf">#&#39;</span><span class="nv">two:small</span><span class="p">)</span> <span class="c1">; make ONE:BIG alias for TWO:SMALL</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">fred</span> <span class="nf">#&#39;</span><span class="nv">barney</span><span class="p">))</span>              <span class="c1">; temporarily alias FRED to BARNEY</span>
  <span class="c1">;; ...</span>
  <span class="p">)</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">setf</span> <span class="nb">string</span> <span class="p">(</span><span class="nv">red</span> <span class="s">&quot;careful here&quot;</span><span class="p">))</span>
<span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A&quot;</span> <span class="nb">string</span><span class="p">)</span>
<span class="c1">;; &lt;FONT COLOR=&#39;red&#39;&gt;careful here&lt;/FONT&gt;</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">red</span> <span class="p">(</span><span class="nb">string</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">concatenate</span> <span class="ss">&#39;string</span> <span class="s">&quot;&lt;FONT COLOR=&#39;red&#39;&gt;&quot;</span> <span class="nb">string</span> <span class="s">&quot;&lt;/FONT&gt;&quot;</span><span class="p">))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defmacro</span> <span class="nv">color-font</span> <span class="p">(</span><span class="nv">color</span><span class="p">)</span>
  <span class="o">`</span><span class="p">(</span><span class="nb">defun</span> <span class="o">,</span><span class="p">(</span><span class="nb">intern</span> <span class="p">(</span><span class="nb">string-upcase</span> <span class="nv">color</span><span class="p">))</span> <span class="p">(</span><span class="nb">string</span><span class="p">)</span>
     <span class="p">(</span><span class="nb">concatenate</span> <span class="ss">&#39;string</span> <span class="s">&quot;&lt;FONT COLOR=&#39;&quot;</span> <span class="o">,</span><span class="nv">color</span> <span class="s">&quot;&#39;&gt;&quot;</span> <span class="nb">string</span> <span class="s">&quot;&lt;/FONT&gt;&quot;</span><span class="p">)))</span>

<span class="p">(</span><span class="nv">color-font</span> <span class="s">&quot;red&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nv">color-font</span> <span class="s">&quot;green&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nv">color-font</span> <span class="s">&quot;blue&quot;</span><span class="p">)</span>
<span class="p">(</span><span class="nv">color-font</span> <span class="s">&quot;purple&quot;</span><span class="p">)</span>
<span class="c1">;; etc</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defmacro</span> <span class="nv">color-fonts</span> <span class="p">(</span><span class="k">&amp;rest</span> <span class="nv">colors</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">append</span> <span class="o">&#39;</span><span class="p">(</span><span class="k">progn</span><span class="p">)</span>
          <span class="p">(</span><span class="nb">loop</span> <span class="nv">for</span> <span class="nv">color</span> <span class="nv">in</span> <span class="nv">colors</span>
             <span class="nv">collect</span> <span class="o">`</span><span class="p">(</span><span class="nv">color-font</span> <span class="o">,</span><span class="nv">color</span><span class="p">))))</span>

<span class="p">(</span><span class="nv">color-fonts</span> <span class="s">&quot;red&quot;</span> <span class="s">&quot;green&quot;</span> <span class="s">&quot;blue&quot;</span> <span class="s">&quot;yellow&quot;</span> <span class="s">&quot;orange&quot;</span> <span class="s">&quot;purple&quot;</span> <span class="s">&quot;violet&quot;</span><span class="p">)</span>
<span class="c1">;;;-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN581"
>Trapping Undefined Function Calls with AUTOLOAD</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN584"
>Nesting Subroutines</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">outer</span> <span class="p">(</span><span class="nv">arg</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let*</span> <span class="p">((</span><span class="nv">x</span> <span class="p">(</span><span class="nb">+</span> <span class="nv">arg</span> <span class="mi">35</span><span class="p">))</span>
         <span class="c1">;; You&#39;re much less likely to do this accidentally in CL, but</span>
         <span class="c1">;; I&#39;m trying to match the spirit of the Perl example.</span>
         <span class="p">(</span><span class="nv">inner</span> <span class="p">(</span><span class="k">block</span> <span class="no">nil</span>
                  <span class="p">(</span><span class="nb">return</span> <span class="p">(</span><span class="nb">*</span> <span class="nv">x</span> <span class="mi">19</span><span class="p">)))))</span>  <span class="c1">; WRONG</span>
    <span class="p">(</span><span class="nb">+</span> <span class="nv">x</span> <span class="p">(</span><span class="nv">inner</span><span class="p">))))</span>
<span class="c1">;;;-----------------------------</span>
<span class="p">(</span><span class="nb">defun</span> <span class="nv">outer</span> <span class="p">(</span><span class="nv">arg</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">x</span> <span class="p">(</span><span class="nb">+</span> <span class="nv">arg</span> <span class="mi">35</span><span class="p">)))</span>
    <span class="p">(</span><span class="k">flet</span> <span class="p">((</span><span class="nv">inner</span> <span class="p">()</span> <span class="p">(</span><span class="nb">*</span> <span class="nv">x</span> <span class="mi">19</span><span class="p">)))</span>
      <span class="p">(</span><span class="nb">+</span> <span class="nv">x</span> <span class="p">(</span><span class="nv">inner</span><span class="p">)))))</span>
<span class="c1">;;;-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN587"
>Program: Sorting Your Mail</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="c1">;;;-----------------------------</span>

<span class="p">(</span><span class="nb">defgeneric</span> <span class="nv">cmp</span> <span class="p">(</span><span class="nv">a</span> <span class="nv">b</span><span class="p">)</span>
  <span class="p">(</span><span class="ss">:documentation</span> <span class="s">&quot;Vaguely like Perl&#39;s cmp() function.&quot;</span><span class="p">))</span>

<span class="p">(</span><span class="nb">defmethod</span> <span class="nv">cmp</span> <span class="p">((</span><span class="nv">a</span> <span class="nb">string</span><span class="p">)</span> <span class="p">(</span><span class="nv">b</span> <span class="nb">string</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">cond</span>
    <span class="p">((</span><span class="nb">string=</span> <span class="nv">a</span> <span class="nv">b</span><span class="p">)</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">((</span><span class="nb">string-lessp</span> <span class="nv">a</span> <span class="nv">b</span><span class="p">)</span> <span class="mi">-1</span><span class="p">)</span>
    <span class="p">(</span><span class="no">t</span> <span class="mi">1</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defmethod</span> <span class="nv">cmp</span> <span class="p">((</span><span class="nv">a</span> <span class="nc">number</span><span class="p">)</span> <span class="p">(</span><span class="nv">b</span> <span class="nc">number</span><span class="p">))</span>
  <span class="p">(</span><span class="nb">cond</span>
    <span class="p">((</span><span class="nb">=</span> <span class="nv">a</span> <span class="nv">b</span><span class="p">)</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">((</span><span class="nb">&lt;</span> <span class="nv">a</span> <span class="nv">b</span><span class="p">)</span> <span class="mi">-1</span><span class="p">)</span>
    <span class="p">(</span><span class="no">t</span> <span class="mi">1</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defmethod</span> <span class="nv">cmp</span> <span class="p">(</span><span class="nv">a</span> <span class="nv">b</span><span class="p">)</span>
  <span class="mi">0</span><span class="p">)</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">bysub1</span> <span class="p">(</span><span class="k">&amp;rest</span> <span class="nv">filenames</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">sub</span> <span class="p">(</span><span class="nb">make-array</span> <span class="mi">0</span> <span class="ss">:fill-pointer</span> <span class="mi">0</span><span class="p">))</span>
        <span class="p">(</span><span class="nv">msgs</span> <span class="p">(</span><span class="nb">make-array</span> <span class="mi">0</span> <span class="ss">:fill-pointer</span> <span class="mi">0</span><span class="p">)))</span>
    <span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">filename</span> <span class="nv">filenames</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">with-open-file</span> <span class="p">(</span><span class="nv">file</span> <span class="nv">filename</span><span class="p">)</span>
        <span class="c1">;; GET-PARAGRAPH defined in section 10.13</span>
        <span class="p">(</span><span class="nb">loop</span>
           <span class="nv">for</span> <span class="nv">paragraph</span> <span class="nb">=</span> <span class="p">(</span><span class="nv">get-paragraph</span> <span class="nv">file</span><span class="p">)</span>
           <span class="nv">until</span> <span class="p">(</span><span class="nb">string-equal</span> <span class="nv">paragraph</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
           <span class="nb">do</span> <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nv">scan</span> <span class="p">(</span><span class="nv">create-scanner</span> <span class="err">#</span><span class="nv">?r</span><span class="s">&quot;^From&quot;</span> <span class="ss">:multi-line-mode</span> <span class="no">t</span><span class="p">)</span>
                          <span class="nv">paragraph</span><span class="p">)</span>
                <span class="p">(</span><span class="nb">vector-push-extend</span>
                 <span class="p">(</span><span class="nb">or</span>
                  <span class="p">(</span><span class="nv">register-groups-bind</span> <span class="p">(</span><span class="nv">subject</span><span class="p">)</span>
                      <span class="p">((</span><span class="nv">create-scanner</span> <span class="err">#</span><span class="nv">?r/^Subject:\s*</span><span class="p">(</span><span class="nv">?:Re:\s*</span><span class="p">)</span><span class="nb">*</span><span class="p">(</span><span class="o">.</span><span class="nb">*</span><span class="p">)</span><span class="nb">/</span>
                                       <span class="ss">:case-insensitive-mode</span> <span class="no">t</span> <span class="ss">:multi-line-mode</span> <span class="no">t</span><span class="p">)</span>
                       <span class="nv">paragraph</span><span class="p">)</span>
                    <span class="p">(</span><span class="nb">string-downcase</span> <span class="nv">subject</span><span class="p">))</span>
                  <span class="s">&quot;&quot;</span><span class="p">)</span>
                 <span class="nv">sub</span><span class="p">))</span>
           <span class="p">(</span><span class="nb">vector-push-extend</span> <span class="nv">paragraph</span> <span class="nv">msgs</span><span class="p">))))</span>
    <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">indices</span> <span class="p">(</span><span class="nb">make-array</span> <span class="p">(</span><span class="nb">length</span> <span class="nv">msgs</span><span class="p">)</span>
                               <span class="ss">:initial-contents</span> <span class="p">(</span><span class="nb">loop</span>
                                                    <span class="nv">for</span> <span class="nv">i</span> <span class="nv">below</span> <span class="p">(</span><span class="nb">length</span> <span class="nv">msgs</span><span class="p">)</span>
                                                    <span class="nv">collect</span> <span class="nv">i</span><span class="p">))))</span>
      <span class="p">(</span><span class="nb">sort</span> <span class="nv">indices</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">a</span> <span class="nv">b</span><span class="p">)</span>
                        <span class="p">(</span><span class="nb">case</span> <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">and</span> <span class="p">(</span><span class="nb">&lt;</span> <span class="nv">a</span> <span class="p">(</span><span class="nb">length</span> <span class="nv">sub</span><span class="p">))</span> <span class="p">(</span><span class="nb">&lt;</span> <span class="nv">b</span> <span class="p">(</span><span class="nb">length</span> <span class="nv">sub</span><span class="p">)))</span>
                                  <span class="p">(</span><span class="nv">cmp</span> <span class="p">(</span><span class="nb">aref</span> <span class="nv">sub</span> <span class="nv">a</span><span class="p">)</span> <span class="p">(</span><span class="nb">aref</span> <span class="nv">sub</span> <span class="nv">b</span><span class="p">))</span>
                                  <span class="mi">0</span><span class="p">)</span>
                          <span class="p">(</span><span class="mi">0</span> <span class="p">(</span><span class="nb">&lt;</span> <span class="nv">a</span> <span class="nv">b</span><span class="p">))</span>
                          <span class="p">(</span><span class="mi">-1</span> <span class="no">t</span><span class="p">))))</span>
      <span class="p">(</span><span class="nb">map</span> <span class="no">nil</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">i</span><span class="p">)</span>
                   <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A~%&quot;</span> <span class="p">(</span><span class="nb">aref</span> <span class="nv">msgs</span> <span class="nv">i</span><span class="p">)))</span>
           <span class="nv">indices</span><span class="p">))))</span>

<span class="c1">;; bysub2 illustrates a Perl-specific idiom and will be skipped.</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">print-hash-table</span> <span class="p">(</span><span class="nv">hashtable</span><span class="p">)</span>
  <span class="s">&quot;Useful for debugging.&quot;</span>
  <span class="p">(</span><span class="nb">loop</span>
     <span class="nv">for</span> <span class="nv">key</span> <span class="nv">being</span> <span class="k">the</span> <span class="nv">hash-keys</span> <span class="nv">of</span> <span class="nv">hashtable</span> <span class="nv">using</span> <span class="p">(</span><span class="nv">hash-value</span> <span class="nv">value</span><span class="p">)</span>
     <span class="nb">do</span> <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A: ~A~%&quot;</span> <span class="nv">key</span> <span class="nv">value</span><span class="p">)))</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">bysub3</span> <span class="p">(</span><span class="k">&amp;rest</span> <span class="nv">filenames</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">msgs</span> <span class="p">(</span><span class="nb">make-array</span> <span class="mi">0</span> <span class="ss">:fill-pointer</span> <span class="mi">0</span><span class="p">)))</span>
    <span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">filename</span> <span class="nv">filenames</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">with-open-file</span> <span class="p">(</span><span class="nv">file</span> <span class="nv">filename</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">loop</span>
           <span class="nv">for</span> <span class="nv">paragraph</span> <span class="nb">=</span> <span class="p">(</span><span class="nv">get-paragraph</span> <span class="nv">file</span><span class="p">)</span>
           <span class="nv">until</span> <span class="p">(</span><span class="nb">string-equal</span> <span class="nv">paragraph</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
           <span class="nb">do</span>
           <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nv">scan</span> <span class="p">(</span><span class="nv">create-scanner</span> <span class="err">#</span><span class="nv">?r</span><span class="s">&quot;^From&quot;</span> <span class="ss">:multi-line-mode</span> <span class="no">t</span><span class="p">)</span>
                       <span class="nv">paragraph</span><span class="p">)</span>
             <span class="p">(</span><span class="nb">vector-push-extend</span>
              <span class="p">(</span><span class="nv">mkhash</span>                   <span class="c1">; MKHASH defined in appendix</span>
               <span class="ss">:subject</span> <span class="p">(</span><span class="nv">register-groups-bind</span> <span class="p">(</span><span class="nv">subject</span><span class="p">)</span>
                            <span class="p">((</span><span class="nv">create-scanner</span> <span class="err">#</span><span class="nv">?r/^Subject:\s*</span><span class="p">(</span><span class="nv">?:Re:\s*</span><span class="p">)</span><span class="nb">*</span><span class="p">(</span><span class="o">.</span><span class="nb">*</span><span class="p">)</span><span class="nb">/</span>
                                             <span class="ss">:case-insensitive-mode</span> <span class="no">t</span> <span class="ss">:multi-line-mode</span> <span class="no">t</span><span class="p">)</span> <span class="nv">paragraph</span><span class="p">)</span>
                          <span class="p">(</span><span class="nb">string-downcase</span> <span class="nv">subject</span><span class="p">))</span>
               <span class="ss">:number</span> <span class="p">(</span><span class="nb">fill-pointer</span> <span class="nv">msgs</span><span class="p">)</span>
               <span class="ss">:text</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
              <span class="nv">msgs</span><span class="p">))</span>
           <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">mail-record</span> <span class="p">(</span><span class="nb">aref</span> <span class="nv">msgs</span> <span class="p">(</span><span class="nb">1-</span> <span class="p">(</span><span class="nb">fill-pointer</span> <span class="nv">msgs</span><span class="p">)))))</span>
             <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:text</span> <span class="nv">mail-record</span><span class="p">)</span> <span class="p">(</span><span class="nb">concatenate</span> <span class="ss">&#39;string</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:text</span> <span class="nv">mail-record</span><span class="p">)</span> <span class="nv">paragraph</span><span class="p">))))))</span>
    <span class="p">(</span><span class="nb">map</span> <span class="no">nil</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">msg</span><span class="p">)</span>
                 <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A&quot;</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:text</span> <span class="nv">msg</span><span class="p">)))</span>
         <span class="p">(</span><span class="nb">sort</span> <span class="nv">msgs</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">a</span> <span class="nv">b</span><span class="p">)</span>
                        <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">subject-a</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:subject</span> <span class="nv">a</span><span class="p">))</span>
                              <span class="p">(</span><span class="nv">subject-b</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:subject</span> <span class="nv">b</span><span class="p">)))</span>
                          <span class="p">(</span><span class="nb">case</span> <span class="p">(</span><span class="nv">cmp</span> <span class="nv">subject-a</span> <span class="nv">subject-b</span><span class="p">)</span>
                            <span class="p">(</span><span class="mi">0</span> <span class="p">(</span><span class="nb">&lt;</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:number</span> <span class="nv">a</span><span class="p">)</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:number</span> <span class="nv">b</span><span class="p">)))</span>
                            <span class="p">(</span><span class="mi">-1</span> <span class="no">t</span><span class="p">))))))))</span>

<span class="c1">;; Can be downloaded using ASDF-INSTALL</span>
<span class="p">(</span><span class="nb">require</span> <span class="ss">:metatilities</span><span class="p">)</span>

<span class="p">(</span><span class="nb">defun</span> <span class="nv">datesort</span> <span class="p">(</span><span class="k">&amp;rest</span> <span class="nv">filenames</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">msgs</span> <span class="p">(</span><span class="nb">make-array</span> <span class="mi">0</span> <span class="ss">:fill-pointer</span> <span class="mi">0</span><span class="p">)))</span>
    <span class="p">(</span><span class="nb">dolist</span> <span class="p">(</span><span class="nv">filename</span> <span class="nv">filenames</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">with-open-file</span> <span class="p">(</span><span class="nv">file</span> <span class="nv">filename</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">loop</span>
           <span class="nv">for</span> <span class="nv">paragraph</span> <span class="nb">=</span> <span class="p">(</span><span class="nv">get-paragraph</span> <span class="nv">file</span><span class="p">)</span>
           <span class="nv">until</span> <span class="p">(</span><span class="nb">string-equal</span> <span class="nv">paragraph</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
           <span class="nb">do</span>
           <span class="p">(</span><span class="nb">when</span> <span class="p">(</span><span class="nv">scan</span> <span class="p">(</span><span class="nv">create-scanner</span> <span class="err">#</span><span class="nv">?r</span><span class="s">&quot;^From&quot;</span> <span class="ss">:multi-line-mode</span> <span class="no">t</span><span class="p">)</span>
                       <span class="nv">paragraph</span><span class="p">)</span>
             <span class="p">(</span><span class="nb">vector-push-extend</span>
              <span class="p">(</span><span class="nv">mkhash</span>
               <span class="ss">:subject</span> <span class="p">(</span><span class="nv">register-groups-bind</span> <span class="p">(</span><span class="nv">subject</span><span class="p">)</span>
                            <span class="p">((</span><span class="nv">create-scanner</span> <span class="err">#</span><span class="nv">?r/^Subject:\s*</span><span class="p">(</span><span class="nv">?:Re:\s*</span><span class="p">)</span><span class="nb">*</span><span class="p">(</span><span class="o">.</span><span class="nb">*</span><span class="p">)</span><span class="nb">/</span>
                                             <span class="ss">:case-insensitive-mode</span> <span class="no">t</span> <span class="ss">:multi-line-mode</span> <span class="no">t</span><span class="p">)</span> <span class="nv">paragraph</span><span class="p">)</span>
                          <span class="p">(</span><span class="nb">string-downcase</span> <span class="nv">subject</span><span class="p">))</span>
               <span class="ss">:number</span> <span class="p">(</span><span class="nb">fill-pointer</span> <span class="nv">msgs</span><span class="p">)</span>
               <span class="c1">;; Need IGNORE-ERRORS because PARSE-DATE-AND-TIME can</span>
               <span class="c1">;; signal conditions</span>
               <span class="ss">:date</span> <span class="p">(</span><span class="nb">ignore-errors</span>
                       <span class="p">(</span><span class="nv">metatilities:parse-date-and-time</span>
                        <span class="p">(</span><span class="nv">register-groups-bind</span> <span class="p">(</span><span class="nv">date</span><span class="p">)</span>
                            <span class="p">((</span><span class="nv">create-scanner</span> <span class="err">#</span><span class="nv">?r/^Date:\s*</span><span class="p">(</span><span class="o">.</span><span class="nb">*</span><span class="p">)</span><span class="nb">/</span> <span class="ss">:multi-line-mode</span> <span class="no">t</span><span class="p">)</span> <span class="nv">paragraph</span><span class="p">)</span>
                          <span class="p">(</span><span class="nb">car</span> <span class="p">(</span><span class="nv">split</span> <span class="err">#</span><span class="nv">?r</span><span class="s">&quot;\s+\(&quot;</span> <span class="nv">date</span><span class="p">)))))</span>
               <span class="ss">:text</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
              <span class="nv">msgs</span><span class="p">))</span>
           <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nv">mail-record</span> <span class="p">(</span><span class="nb">aref</span> <span class="nv">msgs</span> <span class="p">(</span><span class="nb">1-</span> <span class="p">(</span><span class="nb">fill-pointer</span> <span class="nv">msgs</span><span class="p">)))))</span>
             <span class="p">(</span><span class="nb">setf</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:text</span> <span class="nv">mail-record</span><span class="p">)</span> <span class="p">(</span><span class="nb">concatenate</span> <span class="ss">&#39;string</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:text</span> <span class="nv">mail-record</span><span class="p">)</span> <span class="nv">paragraph</span><span class="p">))))))</span>
    <span class="p">(</span><span class="nb">map</span> <span class="no">nil</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">msg</span><span class="p">)</span>
                 <span class="p">(</span><span class="nb">format</span> <span class="no">t</span> <span class="s">&quot;~A&quot;</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:text</span> <span class="nv">msg</span><span class="p">)))</span>
         <span class="p">(</span><span class="nb">sort</span> <span class="nv">msgs</span> <span class="nf">#&#39;</span><span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nv">a</span> <span class="nv">b</span><span class="p">)</span>
                        <span class="p">(</span><span class="nb">case</span> <span class="p">(</span><span class="nv">cmp</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:subject</span> <span class="nv">a</span><span class="p">)</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:subject</span> <span class="nv">b</span><span class="p">))</span>
                          <span class="p">(</span><span class="mi">-1</span> <span class="no">t</span><span class="p">)</span>
                          <span class="p">(</span><span class="mi">0</span> <span class="p">(</span><span class="nb">case</span> <span class="p">(</span><span class="nv">cmp</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:date</span> <span class="nv">a</span><span class="p">)</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:date</span> <span class="nv">b</span><span class="p">))</span>
                               <span class="p">(</span><span class="mi">-1</span> <span class="no">t</span><span class="p">)</span>
                               <span class="p">(</span><span class="mi">0</span> <span class="p">(</span><span class="nb">&lt;</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:number</span> <span class="nv">a</span><span class="p">)</span> <span class="p">(</span><span class="nb">gethash</span> <span class="ss">:number</span> <span class="nv">b</span><span class="p">)))))))))))</span></PRE
></TD
></TR
></TABLE
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="directories.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="referencesandrecords.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Directories</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
>&nbsp;</TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>References and Records</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>
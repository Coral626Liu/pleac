<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN""http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>Web Automation</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="PLEAC-Perl"
HREF="index.html"><LINK
REL="PREVIOUS"
TITLE="CGI Programming"
HREF="cgiprogramming.html"><LINK
REL="NEXT"
TITLE="Helpers"
HREF="a1102.html"><style type="text/css">td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
pre { line-height: 125%; }

  </style></head
><BODY TEXT="#cecece" BGCOLOR="#4f6f6f" LINK="#f5deb3" VLINK="#d5ae83"
CLASS="SECT1"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>PLEAC-Perl</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="cgiprogramming.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
></TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="a1102.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="WEBAUTOMATION"
>20. Web Automation</A
></H1
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1054"
>Introduction</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">#-----------------------------</span>
<span class="cp">http://www.perl.com/CPAN/modules/by-category/15_World_Wide_Web_HTML_HTTP_CGI/</span>
<span class="cp">#-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1057"
>Fetching a URL from a Perl Script</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">#-----------------------------</span>
<span class="cp">use LWP::Simple;</span>
<span class="cp">$content = get($URL);</span>
<span class="cp">#-----------------------------</span>
<span class="cp">use LWP::Simple;</span>
<span class="cp">unless (defined ($content = get $URL)) {</span>
<span class="cp">    die &quot;could not get $URL\n&quot;;</span>
<span class="cp">}</span>
<span class="cp">#-----------------------------</span>
<span class="cp"># <font size="-1"><a href="http://pleac.sourceforge.net/include/perl/ch20/titlebytes</span>">download the following standalone program</a></font>
<span class="cp">#!/usr/bin/perl -w </span>
<span class="cp"># titlebytes - find the title and size of documents </span>
<span class="cp">use LWP::UserAgent; </span>
<span class="cp">use HTTP::Request; </span>
<span class="cp">use HTTP::Response; </span>
<span class="cp">use URI::Heuristic;</span>
<span class="cp">my $raw_url = shift                or die &quot;usage: $0 url\n&quot;; </span>
<span class="cp">my $url = URI::Heuristic::uf_urlstr($raw_url);</span>
<span class="cp">$| = 1; 									# to flush next line </span>
<span class="cp">printf &quot;%s =&gt;\n\t&quot;, $url;</span>
<span class="cp">my $ua = LWP::UserAgent-&gt;new(); </span>
<span class="cp">$ua-&gt;agent(&quot;Schmozilla/v9.14 Platinum&quot;); # give it time, it&#39;ll get there</span>
<span class="cp">my $req = HTTP::Request-&gt;new(GET =&gt; $url); </span>
<span class="cp">$req-&gt;referer(&quot;http://wizard.yellowbrick.oz&quot;);</span>
<span class="cp">			                            # perplex the log analysers</span>
<span class="cp">my $response = $ua-&gt;request($req);</span>
<span class="cp">if ($response-&gt;is_error()) {</span>
<span class="cp">     printf &quot; %s\n&quot;, $response-&gt;status_line;</span>
<span class="cp"> } else {</span>
<span class="cp">     my $count;</span>
<span class="cp">     my $bytes;</span>
<span class="cp">     my $content = $response-&gt;content();</span>
<span class="cp">     $bytes = length $content;</span>
<span class="cp">     $count = ($content =~ tr/\n/\n/);</span>
<span class="cp">     printf &quot;%s (%d lines, %d bytes)\n&quot;, $response-&gt;title(), $count, $bytes; } </span>

<span class="cp">#-----------------------------</span>
<span class="cp">#% titlebytes http://www.tpj.com/</span>
<span class="cp">#http://www.tpj.com/ =&gt;</span>
<span class="cp">#    The Perl Journal (109 lines, 4530 bytes)</span>
<span class="cp">#-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1060"
>Automating Form Submission</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">#-----------------------------</span>
<span class="cp">use LWP::Simple;</span>
<span class="cp">use URI::URL;</span>

<span class="cp">my $url = url(&#39;http://www.perl.com/cgi-bin/cpan_mod&#39;);</span>
<span class="cp">$url-&gt;query_form(module =&gt; &#39;DB_File&#39;, readme =&gt; 1);</span>
<span class="cp">$content = get($url);</span>
<span class="cp">#-----------------------------</span>
<span class="cp">use HTTP::Request::Common qw(POST);</span>
<span class="cp">use LWP::UserAgent;</span>

<span class="cp">$ua = LWP::UserAgent-&gt;new();</span>
<span class="cp">my $req = POST &#39;http://www.perl.com/cgi-bin/cpan_mod&#39;,</span>
<span class="cp">               [ module =&gt; &#39;DB_File&#39;, readme =&gt; 1 ];</span>
<span class="cp">$content = $ua-&gt;request($req)-&gt;as_string;</span>
<span class="cp">#-----------------------------</span>
<span class="cp">field1=value1&amp;field2=value2&amp;field3=value3</span>
<span class="cp">#-----------------------------</span>
<span class="cp">http://www.site.com/path/to/</span>
<span class="cp">script.cgi?field1=value1&amp;field2=value2&amp;field3=value3</span>
<span class="cp">#-----------------------------</span>
<span class="cp">http://www.site.com/path/to/</span>
<span class="cp">script.cgi?arg=%22this+isn%27t+%3CEASY%3E+%26+%3CFUN%3E%22</span>
<span class="cp">#-----------------------------</span>
<span class="cp">$ua-&gt;proxy([&#39;http&#39;, &#39;ftp&#39;] =&gt; &#39;http://proxy.myorg.com:8081&#39;);</span>
<span class="cp">#-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1063"
>Extracting URLs</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">#-----------------------------</span>
<span class="cp">use HTML::LinkExtor;</span>

<span class="cp">$parser = HTML::LinkExtor-&gt;new(undef, $base_url);</span>
<span class="cp">$parser-&gt;parse_file($filename);</span>
<span class="cp">@links = $parser-&gt;links;</span>
<span class="cp">foreach $linkarray (@links) {</span>
<span class="cp">    my @element = @$linkarray;</span>
<span class="cp">    my $elt_type = shift @element;                  # element type</span>

<span class="cp">    # possibly test whether this is an element we&#39;re interested in</span>
<span class="cp">    while (@element) {</span>
<span class="cp">        # extract the next attribute and its value</span>
<span class="cp">        my ($attr_name, $attr_value) = splice(@element, 0, 2);</span>
<span class="cp">        # ... do something with them ...</span>
<span class="cp">    }</span>
<span class="cp">}</span>
<span class="cp">#-----------------------------</span>
<span class="cp">&lt;A HREF=&quot;http://www.perl.com/&quot;&gt;Home page&lt;/A&gt;</span>
<span class="cp">&lt;IMG SRC=&quot;images/big.gif&quot; LOWSRC=&quot;images/big-lowres.gif&quot;&gt;</span>
<span class="cp">#-----------------------------</span>
<span class="cp">[</span>
<span class="cp">  [ a,   href   =&gt; &quot;http://www.perl.com/&quot; ],</span>
<span class="cp">  [ img, src    =&gt; &quot;images/big.gif&quot;,</span>
<span class="cp">         lowsrc =&gt; &quot;images/big-lowres.gif&quot; ]</span>
<span class="cp">]</span>
<span class="cp">#-----------------------------</span>
<span class="cp">if ($elt_type eq &#39;a&#39; &amp;&amp; $attr_name eq &#39;href&#39;) {</span>
<span class="cp">    print &quot;ANCHOR: $attr_value\n&quot; </span>
<span class="cp">        if $attr_value-&gt;scheme =~ /http|ftp/;</span>
<span class="cp">}</span>
<span class="cp">if ($elt_type eq &#39;img&#39; &amp;&amp; $attr_name eq &#39;src&#39;) {</span>
<span class="cp">    print &quot;IMAGE:  $attr_value\n&quot;;</span>
<span class="cp">}</span>
<span class="cp">#-----------------------------</span>
<span class="cp"># <font size="-1"><a href="http://pleac.sourceforge.net/include/perl/ch20/xurl</span>">download the following standalone program</a></font>
<span class="cp">#!/usr/bin/perl -w</span>
<span class="cp"># xurl - extract unique, sorted list of links from URL</span>
<span class="cp">use HTML::LinkExtor;</span>
<span class="cp">use LWP::Simple;</span>

<span class="cp">$base_url = shift;</span>
<span class="cp">$parser = HTML::LinkExtor-&gt;new(undef, $base_url);</span>
<span class="cp">$parser-&gt;parse(get($base_url))-&gt;eof;</span>
<span class="cp">@links = $parser-&gt;links;</span>
<span class="cp">foreach $linkarray (@links) {</span>
<span class="cp">    my @element  = @$linkarray;</span>
<span class="cp">    my $elt_type = shift @element;</span>
<span class="cp">    while (@element) {</span>
<span class="cp">        my ($attr_name , $attr_value) = splice(@element, 0, 2);</span>
<span class="cp">        $seen{$attr_value}++;</span>
<span class="cp">    }</span>
<span class="cp">}</span>
<span class="cp">for (sort keys %seen) { print $_, &quot;\n&quot; }</span>

<span class="cp">#-----------------------------</span>
<span class="cp">#% xurl http://www.perl.com/CPAN</span>
<span class="cp">#ftp://ftp@ftp.perl.com/CPAN/CPAN.html</span>
<span class="cp">#</span>
<span class="cp">#http://language.perl.com/misc/CPAN.cgi</span>
<span class="cp">#</span>
<span class="cp">#http://language.perl.com/misc/cpan_module</span>
<span class="cp">#</span>
<span class="cp">#http://language.perl.com/misc/getcpan</span>
<span class="cp">#</span>
<span class="cp">#http://www.perl.com/index.html</span>
<span class="cp">#</span>
<span class="cp">#http://www.perl.com/gifs/lcb.xbm</span>
<span class="cp">#-----------------------------</span>
<span class="cp">&lt;URL:http://www.perl.com&gt;</span>
<span class="cp">#-----------------------------</span>
<span class="cp">@URLs = ($message =~ /&lt;URL:(.*?)&gt;/g);</span>
<span class="cp">#-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1066"
>Converting ASCII to HTML</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">#-----------------------------</span>
<span class="cp"># <font size="-1"><a href="http://pleac.sourceforge.net/include/perl/ch20/text2html</span>">download the following standalone program</a></font>
<span class="cp">#!/usr/bin/perl -w -p00</span>
<span class="cp"># text2html - trivial html encoding of normal text</span>
<span class="cp"># -p means apply this script to each record.</span>
<span class="cp"># -00 mean that a record is now a paragraph</span>

<span class="cp">use HTML::Entities;</span>
<span class="cp">$_ = encode_entities($_, &quot;\200-\377&quot;);</span>

<span class="cp">if (/^\s/) {</span>
<span class="cp">    # Paragraphs beginning with whitespace are wrapped in &lt;PRE&gt; </span>
<span class="cp">    s{(.*)$}        {&lt;PRE&gt;\n$1&lt;/PRE&gt;\n}s;           # indented verbatim</span>
<span class="cp">} else {</span>
<span class="cp">    s{^(&gt;.*)}       {$1&lt;BR&gt;}gm;                    # quoted text</span>
<span class="cp">    s{&lt;URL:(.*?)&gt;}    {&lt;A HREF=&quot;$1&quot;&gt;$1&lt;/A&gt;}gs         # embedded URL  (good)</span>
<span class="cp">                    ||</span>
<span class="cp">    s{(http:\S+)}   {&lt;A HREF=&quot;$1&quot;&gt;$1&lt;/A&gt;}gs;        # guessed URL   (bad)</span>
<span class="cp">    s{\*(\S+)\*}    {&lt;STRONG&gt;$1&lt;/STRONG&gt;}g;         # this is *bold* here</span>
<span class="cp">    s{\b_(\S+)\_\b} {&lt;EM&gt;$1&lt;/EM&gt;}g;                 # this is _italics_ here</span>
<span class="cp">    s{^}            {&lt;P&gt;\n};                        # add paragraph tag</span>
<span class="cp">}</span>

<span class="cp">#-----------------------------</span>
<span class="cp">BEGIN {</span>
<span class="cp">    print &quot;&lt;TABLE&gt;&quot;;</span>
<span class="cp">    $_ = encode_entities(scalar &lt;&gt;);</span>
<span class="cp">    s/\n\s+/ /g;  # continuation lines</span>
<span class="cp">    while ( /^(\S+?:)\s*(.*)$/gm ) {                # parse heading</span>
<span class="cp">        print &quot;&lt;TR&gt;&lt;TH ALIGN=&#39;LEFT&#39;&gt;$1&lt;/TH&gt;&lt;TD&gt;$2&lt;/TD&gt;&lt;/TR&gt;\n&quot;;</span>
<span class="cp">    }</span>
<span class="cp">    print &quot;&lt;/TABLE&gt;&lt;HR&gt;&quot;;</span>
<span class="cp">}</span>
<span class="cp">#-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1069"
>Converting HTML to ASCII</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">#-----------------------------</span>
<span class="cp">$ascii = `lynx -dump $filename`;</span>
<span class="cp">#-----------------------------</span>
<span class="cp">use HTML::FormatText;</span>
<span class="cp">use HTML::Parse;</span>

<span class="cp">$html = parse_htmlfile($filename);</span>
<span class="cp">$formatter = HTML::FormatText-&gt;new(leftmargin =&gt; 0, rightmargin =&gt; 50);</span>
<span class="cp">$ascii = $formatter-&gt;format($html);</span>
<span class="cp">#-----------------------------</span>
<span class="cp">use HTML::TreeBuilder;</span>
<span class="cp">use HTML::FormatText;</span>

<span class="cp">$html = HTML::TreeBuilder-&gt;new();</span>
<span class="cp">$html-&gt;parse($document);</span>

<span class="cp">$formatter = HTML::FormatText-&gt;new(leftmargin =&gt; 0, rightmargin =&gt; 50);</span>

<span class="cp">$ascii = $formatter-&gt;format($html);</span>
<span class="cp">#-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1072"
>Extracting or Removing HTML Tags</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">#-----------------------------</span>
<span class="cp">($plain_text = $html_text) =~ s/&lt;[^&gt;]*&gt;//gs;     #WRONG</span>
<span class="cp">#-----------------------------</span>
<span class="cp">use HTML::Parse;</span>
<span class="cp">use HTML::FormatText;</span>
<span class="cp">$plain_text = HTML::FormatText-&gt;new-&gt;format(parse_html($html_text));</span>
<span class="cp">#-----------------------------</span>
<span class="cp">#% perl -pe &#39;s/&lt;[^&gt;]*&gt;//g&#39; file</span>
<span class="cp">#-----------------------------</span>
<span class="cp">#&lt;IMG SRC = &quot;foo.gif&quot;</span>
<span class="cp">#     ALT = &quot;Flurp!&quot;&gt;</span>
<span class="cp">#-----------------------------</span>
<span class="cp">#% perl -0777 -pe &#39;s/&lt;[^&gt;]*&gt;//gs&#39; file</span>
<span class="cp">#-----------------------------</span>
<span class="cp">{</span>
<span class="cp">    local $/;               # temporary whole-file input mode</span>
<span class="cp">    $html = &lt;FILE&gt;;</span>
<span class="cp">    $html =~ s/&lt;[^&gt;]*&gt;//gs;</span>
<span class="cp">}</span>
<span class="cp">#-----------------------------</span>
<span class="cp">#&lt;IMG SRC = &quot;foo.gif&quot; ALT = &quot;A &gt; B&quot;&gt;</span>
<span class="cp">#</span>
<span class="cp">#&lt;!-- &lt;A comment&gt; --&gt;</span>
<span class="cp">#</span>
<span class="cp">#&lt;script&gt;if (a&lt;b &amp;&amp; a&gt;c)&lt;/script&gt;</span>
<span class="cp">#</span>
<span class="cp">#&lt;# Just data #&gt;</span>
<span class="cp">#</span>
<span class="cp">#&lt;![INCLUDE CDATA [ &gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; ]]&gt;</span>
<span class="cp">#-----------------------------</span>
<span class="cp">#&lt;!-- This section commented out.</span>
<span class="cp">#    &lt;B&gt;You can&#39;t see me!&lt;/B&gt;</span>
<span class="cp">#--&gt;</span>
<span class="cp">#-----------------------------</span>
<span class="cp">package MyParser;</span>
<span class="cp">use HTML::Parser;</span>
<span class="cp">use HTML::Entities qw(decode_entities);</span>

<span class="cp">@ISA = qw(HTML::Parser);</span>

<span class="cp">sub text {</span>
<span class="cp">    my($self, $text) = @_;</span>
<span class="cp">    print decode_entities($text);</span>
<span class="cp">}</span>

<span class="cp">package main;</span>
<span class="cp">MyParser-&gt;new-&gt;parse_file(*F);</span>
<span class="cp">#-----------------------------</span>
<span class="cp">($title) = ($html =~ m#&lt;TITLE&gt;\s*(.*?)\s*&lt;/TITLE&gt;#is);</span>
<span class="cp">#-----------------------------</span>
<span class="cp"># <font size="-1"><a href="http://pleac.sourceforge.net/include/perl/ch20/htitle</span>">download the following standalone program</a></font>
<span class="cp">#!/usr/bin/perl</span>
<span class="cp"># htitle - get html title from URL</span>

<span class="cp">die &quot;usage: $0 url ...\n&quot; unless @ARGV;</span>
<span class="cp">require LWP;</span>

<span class="cp">foreach $url (@ARGV) {</span>
<span class="cp">    $ua = LWP::UserAgent-&gt;new();</span>
<span class="cp">    $res = $ua-&gt;request(HTTP::Request-&gt;new(GET =&gt; $url));</span>
<span class="cp">    print &quot;$url: &quot; if @ARGV &gt; 1;</span>
<span class="cp">    if ($res-&gt;is_success) {</span>
<span class="cp">        print $res-&gt;title, &quot;\n&quot;;</span>
<span class="cp">    } else {</span>
<span class="cp">        print $res-&gt;status_line, &quot;\n&quot;;</span>
<span class="cp">    }</span>
<span class="cp">}</span>

<span class="cp">#-----------------------------</span>
<span class="cp">#% htitle http://www.ora.com</span>
<span class="cp">#www.oreilly.com -- Welcome to O&#39;Reilly &amp; Associates!</span>
<span class="cp">#</span>
<span class="cp">#% htitle http://www.perl.com/ http://www.perl.com/nullvoid</span>
<span class="cp">#http://www.perl.com/: The www.perl.com Home Page</span>
<span class="cp">#http://www.perl.com/nullvoid: 404 File Not Found</span>
<span class="cp">#-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1075"
>Finding Stale Links</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">#-----------------------------</span>
<span class="cp"># <font size="-1"><a href="http://pleac.sourceforge.net/include/perl/ch20/churl</span>">download the following standalone program</a></font>
<span class="cp">#!/usr/bin/perl -w</span>
<span class="cp"># churl - check urls</span>

<span class="cp">use HTML::LinkExtor;</span>
<span class="cp">use LWP::Simple qw(get head);</span>

<span class="cp">$base_url = shift</span>
<span class="cp">    or die &quot;usage: $0 &lt;start_url&gt;\n&quot;;</span>
<span class="cp">$parser = HTML::LinkExtor-&gt;new(undef, $base_url);</span>
<span class="cp">$parser-&gt;parse(get($base_url));</span>
<span class="cp">@links = $parser-&gt;links;</span>
<span class="cp">print &quot;$base_url: \n&quot;;</span>
<span class="cp">foreach $linkarray (@links) {</span>
<span class="cp">    my @element  = @$linkarray;</span>
<span class="cp">    my $elt_type = shift @element;</span>
<span class="cp">    while (@element) {</span>
<span class="cp">        my ($attr_name , $attr_value) = splice(@element, 0, 2);</span>
<span class="cp">        if ($attr_value-&gt;scheme =~ /\b(ftp|https?|file)\b/) {</span>
<span class="cp">            print &quot;  $attr_value: &quot;, head($attr_value) ? &quot;OK&quot; : &quot;BAD&quot;, &quot;\n&quot;;</span>
<span class="cp">        }</span>
<span class="cp">    }</span>
<span class="cp">}</span>

<span class="cp">#-----------------------------</span>
<span class="cp">#% churl http://www.wizards.com</span>
<span class="cp">#http://www.wizards.com:</span>
<span class="cp">#</span>
<span class="cp">#  FrontPage/FP_Color.gif:  OK</span>
<span class="cp">#</span>
<span class="cp">#  FrontPage/FP_BW.gif:  BAD</span>
<span class="cp">#</span>
<span class="cp">#  #FP_Map:  OK</span>
<span class="cp">#</span>
<span class="cp">#  Games_Library/Welcome.html:  OK</span>
<span class="cp">#-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1078"
>Finding Fresh Links</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">#-----------------------------</span>
<span class="cp"># <font size="-1"><a href="http://pleac.sourceforge.net/include/perl/ch20/surl</span>">download the following standalone program</a></font>
<span class="cp">#!/usr/bin/perl -w</span>
<span class="cp"># surl - sort URLs by their last modification date</span>

<span class="cp">use LWP::UserAgent;</span>
<span class="cp">use HTTP::Request;</span>
<span class="cp">use URI::URL qw(url);</span>

<span class="cp">my($url, %Date);</span>
<span class="cp">my $ua = LWP::UserAgent-&gt;new();</span>

<span class="cp">while ( $url = url(scalar &lt;&gt;) ) {</span>
<span class="cp">    my($req, $ans);</span>
<span class="cp">    next unless $url-&gt;scheme =~ /^(file|https?)$/;</span>
<span class="cp">    $ans = $ua-&gt;request(HTTP::Request-&gt;new(&quot;HEAD&quot;, $url));</span>
<span class="cp">    if ($ans-&gt;is_success) {</span>
<span class="cp">        $Date{$url} = $ans-&gt;last_modified || 0;  # unknown</span>
<span class="cp">    } else {</span>
<span class="cp">        print STDERR &quot;$url: Error [&quot;, $ans-&gt;code, &quot;] &quot;, $ans-&gt;message, &quot;!\n&quot;;</span>
<span class="cp">    }</span>
<span class="cp">}</span>

<span class="cp">foreach $url ( sort { $Date{$b} &lt;=&gt; $Date{$a} } keys %Date ) {</span>
<span class="cp">    printf &quot;%-25s %s\n&quot;, $Date{$url} ? (scalar localtime $Date{$url})</span>
<span class="cp">                                     : &quot;&lt;NONE SPECIFIED&gt;&quot;, $url;</span>
<span class="cp">}</span>

<span class="cp">#-----------------------------</span>
<span class="cp">#% xurl http://www.perl.com/  | surl | head</span>
<span class="cp">#Mon Apr 20 06:16:02 1998  http://electriclichen.com/linux/srom.html</span>
<span class="cp">#</span>
<span class="cp">#Fri Apr 17 13:38:51 1998  http://www.oreilly.com/</span>
<span class="cp">#</span>
<span class="cp">#Fri Mar 13 12:16:47 1998  http://www2.binevolve.com/</span>
<span class="cp">#</span>
<span class="cp">#Sun Mar  8 21:01:27 1998  http://www.perl.org/</span>
<span class="cp">#</span>
<span class="cp">#Tue Nov 18 13:41:32 1997  http://www.perl.com/universal/header.map</span>
<span class="cp">#</span>
<span class="cp">#Wed Oct  1 12:55:13 1997  http://www.songline.com/</span>
<span class="cp">#</span>
<span class="cp">#Sun Aug 17 21:43:51 1997  http://www.perl.com/graphics/perlhome_header.jpg</span>
<span class="cp">#</span>
<span class="cp">#Sun Aug 17 21:43:47 1997  http://www.perl.com/graphics/perl_id_313c.gif</span>
<span class="cp">#</span>
<span class="cp">#Sun Aug 17 21:43:46 1997  http://www.perl.com/graphics/ora_logo.gif</span>
<span class="cp">#</span>
<span class="cp">#Sun Aug 17 21:43:44 1997  http://www.perl.com/graphics/header-nav.gif</span>
<span class="cp">#-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1081"
>Creating HTML Templates</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">#-----------------------------</span>
<span class="cp">sub template {</span>
<span class="cp">    my ($filename, $fillings) = @_;</span>
<span class="cp">    my $text;</span>
<span class="cp">    local $/;                   # slurp mode (undef)</span>
<span class="cp">    local *F;                   # create local filehandle</span>
<span class="cp">    open(F, &quot;&lt; $filename\0&quot;)    || return;</span>
<span class="cp">    $text = &lt;F&gt;;                # read whole file</span>
<span class="cp">    close(F);                   # ignore retval</span>
<span class="cp">    # replace quoted words with value in %$fillings hash</span>
<span class="cp">    $text =~ s{ %% ( .*? ) %% }</span>
<span class="cp">              { exists( $fillings-&gt;{$1} )</span>
<span class="cp">                      ? $fillings-&gt;{$1}</span>
<span class="cp">                      : &quot;&quot;</span>
<span class="cp">              }gsex;</span>
<span class="cp">    return $text;</span>
<span class="cp">}</span>
<span class="cp">#-----------------------------</span>
<span class="cp">#&lt;!-- simple.template for internal template() function --&gt;</span>
<span class="cp">#&lt;HTML&gt;&lt;HEAD&gt;&lt;TITLE&gt;Report for %%username%%&lt;/TITLE&gt;&lt;/HEAD&gt;</span>
<span class="cp">#&lt;BODY&gt;&lt;H1&gt;Report for %%username%%&lt;/H1&gt;</span>
<span class="cp">#%%username%% logged in %%count%% times, for a total of %%total%% minutes.</span>
<span class="cp">#-----------------------------</span>
<span class="cp">#&lt;!-- fancy.template for Text::Template --&gt;</span>
<span class="cp">#&lt;HTML&gt;&lt;HEAD&gt;&lt;TITLE&gt;Report for {$user}&lt;/TITLE&gt;&lt;/HEAD&gt;</span>
<span class="cp">#&lt;BODY&gt;&lt;H1&gt;Report for {$user}&lt;/H1&gt;</span>
<span class="cp">#{ lcfirst($user) } logged in {$count} times, for a total of </span>
<span class="cp">#{ int($total / 60) } minutes.</span>
<span class="cp">#-----------------------------</span>
<span class="cp">%fields = (</span>
<span class="cp">            username =&gt; $whats_his_name,</span>
<span class="cp">            count    =&gt; $login_count,</span>
<span class="cp">            total    =&gt; $minute_used,</span>
<span class="cp">);</span>

<span class="cp">print template(&quot;/home/httpd/templates/simple.template&quot;, \%fields);</span>
<span class="cp">#-----------------------------</span>
<span class="cp"># <font size="-1"><a href="http://pleac.sourceforge.net/include/perl/ch20/userrep</span>">download the following standalone program</a></font>
<span class="cp">#!/usr/bin/perl -w</span>
<span class="cp"># userrep1 - report duration of user logins using SQL database</span>

<span class="cp">use DBI;</span>
<span class="cp">use CGI qw(:standard);</span>

<span class="cp"># template() defined as in the Solution section above</span>
<span class="cp">$user = param(&quot;username&quot;)                   or die &quot;No username&quot;;</span>

<span class="cp">$dbh = DBI-&gt;connect(&quot;dbi:mysql:connections:mysql.domain.com:3306&quot;,</span>
<span class="cp">    &quot;connections&quot;, &quot;seekritpassword&quot;)       or die &quot;Couldn&#39;t connect\n&quot;;</span>
<span class="cp">$sth = $dbh-&gt;prepare(&lt;&lt;&quot;END_OF_SELECT&quot;)     or die &quot;Couldn&#39;t prepare SQL&quot;;</span>
<span class="cp">    SELECT COUNT(duration),SUM(duration) </span>
<span class="cp">    FROM logins WHERE username=&#39;$user&#39;</span>
<span class="cp">END_OF_SELECT</span>

<span class="cp"># this time the duration is assumed to be in seconds</span>
<span class="cp">if (@row = $sth-&gt;fetchrow()) {</span>
<span class="cp">    ($count, $seconds) = @row;</span>
<span class="cp">} else {</span>
<span class="cp">    ($count, $seconds) = (0,0);</span>
<span class="cp">} </span>

<span class="cp">$sth-&gt;finish();</span>
<span class="cp">$dbh-&gt;disconnect;</span>

<span class="cp">print header();</span>
<span class="cp">print template(&quot;report.tpl&quot;, {   </span>
<span class="cp">    &#39;username&#39; =&gt; $user,</span>
<span class="cp">    &#39;count&#39;    =&gt; $count,</span>
<span class="cp">    &#39;total&#39;    =&gt; $total </span>
<span class="cp">});</span>

<span class="cp">#-----------------------------</span>
<span class="cp">You owe: {$total}</span>
<span class="cp">#-----------------------------</span>
<span class="cp">The average was {$count ?  ($total/$count) : 0}.</span>
<span class="cp">#-----------------------------</span>
<span class="cp"># <font size="-1"><a href="http://pleac.sourceforge.net/include/perl/ch20/userrep2</span>">download the following standalone program</a></font>
<span class="cp">#!/usr/bin/perl -w</span>
<span class="cp"># userrep2 - report duration of user logins using SQL database</span>

<span class="cp">use Text::Template;</span>
<span class="cp">use DBI;</span>
<span class="cp">use CGI qw(:standard);</span>

<span class="cp">$tmpl = &quot;/home/httpd/templates/fancy.template&quot;;</span>
<span class="cp">$template = Text::Template-&gt;new(-type =&gt; &quot;file&quot;, -source =&gt; $tmpl);</span>
<span class="cp">$user = param(&quot;username&quot;)                   or die &quot;No username&quot;;</span>

<span class="cp">$dbh = DBI-&gt;connect(&quot;dbi:mysql:connections:mysql.domain.com:3306&quot;,</span>
<span class="cp">    &quot;connections&quot;, &quot;secret passwd&quot;)         or die &quot;Couldn&#39;t db connect\n&quot;;</span>
<span class="cp">$sth = $dbh-&gt;prepare(&lt;&lt;&quot;END_OF_SELECT&quot;)     or die &quot;Couldn&#39;t prepare SQL&quot;;</span>
<span class="cp">    SELECT COUNT(duration),SUM(duration) </span>
<span class="cp">    FROM logins WHERE username=&#39;$user&#39;</span>
<span class="cp">END_OF_SELECT</span>

<span class="cp">$sth-&gt;execute()                             or die &quot;Couldn&#39;t execute SQL&quot;;</span>

<span class="cp">if (@row = $sth-&gt;fetchrow()) {</span>
<span class="cp">    ($count, $total) = @row;</span>
<span class="cp">} else {</span>
<span class="cp">    $count = $total = 0;</span>
<span class="cp">}</span>

<span class="cp">$sth-&gt;finish();</span>
<span class="cp">$dbh-&gt;disconnect;</span>

<span class="cp">print header();</span>
<span class="cp">print $template-&gt;fill_in();</span>

<span class="cp">#-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1084"
>Mirroring Web Pages</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">#-----------------------------</span>
<span class="cp">use LWP::Simple;</span>
<span class="cp">mirror($URL, $local_filename);</span>
<span class="cp">#-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1087"
>Creating a Robot</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">#-----------------------------</span>
<span class="cp">use LWP::RobotUA;</span>
<span class="cp">$ua = LWP::RobotUA-&gt;new(&#39;websnuffler/0.1&#39;, &#39;me@wherever.com&#39;);</span>
<span class="cp">#-----------------------------</span>
<span class="cp">403 (Forbidden) Forbidden by robots.txt</span>
<span class="cp">#-----------------------------</span>
<span class="cp">#% GET http://www.webtechniques.com/robots.txt </span>
<span class="cp">#User-agent: *</span>
<span class="cp">#</span>
<span class="cp">#     Disallow: /stats</span>
<span class="cp">#</span>
<span class="cp">#     Disallow: /db</span>
<span class="cp">#</span>
<span class="cp">#     Disallow: /logs</span>
<span class="cp">#</span>
<span class="cp">#     Disallow: /store</span>
<span class="cp">#</span>
<span class="cp">#     Disallow: /forms</span>
<span class="cp">#</span>
<span class="cp">#     Disallow: /gifs</span>
<span class="cp">#</span>
<span class="cp">#     Disallow: /wais-src</span>
<span class="cp">#</span>
<span class="cp">#     Disallow: /scripts</span>
<span class="cp">#</span>
<span class="cp">#     Disallow: /config</span>
<span class="cp">#-----------------------------</span>
<span class="cp">#% GET http://www.cnn.com/robots.txt | head</span>
<span class="cp">## robots, scram</span>
<span class="cp">#</span>
<span class="cp">## $I d : robots.txt,v 1.2 1998/03/10 18:27:01 mreed Exp $</span>
<span class="cp">#</span>
<span class="cp">#User-agent: *</span>
<span class="cp">#</span>
<span class="cp">#Disallow: /</span>
<span class="cp">#</span>
<span class="cp">#User-agent:     Mozilla/3.01 (hotwired-test/0.1)</span>
<span class="cp">#</span>
<span class="cp">#Disallow:   /cgi-bin</span>
<span class="cp">#</span>
<span class="cp">#Disallow:   /TRANSCRIPTS</span>
<span class="cp">#</span>
<span class="cp">#Disallow:   /development</span>
<span class="cp">#-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1090"
>Parsing a Web Server Log File</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">#-----------------------------</span>
<span class="cp">while (&lt;LOGFILE&gt;) {</span>
<span class="cp">  my ($client, $identuser, $authuser, $date, $time, $tz, $method,</span>
<span class="cp">      $url, $protocol, $status, $bytes) =</span>
<span class="cp">      /^(\S+) (\S+) (\S+) \[([^:]+):(\d+:\d+:\d+) ([^\]]+) &quot;(\S+) (.*?) (\S+)&quot; (\S+) (\S+)$/ or next;</span>
<span class="cp">  # ...</span>
<span class="cp">}</span>
<span class="cp">#-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1093"
>Processing Server Logs</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">#-----------------------------</span>
<span class="cp"># <font size="-1"><a href="http://pleac.sourceforge.net/include/perl/ch20/sumwww</span>">download the following standalone program</a></font>
<span class="cp">#!/usr/bin/perl -w</span>
<span class="cp"># sumwww - summarize web server log activity</span>

<span class="cp">$lastdate = &quot;&quot;;</span>
<span class="cp">daily_logs();</span>
<span class="cp">summary();</span>
<span class="cp">exit;</span>

<span class="cp"># read CLF files and tally hits from the host and to the URL</span>
<span class="cp">sub daily_logs {</span>
<span class="cp">    while (&lt;&gt;) {</span>
<span class="cp">        ($type, $what) = /&quot;(GET|POST)\s+(\S+?) \S+&quot;/ or next;</span>
<span class="cp">        ($host, undef, undef, $datetime) = split;</span>
<span class="cp">        ($bytes) = /\s(\d+)\s*$/ or next;</span>
<span class="cp">        ($date)  = ($datetime =~ /\[([^:]*)/);</span>
<span class="cp">        $posts  += ($type eq POST);</span>
<span class="cp">        $home++ if m, / ,;</span>
<span class="cp">        if ($date ne $lastdate) {</span>
<span class="cp">            if ($lastdate) { write_report()     }</span>
<span class="cp">            else           { $lastdate = $date  }</span>
<span class="cp">        }</span>
<span class="cp">        $count++;</span>
<span class="cp">        $hosts{$host}++;</span>
<span class="cp">        $what{$what}++;</span>
<span class="cp">        $bytesum += $bytes;</span>
<span class="cp">    }</span>
<span class="cp">    write_report() if $count;</span>
<span class="cp">}</span>

<span class="cp"># use *typeglob aliasing of global variables for cheap copy</span>
<span class="cp">sub summary  {</span>
<span class="cp">    $lastdate = &quot;Grand Total&quot;;</span>
<span class="cp">    *count   = *sumcount;</span>
<span class="cp">    *bytesum = *bytesumsum;</span>
<span class="cp">    *hosts   = *allhosts;</span>
<span class="cp">    *posts   = *allposts;</span>
<span class="cp">    *what    = *allwhat;</span>
<span class="cp">    *home    = *allhome;</span>
<span class="cp">    write;</span>
<span class="cp">}</span>

<span class="cp"># display the tallies of hosts and URLs, using formats</span>
<span class="cp">sub write_report {</span>
<span class="cp">    write;</span>

<span class="cp">    # add to summary data</span>
<span class="cp">    $lastdate    = $date;</span>
<span class="cp">    $sumcount   += $count;</span>
<span class="cp">    $bytesumsum += $bytesum;</span>
<span class="cp">    $allposts   += $posts;</span>
<span class="cp">    $allhome    += $home;</span>

<span class="cp">    # reset daily data</span>
<span class="cp">    $posts = $count = $bytesum = $home = 0;</span>
<span class="cp">    @allwhat{keys %what}   = keys %what;</span>
<span class="cp">    @allhosts{keys %hosts} = keys %hosts;</span>
<span class="cp">    %hosts = %what = ();</span>
<span class="cp">}</span>

<span class="cp">format STDOUT_TOP =</span>
<span class="cp">@|||||||||| @|||||| @||||||| @||||||| @|||||| @|||||| @|||||||||||||</span>
<span class="cp">&quot;Date&quot;,     &quot;Hosts&quot;, &quot;Accesses&quot;, &quot;Unidocs&quot;, &quot;POST&quot;, &quot;Home&quot;, &quot;Bytes&quot;</span>
<span class="cp">----------- ------- -------- -------- ------- ------- --------------</span>
<span class="cp">.</span>

<span class="cp">format STDOUT =</span>
<span class="cp">@&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt; @&gt;&gt;&gt;&gt;&gt;&gt; @&gt;&gt;&gt;&gt;&gt;&gt;&gt; @&gt;&gt;&gt;&gt;&gt;&gt;&gt; @&gt;&gt;&gt;&gt;&gt;&gt; @&gt;&gt;&gt;&gt;&gt;&gt; @&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;</span>
<span class="cp">$lastdate,  scalar(keys %hosts), </span>
<span class="cp">            $count, scalar(keys %what), </span>
<span class="cp">                             $posts,  $home,  $bytesum</span>
<span class="cp">.</span>

<span class="cp">#-----------------------------</span>
<span class="cp">#     Date      Hosts  Accesses Unidocs   POST    Home       Bytes</span>
<span class="cp"># </span>
<span class="cp"># ----------- ------- -------- -------- ------- ------- --------------</span>
<span class="cp"># </span>
<span class="cp"># 19/May/1998     353     6447     3074     352      51       16058246</span>
<span class="cp"># </span>
<span class="cp"># 20/May/1998    1938    23868     4288     972     350       61879643</span>
<span class="cp"># </span>
<span class="cp"># 21/May/1998    1775    27872     6596    1064     376       64613798</span>
<span class="cp"># </span>
<span class="cp"># 22/May/1998    1680    21402     4467     735     285       52437374</span>
<span class="cp"># </span>
<span class="cp"># 23/May/1998    1128    21260     4944     592     186       55623059</span>
<span class="cp"># </span>
<span class="cp"># Grand Total    6050   100849    10090    3715    1248      250612120</span>
<span class="cp">#-----------------------------</span>
<span class="cp"># <font size="-1"><a href="http://pleac.sourceforge.net/include/perl/ch20/aprept</span>">download the following standalone program</a></font>
<span class="cp">#!/usr/bin/perl -w</span>
<span class="cp"># aprept - report on Apache logs</span>

<span class="cp">use Logfile::Apache;</span>

<span class="cp">$l = Logfile::Apache-&gt;new(</span>
<span class="cp">    File  =&gt; &quot;-&quot;,                   # STDIN</span>
<span class="cp">    Group =&gt; [ Domain, File ]);</span>

<span class="cp">$l-&gt;report(Group =&gt; Domain, Sort =&gt; Records);</span>
<span class="cp">$l-&gt;report(Group =&gt; File,   List =&gt; [Bytes,Records]);</span>

<span class="cp">#-----------------------------</span>
<span class="cp"># Domain                  Records </span>
<span class="cp"># </span>
<span class="cp"># ===============================</span>
<span class="cp"># </span>
<span class="cp"># US Commercial        222 38.47% </span>
<span class="cp"># </span>
<span class="cp"># US Educational       115 19.93% </span>
<span class="cp"># </span>
<span class="cp"># Network               93 16.12% </span>
<span class="cp"># </span>
<span class="cp"># Unresolved            54  9.36% </span>
<span class="cp"># </span>
<span class="cp"># Australia             48  8.32% </span>
<span class="cp"># </span>
<span class="cp"># Canada                20  3.47% </span>
<span class="cp"># </span>
<span class="cp"># Mexico                 8  1.39% </span>
<span class="cp"># </span>
<span class="cp"># United Kingdom         6  1.04% </span>
<span class="cp"># </span>
<span class="cp"># </span>
<span class="cp"># File                               Bytes          Records </span>
<span class="cp"># </span>
<span class="cp"># =========================================================</span>
<span class="cp"># </span>
<span class="cp"># /                           13008  0.89%         6  1.04% </span>
<span class="cp"># </span>
<span class="cp"># /cgi-bin/MxScreen           11870  0.81%         2  0.35% </span>
<span class="cp"># </span>
<span class="cp"># /cgi-bin/pickcards          39431  2.70%        48  8.32% </span>
<span class="cp"># </span>
<span class="cp"># /deckmaster                143793  9.83%        21  3.64% </span>
<span class="cp"># </span>
<span class="cp"># /deckmaster/admin           54447  3.72%         3  0.52% </span>
<span class="cp">#-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1096"
>Program: htmlsub</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">#-----------------------------</span>
<span class="cp">#&lt;HTML&gt;&lt;HEAD&gt;&lt;TITLE&gt;Hi!&lt;/TITLE&gt;&lt;/HEAD&gt;&lt;BODY&gt;</span>
<span class="cp">#&lt;H1&gt;Welcome to Scooby World!&lt;/H1&gt;</span>
<span class="cp">#I have &lt;A HREF=&quot;pictures.html&quot;&gt;pictures&lt;/A&gt; of the crazy dog</span>
<span class="cp">#himself.  Here&#39;s one!&lt;P&gt;</span>
<span class="cp">#&lt;IMG SRC=&quot;scooby.jpg&quot; ALT=&quot;Good doggy!&quot;&gt;&lt;P&gt;</span>
<span class="cp">#&lt;BLINK&gt;He&#39;s my hero!&lt;/BLINK&gt;  I would like to meet him some day,</span>
<span class="cp">#and get my picture taken with him.&lt;P&gt;</span>
<span class="cp">#P.S. I am deathly ill.  &lt;A HREF=&quot;shergold.html&quot;&gt;Please send</span>
<span class="cp">#cards&lt;/A&gt;.</span>
<span class="cp">#&lt;/BODY&gt;&lt;/HTML&gt;</span>
<span class="cp">#-----------------------------</span>
<span class="cp">#% htmlsub picture photo scooby.html</span>
<span class="cp">#&lt;HTML&gt;&lt;HEAD&gt;&lt;TITLE&gt;Hi!&lt;/TITLE&gt;&lt;/HEAD&gt;&lt;BODY&gt;</span>
<span class="cp">#</span>
<span class="cp">#&lt;H1&gt;Welcome to Scooby World!&lt;/H1&gt;</span>
<span class="cp">#</span>
<span class="cp">#I have &lt;A HREF=&quot;pictures.html&quot;&gt;photos&lt;/A&gt; of the crazy dog</span>
<span class="cp">#</span>
<span class="cp">#himself.  Here&#39;s one!&lt;P&gt;</span>
<span class="cp">#</span>
<span class="cp">#&lt;IMG SRC=&quot;scooby.jpg&quot; ALT=&quot;Good doggy!&quot;&gt;&lt;P&gt;</span>
<span class="cp">#</span>
<span class="cp">#&lt;BLINK&gt;He&#39;s my hero!&lt;/BLINK&gt;  I would like to meet him some day,</span>
<span class="cp">#</span>
<span class="cp">#and get my photo taken with him.&lt;P&gt;</span>
<span class="cp">#</span>
<span class="cp">#P.S. I am deathly ill.  &lt;A HREF=&quot;shergold.html&quot;&gt;Please send</span>
<span class="cp">#</span>
<span class="cp">#cards&lt;/A&gt;.</span>
<span class="cp">#</span>
<span class="cp">#&lt;/BODY&gt;&lt;/HTML&gt;</span>
<span class="cp">#-----------------------------</span>
<span class="cp"># <font size="-1"><a href="http://pleac.sourceforge.net/include/perl/ch20/htmlsub</span>">download the following standalone program</a></font>
<span class="cp">#!/usr/bin/perl -w</span>
<span class="cp"># htmlsub - make substitutions in normal text of HTML files</span>
<span class="cp"># from Gisle Aas &lt;gisle@aas.no&gt;</span>

<span class="cp">sub usage { die &quot;Usage: $0 &lt;from&gt; &lt;to&gt; &lt;file&gt;...\n&quot; }</span>

<span class="cp">my $from = shift or usage;</span>
<span class="cp">my $to   = shift or usage;</span>
<span class="cp">usage unless @ARGV;</span>

<span class="cp"># Build the HTML::Filter subclass to do the substituting.</span>

<span class="cp">package MyFilter;</span>
<span class="cp">require HTML::Filter;</span>
<span class="cp">@ISA=qw(HTML::Filter);</span>
<span class="cp">use HTML::Entities qw(decode_entities encode_entities);</span>

<span class="cp">sub text</span>
<span class="cp">{</span>
<span class="cp">   my $self = shift;</span>
<span class="cp">   my $text = decode_entities($_[0]);</span>
<span class="cp">   $text =~ s/\Q$from/$to/go;       # most important line</span>
<span class="cp">   $self-&gt;SUPER::text(encode_entities($text));</span>
<span class="cp">}</span>

<span class="cp"># Now use the class.</span>

<span class="cp">package main;</span>
<span class="cp">foreach (@ARGV) {</span>
<span class="cp">    MyFilter-&gt;new-&gt;parse_file($_);</span>
<span class="cp">}</span>

<span class="cp">#-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1099"
>Program: hrefsub</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">#-----------------------------</span>
<span class="cp">#% hrefsub shergold.html cards.html scooby.html</span>
<span class="cp">#&lt;HTML&gt;&lt;HEAD&gt;&lt;TITLE&gt;Hi!&lt;/TITLE&gt;&lt;/HEAD&gt;&lt;BODY&gt;</span>
<span class="cp">#</span>
<span class="cp">#&lt;H1&gt;Welcome to Scooby World!&lt;/H1&gt;</span>
<span class="cp">#</span>
<span class="cp">#I have &lt;A HREF=&quot;pictures.html&quot;&gt;pictures&lt;/A&gt; of the crazy dog</span>
<span class="cp">#</span>
<span class="cp">#himself.  Here&#39;s one!&lt;P&gt;</span>
<span class="cp">#</span>
<span class="cp">#&lt;IMG SRC=&quot;scooby.jpg&quot; ALT=&quot;Good doggy!&quot;&gt;&lt;P&gt;</span>
<span class="cp">#</span>
<span class="cp">#&lt;BLINK&gt;He&#39;s my hero!&lt;/BLINK&gt;  I would like to meet him some day,</span>
<span class="cp">#</span>
<span class="cp">#and get my picture taken with him.&lt;P&gt;</span>
<span class="cp">#</span>
<span class="cp">#P.S. I am deathly ill.  &lt;a href=&quot;cards.html&quot;&gt;Please send</span>
<span class="cp">#</span>
<span class="cp">#cards&lt;/A&gt;.</span>
<span class="cp">#</span>
<span class="cp">#&lt;/BODY&gt;&lt;/HTML&gt;</span>
<span class="cp">#-----------------------------</span>
<span class="cp"># <font size="-1"><a href="http://pleac.sourceforge.net/include/perl/ch20/hrefsub</span>">download the following standalone program</a></font>
<span class="cp">#!/usr/bin/perl -w</span>
<span class="cp"># hrefsub - make substitutions in &lt;A HREF=&quot;...&quot;&gt; fields of HTML files</span>
<span class="cp"># from Gisle Aas &lt;gisle@aas.no&gt;</span>

<span class="cp">sub usage { die &quot;Usage: $0 &lt;from&gt; &lt;to&gt; &lt;file&gt;...\n&quot; }</span>

<span class="cp">my $from = shift or usage;</span>
<span class="cp">my $to   = shift or usage;</span>
<span class="cp">usage unless @ARGV;</span>

<span class="cp"># The HTML::Filter subclass to do the substitution.</span>

<span class="cp">package MyFilter;</span>
<span class="cp">require HTML::Filter;</span>
<span class="cp">@ISA=qw(HTML::Filter);</span>
<span class="cp">use HTML::Entities qw(encode_entities);</span>

<span class="cp">sub start {</span>
<span class="cp">   my($self, $tag, $attr, $attrseq, $orig) = @_;</span>
<span class="cp">   if ($tag eq &#39;a&#39; &amp;&amp; exists $attr-&gt;{href}) {</span>
<span class="cp">           if ($attr-&gt;{href} =~ s/\Q$from/$to/g) {</span>
<span class="cp">               # must reconstruct the start tag based on $tag and $attr.</span>
<span class="cp">               # wish we instead were told the extent of the &#39;href&#39; value</span>
<span class="cp">               # in $orig.</span>
<span class="cp">               my $tmp = &quot;&lt;$tag&quot;;</span>
<span class="cp">               for (@$attrseq) {</span>
<span class="cp">                   my $encoded = encode_entities($attr-&gt;{$_});</span>
<span class="cp">                   $tmp .= qq( $_=&quot;$encoded &quot;);</span>
<span class="cp">               }</span>
<span class="cp">               $tmp .= &quot;&gt;&quot;;</span>
<span class="cp">               $self-&gt;output($tmp);</span>
<span class="cp">               return;</span>
<span class="cp">           }</span>
<span class="cp">   }</span>
<span class="cp">   $self-&gt;output($orig);</span>
<span class="cp">}</span>

<span class="cp"># Now use the class.</span>

<span class="cp">package main;</span>
<span class="cp">foreach (@ARGV) {</span>
<span class="cp">        MyFilter-&gt;new-&gt;parse_file($_);</span>
<span class="cp">}</span>

<span class="cp">#-----------------------------</span>
</pre></div>
</body>
</html></PRE
></TD
></TR
></TABLE
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="cgiprogramming.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="a1102.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>CGI Programming</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
>&nbsp;</TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Helpers</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>
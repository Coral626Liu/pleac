<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN""http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>CGI Programming</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="PLEAC-Perl"
HREF="index.html"><LINK
REL="PREVIOUS"
TITLE="Internet Services"
HREF="internetservices.html"><LINK
REL="NEXT"
TITLE="Web Automation"
HREF="webautomation.html"><style type="text/css">td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
pre { line-height: 125%; }

  </style></head
><BODY TEXT="#cecece" BGCOLOR="#4f6f6f" LINK="#f5deb3" VLINK="#d5ae83"
CLASS="SECT1"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>PLEAC-Perl</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="internetservices.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
></TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="webautomation.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="CGIPROGRAMMING"
>19. CGI Programming</A
></H1
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1007"
>Introduction</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">#-----------------------------</span>
<span class="cp"># http://www.perl.com/CPAN/</span>
<span class="cp"># http://www.perl.com:8001/bad/mojo.html</span>
<span class="cp"># ftp://gatekeeper.dec.com/pub/misc/netlib.tar.Z</span>
<span class="cp"># ftp://anonymous@myplace:gatekeeper.dec.com/pub/misc/netlib.tar.Z</span>
<span class="cp"># file:///etc/motd</span>
<span class="cp">#-----------------------------</span>
<span class="cp"># http://mox.perl.com/cgi-bin/program?name=Johann&amp;born=1685</span>
<span class="cp">#-----------------------------</span>
<span class="cp"># http://mox.perl.com/cgi-bin/program</span>
<span class="cp">#-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1010"
>Writing a CGI Script</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">#-----------------------------</span>
<span class="cp"># <font size="-1"><a href="http://pleac.sourceforge.net/include/perl/ch19/hiweb</span>">download the following standalone program</a></font>
<span class="cp">#!/usr/bin/perl -w</span>
<span class="cp"># hiweb - load CGI module to decode information given by web server</span>
<span class="cp">use strict;</span>

<span class="cp">use CGI qw(:standard escapeHTML);</span>

<span class="cp"># get a parameter from a form</span>
<span class="cp">my $value = param(&#39;PARAM_NAME&#39;);</span>

<span class="cp"># output a document</span>
<span class="cp">print header(), start_html(&quot;Howdy there!&quot;),</span>
<span class="cp">      p(&quot;You typed: &quot;, tt(escapeHTML($value))),</span>
<span class="cp">      end_html();</span>

<span class="cp">#-----------------------------</span>
<span class="cp">use CGI qw(:standard);</span>
<span class="cp">$who   = param(&quot;Name&quot;);</span>
<span class="cp">$phone = param(&quot;Number&quot;);</span>
<span class="cp">@picks = param(&quot;Choices&quot;);</span>
<span class="cp">#-----------------------------</span>
<span class="cp">print header( -TYPE    =&gt; &#39;text/plain&#39;,</span>
<span class="cp">              -EXPIRES =&gt; &#39;+3d&#39; );</span>
<span class="cp">#-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1013"
>Redirecting Error Messages</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">#-----------------------------</span>
<span class="cp">use CGI::Carp;</span>
<span class="cp">warn &quot;This is a complaint&quot;;</span>
<span class="cp">die &quot;But this one is serious&quot;;</span>
<span class="cp">#-----------------------------</span>
<span class="cp">BEGIN {</span>
<span class="cp">    use CGI::Carp qw(carpout);</span>
<span class="cp">    open(LOG, &quot;&gt;&gt;/var/local/cgi-logs/mycgi-log&quot;)</span>
<span class="cp">        or die &quot;Unable to append to mycgi-log: $!\n&quot;;</span>
<span class="cp">    carpout(*LOG);</span>
<span class="cp">}</span>
<span class="cp">#-----------------------------</span>
<span class="cp">use CGI::Carp qw(fatalsToBrowser);</span>
<span class="cp">die &quot;Bad error here&quot;;</span>
<span class="cp">#-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1016"
>Fixing a 500 Server Error</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">#-----------------------------</span>
<span class="cp"># <font size="-1"><a href="http://pleac.sourceforge.net/include/perl/ch19/webwhoami</span>">download the following standalone program</a></font>
<span class="cp">#!/usr/bin/perl</span>
<span class="cp"># webwhoami - show web users id</span>
<span class="cp">print &quot;Content-Type: text/plain\n\n&quot;;</span>
<span class="cp">print &quot;Running as &quot;, scalar getpwuid($&gt;), &quot;\n&quot;;</span>

<span class="cp">#-----------------------------</span>
<span class="cp">#% perl -wc cgi-script        # just compilation</span>
<span class="cp">#</span>
<span class="cp">#% perl -w  cgi-script        # parms from stdin</span>
<span class="cp">#(offline mode: enter name=value pairs on standard input)</span>
<span class="cp">#</span>
<span class="cp">#name=joe</span>
<span class="cp">#</span>
<span class="cp">#number=10</span>
<span class="cp">#</span>
<span class="cp">#^D</span>
<span class="cp">#</span>
<span class="cp">#</span>
<span class="cp">#% perl -w  cgi-script name=joe number=10    # run with mock form input</span>
<span class="cp">#% perl -d  cgi-script name=joe number=10    # ditto, under the debugger</span>
<span class="cp">#</span>
<span class="cp">## POST method script in csh</span>
<span class="cp">#% (setenv HTTP_METHOD POST; perl -w cgi-script name=joe number=10)</span>
<span class="cp">## POST method script in sh</span>
<span class="cp">#% HTTP_METHOD=POST perl -w cgi-script name=joe number=10</span>
<span class="cp">#-----------------------------</span>
<span class="cp">#% perl -MCGI -le &#39;print CGI-&gt;VERSION&#39;</span>
<span class="cp">#2.49</span>
<span class="cp">#-----------------------------</span>
<span class="cp">$| = 1;</span>
<span class="cp">#-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1019"
>Writing a Safe CGI Program</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">#-----------------------------</span>
<span class="cp">#!/usr/bin/perl -T</span>
<span class="cp">open(FH, &quot;&gt; $ARGV[0]&quot;) or die;</span>
<span class="cp">#-----------------------------</span>
<span class="cp"># Insecure dependency in open while running with -T switch at ...</span>
<span class="cp">#-----------------------------</span>
<span class="cp">$file = $ARGV[0];                                   # $file tainted</span>
<span class="cp">unless ($file =~ m#^([\w.-]+)$#) {                  # $1 is untainted</span>
<span class="cp">    die &quot;filename &#39;$file&#39; has invalid characters.\n&quot;;</span>
<span class="cp">}</span>
<span class="cp">$file = $1;                                         # $file untainted</span>
<span class="cp">#-----------------------------</span>
<span class="cp">unless (-e $filename) {                     # WRONG!</span>
<span class="cp">    open(FH, &quot;&gt; $filename&quot;);</span>
<span class="cp">    # ...</span>
<span class="cp">}</span>
<span class="cp">#-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1022"
>Making CGI Scripts Efficient</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">#-----------------------------</span>
<span class="cp">#Alias /perl/ /real/path/to/perl/scripts/</span>
<span class="cp">#</span>
<span class="cp">#&lt;Location /perl&gt;</span>
<span class="cp">#SetHandler  perl-script</span>
<span class="cp">#PerlHandler Apache::Registry</span>
<span class="cp">#Options ExecCGI</span>
<span class="cp">#&lt;/Location&gt;</span>
<span class="cp">#</span>
<span class="cp">#PerlModule Apache::Registry</span>
<span class="cp">#PerlModule CGI</span>
<span class="cp">#PerlSendHeader On</span>
<span class="cp">#-----------------------------</span>
<span class="cp">#&lt;Files *.perl&gt;</span>
<span class="cp">#SetHandler  perl-script</span>
<span class="cp">#PerlHandler Apache::Registry</span>
<span class="cp">#Options ExecCGI</span>
<span class="cp">#&lt;/Files&gt;</span>
<span class="cp">#-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1025"
>Executing Commands Without Shell Escapes</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">#-----------------------------</span>
<span class="cp">system(&quot;command $input @files&quot;);            # UNSAFE</span>
<span class="cp">#-----------------------------</span>
<span class="cp">system(&quot;command&quot;, $input, @files);          # safer</span>
<span class="cp">#-----------------------------</span>
<span class="cp">chomp($now = `date`);</span>
<span class="cp">#-----------------------------</span>
<span class="cp">@output = `grep $input @files`;</span>
<span class="cp">#-----------------------------</span>
<span class="cp">die &quot;cannot fork: $!&quot; unless defined ($pid = open(SAFE_KID, &quot;|-&quot;));</span>
<span class="cp">if ($pid == 0) {</span>
<span class="cp">    exec(&#39;grep&#39;, $input, @files) or die &quot;can&#39;t exec grep: $!&quot;;</span>
<span class="cp">} else {</span>
<span class="cp">    @output = &lt;SAFE_KID&gt;;</span>
<span class="cp">    close SAFE_KID;                 # $? contains status</span>
<span class="cp">}</span>
<span class="cp">#-----------------------------</span>
<span class="cp">open(KID_TO_READ, &quot;$program @options @args |&quot;);    # UNSAFE</span>
<span class="cp">#-----------------------------</span>
<span class="cp"># add error processing as above</span>
<span class="cp">die &quot;cannot fork: $!&quot; unless defined($pid = open(KID_TO_READ, &quot;-|&quot;));</span>

<span class="cp">if ($pid) {   # parent</span>
<span class="cp">   while (&lt;KID_TO_READ&gt;) {</span>
<span class="cp">       # do something interesting</span>
<span class="cp">   }</span>
<span class="cp">   close(KID_TO_READ)               or warn &quot;kid exited $?&quot;;</span>

<span class="cp">} else {      # child</span>
<span class="cp">   # reconfigure, then</span>
<span class="cp">   exec($program, @options, @args)  or die &quot;can&#39;t exec program: $!&quot;;</span>
<span class="cp">}</span>
<span class="cp">#-----------------------------</span>
<span class="cp">open(KID_TO_WRITE, &quot;|$program $options @args&quot;);   # UNSAFE</span>
<span class="cp">#-----------------------------</span>
<span class="cp">$pid = open(KID_TO_WRITE, &quot;|-&quot;);</span>
<span class="cp">die &quot;cannot fork: $!&quot; unless defined($pid = open(KID_TO_WRITE, &quot;|-&quot;));</span>
<span class="cp">$SIG{ALRM} = sub { die &quot;whoops, $program pipe broke&quot; };</span>

<span class="cp">if ($pid) {  # parent</span>
<span class="cp">   for (@data) { print KID_TO_WRITE $_ }</span>
<span class="cp">   close(KID_TO_WRITE)              or warn &quot;kid exited $?&quot;;</span>

<span class="cp">} else {     # child</span>
<span class="cp">   # reconfigure, then</span>
<span class="cp">   exec($program, @options, @args)  or die &quot;can&#39;t exec program: $!&quot;;</span>
<span class="cp">}</span>
<span class="cp">#-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1028"
>Formatting Lists and Tables with HTML Shortcuts</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">#-----------------------------</span>
<span class="cp">print ol( li([ qw(red blue green)]) );</span>
<span class="cp"># &lt;OL&gt;&lt;LI&gt;red&lt;/LI&gt; &lt;LI&gt;blue&lt;/LI&gt; &lt;LI&gt;green&lt;/LI&gt;&lt;/OL&gt;</span>

<span class="cp">@names = qw(Larry Moe Curly);</span>
<span class="cp">print ul( li({ -TYPE =&gt; &quot;disc&quot; }, \@names) );</span>
<span class="cp"># &lt;UL&gt;&lt;LI TYPE=&quot;disc&quot;&gt;Larry&lt;/LI&gt; &lt;LI TYPE=&quot;disc&quot;&gt;Moe&lt;/LI&gt;</span>
<span class="cp">#</span>
<span class="cp">#     &lt;LI TYPE=&quot;disc&quot;&gt;Curly&lt;/LI&gt;&lt;/UL&gt;</span>
<span class="cp">#-----------------------------</span>
<span class="cp">print li(&quot;alpha&quot;);</span>
<span class="cp">#     &lt;LI&gt;alpha&lt;/LI&gt;</span>

<span class="cp">print li( [ &quot;alpha&quot;, &quot;omega&quot;] );</span>
<span class="cp">#     &lt;LI&gt;alpha&lt;/LI&gt; &lt;LI&gt;omega&lt;/LI&gt;</span>
<span class="cp">#-----------------------------</span>
<span class="cp">use CGI qw(:standard :html3);</span>

<span class="cp">%hash = (</span>
<span class="cp">    &quot;Wisconsin&quot;  =&gt; [ &quot;Superior&quot;, &quot;Lake Geneva&quot;, &quot;Madison&quot; ],</span>
<span class="cp">    &quot;Colorado&quot;   =&gt; [ &quot;Denver&quot;, &quot;Fort Collins&quot;, &quot;Boulder&quot; ],</span>
<span class="cp">    &quot;Texas&quot;      =&gt; [ &quot;Plano&quot;, &quot;Austin&quot;, &quot;Fort Stockton&quot; ],</span>
<span class="cp">    &quot;California&quot; =&gt; [ &quot;Sebastopol&quot;, &quot;Santa Rosa&quot;, &quot;Berkeley&quot; ],</span>
<span class="cp">);</span>

<span class="cp">$\ = &quot;\n&quot;;</span>

<span class="cp">print &quot;&lt;TABLE&gt; &lt;CAPTION&gt;Cities I Have Known&lt;/CAPTION&gt;&quot;;</span>
<span class="cp">print Tr(th [qw(State Cities)]);</span>
<span class="cp">for $k (sort keys %hash) {</span>
<span class="cp">    print Tr(th($k), td( [ sort @{$hash{$k}} ] ));</span>
<span class="cp">}</span>
<span class="cp">print &quot;&lt;/TABLE&gt;&quot;;</span>
<span class="cp">#-----------------------------</span>
<span class="cp"># &lt;TABLE&gt; &lt;CAPTION&gt;Cities I Have Known&lt;/CAPTION&gt;</span>
<span class="cp"># </span>
<span class="cp">#     &lt;TR&gt;&lt;TH&gt;State&lt;/TH&gt; &lt;TH&gt;Cities&lt;/TH&gt;&lt;/TR&gt;</span>
<span class="cp"># </span>
<span class="cp">#     &lt;TR&gt;&lt;TH&gt;California&lt;/TH&gt; &lt;TD&gt;Berkeley&lt;/TD&gt; &lt;TD&gt;Santa Rosa&lt;/TD&gt; </span>
<span class="cp"># </span>
<span class="cp"># 	  &lt;TD&gt;Sebastopol&lt;/TD&gt; &lt;/TR&gt;</span>
<span class="cp"># </span>
<span class="cp">#     &lt;TR&gt;&lt;TH&gt;Colorado&lt;/TH&gt; &lt;TD&gt;Boulder&lt;/TD&gt; &lt;TD&gt;Denver&lt;/TD&gt; </span>
<span class="cp"># </span>
<span class="cp"># 	  &lt;TD&gt;Fort Collins&lt;/TD&gt; &lt;/TR&gt;</span>
<span class="cp"># </span>
<span class="cp">#     &lt;TR&gt;&lt;TH&gt;Texas&lt;/TH&gt; &lt;TD&gt;Austin&lt;/TD&gt; &lt;TD&gt;Fort Stockton&lt;/TD&gt; </span>
<span class="cp"># </span>
<span class="cp"># 	  &lt;TD&gt;Plano&lt;/TD&gt;&lt;/TR&gt;</span>
<span class="cp"># </span>
<span class="cp">#     &lt;TR&gt;&lt;TH&gt;Wisconsin&lt;/TH&gt; &lt;TD&gt;Lake Geneva&lt;/TD&gt; &lt;TD&gt;Madison&lt;/TD&gt; </span>
<span class="cp"># </span>
<span class="cp"># 	  &lt;TD&gt;Superior&lt;/TD&gt;&lt;/TR&gt;</span>
<span class="cp"># </span>
<span class="cp"># &lt;/TABLE&gt;</span>
<span class="cp">#-----------------------------</span>
<span class="cp">print table</span>
<span class="cp">        caption(&#39;Cities I have Known&#39;),</span>
<span class="cp">        Tr(th [qw(State Cities)]),</span>
<span class="cp">        map { Tr(th($_), td( [ sort @{$hash{$_}} ] )) } sort keys %hash;</span>
<span class="cp">#-----------------------------</span>
<span class="cp"># <font size="-1"><a href="http://pleac.sourceforge.net/include/perl/ch19/salcheck</span>">download the following standalone program</a></font>
<span class="cp">#!/usr/bin/perl</span>
<span class="cp"># salcheck - check for salaries</span>
<span class="cp">use DBI;</span>
<span class="cp">use CGI qw(:standard :html3);</span>

<span class="cp">$limit = param(&quot;LIMIT&quot;);</span>

<span class="cp">print header(), start_html(&quot;Salary Query&quot;),</span>
<span class="cp">      h1(&quot;Search&quot;),</span>
<span class="cp">      start_form(),</span>
<span class="cp">      p(&quot;Enter minimum salary&quot;, textfield(&quot;LIMIT&quot;)),</span>
<span class="cp">      submit(),</span>
<span class="cp">      end_form();</span>

<span class="cp">if (defined $limit) {</span>
<span class="cp">    $dbh = DBI-&gt;connect(&quot;dbi:mysql:somedb:server.host.dom:3306&quot;, </span>
<span class="cp">        &quot;username&quot;, &quot;password&quot;) </span>
<span class="cp">        or die &quot;Connecting: $DBI::errstr&quot;;</span>
<span class="cp">    $sth = $dbh-&gt;prepare(&quot;SELECT name,salary FROM employees </span>
<span class="cp">        WHERE salary &gt; $limit&quot;)</span>
<span class="cp">        or die &quot;Preparing: &quot;, $dbh-&gt;errstr;</span>
<span class="cp">    $sth-&gt;execute</span>
<span class="cp">        or die &quot;Executing: &quot;, $sth-&gt;errstr;</span>

<span class="cp">    print h1(&quot;Results&quot;), &quot;&lt;TABLE BORDER=1&gt;&quot;;</span>

<span class="cp">    while (@row = $sth-&gt;fetchrow()) {</span>
<span class="cp">           print Tr( td( \@row ) );</span>
<span class="cp">    }</span>

<span class="cp">    print &quot;&lt;/TABLE&gt;\n&quot;;</span>
<span class="cp">    $sth-&gt;finish;</span>
<span class="cp">    $dbh-&gt;disconnect;</span>
<span class="cp">}</span>

<span class="cp">print end_html();</span>

<span class="cp">#-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1031"
>Redirecting to a Different Location</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">#-----------------------------</span>
<span class="cp">$url = &quot;http://www.perl.com/CPAN/&quot;;</span>
<span class="cp">print &quot;Location: $url\n\n&quot;;</span>
<span class="cp">exit;</span>
<span class="cp">#-----------------------------</span>
<span class="cp"># <font size="-1"><a href="http://pleac.sourceforge.net/include/perl/ch19/oreobounce</span>">download the following standalone program</a></font>
<span class="cp">#!/usr/bin/perl -w</span>
<span class="cp"># oreobounce - set a cookie and redirect the browser</span>
<span class="cp">use CGI qw(:cgi);</span>

<span class="cp">$oreo = cookie( -NAME    =&gt; &#39;filling&#39;,</span>
<span class="cp">                -VALUE   =&gt; &quot;vanilla crème&quot;,</span>
<span class="cp">                -EXPIRES =&gt; &#39;+3M&#39;,    # M for month, m for minute</span>
<span class="cp">                -DOMAIN  =&gt; &#39;.perl.com&#39;);</span>

<span class="cp">$whither  = &quot;http://somewhere.perl.com/nonesuch.html&quot;;</span>

<span class="cp">print redirect( -URL     =&gt; $whither,</span>
<span class="cp">                -COOKIE  =&gt; $oreo);</span>

<span class="cp">#-----------------------------</span>
<span class="cp">#Status: 302 Moved Temporarily</span>
<span class="cp">#</span>
<span class="cp">#Set-Cookie: filling=vanilla%20cr%E4me; domain=.perl.com; </span>
<span class="cp">#</span>
<span class="cp">#    expires=Tue, 21-Jul-1998 11:58:55 GMT</span>
<span class="cp">#</span>
<span class="cp">#Date: Tue, 21 Apr 1998 11:55:55 GMT</span>
<span class="cp">#</span>
<span class="cp">#Location: http://somewhere.perl.com/nonesuch.html</span>
<span class="cp">#</span>
<span class="cp">#Content-Type: text/html</span>
<span class="cp">#</span>
<span class="cp">#B&lt;&lt;blank line here&gt;&gt;</span>
<span class="cp">#-----------------------------</span>
<span class="cp"># <font size="-1"><a href="http://pleac.sourceforge.net/include/perl/ch19/os_snipe</span>">download the following standalone program</a></font>
<span class="cp">#!/usr/bin/perl</span>
<span class="cp"># os_snipe - redirect to a Jargon File entry about current OS</span>
<span class="cp">$dir = &#39;http://www.wins.uva.nl/%7Emes/jargon&#39;;</span>
<span class="cp">for ($ENV{HTTP_USER_AGENT}) {</span>
<span class="cp">    $page  =    /Mac/            &amp;&amp; &#39;m/Macintrash.html&#39;</span>
<span class="cp">             || /Win(dows )?NT/  &amp;&amp; &#39;e/evilandrude.html&#39;</span>
<span class="cp">             || /Win|MSIE|WebTV/ &amp;&amp; &#39;m/MicroslothWindows.html&#39;</span>
<span class="cp">             || /Linux/          &amp;&amp; &#39;l/Linux.html&#39;</span>
<span class="cp">             || /HP-UX/          &amp;&amp; &#39;h/HP-SUX.html&#39;</span>
<span class="cp">             || /SunOS/          &amp;&amp; &#39;s/ScumOS.html&#39;</span>
<span class="cp">             ||                     &#39;a/AppendixB.html&#39;;</span>
<span class="cp">}</span>
<span class="cp">print &quot;Location: $dir/$page\n\n&quot;;</span>

<span class="cp">#-----------------------------</span>
<span class="cp">use CGI qw(:standard);</span>
<span class="cp">print header( -STATUS =&gt; &#39;204 No response&#39; );</span>
<span class="cp">#-----------------------------</span>
<span class="cp">#Status: 204 No response</span>
<span class="cp">#</span>
<span class="cp">#Content-Type: text/html</span>
<span class="cp">#</span>
<span class="cp">#&lt;blank line here&gt;</span>
<span class="cp">#-----------------------------</span>
<span class="cp">#!/bin/sh</span>

<span class="cp">cat &lt;&lt;EOCAT</span>
<span class="cp">Status: 204 No response</span>
<span class="cp"> </span>
<span class="cp">EOCAT</span>
<span class="cp">#-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1034"
>Debugging the Raw HTTP Exchange</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">#-----------------------------</span>
<span class="cp"># <font size="-1"><a href="http://pleac.sourceforge.net/include/perl/ch19/dummyhttpd</span>">download the following standalone program</a></font>
<span class="cp">#!/usr/bin/perl -w</span>
<span class="cp"># dummyhttpd - start an HTTP daemon and print what the client sends</span>

<span class="cp">use strict;</span>
<span class="cp">use HTTP::Daemon;  # need LWP-5.32 or better</span>

<span class="cp">my $server = HTTP::Daemon-&gt;new(Timeout =&gt; 60);</span>
<span class="cp">print &quot;Please contact me at: &lt;URL:&quot;, $server-&gt;url, &quot;&gt;\n&quot;;</span>

<span class="cp">while (my $client = $server-&gt;accept) {</span>
<span class="cp">  CONNECTION:</span>
<span class="cp">    while (my $answer = $client-&gt;get_request) {</span>
<span class="cp">        print $answer-&gt;as_string;</span>
<span class="cp">        $client-&gt;autoflush;</span>
<span class="cp">      RESPONSE:</span>
<span class="cp">        while (&lt;STDIN&gt;) {</span>
<span class="cp">            last RESPONSE   if $_ eq &quot;.\n&quot;;</span>
<span class="cp">            last CONNECTION if $_ eq &quot;..\n&quot;;</span>
<span class="cp">            print $client $_;</span>
<span class="cp">        }</span>
<span class="cp">        print &quot;\nEOF\n&quot;;</span>
<span class="cp">    }</span>
<span class="cp">    print &quot;CLOSE: &quot;, $client-&gt;reason, &quot;\n&quot;;</span>
<span class="cp">    $client-&gt;close;</span>
<span class="cp">    undef $client;</span>
<span class="cp">}</span>

<span class="cp">#-----------------------------</span>
<span class="cp">#http://somewhere.com/cgi-bin/whatever</span>
<span class="cp">#-----------------------------</span>
<span class="cp">#http://somewhere.com:8989/cgi-bin/whatever</span>
<span class="cp">#-----------------------------</span>
<span class="cp">#% telnet www.perl.com 80</span>
<span class="cp">#GET /bogotic HTTP/1.0</span>
<span class="cp">#</span>
<span class="cp">#&lt;blank line here&gt;</span>
<span class="cp">#</span>
<span class="cp">#HTTP/1.1 404 File Not Found</span>
<span class="cp">#</span>
<span class="cp">#Date: Tue, 21 Apr 1998 11:25:43 GMT</span>
<span class="cp">#</span>
<span class="cp">#Server: Apache/1.2.4</span>
<span class="cp">#</span>
<span class="cp">#Connection: close</span>
<span class="cp">#</span>
<span class="cp">#Content-Type: text/html</span>
<span class="cp">#</span>
<span class="cp">#</span>
<span class="cp">#&lt;HTML&gt;&lt;HEAD&gt;</span>
<span class="cp">#</span>
<span class="cp">#&lt;TITLE&gt;404 File Not Found&lt;/TITLE&gt;</span>
<span class="cp">#</span>
<span class="cp">#&lt;/HEAD&gt;&lt;BODY&gt;</span>
<span class="cp">#</span>
<span class="cp">#&lt;H1&gt;File Not Found&lt;/H1&gt;</span>
<span class="cp">#</span>
<span class="cp">#The requested URL /bogotic was not found on this server.&lt;P&gt;</span>
<span class="cp">#</span>
<span class="cp">#&lt;/BODY&gt;&lt;/HTML&gt;</span>
<span class="cp">#-----------------------------</span>
<span class="cp">% GET -esuSU http://mox.perl.com/perl/bogotic</span>
<span class="cp"># GET http://language.perl.com/bogotic</span>
<span class="cp"># </span>
<span class="cp"># Host: mox.perl.com</span>
<span class="cp"># </span>
<span class="cp"># User-Agent: lwp-request/1.32</span>
<span class="cp"># </span>
<span class="cp"># </span>
<span class="cp"># GET http://mox.perl.com/perl/bogotic --&gt; 302 Moved Temporarily</span>
<span class="cp"># </span>
<span class="cp"># GET http://www.perl.com/perl/bogotic --&gt; 302 Moved Temporarily</span>
<span class="cp"># </span>
<span class="cp"># GET http://language.perl.com/bogotic --&gt; 404 File Not Found</span>
<span class="cp"># </span>
<span class="cp"># Connection: close</span>
<span class="cp"># </span>
<span class="cp"># Date: Tue, 21 Apr 1998 11:29:03 GMT</span>
<span class="cp"># </span>
<span class="cp"># Server: Apache/1.2.4</span>
<span class="cp"># </span>
<span class="cp"># Content-Type: text/html</span>
<span class="cp"># </span>
<span class="cp"># Client-Date: Tue, 21 Apr 1998 12:29:01 GMT</span>
<span class="cp"># </span>
<span class="cp"># Client-Peer: 208.201.239.47:80</span>
<span class="cp"># </span>
<span class="cp"># Title: Broken perl.com Links</span>
<span class="cp"># </span>
<span class="cp"># </span>
<span class="cp"># &lt;HTML&gt;</span>
<span class="cp"># </span>
<span class="cp"># &lt;HEAD&gt;&lt;TITLE&gt;An Error Occurred&lt;/TITLE&gt;&lt;/HEAD&gt;</span>
<span class="cp"># </span>
<span class="cp"># &lt;BODY&gt;</span>
<span class="cp"># </span>
<span class="cp"># &lt;H1&gt;An Error Occurred&lt;/h1&gt;</span>
<span class="cp"># </span>
<span class="cp"># 404 File Not Found</span>
<span class="cp"># </span>
<span class="cp"># &lt;/BODY&gt;</span>
<span class="cp"># </span>
<span class="cp"># &lt;/HTML&gt;</span>
<span class="cp">#-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1037"
>Managing Cookies</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">#-----------------------------</span>
<span class="cp">$preference_value = cookie(&quot;preference name&quot;);</span>
<span class="cp">#-----------------------------</span>
<span class="cp">$packed_cookie = cookie( -NAME    =&gt; &quot;preference name&quot;,</span>
<span class="cp">                         -VALUE   =&gt; &quot;whatever you&#39;d like&quot;,</span>
<span class="cp">                         -EXPIRES =&gt; &quot;+2y&quot;);</span>
<span class="cp">#-----------------------------</span>
<span class="cp">print header(-COOKIE =&gt; $packed_cookie);</span>
<span class="cp">#-----------------------------</span>
<span class="cp"># <font size="-1"><a href="http://pleac.sourceforge.net/include/perl/ch19/ic_cookies</span>">download the following standalone program</a></font>
<span class="cp">#!/usr/bin/perl -w</span>
<span class="cp"># ic_cookies - sample CGI script that uses a cookie</span>
<span class="cp">use CGI qw(:standard);</span>

<span class="cp">use strict;</span>

<span class="cp">my $cookname = &quot;favorite ice cream&quot;;</span>
<span class="cp">my $favorite = param(&quot;flavor&quot;);</span>
<span class="cp">my $tasty    = cookie($cookname) || &#39;mint&#39;;</span>

<span class="cp">unless ($favorite) {</span>
<span class="cp">    print header(), start_html(&quot;Ice Cookies&quot;), h1(&quot;Hello Ice Cream&quot;),</span>
<span class="cp">          hr(), start_form(),</span>
<span class="cp">            p(&quot;Please select a flavor: &quot;, textfield(&quot;flavor&quot;,$tasty)),</span>
<span class="cp">              end_form(), hr();</span>
<span class="cp">    exit;</span>
<span class="cp">}</span>

<span class="cp">my $cookie = cookie(</span>
<span class="cp">                -NAME    =&gt; $cookname,</span>
<span class="cp">                -VALUE   =&gt; $favorite,</span>
<span class="cp">                -EXPIRES =&gt; &quot;+2y&quot;,</span>
<span class="cp">            );</span>

<span class="cp">print header(-COOKIE =&gt; $cookie),</span>
<span class="cp">      start_html(&quot;Ice Cookies, #2&quot;),</span>
<span class="cp">      h1(&quot;Hello Ice Cream&quot;),</span>
<span class="cp">      p(&quot;You chose as your favorite flavor `$favorite&#39;.&quot;);</span>

<span class="cp">#-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1040"
>Creating Sticky Widgets</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">#-----------------------------</span>
<span class="cp">print textfield(&quot;SEARCH&quot;);          # previous SEARCH value is the default</span>
<span class="cp">#-----------------------------</span>
<span class="cp"># <font size="-1"><a href="http://pleac.sourceforge.net/include/perl/ch19/who.cgi</span>">download the following standalone program</a></font>
<span class="cp">#!/usr/bin/perl -wT</span>
<span class="cp"># who.cgi - run who(1) on a user and format the results nicely</span>

<span class="cp">$ENV{IFS}=&#39;&#39;;</span>
<span class="cp">$ENV{PATH}=&#39;/bin:/usr/bin&#39;;</span>

<span class="cp">use CGI qw(:standard);</span>

<span class="cp"># print search form</span>
<span class="cp">print header(), start_html(&quot;Query Users&quot;), h1(&quot;Search&quot;);</span>
<span class="cp">print start_form(), p(&quot;Which user?&quot;, textfield(&quot;WHO&quot;)); submit(), end_form();</span>

<span class="cp"># print results of the query if we have someone to look for</span>
<span class="cp">$name = param(&quot;WHO&quot;);</span>
<span class="cp">if ($name) {</span>
<span class="cp">    print h1(&quot;Results&quot;);</span>
<span class="cp">    $html = &#39;&#39;;</span>
<span class="cp">    </span>
<span class="cp">    # call who and build up text of response</span>
<span class="cp">    foreach (`who`) {</span>
<span class="cp">        next unless /^$name\s/o;            # only lines matching $name</span>
<span class="cp">        s/&amp;/&amp;amp;/g;                        # escape HTML</span>
<span class="cp">        s/&lt;/&amp;lt;/g;</span>
<span class="cp">        s/&gt;/&amp;gt;/g;</span>
<span class="cp">        $html .= $_;</span>
<span class="cp">    }</span>
<span class="cp">    # nice message if we didn&#39;t find anyone by that name</span>
<span class="cp">    $html = $html || &quot;$name is not logged in&quot;;</span>
<span class="cp">    </span>
<span class="cp">    print pre($html);</span>
<span class="cp">}</span>

<span class="cp">print end_html();</span>

<span class="cp">#-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1043"
>Writing a Multiscreen CGI Script</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">#-----------------------------</span>
<span class="cp">use CGI qw(:standard);</span>
<span class="cp">print hidden(&quot;bacon&quot;);</span>
<span class="cp">#-----------------------------</span>
<span class="cp">    print submit(-NAME =&gt; &quot;.State&quot;, -VALUE =&gt; &quot;Checkout&quot;);</span>
<span class="cp">#-----------------------------</span>
<span class="cp">sub to_page { return submit( -NAME =&gt; &quot;.State&quot;, -VALUE =&gt; shift ) }</span>
<span class="cp">#-----------------------------</span>
<span class="cp">$page = param(&quot;.State&quot;) || &quot;Default&quot;;</span>
<span class="cp">#-----------------------------</span>
<span class="cp">if ($page eq &quot;Default&quot;) {</span>
<span class="cp">    front_page();</span>
<span class="cp">} elsif ($page eq &quot;Checkout&quot;) {</span>
<span class="cp">    checkout();</span>
<span class="cp">} else {</span>
<span class="cp">    no_such_page();         # when we get a .State that doesn&#39;t exist</span>
<span class="cp">}</span>
<span class="cp">#-----------------------------</span>
<span class="cp">%States = (</span>
<span class="cp">    &#39;Default&#39;     =&gt; \&amp;front_page,</span>
<span class="cp">    &#39;Shirt&#39;       =&gt; \&amp;shirt,</span>
<span class="cp">    &#39;Sweater&#39;     =&gt; \&amp;sweater,</span>
<span class="cp">    &#39;Checkout&#39;    =&gt; \&amp;checkout,</span>
<span class="cp">    &#39;Card&#39;        =&gt; \&amp;credit_card,</span>
<span class="cp">    &#39;Order&#39;       =&gt; \&amp;order,</span>
<span class="cp">    &#39;Cancel&#39;      =&gt; \&amp;front_page,</span>
<span class="cp">);</span>

<span class="cp">if ($States{$page}) {</span>
<span class="cp">    $States{$page}-&gt;();   # call the correct subroutine </span>
<span class="cp">} else {</span>
<span class="cp">    no_such_page();</span>
<span class="cp">}</span>
<span class="cp">#-----------------------------</span>
<span class="cp">while (($state, $sub) = each %States) {</span>
<span class="cp">    $sub-&gt;( $page eq $state );</span>
<span class="cp">}</span>
<span class="cp">#-----------------------------</span>
<span class="cp">sub t_shirt {</span>
<span class="cp">    my $active = shift;</span>

<span class="cp">    unless ($active) {</span>
<span class="cp">        print hidden(&quot;size&quot;), hidden(&quot;color&quot;);</span>
<span class="cp">        return;</span>
<span class="cp">    }</span>

<span class="cp">    print p(&quot;You want to buy a t-shirt?&quot;);</span>
<span class="cp">    print p(&quot;Size: &quot;, popup_menu(&#39;size&#39;, [ qw(XL L M S XS) ]));</span>
<span class="cp">    print p(&quot;Color:&quot;, popup_menu(&#39;color&#39;, [ qw(Black White) ]));</span>

<span class="cp">    print p( to_page(&quot;Shoes&quot;), to_page(&quot;Checkout&quot;) );</span>
<span class="cp">}</span>
<span class="cp">#-----------------------------</span>
<span class="cp">print header(&quot;Program Title&quot;), start_html();</span>
<span class="cp">print standard_header(), begin_form();</span>
<span class="cp">while (($state, $sub) = each %States) {</span>
<span class="cp">    $sub-&gt;( $page eq $state );</span>
<span class="cp">}</span>
<span class="cp">print standard_footer(), end_form(), end_html();</span>
<span class="cp">#-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1046"
>Saving a Form to a File or Mail Pipe</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">#-----------------------------</span>
<span class="cp"># first open and exclusively lock the file</span>
<span class="cp">open(FH, &quot;&gt;&gt;/tmp/formlog&quot;)              or die &quot;can&#39;t append to formlog: $!&quot;;</span>
<span class="cp">flock(FH, 2)                            or die &quot;can&#39;t flock formlog: $!&quot;;</span>

<span class="cp"># either using the procedural interface</span>
<span class="cp">use CGI qw(:standard);</span>
<span class="cp">save_parameters(*FH);                   # with CGI::save</span>

<span class="cp"># or using the object interface</span>
<span class="cp">use CGI;</span>
<span class="cp">$query = CGI-&gt;new();</span>
<span class="cp">$query-&gt;save(*FH);</span>

<span class="cp">close(FH)                               or die &quot;can&#39;t close formlog: $!&quot;;</span>
<span class="cp">#-----------------------------</span>
<span class="cp">use CGI qw(:standard);</span>
<span class="cp">open(MAIL, &quot;|/usr/lib/sendmail -oi -t&quot;) or die &quot;can&#39;t fork sendmail: $!&quot;;</span>
<span class="cp">print MAIL &lt;&lt;EOF;</span>
<span class="cp">From: $0 (your cgi script)</span>
<span class="cp">To: hisname\@hishost.com</span>
<span class="cp">Subject: mailed form submission</span>

<span class="cp">EOF</span>
<span class="cp">save_parameters(*MAIL);</span>
<span class="cp">close(MAIL)                             or die &quot;can&#39;t close sendmail: $!&quot;; </span>
<span class="cp">#-----------------------------</span>
<span class="cp">param(&quot;_timestamp&quot;, scalar localtime);</span>
<span class="cp">param(&quot;_environs&quot;, %ENV);</span>
<span class="cp">#-----------------------------</span>
<span class="cp">use CGI;</span>
<span class="cp">open(FORMS, &quot;&lt; /tmp/formlog&quot;)       or die &quot;can&#39;t read formlog: $!&quot;;</span>
<span class="cp">flock(FORMS, 1)                     or die &quot;can&#39;t lock formlog: $!&quot;;</span>
<span class="cp">while ($query = CGI-&gt;new(*FORMS)) {</span>
<span class="cp">    last unless $query-&gt;param();     # means end of file</span>
<span class="cp">    %his_env = $query-&gt;param(&#39;_environs&#39;);</span>
<span class="cp">    $count  += $query-&gt;param(&#39;items requested&#39;)</span>
<span class="cp">                unless $his_env{REMOTE_HOST} =~ /(^|\.)perl\.com$/</span>
<span class="cp">}</span>
<span class="cp">print &quot;Total orders: $count\n&quot;;</span>
<span class="cp">#-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1049"
>Program: chemiserie</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">#-----------------------------</span>
<span class="cp"># <font size="-1"><a href="http://pleac.sourceforge.net/include/perl/ch19/chemiserie</span>">download the following standalone program</a></font>
<span class="cp">#!/usr/bin/perl -w</span>
<span class="cp"># chemiserie - simple CGI shopping for shirts and sweaters</span>

<span class="cp">use strict;</span>
<span class="cp">use CGI qw(:standard);</span>
<span class="cp">use CGI::Carp qw(fatalsToBrowser);</span>

<span class="cp">my %States;    	         # state table mapping pages to functions</span>
<span class="cp">my $Current_Screen;    	# the current screen</span>

<span class="cp"># Hash of pages and functions.</span>

<span class="cp">%States = (</span>
<span class="cp">    &#39;Default&#39;     =&gt; \&amp;front_page,</span>
<span class="cp">    &#39;Shirt&#39;       =&gt; \&amp;shirt,</span>
<span class="cp">    &#39;Sweater&#39;     =&gt; \&amp;sweater,</span>
<span class="cp">    &#39;Checkout&#39;    =&gt; \&amp;checkout,</span>
<span class="cp">    &#39;Card&#39;        =&gt; \&amp;credit_card,</span>
<span class="cp">    &#39;Order&#39;       =&gt; \&amp;order,</span>
<span class="cp">    &#39;Cancel&#39;      =&gt; \&amp;front_page,</span>
<span class="cp">);</span>

<span class="cp">$Current_Screen = param(&quot;.State&quot;) || &quot;Default&quot;;</span>
<span class="cp">die &quot;No screen for $Current_Screen&quot; unless $States{$Current_Screen};</span>

<span class="cp"># Generate the current page.</span>

<span class="cp">standard_header();</span>

<span class="cp">while (my($screen_name, $function) = each %States) {</span>
<span class="cp">    $function-&gt;($screen_name eq $Current_Screen);</span>
<span class="cp">}</span>
<span class="cp">standard_footer();</span>
<span class="cp">exit;</span>

<span class="cp">################################</span>
<span class="cp"># header, footer, menu functions</span>
<span class="cp">################################</span>

<span class="cp">sub standard_header {</span>
<span class="cp">    print header(), start_html(-Title =&gt; &quot;Shirts&quot;, -BGCOLOR=&gt;&quot;White&quot;);</span>
<span class="cp">    print start_form(); # start_multipart_form() if file upload</span>
<span class="cp">}</span>

<span class="cp">sub standard_footer { print end_form(), end_html() }</span>

<span class="cp">sub shop_menu {</span>
<span class="cp">    print p(defaults(&quot;Empty My Shopping Cart&quot;),</span>
<span class="cp">        to_page(&quot;Shirt&quot;),</span>
<span class="cp">        to_page(&quot;Sweater&quot;),</span>
<span class="cp">        to_page(&quot;Checkout&quot;));</span>
<span class="cp">}</span>

<span class="cp">#############################</span>
<span class="cp"># subroutines for each screen</span>
<span class="cp">#############################</span>

<span class="cp"># The default page.</span>
<span class="cp">sub front_page {</span>
<span class="cp">    my $active = shift;</span>
<span class="cp">    return unless $active;</span>

<span class="cp">    print &quot;&lt;H1&gt;Hi!&lt;/H1&gt;\n&quot;;</span>
<span class="cp">    print &quot;Welcome to our Shirt Shop!  Please make your selection from &quot;;</span>
<span class="cp">    print &quot;the menu below.\n&quot;;</span>

<span class="cp">    shop_menu();</span>
<span class="cp">}</span>

<span class="cp"># Page to order a shirt from.</span>
<span class="cp">sub shirt {</span>
<span class="cp">    my $active = shift;</span>
<span class="cp">    my @sizes  = qw(XL L M S);</span>
<span class="cp">    my @colors = qw(Black White);</span>

<span class="cp">    my ($size, $color, $count) =</span>
<span class="cp">      (param(&quot;shirt_size&quot;), param(&quot;shirt_color&quot;), param(&quot;shirt_count&quot;));</span>

<span class="cp">    # sanity check</span>
<span class="cp">    if ($count) {</span>
<span class="cp">        $color = $colors[0] unless grep { $_ eq $color } @colors;</span>
<span class="cp">        $size  = $sizes[0]  unless grep { $_ eq $size  } @sizes;</span>
<span class="cp">        param(&quot;shirt_color&quot;, $color);</span>
<span class="cp">        param(&quot;shirt_size&quot;,  $size);</span>
<span class="cp">    }</span>

<span class="cp">    unless ($active) {</span>
<span class="cp">        print hidden(&quot;shirt_size&quot;)  if $size;</span>
<span class="cp">        print hidden(&quot;shirt_color&quot;) if $color;</span>
<span class="cp">        print hidden(&quot;shirt_count&quot;) if $count;</span>
<span class="cp">        return;</span>
<span class="cp">    }</span>

<span class="cp">    print h1(&quot;T-Shirt&quot;);</span>
<span class="cp">    print p(&quot;What a shirt!  This baby is decked out with all the options.&quot;,</span>
<span class="cp">        &quot;It comes with full luxury interior, cotton trim, and a collar&quot;,</span>
<span class="cp">        &quot;to make your eyes water!  Unit price: \$33.00&quot;);</span>
<span class="cp">    print h2(&quot;Options&quot;);</span>
<span class="cp">    print p(&quot;How Many?&quot;, textfield(&quot;shirt_count&quot;));</span>
<span class="cp">    print p(&quot;Size?&quot;,  popup_menu(&quot;shirt_size&quot;,  \@sizes ),</span>
<span class="cp">        &quot;Color?&quot;, popup_menu(&quot;shirt_color&quot;, \@colors));</span>

<span class="cp">    shop_menu();</span>
<span class="cp">}</span>

<span class="cp"># Page to order a sweater from.</span>
<span class="cp">sub sweater {</span>
<span class="cp">    my $active = shift;</span>
<span class="cp">    my @sizes  = qw(XL L M);</span>
<span class="cp">    my @colors = qw(Chartreuse Puce Lavender);</span>

<span class="cp">    my ($size, $color, $count) =</span>
<span class="cp">      (param(&quot;sweater_size&quot;), param(&quot;sweater_color&quot;), param(&quot;sweater_count&quot;));</span>

<span class="cp">    # sanity check</span>
<span class="cp">    if ($count) {</span>
<span class="cp">        $color = $colors[0] unless grep { $_ eq $color } @colors;</span>
<span class="cp">        $size  = $sizes[0]  unless grep { $_ eq $size  } @sizes;</span>
<span class="cp">        param(&quot;sweater_color&quot;, $color);</span>
<span class="cp">        param(&quot;sweater_size&quot;,  $size);</span>
<span class="cp">    }</span>

<span class="cp">    unless ($active) {</span>
<span class="cp">        print hidden(&quot;sweater_size&quot;)  if $size;</span>
<span class="cp">        print hidden(&quot;sweater_color&quot;) if $color;</span>
<span class="cp">        print hidden(&quot;sweater_count&quot;) if $count;</span>
<span class="cp">        return;</span>
<span class="cp">    }</span>

<span class="cp">    print h1(&quot;Sweater&quot;);</span>
<span class="cp">    print p(&quot;Nothing implies preppy elegance more than this fine&quot;,</span>
<span class="cp">        &quot;sweater.  Made by peasant workers from black market silk,&quot;,</span>
<span class="cp">        &quot;it slides onto your lean form and cries out ``Take me,&quot;,</span>
<span class="cp">        &quot;for I am a god!&#39;&#39;.  Unit price: \$49.99.&quot;);</span>
<span class="cp">    print h2(&quot;Options&quot;);</span>
<span class="cp">    print p(&quot;How Many?&quot;, textfield(&quot;sweater_count&quot;));</span>
<span class="cp">    print p(&quot;Size?&quot;,  popup_menu(&quot;sweater_size&quot;,  \@sizes));</span>
<span class="cp">    print p(&quot;Color?&quot;, popup_menu(&quot;sweater_color&quot;, \@colors));</span>

<span class="cp">    shop_menu();</span>
<span class="cp">}</span>

<span class="cp"># Page to display current order for confirmation.</span>
<span class="cp">sub checkout {</span>
<span class="cp">    my $active = shift;</span>

<span class="cp">    return unless $active;</span>

<span class="cp">    print h1(&quot;Order Confirmation&quot;);</span>
<span class="cp">    print p(&quot;You ordered the following:&quot;);</span>
<span class="cp">    print order_text();</span>
<span class="cp">    print p(&quot;Is this right?  Select &#39;Card&#39; to pay for the items&quot;,</span>
<span class="cp">        &quot;or &#39;Shirt&#39; or &#39;Sweater&#39; to continue shopping.&quot;);</span>
<span class="cp">    print p(to_page(&quot;Card&quot;),</span>
<span class="cp">        to_page(&quot;Shirt&quot;), </span>
<span class="cp">        to_page(&quot;Sweater&quot;));</span>
<span class="cp">}</span>

<span class="cp"># Page to gather credit-card information.</span>
<span class="cp">sub credit_card {</span>
<span class="cp">    my $active = shift;</span>
<span class="cp">    my @widgets = qw(Name Address1 Address2 City Zip State Phone Card Expiry);</span>

<span class="cp">    unless ($active) {</span>
<span class="cp">        print map { hidden($_) } @widgets;</span>
<span class="cp">        return;</span>
<span class="cp">    }</span>

<span class="cp">    print pre(p(&quot;Name:          &quot;, textfield(&quot;Name&quot;)),</span>
<span class="cp">    	  p(&quot;Address:       &quot;, textfield(&quot;Address1&quot;)),</span>
<span class="cp">    	  p(&quot;               &quot;, textfield(&quot;Address2&quot;)),</span>
<span class="cp">    	  p(&quot;City:          &quot;, textfield(&quot;City&quot;)),</span>
<span class="cp">    	  p(&quot;Zip:           &quot;, textfield(&quot;Zip&quot;)),</span>
<span class="cp">    	  p(&quot;State:         &quot;, textfield(&quot;State&quot;)),</span>
<span class="cp">    	  p(&quot;Phone:         &quot;, textfield(&quot;Phone&quot;)),</span>
<span class="cp">    	  p(&quot;Credit Card #: &quot;, textfield(&quot;Card&quot;)),</span>
<span class="cp">    	  p(&quot;Expiry:        &quot;, textfield(&quot;Expiry&quot;)));</span>

<span class="cp">    print p(&quot;Click on &#39;Order&#39; to order the items.  Click on &#39;Cancel&#39; to return </span>
<span class="cp">shopping.&quot;);</span>

<span class="cp">    print p(to_page(&quot;Order&quot;), to_page(&quot;Cancel&quot;));</span>
<span class="cp">}</span>

<span class="cp"># Page to complete an order.</span>
<span class="cp">sub order {</span>
<span class="cp">    my $active = shift;</span>

<span class="cp">    unless ($active) {</span>
<span class="cp">        return;</span>
<span class="cp">    }</span>

<span class="cp">    # you&#39;d check credit card values here</span>

<span class="cp">    print h1(&quot;Ordered!&quot;);</span>
<span class="cp">    print p(&quot;You have ordered the following toppings:&quot;);</span>
<span class="cp">    print order_text();</span>

<span class="cp">    print p(defaults(&quot;Begin Again&quot;));</span>
<span class="cp">}</span>

<span class="cp"># Returns HTML for the current order (&quot;You have ordered ...&quot;)</span>
<span class="cp">sub order_text {</span>
<span class="cp">    my $html = &#39;&#39;;</span>

<span class="cp">    if (param(&quot;shirt_count&quot;)) {</span>
<span class="cp">        $html .= p(&quot;You have ordered &quot;, param(&quot;shirt_count&quot;),</span>
<span class="cp">    	       &quot; shirts of size &quot;,  param(&quot;shirt_size&quot;),</span>
<span class="cp">    	       &quot; and color &quot;, param(&quot;shirt_color&quot;), &quot;.&quot;);</span>
<span class="cp">    }</span>
<span class="cp">    if (param(&quot;sweater_count&quot;)) {</span>
<span class="cp">        $html .= p(&quot;You have ordered &quot;,  param(&quot;sweater_count&quot;),</span>
<span class="cp">    	       &quot; sweaters of size &quot;, param(&quot;sweater_size&quot;),</span>
<span class="cp">    	       &quot; and color &quot;, param(&quot;sweater_color&quot;), &quot;.&quot;);</span>
<span class="cp">    }</span>
<span class="cp">    $html = p(&quot;Nothing!&quot;) unless $html;</span>
<span class="cp">    $html .= p(&quot;For a total cost of &quot;, calculate_price());</span>
<span class="cp">    return $html;</span>
<span class="cp">}</span>

<span class="cp">sub calculate_price {</span>
<span class="cp">    my $shirts   = param(&quot;shirt_count&quot;)   || 0;</span>
<span class="cp">    my $sweaters = param(&quot;sweater_count&quot;) || 0;</span>
<span class="cp">    return sprintf(&quot;\$%.2f&quot;, $shirts*33 + $sweaters * 49.99);</span>
<span class="cp">}</span>

<span class="cp">sub to_page { submit(-NAME =&gt; &quot;.State&quot;, -VALUE =&gt; shift) }</span>

<span class="cp">#-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="internetservices.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="webautomation.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Internet Services</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
>&nbsp;</TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Web Automation</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>
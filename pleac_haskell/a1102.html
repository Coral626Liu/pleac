<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN""http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>Helpers</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="PLEAC-Haskell"
HREF="index.html"><LINK
REL="PREVIOUS"
TITLE="Web Automation"
HREF="webautomation.html"><style type="text/css">td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
pre { line-height: 125%; }

  </style></head
><BODY TEXT="#cecece" BGCOLOR="#4f6f6f" LINK="#f5deb3" VLINK="#d5ae83"
CLASS="APPENDIX"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>PLEAC-Haskell</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="webautomation.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
></TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
>&nbsp;</TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="APPENDIX"
><H1
CLASS="APPENDIX"
><A
NAME="AEN1102"
>A. Helpers</A
></H1
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c1"></span><span class="kr">import</span> <span class="nn">List</span>
<span class="kr">import</span> <span class="nn">Data.Ord</span> <span class="p">(</span><span class="nf">comparing</span><span class="p">)</span>
<span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Data.Array</span> <span class="k">as</span> <span class="n">Array</span>
<span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Data.Map</span> <span class="k">as</span> <span class="n">Map</span>
<span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Data.Set</span> <span class="k">as</span> <span class="n">Set</span>
<span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Control.Arrow</span> <span class="k">as</span> <span class="n">Arrow</span>

<span class="nf">listToArray</span> <span class="ow">::</span> <span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="ow">-&gt;</span> <span class="kt">Array</span> <span class="kt">Int</span> <span class="n">a</span>
<span class="nf">listToArray</span> <span class="n">l</span> <span class="ow">=</span> <span class="kt">Array</span><span class="o">.</span><span class="n">listArray</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">length</span> <span class="n">l</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="n">l</span>

<span class="nf">indexOf</span> <span class="n">subst</span> <span class="n">s</span> <span class="ow">=</span> <span class="n">findIndex</span> <span class="p">(</span><span class="n">subst</span> <span class="p">`</span><span class="n">isPrefixOf</span><span class="p">`)</span> <span class="p">(</span><span class="n">tails</span> <span class="n">s</span><span class="p">)</span>

<span class="nf">groupNelem</span> <span class="ow">::</span> <span class="kt">Int</span> <span class="ow">-&gt;</span> <span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="ow">-&gt;</span> <span class="p">[[</span><span class="n">a</span><span class="p">]]</span>
<span class="nf">groupNelem</span> <span class="n">n</span> <span class="ow">=</span> <span class="n">unfoldr</span> <span class="n">f</span>
    <span class="kr">where</span> <span class="n">f</span> <span class="kt">[]</span> <span class="ow">=</span> <span class="kt">Nothing</span>
          <span class="n">f</span> <span class="n">s</span> <span class="ow">=</span> <span class="kt">Just</span> <span class="p">(</span><span class="n">splitAt</span> <span class="n">n</span> <span class="n">s</span><span class="p">)</span>

<span class="nf">sortByKey</span> <span class="n">f</span> <span class="ow">=</span> <span class="n">map</span> <span class="n">snd</span> <span class="o">.</span> <span class="n">sortBy</span> <span class="p">(</span><span class="n">comparing</span> <span class="n">fst</span><span class="p">)</span> <span class="o">.</span> <span class="n">map</span> <span class="p">(</span><span class="nf">\</span><span class="n">x</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="n">f</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
<span class="nf">sortByKeyRev</span> <span class="n">f</span> <span class="ow">=</span> <span class="n">map</span> <span class="n">snd</span> <span class="o">.</span> <span class="n">sortBy</span> <span class="p">(</span><span class="n">flip</span> <span class="o">$</span> <span class="n">comparing</span> <span class="n">fst</span><span class="p">)</span> <span class="o">.</span> <span class="n">map</span> <span class="p">(</span><span class="nf">\</span><span class="n">x</span> <span class="ow">-&gt;</span> <span class="p">(</span><span class="n">f</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>

<span class="c1">-- alike python&#39;s fileinput.input() or perl&#39;s &lt;&gt;</span>
<span class="c1">-- typical usage: getArgs &gt;&gt;= any_input</span>
<span class="nf">any_input</span> <span class="ow">::</span> <span class="p">[</span><span class="kt">FilePath</span><span class="p">]</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="kt">String</span>
<span class="nf">any_input</span> <span class="kt">[]</span> <span class="ow">=</span> <span class="n">getContents</span>
<span class="nf">any_input</span> <span class="p">(</span><span class="n">f</span><span class="kt">:</span><span class="kr">_</span><span class="p">)</span> <span class="ow">=</span> <span class="n">readFile</span> <span class="n">f</span>

<span class="c1">-- subRegex only allow a fixed string</span>
<span class="c1">-- subRegexWith below takes a (String -&gt; String) function to compute a result</span>
<span class="nf">subRegexWith</span> <span class="n">re</span> <span class="n">new</span> <span class="n">s</span> <span class="ow">=</span>
    <span class="kr">case</span> <span class="n">matchRegexAll</span> <span class="n">re</span> <span class="n">s</span> <span class="kr">of</span>
      <span class="kt">Nothing</span> <span class="ow">-&gt;</span> <span class="n">s</span>
      <span class="kt">Just</span> <span class="p">(</span><span class="n">before</span><span class="p">,</span> <span class="n">matched</span><span class="p">,</span> <span class="n">after</span><span class="p">,</span> <span class="kr">_</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">before</span> <span class="o">++</span> <span class="n">new</span> <span class="n">matched</span> <span class="o">++</span> <span class="p">(</span><span class="n">subRegexWith</span> <span class="n">re</span> <span class="n">new</span> <span class="n">after</span><span class="p">)</span>

<span class="nf">subRegexOnceWith</span> <span class="n">re</span> <span class="n">new</span> <span class="n">s</span> <span class="ow">=</span> 
    <span class="kr">case</span> <span class="n">matchRegexAll</span> <span class="n">re</span> <span class="n">s</span> <span class="kr">of</span>
      <span class="kt">Nothing</span> <span class="ow">-&gt;</span> <span class="n">s</span>
      <span class="kt">Just</span> <span class="p">(</span><span class="n">before</span><span class="p">,</span> <span class="n">matched</span><span class="p">,</span> <span class="n">after</span><span class="p">,</span> <span class="kr">_</span><span class="p">)</span> <span class="ow">-&gt;</span> <span class="n">before</span> <span class="o">++</span> <span class="n">new</span> <span class="n">matched</span> <span class="o">++</span> <span class="n">after</span>

<span class="nf">rand</span> <span class="ow">::</span> <span class="kt">Int</span> <span class="ow">-&gt;</span> <span class="kt">Int</span> <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="kt">Int</span>
<span class="nf">rand</span> <span class="n">low</span> <span class="n">high</span> <span class="ow">=</span> <span class="n">getStdRandom</span> <span class="p">(</span><span class="n">randomR</span> <span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">))</span>

<span class="nf">dirname_basename</span> <span class="n">file</span> <span class="ow">=</span> <span class="p">(</span><span class="kr">if</span> <span class="n">dir</span> <span class="o">==</span> <span class="s">&quot;&quot;</span> <span class="kr">then</span> <span class="s">&quot;.&quot;</span> <span class="kr">else</span> <span class="p">(</span><span class="n">reverse</span> <span class="o">$</span> <span class="n">tail</span> <span class="n">dir</span><span class="p">),</span> <span class="n">reverse</span> <span class="n">base</span><span class="p">)</span>
    <span class="kr">where</span> <span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">dir</span><span class="p">)</span> <span class="ow">=</span> <span class="n">break</span> <span class="p">(</span><span class="o">==</span> <span class="sc">&#39;/&#39;</span><span class="p">)</span> <span class="o">$</span> <span class="n">reverse</span> <span class="n">file</span>

<span class="nf">dirname</span> <span class="ow">=</span> <span class="n">fst</span> <span class="o">.</span> <span class="n">dirname_basename</span>
<span class="nf">basename</span> <span class="ow">=</span> <span class="n">snd</span> <span class="o">.</span> <span class="n">dirname_basename</span>


<span class="c1">-- from http://www.cse.unsw.edu.au/~dons/code/newpopen</span>
<span class="c1">-- modified to handle stderr</span>
<span class="kr">import</span> <span class="nn">System.Process</span>
<span class="kr">import</span> <span class="nn">System.Exit</span>
<span class="kr">import</span> <span class="nn">System.IO</span>

<span class="kr">import</span> <span class="nn">Control.Monad</span>
<span class="kr">import</span> <span class="nn">Control.Concurrent</span>
<span class="kr">import</span> <span class="k">qualified</span> <span class="nn">Control.Exception</span> <span class="k">as</span> <span class="n">C</span>

<span class="nf">readProcess</span> <span class="ow">::</span> <span class="kt">FilePath</span>                     <span class="c1">-- ^ command to run</span>
            <span class="ow">-&gt;</span> <span class="p">[</span><span class="kt">String</span><span class="p">]</span>                     <span class="c1">-- ^ any arguments</span>
            <span class="ow">-&gt;</span> <span class="kt">String</span>                       <span class="c1">-- ^ standard input</span>
            <span class="ow">-&gt;</span> <span class="kt">IO</span> <span class="p">(</span><span class="kt">Either</span> <span class="kt">ExitCode</span> <span class="kt">String</span><span class="p">)</span>  <span class="c1">-- ^ either the stdout, or an exitcode</span>

<span class="nf">readProcess</span> <span class="n">cmd</span> <span class="n">args</span> <span class="n">input</span> <span class="ow">=</span> <span class="kt">C</span><span class="o">.</span><span class="n">handle</span> <span class="p">(</span><span class="n">return</span> <span class="o">.</span> <span class="n">handler</span><span class="p">)</span> <span class="o">$</span> <span class="kr">do</span>

    <span class="p">(</span><span class="n">inh</span><span class="p">,</span><span class="n">outh</span><span class="p">,</span><span class="n">errh</span><span class="p">,</span><span class="n">pid</span><span class="p">)</span> <span class="ow">&lt;-</span> <span class="n">runInteractiveProcess</span> <span class="n">cmd</span> <span class="n">args</span> <span class="kt">Nothing</span> <span class="kt">Nothing</span>

    <span class="c1">-- fork off a thread to start consuming the output</span>
    <span class="n">output</span>  <span class="ow">&lt;-</span> <span class="n">hGetContents</span> <span class="n">outh</span>
    <span class="n">outMVar</span> <span class="ow">&lt;-</span> <span class="n">newEmptyMVar</span>
    <span class="n">forkIO</span> <span class="o">$</span> <span class="kt">C</span><span class="o">.</span><span class="n">evaluate</span> <span class="p">(</span><span class="n">length</span> <span class="n">output</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">putMVar</span> <span class="n">outMVar</span> <span class="nb">()</span>

    <span class="c1">-- fork off a thread to start consuming the output</span>
    <span class="n">errput</span>  <span class="ow">&lt;-</span> <span class="n">hGetContents</span> <span class="n">errh</span>
    <span class="n">errMVar</span> <span class="ow">&lt;-</span> <span class="n">newEmptyMVar</span>
    <span class="n">forkIO</span> <span class="o">$</span> <span class="kt">C</span><span class="o">.</span><span class="n">evaluate</span> <span class="p">(</span><span class="n">length</span> <span class="n">errput</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">putMVar</span> <span class="n">errMVar</span> <span class="nb">()</span>

    <span class="c1">-- now write and flush any input</span>
    <span class="n">when</span> <span class="p">(</span><span class="n">not</span> <span class="p">(</span><span class="n">null</span> <span class="n">input</span><span class="p">))</span> <span class="o">$</span> <span class="n">hPutStr</span> <span class="n">inh</span> <span class="n">input</span>
    <span class="n">hClose</span> <span class="n">inh</span>          <span class="c1">-- done with stdin</span>

    <span class="c1">-- wait on the output</span>
    <span class="n">takeMVar</span> <span class="n">outMVar</span>
    <span class="n">hClose</span> <span class="n">outh</span>

    <span class="c1">-- wait on the errput</span>
    <span class="n">takeMVar</span> <span class="n">errMVar</span>
    <span class="n">hClose</span> <span class="n">errh</span>

    <span class="n">hPutStr</span> <span class="n">stderr</span> <span class="n">errput</span>

    <span class="c1">-- wait on the process</span>
    <span class="n">ex</span> <span class="ow">&lt;-</span> <span class="kt">C</span><span class="o">.</span><span class="n">catch</span> <span class="p">(</span><span class="n">waitForProcess</span> <span class="n">pid</span><span class="p">)</span> <span class="p">(</span><span class="nf">\</span><span class="kr">_</span> <span class="ow">-&gt;</span> <span class="n">return</span> <span class="kt">ExitSuccess</span><span class="p">)</span>

    <span class="n">return</span> <span class="o">$</span> <span class="kr">case</span> <span class="n">ex</span> <span class="kr">of</span>
        <span class="kt">ExitSuccess</span>   <span class="ow">-&gt;</span> <span class="kt">Right</span> <span class="n">output</span>
        <span class="kt">ExitFailure</span> <span class="kr">_</span> <span class="ow">-&gt;</span> <span class="kt">Left</span> <span class="n">ex</span>

  <span class="kr">where</span>
    <span class="n">handler</span> <span class="p">(</span><span class="kt">C</span><span class="o">.</span><span class="kt">ExitException</span> <span class="n">e</span><span class="p">)</span> <span class="ow">=</span> <span class="kt">Left</span> <span class="n">e</span>
    <span class="n">handler</span> <span class="n">e</span>                   <span class="ow">=</span> <span class="kt">Left</span> <span class="p">(</span><span class="kt">ExitFailure</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</body>
</html></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="webautomation.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>&nbsp;</TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Web Automation</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
>&nbsp;</TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>&nbsp;</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN""http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>File Contents</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="PLEAC-Python"
HREF="index.html"><LINK
REL="PREVIOUS"
TITLE="File Access"
HREF="fileaccess.html"><LINK
REL="NEXT"
TITLE="Directories"
HREF="directories.html"><style type="text/css">td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
pre { line-height: 125%; }

  </style></head
><BODY TEXT="#cecece" BGCOLOR="#4f6f6f" LINK="#f5deb3" VLINK="#d5ae83"
CLASS="SECT1"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>PLEAC-Python</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="fileaccess.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
></TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="directories.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="FILECONTENTS"
>8. File Contents</A
></H1
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN430"
>Introduction</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">#-----------------------------</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">DATAFILE</span><span class="p">:</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
    <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="k">print</span> <span class="n">size</span>        <span class="c"># output size of line</span>

<span class="c">#-----------------------------</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">datafile</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">length</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">())</span>     <span class="c"># output size of line</span>
<span class="c">#-----------------------------</span>
<span class="n">lines</span> <span class="o">=</span> <span class="n">datafile</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
<span class="c">#-----------------------------</span>
<span class="n">whole_file</span> <span class="o">=</span> <span class="n">myfile</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="c">#-----------------------------</span>
<span class="c">## No direct equivalent in Python</span>
<span class="c">#% perl -040 -e &#39;$word = &lt;&gt;; print &quot;First word is $word\n&quot;;&#39;</span>
<span class="c">#-----------------------------</span>
<span class="c">## No direct equivalent in Python</span>
<span class="c">#% perl -ne &#39;BEGIN { $/=&quot;%%\n&quot; } chomp; print if /Unix/i&#39; fortune.dat</span>
<span class="c">#-----------------------------</span>
<span class="k">print</span><span class="o">&gt;&gt;</span><span class="n">myfile</span><span class="p">,</span> <span class="s">&quot;One&quot;</span><span class="p">,</span> <span class="s">&quot;two&quot;</span><span class="p">,</span> <span class="s">&quot;three&quot;</span>  <span class="c"># &quot;One two three&quot;</span>
<span class="k">print</span> <span class="s">&quot;Baa baa black sheep.&quot;</span>         <span class="c"># Sent to default output file</span>
<span class="c">#-----------------------------</span>
<span class="nb">buffer</span> <span class="o">=</span> <span class="n">myfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">4096</span><span class="p">)</span>
<span class="n">rv</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">buffer</span><span class="p">)</span>
<span class="c">#-----------------------------</span>
<span class="n">myfile</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
<span class="nb">open</span><span class="p">(</span><span class="s">&quot;/tmp/</span><span class="si">%d</span><span class="s">.pid&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">getpid</span><span class="p">(),</span> <span class="s">&quot;a&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="n">length</span><span class="p">)</span>
<span class="c">#-----------------------------</span>
<span class="n">pos</span> <span class="o">=</span> <span class="n">myfile</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
<span class="k">print</span> <span class="s">&quot;I&#39;m&quot;</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="s">&quot;bytes from the start of DATAFILE.&quot;</span>
<span class="c">#-----------------------------</span>
<span class="n">logfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>   <span class="c"># Seek to the end</span>
<span class="n">datafile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">pos</span><span class="p">)</span>   <span class="c"># Seek to a given byte</span>
<span class="n">outfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c"># Seek back 20 bytes</span>
<span class="c">#-----------------------------</span>
<span class="n">written</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">datafile</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">mystr</span><span class="p">)</span>
<span class="k">if</span> <span class="n">written</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mystr</span><span class="p">):</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;only read </span><span class="si">%s</span><span class="s"> bytes, not </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">written</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">mystr</span><span class="p">)))</span>
<span class="c">#-----------------------------</span>
<span class="n">pos</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">lseek</span><span class="p">(</span><span class="n">myfile</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>       <span class="c"># don&#39;t change position</span>
<span class="c">#-----------------------------</span>

 </PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN433"
>Reading Lines with Continuation Characters</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="k">def</span> <span class="nf">ContReader</span><span class="p">(</span><span class="n">infile</span><span class="p">):</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">infile</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\\</span><span class="s">&quot;</span><span class="p">):</span>
            <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">continue</span>
        <span class="n">lines</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">yield</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">lines</span><span class="p">:</span>
        <span class="k">yield</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>

<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">ContReader</span><span class="p">(</span><span class="n">datafile</span><span class="p">):</span>
    <span class="k">pass</span> <span class="c"># process full record in &#39;line&#39; here</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN436"
>Counting Lines (or Paragraphs or Records) in a File</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="kn">import</span> <span class="nn">os</span>
<span class="n">count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s">&quot;wc -l &lt; &quot;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
<span class="c">#-----------------------------</span>
<span class="k">for</span> <span class="n">count</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)):</span>
    <span class="k">pass</span>
<span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>  <span class="c"># indexing is zero based</span>
<span class="c">#-----------------------------</span>
<span class="n">myfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">myfile</span><span class="p">:</span>
    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="c"># &#39;count&#39; now holds the number of lines read</span>
<span class="c">#-----------------------------</span>
<span class="n">myfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">myfile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="c">#-----------------------------</span>
<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">myfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">count</span> <span class="o">+=</span> <span class="n">s</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
<span class="c">#-----------------------------</span>
<span class="k">for</span> <span class="n">line</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">),</span> <span class="nb">xrange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">maxint</span><span class="p">)):</span>
    <span class="k">pass</span>
<span class="c"># &#39;count&#39; now holds the number of lines read</span>
<span class="c">#-----------------------------</span>
<span class="kn">import</span> <span class="nn">fileinput</span>
<span class="n">fi</span> <span class="o">=</span> <span class="n">fileinput</span><span class="o">.</span><span class="n">FileInput</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<span class="k">while</span> <span class="n">fi</span><span class="o">.</span><span class="n">readline</span><span class="p">():</span> <span class="k">pass</span>

<span class="n">count</span> <span class="o">=</span> <span class="n">fi</span><span class="o">.</span><span class="n">lineno</span><span class="p">()</span>
<span class="c">#-----------------------------</span>
<span class="k">def</span> <span class="nf">SepReader</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">infile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">text</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">fields</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">yield</span> <span class="n">field</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">fields</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">new_text</span> <span class="o">=</span> <span class="n">infile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">new_text</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">text</span>
            <span class="k">break</span>
        <span class="n">text</span> <span class="o">+=</span> <span class="n">new_text</span>

<span class="n">para_count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">para</span> <span class="ow">in</span> <span class="n">SepReader</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)):</span>
    <span class="n">para_count</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="c"># FIXME: For my test case (Python-pre2.2 README from CVS) this</span>
<span class="c"># returns 175 paragraphs while Perl returns 174.</span>
<span class="c">#-----------------------------</span>

 </PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN439"
>Processing Every Word in a File</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">word</span> <span class="ow">in</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">():</span>
        <span class="k">pass</span> <span class="c"># do something with &#39;chunk&#39;</span>
<span class="c">#-----------------------------</span>
<span class="n">pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&quot;(\w[\w&#39;-]*)&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">:</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">pat</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="c"># do something with match.group(1)</span>

<span class="c"># EXPERIMENTAL in the sre implementation but</span>
<span class="c"># likely to be included in future (post-2.2) releases.</span>
<span class="n">pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&quot;(\w[\w&#39;-]*)&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">:</span>
    <span class="n">scanner</span> <span class="o">=</span> <span class="n">pat</span><span class="o">.</span><span class="n">scanner</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">scanner</span><span class="o">.</span><span class="n">search</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="c"># do something with match.group(1)</span>


<span class="c">#-----------------------------</span>
<span class="c"># Make a word frequency count</span>
<span class="kn">import</span> <span class="nn">fileinput</span><span class="o">,</span> <span class="nn">re</span>
<span class="n">pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&quot;(\w[\w&#39;-]*)&quot;</span><span class="p">)</span>
<span class="n">seen</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fileinput</span><span class="o">.</span><span class="n">input</span><span class="p">():</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">pat</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">seen</span><span class="p">[</span><span class="n">text</span><span class="p">]</span> <span class="o">=</span> <span class="n">seen</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

<span class="c"># output dict in a descending numeric sort of its values</span>
<span class="k">for</span> <span class="n">text</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">seen</span><span class="o">.</span><span class="n">items</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
    <span class="k">print</span> <span class="s">&quot;</span><span class="si">%5d</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>

<span class="c">#-----------------------------</span>
<span class="c"># Line frequency count</span>
<span class="kn">import</span> <span class="nn">fileinput</span><span class="o">,</span> <span class="nn">sys</span>
<span class="n">seen</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fileinput</span><span class="o">.</span><span class="n">input</span><span class="p">():</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">seen</span><span class="p">[</span><span class="n">text</span><span class="p">]</span> <span class="o">=</span> <span class="n">seen</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

<span class="k">for</span> <span class="n">text</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">seen</span><span class="o">.</span><span class="n">items</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%5d</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="n">text</span><span class="p">))</span>

<span class="c">#-----------------------------</span>

 </PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN442"
>Reading a File Backwards by Line or Paragraph</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="n">lines</span> <span class="o">=</span> <span class="n">myfile</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
<span class="k">while</span> <span class="n">lines</span><span class="p">:</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="c"># do something with &#39;line&#39;</span>

<span class="c">#-----------------------------</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">myfile</span><span class="p">):</span>
    <span class="k">pass</span>  <span class="c"># do something with line</span>
<span class="c">#-----------------------------</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="o">-</span><span class="n">i</span><span class="p">]</span>
<span class="c">#-----------------------------</span>
<span class="k">for</span> <span class="n">paragraph</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">SepReader</span><span class="p">(</span><span class="n">infile</span><span class="p">)):</span>
    <span class="k">pass</span> <span class="c"># do something</span>
<span class="c">#-----------------------------</span>

 </PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN445"
>Trailing a Growing File</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="kn">import</span> <span class="nn">time</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">infile</span><span class="p">:</span>
        <span class="k">pass</span> <span class="c"># do something with the line</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">SOMETIME</span><span class="p">)</span>
    <span class="n">infile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="c">#-----------------------------</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="n">naptime</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">logfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;/tmp/logfile&quot;</span><span class="p">)</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">logfile</span><span class="p">:</span>
        <span class="k">print</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">naptime</span><span class="p">)</span>
    <span class="n">infile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="c">#-----------------------------</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">curpos</span> <span class="o">=</span> <span class="n">logfile</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">logfile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">curpos</span> <span class="o">=</span> <span class="n">logfile</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
    <span class="n">sleep</span><span class="p">(</span><span class="n">naptime</span><span class="p">)</span>
    <span class="n">logfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">curpos</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>  <span class="c"># seek to where we had been</span>
<span class="c">#-----------------------------</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">LOGFILENAME</span><span class="p">)</span><span class="o">.</span><span class="n">st_nlink</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">raise</span> <span class="ne">SystemExit</span>
<span class="c">#-----------------------------</span>

 </PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN448"
>Picking a Random Line from a File</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="kn">import</span> <span class="nn">random</span><span class="o">,</span> <span class="nn">fileinput</span>
<span class="n">text</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fileinput</span><span class="o">.</span><span class="n">input</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="n">fileinput</span><span class="o">.</span><span class="n">lineno</span><span class="p">())</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">text</span> <span class="o">=</span> <span class="n">line</span>
<span class="c"># &#39;text&#39; is the random line</span>
<span class="c">#-----------------------------</span>
<span class="c"># XXX is the perl code correct?  Where is the fortunes file opened?</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">adage</span> <span class="o">=</span> <span class="bp">None</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">rec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">SepReader</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s">&quot;/usr/share/games/fortunes&quot;</span><span class="p">),</span> <span class="s">&quot;%</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)):</span>
    <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">randrange</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">adage</span> <span class="o">=</span> <span class="n">rec</span>
<span class="k">print</span> <span class="n">adage</span>
<span class="c">#-----------------------------</span>

 </PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN451"
>Randomizing All Lines</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="kn">import</span> <span class="nn">random</span>
<span class="n">lines</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
<span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
<span class="c">#-----------------------------</span>

 </PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN454"
>Reading a Particular Line in a File</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c"># using efficient caching system</span>
<span class="kn">import</span> <span class="nn">linecache</span>
<span class="n">linecache</span><span class="o">.</span><span class="n">getline</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">DESIRED_LINE_NUMBER</span><span class="p">)</span>

<span class="c"># or doing it more oldskool</span>
<span class="n">lineno</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">infile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span> <span class="ow">or</span> <span class="n">lineno</span> <span class="o">==</span> <span class="n">DESIRED_LINE_NUMBER</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="n">lineno</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="c">#-----------------------------</span>
<span class="n">lines</span> <span class="o">=</span> <span class="n">infile</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
<span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">DESIRED_LINE_NUMBER</span><span class="p">]</span>
<span class="c">#-----------------------------</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">DESIRED_LINE_NUMBER</span><span class="p">):</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">infile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
        <span class="k">break</span>
<span class="c">#-----------------------------</span>

<span class="c">## Not sure what this thing is doing.  Allow fast access to a given</span>
<span class="c">## line number?</span>

<span class="c"># usage: build_index(*DATA_HANDLE, *INDEX_HANDLE)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN457"
>Processing Variable-Length Text Fields</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c"># given $RECORD with field separated by PATTERN,</span>
<span class="c"># extract @FIELDS.</span>
<span class="n">fields</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">pattern_string</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
<span class="c">#-----------------------------</span>
<span class="n">pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">pattern_string</span><span class="p">)</span>
<span class="n">fields</span> <span class="o">=</span> <span class="n">pat</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<span class="c">#-----------------------------</span>
<span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">r&quot;([+-])&quot;</span><span class="p">,</span> <span class="s">&quot;3+5-2&quot;</span><span class="p">)</span>
<span class="c">#-----------------------------</span>
<span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="s">&#39;+&#39;</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span>
<span class="c">#-----------------------------</span>
<span class="n">fields</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">)</span>
<span class="c">#-----------------------------</span>
<span class="n">fields</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">r&quot;:&quot;</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span>
<span class="c">#-----------------------------</span>
<span class="n">fields</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">r&quot;\s+&quot;</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span>
<span class="c">#-----------------------------</span>
<span class="n">fields</span> <span class="o">=</span> <span class="n">record</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">)</span>
<span class="c">#-----------------------------</span>

 </PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN460"
>Removing the Last Line of a File</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="n">myfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)</span>
<span class="n">prev_pos</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">myfile</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="n">prev_pos</span> <span class="o">=</span> <span class="n">pos</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="n">myfile</span><span class="o">.</span><span class="n">tell</span><span class="p">()</span>
<span class="n">myfile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;a&quot;</span><span class="p">)</span>
<span class="n">myfile</span><span class="o">.</span><span class="n">truncate</span><span class="p">(</span><span class="n">prev_pos</span><span class="p">)</span>
<span class="c">#-----------------------------</span>

 </PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN463"
>Processing Binary Files</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span>
<span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&quot;wb&quot;</span><span class="p">)</span>
<span class="c">#-----------------------------</span>
<span class="n">gifname</span> <span class="o">=</span> <span class="s">&quot;picture.gif&quot;</span>
<span class="n">gif_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">gifname</span><span class="p">,</span> <span class="s">&quot;rb&quot;</span><span class="p">)</span>

<span class="c"># Don&#39;t think there&#39;s an equivalent for these in Python</span>
<span class="c">#binmode(GIF);               # now DOS won&#39;t mangle binary input from GIF</span>
<span class="c">#binmode(STDOUT);            # now DOS won&#39;t mangle binary output to STDOUT</span>

<span class="c">#-----------------------------</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">buff</span> <span class="o">=</span> <span class="n">gif</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="mi">10</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">buff</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">buff</span><span class="p">)</span>
<span class="c">#-----------------------------</span>

 </PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN466"
>Using Random-Access I/O</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="n">address</span> <span class="o">=</span> <span class="n">recsize</span> <span class="o">*</span> <span class="n">recno</span>
<span class="n">myfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="nb">buffer</span> <span class="o">=</span> <span class="n">myfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">recsize</span><span class="p">)</span>
<span class="c">#-----------------------------</span>
<span class="n">address</span> <span class="o">=</span> <span class="n">recsize</span> <span class="o">*</span> <span class="p">(</span><span class="n">recno</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="c">#-----------------------------</span>

 </PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN469"
>Updating a Random-Access File</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="kn">import</span> <span class="nn">posixfile</span>
<span class="n">address</span> <span class="o">=</span> <span class="n">recsize</span> <span class="o">*</span> <span class="n">recno</span>
<span class="n">myfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
<span class="nb">buffer</span> <span class="o">=</span> <span class="n">myfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">recsize</span><span class="p">)</span>
<span class="c"># ... work with the buffer, then turn it back into a string and ...</span>
<span class="n">myfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="o">-</span><span class="n">recsize</span><span class="p">,</span> <span class="n">posixfile</span><span class="o">.</span><span class="n">SEEK_CUR</span><span class="p">)</span>
<span class="n">myfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">buffer</span><span class="p">)</span>
<span class="n">myfile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="c">#-----------------------------</span>
<span class="c">## Not yet implemented</span>
<span class="c"># weekearly -- set someone&#39;s login date back a week</span>
<span class="c"># @@INCOMPLETE@@</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN472"
>Reading a String from a Binary File</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">## Note: this isn&#39;t optimal -- the &#39;s+=c&#39; may go O(N**2) so don&#39;t</span>
<span class="c">## use for large strings.</span>
<span class="n">myfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
<span class="n">s</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">myfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span> <span class="ow">or</span> <span class="n">c</span> <span class="o">==</span> <span class="s">&quot;</span><span class="se">\0</span><span class="s">&quot;</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="n">s</span> <span class="o">+=</span> <span class="n">c</span>
<span class="c">#-----------------------------</span>
<span class="n">myfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">myfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\0</span><span class="s">&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">offset</span> <span class="o">+=</span> <span class="n">x</span>
        <span class="k">break</span>
    <span class="n">offset</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1000</span><span class="p">:</span>  <span class="c"># EOF</span>
        <span class="k">break</span>
<span class="n">myfile</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">myfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">offset</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">myfile</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c">#-----------------------------</span>
<span class="c">## Not Implemented</span>
<span class="c"># bgets - get a string from an address in a binary file</span>
<span class="c">#-----------------------------</span>
<span class="c">#!/usr/bin/perl</span>
<span class="c"># strings - pull strings out of a binary file</span>
<span class="kn">import</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">sys</span>

<span class="c">## Assumes SepReader from above</span>

<span class="n">pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&quot;([\040-\176\s]{4,})&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">block</span> <span class="ow">in</span> <span class="n">SepReader</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\0</span><span class="s">&quot;</span><span class="p">):</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">match</span> <span class="o">=</span> <span class="n">pat</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="n">pos</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">print</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">pos</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="c">#-----------------------------</span>
 </PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN475"
>Reading Fixed-Length Records</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span>
<span class="c"># RECORDSIZE is the length of a record, in bytes.</span>
<span class="c"># TEMPLATE is the unpack template for the record</span>
<span class="c"># FILE is the file to read from</span>
<span class="c"># FIELDS is a tuple, one element per field</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="n">RECORDSIZE</span><span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">TEMPLATE</span><span class="p">)</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">record</span> <span class="o">=</span> <span class="n">FILE</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">RECORDSIZE</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">record</span><span class="p">)</span><span class="o">!=</span><span class="n">RECORDSIZE</span><span class="p">:</span>
        <span class="k">raise</span> <span class="s">&quot;short read&quot;</span>
    <span class="n">FIELDS</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">TEMPLATE</span><span class="p">,</span> <span class="n">record</span><span class="p">)</span>
<span class="c"># ----</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN478"
>Reading Configuration Files</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c"># NOTE: to parse INI file, see the stanard ConfigParser module.</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="n">pat</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&quot;\s*=\s*&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">config_file</span><span class="p">:</span>
    <span class="k">if</span> <span class="s">&quot;#&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">:</span>         <span class="c"># no comments</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="n">line</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s">&quot;#&quot;</span><span class="p">)]</span>
    <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>     <span class="c"># no leading or trailing white</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>            <span class="c"># anything left?</span>
        <span class="k">continue</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">pat</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="n">var</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="n">m</span><span class="o">.</span><span class="n">start</span><span class="p">()]</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="n">m</span><span class="o">.</span><span class="n">end</span><span class="p">():]</span>
    <span class="n">User_Preferences</span><span class="p">[</span><span class="n">var</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN481"
>Testing a File for Trustworthiness</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="kn">import</span> <span class="nn">os</span>

<span class="n">mode</span><span class="p">,</span> <span class="n">ino</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">nlink</span><span class="p">,</span> <span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> \
<span class="n">atime</span><span class="p">,</span> <span class="n">mtime</span><span class="p">,</span> <span class="n">ctime</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

<span class="n">mode</span> <span class="o">&amp;=</span> <span class="mo">07777</span>               <span class="c"># discard file type info</span>

<span class="c">#-----------------------------</span>
<span class="n">info</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
<span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">st_uid</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&quot;Superuser owns&quot;</span><span class="p">,</span> <span class="n">filename</span>
<span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">st_atime</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">:</span>
    <span class="k">print</span> <span class="n">filename</span><span class="p">,</span> <span class="s">&quot;has been read since it was written.&quot;</span>
<span class="c">#-----------------------------</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="k">def</span> <span class="nf">is_safe</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">info</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">stat</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="c"># owner neither superuser nor me </span>
    <span class="c"># the real uid is in stored in the $&lt; variable</span>
    <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">st_uid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">getuid</span><span class="p">()):</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="c"># check whether group or other can write file.</span>
    <span class="c"># use 066 to detect either reading or writing</span>
    <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="mo">022</span><span class="p">:</span>  <span class="c"># someone else can write this</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>  <span class="c"># non-directories aren&#39;t safe</span>
            <span class="k">return</span> <span class="bp">False</span>
        <span class="c"># but directories with the sticky bit (01000) are</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">st_mode</span> <span class="o">&amp;</span> <span class="mo">01000</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="bp">True</span>
<span class="c">#-----------------------------</span>
<span class="c">## XXX What is &#39;_PC_CHOWN_RESTRICTED&#39;?</span>

<span class="k">def</span> <span class="nf">is_verysafe</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="n">terms</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">path</span><span class="p">,</span> <span class="n">ending</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ending</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">terms</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ending</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">term</span> <span class="ow">in</span> <span class="n">terms</span><span class="p">:</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_safe</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>
    <span class="k">return</span> <span class="bp">True</span>
<span class="c">#-----------------------------</span>

<span class="c"># Program: tctee</span>
<span class="c"># Not Implemented (requires reimplementing Perl&#39;s builtin &#39;&gt;&gt;&#39;, &#39;|&#39;,</span>
<span class="c"># etc. semantics)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN484"
>Program: tailwtmp</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">#!/usr/bin/python</span>
<span class="c"># tailwtmp - watch for logins and logouts;</span>
<span class="c"># uses linux utmp structure, from /usr/include/bits/utmp.h</span>

<span class="c"># /* The structure describing an entry in the user accounting database.  */</span>
<span class="c"># struct utmp</span>
<span class="c"># {</span>
<span class="c">#   short int ut_type;            /* Type of login.  */</span>
<span class="c">#   pid_t ut_pid;                 /* Process ID of login process.  */</span>
<span class="c">#   char ut_line[UT_LINESIZE];    /* Devicename.  */</span>
<span class="c">#   char ut_id[4];                /* Inittab ID.  */</span>
<span class="c">#   char ut_user[UT_NAMESIZE];    /* Username.  */</span>
<span class="c">#   char ut_host[UT_HOSTSIZE];    /* Hostname for remote login.  */</span>
<span class="c">#   struct exit_status ut_exit;   /* Exit status of a process marked</span>
<span class="c">#                                    as DEAD_PROCESS.  */</span>
<span class="c">#   long int ut_session;          /* Session ID, used for windowing.  */</span>
<span class="c">#   struct timeval ut_tv;         /* Time entry was made.  */</span>
<span class="c">#   int32_t ut_addr_v6[4];        /* Internet address of remote host.  */</span>
<span class="c">#   char __unused[20];            /* Reserved for future use.  */</span>
<span class="c"># };</span>

<span class="c"># /* Values for the `ut_type&#39; field of a `struct utmp&#39;.  */</span>
<span class="c"># #define EMPTY       0   /* No valid user accounting information.  */</span>
<span class="c"># </span>
<span class="c"># #define RUN_LVL     1   /* The system&#39;s runlevel.  */</span>
<span class="c"># #define BOOT_TIME   2   /* Time of system boot.  */</span>
<span class="c"># #define NEW_TIME    3   /* Time after system clock changed.  */</span>
<span class="c"># #define OLD_TIME    4   /* Time when system clock changed.  */</span>
<span class="c"># </span>
<span class="c"># #define INIT_PROCESS    5   /* Process spawned by the init process.  */</span>
<span class="c"># #define LOGIN_PROCESS   6   /* Session leader of a logged in user.  */</span>
<span class="c"># #define USER_PROCESS    7   /* Normal process.  */</span>
<span class="c"># #define DEAD_PROCESS    8   /* Terminated process.  */</span>
<span class="c"># </span>
<span class="c"># #define ACCOUNTING  9</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="k">class</span> <span class="nc">WTmpRecord</span><span class="p">:</span>
    <span class="n">fmt</span> <span class="o">=</span> <span class="s">&quot;hI32s4s32s256siili4l20s&quot;</span><span class="p">;</span>
    <span class="n">_fieldnames</span> <span class="o">=</span> <span class="p">[</span><span class="s">&quot;type&quot;</span><span class="p">,</span><span class="s">&quot;PID&quot;</span><span class="p">,</span><span class="s">&quot;Line&quot;</span><span class="p">,</span><span class="s">&quot;inittab&quot;</span><span class="p">,</span><span class="s">&quot;User&quot;</span><span class="p">,</span><span class="s">&quot;Hostname&quot;</span><span class="p">,</span>
                    <span class="s">&quot;exit_status&quot;</span><span class="p">,</span> <span class="s">&quot;session&quot;</span><span class="p">,</span> <span class="s">&quot;time&quot;</span><span class="p">,</span> <span class="s">&quot;addr&quot;</span> <span class="p">]</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rec_size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fmt</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rec_size</span>
    <span class="k">def</span> <span class="nf">unpack</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bin_data</span><span class="p">):</span>
        <span class="n">rec</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fmt</span><span class="p">,</span> <span class="n">bin_data</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rec</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rec</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">):</span>
                <span class="c"># remove character zeros from strings</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">rec</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\0</span><span class="s">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_rec</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rec</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rec</span>
    <span class="k">def</span> <span class="nf">fieldnames</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fieldnames</span>
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">name</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rec</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_fieldnames</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">name</span><span class="p">)]</span>
        
<span class="n">rec</span> <span class="o">=</span> <span class="n">WTmpRecord</span><span class="p">()</span>
<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;/var/log/wtmp&quot;</span><span class="p">,</span><span class="s">&quot;rb&quot;</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="nb">bin</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">size</span><span class="p">())</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">bin</span><span class="p">)</span> <span class="o">!=</span> <span class="n">rec</span><span class="o">.</span><span class="n">size</span><span class="p">():</span>
            <span class="k">break</span>
        <span class="n">rec</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="nb">bin</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rec</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot; </span><span class="si">%1d</span><span class="s"> </span><span class="si">%-8s</span><span class="s"> </span><span class="si">%-12s</span><span class="s"> </span><span class="si">%-24s</span><span class="s"> </span><span class="si">%-20s</span><span class="s"> </span><span class="si">%5d</span><span class="s"> </span><span class="si">%08x</span><span class="s">&quot;</span> <span class="o">%</span> \
                <span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">rec</span><span class="o">.</span><span class="n">User</span><span class="p">,</span> <span class="n">rec</span><span class="o">.</span><span class="n">Line</span><span class="p">,</span> 
                 <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%a %Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M:%S&quot;</span><span class="p">,</span><span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">time</span><span class="p">)),</span>
                 <span class="n">rec</span><span class="o">.</span><span class="n">Hostname</span><span class="p">,</span> <span class="n">rec</span><span class="o">.</span><span class="n">PID</span><span class="p">,</span> <span class="n">rec</span><span class="o">.</span><span class="n">addr</span><span class="p">)</span>
    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN487"
>Program: tctee</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c"># @@INCOMPLETE@@</span>
<span class="c"># @@INCOMPLETE@@</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN490"
>Program: laston</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">#!/usr/bin/python</span>
<span class="c"># laston - find out when given user last logged on</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">struct</span>
<span class="kn">import</span> <span class="nn">pwd</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&quot;/var/log/lastlog&quot;</span><span class="p">,</span><span class="s">&quot;rb&quot;</span><span class="p">)</span>

<span class="n">fmt</span> <span class="o">=</span> <span class="s">&quot;L32s256s&quot;</span>
<span class="n">rec_size</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">calcsize</span><span class="p">(</span><span class="n">fmt</span><span class="p">)</span>

<span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">r&quot;^\d+$&quot;</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwnam</span><span class="p">(</span><span class="n">user</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">print</span> <span class="s">&quot;no such uid </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">user</span><span class="p">)</span>
            <span class="k">continue</span>
    <span class="n">f</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">rec_size</span> <span class="o">*</span> <span class="n">user_id</span><span class="p">)</span>
    <span class="nb">bin</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">rec_size</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">bin</span><span class="p">)</span> <span class="o">==</span> <span class="n">rec_size</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">struct</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="nb">bin</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">logged_in</span> <span class="o">=</span> <span class="s">&quot;at </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%a %H:%M:%S %Y-%m-</span><span class="si">%d</span><span class="s">&quot;</span><span class="p">,</span>
                                    <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])))</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s">&quot; on </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">host</span> <span class="o">=</span> <span class="s">&quot; from </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logged_in</span> <span class="o">=</span> <span class="s">&quot;never logged in&quot;</span>
            <span class="n">line</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
            <span class="n">host</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="k">print</span> <span class="s">&quot;</span><span class="si">%-8s</span><span class="s"> UID </span><span class="si">%5d</span><span class="s"> </span><span class="si">%s%s%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">logged_in</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">host</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;Read failed.&quot;</span>
<span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></PRE
></TD
></TR
></TABLE
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="fileaccess.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="directories.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>File Access</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
>&nbsp;</TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Directories</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>
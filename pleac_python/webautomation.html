<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN""http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>Web Automation</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="PLEAC-Python"
HREF="index.html"><LINK
REL="PREVIOUS"
TITLE="CGI Programming"
HREF="cgiprogramming.html"><LINK
REL="NEXT"
TITLE="Helpers"
HREF="a1102.html"><style type="text/css">td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
pre { line-height: 125%; }

  </style></head
><BODY TEXT="#cecece" BGCOLOR="#4f6f6f" LINK="#f5deb3" VLINK="#d5ae83"
CLASS="SECT1"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>PLEAC-Python</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="cgiprogramming.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
></TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="a1102.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="WEBAUTOMATION"
>20. Web Automation</A
></H1
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1054"
>Introduction</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1057"
>Fetching a URL from a Perl Script</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">#-----------------------------</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="n">content</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">urllib</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&quot;could not get </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">url</span>

<span class="c">#-----------------------------</span>
<span class="c"># <font size="-1"><a href="http://pleac.sourceforge.net/include/python/ch20/titlebytes</span>">download the following standalone program</a></font>
<span class="c">#!/usr/bin/python</span>
<span class="c"># titlebytes - find the title and size of documents</span>
<span class="c">#</span>
<span class="c"># differences to perl</span>
<span class="c"># </span>
<span class="c"># * no URI::Heuristics</span>
<span class="c"># * perl LWP supports fetching files from local system</span>
<span class="c"># * fetching a title from ftp or file doesnt work in perl either.</span>

<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">urllib2</span><span class="o">,</span> <span class="nn">HTMLParser</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span><span class="o">&lt;=</span><span class="mi">1</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&quot;usage: </span><span class="si">%s</span><span class="s"> url&quot;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">raw_url</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> 

<span class="c"># python has no equivalent to pearls URI::Heuristics, which</span>
<span class="c"># would do some guessing like :</span>
<span class="c">#</span>
<span class="c">#   perl            -&gt; http://www.perl.com</span>
<span class="c">#   www.oreilly.com -&gt; http://www.oreilly.com</span>
<span class="c">#   ftp.funet.fi    -&gt; ftp://ftp.funet.fi</span>
<span class="c">#   /etc/passwd     -&gt; file:/etc/passwd</span>

<span class="c"># simple but pedantic html parser: tpj.com breaks it.</span>
<span class="k">class</span> <span class="nc">html</span><span class="p">(</span><span class="n">HTMLParser</span><span class="o">.</span><span class="n">HTMLParser</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">HTMLParser</span><span class="o">.</span><span class="n">HTMLParser</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_open_tags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">def</span> <span class="nf">handle_starttag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_open_tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">handle_endtag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_open_tags</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_open_tags</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">handle_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_open_tags</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_open_tags</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">data</span>
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">attr</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>

<span class="n">url</span> <span class="o">=</span> <span class="n">raw_url</span>
<span class="k">print</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> =&gt;</span><span class="se">\n\t</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">url</span><span class="p">,</span>
<span class="c"># TODO fake user agent &quot;Schmozilla/v9.17 Platinum&quot;</span>
<span class="c"># TODO referer &quot;http://wizard.yellowbrick.oz&quot;</span>
<span class="c"># as we only do http httplib would do also</span>
<span class="k">try</span><span class="p">:</span>
	<span class="n">response</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="k">except</span><span class="p">:</span>
	<span class="k">print</span> <span class="s">&quot; </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">reason</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
	<span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="c"># title is not in response</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">parser</span> <span class="o">=</span> <span class="n">html</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c"># force processing all data</span>
<span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">))</span>
<span class="nb">bytes</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="k">print</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s"> (</span><span class="si">%d</span><span class="s"> lines, </span><span class="si">%d</span><span class="s"> bytes)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">title</span><span class="p">,</span> 
        <span class="n">count</span><span class="p">,</span> 
        <span class="nb">bytes</span><span class="p">)</span>

<span class="c"># omly bytes is in response.info()</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1060"
>Automating Form Submission</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span>
<span class="c"># GET method</span>
<span class="kn">import</span> <span class="nn">httplib</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">httplib</span><span class="o">.</span><span class="n">HTTPConnection</span><span class="p">(</span><span class="s">&#39;www.perl.com&#39;</span><span class="p">)</span>
<span class="n">conn</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s">&#39;GET&#39;</span><span class="p">,</span><span class="s">&#39;/cgi-bin/cpan_mod?module=DB_File&amp;readme=1&#39;</span><span class="p">)</span>
<span class="n">r1</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">getresponse</span><span class="p">()</span>
<span class="n">content</span> <span class="o">=</span> <span class="n">r1</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="c"># POST method</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlencode</span><span class="p">({</span><span class="s">&#39;module&#39;</span><span class="p">:</span> <span class="s">&#39;DB_File&#39;</span><span class="p">,</span> <span class="s">&#39;readme&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">})</span>
<span class="n">content</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="s">&#39;http://www.perl.com&#39;</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="c"># fields must be properly escaped</span>
<span class="c"># script.cgi?field1?arg=%22this%20isn%27t%20%3CEASY%3E%22</span>

<span class="c"># proxies can be taken from environment, or specified</span>
<span class="c"># as the optional thrid parameter to urlopen.</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1063"
>Extracting URLs</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c"># <font size="-1"><a href="http://pleac.sourceforge.net/include/python/ch20/xurl</span>">download the following standalone program</a></font>
<span class="c">#!/usr/bin/python</span>
<span class="c"># xurl - extract unique, sorted list of links from URL</span>

<span class="kn">from</span> <span class="nn">HTMLParser</span> <span class="kn">import</span> <span class="n">HTMLParser</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">from</span> <span class="nn">sets</span> <span class="kn">import</span> <span class="n">Set</span> <span class="k">as</span> <span class="nb">set</span> <span class="c"># not needed in 2.4</span>
<span class="k">class</span> <span class="nc">myParser</span><span class="p">(</span><span class="n">HTMLParser</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseUrl</span> <span class="o">=</span> <span class="n">url</span><span class="p">[:</span><span class="n">url</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)]</span>
        <span class="n">HTMLParser</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">urls</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">HTMLParser</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">handle_starttag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s">&#39;a&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attrs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;href&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attrs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="c"># we need to add the base URL.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">urls</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseUrl</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">attrs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">urls</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
<span class="n">url</span> <span class="o">=</span> <span class="s">&#39;http://www.perl.com/CPAN&#39;</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">myParser</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">p</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">urllist</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">urls</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="n">urllist</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
<span class="k">print</span> <span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">urllist</span><span class="p">)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1066"
>Converting ASCII to HTML</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c"># Converting ASCII to HTML</span>

<span class="c"># <font size="-1"><a href="http://pleac.sourceforge.net/include/python/ch20/text2html</span>">download the following standalone program</a></font>
<span class="c">#!/usr/bin/python</span>
<span class="c"># text2html - trivial html encoding of normal text</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="c"># precompile regular expressions</span>
<span class="n">re_quoted</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&quot;(?m)^(&gt;.*?)$&quot;</span><span class="p">)</span>
<span class="n">re_url</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&quot;&lt;URL:(.*)&gt;&quot;</span><span class="p">)</span>
<span class="n">re_http</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&quot;(http:\S+)&quot;</span><span class="p">)</span>
<span class="n">re_strong</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&quot;\*(\S+)\*&quot;</span><span class="p">)</span>
<span class="n">re_em</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&quot;\b_(\S+)_\b&quot;</span><span class="p">)</span>

<span class="c"># split paragraphs</span>
<span class="k">for</span> <span class="n">para</span> <span class="ow">in</span> <span class="nb">open</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">):</span>
    <span class="c"># TODO encode entities: dont encode &quot;&lt;&gt;&quot; but do &quot;&amp;&quot;</span>
    <span class="k">if</span> <span class="n">para</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot;&lt;pre&gt;</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s">&lt;/pre&gt;&quot;</span> <span class="o">%</span> <span class="n">para</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">para</span> <span class="o">=</span> <span class="n">re_quoted</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">r&quot;\1&lt;br /&gt;&quot;</span><span class="p">,</span> <span class="n">para</span><span class="p">)</span>          <span class="c"># quoted text</span>
        <span class="n">para</span> <span class="o">=</span> <span class="n">re_url</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">r&#39;&lt;a href=&quot;\1&quot;&gt;\1&lt;/a&gt;&#39;</span><span class="p">,</span> <span class="n">para</span><span class="p">)</span>  <span class="c"># embedded URL</span>
        <span class="n">para</span> <span class="o">=</span> <span class="n">re_http</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">r&#39;&lt;a href=&quot;\1&quot;&gt;\1&lt;/a&gt;&#39;</span><span class="p">,</span> <span class="n">para</span><span class="p">)</span> <span class="c"># guessed URL</span>
        <span class="n">para</span> <span class="o">=</span> <span class="n">re_strong</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">r&quot;&lt;strong&gt;\1&lt;/strong&gt;&quot;</span><span class="p">,</span><span class="n">para</span><span class="p">)</span>   <span class="c"># this is *bold* here</span>
        <span class="n">para</span> <span class="o">=</span> <span class="n">re_em</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">r&quot;&lt;em&gt;\1&lt;/em&gt;&quot;</span><span class="p">,</span><span class="n">para</span><span class="p">)</span>            <span class="c"># this is _italic_ here</span>
        <span class="k">print</span> <span class="s">&quot;&lt;p&gt;</span><span class="se">\n</span><span class="si">%s</span><span class="se">\n</span><span class="s">&lt;/p&gt;&quot;</span> <span class="o">%</span> <span class="n">para</span>                     <span class="c"># add paragraph tags</span>



<span class="c">#-----------------------------</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">htmlentitydefs</span>

<span class="k">def</span> <span class="nf">encode_entities</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">htmlentitydefs</span><span class="o">.</span><span class="n">codepoint2name</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span><span class="o">&lt;</span><span class="mi">256</span><span class="p">:</span> <span class="c"># no unicodes</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="nb">chr</span><span class="p">(</span><span class="n">k</span><span class="p">),</span><span class="s">&quot;&amp;</span><span class="si">%s</span><span class="s">;&quot;</span><span class="o">%</span><span class="n">v</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s</span>

<span class="k">print</span> <span class="s">&quot;&lt;table&gt;&quot;</span>
<span class="n">text</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">text</span> <span class="o">=</span> <span class="n">encode_entities</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
<span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">r&quot;(\n[ \t]+)&quot;</span><span class="p">,</span><span class="s">&quot; . &quot;</span><span class="p">,</span><span class="n">text</span><span class="p">)</span>   <span class="c"># continuation lines</span>
<span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">r&quot;(?m)^(\S+?:)\s*(.*?)$&quot;</span><span class="p">,</span>
              <span class="s">r&#39;&lt;tr&gt;&lt;th align=&quot;left&quot;&gt;\1&lt;/th&gt;&lt;td&gt;\2&lt;/td&gt;&lt;/tr&gt;&#39;</span><span class="p">,</span>
                            <span class="n">text</span><span class="p">);</span>
<span class="k">print</span> <span class="n">text</span>    
<span class="k">print</span> <span class="s">&quot;&lt;/table&gt;&quot;</span>
                            </PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1069"
>Converting HTML to ASCII</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c"># Converting HTML to ASCII</span>

<span class="c">#-----------------------------</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="n">ascii</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">popen</span><span class="p">(</span><span class="s">&quot;lynx -dump &quot;</span> <span class="o">+</span> <span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="c">#-----------------------------</span>
<span class="kn">import</span> <span class="nn">formatter</span>
<span class="kn">import</span> <span class="nn">htmllib</span>

<span class="n">w</span> <span class="o">=</span> <span class="n">formatter</span><span class="o">.</span><span class="n">DumbWriter</span><span class="p">()</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">formatter</span><span class="o">.</span><span class="n">AbstractFormatter</span><span class="p">(</span><span class="n">w</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">htmllib</span><span class="o">.</span><span class="n">HTMLParser</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">html</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="c"># Above is a bare minimum to use writer/formatter/parser</span>
<span class="c"># framework of Python.</span>

<span class="c"># Search Python Cookbook for more details, like writing</span>
<span class="c"># your own writers or formatters.</span>

<span class="c"># Recipe #52297 has TtyFormatter, formatting underline</span>
<span class="c"># and bold in Terminal. Recipe #135005 has a writer</span>
<span class="c"># accumulating text instead of printing.</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1072"
>Extracting or Removing HTML Tags</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="n">plain_text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">r&quot;&lt;[^&gt;]*&gt;&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">html_text</span><span class="p">)</span> <span class="c">#WRONG</span>

<span class="c"># using HTMLParser</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">HTMLParser</span>

<span class="k">class</span> <span class="nc">html</span><span class="p">(</span><span class="n">HTMLParser</span><span class="o">.</span><span class="n">HTMLParser</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">HTMLParser</span><span class="o">.</span><span class="n">HTMLParser</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plaintext</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ignore</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">def</span> <span class="nf">handle_starttag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s">&quot;script&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ignore</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">def</span> <span class="nf">handle_endtag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s">&quot;script&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ignore</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="k">def</span> <span class="nf">handle_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ignore</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_plaintext</span> <span class="o">+=</span> <span class="n">data</span>
    <span class="k">def</span> <span class="nf">get_plaintext</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plaintext</span>
    <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">msg</span><span class="p">):</span>
        <span class="c"># ignore all errors</span>
        <span class="k">pass</span>

<span class="n">html_text</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="n">parser</span> <span class="o">=</span> <span class="n">html</span><span class="p">()</span>
<span class="n">parser</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">html_text</span><span class="p">)</span>
<span class="n">parser</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c"># force processing all data</span>
<span class="k">print</span> <span class="n">parser</span><span class="o">.</span><span class="n">get_plaintext</span><span class="p">()</span>

<span class="n">title_s</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r&quot;(?i)&lt;title&gt;\s*(.*?)\s*&lt;/title&gt;&quot;</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
<span class="n">title</span> <span class="o">=</span> <span class="n">title_s</span> <span class="ow">and</span> <span class="n">title_s</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="s">&quot;NO TITLE&quot;</span>

<span class="c"># <font size="-1"><a href="http://pleac.sourceforge.net/include/python/ch20/htitle</span>">download the following standalone program</a></font>
<span class="c">#!/usr/bin/python</span>
<span class="c"># htitlebytes - get html title from URL</span>
<span class="c">#</span>

<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">urllib2</span><span class="o">,</span> <span class="nn">HTMLParser</span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span><span class="o">&lt;=</span><span class="mi">1</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&quot;usage: </span><span class="si">%s</span><span class="s"> url ...&quot;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="c"># simple but pedantic html parser: tpj.com breaks it.</span>
<span class="k">class</span> <span class="nc">html</span><span class="p">(</span><span class="n">HTMLParser</span><span class="o">.</span><span class="n">HTMLParser</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">HTMLParser</span><span class="o">.</span><span class="n">HTMLParser</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_open_tags</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">def</span> <span class="nf">handle_starttag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_open_tags</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tag</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">handle_endtag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_open_tags</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_open_tags</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">handle_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_open_tags</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_open_tags</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">data</span>
    <span class="k">def</span> <span class="nf">__getattr__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">attr</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">attr</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="n">attr</span><span class="p">]</span>
    <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">msg</span><span class="p">):</span>
        <span class="c"># ignore all errors</span>
        <span class="k">pass</span>

<span class="k">for</span> <span class="n">url</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
    <span class="k">print</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">: &quot;</span> <span class="o">%</span> <span class="n">url</span><span class="p">,</span>
    <span class="c"># TODO fake user agent &quot;Schmozilla/v9.17 Platinum&quot;</span>
    <span class="c"># TODO referer &quot;http://wizard.yellowbrick.oz&quot;</span>
    <span class="c"># as we only do http httplib would do also</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">urllib2</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot; </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="c"># title is not in response</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">html</span><span class="p">()</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>  <span class="c"># force processing all data</span>
    <span class="k">print</span> <span class="n">parser</span><span class="o">.</span><span class="n">title</span> </PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1075"
>Finding Stale Links</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c"># <font size="-1"><a href="http://pleac.sourceforge.net/include/python/ch20/churl</span>">download the following standalone program</a></font>
<span class="c">#!/usr/bin/python</span>
<span class="c"># churl - check urls</span>

<span class="kn">import</span> <span class="nn">sys</span>

<span class="c"># head request</span>
<span class="kn">import</span> <span class="nn">urllib</span>
<span class="k">def</span> <span class="nf">valid</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="k">return</span> <span class="mi">1</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>

<span class="c"># parser class as in xurl</span>
<span class="kn">from</span> <span class="nn">HTMLParser</span> <span class="kn">import</span> <span class="n">HTMLParser</span>
<span class="kn">from</span> <span class="nn">sets</span> <span class="kn">import</span> <span class="n">Set</span> <span class="k">as</span> <span class="nb">set</span> <span class="c"># not needed in 2.4</span>
<span class="k">class</span> <span class="nc">myParser</span><span class="p">(</span><span class="n">HTMLParser</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseUrl</span> <span class="o">=</span> <span class="n">url</span><span class="p">[:</span><span class="n">url</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)]</span>
        <span class="n">HTMLParser</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">urls</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">HTMLParser</span><span class="o">.</span><span class="n">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">handle_starttag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">tag</span> <span class="o">==</span> <span class="s">&#39;a&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">attrs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;href&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">attrs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s">&#39;:&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="c"># we need to add the base URL.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">urls</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">baseUrl</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="n">attrs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">urls</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>

<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span><span class="o">&lt;=</span><span class="mi">1</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&quot;usage: </span><span class="si">%s</span><span class="s"> &lt;start_url&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    
<span class="n">base_url</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="k">print</span> <span class="n">base_url</span><span class="o">+</span><span class="s">&quot;:&quot;</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">myParser</span><span class="p">(</span><span class="n">base_url</span><span class="p">)</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">base_url</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">p</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="k">for</span> <span class="n">link</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">urls</span><span class="o">.</span><span class="n">_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
    <span class="n">state</span> <span class="o">=</span> <span class="s">&quot;UNKNOWN URL&quot;</span>
    <span class="k">if</span> <span class="n">link</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;http:&quot;</span><span class="p">):</span>
        <span class="n">state</span> <span class="o">=</span> <span class="s">&quot;BAD&quot;</span>
        <span class="k">if</span> <span class="n">valid</span><span class="p">(</span><span class="n">link</span><span class="p">):</span>
            <span class="n">state</span> <span class="o">=</span> <span class="s">&quot;OK&quot;</span>
    <span class="k">print</span> <span class="s">&quot;  </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">link</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1078"
>Finding Fresh Links</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c"># <font size="-1"><a href="http://pleac.sourceforge.net/include/python/ch20/surl</span>">download the following standalone program</a></font>
<span class="c">#!/usr/bin/python</span>
<span class="c"># surl - sort URLs by their last modification date</span>

<span class="kn">import</span> <span class="nn">urllib</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">Date</span> <span class="o">=</span> <span class="p">{}</span>
<span class="k">while</span> <span class="mi">1</span><span class="p">:</span>
    <span class="c"># we only read from stdin not from argv.</span>
    <span class="n">ln</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">ln</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="n">ln</span> <span class="o">=</span> <span class="n">ln</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">urlopen</span><span class="p">(</span><span class="n">ln</span><span class="p">)</span>
        <span class="n">date</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">mktime</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">info</span><span class="p">()</span><span class="o">.</span><span class="n">getdate</span><span class="p">(</span><span class="s">&quot;date&quot;</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Date</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">date</span><span class="p">):</span>
            <span class="n">Date</span><span class="p">[</span><span class="n">date</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">Date</span><span class="p">[</span><span class="n">date</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ln</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">!</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">ln</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">1</span><span class="p">]))</span>

<span class="n">dates</span> <span class="o">=</span> <span class="n">Date</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<span class="n">dates</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>    <span class="c"># python 2.4 would have sorted</span>
<span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dates</span><span class="p">:</span>
    <span class="k">print</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">  </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%Y-%m-</span><span class="si">%d</span><span class="s"> %H:%M:%S&quot;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">d</span><span class="p">)),</span>
                    <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Date</span><span class="p">[</span><span class="n">d</span><span class="p">]))</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1081"
>Creating HTML Templates</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="kn">import</span> <span class="nn">re</span>

<span class="k">def</span> <span class="nf">template</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">fillings</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">repl</span><span class="p">(</span><span class="n">matchobj</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">fillings</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">matchobj</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">fillings</span><span class="p">[</span><span class="n">matchobj</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)])</span>
        <span class="k">return</span> <span class="s">&quot;&quot;</span>
    <span class="c"># replace quoted words with value from fillings dictionary</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%%</span><span class="s">(.+?)</span><span class="si">%%</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">repl</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">text</span>

<span class="n">fields</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;username&quot;</span><span class="p">:</span><span class="s">&quot;peter&quot;</span><span class="p">,</span> <span class="s">&quot;count&quot;</span><span class="p">:</span><span class="s">&quot;23&quot;</span><span class="p">,</span> <span class="s">&quot;total&quot;</span><span class="p">:</span> <span class="s">&quot;1234&quot;</span><span class="p">}</span>
<span class="k">print</span> <span class="n">template</span><span class="p">(</span><span class="s">&quot;/home/httpd/templates/simple.template&quot;</span><span class="p">,</span> <span class="n">fields</span><span class="p">)</span>

<span class="c"># <font size="-1"><a href="http://pleac.sourceforge.net/include/python/ch20/userrep1</span>">download the following standalone program</a></font>
<span class="c">#!/usr/bin/python</span>
<span class="c"># userrep1 - report duration of user logins using SQL database</span>

<span class="kn">import</span> <span class="nn">MySQLdb</span>
<span class="kn">import</span> <span class="nn">cgi</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="k">def</span> <span class="nf">template</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">fillings</span><span class="p">):</span>
    <span class="n">text</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">def</span> <span class="nf">repl</span><span class="p">(</span><span class="n">matchobj</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">fillings</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">matchobj</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)):</span>
            <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">fillings</span><span class="p">[</span><span class="n">matchobj</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)])</span>
        <span class="k">return</span> <span class="s">&quot;&quot;</span>
    <span class="c"># replace quoted words with value from fillings dictionary</span>
    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%%</span><span class="s">(.+?)</span><span class="si">%%</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">repl</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">text</span>

<span class="n">fields</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">.</span><span class="n">FieldStorage</span><span class="p">()</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">fields</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&quot;user&quot;</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&quot;Content-Type: text/plain</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="k">print</span> <span class="s">&quot;No username&quot;</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_userdata</span><span class="p">(</span><span class="n">username</span><span class="p">):</span>
    <span class="n">db</span> <span class="o">=</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">passwd</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="n">db</span><span class="o">=</span><span class="s">&quot;connections&quot;</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="s">&quot;bert&quot;</span><span class="p">)</span>
    <span class="n">db</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s">&quot;select count(duration) as count,&quot;</span>
            <span class="o">+</span><span class="s">&quot; sum(duration) as total from logins&quot;</span>
            <span class="o">+</span><span class="s">&quot; where username=&#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">username</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">store_result</span><span class="p">()</span><span class="o">.</span><span class="n">fetch_row</span><span class="p">(</span><span class="n">maxrows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s">&quot;username&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">username</span>
    <span class="n">db</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        
<span class="k">print</span> <span class="s">&quot;Content-Type: text/html</span><span class="se">\n</span><span class="s">&quot;</span>

<span class="k">print</span> <span class="n">template</span><span class="p">(</span><span class="s">&quot;report.tpl&quot;</span><span class="p">,</span> <span class="n">get_userdata</span><span class="p">(</span><span class="n">fields</span><span class="p">[</span><span class="s">&quot;user&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>

<span class="c"># @@INCOMPLETE@@</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1084"
>Mirroring Web Pages</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c"># @@INCOMPLETE@@</span>
<span class="c"># @@INCOMPLETE@@</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1087"
>Creating a Robot</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c"># @@INCOMPLETE@@</span>
<span class="c"># @@INCOMPLETE@@</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1090"
>Parsing a Web Server Log File</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span>
<span class="c"># sample data, use ``LOGFILE = open(sys.argv[1])`` in real life</span>
<span class="n">LOGFILE</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s">&#39;127.0.0.1 - - [04/Sep/2005:20:50:31 +0200] &quot;GET /bus HTTP/1.1&quot; 301 303</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span>
        <span class="s">&#39;127.0.0.1 - - [04/Sep/2005:20:50:31 +0200] &quot;GET /bus HTTP/1.1&quot; 301 303 &quot;-&quot; &quot;Opera/8.02 (X11; Linux i686; U; en)&quot;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span>
        <span class="s">&#39;192.168.0.1 - - [04/Sep/2005:20:50:36 +0200] &quot;GET /bus/libjs/layersmenu-library.js HTTP/1.1&quot; 200 6228</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span>
        <span class="s">&#39;192.168.0.1 - - [04/Sep/2005:20:50:36 +0200] &quot;GET /bus/libjs/layersmenu-library.js HTTP/1.1&quot; 200 6228 &quot;http://localhost/bus/&quot; &quot;Opera/8.02 (X11; Linux i686; U; en)&quot;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">,</span>
    <span class="p">]</span>

<span class="kn">import</span> <span class="nn">re</span>

<span class="c"># similar too perl version.</span>
<span class="n">web_server_log_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;^(\S+) (\S+) (\S+) \[([^:]+):(\d+:\d+:\d+) ([^\]]+)\] &quot;(\S+) (.*?) (\S+)&quot; (\S+) (\S+)$&#39;</span><span class="p">)</span>
    
<span class="c"># with group naming.</span>
<span class="n">split_re</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s">r&#39;&#39;&#39;(?x)         # allow nicer formatting (but requires escaping blanks)</span>
<span class="s">                       ^(?P&lt;client&gt;\S+)\s</span>
<span class="s">                       (?P&lt;identuser&gt;\S+)\s</span>
<span class="s">                       (?P&lt;authuser&gt;\S+)\s</span>
<span class="s">                       \[</span>
<span class="s">                         (?P&lt;date&gt;[^:]+):</span>
<span class="s">                         (?P&lt;time&gt;[\d:]+)\s</span>
<span class="s">                         (?P&lt;tz&gt;[^\]]+)</span>
<span class="s">                       \]\s</span>
<span class="s">                       &quot;</span>
<span class="s">                         (?P&lt;method&gt;\S+)\s</span>
<span class="s">                         (?P&lt;url&gt;.*?)\s</span>
<span class="s">                         (?P&lt;protocol&gt;\S+)</span>
<span class="s">                       &quot;\s</span>
<span class="s">                       (?P&lt;status&gt;\S+)\s</span>
<span class="s">                       (?P&lt;bytes&gt;\S+)</span>
<span class="s">                       (?:</span>
<span class="s">                         \s</span>
<span class="s">                         &quot;</span>
<span class="s">                           (?P&lt;referrer&gt;[^&quot;]+)</span>
<span class="s">                         &quot;\s</span>
<span class="s">                         &quot;</span>
<span class="s">                           (?P&lt;agent&gt;[^&quot;]+)</span>
<span class="s">                         &quot;</span>
<span class="s">                       )?&#39;&#39;&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">LOGFILE</span><span class="p">:</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">split_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">f</span><span class="p">:</span>
        <span class="k">print</span> <span class="s">&quot;agent = </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">f</span><span class="o">.</span><span class="n">groupdict</span><span class="p">()[</span><span class="s">&#39;agent&#39;</span><span class="p">]</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1093"
>Processing Server Logs</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c"># @@INCOMPLETE@@</span>
<span class="c"># @@INCOMPLETE@@</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1096"
>Program: htmlsub</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c"># @@INCOMPLETE@@</span>
<span class="c"># @@INCOMPLETE@@</span>
</pre></div>
</body>
</html></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1099"
>Program: hrefsub</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
></PRE
></TD
></TR
></TABLE
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="cgiprogramming.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="a1102.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>CGI Programming</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
>&nbsp;</TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Helpers</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN""http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>CGI Programming</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="PLEAC-Python"
HREF="index.html"><LINK
REL="PREVIOUS"
TITLE="Internet Services"
HREF="internetservices.html"><LINK
REL="NEXT"
TITLE="Web Automation"
HREF="webautomation.html"><style type="text/css">td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
pre { line-height: 125%; }

  </style></head
><BODY TEXT="#cecece" BGCOLOR="#4f6f6f" LINK="#f5deb3" VLINK="#d5ae83"
CLASS="SECT1"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>PLEAC-Python</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="internetservices.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
></TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="webautomation.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="CGIPROGRAMMING"
>19. CGI Programming</A
></H1
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1007"
>Introduction</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c"># Introduction</span>
<span class="c">#</span>
<span class="c"># There is no standard cgi/web framework in python,</span>
<span class="c"># this is reason for ranting now and then.</span>
<span class="c">#</span>
<span class="c"># See `PyWebOff &lt;http://pyre.third-bit.com/pyweb/index.html&gt;`__</span>
<span class="c"># which compares CherryPy, Quixote, Twisted, WebWare and Zope</span>
<span class="c"># Karrigell and print stantements. </span>
<span class="c">#</span>
<span class="c"># Then there is Nevow and Standalone ZPT.</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1010"
>Writing a CGI Script</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c"># Partial implementation of PLEAC Python section 19.1</span>
<span class="c"># Written by Seo Sanghyeon</span>

<span class="c"># Standard CGI module is where PERL shines. Python</span>
<span class="c"># module, cgi, is nothing but a form parser. So it is</span>
<span class="c"># not really fair to compare these two. But I hesitate</span>
<span class="c"># to introduce any non-standard module. After all,</span>
<span class="c"># which one should I choose?</span>

<span class="c"># I would stick to simple print statements. I believe</span>
<span class="c"># the following is close to how these tasks are usually</span>
<span class="c"># done in Python.</span>

<span class="c">#-----------------------------</span>
<span class="c">#!/usr/bin/env python</span>
<span class="c"># hiweb - using FieldStorage class to get at form data</span>

<span class="kn">import</span> <span class="nn">cgi</span>
<span class="n">form</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">.</span><span class="n">FieldStorage</span><span class="p">()</span>

<span class="c"># get a value from the form</span>
<span class="n">value</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="s">&quot;PARAM_NAME&quot;</span><span class="p">)</span>

<span class="c"># print a standard header</span>
<span class="k">print</span> <span class="s">&quot;Content-Type: text/html&quot;</span>
<span class="k">print</span>

<span class="c"># print a document</span>
<span class="k">print</span> <span class="s">&quot;&lt;P&gt;You typed: &lt;TT&gt;</span><span class="si">%s</span><span class="s">&lt;/TT&gt;&lt;/P&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span>
    <span class="n">cgi</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">value</span><span class="p">),</span>
    <span class="p">)</span>

<span class="c">#-----------------------------</span>
<span class="kn">import</span> <span class="nn">cgi</span>
<span class="n">form</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">.</span><span class="n">FieldStorage</span><span class="p">()</span>

<span class="n">who</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="s">&quot;Name&quot;</span><span class="p">)</span>
<span class="n">phone</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="s">&quot;Number&quot;</span><span class="p">)</span>
<span class="n">picks</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">getvalue</span><span class="p">(</span><span class="s">&quot;Choices&quot;</span><span class="p">)</span>

<span class="c"># if you want to assure `picks&#39; to be a list</span>
<span class="n">picks</span> <span class="o">=</span> <span class="n">form</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s">&quot;Choices&quot;</span><span class="p">)</span>

<span class="c">#-----------------------------</span>
<span class="c"># Not Implemented</span>

<span class="c"># To implement -EXPIRES =&gt; &#39;+3d&#39;, I need to study about</span>
<span class="kn">import</span> <span class="nn">cgi</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="n">time_format</span> <span class="o">=</span> <span class="s">&quot;%a, </span><span class="si">%d</span><span class="s"> %b %Y %H:%M:%S %Z&quot;</span>
<span class="k">print</span> <span class="s">&quot;Expires: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="o">+</span><span class="mi">3</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">time_format</span><span class="p">)</span>
        <span class="p">)</span>
<span class="k">print</span> <span class="s">&quot;Date: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="n">time_format</span><span class="p">))</span>
<span class="k">print</span> <span class="s">&quot;Content-Type: text/plain; charset=ISO-8859-1&quot;</span>

<span class="c">#-----------------------------</span>
<span class="c"># NOTES</span>

<span class="c"># CGI::param() is a multi-purpose function. Here I want to</span>
<span class="c"># note which Python functions correspond to it.</span>

<span class="c"># PERL version 5.6.1, CGI.pm version 2.80.</span>
<span class="c"># Python version 2.2.3. cgi.py CVS revision 1.68.</span>

<span class="c"># Assume that `form&#39; is the FieldStorage instance.</span>

<span class="c"># param() with zero argument returns parameter names as</span>
<span class="c"># a list. It is `form.keys()&#39; in Python, following Python&#39;s</span>
<span class="c"># usual mapping interface.</span>

<span class="c"># param() with one argument returns the value of the named</span>
<span class="c"># parameter. It is `form.getvalue()&#39;, but there are some</span>
<span class="c"># twists:</span>

<span class="c"># 1) A single value is passed.</span>
<span class="c"># No problem.</span>

<span class="c"># 2) Multiple values are passed.</span>
<span class="c"># PERL: in LIST context, you get a list. in SCALAR context,</span>
<span class="c">#       you get the first value from the list.</span>
<span class="c"># Python: `form.getvalue()&#39; returns a list if multiple</span>
<span class="c">#         values are passed, a raw value if a single value</span>
<span class="c">#         is passed. With `form.getlist()&#39;, you always</span>
<span class="c">#         get a list. (When a single value is passed, you</span>
<span class="c">#         get a list with one element.) With `form.getfirst()&#39;,</span>
<span class="c">#         you always get a value. (When multiple values are</span>
<span class="c">#         passed, you get the first one.)</span>

<span class="c"># 3) Parameter name is given, but no value is passed.</span>
<span class="c"># PERL: returns an empty string, not undef. POD says this</span>
<span class="c">#       feature is new in 2.63, and was introduced to avoid</span>
<span class="c">#       &quot;undefined value&quot; warnings when running with the</span>
<span class="c">#       -w switch.</span>
<span class="c"># Python: tricky. If you want black values to be retained,</span>
<span class="c">#         you should pass a nonzero `keep_blank_values&#39; keyword</span>
<span class="c">#         argument. Default is not to retain blanks. In case</span>
<span class="c">#         values are not retained, see below.</span>

<span class="c"># 4) Even parameter name is never mentioned.</span>
<span class="c"># PERL: returns undef.</span>
<span class="c"># Python: returns None, or whatever you passed as the second</span>
<span class="c">#         argument, or `default` keyword argument. This is</span>
<span class="c">#         consistent with `get()&#39; method of the Python mapping</span>
<span class="c">#         interface.</span>

<span class="c"># param() with more than one argument modifies the already</span>
<span class="c"># set form data. This functionality is not available in Python</span>
<span class="c"># cgi module.</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1013"
>Redirecting Error Messages</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c"># enable() from &#39;cgitb&#39; module, by default, redirects traceback</span>
<span class="c"># to the browser. It is defined as &#39;enable(display=True, logdir=None,</span>
<span class="c"># context=5)&#39;.</span>

<span class="c"># equivalent to importing CGI::Carp::fatalsToBrowser.</span>
<span class="kn">import</span> <span class="nn">cgitb</span>
<span class="n">cgitb</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>

<span class="c"># to suppress browser output, you should explicitly say so.</span>
<span class="kn">import</span> <span class="nn">cgitb</span>
<span class="n">cgitb</span><span class="o">.</span><span class="n">enable</span><span class="p">(</span><span class="n">display</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>

<span class="c"># equivalent to call CGI::Carp::carpout with temporary files.</span>
<span class="kn">import</span> <span class="nn">cgitb</span>
<span class="n">cgitb</span><span class="o">.</span><span class="n">enable</span><span class="p">(</span><span class="n">logdir</span><span class="o">=</span><span class="s">&quot;/var/local/cgi-logs/&quot;</span><span class="p">)</span>

<span class="c"># Python exception, traceback facilities are much richer than PERL&#39;s</span>
<span class="c"># die and its friends. You can use your custom exception formatter</span>
<span class="c"># by replacing sys.excepthook. (equivalent to CGI::Carp::set_message.)</span>
<span class="c"># Default formatter is available as traceback.print_exc() in pure</span>
<span class="c"># Python. In fact, what cgitb.enable() does is replacing excepthook</span>
<span class="c"># to cgitb.handler(), which knows how to format exceptions to HTML.</span>

<span class="c"># If this is not enough, (usually this is enough!) Python 2.3 comes</span>
<span class="c"># with a new standard module called &#39;logging&#39;, which is complex, but</span>
<span class="c"># very flexible and entirely customizable.</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1016"
>Fixing a 500 Server Error</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">#</span>
<span class="c"># <font size="-1"><a href="http://pleac.sourceforge.net/include/python/ch19/webwhoami</span>">download the following standalone program</a></font>
<span class="c">#!/usr/bin/python</span>
<span class="c"># webwhoami - show web users id</span>
<span class="kn">import</span> <span class="nn">getpass</span>
<span class="k">print</span> <span class="s">&quot;Content-Type: text/plain</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="k">print</span> <span class="s">&quot;Running as </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span>



<span class="c"># STDOUT/ERR flushing</span>
<span class="c">#</span>
<span class="c"># In contrast to what the perl cookbook says, modpython.org tells</span>
<span class="c"># STDERR is buffered too.</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1019"
>Writing a Safe CGI Program</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c"># @@INCOMPLETE@@</span>
<span class="c"># @@INCOMPLETE@@</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1022"
>Making CGI Scripts Efficient</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span>
<span class="c"># use mod_python in the Apache web server.</span>

<span class="c"># Load the module in httpd.conf or apache.conf</span>

<span class="n">LoadModule</span> <span class="n">python_module</span> <span class="n">libexec</span><span class="o">/</span><span class="n">mod_python</span><span class="o">.</span><span class="n">so</span>

<span class="o">&lt;</span><span class="n">Directory</span> <span class="o">/</span><span class="n">some</span><span class="o">/</span><span class="n">directory</span><span class="o">/</span><span class="n">htdocs</span><span class="o">/</span><span class="n">test</span><span class="o">&gt;</span>
    <span class="n">AddHandler</span> <span class="n">mod_python</span> <span class="o">.</span><span class="n">py</span>
    <span class="n">PythonHandler</span> <span class="n">mptest</span>
    <span class="n">PythonDebug</span> <span class="n">On</span>
<span class="o">&lt;/</span><span class="n">Directory</span><span class="o">&gt;</span>

<span class="c"># test.py file in /some/directory/htdocs/test</span>
<span class="kn">from</span> <span class="nn">mod_python</span> <span class="kn">import</span> <span class="n">apache</span>

<span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="n">req</span><span class="p">):</span>
    <span class="n">req</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;Hello World!&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">apache</span><span class="o">.</span><span class="n">OK</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1025"
>Executing Commands Without Shell Escapes</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s">&quot;command </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">files</span><span class="p">)))</span> <span class="c"># UNSAFE</span>

<span class="c"># python doc lib cgi-security it says</span>
<span class="c">#</span>
<span class="c"># To be on the safe side, if you must pass a string gotten from a form to a shell</span>
<span class="c"># command, you should make sure the string contains only alphanumeric characters, dashes,</span>
<span class="c"># underscores, and periods.</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="n">cmd</span> <span class="o">=</span> <span class="s">&quot;command </span><span class="si">%s</span><span class="s"> </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">input</span><span class="p">,</span> <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">files</span><span class="p">))</span>
<span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s">r&quot;[^a-zA-Z0-9._\-]&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&quot;rejected&quot;</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
<span class="n">trans</span> <span class="o">=</span> <span class="n">string</span><span class="o">.</span><span class="n">maketrans</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_letters</span><span class="o">+</span><span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="o">+</span><span class="s">&quot;-_.&quot;</span><span class="p">,</span>

<span class="c"># @@INCOMPLETE@@</span>
<span class="c"># @@INCOMPLETE@@</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1028"
>Formatting Lists and Tables with HTML Shortcuts</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">#-----------------------------</span>
<span class="c"># This uses nevow&#39;s (http://nevow.com) stan; there&#39;s no standard</span>
<span class="c"># way to generate HTML, though there are many implementations of</span>
<span class="c"># this basic idea.</span>
<span class="kn">from</span> <span class="nn">nevow</span> <span class="kn">import</span> <span class="n">tags</span> <span class="k">as</span> <span class="n">T</span>
<span class="k">print</span> <span class="n">T</span><span class="o">.</span><span class="n">ol</span><span class="p">[</span><span class="n">T</span><span class="o">.</span><span class="n">li</span><span class="p">[</span><span class="s">&#39;red&#39;</span><span class="p">],</span> <span class="n">T</span><span class="o">.</span><span class="n">li</span><span class="p">[</span><span class="s">&#39;blue&#39;</span><span class="p">],</span> <span class="n">T</span><span class="o">.</span><span class="n">li</span><span class="p">[</span><span class="s">&#39;green&#39;</span><span class="p">]]</span>
<span class="c"># &lt;ol&gt;&lt;li&gt;red&lt;/li&gt;&lt;li&gt;blue&lt;/li&gt;&lt;li&gt;green&lt;/li&gt;&lt;/ol&gt;</span>

<span class="n">names</span> <span class="o">=</span> <span class="s">&#39;Larry Moe Curly&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<span class="k">print</span> <span class="n">T</span><span class="o">.</span><span class="n">ul</span><span class="p">[</span> <span class="p">[</span><span class="n">T</span><span class="o">.</span><span class="n">li</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&quot;disc&quot;</span><span class="p">)[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">]</span> <span class="p">]</span>
<span class="c"># &lt;ul&gt;&lt;li type=&quot;disc&quot;&gt;Larry&lt;/li&gt;&lt;li type=&quot;disc&quot;&gt;Moe&lt;/li&gt;</span>
<span class="c">#     &lt;li type=&quot;disc&quot;&gt;Curly&lt;/li&gt;&lt;/ul&gt;</span>
<span class="c">#-----------------------------</span>
<span class="k">print</span> <span class="n">T</span><span class="o">.</span><span class="n">li</span><span class="p">[</span><span class="s">&quot;alpha&quot;</span><span class="p">]</span>
<span class="c">#     &lt;li&gt;alpha&lt;/li&gt;</span>

<span class="k">print</span> <span class="n">T</span><span class="o">.</span><span class="n">li</span><span class="p">[</span><span class="s">&#39;alpha&#39;</span><span class="p">],</span> <span class="n">T</span><span class="o">.</span><span class="n">li</span><span class="p">[</span><span class="s">&#39;omega&#39;</span><span class="p">]</span>
<span class="c">#     &lt;li&gt;alpha&lt;/li&gt; &lt;li&gt;omega&lt;/li&gt;</span>
<span class="c">#-----------------------------</span>
<span class="n">states</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s">&quot;Wisconsin&quot;</span><span class="p">:</span>  <span class="p">[</span> <span class="s">&quot;Superior&quot;</span><span class="p">,</span> <span class="s">&quot;Lake Geneva&quot;</span><span class="p">,</span> <span class="s">&quot;Madison&quot;</span> <span class="p">],</span>
    <span class="s">&quot;Colorado&quot;</span><span class="p">:</span>   <span class="p">[</span> <span class="s">&quot;Denver&quot;</span><span class="p">,</span> <span class="s">&quot;Fort Collins&quot;</span><span class="p">,</span> <span class="s">&quot;Boulder&quot;</span> <span class="p">],</span>
    <span class="s">&quot;Texas&quot;</span><span class="p">:</span>      <span class="p">[</span> <span class="s">&quot;Plano&quot;</span><span class="p">,</span> <span class="s">&quot;Austin&quot;</span><span class="p">,</span> <span class="s">&quot;Fort Stockton&quot;</span> <span class="p">],</span>
    <span class="s">&quot;California&quot;</span><span class="p">:</span> <span class="p">[</span> <span class="s">&quot;Sebastopol&quot;</span><span class="p">,</span> <span class="s">&quot;Santa Rosa&quot;</span><span class="p">,</span> <span class="s">&quot;Berkeley&quot;</span> <span class="p">],</span>
<span class="p">}</span>

<span class="k">print</span> <span class="s">&quot;&lt;TABLE&gt; &lt;CAPTION&gt;Cities I Have Known&lt;/CAPTION&gt;&quot;</span><span class="p">;</span>
<span class="k">print</span> <span class="n">T</span><span class="o">.</span><span class="n">tr</span><span class="p">[</span><span class="n">T</span><span class="o">.</span><span class="n">th</span><span class="p">(</span><span class="s">&#39;State&#39;</span><span class="p">),</span> <span class="n">T</span><span class="o">.</span><span class="n">th</span><span class="p">(</span><span class="s">&#39;Cities&#39;</span><span class="p">)]</span>
<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
    <span class="k">print</span> <span class="n">T</span><span class="o">.</span><span class="n">tr</span><span class="p">[</span> <span class="p">[</span><span class="n">T</span><span class="o">.</span><span class="n">th</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span><span class="n">T</span><span class="o">.</span><span class="n">td</span><span class="p">(</span><span class="n">city</span><span class="p">)</span> <span class="k">for</span> <span class="n">city</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="n">k</span><span class="p">])]</span> <span class="p">]</span>
<span class="k">print</span> <span class="s">&quot;&lt;/TABLE&gt;&quot;</span><span class="p">;</span>
<span class="c">#-----------------------------</span>
<span class="c"># &lt;TABLE&gt; &lt;CAPTION&gt;Cities I Have Known&lt;/CAPTION&gt;</span>
<span class="c">#</span>
<span class="c">#     &lt;TR&gt;&lt;TH&gt;State&lt;/TH&gt; &lt;TH&gt;Cities&lt;/TH&gt;&lt;/TR&gt;</span>
<span class="c">#</span>
<span class="c">#     &lt;TR&gt;&lt;TH&gt;California&lt;/TH&gt; &lt;TD&gt;Berkeley&lt;/TD&gt; &lt;TD&gt;Santa Rosa&lt;/TD&gt;</span>
<span class="c">#</span>
<span class="c">#         &lt;TD&gt;Sebastopol&lt;/TD&gt; &lt;/TR&gt;</span>
<span class="c">#</span>
<span class="c">#     &lt;TR&gt;&lt;TH&gt;Colorado&lt;/TH&gt; &lt;TD&gt;Boulder&lt;/TD&gt; &lt;TD&gt;Denver&lt;/TD&gt;</span>
<span class="c">#</span>
<span class="c">#         &lt;TD&gt;Fort Collins&lt;/TD&gt; &lt;/TR&gt;</span>
<span class="c">#</span>
<span class="c">#     &lt;TR&gt;&lt;TH&gt;Texas&lt;/TH&gt; &lt;TD&gt;Austin&lt;/TD&gt; &lt;TD&gt;Fort Stockton&lt;/TD&gt;</span>
<span class="c">#</span>
<span class="c">#         &lt;TD&gt;Plano&lt;/TD&gt;&lt;/TR&gt;</span>
<span class="c">#</span>
<span class="c">#     &lt;TR&gt;&lt;TH&gt;Wisconsin&lt;/TH&gt; &lt;TD&gt;Lake Geneva&lt;/TD&gt; &lt;TD&gt;Madison&lt;/TD&gt;</span>
<span class="c">#</span>
<span class="c">#         &lt;TD&gt;Superior&lt;/TD&gt;&lt;/TR&gt;</span>
<span class="c">#</span>
<span class="c"># &lt;/TABLE&gt;</span>
<span class="c">#-----------------------------</span>
<span class="k">print</span> <span class="n">T</span><span class="o">.</span><span class="n">table</span><span class="p">[</span>
        <span class="p">[</span><span class="n">T</span><span class="o">.</span><span class="n">caption</span><span class="p">[</span><span class="s">&#39;Cities I have Known&#39;</span><span class="p">],</span>
         <span class="n">T</span><span class="o">.</span><span class="n">tr</span><span class="p">[</span><span class="n">T</span><span class="o">.</span><span class="n">th</span><span class="p">[</span><span class="s">&#39;State&#39;</span><span class="p">],</span> <span class="n">T</span><span class="o">.</span><span class="n">th</span><span class="p">[</span><span class="s">&#39;Cities&#39;</span><span class="p">]]</span> <span class="p">]</span> <span class="o">+</span>
        <span class="p">[</span><span class="n">T</span><span class="o">.</span><span class="n">tr</span><span class="p">[</span> <span class="p">[</span><span class="n">T</span><span class="o">.</span><span class="n">th</span><span class="p">(</span><span class="n">k</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span><span class="n">T</span><span class="o">.</span><span class="n">td</span><span class="p">(</span><span class="n">city</span><span class="p">)</span> <span class="k">for</span> <span class="n">city</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">states</span><span class="p">[</span><span class="n">k</span><span class="p">])]]</span>
         <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">states</span><span class="o">.</span><span class="n">keys</span><span class="p">())]]</span>
<span class="c">#-----------------------------</span>
<span class="c"># salcheck - check for salaries</span>
<span class="kn">import</span> <span class="nn">MySQLdb</span>
<span class="kn">import</span> <span class="nn">cgi</span>

<span class="n">form</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">.</span><span class="n">FieldStorage</span><span class="p">()</span>

<span class="k">if</span> <span class="s">&#39;limit&#39;</span> <span class="ow">in</span> <span class="n">form</span><span class="p">:</span>
    <span class="n">limit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;limit&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">limit</span> <span class="o">=</span> <span class="s">&#39;&#39;</span>

<span class="c"># There&#39;s not a good way to start an HTML/XML construct with stan</span>
<span class="c"># without completing it.</span>
<span class="k">print</span> <span class="s">&#39;&lt;html&gt;&lt;head&gt;&lt;title&gt;Salary Query&lt;/title&gt;&lt;/head&gt;&lt;body&gt;&#39;</span>
<span class="k">print</span> <span class="n">T</span><span class="o">.</span><span class="n">h1</span><span class="p">[</span><span class="s">&#39;Search&#39;</span><span class="p">]</span>
<span class="k">print</span> <span class="s">&#39;&lt;form&gt;&#39;</span>
<span class="k">print</span> <span class="n">T</span><span class="o">.</span><span class="n">p</span><span class="p">[</span><span class="s">&#39;Enter minimum salary&#39;</span><span class="p">,</span>
          <span class="n">T</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&quot;text&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&quot;limit&quot;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="n">limit</span><span class="p">)]</span>
<span class="k">print</span> <span class="n">T</span><span class="o">.</span><span class="n">input</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s">&quot;submit&quot;</span><span class="p">)</span>
<span class="k">print</span> <span class="s">&#39;&lt;/form&gt;&#39;</span>

<span class="k">if</span> <span class="n">limit</span><span class="p">:</span>
    <span class="n">dbconn</span> <span class="o">=</span> <span class="n">MySQLdb</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">db</span><span class="o">=</span><span class="s">&#39;somedb&#39;</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s">&#39;server.host.dom&#39;</span><span class="p">,</span>
                             <span class="n">port</span><span class="o">=</span><span class="mi">3306</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="s">&#39;username&#39;</span><span class="p">,</span>
                             <span class="n">passwd</span><span class="o">=</span><span class="s">&#39;password&#39;</span><span class="p">)</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">dbconn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;&quot;&quot;</span>
<span class="s">    SELECT name, salary FROM employees</span>
<span class="s">    WHERE salary &gt; </span><span class="si">%s</span><span class="s">&quot;&quot;&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">limit</span><span class="p">,))</span>

    <span class="k">print</span> <span class="n">T</span><span class="o">.</span><span class="n">h1</span><span class="p">[</span><span class="s">&quot;Results&quot;</span><span class="p">]</span>
    <span class="k">print</span> <span class="s">&quot;&lt;TABLE BORDER=1&gt;&quot;</span>

    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
        <span class="k">print</span> <span class="n">T</span><span class="o">.</span><span class="n">tr</span><span class="p">[</span> <span class="p">[</span><span class="n">T</span><span class="o">.</span><span class="n">td</span><span class="p">(</span><span class="n">cell</span><span class="p">)</span> <span class="k">for</span> <span class="n">cell</span> <span class="ow">in</span> <span class="n">row</span><span class="p">]</span> <span class="p">]</span>

    <span class="k">print</span> <span class="s">&quot;&lt;/TABLE&gt;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
    <span class="n">cursor</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="n">dbconn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="k">print</span> <span class="s">&#39;&lt;/body&gt;&lt;/html&gt;&#39;</span>
<span class="c">#-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1031"
>Redirecting to a Different Location</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">#-----------------------------</span>
<span class="n">url</span> <span class="o">=</span> <span class="s">&quot;http://python.org/pypi&quot;</span>
<span class="k">print</span> <span class="s">&quot;Location: </span><span class="si">%s</span><span class="se">\n</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">url</span>
<span class="k">raise</span> <span class="ne">SystemExit</span>
<span class="c">#-----------------------------</span>
<span class="c"># oreobounce - set a cookie and redirect the browser</span>
<span class="kn">import</span> <span class="nn">Cookie</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">c</span> <span class="o">=</span> <span class="n">Cookie</span><span class="o">.</span><span class="n">SimpleCookie</span><span class="p">()</span>
<span class="n">c</span><span class="p">[</span><span class="s">&#39;filling&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;vanilla cr?me&#39;</span>
<span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="n">future</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="p">(</span><span class="mi">60</span><span class="o">*</span><span class="mi">60</span><span class="o">*</span><span class="mi">24</span><span class="o">*</span><span class="mi">30</span><span class="p">)</span> <span class="c"># 3 months</span>
<span class="n">expire_date</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&#39;%a </span><span class="si">%d</span><span class="s"> %b %Y %H:%M:%S GMT&#39;</span><span class="p">,</span> <span class="n">future</span><span class="p">)</span>
<span class="n">c</span><span class="p">[</span><span class="s">&#39;filling&#39;</span><span class="p">][</span><span class="s">&#39;expires&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">expire_date</span>
<span class="n">c</span><span class="p">[</span><span class="s">&#39;filling&#39;</span><span class="p">][</span><span class="s">&#39;domain&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&#39;.python.org&#39;</span>

<span class="n">whither</span>  <span class="o">=</span> <span class="s">&quot;http://somewhere.python.org/nonesuch.html&quot;</span>

<span class="c"># Prints the cookie header</span>
<span class="k">print</span> <span class="s">&#39;Status: 302 Moved Temporarily&#39;</span>
<span class="k">print</span> <span class="n">c</span>
<span class="k">print</span> <span class="s">&#39;Location:&#39;</span><span class="p">,</span> <span class="n">whither</span>
<span class="k">print</span>

<span class="c">#-----------------------------</span>
<span class="c">#Status: 302 Moved Temporarily</span>
<span class="c">#Set-Cookie: filling=vanilla%20cr%E4me; domain=.perl.com;</span>
<span class="c">#    expires=Tue, 21-Jul-1998 11:58:55 GMT</span>
<span class="c">#Location: http://somewhere.perl.com/nonesuch.html</span>
<span class="c">#-----------------------------</span>
<span class="c"># os_snipe - redirect to a Jargon File entry about current OS</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">re</span>
<span class="nb">dir</span> <span class="o">=</span> <span class="s">&#39;http://www.wins.uva.nl/</span><span class="si">%7E</span><span class="s">mes/jargon&#39;</span>
<span class="n">matches</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="s">r&#39;Mac&#39;</span><span class="p">,</span> <span class="s">&#39;m/Macintrash.html&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">r&#39;Win(dows )?NT&#39;</span><span class="p">,</span> <span class="s">&#39;e/evilandrude.html&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">r&#39;Win|MSIE|WebTV&#39;</span><span class="p">,</span> <span class="s">&#39;m/MicroslothWindows.html&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">r&#39;Linux&#39;</span><span class="p">,</span> <span class="s">&#39;l/Linux.html&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">r&#39;HP-UX&#39;</span><span class="p">,</span> <span class="s">&#39;h/HP-SUX.html&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="s">r&#39;SunOS&#39;</span><span class="p">,</span> <span class="s">&#39;s/ScumOS.html&#39;</span><span class="p">),</span>
    <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">&#39;a/AppendixB.html&#39;</span><span class="p">),</span>
    <span class="p">]</span>

<span class="k">for</span> <span class="n">regex</span><span class="p">,</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">matches</span><span class="p">:</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">regex</span><span class="p">:</span> <span class="c"># default</span>
        <span class="k">break</span>
    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&#39;HTTP_USER_AGENT&#39;</span><span class="p">]):</span>
        <span class="k">break</span>
<span class="k">print</span> <span class="s">&#39;Location: </span><span class="si">%s</span><span class="s">/</span><span class="si">%s</span><span class="se">\n</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">dir</span><span class="p">,</span> <span class="n">page</span><span class="p">)</span>
<span class="c">#-----------------------------</span>
<span class="c"># There&#39;s no special way to print headers</span>
<span class="k">print</span> <span class="s">&#39;Status: 204 No response&#39;</span>
<span class="k">print</span>
<span class="c">#-----------------------------</span>
<span class="c">#Status: 204 No response</span>
<span class="c">#-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1034"
>Debugging the Raw HTTP Exchange</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c"># <font size="-1"><a href="http://pleac.sourceforge.net/include/python/ch19/dummyhttpd</span>">download the following standalone program</a></font>
<span class="c">#!/usr/bin/python</span>
<span class="c"># dummyhttpd - start a HTTP daemon and print what the client sends</span>

<span class="kn">import</span> <span class="nn">SocketServer</span>
<span class="c"># or use BaseHTTPServer, SimpleHTTPServer, CGIHTTPServer</span>

<span class="k">def</span> <span class="nf">adr_str</span><span class="p">(</span><span class="n">adr</span><span class="p">):</span>
    <span class="k">return</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">:</span><span class="si">%d</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">adr</span>

<span class="k">class</span> <span class="nc">RequestHandler</span><span class="p">(</span><span class="n">SocketServer</span><span class="o">.</span><span class="n">BaseRequestHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span> <span class="s">&quot;client access from </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="n">adr_str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">client_address</span><span class="p">)</span>
        <span class="k">print</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">recv</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s">&quot;Content-Type: text/plain</span><span class="se">\n</span><span class="s">&quot;</span>
                          <span class="s">&quot;Server: dymmyhttpd/1.0.0</span><span class="se">\n</span><span class="s">&quot;</span>
                          <span class="s">&quot;</span><span class="se">\n</span><span class="s">...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="n">adr</span> <span class="o">=</span> <span class="p">(</span><span class="s">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">8001</span><span class="p">)</span>
<span class="k">print</span> <span class="s">&quot;Please contact me at &lt;http://</span><span class="si">%s</span><span class="s">&gt;&quot;</span> <span class="o">%</span> <span class="n">adr_str</span><span class="p">(</span><span class="n">adr</span><span class="p">)</span>
<span class="n">server</span> <span class="o">=</span> <span class="n">SocketServer</span><span class="o">.</span><span class="n">TCPServer</span><span class="p">(</span><span class="n">adr</span><span class="p">,</span> <span class="n">RequestHandler</span><span class="p">)</span>
<span class="n">server</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
<span class="n">server</span><span class="o">.</span><span class="n">server_close</span><span class="p">()</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1037"
>Managing Cookies</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span>
<span class="kn">import</span> <span class="nn">Cookie</span>
<span class="n">cookies</span> <span class="o">=</span> <span class="n">Cookie</span><span class="o">.</span><span class="n">SimpleCookie</span><span class="p">()</span>
<span class="c"># SimpleCookie is more secure, but does not support all characters.</span>
<span class="n">cookies</span><span class="p">[</span><span class="s">&quot;preference-name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;whatever you&#39;d like&quot;</span> 
<span class="k">print</span> <span class="n">cookies</span>

<span class="c"># <font size="-1"><a href="http://pleac.sourceforge.net/include/python/ch19/ic_cookies</span>">download the following standalone program</a></font>
<span class="c">#!/usr/bin/python</span>
<span class="c"># ic_cookies - sample CGI script that uses a cookie</span>

<span class="kn">import</span> <span class="nn">cgi</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">Cookie</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="n">cookname</span> <span class="o">=</span> <span class="s">&quot;favorite-ice-cream&quot;</span>  <span class="c"># SimpleCookie does not support blanks</span>
<span class="n">fieldname</span> <span class="o">=</span> <span class="s">&quot;flavor&quot;</span>

<span class="n">cookies</span> <span class="o">=</span> <span class="n">Cookie</span><span class="o">.</span><span class="n">SimpleCookie</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;HTTP_COOKIE&quot;</span><span class="p">,</span><span class="s">&quot;&quot;</span><span class="p">))</span>
<span class="k">if</span> <span class="n">cookies</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">cookname</span><span class="p">):</span>
    <span class="n">favorite</span> <span class="o">=</span> <span class="n">cookies</span><span class="p">[</span><span class="n">cookname</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">favorite</span> <span class="o">=</span> <span class="s">&quot;mint&quot;</span>

<span class="n">form</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">.</span><span class="n">FieldStorage</span><span class="p">()</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">form</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="n">fieldname</span><span class="p">):</span>
    <span class="k">print</span> <span class="s">&quot;Content-Type: text/html&quot;</span>
    <span class="k">print</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="k">print</span> <span class="s">&quot;&lt;html&gt;&lt;body&gt;&quot;</span>
    <span class="k">print</span> <span class="s">&quot;&lt;h1&gt;Hello Ice Cream&lt;/h1&gt;&quot;</span>
    <span class="k">print</span> <span class="s">&quot;&lt;form&gt;&quot;</span>
    <span class="k">print</span> <span class="s">&#39;Please select a flavor: &lt;input type=&quot;text&quot; name=&quot;</span><span class="si">%s</span><span class="s">&quot; value=&quot;</span><span class="si">%s</span><span class="s">&quot; /&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">fieldname</span><span class="p">,</span> <span class="n">favorite</span> <span class="p">)</span>
    <span class="k">print</span> <span class="s">&quot;&lt;/form&gt;&quot;</span>
    <span class="k">print</span> <span class="s">&quot;&lt;hr /&gt;&quot;</span>
    <span class="k">print</span> <span class="s">&quot;&lt;/body&gt;&lt;/html&gt;&quot;</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">favorite</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="n">fieldname</span><span class="p">]</span><span class="o">.</span><span class="n">value</span>
    <span class="n">cookies</span><span class="p">[</span><span class="n">cookname</span><span class="p">]</span> <span class="o">=</span> <span class="n">favorite</span>
    <span class="n">expire</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="mi">730</span><span class="p">)</span>
    <span class="n">cookies</span><span class="p">[</span><span class="n">cookname</span><span class="p">][</span><span class="s">&quot;expires&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">expire</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%a, </span><span class="si">%d</span><span class="s"> %b %Y %H:00:00 GMT&quot;</span><span class="p">)</span>
    <span class="n">cookies</span><span class="p">[</span><span class="n">cookname</span><span class="p">][</span><span class="s">&quot;path&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;/&quot;</span>
    <span class="k">print</span> <span class="s">&quot;Content-Type: text/html&quot;</span>
    <span class="k">print</span> <span class="n">cookies</span>
    <span class="k">print</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
    <span class="k">print</span> <span class="s">&quot;&lt;html&gt;&lt;body&gt;&quot;</span>
    <span class="k">print</span> <span class="s">&quot;&lt;h1&gt;Hello Ice Cream&lt;/h1&gt;&quot;</span>
    <span class="k">print</span> <span class="s">&quot;&lt;p&gt;You chose as your favorite flavor </span><span class="se">\&quot;</span><span class="si">%s</span><span class="se">\&quot;</span><span class="s">&lt;/p&gt;&quot;</span> <span class="o">%</span> <span class="n">favorite</span>
    <span class="k">print</span> <span class="s">&quot;&lt;/body&gt;&lt;/html&gt;&quot;</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1040"
>Creating Sticky Widgets</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c"># @@INCOMPLETE@@</span>
<span class="c"># @@INCOMPLETE@@</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1043"
>Writing a Multiscreen CGI Script</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c"># @@INCOMPLETE@@</span>
<span class="c"># @@INCOMPLETE@@</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1046"
>Saving a Form to a File or Mail Pipe</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c">#-----------------------------</span>
<span class="c"># first open and exclusively lock the file</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">cgi</span><span class="o">,</span> <span class="nn">fcntl</span><span class="o">,</span> <span class="nn">cPickle</span>
<span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;/tmp/formlog&#39;</span><span class="p">,</span> <span class="s">&#39;ab&#39;</span><span class="p">)</span>
<span class="n">fcntl</span><span class="o">.</span><span class="n">flock</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">LOCK_EX</span><span class="p">)</span>

<span class="n">form</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">.</span><span class="n">FieldStorage</span><span class="p">()</span>
<span class="c"># This doesn&#39;t produce a readable file; we copy the environment so</span>
<span class="c"># that we save a plain dictionary (os.environ is a dictionary-like</span>
<span class="c"># object).</span>
<span class="n">cPickle</span><span class="o">.</span><span class="n">dump</span><span class="p">((</span><span class="n">form</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span> <span class="n">fh</span><span class="p">)</span>
<span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="c">#-----------------------------</span>
<span class="kn">import</span> <span class="nn">cgi</span><span class="o">,</span> <span class="nn">smtplib</span><span class="o">,</span> <span class="nn">sys</span>

<span class="n">form</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">.</span><span class="n">FieldStorage</span><span class="p">()</span>
<span class="n">email</span> <span class="o">=</span> <span class="s">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s">From: %S</span>
<span class="s">To: hisname@hishost.com</span>
<span class="s">Subject: mailed form submission</span>

<span class="s">&quot;&quot;&quot;</span> <span class="o">%</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">form</span><span class="p">:</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">form</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">values</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">values</span><span class="p">:</span>
        <span class="n">email</span> <span class="o">+=</span> <span class="s">&#39;</span><span class="se">\n</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

<span class="n">server</span> <span class="o">=</span> <span class="n">smtplib</span><span class="o">.</span><span class="n">SMTP</span><span class="p">(</span><span class="s">&#39;localhost&#39;</span><span class="p">)</span>
<span class="n">server</span><span class="o">.</span><span class="n">sendmail</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="s">&#39;hisname@hishost.com&#39;</span><span class="p">],</span> <span class="n">email</span><span class="p">)</span>
<span class="n">server</span><span class="o">.</span><span class="n">quit</span><span class="p">()</span>
<span class="c">#-----------------------------</span>
<span class="c"># @@INCOMPLETE@@ I don&#39;t get the point of these:</span>
<span class="c"># param(&quot;_timestamp&quot;, scalar localtime);</span>
<span class="c"># param(&quot;_environs&quot;, %ENV);</span>
<span class="c">#-----------------------------</span>
<span class="kn">import</span> <span class="nn">fcntl</span><span class="o">,</span> <span class="nn">cPickle</span>
<span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="s">&#39;/tmp/formlog&#39;</span><span class="p">,</span> <span class="s">&#39;rb&#39;</span><span class="p">)</span>
<span class="n">fcntl</span><span class="o">.</span><span class="n">flock</span><span class="p">(</span><span class="n">fh</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">LOCK_SH</span><span class="p">)</span>

<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">form</span><span class="p">,</span> <span class="n">environ</span> <span class="o">=</span> <span class="n">cPickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">EOFError</span><span class="p">:</span>
        <span class="k">break</span>
    <span class="k">if</span> <span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;REMOTE_HOST&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s">&#39;perl.com&#39;</span><span class="p">):</span>
        <span class="k">continue</span>
    <span class="k">if</span> <span class="s">&#39;items requested&#39;</span> <span class="ow">in</span> <span class="n">form</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">(</span><span class="n">form</span><span class="p">[</span><span class="s">&#39;items requested&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<span class="k">print</span> <span class="s">&#39;Total orders:&#39;</span><span class="p">,</span> <span class="n">count</span>
<span class="c">#-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1049"
>Program: chemiserie</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="c"></span><span class="c"># @@INCOMPLETE@@</span>
<span class="c"># @@INCOMPLETE@@</span></PRE
></TD
></TR
></TABLE
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="internetservices.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="webautomation.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Internet Services</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
>&nbsp;</TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Web Automation</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>
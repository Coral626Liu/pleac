<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN""http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>CGI Programming</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="PLEAC-Ruby"
HREF="index.html"><LINK
REL="PREVIOUS"
TITLE="Internet Services"
HREF="internetservices.html"><LINK
REL="NEXT"
TITLE="Web Automation"
HREF="webautomation.html"><style type="text/css">td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
pre { line-height: 125%; }

  </style></head
><BODY TEXT="#cecece" BGCOLOR="#4f6f6f" LINK="#f5deb3" VLINK="#d5ae83"
CLASS="SECT1"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>PLEAC-Ruby</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="internetservices.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
></TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="webautomation.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="CGIPROGRAMMING"
>19. CGI Programming</A
></H1
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1007"
>Introduction</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">#-----------------------------</span>
<span class="cp"># http://www.perl.com/CPAN/</span>
<span class="cp"># http://www.perl.com:8001/bad/mojo.html</span>
<span class="cp"># ftp://gatekeeper.dec.com/pub/misc/netlib.tar.Z</span>
<span class="cp"># ftp://anonymous@myplace:gatekeeper.dec.com/pub/misc/netlib.tar.Z</span>
<span class="cp"># file:///etc/motd</span>
<span class="cp">#-----------------------------</span>
<span class="cp"># http://mox.perl.com/cgi-bin/program?name=Johann&amp;born=1685</span>
<span class="cp">#-----------------------------</span>
<span class="cp"># http://mox.perl.com/cgi-bin/program</span>
<span class="cp">#-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1010"
>Writing a CGI Script</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">#!/usr/local/bin/ruby -w</span>
<span class="cp"># hiweb - load CGI class to decode information given by web server</span>

<span class="cp">require &#39;cgi&#39;</span>

<span class="cp">cgi = CGI.new(&#39;html3&#39;)</span>

<span class="cp"># get a parameter from a form</span>
<span class="cp">value = cgi.params[&#39;PARAM_NAME&#39;][0]</span>

<span class="cp"># output a document</span>
<span class="cp">cgi.out {</span>
<span class="cp">    cgi.html {</span>
<span class="cp">        cgi.head { cgi.title { &quot;Howdy there!&quot; } } +</span>
<span class="cp">            cgi.body { cgi.p { &quot;You typed: &quot; + cgi.tt {</span>
<span class="cp">                    CGI.escapeHTML(value) } } }</span>
<span class="cp">    }</span>
<span class="cp">}</span>

<span class="cp">require &#39;cgi&#39;</span>
<span class="cp">cgi = CGI.new</span>
<span class="cp">who   = cgi.param[&quot;Name&quot;][0]     # first param in list</span>
<span class="cp">phone = cgi.param[&quot;Number&quot;][0]</span>
<span class="cp">picks = cgi.param[&quot;Choices&quot;]     # complete list</span>

<span class="cp">print cgi.header( &#39;type&#39; =&gt; &#39;text/plain&#39;,</span>
<span class="cp">                  &#39;expires&#39; =&gt; Time.now + (3 * 24 * 60 * 60) )</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1013"
>Redirecting Error Messages</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1016"
>Fixing a 500 Server Error</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">#!/usr/local/bin/ruby -w</span>
<span class="cp"># webwhoami - show web user&#39;s id</span>
<span class="cp">require &#39;etc&#39;</span>
<span class="cp">print &quot;Content-Type: text/plain\n\n&quot;</span>
<span class="cp">print &quot;Running as &quot; + Etc.getpwuid.name + &quot;\n&quot;</span>

<span class="cp"># % ruby -wc cgi-script     # just check syntax</span>

<span class="cp"># % ruby -w  cgi-script     # params from stdin</span>
<span class="cp"># (offline mode: enter name=value pairs on standard input)</span>
<span class="cp"># name=joe</span>
<span class="cp"># number=10</span>
<span class="cp"># ^D</span>

<span class="cp"># % ruby -w  cgi-script name=joe number=10     # run with mock form input</span>
<span class="cp"># % ruby -d  cgi-script name=joe number=10     # ditto, under the debugger</span>

<span class="cp"># POST method script in csh</span>
<span class="cp"># % (setenv HTTP_METHOD POST; ruby -w cgi-script name=joe number=10)</span>
<span class="cp"># POST method script in sh</span>
<span class="cp"># % HTTP_METHOD=POST perl -w cgi-script name=joe number=10</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1019"
>Writing a Safe CGI Program</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp"># ruby has several security levels, the level &quot;1&quot; is similar to perls taint mode.</span>
<span class="cp"># It can be switched on by providing the -T command line parameter</span>
<span class="cp"># or by setting $SAFE to 1. Setting $SAFE to 2,3 or 4 restricts possible</span>
<span class="cp"># harmful operations further.</span>

<span class="cp">#!/usr/bin/ruby -T</span>
<span class="cp">$SAFE = 1</span>
<span class="cp">File.open(ARGV[0], &quot;w&quot;)</span>
<span class="cp"># ruby warns with:</span>
<span class="cp"># taint1.rb:2:in `initialize&#39;: Insecure operation - initialize (SecurityError)</span>

<span class="cp">$SAFE = 1</span>
<span class="cp">file = ARGV[0]</span>
<span class="cp">unless /^([\w.-]+)$/.match(file)</span>
<span class="cp">    raise &quot;filename #{file} has invalid characters&quot;</span>
<span class="cp">end</span>
<span class="cp">file = $1</span>
<span class="cp"># In ruby, even the back reference from a regular expression stays tainted.</span>
<span class="cp"># you need to explicitly untaint the variable:</span>
<span class="cp">file.untaint</span>
<span class="cp">File.open(file, &quot;w&quot;)</span>

<span class="cp"># Race condition exists like in perl:</span>
<span class="cp">unless File.exists(filename)        # Wrong because of race condition</span>
<span class="cp">    File.open(filename, &quot;w&quot;)</span>
<span class="cp">end</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1022"
>Making CGI Scripts Efficient</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1025"
>Executing Commands Without Shell Escapes</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1028"
>Formatting Lists and Tables with HTML Shortcuts</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1031"
>Redirecting to a Different Location</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">url = &quot;http://pleac.sourceforge.net/pleac_ruby/&quot;</span>
<span class="cp">print &quot;Location: #{url}\r\n\r\n&quot;</span>
<span class="cp">exit</span>

<span class="cp">#!/usr/bin/ruby</span>
<span class="cp">require &#39;cgi&#39;</span>

<span class="cp">cgi = CGI.new</span>
<span class="cp">oreo = CGI::Cookie.new(&#39;name&#39; =&gt; &#39;filling&#39;,</span>
<span class="cp">                       &#39;value&#39; =&gt; &#39;vanilla creme&#39;,</span>
<span class="cp">                       &#39;expires&#39; =&gt; Time.now + (3 * 30 * 24 * 60 * 60),</span>
<span class="cp">                       &#39;domain&#39; =&gt; &#39;.pleac.sourceforge.net&#39;)</span>

<span class="cp">whither = &#39;http://pleac.sourceforge.net/pleac_ruby/cgiprogramming.html&#39;</span>

<span class="cp">cgi.out(&#39;cookie&#39; =&gt; oreo,</span>
<span class="cp">        &#39;Location&#39; =&gt; whither){&quot;&quot;}</span>

<span class="cp">#!/usr/bin/ruby</span>
<span class="cp"># os_snipe - redirect to a Jargon File entry about current OS</span>
<span class="cp">dir = &#39;http://www.elsewhere.org/jargon/html/entry&#39;</span>

<span class="cp">agent = ENV[&#39;HTTP_USER_AGENT&#39;]</span>

<span class="cp">page = case</span>
<span class="cp">    when agent =~ /Mac/: &#39;Macintrash.html&#39;</span>
<span class="cp">    when agent =~ /Win(dows )?NT/: &#39;evil_and_rude.html&#39;</span>
<span class="cp">    when agent =~ /Win|MSIE|WebTV/: &#39;Microsloth_Windows.html&#39;</span>
<span class="cp">    when agent =~ /Linux/: &#39;Linux.html&#39;</span>
<span class="cp">    when agent =~ /HP-UX/: &#39;HP-SUX.html&#39;</span>
<span class="cp">    when agent =~ /SunOS/: &#39;ScumOS.html&#39;</span>
<span class="cp">    else &#39;Appendix_B.html&#39;</span>
<span class="cp">end</span>

<span class="cp">print &quot;Location: #{dir}/#{page}\n\n&quot;</span>

<span class="cp">require &#39;cgi&#39;</span>
<span class="cp">cgi = CGI.new</span>
<span class="cp">cgi.out(&#39;status&#39; =&gt; &#39;204 No response&#39;){&quot;&quot;}</span>
<span class="cp"># this produces:</span>
<span class="cp"># Status: 204 No response</span>
<span class="cp"># Content-Type: text/html</span>
<span class="cp"># Content-Length: 0</span>
<span class="cp"># &lt;blank line here&gt;</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1034"
>Debugging the Raw HTTP Exchange</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1037"
>Managing Cookies</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">preference_value = cgi.cookies[&quot;preference name&quot;][0]</span>

<span class="cp">packed_cookie = CGI::Cookie.new(&quot;name&quot; =&gt; &quot;preference name&quot;,</span>
<span class="cp">                                &quot;value&quot; =&gt; &quot;whatever you&#39;d like&quot;,</span>
<span class="cp">                                &quot;expires&quot; =&gt; Time.local(Time.now.year + 2,</span>
<span class="cp">    Time.now.mon, Time.now.day, Time.now.hour, Time.now.min, Time.now.sec) )</span>

<span class="cp">cgi.header(&quot;cookie&quot; =&gt; [packed_cookie])</span>

<span class="cp">#!/usr/local/bin/ruby -w</span>
<span class="cp"># ic_cookies - sample CGI script that uses a cookie</span>
<span class="cp">require &#39;cgi&#39;</span>

<span class="cp">cgi = CGI.new(&#39;html3&#39;)</span>

<span class="cp">cookname = &quot;favorite ice cream&quot;</span>
<span class="cp">favorite = cgi.params[&quot;flavor&quot;][0]</span>
<span class="cp">tasty    = cgi.cookies[cookname][0] || &#39;mint&#39;</span>

<span class="cp">unless favorite</span>
<span class="cp">    cgi.out {</span>
<span class="cp">        cgi.html {</span>
<span class="cp">            cgi.head { cgi.title { &quot;Ice Cookies&quot; } } +</span>
<span class="cp">            cgi.body {</span>
<span class="cp">                cgi.h1 { &quot;Hello Ice Cream&quot; } +</span>
<span class="cp">                cgi.hr +</span>
<span class="cp">                cgi.form {</span>
<span class="cp">                    cgi.p { &quot;Please select a flavor: &quot; +</span>
<span class="cp">                            cgi.text_field(&quot;flavor&quot;, tasty ) }</span>
<span class="cp">                } +</span>
<span class="cp">                cgi.hr</span>
<span class="cp">            }</span>
<span class="cp">        }</span>
<span class="cp">    }</span>
<span class="cp">else</span>
<span class="cp">    cookie = CGI::Cookie.new( &quot;name&quot;    =&gt; cookname,</span>
<span class="cp">                              &quot;value&quot;   =&gt; favorite,</span>
<span class="cp">                              &quot;expires&quot; =&gt; Time.local(Time.now.year + 2,</span>
<span class="cp">Time.now.mon, Time.now.day, Time.now.hour, Time.now.min, Time.now.sec) )</span>
<span class="cp">    cgi.out(&quot;cookie&quot; =&gt; [cookie]) {</span>
<span class="cp">        cgi.html {</span>
<span class="cp">            cgi.head { cgi.title { &quot;Ice Cookies&quot; } } +</span>
<span class="cp">            cgi.body {</span>
<span class="cp">                cgi.h1 { &quot;Hello Ice Cream&quot; } +</span>
<span class="cp">                cgi.p { &quot;You chose as your favorite flavor `#{favorite}&#39;.&quot; }</span>
<span class="cp">            }</span>
<span class="cp">        }</span>
<span class="cp">    }</span>
<span class="cp">end</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1040"
>Creating Sticky Widgets</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1043"
>Writing a Multiscreen CGI Script</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1046"
>Saving a Form to a File or Mail Pipe</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1049"
>Program: chemiserie</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
></PRE
></TD
></TR
></TABLE
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="internetservices.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="webautomation.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Internet Services</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
>&nbsp;</TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Web Automation</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>
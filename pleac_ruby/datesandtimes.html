<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN""http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>Dates and Times</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="PLEAC-Ruby"
HREF="index.html"><LINK
REL="PREVIOUS"
TITLE="Numbers"
HREF="numbers.html"><LINK
REL="NEXT"
TITLE="Arrays"
HREF="arrays.html"><style type="text/css">td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
pre { line-height: 125%; }

  </style></head
><BODY TEXT="#cecece" BGCOLOR="#4f6f6f" LINK="#f5deb3" VLINK="#d5ae83"
CLASS="SECT1"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>PLEAC-Ruby</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="numbers.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
></TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="arrays.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="DATESANDTIMES"
>3. Dates and Times</A
></H1
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN132"
>Introduction</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">puts Time.now</span>

<span class="cp">print &quot;Today is day &quot;, Time.now.yday, &quot; of the current year.\n&quot;</span>
<span class="cp">print &quot;Today is day &quot;, Time.now.day, &quot; of the current month.\n&quot;</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN135"
>Finding Today's Date</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">day, month, year = Time.now.day, Time.now.month, Time.now.year</span>
<span class="cp"># or</span>
<span class="cp">day, month, year = Time.now.to_a[3..5]</span>

<span class="cp">tl = Time.now.localtime</span>
<span class="cp">printf(&quot;The current date is %04d %02d %02d\n&quot;, tl.year, tl.month, tl.day)</span>

<span class="cp">Time.now.localtime.strftime(&quot;%Y-%m-%d&quot;)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN138"
>Converting DMYHMS to Epoch Seconds</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">Time.local(year, month, day, hour, minute, second).tv_sec</span>
<span class="cp">Time.gm(year, month, day, hour, minute, second).tv_sec</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN141"
>Converting Epoch Seconds to DMYHMS</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">sec, min, hour, day, month, year, wday, yday, isdst, zone = Time.at(epoch_secs).to_a</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN144"
>Adding to or Subtracting from a Date</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">when_ = now + difference         # now -&gt; Time ; difference -&gt; Numeric (delta in seconds)</span>
<span class="cp">then_ = now - difference</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN147"
>Difference of Two Dates</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">bree = 361535725</span>
<span class="cp">nat  =  96201950</span>

<span class="cp">difference = bree - nat</span>
<span class="cp">puts &quot;There were #{difference} seconds between Nat and Bree&quot;</span>

<span class="cp">seconds    =  difference % 60</span>
<span class="cp">difference = (difference - seconds) / 60</span>
<span class="cp">minutes    =  difference % 60</span>
<span class="cp">difference = (difference - minutes) / 60</span>
<span class="cp">hours      =  difference % 24</span>
<span class="cp">difference = (difference - hours)   / 24</span>
<span class="cp">days       =  difference % 7</span>
<span class="cp">weeks      = (difference - days)    /  7</span>

<span class="cp">puts &quot;(#{weeks} weeks, #{days} days, #{hours}:#{minutes}:#{seconds})&quot;</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN150"
>Day in a Week/Month/Year or Week Number</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">monthday, weekday, yearday = date.mday, date.wday, date.yday</span>

<span class="cp"># AFAIK the week number is not just a division since week boundaries are on sundays</span>
<span class="cp">weeknum = d.strftime(&quot;%U&quot;).to_i + 1</span>

<span class="cp">year  = 1981</span>
<span class="cp">month = &quot;jun&quot;                     # or `6&#39; if you want to emulate a broken language</span>
<span class="cp">day   = 16</span>
<span class="cp">t = Time.mktime(year, month, day)</span>
<span class="cp">print &quot;#{month}/#{day}/#{year} was a &quot;, t.strftime(&quot;%A&quot;), &quot;\n&quot;</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN153"
>Parsing Dates and Times from Strings</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">yyyy, mm, dd = $1, $2, $3 if &quot;1998-06-25&quot; =~ /(\d+)-(\d+)-(\d+)/</span>

<span class="cp">epoch_seconds = Time.mktime(yyyy, mm, dd).tv_sec</span>

<span class="cp"># dunno an equivalent to Date::Manip#ParseDate</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN156"
>Printing a Date</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">string = Time.at(epoch_secs)</span>
<span class="cp">Time.at(1234567890).gmtime        # gives: Fri Feb 13 23:31:30 UTC 2009</span>

<span class="cp">time = Time.mktime(1973, &quot;jan&quot;, 18, 3, 45, 50)</span>
<span class="cp">print &quot;In localtime it gives: &quot;, time.localtime, &quot;\n&quot;</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN159"
>High-Resolution Timers</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp"># Ruby provides micro-seconds in Time object</span>
<span class="cp">Time.now.usec</span>

<span class="cp"># Ruby gives the seconds in floating format when substracting two Time objects</span>
<span class="cp">before = Time.now</span>
<span class="cp">line = gets</span>
<span class="cp">elapsed = Time.now - before</span>
<span class="cp">puts &quot;You took #{elapsed} seconds.&quot;</span>

<span class="cp"># On my Celeron-400 with Linux-2.2.19-14mdk, average for three execs are:</span>
<span class="cp">#   This Ruby version:       average 0.00321 sec</span>
<span class="cp">#   Cookbook&#39;s Perl version: average 0.00981 sec</span>
<span class="cp">size = 500</span>
<span class="cp">number_of_times = 100</span>
<span class="cp">total_time = 0</span>
<span class="cp">number_of_times.times {</span>
<span class="cp">    # populate array</span>
<span class="cp">    array = []</span>
<span class="cp">    size.times { array &lt;&lt; rand }</span>
<span class="cp">    # sort it</span>
<span class="cp">    begin_ = Time.now</span>
<span class="cp">    array.sort!</span>
<span class="cp">    time = Time.now - begin_</span>
<span class="cp">    total_time += time</span>
<span class="cp">}</span>
<span class="cp">printf &quot;On average, sorting %d random numbers takes %.5f seconds\n&quot;,</span>
<span class="cp">    size, (total_time/Float(number_of_times))</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN162"
>Short Sleeps</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">sleep(0.005)                      # Ruby is definitely not as broken as Perl :)</span>
<span class="cp"># (may be interrupted by sending the process a SIGALRM)</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN165"
>Program: hopdelta</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">#!/usr/bin/ruby -w</span>
<span class="cp"># hopdelta - feed mail header, produce lines</span>
<span class="cp">#            showing delay at each hop.</span>
<span class="cp">require &#39;time&#39;</span>
<span class="cp">class MailHopDelta</span>

<span class="cp">    def initialize(mail)</span>
<span class="cp">        @head = mail.gsub(/\n\s+/,&#39; &#39;)</span>
<span class="cp">        @topline = %w-Sender Recipient Time Delta-</span>
<span class="cp">        @start_from = mail.match(/^From.*\@([^\s&gt;]*)/)[1]</span>
<span class="cp">        @date = Time.parse(mail.match(/^Date:\s+(.*)/)[1])</span>
<span class="cp">    end</span>

<span class="cp">    def out(line)</span>
<span class="cp">         &quot;%-20.20s %-20.20s %-20.20s  %s&quot; % line</span>
<span class="cp">    end</span>

<span class="cp">    def hop_date(day)</span>
<span class="cp">        day.strftime(&quot;%I:%M:%S %Y/%m/%d&quot;)</span>
<span class="cp">    end</span>

<span class="cp">    def puts_hops</span>
<span class="cp">        puts out(@topline) </span>
<span class="cp">        puts out([&#39;Start&#39;, @start_from, hop_date(@date),&#39;&#39;])</span>
<span class="cp">        @head.split(/\n/).reverse.grep(/^Received:/).each do |hop|</span>
<span class="cp">            hop.gsub!(/\bon (.*?) (id.*)/,&#39;; \1&#39;)</span>
<span class="cp">            whence = hop.match(/;\s+(.*)$/)[1]</span>
<span class="cp">            unless whence</span>
<span class="cp">                warn &quot;Bad received line: #{hop}&quot;</span>
<span class="cp">                next</span>
<span class="cp">            end</span>
<span class="cp">            from = $+ if hop =~ /from\s+(\S+)|\((.*?)\)/</span>
<span class="cp">            by   = $1 if hop =~ /by\s+(\S+\.\S+)/</span>
<span class="cp">            next unless now = Time.parse(whence).localtime</span>
<span class="cp">            delta = now - @date</span>
<span class="cp">            puts out([from, by, hop_date(now), hop_time(delta)])</span>
<span class="cp">            @date = now</span>
<span class="cp">        end</span>
<span class="cp">    end</span>

<span class="cp">    def hop_time(secs)</span>
<span class="cp">        sign = secs &lt; 0 ? -1 : 1</span>
<span class="cp">        days, secs = secs.abs.divmod(60 * 60 * 24)</span>
<span class="cp">        hours,secs = secs.abs.divmod(60 * 60)</span>
<span class="cp">        mins, secs = secs.abs.divmod(60)</span>
<span class="cp">        rtn =  &quot;%3ds&quot; % [secs  * sign]</span>
<span class="cp">        rtn &lt;&lt; &quot;%3dm&quot; % [mins  * sign] if mins  != 0</span>
<span class="cp">        rtn &lt;&lt; &quot;%3dh&quot; % [hours * sign] if hours != 0</span>
<span class="cp">        rtn &lt;&lt; &quot;%3dd&quot; % [days  * sign] if days  != 0 </span>
<span class="cp">        rtn</span>
<span class="cp">    end</span>
<span class="cp">end</span>

<span class="cp">$/ = &quot;&quot;</span>
<span class="cp">mail = MailHopDelta.new(ARGF.gets).puts_hops</span></PRE
></TD
></TR
></TABLE
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="numbers.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="arrays.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Numbers</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
>&nbsp;</TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Arrays</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>
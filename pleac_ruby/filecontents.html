<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN""http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>File Contents</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="PLEAC-Ruby"
HREF="index.html"><LINK
REL="PREVIOUS"
TITLE="File Access"
HREF="fileaccess.html"><LINK
REL="NEXT"
TITLE="Directories"
HREF="directories.html"><style type="text/css">td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
pre { line-height: 125%; }

  </style></head
><BODY TEXT="#cecece" BGCOLOR="#4f6f6f" LINK="#f5deb3" VLINK="#d5ae83"
CLASS="SECT1"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>PLEAC-Ruby</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="fileaccess.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
></TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="directories.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="FILECONTENTS"
>8. File Contents</A
></H1
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN430"
>Introduction</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">#-----------------------------</span>
<span class="cp"># datafile is a file or IO object</span>
<span class="cp">datafile.readlines.each { |line|</span>
<span class="cp">    line.chomp!</span>
<span class="cp">    size = line.length</span>
<span class="cp">    puts size</span>
<span class="cp">}</span>
<span class="cp">#-----------------------------</span>
<span class="cp">datafile.readlines.each { |line|</span>
<span class="cp">    puts line.chomp!.length</span>
<span class="cp">}</span>
<span class="cp">#-----------------------------</span>
<span class="cp">lines = datafile.readlines</span>
<span class="cp">#-----------------------------</span>
<span class="cp">whole_file = file.read</span>
<span class="cp">#-----------------------------</span>
<span class="cp"># ruby -040 -e &#39;word = gets; puts &quot;First word is #{word}&quot;&#39;</span>
<span class="cp">#-----------------------------</span>
<span class="cp"># ruby -ne &#39;BEGIN { $/=&quot;%%\n&quot; }; $_.chomp; puts $_ if( $_=~/Unix/i)&#39; fortune.dat</span>
<span class="cp">#-----------------------------</span>
<span class="cp">handle.print &quot;one&quot;, &quot;two&quot;, &quot;three&quot; # &quot;onetwothree&quot;</span>
<span class="cp">puts &quot;Baa baa black sheep.&quot;        # sent to $stdout</span>
<span class="cp">#-----------------------------</span>
<span class="cp">buffer = handle.read(4096)</span>
<span class="cp">rv     = buffer.length</span>
<span class="cp">#-----------------------------</span>
<span class="cp">handle.truncate(length)</span>
<span class="cp">open(&quot;/tmp#{$$}.pid&quot;, &#39;w&#39;) { |handle| handle.truncate(length) }</span>
<span class="cp">#-----------------------------</span>
<span class="cp">pos = datafile.pos  # tell is an alias of pos</span>
<span class="cp">puts &quot;I&#39;m #{pos} bytes from the start of datafile&quot;</span>
<span class="cp">#-----------------------------</span>
<span class="cp">logfile.seek(0, IO::SEEK_END)</span>
<span class="cp">datafile.seek(pos)  #  IO::SEEK_SET is the default</span>
<span class="cp">out.seek(-20, IO::SEEK_CUR)</span>
<span class="cp">#-----------------------------</span>
<span class="cp">written = datafile.syswrite(mystring)</span>
<span class="cp">raise RunTimeError unless written == mystring.length</span>
<span class="cp">block = infile.sysread(256)   # no equivalent to perl offset parameter in sysread</span>
<span class="cp">puts &quot;only read #{block.length} bytes&quot; if 256 != block.length</span>
<span class="cp">#-----------------------------</span>
<span class="cp">pos = handle.sysseek(0, IO::SEEK_CUR)  # don&#39;t change position</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN433"
>Reading Lines with Continuation Characters</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">while (line = fh.gets)</span>
<span class="cp">    line.chomp!</span>
<span class="cp">    nextline = nil</span>
<span class="cp">    line.gsub!(/\\$/) { |match| nextline = fh.gets; &#39;&#39; }</span>
<span class="cp">    if (nextline != nil)</span>
<span class="cp">        line += nextline </span>
<span class="cp">        redo</span>
<span class="cp">    end</span>
<span class="cp">    # process full record in line here</span>
<span class="cp">end</span>
<span class="cp">#-----------------------------</span>
<span class="cp"># DISTFILES = $(DIST_COMMON) $(SOURCES) $(HEADERS) \</span>
<span class="cp">#         $(TEXINFOS) $(INFOS) $(MANS) $(DATA)</span>
<span class="cp"># DEP_DISTFILES = $(DIST_COMMON) $(SOURCES) $(HEADERS) \</span>
<span class="cp">#         $(TEXINFOS) $(INFO_DEPS) $(MANS) $(DATA) \</span>
<span class="cp">#         $(EXTRA_DIST)</span>
<span class="cp">#-----------------------------</span>
<span class="cp">line.gsub!(/\\\s*$/, &#39;&#39;) {</span>
<span class="cp">    # as before</span>
<span class="cp">}</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN436"
>Counting Lines (or Paragraphs or Records) in a File</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">#-----------------------------</span>
<span class="cp">count = `wc -l &lt; #{filename}`</span>
<span class="cp">fail &quot;wc failed: #{$?}&quot; if $? != 0</span>
<span class="cp">count.chomp!</span>
<span class="cp">#-----------------------------</span>
<span class="cp">count = 0</span>
<span class="cp">File.open(file, &#39;r&#39;) { |fh|</span>
<span class="cp">    count += 1 while fh.gets</span>
<span class="cp">}</span>
<span class="cp"># count now holds the number of lines read</span>
<span class="cp">#-----------------------------</span>
<span class="cp">count = 0</span>
<span class="cp">while (chunk = file.sysread(2**16)) </span>
<span class="cp">    count += chunk.count(&quot;\n&quot;)</span>
<span class="cp">end rescue EOFError</span>
<span class="cp">#-----------------------------</span>
<span class="cp">File.open(filename,&#39;r&#39;) { |fh|</span>
<span class="cp">    count += 1 while fh.gets</span>
<span class="cp">}</span>
<span class="cp"># count now holds the number of lines read</span>
<span class="cp">#-----------------------------</span>
<span class="cp"># As ruby doesn&#39;t quite have an equivalent to using a for</span>
<span class="cp"># statement as in perl, I threw this in</span>
<span class="cp">count = File.readlines(filename).size</span>
<span class="cp">#-----------------------------</span>
<span class="cp">1 while file.gets</span>
<span class="cp">count = $.</span>
<span class="cp">#-----------------------------</span>
<span class="cp">$/ = &#39;&#39;</span>
<span class="cp">open(filename, &#39;r&#39;) { |fh|</span>
<span class="cp">    1 while fh.gets</span>
<span class="cp">    para_count = $.</span>
<span class="cp">} rescue fail(&quot;can&#39;t open #{filename}: $!&quot;) </span>
<span class="cp">#-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN439"
>Processing Every Word in a File</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">#-----------------------------</span>
<span class="cp">while (gets)</span>
<span class="cp">    split.each { |chunk|</span>
<span class="cp">        # do something with chunk</span>
<span class="cp">    }</span>
<span class="cp">end</span>
<span class="cp">#-----------------------------</span>
<span class="cp">while (gets)</span>
<span class="cp">    gsub(/(\w[\w&#39;-]*)/) { |word|</span>
<span class="cp">        # do something with word</span>
<span class="cp">    }</span>
<span class="cp">end</span>
<span class="cp">#-----------------------------</span>
<span class="cp"># Make a word frequency count</span>
<span class="cp"># normally hashes can be created using {} or just Hash.new</span>
<span class="cp"># but we want the default value of an entry to be 0 instead </span>
<span class="cp"># of nil. (nil can&#39;t be incremented)</span>
<span class="cp">seen = Hash.new(0)</span>
<span class="cp">while (gets)</span>
<span class="cp">    gsub(/(\w[\w&#39;-]*)/) { |word|</span>
<span class="cp">        seen[word.downcase] += 1</span>
<span class="cp">    }</span>
<span class="cp">end</span>
<span class="cp"># output hash in a descending numeric sort of its values</span>
<span class="cp">seen.sort { |a,b| b[1] &lt;=&gt; a[1] }.each do |k,v|</span>
<span class="cp">    printf(&quot;%5d %s\n&quot;, v, k )</span>
<span class="cp">end</span>

<span class="cp">#-----------------------------</span>
<span class="cp"># Line frequency count</span>
<span class="cp">seen = Hash.new(0)</span>
<span class="cp">while (gets)</span>
<span class="cp">    seen[$_.downcase] += 1</span>
<span class="cp">end</span>
<span class="cp">seen.sort { |a,b| b[1] &lt;=&gt; a[1] }.each do |k,v|</span>
<span class="cp">    printf(&quot;%5d %s\n&quot;, v, k )</span>
<span class="cp">end</span>
<span class="cp">#-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN442"
>Reading a File Backwards by Line or Paragraph</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">#-----------------------------</span>
<span class="cp"># instead of file handle FILE, we can just</span>
<span class="cp"># use a string containing the filename</span>
<span class="cp">File.readlines(file).each { |line|</span>
<span class="cp">    # do something with line</span>
<span class="cp">}</span>
<span class="cp">#-----------------------------</span>
<span class="cp">File.readlines(file).reverse_each { |line|</span>
<span class="cp">    # do something with line</span>
<span class="cp">}</span>
<span class="cp">#-----------------------------</span>
<span class="cp"># the variable lines might have been created</span>
<span class="cp"># this way</span>
<span class="cp"># lines = File.readlines(file)</span>
<span class="cp">#</span>
<span class="cp"># normally one would use the reverse_each, but</span>
<span class="cp"># if you insist on using a numerical index to</span>
<span class="cp"># iterate over the lines array...</span>
<span class="cp">(lines.size - 1).downto(0) { |i|</span>
<span class="cp">    line = lines[i]</span>
<span class="cp">}</span>
<span class="cp">#-----------------------------</span>
<span class="cp"># the second readlines argument is a the </span>
<span class="cp"># record separator $/, just like perl, a blank</span>
<span class="cp"># separator splits the records into paragraphs</span>
<span class="cp">File.readlines(file, &#39;&#39;).each { |paragraph|</span>
<span class="cp">    # do something with paragraph</span>
<span class="cp">    puts &quot;-&gt;Paragraph #{paragraph}&quot;</span>
<span class="cp">}</span>
<span class="cp">#-----------------------------</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN445"
>Trailing a Growing File</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp"># This shows both reading the growing file and a fall back (exit) when the file is deleted.</span>
<span class="cp">file = File.open(&#39;growing.txt&#39;) # Open the file, default mode is reading.</span>
<span class="cp">while File.exists?(file.path) # Check if the file exists, exit if not.</span>
<span class="cp">    puts file.gets while !file.eof? # Print file contents until the end-of-file is reached.</span>
<span class="cp">    sleep(1) # Wait 1 second, so the file might grow in the meantime.</span>
<span class="cp">    # No need to seek  - eof will be reset automatically if the file grows.</span>
<span class="cp">end</span>

<span class="cp"># Another option - reopen the file if current position is greater then the length of the file.</span>
<span class="cp">filename = &#39;growing.txt&#39;</span>
<span class="cp">file = File.open(filename)</span>
<span class="cp">while File.exists?(file.path)</span>
<span class="cp">    if File.size(filename) &lt; file.pos</span>
<span class="cp">        puts &quot;File truncated -  reopening.&quot;</span>
<span class="cp">        file = File.open(filename)</span>
<span class="cp">    end</span>
<span class="cp">    puts file.gets while !file.eof?</span>
<span class="cp">    sleep(1)</span>
<span class="cp">end</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN448"
>Picking a Random Line from a File</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">$/ = &quot;%\n&quot;</span>
<span class="cp">srand</span>

<span class="cp">File.open(&#39;/usr/share/fortune/humorists&#39;).each do |line|</span>
<span class="cp">    adage = line if rand($.) &lt; 1</span>
<span class="cp">end</span>

<span class="cp">puts adage</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN451"
>Randomizing All Lines</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp"># Helper function from chapter 4.17: Randomizing an Array</span>
<span class="cp">def fisher_yates_shuffle(a)</span>
<span class="cp">    (a.size-1).downto(1) { |i|</span>
<span class="cp">        j = rand(i+1)</span>
<span class="cp">        a[i], a[j] = a[j], a[i] if i != j</span>
<span class="cp">    }</span>
<span class="cp">end</span>

<span class="cp"># Open the file, default mode is reading. Read all lines into an array.</span>
<span class="cp">lines = File.open(&#39;to_randomize.txt&#39;).collect</span>

<span class="cp"># Shuffle them.</span>
<span class="cp">fisher_yates_shuffle(lines)</span>

<span class="cp"># Print the shuffled lines.</span>
<span class="cp">puts lines </span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN454"
>Reading a Particular Line in a File</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN457"
>Processing Variable-Length Text Fields</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN460"
>Removing the Last Line of a File</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="cp"></span><span class="cp">begin</span>
<span class="cp">    fh = File.open(file, &quot;r+&quot;)</span>
<span class="cp">    addr = fh.tell unless fh.eof while fh.gets</span>
<span class="cp">    fh.truncate(addr)</span>
<span class="cp">rescue SystemCallError</span>
<span class="cp">    $stderr.puts &quot;#$!&quot;</span>
<span class="cp">end</span></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN463"
>Processing Binary Files</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN466"
>Using Random-Access I/O</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN469"
>Updating a Random-Access File</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN472"
>Reading a String from a Binary File</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN475"
>Reading Fixed-Length Records</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN478"
>Reading Configuration Files</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN481"
>Testing a File for Trustworthiness</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN484"
>Program: tailwtmp</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN487"
>Program: tctee</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN490"
>Program: laston</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
></PRE
></TD
></TR
></TABLE
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="fileaccess.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="directories.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>File Access</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
>&nbsp;</TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Directories</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>
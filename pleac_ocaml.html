<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
   "http://www.w3.org/TR/html4/strict.dtd">

<html>
<head>
  <title></title>
  <meta http-equiv="content-type" content="text/html; charset=latin1">
  <style type="text/css">
td.linenos { background-color: #f0f0f0; padding-right: 10px; }
span.lineno { background-color: #f0f0f0; padding: 0 5px 0 5px; }
pre { line-height: 125%; }
body .hll { background-color: #ffffcc }
body  { background: #f8f8f8; }
body .c { color: #408080; font-style: italic } /* Comment */
body .err { border: 1px solid #FF0000 } /* Error */
body .k { color: #008000; font-weight: bold } /* Keyword */
body .o { color: #666666 } /* Operator */
body .cm { color: #408080; font-style: italic } /* Comment.Multiline */
body .cp { color: #BC7A00 } /* Comment.Preproc */
body .c1 { color: #408080; font-style: italic } /* Comment.Single */
body .cs { color: #408080; font-style: italic } /* Comment.Special */
body .gd { color: #A00000 } /* Generic.Deleted */
body .ge { font-style: italic } /* Generic.Emph */
body .gr { color: #FF0000 } /* Generic.Error */
body .gh { color: #000080; font-weight: bold } /* Generic.Heading */
body .gi { color: #00A000 } /* Generic.Inserted */
body .go { color: #888888 } /* Generic.Output */
body .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
body .gs { font-weight: bold } /* Generic.Strong */
body .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
body .gt { color: #0044DD } /* Generic.Traceback */
body .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
body .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
body .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
body .kp { color: #008000 } /* Keyword.Pseudo */
body .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
body .kt { color: #B00040 } /* Keyword.Type */
body .m { color: #666666 } /* Literal.Number */
body .s { color: #BA2121 } /* Literal.String */
body .na { color: #7D9029 } /* Name.Attribute */
body .nb { color: #008000 } /* Name.Builtin */
body .nc { color: #0000FF; font-weight: bold } /* Name.Class */
body .no { color: #880000 } /* Name.Constant */
body .nd { color: #AA22FF } /* Name.Decorator */
body .ni { color: #999999; font-weight: bold } /* Name.Entity */
body .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
body .nf { color: #0000FF } /* Name.Function */
body .nl { color: #A0A000 } /* Name.Label */
body .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
body .nt { color: #008000; font-weight: bold } /* Name.Tag */
body .nv { color: #19177C } /* Name.Variable */
body .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
body .w { color: #bbbbbb } /* Text.Whitespace */
body .mf { color: #666666 } /* Literal.Number.Float */
body .mh { color: #666666 } /* Literal.Number.Hex */
body .mi { color: #666666 } /* Literal.Number.Integer */
body .mo { color: #666666 } /* Literal.Number.Oct */
body .sb { color: #BA2121 } /* Literal.String.Backtick */
body .sc { color: #BA2121 } /* Literal.String.Char */
body .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
body .s2 { color: #BA2121 } /* Literal.String.Double */
body .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
body .sh { color: #BA2121 } /* Literal.String.Heredoc */
body .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
body .sx { color: #008000 } /* Literal.String.Other */
body .sr { color: #BB6688 } /* Literal.String.Regex */
body .s1 { color: #BA2121 } /* Literal.String.Single */
body .ss { color: #19177C } /* Literal.String.Symbol */
body .bp { color: #008000 } /* Name.Builtin.Pseudo */
body .vc { color: #19177C } /* Name.Variable.Class */
body .vg { color: #19177C } /* Name.Variable.Global */
body .vi { color: #19177C } /* Name.Variable.Instance */
body .il { color: #666666 } /* Literal.Number.Integer.Long */

  </style>
</head>
<body>
<h2></h2>

<div class="highlight"><pre><span class="c">(* -*- ocaml -*- *)</span>

<span class="c">(* @@PLEAC@@_NAME *)</span>
<span class="c">(* @@SKIP@@ Objective CAML @@SKIP@@ *)</span>

<span class="c">(* @@PLEAC@@_WEB *)</span>
<span class="c">(* @@SKIP@@ http://www.ocaml.org/ @@SKIP@@ *)</span>

<span class="c">(* @@PLEAC@@_APPENDIX *)</span>
<span class="k">open</span> <span class="nc">Printf</span>

<span class="k">let</span> <span class="n">sort_</span> <span class="n">l</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">sort</span> <span class="n">compare</span> <span class="n">l</span>

<span class="k">let</span> <span class="k">rec</span> <span class="n">uniq</span> <span class="o">=</span> <span class="k">function</span>
  <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="bp">[]</span>
  <span class="o">|</span> <span class="n">e</span><span class="o">::</span><span class="n">l</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="nn">List</span><span class="p">.</span><span class="n">mem</span> <span class="n">e</span> <span class="n">l</span> <span class="k">then</span> <span class="n">uniq</span> <span class="n">l</span> <span class="k">else</span> <span class="n">e</span> <span class="o">::</span> <span class="n">uniq</span> <span class="n">l</span>

<span class="k">let</span> <span class="k">rec</span> <span class="n">filter_some</span> <span class="o">=</span> <span class="k">function</span>
  <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="bp">[]</span>
  <span class="o">|</span> <span class="nc">Some</span> <span class="n">e</span> <span class="o">::</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">e</span> <span class="o">::</span> <span class="n">filter_some</span> <span class="n">l</span>
  <span class="o">|</span> <span class="nc">None</span> <span class="o">::</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">filter_some</span> <span class="n">l</span>

<span class="k">let</span> <span class="k">rec</span> <span class="n">all_assoc</span> <span class="n">e</span> <span class="o">=</span> <span class="k">function</span>
  <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="bp">[]</span>
  <span class="o">|</span> <span class="o">(</span><span class="n">e&#39;</span><span class="o">,</span><span class="n">v</span><span class="o">)</span> <span class="o">::</span> <span class="n">l</span> <span class="k">when</span> <span class="n">e</span><span class="o">=</span><span class="n">e&#39;</span> <span class="o">-&gt;</span> <span class="n">v</span> <span class="o">::</span> <span class="n">all_assoc</span> <span class="n">e</span> <span class="n">l</span>
  <span class="o">|</span> <span class="o">_</span> <span class="o">::</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">all_assoc</span> <span class="n">e</span> <span class="n">l</span>

<span class="c">(* fold_left alike. note that it is tail recursive *)</span>
<span class="k">let</span> <span class="k">rec</span> <span class="n">fold_lines</span> <span class="n">f</span> <span class="n">init</span> <span class="n">chan</span> <span class="o">=</span>
  <span class="k">match</span>
    <span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">chan</span><span class="o">)</span>
    <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="nc">None</span>
  <span class="k">with</span>
  <span class="o">|</span> <span class="nc">Some</span> <span class="n">line</span> <span class="o">-&gt;</span> <span class="n">fold_lines</span> <span class="n">f</span> <span class="o">(</span><span class="n">f</span> <span class="n">init</span> <span class="n">line</span><span class="o">)</span> <span class="n">chan</span>
  <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="n">init</span>

<span class="k">let</span> <span class="n">iter_lines</span> <span class="n">f</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">fold_lines</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="n">line</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">line</span><span class="o">)</span> <span class="bp">()</span> <span class="n">chan</span>
<span class="k">let</span> <span class="n">readlines</span> <span class="n">chan</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="o">(</span><span class="n">fold_lines</span> <span class="o">(</span><span class="k">fun</span> <span class="n">l</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">e</span><span class="o">::</span><span class="n">l</span><span class="o">)</span> <span class="bp">[]</span> <span class="n">chan</span><span class="o">)</span>
<span class="o">;;</span>
<span class="c">(* @@PLEAC@@_1.0 *)</span>
<span class="c">(*---------------------------*)</span>
<span class="k">let</span> <span class="kt">string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">n&quot;</span>                  <span class="c">(* two characters, \ and an n*)</span>
<span class="k">let</span> <span class="kt">string</span> <span class="o">=</span> <span class="s2">&quot;Jon &#39;Maddog&#39; Orwant&quot;</span>  <span class="c">(* literal single quotes*)</span>
<span class="c">(*---------------------------*)</span>
<span class="k">let</span> <span class="kt">string</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>                     <span class="c">(* a &quot;newline&quot; character *)</span>
<span class="k">let</span> <span class="kt">string</span> <span class="o">=</span> <span class="s2">&quot;Jon </span><span class="se">\&quot;</span><span class="s2">Maddog</span><span class="se">\&quot;</span><span class="s2"> Orwant&quot;</span>  <span class="c">(* literal double quotes *)</span>

<span class="k">let</span> <span class="n">a</span> <span class="o">=</span> <span class="s2">&quot;</span>
<span class="s2">    This is a multiline here document</span>
<span class="s2">    terminated by one  double quote</span>
<span class="s2">    &quot;</span>
<span class="c">(* @@PLEAC@@_1.1 *)</span>
<span class="k">let</span> <span class="k">value</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="kt">string</span> <span class="n">offset</span> <span class="n">count</span>
<span class="k">let</span> <span class="k">value</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="kt">string</span> <span class="n">offset</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="kt">string</span> <span class="o">-</span> <span class="n">offset</span><span class="o">)</span>
<span class="c">(* or *)</span>
<span class="k">let</span> <span class="k">value</span> <span class="o">=</span> <span class="n">sub_end</span> <span class="kt">string</span> <span class="n">offset</span>
<span class="c">(* using *)</span>
<span class="k">let</span> <span class="n">sub_end</span> <span class="kt">string</span> <span class="n">offset</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="kt">string</span> <span class="n">offset</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="kt">string</span> <span class="o">-</span> <span class="n">offset</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>
<span class="c">(* get a 5-byte string, skip 3, then grab 2 8-byte strings, then the rest*)</span>

<span class="c">(* split at &#39;sz&#39; byte boundaries *)</span>
<span class="k">let</span> <span class="k">rec</span> <span class="n">split_every_n_chars</span> <span class="n">sz</span> <span class="o">=</span> <span class="k">function</span>
  <span class="o">|</span> <span class="s2">&quot;&quot;</span> <span class="o">-&gt;</span> <span class="bp">[]</span>
  <span class="o">|</span> <span class="n">s</span> <span class="o">-&gt;</span>
      <span class="k">try</span>
	<span class="k">let</span> <span class="o">(</span><span class="n">beg</span><span class="o">,</span> <span class="n">rest</span><span class="o">)</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">s</span> <span class="mi">0</span> <span class="n">sz</span><span class="o">,</span> <span class="n">sub_end</span> <span class="n">s</span> <span class="n">sz</span> <span class="k">in</span>
	<span class="n">beg</span> <span class="o">::</span> <span class="n">split_every_n_chars</span> <span class="n">sz</span> <span class="n">rest</span>
      <span class="k">with</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="o">[</span><span class="n">s</span><span class="o">]</span>

<span class="k">let</span> <span class="n">fivers</span> <span class="o">=</span> <span class="n">split_every_n_chars</span> <span class="mi">5</span> <span class="kt">string</span>

<span class="c">(* chop string into individual characters *)</span>
<span class="k">let</span> <span class="n">chars</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">.[</span><span class="mi">0</span><span class="o">])</span> <span class="o">(</span><span class="n">split_every_n_chars</span> <span class="mi">1</span> <span class="kt">string</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="kt">string</span> <span class="o">=</span> <span class="s2">&quot;This is what you have&quot;</span><span class="o">;;</span>
<span class="c">(* Indexes are left to right. There is no possibility to index *)</span>
<span class="c">(* directly from right to left *)</span>
<span class="c">(* &quot;T&quot; *)</span>
<span class="k">let</span> <span class="n">first</span>  <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="kt">string</span> <span class="mi">0</span> <span class="mi">1</span>
<span class="c">(* &quot;is&quot; *)</span>
<span class="k">let</span> <span class="n">start</span>  <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="kt">string</span> <span class="mi">5</span> <span class="mi">2</span>
<span class="c">(* &quot;you have&quot; *)</span>
<span class="k">let</span> <span class="n">rest</span>   <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="kt">string</span> <span class="mi">13</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="kt">string</span> <span class="o">-</span> <span class="mi">13</span><span class="o">)</span>
<span class="c">(* &quot;e&quot; *)</span>
<span class="k">let</span> <span class="n">last</span>   <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="kt">string</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="kt">string</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="mi">1</span>
<span class="c">(* &quot;have&quot; *)</span>
<span class="k">let</span> <span class="n">theend</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="kt">string</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="kt">string</span> <span class="o">-</span> <span class="mi">4</span><span class="o">)</span> <span class="mi">4</span>
<span class="c">(* &quot;you&quot; *)</span>
<span class="k">let</span> <span class="n">piece</span>  <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="kt">string</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="kt">string</span> <span class="o">-</span> <span class="mi">8</span><span class="o">)</span> <span class="mi">3</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="kt">string</span> <span class="o">=</span> <span class="s2">&quot;This is what you have&quot;</span><span class="o">;;</span>
<span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s&quot;</span> <span class="kt">string</span> <span class="o">;</span>
<span class="c">(*This is what you have*)</span>

<span class="c">(* Change &quot;is&quot; to &quot;wasn&#39;t&quot;*)</span>
<span class="k">let</span> <span class="kt">string</span> <span class="o">=</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="kt">string</span> <span class="mi">0</span> <span class="mi">5</span><span class="o">)</span> <span class="o">^</span> <span class="s2">&quot;wasn&#39;t&quot;</span> <span class="o">^</span> <span class="n">sub_end</span> <span class="kt">string</span> <span class="mi">7</span>
<span class="c">(*This wasn&#39;t what you have *)</span>

<span class="c">(*This wasn&#39;t wonderous *)</span>
<span class="k">let</span> <span class="kt">string</span> <span class="o">=</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="kt">string</span> <span class="mi">0</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="kt">string</span> <span class="o">-</span><span class="mi">12</span><span class="o">))</span> <span class="o">^</span>
   <span class="s2">&quot;ondrous&quot;</span><span class="o">;;</span>

<span class="c">(* delete first character *)</span>
<span class="k">let</span> <span class="kt">string</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="kt">string</span> <span class="mi">1</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="kt">string</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span>
<span class="c">(*his wasn&#39;t wondrous*)</span>

<span class="c">(* delete last 10 characters *)</span>
<span class="k">let</span> <span class="kt">string</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="kt">string</span> <span class="mi">0</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="kt">string</span> <span class="o">-</span><span class="mi">10</span><span class="o">)</span>
<span class="c">(*his wasn&#39;*)</span>
<span class="c">(*-----------------------------*)</span>

<span class="c">(* @@PLEAC@@_1.2 *)</span>

<span class="c">(* Because OCaml doesn&#39;t have the same notion of truth or definedness as Perl,</span>
<span class="c"> * most of these examples just can&#39;t be done as they are in Perl.  Some can be</span>
<span class="c"> * approximated via the use of options, but remember, unbound variables are not</span>
<span class="c"> * automatically assigned the value of None -- the variable has to have been</span>
<span class="c"> * explicitly bound to None (or Some x) beforehand.</span>
<span class="c">*)</span>

<span class="c">(* use b if b is not None, else use c *)</span>
<span class="k">let</span> <span class="n">a</span> <span class="o">=</span> <span class="k">match</span> <span class="n">b</span> <span class="k">with</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="n">c</span> <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">b</span><span class="o">;;</span>

<span class="c">(* set x to y if x is currently None *)</span>
<span class="k">let</span> <span class="n">x</span> <span class="o">=</span> <span class="k">match</span> <span class="n">x</span> <span class="k">with</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="n">y</span> <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">;;</span>

<span class="c">(* Note that these are much closer to Perls notion of definedness than truth *)</span>

<span class="c">(* We can set foo to either bar or &quot;DEFAULT VALUE&quot; in one of two ways *)</span>
<span class="c">(* keep foo as a string option *)</span>
<span class="k">let</span> <span class="n">foo</span> <span class="o">=</span> <span class="k">match</span> <span class="n">bar</span> <span class="k">with</span> <span class="nc">Some</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">bar</span> <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nc">Some</span> <span class="s2">&quot;DEFAULT VALUE&quot;</span><span class="o">;;</span>

<span class="c">(* Use foo as a string *)</span>
<span class="k">let</span> <span class="n">foo</span> <span class="o">=</span> <span class="k">match</span> <span class="n">bar</span> <span class="k">with</span> <span class="nc">Some</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span> <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="s2">&quot;DEFAULT VALUE&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">dir</span> <span class="o">=</span> <span class="k">if</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">then</span> <span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span> <span class="k">else</span> <span class="s2">&quot;/tmp&quot;</span><span class="o">;;</span>

<span class="c">(* None of the other examples really make sense in OCaml terms... *)</span>

<span class="c">(* @@PLEAC@@_1.3 *)</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="n">var1</span><span class="o">,</span> <span class="n">var2</span> <span class="o">=</span> <span class="n">var2</span><span class="o">,</span> <span class="n">var1</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="n">temp</span>    <span class="o">=</span> <span class="n">a</span>
<span class="k">let</span> <span class="n">a</span>       <span class="o">=</span> <span class="n">b</span>
<span class="k">let</span> <span class="n">b</span>       <span class="o">=</span> <span class="n">temp</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="n">a</span>       <span class="o">=</span> <span class="s2">&quot;alpha&quot;</span>
<span class="k">let</span> <span class="n">b</span>       <span class="o">=</span> <span class="s2">&quot;omega&quot;</span>
<span class="k">let</span> <span class="n">a</span><span class="o">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="o">,</span> <span class="n">a</span>      <span class="c">(* the first shall be last -- and versa vice *)</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="n">alpha</span><span class="o">,</span> <span class="n">beta</span><span class="o">,</span> <span class="n">production</span> <span class="o">=</span> <span class="s2">&quot;January&quot;</span><span class="o">,</span> <span class="s2">&quot;March&quot;</span><span class="o">,</span> <span class="s2">&quot;August&quot;</span>
<span class="c">(* move beta       to alpha,</span>
<span class="c"> * move production to beta,</span>
<span class="c"> * move alpha      to production *)</span>
<span class="k">let</span> <span class="n">alpha</span><span class="o">,</span> <span class="n">beta</span><span class="o">,</span> <span class="n">production</span> <span class="o">=</span> <span class="n">beta</span><span class="o">,</span> <span class="n">production</span><span class="o">,</span> <span class="n">alpha</span>
<span class="c">(*-----------------------------*)</span>

<span class="c">(* @@PLEAC@@_1.4 *)</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="n">num</span>  <span class="o">=</span> <span class="nn">Char</span><span class="p">.</span><span class="n">code</span> <span class="kt">char</span>
<span class="k">let</span> <span class="kt">char</span> <span class="o">=</span> <span class="nn">Char</span><span class="p">.</span><span class="n">chr</span> <span class="n">num</span>
<span class="c">(*-----------------------------*)</span>
<span class="c">(* char and int are distinct datatypes in OCaml *)</span>
<span class="n">printf</span> <span class="s2">&quot;Number %d is character %c</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">num</span> <span class="o">(</span><span class="nn">Char</span><span class="p">.</span><span class="n">chr</span> <span class="n">num</span><span class="o">)</span>
<span class="c">(* Number 101 is character e *)</span>
<span class="c">(*-----------------------------*)</span>
<span class="c">(* convert string to list of chars *)</span>
<span class="k">let</span> <span class="n">explode</span> <span class="n">s</span> <span class="o">=</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">f</span> <span class="n">acc</span> <span class="o">=</span> <span class="k">function</span>
    <span class="o">|</span> <span class="o">-</span><span class="mi">1</span> <span class="o">-&gt;</span> <span class="n">acc</span>
    <span class="o">|</span> <span class="n">k</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="o">(</span><span class="n">s</span><span class="o">.[</span><span class="n">k</span><span class="o">]</span> <span class="o">::</span> <span class="n">acc</span><span class="o">)</span> <span class="o">(</span><span class="n">k</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span>
  <span class="k">in</span> <span class="n">f</span> <span class="bp">[]</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span>

<span class="c">(* convert list of chars to string *)</span>
<span class="k">let</span> <span class="n">implode</span> <span class="n">l</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">create</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">length</span> <span class="n">l</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">f</span> <span class="n">n</span> <span class="o">=</span> <span class="k">function</span>
    <span class="o">|</span> <span class="n">x</span> <span class="o">::</span> <span class="n">xs</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="o">.[</span><span class="n">n</span><span class="o">]</span> <span class="o">&lt;-</span> <span class="n">x</span><span class="o">;</span> <span class="n">f</span> <span class="o">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">xs</span>
    <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="n">s</span>
  <span class="k">in</span> <span class="n">f</span> <span class="mi">0</span> <span class="n">l</span>

<span class="c">(* ascii is list of ints. *)</span>
<span class="k">let</span> <span class="n">ascii</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="nn">Char</span><span class="p">.</span><span class="n">code</span> <span class="o">(</span><span class="n">explode</span> <span class="kt">string</span><span class="o">)</span>
<span class="k">let</span> <span class="kt">string</span> <span class="o">=</span> <span class="n">implode</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="nn">Char</span><span class="p">.</span><span class="n">ord</span> <span class="n">ascii</span><span class="o">)</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="n">ascii_value</span> <span class="o">=</span> <span class="nn">Char</span><span class="p">.</span><span class="n">code</span> <span class="sc">&#39;e&#39;</span>    <span class="c">(* now 101 *)</span>
<span class="k">let</span> <span class="n">character</span>   <span class="o">=</span> <span class="nn">Char</span><span class="p">.</span><span class="n">chr</span> <span class="mi">101</span>     <span class="c">(* now &#39;e&#39; *)</span>
<span class="c">(*-----------------------------*)</span>
<span class="n">printf</span> <span class="s2">&quot;Number %d is character %c</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="mi">101</span> <span class="o">(</span><span class="nn">Char</span><span class="p">.</span><span class="n">chr</span> <span class="mi">101</span><span class="o">)</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="n">ascii_character_numbers</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="nn">Char</span><span class="p">.</span><span class="n">code</span> <span class="o">(</span><span class="n">explode</span> <span class="s2">&quot;sample&quot;</span><span class="o">);;</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="n">printf</span> <span class="s2">&quot;%d &quot;</span><span class="o">)</span> <span class="n">ascii_character_numbers</span><span class="o">;</span>
<span class="n">printf</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="mi">115</span> <span class="mi">97</span> <span class="mi">109</span> <span class="mi">112</span> <span class="mi">108</span> <span class="mi">101</span>

<span class="k">let</span> <span class="n">word</span> <span class="o">=</span> <span class="n">implode</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="nn">Char</span><span class="p">.</span><span class="n">chr</span> <span class="n">ascii_character_numbers</span><span class="o">)</span>
<span class="k">let</span> <span class="n">word</span> <span class="o">=</span> <span class="n">implode</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="nn">Char</span><span class="p">.</span><span class="n">chr</span> <span class="o">[</span><span class="mi">115</span><span class="o">;</span> <span class="mi">97</span><span class="o">;</span> <span class="mi">109</span><span class="o">;</span> <span class="mi">112</span><span class="o">;</span> <span class="mi">108</span><span class="o">;</span> <span class="mi">101</span><span class="o">]);;</span> <span class="c">(* same *)</span>
<span class="n">printf</span> <span class="s2">&quot;%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">word</span>
<span class="n">sample</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="n">hal</span> <span class="o">=</span> <span class="s2">&quot;HAL&quot;</span>
<span class="k">let</span> <span class="n">ascii</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="nn">Char</span><span class="p">.</span><span class="n">code</span> <span class="o">(</span><span class="n">explode</span> <span class="n">hal</span><span class="o">)</span>
<span class="k">let</span> <span class="n">ascii</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">((</span> <span class="o">+</span> <span class="o">)</span> <span class="mi">1</span><span class="o">)</span> <span class="n">ascii</span>  <span class="c">(* add one to each ASCII value *)</span>
<span class="k">let</span> <span class="n">ibm</span> <span class="o">=</span> <span class="n">implode</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="nn">Char</span><span class="p">.</span><span class="n">chr</span> <span class="n">ascii</span><span class="o">);;</span>
<span class="n">printf</span> <span class="s2">&quot;%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">ibm</span>             <span class="c">(* prints &quot;IBM&quot; *)</span>
<span class="c">(*-----------------------------*)</span>

<span class="c">(* @@PLEAC@@_1.5 *)</span>

<span class="c">(* One can split a string into an array of character, or corresponding ASCII</span>
<span class="c"> * codes as follows, but this is not necessary to process the strings a</span>
<span class="c"> * character at a time: *)</span>

<span class="k">let</span> <span class="n">array_of_chars</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">init</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span><span class="o">)</span> <span class="o">(</span><span class="k">fun</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="o">.[</span><span class="n">i</span><span class="o">]);;</span>
<span class="k">let</span> <span class="n">array_of_codes</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">init</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span><span class="o">)</span> <span class="o">(</span><span class="k">fun</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="nn">Char</span><span class="p">.</span><span class="n">code</span> <span class="n">s</span><span class="o">.[</span><span class="n">i</span><span class="o">]);;</span>

<span class="c">(* or one can just use String.iter *)</span>
<span class="nn">String</span><span class="p">.</span><span class="n">iter</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="c">(*do something with s.[i], the ith char of the string*)</span><span class="o">)</span> <span class="n">s</span><span class="o">;;</span>

<span class="c">(* The following function can be used to return a list of all unique keys in a</span>
<span class="c"> * hashtable *)</span>

<span class="k">let</span> <span class="n">keys</span> <span class="n">h</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">k</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">fold</span> <span class="o">(</span><span class="k">fun</span> <span class="n">k</span> <span class="n">v</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">k</span><span class="o">::</span><span class="n">b</span><span class="o">)</span> <span class="n">h</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="c">(* filter out duplicates *)</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">fold_left</span> <span class="o">(</span><span class="k">fun</span> <span class="n">b</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="nn">List</span><span class="p">.</span><span class="n">mem</span> <span class="n">x</span> <span class="n">b</span> <span class="k">then</span> <span class="n">b</span> <span class="k">else</span> <span class="n">x</span><span class="o">::</span><span class="n">b</span><span class="o">)</span> <span class="bp">[]</span> <span class="n">k</span><span class="o">;;</span>

<span class="c">(* and this function is a shorthand for adding a key,value pair to a hashtable</span>
<span class="c">*)</span>

<span class="k">let</span> <span class="o">(</span> <span class="o">&lt;&lt;+</span> <span class="o">)</span> <span class="n">h</span> <span class="o">(</span><span class="n">k</span><span class="o">,</span><span class="n">v</span><span class="o">)</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">add</span> <span class="n">h</span> <span class="n">k</span> <span class="n">v</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">seen</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">13</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;an apple a day&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">array_of_chars</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">init</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span><span class="o">)</span> <span class="o">(</span><span class="k">fun</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">s</span><span class="o">.[</span><span class="n">i</span><span class="o">]);;</span>
<span class="nn">Array</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">seen</span> <span class="o">&lt;&lt;+</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="mi">1</span><span class="o">))</span> <span class="n">array_of_chars</span><span class="o">;</span>
<span class="n">print_string</span> <span class="s2">&quot;unique chars are:</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">;</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="n">print_char</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">sort</span> <span class="n">compare</span> <span class="o">(</span><span class="n">keys</span> <span class="n">seen</span><span class="o">));</span>
<span class="n">print_newline</span> <span class="bp">()</span><span class="o">;;</span>

<span class="c">(* or, without the unnecessary and innefficient step of converting the string</span>
<span class="c"> * into an array of chars *)</span>
<span class="k">let</span> <span class="n">seen</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">13</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;an apple a day&quot;</span><span class="o">;;</span>
<span class="nn">String</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">seen</span> <span class="o">&lt;&lt;+</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="mi">1</span><span class="o">))</span> <span class="n">s</span><span class="o">;</span>
<span class="n">print_string</span> <span class="s2">&quot;unique chars are:</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">;</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="n">print_char</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">sort</span> <span class="n">compare</span> <span class="o">(</span><span class="n">keys</span> <span class="n">seen</span><span class="o">));</span>
<span class="n">print_newline</span> <span class="bp">()</span><span class="o">;;</span>

<span class="c">(* To compute the simple 31-bit checksum of a string *)</span>
<span class="k">let</span> <span class="n">cksum</span> <span class="n">s</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="nn">String</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">sum</span> <span class="o">:=</span> <span class="o">!</span><span class="n">sum</span> <span class="o">+</span> <span class="o">(</span><span class="nn">Char</span><span class="p">.</span><span class="n">code</span> <span class="n">x</span><span class="o">))</span> <span class="n">s</span><span class="o">;</span>
  <span class="o">!</span><span class="n">sum</span><span class="o">;;</span>
<span class="c">(*</span>
<span class="c"># cksum &quot;an apple a day&quot;;;</span>
<span class="c">- : int = 1248</span>
<span class="c">*)</span>

<span class="c">(* to emulate the SysV 16-bit checksum, we will first write two routines sort of</span>
<span class="c"> * similar to Perl&#39;s (&lt;&gt;), that will return the contents of a file either as a</span>
<span class="c"> * list of strings or as a single string - not that the list of strings version</span>
<span class="c"> * throws away the \n at the end of each line *)</span>

<span class="k">let</span> <span class="n">slurp_to_list</span> <span class="n">filename</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">ic</span> <span class="o">=</span> <span class="n">open_in</span> <span class="n">filename</span> <span class="ow">and</span>
  <span class="n">l</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span> <span class="bp">()</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">ic</span> <span class="k">in</span>
    <span class="n">l</span> <span class="o">:=</span> <span class="n">line</span><span class="o">::!</span><span class="n">l</span><span class="o">;</span>
    <span class="n">loop</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="k">try</span> <span class="n">loop</span> <span class="bp">()</span> <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="n">close_in</span> <span class="n">ic</span><span class="o">;</span> <span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="o">!</span><span class="n">l</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">slurp_to_string</span> <span class="n">filename</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">ic</span> <span class="o">=</span> <span class="n">open_in</span> <span class="n">filename</span> <span class="ow">and</span>
  <span class="n">buf</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">create</span> <span class="mi">4096</span> <span class="k">in</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span> <span class="bp">()</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">ic</span> <span class="k">in</span>
    <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_string</span> <span class="n">buf</span> <span class="n">line</span><span class="o">;</span>
    <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_string</span> <span class="n">buf</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
    <span class="n">loop</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="k">try</span> <span class="n">loop</span> <span class="bp">()</span> <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="n">close_in</span> <span class="n">ic</span><span class="o">;</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">contents</span> <span class="n">buf</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">cksum16</span> <span class="n">fn</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">addString</span> <span class="n">sum</span> <span class="n">s</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">sm</span> <span class="o">=</span> <span class="n">ref</span> <span class="n">sum</span> <span class="k">in</span>
    <span class="nn">String</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">c</span> <span class="o">-&gt;</span> <span class="n">sm</span> <span class="o">:=</span> <span class="o">!</span><span class="n">sm</span> <span class="o">+</span> <span class="o">(</span><span class="nn">Char</span><span class="p">.</span><span class="n">code</span> <span class="n">c</span><span class="o">))</span> <span class="o">(</span><span class="n">s</span> <span class="o">^</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">);</span>
    <span class="o">!</span><span class="n">sm</span> <span class="ow">mod</span> <span class="mi">65537</span> <span class="c">(* 2^16 - 1 *)</span><span class="k">in</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">fold_left</span> <span class="n">addString</span> <span class="mi">0</span> <span class="o">(</span><span class="n">slurp_to_list</span> <span class="n">fn</span><span class="o">);;</span>

<span class="c">(* or *)</span>
<span class="k">let</span> <span class="n">cksum16</span> <span class="n">fn</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>
  <span class="ow">and</span> <span class="n">s</span> <span class="o">=</span> <span class="n">slurp_to_string</span> <span class="n">fn</span> <span class="k">in</span>
  <span class="nn">String</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">c</span> <span class="o">-&gt;</span> <span class="n">sum</span> <span class="o">:=</span> <span class="o">(!</span><span class="n">sum</span> <span class="o">+</span> <span class="o">(</span><span class="nn">Char</span><span class="p">.</span><span class="n">code</span> <span class="n">c</span><span class="o">))</span> <span class="ow">mod</span> <span class="mi">65537</span><span class="o">)</span> <span class="n">s</span><span class="o">;</span>
  <span class="o">!</span><span class="n">sum</span><span class="o">;;</span>



<span class="c">(* Note: slowcat as written is meant to be run from the command line, not in the</span>
<span class="c"> * toplevel *)</span>

<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* slowcat - emulate a   s l o w  line printer *)</span>
<span class="c">(* usage: slowcat [-DELAY] [files ...] *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="c">(* make sure you have the code for the slurp_to_string function in this file as</span>
<span class="c"> * well... *)</span>

<span class="k">let</span> <span class="o">_</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">delay</span><span class="o">,</span><span class="n">fs</span> <span class="o">=</span> <span class="k">try</span> <span class="o">(</span><span class="n">float_of_string</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">)),</span><span class="mi">2</span> <span class="k">with</span> <span class="nc">Failure</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="mi">1</span><span class="o">.,</span><span class="mi">1</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">files</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">sub</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="n">fs</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="o">-</span> <span class="n">fs</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">print_file</span> <span class="n">f</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">slurp_to_string</span> <span class="n">f</span> <span class="k">in</span>
    <span class="nn">String</span><span class="p">.</span><span class="n">iter</span>
      <span class="o">(</span><span class="k">fun</span> <span class="n">c</span> <span class="o">-&gt;</span>
        <span class="n">print_char</span> <span class="n">c</span><span class="o">;</span>
        <span class="n">ignore</span><span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">select</span> <span class="bp">[]</span> <span class="bp">[]</span> <span class="bp">[]</span> <span class="o">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">005</span> <span class="o">*.</span> <span class="n">delay</span><span class="o">)))</span> <span class="n">s</span> <span class="k">in</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">iter</span> <span class="n">print_file</span> <span class="n">files</span><span class="o">;;</span>

<span class="c">(* @@PLEAC@@_1.6 *)</span>

<span class="c">(* To flip the characters of a string, we can use a for loop.</span>
<span class="c"> * Note that this version does not destructively update the string *)</span>

<span class="k">let</span> <span class="n">reverse</span> <span class="n">s</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">len</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">s&#39;</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">create</span> <span class="o">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">to</span> <span class="n">len</span> <span class="k">do</span>
    <span class="n">s&#39;</span><span class="o">.[</span><span class="n">i</span><span class="o">]</span> <span class="o">&lt;-</span> <span class="n">s</span><span class="o">.[</span><span class="n">len</span> <span class="o">-</span> <span class="n">i</span><span class="o">]</span>
  <span class="k">done</span><span class="o">;</span>
  <span class="n">s&#39;</span><span class="o">;;</span>

<span class="c">(* to modify the string in place, we can use the following function *)</span>
<span class="k">let</span> <span class="n">reverse_in_place</span> <span class="n">s</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">len</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">in</span>
  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">to</span> <span class="o">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">t</span> <span class="o">=</span> <span class="n">s</span><span class="o">.[</span><span class="n">i</span><span class="o">]</span> <span class="k">in</span>
    <span class="n">s</span><span class="o">.[</span><span class="n">i</span><span class="o">]</span> <span class="o">&lt;-</span> <span class="n">s</span><span class="o">.[</span><span class="n">len</span> <span class="o">-</span> <span class="n">i</span><span class="o">];</span>
    <span class="n">s</span><span class="o">.[</span><span class="n">len</span> <span class="o">-</span> <span class="n">i</span><span class="o">]</span> <span class="o">&lt;-</span> <span class="n">t</span>
  <span class="k">done</span><span class="o">;;</span>

<span class="c">(* To reverse the words in a string, we can use String.concat, Str.split and</span>
<span class="c"> * List.rev.  Note that this requires us to load in the Str module --</span>
<span class="c"> * use `#load &quot;str.cma&quot;&#39; in* the toplevel, or be sure to include str.cma in the</span>
<span class="c"> * list of object files when compiling your code.  E.g.:</span>
<span class="c"> *      ocamlc other options str.cma other files   -or-</span>
<span class="c"> *      ocamlopt other options str.cmxa other files</span>
<span class="c">*)</span>

<span class="k">let</span> <span class="n">reverse_words</span> <span class="n">s</span> <span class="o">=</span>
  <span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot; &quot;</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">split</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot; &quot;</span><span class="o">)</span> <span class="n">s</span><span class="o">));;</span>

<span class="k">let</span> <span class="n">is_palindrome</span> <span class="n">s</span> <span class="o">=</span>
  <span class="n">s</span> <span class="o">=</span> <span class="n">reverse</span> <span class="n">s</span><span class="o">;;</span>

<span class="c">(* We do need to do a bit more work that Perl to find the big palindromes in</span>
<span class="c"> * /usr/share/dict/words ... *)</span>

<span class="k">let</span> <span class="n">findBigPals</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">words</span> <span class="o">=</span> <span class="n">open_in</span> <span class="s2">&quot;/usr/share/dict/words&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span> <span class="bp">()</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">w</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">words</span> <span class="k">in</span>
    <span class="k">if</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">w</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span> <span class="n">w</span> <span class="o">=</span> <span class="n">reverse</span> <span class="n">w</span> <span class="k">then</span>
      <span class="n">print_endline</span> <span class="n">w</span><span class="o">;</span>
    <span class="n">loop</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="k">try</span> <span class="n">loop</span> <span class="bp">()</span> <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="n">close_in</span> <span class="n">words</span><span class="o">;;</span>

<span class="c">(* @@PLEAC@@_1.7 *)</span>

<span class="k">let</span> <span class="n">expand_tabs</span> <span class="o">?(</span><span class="n">spaces</span> <span class="o">=</span> <span class="mi">8</span><span class="o">)</span> <span class="n">s</span> <span class="o">=</span>
  <span class="nn">Str</span><span class="p">.</span><span class="n">global_replace</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="o">)</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="n">spaces</span> <span class="sc">&#39; &#39;</span><span class="o">)</span> <span class="n">s</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">compress_tabs</span> <span class="o">?(</span><span class="n">spaces</span> <span class="o">=</span> <span class="mi">8</span><span class="o">)</span> <span class="n">s</span> <span class="o">=</span>
  <span class="nn">Str</span><span class="p">.</span><span class="n">global_replace</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="n">spaces</span> <span class="sc">&#39; &#39;</span><span class="o">))</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="n">s</span><span class="o">;;</span>

<span class="c">(*</span>
<span class="c"># let st = &quot;\tyo baby!\n\t\tWhat the shizzle?\t(Mack)&quot;;;</span>
<span class="c">val st : string = &quot;\tyo baby!\n\t\tWhat the shizzle?\t(Mack)&quot;</span>
<span class="c"># let etst = expand_tabs st;;</span>
<span class="c">val etst : string =</span>
<span class="c">  &quot;        yo baby!\n                What the shizzle?        (Mack)&quot;</span>
<span class="c"># let etst = expand_tabs ~spaces:4 st;;</span>
<span class="c">val etst : string = &quot;    yo baby!\n        What the shizzle?    (Mack)&quot;</span>
<span class="c"># let etst = expand_tabs ~spaces:8 st;;</span>
<span class="c">val etst : string =</span>
<span class="c">  &quot;        yo baby!\n                What the shizzle?        (Mack)&quot;</span>
<span class="c"># let rest = compress_tabs etst;;</span>
<span class="c">val rest : string = &quot;\tyo baby!\n\t\tWhat the shizzle?\t(Mack)&quot;</span>
<span class="c"># let rest = compress_tabs ~spaces:4 etst;;</span>
<span class="c">val rest : string = &quot;\t\tyo baby!\n\t\t\t\tWhat the shizzle?\t\t(Mack)&quot;</span>
<span class="c"># let rest = compress_tabs ~spaces:3 etst;;</span>
<span class="c">val rest : string =</span>
<span class="c">  &quot;\t\t  yo baby!\n\t\t\t\t\t What the shizzle?\t\t  (Mack)&quot;</span>
<span class="c">*)</span>

<span class="c">(* @@PLEAC@@_1.8 *)</span>
<span class="c">(* As far as I know there is no way to do this in OCaml due to</span>
<span class="c">   type-safety contraints built into the OCaml compiler -- it may be</span>
<span class="c">   feasible with *much* juju, but don&#39;t expect to see this anytime</span>
<span class="c">   soon...</span>

<span class="c">   If you don&#39;t mind supplying a data structure rather than capturing</span>
<span class="c">   local variables, you can use Buffer.add_substitute to get a similar</span>
<span class="c">   effect. *)</span>

<span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">create</span> <span class="mi">16</span>
<span class="k">let</span> <span class="n">vars</span> <span class="o">=</span> <span class="o">[(</span><span class="s2">&quot;debt&quot;</span><span class="o">,</span> <span class="s2">&quot;$700 billion&quot;</span><span class="o">)]</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_substitute</span> <span class="n">buffer</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">name</span> <span class="o">-&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">assoc</span> <span class="n">name</span> <span class="n">vars</span><span class="o">)</span>
    <span class="s2">&quot;You owe $debt to me.&quot;</span><span class="o">;</span>
  <span class="n">print_endline</span> <span class="o">(</span><span class="nn">Buffer</span><span class="p">.</span><span class="n">contents</span> <span class="n">buffer</span><span class="o">)</span>

<span class="c">(* @@PLEAC@@_1.9 *)</span>

<span class="c">(* Just use the String module&#39;s uppercase, lowercase, capitalize and</span>
<span class="c"> * uncapitalize *)</span>

<span class="k">let</span> <span class="n">big</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">uppercase</span> <span class="n">little</span><span class="o">;;</span>    <span class="c">(* &quot;bo peep&quot; -&gt; &quot;BO PEEP&quot; *)</span>
<span class="k">let</span> <span class="n">little</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">lowercase</span> <span class="n">big</span><span class="o">;;</span>    <span class="c">(* &quot;JOHN&quot; -&gt; &quot;john&quot; *)</span>
<span class="k">let</span> <span class="n">big</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">capitalize</span> <span class="n">little</span><span class="o">;;</span>   <span class="c">(* &quot;bo&quot; -&gt; &quot;Bo&quot; *)</span>
<span class="k">let</span> <span class="n">little</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">uncapitalize</span> <span class="n">big</span><span class="o">;;</span> <span class="c">(* &quot;BoPeep&quot; -&gt; &quot;boPeep&quot; *)</span>

<span class="c">(* Capitalize each word&#39;s first character, downcase the rest *)</span>
<span class="k">let</span> <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;thIS is a loNG liNE&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">text</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">capitalize</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">lowercase</span> <span class="n">text</span><span class="o">);;</span>
<span class="n">print_endline</span> <span class="n">text</span><span class="o">;;</span>

<span class="c">(*</span>
<span class="c">This is a long line</span>
<span class="c">*)</span>

<span class="c">(* To do case insensitive comparisons *)</span>
<span class="k">if</span> <span class="nn">String</span><span class="p">.</span><span class="n">uppercase</span> <span class="n">a</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">uppercase</span> <span class="n">b</span> <span class="k">then</span>
  <span class="n">print_endline</span> <span class="s2">&quot;a and b are the same</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">randcap</span> <span class="n">fn</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">slurp_to_string</span> <span class="n">fn</span> <span class="k">in</span>
  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">to</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">do</span>
    <span class="k">if</span> <span class="nn">Random</span><span class="p">.</span><span class="n">int</span> <span class="mi">100</span> <span class="o">&lt;</span> <span class="mi">20</span> <span class="k">then</span>
      <span class="nn">String</span><span class="p">.</span><span class="n">blit</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">capitalize</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">s</span> <span class="n">i</span> <span class="mi">1</span><span class="o">))</span> <span class="mi">0</span> <span class="n">s</span>  <span class="n">i</span> <span class="mi">1</span>
  <span class="k">done</span><span class="o">;</span>
  <span class="n">print_string</span> <span class="n">s</span><span class="o">;;</span>


<span class="c">(*</span>
<span class="c"># randcap &quot;/etc/passwd&quot;;;</span>

<span class="c">##</span>
<span class="c"># User DatAbAse</span>
<span class="c">#</span>
<span class="c"># Note That this fIle is consuLTed wHen the sysTeM Is runninG In single-user</span>
<span class="c"># modE.  At other times this iNformAtion is handlEd by one or moRe oF:</span>
<span class="c"># lOokupD DIrectorYServicEs</span>
<span class="c"># By default, lOOkupd getS inFormaTion frOm NetInFo, so thiS fIle will</span>
<span class="c"># not be cOnsultEd unless you hAvE cHaNged LOokupd&#39;s COnfiguratiOn.</span>
<span class="c"># This fiLe is usEd while in siNgle UseR Mode.</span>
<span class="c">#</span>
<span class="c"># TO Use this file for noRmal aUthEnticatIon, you may eNable it With</span>
<span class="c"># /ApPlicatiOns/Utilities/DiRectory AccEss.</span>
<span class="c">##</span>

<span class="c">&lt; ... snip ... &gt;</span>
<span class="c">*)</span>

<span class="c">(* @@PLEAC@@_1.10 *)</span>

<span class="c">(* Again, because of OCaml&#39;s type-safe nature, actual interpolation cannot be</span>
<span class="c"> * done inside of strings -- one must use either string concatenation or sprintf</span>
<span class="c"> * to get the results we&#39;re looking for *)</span>

<span class="k">let</span> <span class="n">phrase</span> <span class="o">=</span> <span class="s2">&quot;I have &quot;</span> <span class="o">^</span> <span class="o">(</span><span class="n">string_of_int</span> <span class="o">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="o">))</span> <span class="o">^</span> <span class="s2">&quot; guanacos.&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">prhase</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">&quot;I have %d guanacos.&quot;</span> <span class="o">(</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="o">);;</span>

<span class="c">(* @@PLEAC@@_1.11 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">var</span> <span class="o">=</span>  <span class="nn">Str</span><span class="p">.</span><span class="n">global_replace</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;^[</span><span class="se">\t</span><span class="s2"> ]+&quot;</span><span class="o">)</span> <span class="s2">&quot;&quot;</span> <span class="s2">&quot;\</span>
<span class="s2">    your text</span>
<span class="s2">    goes here</span>
<span class="s2">&quot;</span><span class="o">;;</span>

<span class="c">(* @@PLEAC@@_1.12 *)</span>

<span class="c">(* We can emulate the Perl wrap function with the following function *)</span>
<span class="k">let</span> <span class="n">wrap</span> <span class="n">width</span> <span class="n">s</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">l</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">split</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot; &quot;</span><span class="o">)</span> <span class="n">s</span> <span class="k">in</span>
  <span class="nn">Format</span><span class="p">.</span><span class="n">pp_set_margin</span> <span class="nn">Format</span><span class="p">.</span><span class="n">str_formatter</span> <span class="n">width</span><span class="o">;</span>
  <span class="nn">Format</span><span class="p">.</span><span class="n">pp_open_box</span> <span class="nn">Format</span><span class="p">.</span><span class="n">str_formatter</span> <span class="mi">0</span><span class="o">;</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span>
      <span class="nn">Format</span><span class="p">.</span><span class="n">pp_print_string</span> <span class="nn">Format</span><span class="p">.</span><span class="n">str_formatter</span> <span class="n">x</span><span class="o">;</span>
      <span class="nn">Format</span><span class="p">.</span><span class="n">pp_print_break</span> <span class="nn">Format</span><span class="p">.</span><span class="n">str_formatter</span> <span class="mi">1</span> <span class="mi">0</span><span class="o">;)</span> <span class="n">l</span><span class="o">;</span>
  <span class="nn">Format</span><span class="p">.</span><span class="n">flush_str_formatter</span> <span class="bp">()</span><span class="o">;;</span>

<span class="c">(*</span>
<span class="c"># let st = &quot;May I say how lovely you are looking today... this wrapping has done wonders for your figure!\n&quot;;;</span>
<span class="c">val st : string =</span>
<span class="c">  &quot;May I say how lovely you are looking today... this wrapping has done wonders for your figure!\n&quot;</span>

<span class="c"># print_string (wrap 50 st);;</span>
<span class="c">May I say how lovely you are looking today...</span>
<span class="c">this wrapping has done wonders for your figure!</span>

<span class="c"># print_string (wrap 30 st);;</span>
<span class="c">May I say how lovely you are</span>
<span class="c">looking today... this</span>
<span class="c">wrapping has done wonders for</span>
<span class="c">your figure!</span>
<span class="c">*)</span>

<span class="c">(* Note that this version doesn&#39;t allow you to specify an opening or standard</span>
<span class="c"> * indentation (I am having trouble getting the Format module to behave as I</span>
<span class="c"> * think it should...).  However, if one only wants to print spaces there</span>
<span class="c"> * instead of arbitrary line leaders, we can use the following version *)</span>

<span class="k">let</span> <span class="n">wrap</span> <span class="o">?(</span><span class="n">lead</span><span class="o">=</span><span class="mi">0</span><span class="o">)</span> <span class="o">?(</span><span class="n">indent</span><span class="o">=</span><span class="mi">0</span><span class="o">)</span> <span class="n">width</span> <span class="n">s</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">l</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">split</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot; &quot;</span><span class="o">)</span> <span class="n">s</span> <span class="k">in</span>
  <span class="nn">Format</span><span class="p">.</span><span class="n">pp_set_margin</span> <span class="nn">Format</span><span class="p">.</span><span class="n">str_formatter</span> <span class="n">width</span><span class="o">;</span>
  <span class="nn">Format</span><span class="p">.</span><span class="n">pp_open_box</span> <span class="nn">Format</span><span class="p">.</span><span class="n">str_formatter</span> <span class="mi">0</span><span class="o">;</span>
  <span class="nn">Format</span><span class="p">.</span><span class="n">pp_print_break</span> <span class="nn">Format</span><span class="p">.</span><span class="n">str_formatter</span> <span class="n">lead</span> <span class="n">indent</span><span class="o">;</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span>
      <span class="nn">Format</span><span class="p">.</span><span class="n">pp_print_string</span> <span class="nn">Format</span><span class="p">.</span><span class="n">str_formatter</span> <span class="n">x</span><span class="o">;</span>
      <span class="nn">Format</span><span class="p">.</span><span class="n">pp_print_break</span> <span class="nn">Format</span><span class="p">.</span><span class="n">str_formatter</span> <span class="mi">1</span> <span class="n">indent</span><span class="o">;)</span> <span class="n">l</span><span class="o">;</span>
  <span class="nn">Format</span><span class="p">.</span><span class="n">flush_str_formatter</span> <span class="bp">()</span><span class="o">;;</span>

<span class="c">(*</span>
<span class="c"># print_string (wrap 20 st);;</span>
<span class="c">May I say how</span>
<span class="c">lovely you are</span>
<span class="c">looking today...</span>
<span class="c">this wrapping has</span>
<span class="c">done wonders for</span>
<span class="c">your figure!</span>
<span class="c"> - : unit = ()</span>

<span class="c"># print_string (wrap ~lead:6 ~indent:2 20 st);;</span>
<span class="c">      May I say how</span>
<span class="c">  lovely you are</span>
<span class="c">  looking today...</span>
<span class="c">  this wrapping has</span>
<span class="c">  done wonders for</span>
<span class="c">  your figure!</span>

<span class="c"># print_string (wrap ~lead:2 20 st);;</span>
<span class="c">  May I say how</span>
<span class="c">lovely you are</span>
<span class="c">looking today...</span>
<span class="c">this wrapping has</span>
<span class="c">done wonders for</span>
<span class="c">your figure!</span>
<span class="c">*)</span>

<span class="c">(* @@PLEAC@@_1.13 *)</span>
<span class="c">(*</span>
<span class="c">** The Str module is deistributed with the standard Ocaml compiler</span>
<span class="c">** suit but it is not automatically pulled in by the command line</span>
<span class="c">** interpreter or the compilers.</span>
<span class="c">**</span>
<span class="c">** The &quot;#load&quot; line is only needed if you are running this in the</span>
<span class="c">** command interpretter.</span>
<span class="c">**</span>
<span class="c">** If you are using either of the ocaml compilers, you will need</span>
<span class="c">** to remove the &quot;#load&quot; line and link in str.cmxa in the final</span>
<span class="c">** compile command.</span>
<span class="c">*)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span> <span class="o">;;</span>

<span class="k">open</span> <span class="nc">Str</span>

<span class="k">let</span> <span class="n">escape</span> <span class="n">charlist</span> <span class="n">str</span> <span class="o">=</span>
	<span class="k">let</span> <span class="n">rx</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="o">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">([&quot;</span> <span class="o">^</span> <span class="n">charlist</span> <span class="o">^</span> <span class="s2">&quot;]</span><span class="se">\\</span><span class="s2">)&quot;</span><span class="o">)</span> <span class="k">in</span>
	<span class="nn">Str</span><span class="p">.</span><span class="n">global_replace</span> <span class="n">rx</span> <span class="s2">&quot;</span><span class="se">\\\\\\</span><span class="s2">1&quot;</span> <span class="n">str</span>

<span class="k">let</span> <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;Mom said, </span><span class="se">\&quot;</span><span class="s2">Don&#39;t do that.</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">;;</span>
<span class="n">print_endline</span> <span class="n">text</span> <span class="o">;;</span>

<span class="k">let</span> <span class="n">text</span> <span class="o">=</span> <span class="n">escape</span> <span class="s2">&quot;&#39;</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="n">text</span> <span class="o">;;</span>
<span class="n">print_endline</span> <span class="n">text</span> <span class="o">;;</span>

<span class="c">(* @@PLEAC@@_1.14 *)</span>

<span class="k">let</span> <span class="n">trim</span> <span class="n">s</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">s&#39;</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;^[ </span><span class="se">\t\n</span><span class="s2">]+&quot;</span><span class="o">)</span> <span class="s2">&quot;&quot;</span> <span class="n">s</span> <span class="k">in</span>
  <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[ </span><span class="se">\t\n</span><span class="s2">]+$&quot;</span><span class="o">)</span> <span class="s2">&quot;&quot;</span> <span class="n">s&#39;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">chop</span> <span class="n">s</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">then</span> <span class="n">s</span> <span class="k">else</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">s</span> <span class="mi">0</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);;</span>

<span class="k">let</span> <span class="n">chomp</span> <span class="o">?(</span><span class="n">c</span><span class="o">=</span><span class="sc">&#39;\n&#39;</span><span class="o">)</span> <span class="n">s</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">then</span> <span class="n">s</span> <span class="k">else</span>
    <span class="k">let</span> <span class="n">len</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">in</span>
    <span class="k">if</span> <span class="n">s</span><span class="o">.[</span><span class="n">len</span><span class="o">]</span> <span class="o">=</span> <span class="n">c</span> <span class="k">then</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">s</span> <span class="mi">0</span> <span class="n">len</span> <span class="k">else</span> <span class="n">s</span><span class="o">;;</span>

<span class="c">(* @@PLEAC@@_1.15 *)</span>

<span class="k">let</span> <span class="n">parse_csv</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">|&quot;</span> <span class="o">[</span>
                             <span class="s2">&quot;</span><span class="se">\&quot;\\</span><span class="s2">([^</span><span class="se">\&quot;\\\\</span><span class="s2">]*</span><span class="se">\\</span><span class="s2">(</span><span class="se">\\\\</span><span class="s2">.[^</span><span class="se">\&quot;\\\\</span><span class="s2">]*</span><span class="se">\\</span><span class="s2">)*</span><span class="se">\\</span><span class="s2">)</span><span class="se">\&quot;</span><span class="s2">,?&quot;</span><span class="o">;</span>
                             <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">([^,]+</span><span class="se">\\</span><span class="s2">),?&quot;</span><span class="o">;</span>
                             <span class="s2">&quot;,&quot;</span><span class="o">;</span>
                           <span class="o">])</span> <span class="k">in</span>
  <span class="k">fun</span> <span class="n">text</span> <span class="o">-&gt;</span>
    <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span> <span class="n">start</span> <span class="n">result</span> <span class="o">=</span>
      <span class="k">if</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">regexp</span> <span class="n">text</span> <span class="n">start</span> <span class="k">then</span>
        <span class="k">let</span> <span class="n">result</span> <span class="o">=</span>
          <span class="o">(</span><span class="k">try</span> <span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">1</span> <span class="n">text</span> <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
             <span class="k">try</span> <span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">3</span> <span class="n">text</span> <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
               <span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="o">::</span> <span class="n">result</span> <span class="k">in</span>
        <span class="n">loop</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">match_end</span> <span class="bp">()</span><span class="o">)</span> <span class="n">result</span>
      <span class="k">else</span>
        <span class="n">result</span> <span class="k">in</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="o">((</span><span class="k">if</span>
                 <span class="k">try</span> <span class="nn">String</span><span class="p">.</span><span class="n">rindex</span> <span class="n">text</span> <span class="sc">&#39;,&#39;</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">text</span> <span class="o">-</span> <span class="mi">1</span>
                 <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">false</span>
               <span class="k">then</span> <span class="o">[</span><span class="s2">&quot;&quot;</span><span class="o">]</span> <span class="k">else</span> <span class="bp">[]</span><span class="o">)</span>
              <span class="o">@</span> <span class="n">loop</span> <span class="mi">0</span> <span class="bp">[]</span><span class="o">)</span>

<span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;XYZZY,</span><span class="se">\&quot;\&quot;</span><span class="s2">,</span><span class="se">\&quot;</span><span class="s2">O&#39;Reilly, Inc</span><span class="se">\&quot;</span><span class="s2">,</span><span class="se">\&quot;</span><span class="s2">Wall, Larry</span><span class="se">\&quot;</span><span class="s2">,</span><span class="se">\&quot;</span><span class="s2">a </span><span class="se">\\\&quot;</span><span class="s2">glug</span><span class="se">\\\&quot;</span><span class="s2"> bit,</span><span class="se">\&quot;</span><span class="s2">,5,</span><span class="se">\&quot;</span><span class="s2">Error, Core Dumped</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">iteri</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">i</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%d : %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">i</span> <span class="n">x</span><span class="o">)</span>
    <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">of_list</span> <span class="o">(</span><span class="n">parse_csv</span> <span class="n">line</span><span class="o">))</span>

<span class="c">(* @@PLEAC@@_1.16 *)</span>

<span class="k">let</span> <span class="n">soundex</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">code_1</span> <span class="o">=</span> <span class="nn">Char</span><span class="p">.</span><span class="n">code</span> <span class="sc">&#39;1&#39;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">code_A</span> <span class="o">=</span> <span class="nn">Char</span><span class="p">.</span><span class="n">code</span> <span class="sc">&#39;A&#39;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">code_Z</span> <span class="o">=</span> <span class="nn">Char</span><span class="p">.</span><span class="n">code</span> <span class="sc">&#39;Z&#39;</span> <span class="k">in</span>

  <span class="k">let</span> <span class="n">trans</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">make</span> <span class="o">(</span><span class="n">code_Z</span> <span class="o">-</span> <span class="n">code_A</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">add_letters</span> <span class="n">number</span> <span class="n">letters</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">add</span> <span class="n">letter</span> <span class="o">=</span>
      <span class="n">trans</span><span class="o">.(</span><span class="nn">Char</span><span class="p">.</span><span class="n">code</span> <span class="n">letter</span> <span class="o">-</span> <span class="n">code_A</span><span class="o">)</span> <span class="o">&lt;-</span> <span class="o">(</span><span class="n">number</span> <span class="o">+</span> <span class="n">code_1</span><span class="o">)</span> <span class="k">in</span>
    <span class="nn">String</span><span class="p">.</span><span class="n">iter</span> <span class="n">add</span> <span class="n">letters</span> <span class="k">in</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">iteri</span> <span class="n">add_letters</span> <span class="o">[|</span> <span class="s2">&quot;BFPV&quot;</span><span class="o">;</span> <span class="s2">&quot;CGJKQSXZ&quot;</span><span class="o">;</span> <span class="s2">&quot;DT&quot;</span><span class="o">;</span> <span class="s2">&quot;L&quot;</span><span class="o">;</span> <span class="s2">&quot;MN&quot;</span><span class="o">;</span> <span class="s2">&quot;R&quot;</span> <span class="o">|];</span>

  <span class="k">fun</span> <span class="o">?(</span><span class="n">length</span><span class="o">=</span><span class="mi">4</span><span class="o">)</span> <span class="n">s</span> <span class="o">-&gt;</span>
    <span class="k">let</span> <span class="n">slength</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">soundex</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="n">length</span> <span class="sc">&#39;0&#39;</span> <span class="k">in</span>
    <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span> <span class="n">i</span> <span class="n">j</span> <span class="n">last</span> <span class="o">=</span>
      <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">slength</span> <span class="o">&amp;&amp;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">length</span> <span class="k">then</span> <span class="k">begin</span>
        <span class="k">let</span> <span class="n">code</span> <span class="o">=</span> <span class="nn">Char</span><span class="p">.</span><span class="n">code</span> <span class="o">(</span><span class="nn">Char</span><span class="p">.</span><span class="n">uppercase</span> <span class="n">s</span><span class="o">.[</span><span class="n">i</span><span class="o">])</span> <span class="k">in</span>
        <span class="k">if</span> <span class="n">code</span> <span class="o">&gt;=</span> <span class="n">code_A</span> <span class="o">&amp;&amp;</span> <span class="n">code</span> <span class="o">&lt;=</span> <span class="n">code_Z</span>
        <span class="k">then</span> <span class="o">(</span><span class="k">if</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
              <span class="k">then</span> <span class="o">(</span><span class="n">soundex</span><span class="o">.[</span><span class="n">j</span><span class="o">]</span> <span class="o">&lt;-</span> <span class="nn">Char</span><span class="p">.</span><span class="n">chr</span> <span class="n">code</span><span class="o">;</span>
                    <span class="n">loop</span> <span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">trans</span><span class="o">.(</span><span class="n">code</span> <span class="o">-</span> <span class="n">code_A</span><span class="o">))</span>
              <span class="k">else</span> <span class="o">(</span><span class="k">match</span> <span class="n">trans</span><span class="o">.(</span><span class="n">code</span> <span class="o">-</span> <span class="n">code_A</span><span class="o">)</span> <span class="k">with</span>
                      <span class="o">|</span> <span class="mi">0</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">j</span> <span class="mi">0</span>
                      <span class="o">|</span> <span class="n">code</span> <span class="k">when</span> <span class="n">code</span> <span class="o">&lt;&gt;</span> <span class="n">last</span> <span class="o">-&gt;</span>
                          <span class="n">soundex</span><span class="o">.[</span><span class="n">j</span><span class="o">]</span> <span class="o">&lt;-</span> <span class="nn">Char</span><span class="p">.</span><span class="n">chr</span> <span class="n">code</span><span class="o">;</span>
                          <span class="n">loop</span> <span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">code</span>
                      <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">j</span> <span class="n">last</span><span class="o">))</span>
        <span class="k">else</span> <span class="n">loop</span> <span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">j</span> <span class="n">last</span>
      <span class="k">end</span> <span class="k">in</span>
    <span class="n">loop</span> <span class="mi">0</span> <span class="mi">0</span> <span class="mi">0</span><span class="o">;</span>
    <span class="n">soundex</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">code</span> <span class="o">=</span> <span class="n">soundex</span> <span class="kt">string</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">codes</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">soundex</span> <span class="kt">list</span><span class="o">;;</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">print_string</span> <span class="s2">&quot;Lookup user: &quot;</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">user</span> <span class="o">=</span> <span class="n">read_line</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="k">if</span> <span class="n">user</span> <span class="o">&lt;&gt;</span> <span class="s2">&quot;&quot;</span> <span class="k">then</span> <span class="k">begin</span>
    <span class="k">let</span> <span class="n">name_code</span> <span class="o">=</span> <span class="n">soundex</span> <span class="n">user</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="o">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">([a-zA-Z_0-9]+</span><span class="se">\\</span><span class="s2">)[^,]*[^a-zA-Z_0-9]+&quot;</span>
                             <span class="o">^</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">([a-zA-Z_0-9]+</span><span class="se">\\</span><span class="s2">)&quot;</span><span class="o">)</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">passwd</span> <span class="o">=</span> <span class="n">open_in</span> <span class="s2">&quot;/etc/passwd&quot;</span> <span class="k">in</span>
    <span class="k">try</span>
      <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
        <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">passwd</span> <span class="k">in</span>
        <span class="k">let</span> <span class="n">name</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">line</span> <span class="mi">0</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">index</span> <span class="n">line</span> <span class="sc">&#39;:&#39;</span><span class="o">)</span> <span class="k">in</span>
        <span class="k">let</span> <span class="o">{</span><span class="nn">Unix</span><span class="p">.</span><span class="n">pw_gecos</span><span class="o">=</span><span class="n">gecos</span><span class="o">}</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">getpwnam</span> <span class="n">name</span> <span class="k">in</span>
        <span class="k">let</span> <span class="o">(</span><span class="n">firstname</span><span class="o">,</span> <span class="n">lastname</span><span class="o">)</span> <span class="o">=</span>
          <span class="k">if</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">regexp</span> <span class="n">gecos</span> <span class="mi">0</span>
          <span class="k">then</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">1</span> <span class="n">gecos</span><span class="o">,</span> <span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">2</span> <span class="n">gecos</span><span class="o">)</span>
          <span class="k">else</span> <span class="o">(</span><span class="s2">&quot;&quot;</span><span class="o">,</span> <span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="k">in</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">name_code</span> <span class="o">=</span> <span class="n">soundex</span> <span class="n">name</span>
            <span class="o">||</span> <span class="n">name_code</span> <span class="o">=</span> <span class="n">soundex</span> <span class="n">lastname</span>
            <span class="o">||</span> <span class="n">name_code</span> <span class="o">=</span> <span class="n">soundex</span> <span class="n">firstname</span><span class="o">)</span>
        <span class="k">then</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s: %s %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">name</span> <span class="n">firstname</span> <span class="n">lastname</span>
      <span class="k">done</span>
    <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
      <span class="n">close_in</span> <span class="n">passwd</span>
  <span class="k">end</span>

<span class="c">(* @@PLEAC@@_1.17 *)</span>
<span class="c">(* fixstyle - switch first set of data strings to second set *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">data</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span>
<span class="k">let</span> <span class="n">keys</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="o">(</span> <span class="o">=&gt;</span> <span class="o">)</span> <span class="n">key</span> <span class="k">value</span> <span class="o">=</span>
    <span class="n">keys</span> <span class="o">:=</span> <span class="n">key</span> <span class="o">::</span> <span class="o">!</span><span class="n">keys</span><span class="o">;</span>
    <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">data</span> <span class="n">key</span> <span class="k">value</span> <span class="k">in</span>
  <span class="o">(</span>
    <span class="s2">&quot;analysed&quot;</span>       <span class="o">=&gt;</span> <span class="s2">&quot;analyzed&quot;</span><span class="o">;</span>
    <span class="s2">&quot;built-in&quot;</span>       <span class="o">=&gt;</span> <span class="s2">&quot;builtin&quot;</span><span class="o">;</span>
    <span class="s2">&quot;chastized&quot;</span>      <span class="o">=&gt;</span> <span class="s2">&quot;chastised&quot;</span><span class="o">;</span>
    <span class="s2">&quot;commandline&quot;</span>    <span class="o">=&gt;</span> <span class="s2">&quot;command-line&quot;</span><span class="o">;</span>
    <span class="s2">&quot;de-allocate&quot;</span>    <span class="o">=&gt;</span> <span class="s2">&quot;deallocate&quot;</span><span class="o">;</span>
    <span class="s2">&quot;dropin&quot;</span>         <span class="o">=&gt;</span> <span class="s2">&quot;drop-in&quot;</span><span class="o">;</span>
    <span class="s2">&quot;hardcode&quot;</span>       <span class="o">=&gt;</span> <span class="s2">&quot;hard-code&quot;</span><span class="o">;</span>
    <span class="s2">&quot;meta-data&quot;</span>      <span class="o">=&gt;</span> <span class="s2">&quot;metadata&quot;</span><span class="o">;</span>
    <span class="s2">&quot;multicharacter&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;multi-character&quot;</span><span class="o">;</span>
    <span class="s2">&quot;multiway&quot;</span>       <span class="o">=&gt;</span> <span class="s2">&quot;multi-way&quot;</span><span class="o">;</span>
    <span class="s2">&quot;non-empty&quot;</span>      <span class="o">=&gt;</span> <span class="s2">&quot;nonempty&quot;</span><span class="o">;</span>
    <span class="s2">&quot;non-profit&quot;</span>     <span class="o">=&gt;</span> <span class="s2">&quot;nonprofit&quot;</span><span class="o">;</span>
    <span class="s2">&quot;non-trappable&quot;</span>  <span class="o">=&gt;</span> <span class="s2">&quot;nontrappable&quot;</span><span class="o">;</span>
    <span class="s2">&quot;pre-define&quot;</span>     <span class="o">=&gt;</span> <span class="s2">&quot;predefine&quot;</span><span class="o">;</span>
    <span class="s2">&quot;preextend&quot;</span>      <span class="o">=&gt;</span> <span class="s2">&quot;pre-extend&quot;</span><span class="o">;</span>
    <span class="s2">&quot;re-compiling&quot;</span>   <span class="o">=&gt;</span> <span class="s2">&quot;recompiling&quot;</span><span class="o">;</span>
    <span class="s2">&quot;reenter&quot;</span>        <span class="o">=&gt;</span> <span class="s2">&quot;re-enter&quot;</span><span class="o">;</span>
    <span class="s2">&quot;turnkey&quot;</span>        <span class="o">=&gt;</span> <span class="s2">&quot;turn-key&quot;</span><span class="o">;</span>
  <span class="o">)</span>

<span class="k">let</span> <span class="n">pattern_text</span> <span class="o">=</span>
  <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">(&quot;</span> <span class="o">^</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">|&quot;</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="nn">Str</span><span class="p">.</span><span class="n">quote</span> <span class="o">!</span><span class="n">keys</span><span class="o">))</span> <span class="o">^</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">)&quot;</span>
<span class="k">let</span> <span class="n">pattern</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="n">pattern_text</span>

<span class="k">let</span> <span class="n">args</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">))</span>

<span class="k">let</span> <span class="n">verbose</span> <span class="o">=</span>
  <span class="k">match</span> <span class="o">!</span><span class="n">args</span> <span class="k">with</span>
    <span class="o">|</span> <span class="s2">&quot;-v&quot;</span> <span class="o">::</span> <span class="n">rest</span> <span class="o">-&gt;</span> <span class="n">args</span> <span class="o">:=</span> <span class="n">rest</span><span class="o">;</span> <span class="bp">true</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">args</span> <span class="o">=</span> <span class="bp">[]</span>
  <span class="k">then</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s: reading from stdin</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">);</span>
        <span class="n">args</span> <span class="o">:=</span> <span class="o">[</span><span class="s2">&quot;-&quot;</span><span class="o">])</span>

<span class="k">let</span> <span class="n">replace_all</span> <span class="n">text</span> <span class="n">line</span> <span class="n">file</span> <span class="o">=</span>
  <span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span>
       <span class="o">(</span><span class="k">function</span>
          <span class="o">|</span> <span class="nn">Str</span><span class="p">.</span><span class="nc">Text</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span>
          <span class="o">|</span> <span class="nn">Str</span><span class="p">.</span><span class="nc">Delim</span> <span class="n">s</span> <span class="o">-&gt;</span>
              <span class="k">if</span> <span class="n">verbose</span>
              <span class="k">then</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s =&gt; %s at %s line %d.</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">s</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">data</span> <span class="n">s</span><span class="o">)</span> <span class="n">file</span> <span class="n">line</span><span class="o">;</span>
              <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">data</span> <span class="n">s</span><span class="o">)</span>
       <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">full_split</span> <span class="n">pattern</span> <span class="n">text</span><span class="o">))</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">file</span> <span class="o">-&gt;</span>
       <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span>
         <span class="k">if</span> <span class="n">file</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
         <span class="k">then</span> <span class="n">stdin</span>
         <span class="k">else</span> <span class="n">open_in</span> <span class="n">file</span> <span class="k">in</span>
       <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
       <span class="k">try</span>
         <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
           <span class="k">let</span> <span class="n">text</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">in_channel</span> <span class="k">in</span>
           <span class="n">incr</span> <span class="n">line</span><span class="o">;</span>
           <span class="n">print_endline</span> <span class="o">(</span><span class="n">replace_all</span> <span class="n">text</span> <span class="o">!</span><span class="n">line</span> <span class="n">file</span><span class="o">)</span>
         <span class="k">done</span>
       <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
         <span class="n">close_in</span> <span class="n">in_channel</span><span class="o">)</span>
    <span class="o">!</span><span class="n">args</span>

<span class="c">(* @@PLEAC@@_1.18 *)</span>
<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* psgrep - print selected lines of ps output by</span>
<span class="c">            compiling user queries into code *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="c">(* Warning: In order to closely approximate the original recipe, this</span>
<span class="c">   example performs dynamic evaluation using the toplevel. This mechanism</span>
<span class="c">   is undocumented and not type-safe. Use at your own risk.</span>

<span class="c">   The &quot;psgrep&quot; utility, defined below, can be used to filter the results</span>
<span class="c">   of the command-line &quot;ps&quot; program. Here are some examples:</span>

<span class="c">   Processes whose command names start with &quot;sh&quot;:</span>

<span class="c">   % psgrep &#39;String.sub command 0 2 = &quot;sh&quot;&#39;</span>

<span class="c">   Processes running with a user ID below 10:</span>

<span class="c">   % psgrep &#39;uid &lt; 10&#39;</span>

<span class="c">   Login shells with active ttys:</span>

<span class="c">   % psgrep &quot;command.[0] = &#39;-&#39;&quot; &#39;tty &lt;&gt; &quot;?&quot;&#39;</span>

<span class="c">   Processes running on pseudo-ttys:</span>

<span class="c">   % psgrep &#39;String.contains &quot;pqrst&quot; tty.[0]&#39;</span>

<span class="c">   Non-superuser processes running detached:</span>

<span class="c">   % psgrep &#39;uid &gt; 0 &amp;&amp; tty = &quot;?&quot;&#39;</span>

<span class="c">   Huge processes that aren&#39;t owned by the superuser:</span>

<span class="c">   % psgrep &#39;vsz &gt; 50000&#39; &#39;uid &lt;&gt; 0&#39;</span>
<span class="c">*)</span>

<span class="c">(* Eval recipe thanks to Clément Capel. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Toploop</span><span class="p">.</span><span class="n">initialize_toplevel_env</span> <span class="bp">()</span>
<span class="k">let</span> <span class="n">eval</span> <span class="n">text</span> <span class="o">=</span> <span class="k">let</span> <span class="n">lexbuf</span> <span class="o">=</span> <span class="o">(</span><span class="nn">Lexing</span><span class="p">.</span><span class="n">from_string</span> <span class="n">text</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">phrase</span> <span class="o">=</span> <span class="o">!</span><span class="nn">Toploop</span><span class="p">.</span><span class="n">parse_toplevel_phrase</span> <span class="n">lexbuf</span> <span class="k">in</span>
  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Toploop</span><span class="p">.</span><span class="n">execute_phrase</span> <span class="bp">false</span> <span class="nn">Format</span><span class="p">.</span><span class="n">std_formatter</span> <span class="n">phrase</span><span class="o">)</span>
<span class="k">let</span> <span class="n">get</span> <span class="n">name</span> <span class="o">=</span> <span class="nn">Obj</span><span class="p">.</span><span class="n">obj</span> <span class="o">(</span><span class="nn">Toploop</span><span class="p">.</span><span class="n">getvalue</span> <span class="n">name</span><span class="o">)</span>
<span class="k">let</span> <span class="n">set</span> <span class="n">name</span> <span class="k">value</span> <span class="o">=</span> <span class="nn">Toploop</span><span class="p">.</span><span class="n">setvalue</span> <span class="n">name</span> <span class="o">(</span><span class="nn">Obj</span><span class="p">.</span><span class="n">repr</span> <span class="k">value</span><span class="o">)</span>

<span class="c">(* Type for &quot;ps&quot; results. *)</span>
<span class="k">type</span> <span class="n">ps</span> <span class="o">=</span>
    <span class="o">{</span><span class="n">f</span> <span class="o">:</span> <span class="kt">int</span><span class="o">;</span> <span class="n">uid</span> <span class="o">:</span> <span class="kt">int</span><span class="o">;</span> <span class="n">pid</span> <span class="o">:</span> <span class="kt">int</span><span class="o">;</span> <span class="n">ppid</span> <span class="o">:</span> <span class="kt">int</span><span class="o">;</span> <span class="n">pri</span> <span class="o">:</span> <span class="kt">int</span><span class="o">;</span> <span class="n">ni</span> <span class="o">:</span> <span class="kt">string</span><span class="o">;</span>
     <span class="n">vsz</span> <span class="o">:</span> <span class="kt">int</span><span class="o">;</span> <span class="n">rss</span> <span class="o">:</span> <span class="kt">int</span><span class="o">;</span> <span class="n">wchan</span> <span class="o">:</span> <span class="kt">string</span><span class="o">;</span> <span class="n">stat</span> <span class="o">:</span> <span class="kt">string</span><span class="o">;</span> <span class="n">tty</span> <span class="o">:</span> <span class="kt">string</span><span class="o">;</span>
     <span class="n">time</span> <span class="o">:</span> <span class="kt">string</span><span class="o">;</span> <span class="n">command</span> <span class="o">:</span> <span class="kt">string</span><span class="o">}</span>

<span class="c">(* Based on the GNU ps from Debian Linux. Other OSs will most likely</span>
<span class="c">   require changes to this format. *)</span>
<span class="k">let</span> <span class="n">parse_ps_line</span> <span class="n">line</span> <span class="o">=</span>
  <span class="nn">Scanf</span><span class="p">.</span><span class="n">sscanf</span> <span class="n">line</span> <span class="s2">&quot;%d %d %d %d %d %s %d %d %6s %4s %10s %4s %s@</span><span class="se">\000</span><span class="s2">&quot;</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">f</span> <span class="n">uid</span> <span class="n">pid</span> <span class="n">ppid</span> <span class="n">pri</span> <span class="n">ni</span> <span class="n">vsz</span> <span class="n">rss</span> <span class="n">wchan</span> <span class="n">stat</span> <span class="n">tty</span> <span class="n">time</span> <span class="n">command</span> <span class="o">-&gt;</span>
       <span class="o">{</span><span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="o">;</span> <span class="n">uid</span><span class="o">=</span><span class="n">uid</span><span class="o">;</span> <span class="n">pid</span><span class="o">=</span><span class="n">pid</span><span class="o">;</span> <span class="n">ppid</span><span class="o">=</span><span class="n">ppid</span><span class="o">;</span> <span class="n">pri</span><span class="o">=</span><span class="n">pri</span><span class="o">;</span> <span class="n">ni</span><span class="o">=</span><span class="n">ni</span><span class="o">;</span>
        <span class="n">vsz</span><span class="o">=</span><span class="n">vsz</span><span class="o">;</span> <span class="n">rss</span><span class="o">=</span><span class="n">rss</span><span class="o">;</span> <span class="n">wchan</span><span class="o">=</span><span class="n">wchan</span><span class="o">;</span> <span class="n">stat</span><span class="o">=</span><span class="n">stat</span><span class="o">;</span> <span class="n">tty</span><span class="o">=</span><span class="n">tty</span><span class="o">;</span>
        <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="o">;</span> <span class="n">command</span><span class="o">=</span><span class="n">command</span><span class="o">})</span>

<span class="k">let</span> <span class="n">eval_predicate</span> <span class="n">ps</span> <span class="n">pred</span> <span class="o">=</span>
  <span class="c">(* Use &quot;eval&quot; to initialize each variable&#39;s name and type,</span>
<span class="c">     then use &quot;set&quot; to set a value. *)</span>
  <span class="n">eval</span> <span class="s2">&quot;let f = 0;;&quot;</span><span class="o">;</span>          <span class="n">set</span> <span class="s2">&quot;f&quot;</span> <span class="n">ps</span><span class="o">.</span><span class="n">f</span><span class="o">;</span>
  <span class="n">eval</span> <span class="s2">&quot;let uid = 0;;&quot;</span><span class="o">;</span>        <span class="n">set</span> <span class="s2">&quot;uid&quot;</span> <span class="n">ps</span><span class="o">.</span><span class="n">uid</span><span class="o">;</span>
  <span class="n">eval</span> <span class="s2">&quot;let pid = 0;;&quot;</span><span class="o">;</span>        <span class="n">set</span> <span class="s2">&quot;pid&quot;</span> <span class="n">ps</span><span class="o">.</span><span class="n">pid</span><span class="o">;</span>
  <span class="n">eval</span> <span class="s2">&quot;let ppid = 0;;&quot;</span><span class="o">;</span>       <span class="n">set</span> <span class="s2">&quot;ppid&quot;</span> <span class="n">ps</span><span class="o">.</span><span class="n">ppid</span><span class="o">;</span>
  <span class="n">eval</span> <span class="s2">&quot;let pri = 0;;&quot;</span><span class="o">;</span>        <span class="n">set</span> <span class="s2">&quot;pri&quot;</span> <span class="n">ps</span><span class="o">.</span><span class="n">pri</span><span class="o">;</span>
  <span class="n">eval</span> <span class="s2">&quot;let ni = </span><span class="se">\&quot;\&quot;</span><span class="s2">;;&quot;</span><span class="o">;</span>      <span class="n">set</span> <span class="s2">&quot;ni&quot;</span> <span class="n">ps</span><span class="o">.</span><span class="n">ni</span><span class="o">;</span>
  <span class="n">eval</span> <span class="s2">&quot;let vsz = 0;;&quot;</span><span class="o">;</span>        <span class="n">set</span> <span class="s2">&quot;vsz&quot;</span> <span class="n">ps</span><span class="o">.</span><span class="n">vsz</span><span class="o">;</span>
  <span class="n">eval</span> <span class="s2">&quot;let rss = 0;;&quot;</span><span class="o">;</span>        <span class="n">set</span> <span class="s2">&quot;rss&quot;</span> <span class="n">ps</span><span class="o">.</span><span class="n">rss</span><span class="o">;</span>
  <span class="n">eval</span> <span class="s2">&quot;let wchan = </span><span class="se">\&quot;\&quot;</span><span class="s2">;;&quot;</span><span class="o">;</span>   <span class="n">set</span> <span class="s2">&quot;wchan&quot;</span> <span class="n">ps</span><span class="o">.</span><span class="n">wchan</span><span class="o">;</span>
  <span class="n">eval</span> <span class="s2">&quot;let stat = </span><span class="se">\&quot;\&quot;</span><span class="s2">;;&quot;</span><span class="o">;</span>    <span class="n">set</span> <span class="s2">&quot;stat&quot;</span> <span class="n">ps</span><span class="o">.</span><span class="n">stat</span><span class="o">;</span>
  <span class="n">eval</span> <span class="s2">&quot;let tty = </span><span class="se">\&quot;\&quot;</span><span class="s2">;;&quot;</span><span class="o">;</span>     <span class="n">set</span> <span class="s2">&quot;tty&quot;</span> <span class="n">ps</span><span class="o">.</span><span class="n">tty</span><span class="o">;</span>
  <span class="n">eval</span> <span class="s2">&quot;let time = </span><span class="se">\&quot;\&quot;</span><span class="s2">;;&quot;</span><span class="o">;</span>    <span class="n">set</span> <span class="s2">&quot;time&quot;</span> <span class="n">ps</span><span class="o">.</span><span class="n">time</span><span class="o">;</span>
  <span class="n">eval</span> <span class="s2">&quot;let command = </span><span class="se">\&quot;\&quot;</span><span class="s2">;;&quot;</span><span class="o">;</span> <span class="n">set</span> <span class="s2">&quot;command&quot;</span> <span class="n">ps</span><span class="o">.</span><span class="n">command</span><span class="o">;</span>
  <span class="c">(* Evaluate expression and return result as boolean. *)</span>
  <span class="n">eval</span> <span class="o">(</span><span class="s2">&quot;let result = (&quot;</span> <span class="o">^</span> <span class="n">pred</span> <span class="o">^</span> <span class="s2">&quot;);;&quot;</span><span class="o">);</span>
  <span class="o">(</span><span class="n">get</span> <span class="s2">&quot;result&quot;</span> <span class="o">:</span> <span class="kt">bool</span><span class="o">)</span>

<span class="k">exception</span> <span class="nc">TypeError</span> <span class="k">of</span> <span class="kt">string</span>
<span class="k">exception</span> <span class="nc">SyntaxError</span> <span class="k">of</span> <span class="kt">string</span>

<span class="k">let</span> <span class="n">preds</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">preds</span> <span class="o">=</span> <span class="bp">[]</span>
  <span class="k">then</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;usage: %s criterion ...</span>
<span class="s2">    Each criterion is an OCaml expression involving:</span>
<span class="s2">     f uid pid ppid pri ni vsz rss wchan stat tty time command</span>
<span class="s2">    All criteria must be met for a line to be printed.</span>
<span class="s2">&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">);</span> <span class="n">exit</span> <span class="mi">0</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">proc</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_in</span> <span class="s2">&quot;ps wwaxl&quot;</span> <span class="k">in</span>
  <span class="k">try</span>
    <span class="n">print_endline</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">proc</span><span class="o">);</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">proc</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">ps</span> <span class="o">=</span> <span class="n">parse_ps_line</span> <span class="n">line</span> <span class="k">in</span>
      <span class="k">if</span> <span class="nn">List</span><span class="p">.</span><span class="n">for_all</span>
        <span class="o">(</span><span class="k">fun</span> <span class="n">pred</span> <span class="o">-&gt;</span>
           <span class="k">try</span> <span class="n">eval_predicate</span> <span class="n">ps</span> <span class="n">pred</span>
           <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span>
             <span class="c">(* Convert exceptions to strings to avoid depending on</span>
<span class="c">                additional toplevel libraries. *)</span>
             <span class="k">match</span> <span class="nn">Printexc</span><span class="p">.</span><span class="n">to_string</span> <span class="n">e</span> <span class="k">with</span>
               <span class="o">|</span> <span class="s2">&quot;Typecore.Error(_, _)&quot;</span> <span class="o">-&gt;</span> <span class="k">raise</span> <span class="o">(</span><span class="nc">TypeError</span> <span class="n">pred</span><span class="o">)</span>
               <span class="o">|</span> <span class="s2">&quot;Syntaxerr.Error(_)&quot;</span>
               <span class="o">|</span> <span class="s2">&quot;Lexer.Error(1, _)&quot;</span>
               <span class="o">|</span> <span class="s2">&quot;Lexer.Error(_, _)&quot;</span> <span class="o">-&gt;</span> <span class="k">raise</span> <span class="o">(</span><span class="nc">SyntaxError</span> <span class="n">pred</span><span class="o">)</span>
               <span class="o">|</span> <span class="s2">&quot;Misc.Fatal_error&quot;</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="n">pred</span>
               <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">raise</span> <span class="n">e</span><span class="o">)</span>
        <span class="n">preds</span>
      <span class="k">then</span> <span class="n">print_endline</span> <span class="n">line</span>
    <span class="k">done</span>
  <span class="k">with</span>
    <span class="o">|</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
        <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_in</span> <span class="n">proc</span><span class="o">)</span>
    <span class="o">|</span> <span class="n">e</span> <span class="o">-&gt;</span>
        <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_in</span> <span class="n">proc</span><span class="o">);</span>
        <span class="k">raise</span> <span class="n">e</span>


<span class="c">(* @@PLEAC@@_2.1 *)</span>

<span class="c">(* Something like this must be done differently in OCaml because of its</span>
<span class="c">* type-safety.  Some of the tests will use regular expressions, but most won&#39;t *)</span>
<span class="k">let</span> <span class="n">has_NonDigits</span> <span class="n">s</span> <span class="o">=</span>
  <span class="k">try</span> <span class="n">ignore</span> <span class="o">(</span><span class="n">search_forward</span> <span class="o">(</span><span class="n">regexp</span> <span class="s2">&quot;[^0-9]&quot;</span><span class="o">)</span> <span class="n">s</span><span class="o">);</span> <span class="bp">true</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">true</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">is_NaturalNumber</span> <span class="n">s</span> <span class="o">=</span>
  <span class="k">try</span> <span class="k">let</span> <span class="n">n</span> <span class="o">=</span> <span class="n">int_of_string</span> <span class="n">s</span> <span class="k">in</span> <span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">with</span> <span class="nc">Failure</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">false</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">is_Integer</span> <span class="n">s</span> <span class="o">=</span>
  <span class="k">try</span> <span class="n">ignore</span><span class="o">(</span><span class="n">int_of_string</span> <span class="n">s</span><span class="o">);</span> <span class="bp">true</span> <span class="k">with</span> <span class="nc">Failure</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">false</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">is_DecimalNumber</span> <span class="n">s</span> <span class="o">=</span>
  <span class="k">try</span> <span class="n">ignore</span><span class="o">(</span><span class="n">int_of_string</span> <span class="n">s</span><span class="o">);</span> <span class="bp">true</span> <span class="k">with</span> <span class="nc">Failure</span> <span class="o">_</span> <span class="o">-&gt;</span>
    <span class="k">try</span> <span class="k">let</span> <span class="n">n</span> <span class="o">=</span> <span class="n">float_of_string</span> <span class="n">s</span> <span class="k">in</span> <span class="o">(</span><span class="n">abs_float</span> <span class="n">f</span><span class="o">)</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="o">.</span>
    <span class="k">with</span> <span class="nc">Failure</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">false</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">is_CFloat</span> <span class="n">s</span> <span class="o">=</span>
  <span class="k">try</span> <span class="n">ignore</span><span class="o">(</span><span class="n">float_of_string</span> <span class="n">s</span><span class="o">);</span> <span class="bp">true</span>
  <span class="k">with</span> <span class="nc">Failure</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">false</span><span class="o">;;</span>

<span class="c">(* One of the above predicates can then be used as needed *)</span>
<span class="k">if</span> <span class="n">predicate</span> <span class="n">s</span> <span class="k">then</span>
  <span class="c">(* is a number *)</span>
<span class="k">else</span>
  <span class="c">(* is not a number *)</span>

<span class="c">(* @@PLEAC@@_2.2 *)</span>
<span class="c">(*-----------------------------*)</span>
<span class="c">(* equalStr num1 num2 accuracy returns true if num1 and num2</span>
<span class="c">   are equal to accuracy decimal places *)</span>

<span class="c">(* done by converting to strings, a la the Perl example *)</span>
<span class="k">let</span> <span class="n">equalStr</span> <span class="n">num1</span> <span class="n">num2</span> <span class="n">accuracy</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">p</span> <span class="n">x</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">&quot;%.*f&quot;</span> <span class="n">accuracy</span> <span class="n">x</span> <span class="k">in</span>
  <span class="o">(</span><span class="n">p</span> <span class="n">num1</span><span class="o">)</span> <span class="o">=</span> <span class="o">(</span><span class="n">p</span> <span class="n">num2</span><span class="o">)</span>

<span class="c">(* Done in a more or less sane way, i.e. treating them as numbers *)</span>
<span class="k">let</span> <span class="n">equal</span> <span class="n">num1</span> <span class="n">num2</span> <span class="n">accuracy</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">chop</span> <span class="n">x</span> <span class="o">=</span> <span class="n">floor</span> <span class="o">(</span><span class="n">x</span> <span class="o">*.</span> <span class="o">(</span><span class="mi">10</span><span class="o">.</span> <span class="o">**</span> <span class="o">(</span><span class="kt">float</span> <span class="n">accuracy</span><span class="o">)))</span> <span class="k">in</span>
  <span class="o">(</span><span class="n">chop</span> <span class="n">num1</span><span class="o">)</span> <span class="o">=</span> <span class="o">(</span><span class="n">chop</span> <span class="n">num2</span><span class="o">);;</span>

<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="n">wage</span> <span class="o">=</span> <span class="mi">536</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">week</span> <span class="o">=</span> <span class="mi">40</span> <span class="o">*</span> <span class="n">wage</span><span class="o">;;</span>
<span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;One week&#39;s wage is %.2f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">((</span><span class="kt">float</span> <span class="n">week</span><span class="o">)</span> <span class="o">/.</span> <span class="mi">100</span><span class="o">.);;</span>
<span class="c">(*-----------------------------*)</span>

<span class="c">(* @@PLEAC@@_2.3 *)</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="n">rounded</span> <span class="n">digits</span> <span class="n">fl</span> <span class="o">=</span> <span class="n">float_of_string</span> <span class="o">(</span><span class="n">sprintf</span> <span class="s2">&quot;%.*f&quot;</span> <span class="n">digits</span> <span class="n">fl</span><span class="o">);;</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="mi">255</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">b</span> <span class="o">=</span> <span class="n">float_of_string</span> <span class="o">(</span><span class="n">sprintf</span> <span class="s2">&quot;%.2f&quot;</span> <span class="n">a</span><span class="o">);;</span>
<span class="k">let</span> <span class="n">c</span> <span class="o">=</span> <span class="n">rounded</span> <span class="mi">2</span> <span class="n">a</span><span class="o">;;</span>
<span class="n">printf</span> <span class="s2">&quot;Unrounded %f</span><span class="se">\n</span><span class="s2">Rounded %f</span><span class="se">\n</span><span class="s2">Other rounded %f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">a</span> <span class="n">b</span> <span class="n">c</span><span class="o">;;</span>
<span class="n">printf</span> <span class="s2">&quot;Unrounded %f</span><span class="se">\n</span><span class="s2">Rounded %.2f</span><span class="se">\n</span><span class="s2">Other rounded %f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">a</span> <span class="n">c</span> <span class="o">(</span><span class="n">rounded</span> <span class="mi">2</span> <span class="n">a</span><span class="o">);;</span>

<span class="c">(*</span>
<span class="c"> * Unrounded 0.255000</span>
<span class="c"> * Rounded 0.260000</span>
<span class="c"> * Other rounded 0.260000</span>
<span class="c"> * Unrounded 0.255000</span>
<span class="c"> * Rounded 0.26</span>
<span class="c"> * Other rounded 0.260000</span>
<span class="c"> *)</span>

<span class="c">(*-----------------------------*)</span>
<span class="c">(* To &quot;round&quot; to the nearest integer, use ceil, floor, or truncate.  Note that</span>
<span class="c">truncate converts the float to an integer, so a conversion back to a float is</span>
<span class="c">necessary *)</span>
<span class="k">let</span> <span class="n">fs</span> <span class="o">=</span> <span class="o">[</span><span class="mi">3</span><span class="o">.</span><span class="mi">3</span><span class="o">;</span> <span class="mi">3</span><span class="o">.</span><span class="mi">5</span><span class="o">;</span> <span class="mi">3</span><span class="o">.</span><span class="mi">7</span><span class="o">;</span> <span class="o">-.</span> <span class="mi">3</span><span class="o">.</span><span class="mi">3</span><span class="o">];;</span>
<span class="n">printf</span> <span class="s2">&quot;number</span><span class="se">\t</span><span class="s2">int</span><span class="se">\t</span><span class="s2">floor</span><span class="se">\t</span><span class="s2">ceil</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">printf</span> <span class="s2">&quot;%.1f</span><span class="se">\t</span><span class="s2">%.1f</span><span class="se">\t</span><span class="s2">%.1f</span><span class="se">\t</span><span class="s2">%.1f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">x</span> <span class="o">(</span><span class="kt">float</span> <span class="o">(</span><span class="n">truncate</span> <span class="n">x</span><span class="o">))</span> <span class="o">(</span><span class="n">floor</span> <span class="n">x</span><span class="o">)</span> <span class="o">(</span><span class="n">ceil</span> <span class="n">x</span><span class="o">))</span>
  <span class="n">fs</span><span class="o">;;</span>

<span class="c">(*</span>
<span class="c"> * number	int	floor	ceil</span>
<span class="c"> * 3.3	3.0	3.0	4.0</span>
<span class="c"> * 3.5	3.0	3.0	4.0</span>
<span class="c"> * 3.7	3.0	3.0	4.0</span>
<span class="c"> * -3.3	-3.0	-4.0	-3.0</span>
<span class="c"> *)</span>

<span class="c">(* Or if you really want an integer in column 2 *)</span>
<span class="n">printf</span> <span class="s2">&quot;number</span><span class="se">\t</span><span class="s2">int</span><span class="se">\t</span><span class="s2">floor</span><span class="se">\t</span><span class="s2">ceil</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">printf</span> <span class="s2">&quot;%.1f</span><span class="se">\t</span><span class="s2">%d</span><span class="se">\t</span><span class="s2">%.1f</span><span class="se">\t</span><span class="s2">%.1f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">x</span> <span class="o">(</span><span class="n">truncate</span> <span class="n">x</span><span class="o">)</span> <span class="o">(</span><span class="n">floor</span> <span class="n">x</span><span class="o">)</span> <span class="o">(</span><span class="n">ceil</span> <span class="n">x</span><span class="o">))</span>
  <span class="n">fs</span><span class="o">;;</span>

<span class="c">(*</span>
<span class="c"> * number	int	floor	ceil</span>
<span class="c"> * 3.3	3	3.0	4.0</span>
<span class="c"> * 3.5	3	3.0	4.0</span>
<span class="c"> * 3.7	3	3.0	4.0</span>
<span class="c"> * -3.3	-3	-4.0	-3.0</span>
<span class="c"> *)</span>

<span class="c">(* @@PLEAC@@_2.4 *)</span>

<span class="c">(*-----------------------------*)</span>
<span class="c">(*</span>
<span class="c"> * Two versions in each direction -- one to deal with decimal strings,</span>
<span class="c"> * and the other to deal with decimal integers.  Binary numbers will</span>
<span class="c"> * always be strings</span>
<span class="c"> *)</span>

<span class="k">let</span> <span class="n">binStr_of_decInt</span> <span class="n">i</span> <span class="o">=</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">strip_bits</span> <span class="n">i</span> <span class="n">s</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">i</span> <span class="k">with</span>
      <span class="mi">0</span> <span class="o">-&gt;</span> <span class="n">s</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">strip_bits</span> <span class="o">(</span><span class="n">i</span> <span class="n">lsr</span> <span class="mi">1</span><span class="o">)</span> <span class="o">((</span><span class="n">string_of_int</span> <span class="o">(</span><span class="n">i</span> <span class="ow">land</span> <span class="mh">0x01</span><span class="o">))</span> <span class="o">^</span> <span class="n">s</span><span class="o">)</span> <span class="k">in</span>
  <span class="n">strip_bits</span> <span class="n">i</span> <span class="s2">&quot;&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">binStr_of_decStr</span> <span class="n">i</span> <span class="o">=</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">strip_bits</span> <span class="n">i</span> <span class="n">s</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">i</span> <span class="k">with</span>
      <span class="mi">0</span> <span class="o">-&gt;</span> <span class="n">s</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">strip_bits</span> <span class="o">(</span><span class="n">i</span> <span class="n">lsr</span> <span class="mi">1</span><span class="o">)</span> <span class="o">((</span><span class="n">string_of_int</span> <span class="o">(</span><span class="n">i</span> <span class="ow">land</span> <span class="mh">0x01</span><span class="o">))</span> <span class="o">^</span> <span class="n">s</span><span class="o">)</span> <span class="k">in</span>
  <span class="n">strip_bits</span> <span class="o">(</span><span class="n">int_of_string</span> <span class="n">i</span><span class="o">)</span> <span class="s2">&quot;&quot;</span><span class="o">;;</span>
<span class="c">(* Of course if you have binStr_of_decInt already, it&#39;s easier to just call</span>
<span class="c">   binStr_of_decInt (int_of_string i) *)</span>

<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="n">decInt_of_binStr</span> <span class="n">s</span> <span class="o">=</span>
  <span class="n">int_of_string</span> <span class="o">(</span><span class="s2">&quot;0b&quot;</span> <span class="o">^</span> <span class="n">s</span><span class="o">);;</span>

<span class="k">let</span> <span class="n">decStr_of_binStr</span> <span class="n">s</span> <span class="o">=</span>
  <span class="n">string_of_int</span> <span class="o">(</span><span class="n">int_of_string</span> <span class="o">(</span><span class="s2">&quot;0b&quot;</span> <span class="o">^</span> <span class="n">s</span><span class="o">));;</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="n">numInt</span> <span class="o">=</span> <span class="n">decInt_of_binStr</span> <span class="s2">&quot;0110110&quot;</span><span class="o">;;</span> <span class="c">(* numInt = 54 *)</span>
<span class="k">let</span> <span class="n">numInt</span> <span class="o">=</span> <span class="n">decStr_of_binStr</span> <span class="s2">&quot;0110110&quot;</span><span class="o">;;</span> <span class="c">(* numInt = &quot;54&quot; *)</span>
<span class="k">let</span> <span class="n">bin1</span> <span class="o">=</span> <span class="n">binStr_of_decInt</span> <span class="mi">54</span><span class="o">;;</span>   <span class="c">(* bin1 = &quot;110110&quot; *)</span>
<span class="k">let</span> <span class="n">bin2</span> <span class="o">=</span> <span class="n">binStr_of_decStr</span> <span class="s2">&quot;54&quot;</span><span class="o">;;</span> <span class="c">(* bin2 = &quot;110110&quot; *)</span>
<span class="c">(*-----------------------------*)</span>

<span class="c">(* @@PLEAC@@_2.5 *)</span>
<span class="c">(*-----------------------------*)</span>
<span class="c">(* The boring way is to use a for loop... *)</span>
<span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="n">low</span> <span class="k">to</span> <span class="n">high</span> <span class="k">do</span>
  <span class="c">(* Do your stuff *)</span>
  <span class="c">(* Note, if what you want to do in the loop does not have have type unit, you</span>
<span class="c">     need to wrap it with ignore, e.g. ignore (2 * i) *)</span>
<span class="k">done</span>

<span class="c">(* Or you skip the syntactic sugar and write it recursively yourself *)</span>
<span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span> <span class="n">low</span> <span class="n">high</span> <span class="n">f</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">low</span> <span class="o">&gt;</span> <span class="n">high</span> <span class="k">then</span>
    <span class="bp">()</span>
  <span class="k">else</span>
    <span class="k">begin</span>
      <span class="n">ignore</span> <span class="o">(</span><span class="n">f</span> <span class="n">low</span><span class="o">);</span>
      <span class="n">loop</span> <span class="o">(</span><span class="n">succ</span> <span class="n">low</span><span class="o">)</span> <span class="n">high</span> <span class="n">f</span>
    <span class="k">end</span><span class="o">;;</span>

<span class="c">(* and now with stepsize different from 1 *)</span>
<span class="k">let</span> <span class="k">rec</span> <span class="n">loopStep</span> <span class="n">low</span> <span class="n">high</span> <span class="n">step</span> <span class="n">f</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">low</span> <span class="o">&gt;</span> <span class="n">high</span> <span class="k">then</span>
    <span class="bp">()</span>
  <span class="k">else</span>
    <span class="k">begin</span>
      <span class="n">ignore</span> <span class="o">(</span><span class="n">f</span> <span class="n">low</span><span class="o">);</span>
      <span class="n">loopStep</span> <span class="o">(</span><span class="n">low</span> <span class="o">+</span> <span class="n">step</span><span class="o">)</span> <span class="n">high</span> <span class="n">f</span>
    <span class="k">end</span><span class="o">;;</span>


<span class="c">(* Or, if you don&#39;t mind wasting space, you can use the useful iter functions</span>
<span class="c"> *)</span>
<span class="c">(* Array based *)</span>
<span class="k">let</span> <span class="n">makeArraySequence</span> <span class="n">lo</span> <span class="n">hi</span> <span class="o">=</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">init</span> <span class="o">(</span><span class="n">hi</span> <span class="o">-</span> <span class="n">lo</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">(</span><span class="k">fun</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">i</span> <span class="o">+</span> <span class="n">lo</span><span class="o">);;</span>
<span class="nn">Array</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span> <span class="n">your</span> <span class="k">function</span> <span class="n">here</span> <span class="o">)</span> <span class="o">(</span><span class="n">makeArraySequence</span> <span class="n">lo</span> <span class="n">hi</span><span class="o">);;</span>

<span class="c">(* List based *)</span>
<span class="k">let</span> <span class="n">makeListSequence</span> <span class="n">lo</span> <span class="n">hi</span> <span class="o">=</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">msHelper</span> <span class="n">lo</span> <span class="n">hi</span> <span class="n">l</span> <span class="o">=</span>
    <span class="k">match</span> <span class="o">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="o">)</span> <span class="k">with</span>
    <span class="mi">0</span> <span class="o">-&gt;</span> <span class="n">b</span><span class="o">::</span><span class="n">l</span>
	<span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">msHelper</span> <span class="n">a</span> <span class="o">(</span><span class="n">b</span><span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="o">(</span><span class="n">b</span><span class="o">::</span><span class="n">l</span><span class="o">)</span> <span class="k">in</span>
  <span class="n">msHelper</span> <span class="n">lo</span> <span class="n">hi</span> <span class="bp">[]</span><span class="o">;;</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span> <span class="n">your</span> <span class="k">function</span> <span class="n">here</span> <span class="o">)</span> <span class="o">(</span><span class="n">makeListSequence</span> <span class="n">lo</span> <span class="n">hi</span><span class="o">);;</span>
<span class="c">(*-----------------------------*)</span>
<span class="n">printf</span> <span class="s2">&quot;Infancy is: &quot;</span><span class="o">;</span>
<span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">to</span> <span class="mi">2</span> <span class="k">do</span>
  <span class="n">printf</span> <span class="s2">&quot;%d &quot;</span> <span class="n">i</span>
<span class="k">done</span><span class="o">;;</span>

<span class="n">print_newline</span><span class="bp">()</span><span class="o">;;</span>

<span class="n">printf</span> <span class="s2">&quot;Toddling is: &quot;</span><span class="o">;</span>
<span class="n">loop</span> <span class="mi">3</span> <span class="mi">4</span> <span class="o">(</span><span class="k">fun</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">printf</span> <span class="s2">&quot;%d &quot;</span> <span class="n">i</span><span class="o">);;</span>

<span class="n">print_newline</span> <span class="bp">()</span><span class="o">;;</span>

<span class="n">printf</span> <span class="s2">&quot;Childhood is: &quot;</span><span class="o">;</span>
<span class="nn">Array</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">printf</span> <span class="s2">&quot;%d &quot;</span> <span class="n">i</span><span class="o">)</span> <span class="o">(</span><span class="n">makeArraySequence</span> <span class="mi">5</span> <span class="mi">12</span><span class="o">);;</span>

<span class="n">print_newline</span><span class="bp">()</span><span class="o">;;</span>

<span class="c">(*</span>
<span class="c"> * Infancy is: 0 1 2</span>
<span class="c"> * Toddling is: 3 4</span>
<span class="c"> * Childhood is: 5 6 7 8 9 10 11 12</span>
<span class="c"> *)</span>
<span class="c">(*-----------------------------*)</span>

<span class="c">(* @@PLEAC@@_2.6 *)</span>
<span class="c">(* Based on Groovy version by Paul King. *)</span>

<span class="k">let</span> <span class="n">roman_map</span> <span class="o">=</span>
  <span class="o">[</span><span class="mi">1000</span><span class="o">,</span> <span class="s2">&quot;M&quot;</span><span class="o">;</span> <span class="mi">900</span><span class="o">,</span> <span class="s2">&quot;CM&quot;</span><span class="o">;</span> <span class="mi">500</span><span class="o">,</span> <span class="s2">&quot;D&quot;</span><span class="o">;</span> <span class="mi">400</span><span class="o">,</span> <span class="s2">&quot;CD&quot;</span><span class="o">;</span> <span class="mi">100</span><span class="o">,</span> <span class="s2">&quot;C&quot;</span><span class="o">;</span> <span class="mi">90</span><span class="o">,</span> <span class="s2">&quot;XC&quot;</span><span class="o">;</span>
   <span class="mi">50</span><span class="o">,</span>   <span class="s2">&quot;L&quot;</span><span class="o">;</span> <span class="mi">40</span><span class="o">,</span>  <span class="s2">&quot;XL&quot;</span><span class="o">;</span> <span class="mi">10</span><span class="o">,</span>  <span class="s2">&quot;X&quot;</span><span class="o">;</span> <span class="mi">9</span><span class="o">,</span>   <span class="s2">&quot;IX&quot;</span><span class="o">;</span> <span class="mi">5</span><span class="o">,</span>   <span class="s2">&quot;V&quot;</span><span class="o">;</span> <span class="mi">4</span><span class="o">,</span>  <span class="s2">&quot;IV&quot;</span><span class="o">;</span> <span class="mi">1</span><span class="o">,</span> <span class="s2">&quot;I&quot;</span><span class="o">]</span>

<span class="k">let</span> <span class="n">roman</span> <span class="n">arabic</span> <span class="o">=</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span> <span class="n">remains</span> <span class="n">text</span> <span class="n">map</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">map</span> <span class="k">with</span>
      <span class="o">|</span> <span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="k">value</span><span class="o">)</span> <span class="o">::</span> <span class="n">rest</span> <span class="o">-&gt;</span>
          <span class="k">if</span> <span class="n">remains</span> <span class="o">&gt;=</span> <span class="n">key</span>
          <span class="k">then</span> <span class="n">loop</span> <span class="o">(</span><span class="n">remains</span> <span class="o">-</span> <span class="n">key</span><span class="o">)</span> <span class="o">(</span><span class="n">text</span> <span class="o">^</span> <span class="k">value</span><span class="o">)</span> <span class="n">map</span>
          <span class="k">else</span> <span class="n">loop</span> <span class="n">remains</span> <span class="n">text</span> <span class="n">rest</span>
      <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="n">text</span> <span class="k">in</span>
  <span class="n">loop</span> <span class="n">arabic</span> <span class="s2">&quot;&quot;</span> <span class="n">roman_map</span>

<span class="k">let</span> <span class="n">arabic</span> <span class="n">roman</span> <span class="o">=</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span> <span class="n">text</span> <span class="n">sum</span> <span class="n">map</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">map</span> <span class="k">with</span>
      <span class="o">|</span> <span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="k">value</span><span class="o">)</span> <span class="o">::</span> <span class="n">rest</span> <span class="o">-&gt;</span>
          <span class="k">if</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">text</span> <span class="o">&gt;=</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="k">value</span>
              <span class="o">&amp;&amp;</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">text</span> <span class="mi">0</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="k">value</span><span class="o">)</span> <span class="o">=</span> <span class="k">value</span><span class="o">)</span>
          <span class="k">then</span> <span class="o">(</span><span class="n">loop</span>
                  <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">sub</span>
                     <span class="n">text</span>
                     <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="k">value</span><span class="o">)</span>
                     <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">text</span> <span class="o">-</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="k">value</span><span class="o">))</span>
                  <span class="o">(</span><span class="n">sum</span> <span class="o">+</span> <span class="n">key</span><span class="o">)</span>
                  <span class="n">map</span><span class="o">)</span>
          <span class="k">else</span> <span class="n">loop</span> <span class="n">text</span> <span class="n">sum</span> <span class="n">rest</span>
      <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="n">sum</span> <span class="k">in</span>
  <span class="n">loop</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">uppercase</span> <span class="n">roman</span><span class="o">)</span> <span class="mi">0</span> <span class="n">roman_map</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Alternative version by Ken Wakita. *)</span>
<span class="k">let</span> <span class="n">roman</span> <span class="n">arabic</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">nstr</span> <span class="n">s</span> <span class="n">n</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">make</span> <span class="n">n</span> <span class="n">s</span><span class="o">))</span> <span class="k">in</span>
  <span class="n">snd</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">fold_left</span>
         <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">arabic</span><span class="o">,</span> <span class="n">roman</span><span class="o">)</span> <span class="o">(</span><span class="n">arab</span><span class="o">,</span> <span class="n">rom</span><span class="o">)</span> <span class="o">-&gt;</span>
           <span class="n">arabic</span> <span class="ow">mod</span> <span class="n">arab</span><span class="o">,</span> <span class="n">roman</span> <span class="o">^</span> <span class="o">(</span><span class="n">nstr</span> <span class="n">rom</span> <span class="o">(</span><span class="n">arabic</span> <span class="o">/</span> <span class="n">arab</span><span class="o">)))</span>
         <span class="o">(</span><span class="n">arabic</span><span class="o">,</span> <span class="s2">&quot;&quot;</span><span class="o">)</span>
         <span class="n">roman_map</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">roman_fifteen</span> <span class="o">=</span> <span class="n">roman</span> <span class="mi">15</span> <span class="k">in</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Roman for fifteen is %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">roman_fifteen</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">arabic_fifteen</span> <span class="o">=</span> <span class="n">arabic</span> <span class="n">roman_fifteen</span> <span class="k">in</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Converted back, %s is %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">roman_fifteen</span> <span class="n">arabic_fifteen</span>

<span class="c">(* Roman for fifteen is XV</span>
<span class="c">   Converted back, XV is 15 *)</span>

<span class="c">(* @@PLEAC@@_2.7 *)</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="n">random_int</span> <span class="n">lo</span> <span class="n">hi</span> <span class="o">=</span>
  <span class="o">(</span><span class="nn">Random</span><span class="p">.</span><span class="n">int</span> <span class="o">(</span><span class="n">hi</span> <span class="o">-</span> <span class="n">lo</span> <span class="o">+</span> <span class="mi">1</span><span class="o">))</span> <span class="o">+</span> <span class="n">lo</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">random_float</span> <span class="n">lo</span> <span class="n">hi</span> <span class="o">=</span>
  <span class="o">(</span><span class="nn">Random</span><span class="p">.</span><span class="n">float</span> <span class="o">(</span><span class="n">hi</span> <span class="o">-.</span> <span class="n">lo</span> <span class="o">+.</span> <span class="mi">1</span><span class="o">.))</span> <span class="o">+.</span> <span class="n">lo</span><span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="n">random_number</span> <span class="o">=</span> <span class="n">random_int</span> <span class="mi">25</span> <span class="mi">75</span> <span class="k">in</span>
  <span class="n">printf</span> <span class="s2">&quot;%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">random_number</span><span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="n">elem</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.(</span><span class="nn">Random</span><span class="p">.</span><span class="n">int</span> <span class="o">(</span><span class="nn">Arry</span><span class="p">.</span><span class="n">length</span> <span class="n">arr</span><span class="o">))</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="n">uc</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">init</span> <span class="mi">26</span> <span class="o">(</span><span class="k">fun</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="nn">Char</span><span class="p">.</span><span class="n">chr</span> <span class="o">(</span><span class="n">i</span><span class="o">+</span> <span class="o">(</span><span class="nn">Char</span><span class="p">.</span><span class="n">code</span> <span class="sc">&#39;A&#39;</span><span class="o">)))</span>
<span class="ow">and</span> <span class="n">lc</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">init</span> <span class="mi">26</span> <span class="o">(</span><span class="k">fun</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="nn">Char</span><span class="p">.</span><span class="n">chr</span> <span class="o">(</span><span class="n">i</span><span class="o">+</span> <span class="o">(</span><span class="nn">Char</span><span class="p">.</span><span class="n">code</span> <span class="sc">&#39;a&#39;</span><span class="o">)))</span>
<span class="ow">and</span> <span class="n">nums</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">init</span> <span class="mi">10</span> <span class="o">(</span><span class="k">fun</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="nn">Char</span><span class="p">.</span><span class="n">chr</span> <span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="o">(</span><span class="nn">Char</span><span class="p">.</span><span class="n">code</span> <span class="sc">&#39;0&#39;</span><span class="o">)))</span>
<span class="ow">and</span> <span class="n">puncs</span> <span class="o">=</span> <span class="o">[|</span> <span class="sc">&#39;!&#39;</span><span class="o">;</span> <span class="sc">&#39;@&#39;</span><span class="o">;</span> <span class="sc">&#39;$&#39;</span><span class="o">;</span> <span class="sc">&#39;%&#39;</span><span class="o">;</span> <span class="sc">&#39;^&#39;</span><span class="o">;</span> <span class="sc">&#39;&amp;&#39;</span><span class="o">;</span> <span class="sc">&#39;*&#39;</span> <span class="o">|];;</span>
<span class="k">let</span> <span class="n">chars</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">concat</span> <span class="o">[</span><span class="n">uc</span><span class="o">;</span> <span class="n">lc</span><span class="o">;</span> <span class="n">nums</span><span class="o">;</span> <span class="n">puncs</span><span class="o">];;</span>

<span class="c">(* to generate the random password as a char array *)</span>
<span class="k">let</span> <span class="n">password</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">init</span> <span class="mi">8</span> <span class="o">(</span><span class="k">fun</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">chars</span><span class="o">.(</span><span class="nn">Random</span><span class="p">.</span><span class="n">int</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">chars</span><span class="o">)));;</span>
<span class="c">(* to generate the random password as a string *)</span>
<span class="k">let</span> <span class="n">passString</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="mi">8</span> <span class="sc">&#39; &#39;</span> <span class="k">in</span>
  <span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span> <span class="k">to</span> <span class="mi">7</span> <span class="k">do</span>
	<span class="n">s</span><span class="o">.[</span><span class="n">i</span><span class="o">]</span> <span class="o">&lt;-</span> <span class="n">chars</span><span class="o">.(</span><span class="nn">Random</span><span class="p">.</span><span class="n">int</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">chars</span><span class="o">))</span>
  <span class="k">done</span><span class="o">;</span>
  <span class="n">s</span><span class="o">;;</span>

<span class="c">(*-----------------------------*)</span>


<span class="c">(* @@PLEAC@@_2.8 *)</span>
<span class="c">(* Seed the generator with an integer *)</span>
<span class="nn">Random</span><span class="p">.</span><span class="n">init</span> <span class="mi">5</span><span class="o">;;</span>

<span class="c">(* Seed the generator with an array of integers *)</span>
<span class="nn">Random</span><span class="p">.</span><span class="n">full_init</span> <span class="o">[|</span> <span class="mi">1</span><span class="o">;</span> <span class="mi">2</span><span class="o">;</span> <span class="mi">178653</span><span class="o">;</span> <span class="o">-</span><span class="mi">62</span> <span class="o">|];;</span>

<span class="c">(* Automatically seed the generator in a system-dependant manner *)</span>
<span class="nn">Random</span><span class="p">.</span><span class="n">self_init</span> <span class="bp">()</span><span class="o">;;</span>

<span class="c">(* @@PLEAC@@_2.9 *)</span>
<span class="c">(* This requires installation of the third party the cryptokit library... *)</span>
<span class="k">let</span> <span class="n">prng</span> <span class="o">=</span> <span class="nn">Cryptokit</span><span class="p">.</span><span class="nn">Random</span><span class="p">.</span><span class="n">secure_rng</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">buf</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="mi">10</span> <span class="sc">&#39; &#39;</span><span class="o">;;</span>
<span class="c">(* random_bytes buf pos len stores len random bytes in string buf, starting at position pos *)</span>
<span class="n">prng</span><span class="o">#</span><span class="n">random_bytes</span> <span class="n">buf</span> <span class="mi">0</span> <span class="mi">10</span><span class="o">;;</span>  <span class="c">(* buf now contains 10 random bytes *)</span>


<span class="c">(* @@PLEAC@@_2.10 *)</span>
<span class="c">(* Note that this will return just one of the numbers, as returning either one</span>
<span class="c">* or the other would requires always constructing an array or a list -- this</span>
<span class="c">* just returns a float *)</span>

<span class="k">let</span> <span class="n">gaussianRand</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">getW</span> <span class="bp">()</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">u1</span> <span class="o">=</span> <span class="mi">2</span><span class="o">.</span> <span class="o">*.</span> <span class="o">(</span><span class="nn">Random</span><span class="p">.</span><span class="n">float</span> <span class="mi">1</span><span class="o">.)</span> <span class="o">-.</span> <span class="mi">1</span><span class="o">.</span>
    <span class="ow">and</span> <span class="n">u2</span> <span class="o">=</span> <span class="mi">2</span><span class="o">.</span> <span class="o">*.</span> <span class="o">(</span><span class="nn">Random</span><span class="p">.</span><span class="n">float</span> <span class="mi">1</span><span class="o">.)</span> <span class="o">-.</span> <span class="mi">1</span><span class="o">.</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">w</span> <span class="o">=</span> <span class="n">u1</span> <span class="o">*.</span> <span class="n">u1</span> <span class="o">+.</span> <span class="n">u2</span> <span class="o">*.</span> <span class="n">u2</span> <span class="k">in</span>
    <span class="k">if</span> <span class="n">w</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">.</span> <span class="k">then</span> <span class="n">w</span><span class="o">,</span><span class="n">u1</span><span class="o">,</span><span class="n">u2</span> <span class="k">else</span> <span class="n">getW</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">w</span><span class="o">,</span><span class="n">u1</span><span class="o">,</span><span class="n">u2</span> <span class="o">=</span> <span class="n">getW</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">w</span> <span class="o">=</span> <span class="n">sqrt</span><span class="o">((-</span><span class="mi">2</span><span class="o">.</span> <span class="o">*.</span> <span class="o">(</span><span class="n">log</span> <span class="n">w</span><span class="o">))</span> <span class="o">/.</span> <span class="n">w</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">g2</span> <span class="o">=</span> <span class="n">u1</span> <span class="o">*.</span> <span class="n">w</span>
  <span class="ow">and</span> <span class="n">g1</span> <span class="o">=</span> <span class="n">u2</span> <span class="o">*.</span> <span class="n">w</span> <span class="k">in</span>
  <span class="n">g1</span><span class="o">;;</span>


<span class="c">(* note that because of the way dist is used, it makes the most sense to return</span>
<span class="c">* it as a sorted associative list rather than another hash table *)</span>
<span class="k">let</span> <span class="n">weightToDist</span> <span class="n">whash</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">total</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">fold</span> <span class="o">(</span><span class="k">fun</span> <span class="n">k</span> <span class="n">v</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">b</span> <span class="o">+.</span> <span class="n">v</span><span class="o">)</span> <span class="n">whash</span> <span class="mi">0</span><span class="o">.</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">dist</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">fold</span> <span class="o">(</span><span class="k">fun</span> <span class="n">k</span> <span class="n">v</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">v</span><span class="o">,</span><span class="n">k</span><span class="o">)::</span><span class="n">b</span><span class="o">)</span> <span class="n">whash</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">sort</span> <span class="n">compare</span> <span class="n">dist</span><span class="o">;;</span>

<span class="k">let</span> <span class="k">rec</span> <span class="n">weightedRand</span> <span class="n">dhash</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">r</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="nn">Random</span><span class="p">.</span><span class="n">float</span> <span class="mi">1</span><span class="o">.)</span> <span class="k">in</span>
  <span class="k">try</span>
    <span class="k">let</span> <span class="n">v</span><span class="o">,</span><span class="n">k</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">find</span> <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">v</span><span class="o">,</span><span class="n">k</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">r</span> <span class="o">:=</span> <span class="o">!</span><span class="n">r</span> <span class="o">-.</span> <span class="n">v</span><span class="o">;</span> <span class="o">!</span><span class="n">r</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">.)</span> <span class="n">dhash</span> <span class="k">in</span> <span class="n">k</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="n">weightedRand</span> <span class="n">dhash</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">mean</span><span class="o">,</span><span class="n">dev</span> <span class="o">=</span> <span class="mi">25</span><span class="o">.,</span><span class="mi">2</span><span class="o">.</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">salary</span> <span class="o">=</span> <span class="n">gaussianRand</span> <span class="bp">()</span> <span class="o">*.</span> <span class="n">sdev</span> <span class="o">+.</span> <span class="n">mean</span><span class="o">;;</span>
<span class="n">printf</span> <span class="s2">&quot;You have been hired at $%.2f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">salary</span><span class="o">;;</span>

<span class="c">(* @@PLEAC@@_2.11 *)</span>
<span class="k">let</span> <span class="n">pi</span> <span class="o">=</span> <span class="n">acos</span><span class="o">(-.</span> <span class="mi">1</span><span class="o">.);;</span>
<span class="k">let</span> <span class="n">degrees_of_radians</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">180</span><span class="o">.</span> <span class="o">*.</span> <span class="n">r</span> <span class="o">/.</span> <span class="n">pi</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">radians_of_degrees</span> <span class="n">d</span> <span class="o">=</span> <span class="n">d</span> <span class="o">*.</span> <span class="n">pi</span> <span class="o">/.</span> <span class="mi">180</span><span class="o">.;;</span>

<span class="k">let</span> <span class="n">sinDeg</span> <span class="n">d</span> <span class="o">=</span> <span class="n">sin</span> <span class="o">(</span><span class="n">radians_of_degrees</span> <span class="n">d</span><span class="o">);;</span>
<span class="k">let</span> <span class="n">cosDeg</span> <span class="n">d</span> <span class="o">=</span> <span class="n">cos</span> <span class="o">(</span><span class="n">radians_of_degrees</span> <span class="n">d</span><span class="o">);;</span>

<span class="c">(* @@PLEAC@@_2.12 *)</span>
<span class="c">(* cos, sin, tan, acos, asin, atan, sinh, cosh and tanh are all standard</span>
<span class="c">functions, but missing functions, such as secant can be construced in the usual</span>
<span class="c">way... *)</span>

<span class="k">let</span> <span class="n">sec</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="o">.</span> <span class="o">/.</span> <span class="o">(</span><span class="n">sin</span> <span class="n">x</span><span class="o">);;</span>

<span class="c">(* @@PLEAC@@_2.13 *)</span>

<span class="c">(* to take a natural log, use the log function *)</span>
<span class="k">let</span> <span class="n">log_e</span> <span class="o">=</span> <span class="n">log</span> <span class="mi">100</span><span class="o">.;;</span>

<span class="c">(* to take a log to base 10, use the log10 function *)</span>
<span class="k">let</span> <span class="n">log_10</span> <span class="o">=</span> <span class="n">log10</span> <span class="mi">100</span><span class="o">.;;</span>

<span class="c">(* to take a log to an arbitrary base, use traditional identities *)</span>
<span class="k">let</span> <span class="n">logB</span> <span class="n">base</span> <span class="n">x</span> <span class="o">=</span> <span class="o">(</span><span class="n">log</span> <span class="n">x</span><span class="o">)</span> <span class="o">/.</span> <span class="o">(</span><span class="n">log</span> <span class="n">base</span><span class="o">);;</span>


<span class="c">(* @@PLEAC@@_2.14 *)</span>
<span class="k">let</span> <span class="n">mmult</span> <span class="n">m1</span> <span class="n">m2</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">dim</span> <span class="n">m</span> <span class="o">=</span>
    <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">m</span><span class="o">,</span><span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">m</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">r1</span><span class="o">,</span><span class="n">c1</span> <span class="o">=</span> <span class="n">dim</span> <span class="n">m1</span>
  <span class="ow">and</span> <span class="n">r2</span><span class="o">,</span><span class="n">c2</span> <span class="o">=</span> <span class="n">dim</span> <span class="n">m2</span> <span class="k">in</span>
  <span class="k">if</span> <span class="n">c1</span> <span class="o">&lt;&gt;</span> <span class="n">r2</span> <span class="k">then</span> <span class="k">raise</span> <span class="o">(</span><span class="nc">Invalid_argument</span> <span class="s2">&quot;Matrix dimensions don&#39;t match&quot;</span><span class="o">)</span>
  <span class="k">else</span>
    <span class="k">begin</span>
      <span class="k">let</span> <span class="n">dotP</span> <span class="n">v1</span> <span class="n">v2</span> <span class="o">=</span>
        <span class="k">let</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span><span class="o">.</span> <span class="k">in</span>
        <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">to</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">v1</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">do</span>
          <span class="n">sum</span> <span class="o">:=</span> <span class="o">!</span><span class="n">sum</span> <span class="o">+.</span> <span class="o">(</span><span class="n">v1</span><span class="o">.(</span><span class="n">i</span><span class="o">)</span> <span class="o">*.</span> <span class="n">v2</span><span class="o">.(</span><span class="n">i</span><span class="o">))</span>
        <span class="k">done</span><span class="o">;</span>
        <span class="o">!</span><span class="n">sum</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">row</span> <span class="n">m</span> <span class="n">i</span> <span class="o">=</span> <span class="n">m</span><span class="o">.(</span><span class="n">i</span><span class="o">)</span>
      <span class="ow">and</span> <span class="n">col</span> <span class="n">m</span> <span class="n">i</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">init</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">m</span><span class="o">)</span> <span class="o">(</span><span class="k">fun</span> <span class="n">r</span> <span class="o">-&gt;</span> <span class="n">m</span><span class="o">.(</span><span class="n">r</span><span class="o">).(</span><span class="n">i</span><span class="o">))</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">res</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">make_matrix</span> <span class="n">r1</span> <span class="n">c2</span> <span class="mi">0</span><span class="o">.</span> <span class="k">in</span>
      <span class="k">for</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">to</span> <span class="n">pred</span> <span class="n">r1</span> <span class="k">do</span>
        <span class="k">for</span> <span class="n">c</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">to</span> <span class="n">pred</span> <span class="n">c2</span> <span class="k">do</span>
          <span class="n">res</span><span class="o">.(</span><span class="n">r</span><span class="o">).(</span><span class="n">c</span><span class="o">)</span> <span class="o">&lt;-</span> <span class="n">dotP</span> <span class="o">(</span><span class="n">row</span> <span class="n">m1</span> <span class="n">r</span><span class="o">)</span> <span class="o">(</span><span class="n">col</span> <span class="n">m2</span> <span class="n">c</span><span class="o">)</span>
        <span class="k">done</span>
      <span class="k">done</span><span class="o">;</span>
      <span class="n">res</span>
    <span class="k">end</span><span class="o">;;</span>

<span class="c">(* @@PLEAC@@_2.15 *)</span>
<span class="c">(*-----------------------------*)</span>
<span class="c">(* c = a * b manually *)</span>
<span class="k">type</span> <span class="n">cplx</span> <span class="o">=</span> <span class="o">{</span> <span class="n">real</span> <span class="o">:</span> <span class="kt">float</span><span class="o">;</span> <span class="n">imag</span> <span class="o">:</span> <span class="kt">float</span><span class="o">;</span> <span class="o">};;</span>
<span class="k">let</span> <span class="n">c</span> <span class="o">=</span> <span class="o">{</span><span class="n">real</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">real</span> <span class="o">*.</span> <span class="n">b</span><span class="o">.</span><span class="n">real</span> <span class="o">-.</span> <span class="n">a</span><span class="o">.</span><span class="n">imag</span> <span class="o">*.</span> <span class="n">b</span><span class="o">.</span><span class="n">imag</span><span class="o">;</span>
         <span class="n">imag</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">imag</span> <span class="o">*.</span> <span class="n">b</span><span class="o">.</span><span class="n">real</span> <span class="o">+.</span> <span class="n">b</span><span class="o">.</span><span class="n">imag</span> <span class="o">*.</span> <span class="n">a</span><span class="o">.</span><span class="n">real</span><span class="o">};;</span>
<span class="c">(*-----------------------------*)</span>

<span class="c">(* c = a * b using the Complex module *)</span>
<span class="k">open</span> <span class="nc">Complex</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">c</span> <span class="o">=</span> <span class="nn">Complex</span><span class="p">.</span><span class="n">mul</span> <span class="n">a</span> <span class="n">b</span><span class="o">;;</span>
<span class="c">(* Note that we could have simply said let c = mul a b, but a later binding of a value to the</span>
<span class="c">   name mul would render the complex mul invisible after that, Complex.mul is</span>
<span class="c">   less ambiguous. *)</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="n">a</span> <span class="o">=</span> <span class="o">{</span><span class="n">real</span><span class="o">=</span><span class="mi">3</span><span class="o">.;</span> <span class="n">imag</span><span class="o">=</span><span class="mi">5</span><span class="o">.};;</span>
<span class="k">let</span> <span class="n">b</span> <span class="o">=</span> <span class="o">{</span><span class="n">real</span><span class="o">=</span><span class="mi">2</span><span class="o">.;</span> <span class="n">imag</span><span class="o">=(-.</span> <span class="mi">2</span><span class="o">.);}</span>
<span class="k">let</span> <span class="n">c</span> <span class="o">=</span> <span class="o">{</span><span class="n">real</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">real</span> <span class="o">*.</span> <span class="n">b</span><span class="o">.</span><span class="n">real</span> <span class="o">-.</span> <span class="n">a</span><span class="o">.</span><span class="n">imag</span> <span class="o">*.</span> <span class="n">b</span><span class="o">.</span><span class="n">imag</span><span class="o">;</span>
         <span class="n">imag</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">imag</span> <span class="o">*.</span> <span class="n">b</span><span class="o">.</span><span class="n">real</span> <span class="o">+.</span> <span class="n">b</span><span class="o">.</span><span class="n">imag</span> <span class="o">*.</span> <span class="n">a</span><span class="o">.</span><span class="n">real</span><span class="o">};;</span>
<span class="n">printf</span> <span class="s2">&quot;c = %f+%fi</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">c</span><span class="o">.</span><span class="n">real</span> <span class="n">c</span><span class="o">.</span><span class="n">imag</span><span class="o">;;</span>

<span class="c">(* c = 16.000000+4.000000i *)</span>

<span class="k">let</span> <span class="n">a</span> <span class="o">=</span> <span class="o">{</span><span class="n">re</span><span class="o">=</span><span class="mi">3</span><span class="o">.;</span> <span class="n">im</span><span class="o">=</span><span class="mi">5</span><span class="o">.};;</span>
<span class="k">let</span> <span class="n">b</span> <span class="o">=</span> <span class="o">{</span><span class="n">re</span><span class="o">=</span><span class="mi">2</span><span class="o">.;</span> <span class="n">im</span><span class="o">=(-.</span> <span class="mi">2</span><span class="o">.);}</span>
<span class="k">let</span> <span class="n">c</span> <span class="o">=</span> <span class="n">mul</span> <span class="n">a</span> <span class="n">b</span><span class="o">;;</span>
<span class="n">printf</span> <span class="s2">&quot;c = %f+%fi</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">c</span><span class="o">.</span><span class="n">re</span> <span class="n">c</span><span class="o">.</span><span class="n">im</span><span class="o">;;</span>

<span class="c">(* c = 16.000000+4.000000i *)</span>

<span class="k">let</span> <span class="n">d</span> <span class="o">=</span> <span class="o">{</span><span class="n">re</span><span class="o">=</span><span class="mi">3</span><span class="o">.;</span> <span class="n">im</span><span class="o">=</span><span class="mi">4</span><span class="o">.};;</span>
<span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">sqrt</span> <span class="n">d</span> <span class="k">in</span>
<span class="n">printf</span> <span class="s2">&quot;sqrt(%.2f+%.2fi) = %.2f+%.2fi</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">d</span><span class="o">.</span><span class="n">re</span> <span class="n">d</span><span class="o">.</span><span class="n">im</span> <span class="n">s</span><span class="o">.</span><span class="n">re</span> <span class="n">s</span><span class="o">.</span><span class="n">im</span><span class="o">;;</span>

<span class="c">(* sqrt(3.00+4.00i) = 2.00+1.00i *)</span>

<span class="c">(* @@PLEAC@@_2.16 *)</span>
<span class="c">(* Since integers and strings are very different things in OCaml, we will</span>
<span class="c">   represent both octal and hexidecimal values as strings *)</span>

<span class="k">let</span> <span class="n">oct_of_hex</span> <span class="n">h</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;%0o&quot;</span> <span class="o">(</span><span class="n">int_of_string</span> <span class="o">(</span><span class="s2">&quot;0x&quot;</span> <span class="o">^</span> <span class="n">h</span><span class="o">));;</span>
<span class="k">let</span> <span class="n">hex_of_oct</span> <span class="n">o</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;%0x&quot;</span> <span class="o">(</span><span class="n">int_of_string</span> <span class="o">(</span><span class="s2">&quot;0o&quot;</span> <span class="o">^</span> <span class="n">o</span><span class="o">));;</span>

<span class="c">(* One small problem is that OCaml integers are 31 (or 63) bit values, if you need</span>
<span class="c">   something larger, you can use the following for a full 32 bits: *)</span>
<span class="k">let</span> <span class="n">oct_of_hex32</span> <span class="n">h</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;%0lo&quot;</span> <span class="o">(</span><span class="nn">Int32</span><span class="p">.</span><span class="n">of_string</span> <span class="o">(</span><span class="s2">&quot;0x&quot;</span> <span class="o">^</span> <span class="n">h</span><span class="o">));;</span>
<span class="k">let</span> <span class="n">hex_of_oct32</span> <span class="n">o</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;%0lx&quot;</span> <span class="o">(</span><span class="nn">Int32</span><span class="p">.</span><span class="n">of_string</span> <span class="o">(</span><span class="s2">&quot;0o&quot;</span> <span class="o">^</span> <span class="n">o</span><span class="o">));;</span>

<span class="c">(* Or this for 64 bits: *)</span>
<span class="k">let</span> <span class="n">oct_of_hex64</span> <span class="n">h</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;%0Lo&quot;</span> <span class="o">(</span><span class="nn">Int64</span><span class="p">.</span><span class="n">of_string</span> <span class="o">(</span><span class="s2">&quot;0x&quot;</span> <span class="o">^</span> <span class="n">h</span><span class="o">));;</span>
<span class="k">let</span> <span class="n">hex_of_oct64</span> <span class="n">o</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;%0Lx&quot;</span> <span class="o">(</span><span class="nn">Int64</span><span class="p">.</span><span class="n">of_string</span> <span class="o">(</span><span class="s2">&quot;0o&quot;</span> <span class="o">^</span> <span class="n">o</span><span class="o">));;</span>

<span class="c">(* For anything else you have to roll your own *)</span>
<span class="k">let</span> <span class="n">chopn</span> <span class="n">n</span> <span class="n">s</span> <span class="o">=</span>
  <span class="c">(* Chops strings into list of n byte substrings *)</span>
  <span class="k">match</span> <span class="n">s</span> <span class="k">with</span>
    <span class="s2">&quot;&quot;</span> <span class="o">-&gt;</span> <span class="o">[</span><span class="s2">&quot;&quot;</span><span class="o">]</span> <span class="c">(* avoids wierd edge case *)</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span>
      <span class="k">let</span> <span class="n">ex</span> <span class="o">=</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span><span class="o">)</span> <span class="ow">mod</span> <span class="n">n</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">ss</span> <span class="o">=</span> <span class="k">if</span> <span class="n">ex</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">then</span> <span class="n">s</span> <span class="k">else</span> <span class="o">((</span><span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="o">(</span><span class="n">n</span><span class="o">-</span><span class="n">ex</span><span class="o">)</span> <span class="sc">&#39;0&#39;</span><span class="o">)</span> <span class="o">^</span> <span class="n">s</span><span class="o">)</span> <span class="k">in</span>
      <span class="k">let</span> <span class="k">rec</span> <span class="n">schopn</span> <span class="n">x</span> <span class="n">s</span> <span class="n">l</span> <span class="o">=</span>
        <span class="k">match</span> <span class="n">x</span> <span class="k">with</span>
          <span class="mi">0</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">s</span> <span class="mi">0</span> <span class="n">n</span><span class="o">)::</span><span class="n">l</span>
          <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">schopn</span> <span class="o">(</span><span class="n">x</span><span class="o">-</span><span class="n">n</span><span class="o">)</span> <span class="n">s</span> <span class="o">((</span><span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">s</span> <span class="n">x</span> <span class="n">n</span><span class="o">)::</span><span class="n">l</span><span class="o">)</span> <span class="k">in</span>
      <span class="n">schopn</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">ss</span> <span class="o">-</span> <span class="n">n</span><span class="o">)</span> <span class="n">ss</span> <span class="bp">[]</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">long_oct_of_hex</span> <span class="n">h</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">choppedH</span> <span class="o">=</span> <span class="n">chopn</span> <span class="mi">6</span> <span class="n">h</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">f</span> <span class="n">x</span> <span class="o">=</span> <span class="n">int_of_string</span> <span class="o">(</span><span class="s2">&quot;0x&quot;</span> <span class="o">^</span> <span class="n">x</span><span class="o">)</span> <span class="k">in</span>
  <span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;%08o&quot;</span> <span class="o">(</span><span class="n">f</span> <span class="n">x</span><span class="o">))</span> <span class="n">choppedH</span><span class="o">);;</span>

<span class="k">let</span> <span class="n">long_hex_of_oct</span> <span class="n">o</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">choppedO</span> <span class="o">=</span> <span class="n">chopn</span> <span class="mi">8</span> <span class="n">o</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">f</span> <span class="n">x</span> <span class="o">=</span> <span class="n">int_of_string</span> <span class="o">(</span><span class="s2">&quot;0o&quot;</span> <span class="o">^</span> <span class="n">x</span><span class="o">)</span> <span class="k">in</span>
  <span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;%06x&quot;</span> <span class="o">(</span><span class="n">f</span> <span class="n">x</span><span class="o">))</span> <span class="n">choppedO</span><span class="o">);;</span>
<span class="c">(*-----------------------------*)</span>
<span class="c">(* Since octal, hex and decimal are all the same internally, we don&#39;t need to do</span>
<span class="c">    any explicit conversion *)</span>
<span class="n">printf</span> <span class="s2">&quot;Gimme a number in decimal, octal, or hex: &quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">num</span> <span class="o">=</span> <span class="n">read_int</span> <span class="bp">()</span><span class="o">;;</span>
<span class="n">printf</span> <span class="s2">&quot;%d %x %o</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">num</span> <span class="n">num</span> <span class="n">num</span><span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="n">printf</span> <span class="s2">&quot;Enter file permission in octal: &quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">permissions</span> <span class="o">=</span> <span class="k">try</span> <span class="n">read_int</span> <span class="bp">()</span>
<span class="k">with</span> <span class="nc">Failure</span> <span class="n">message</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">&quot;Exiting...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;;</span>
<span class="n">printf</span> <span class="s2">&quot;The decimal value is %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">permissions</span><span class="o">;;</span>

<span class="c">(* @@PLEAC@@_2.17 *)</span>
<span class="c">(* This example requires the PCRE library, available at:</span>
<span class="c">   http://www.ocaml.info/home/ocaml_sources.html#pcre-ocaml *)</span>
<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+pcre&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;pcre.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">rev_string</span> <span class="n">s</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">s&#39;</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">copy</span> <span class="n">s</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">i</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="k">in</span>
  <span class="nn">String</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">c</span> <span class="o">-&gt;</span> <span class="n">s&#39;</span><span class="o">.[!</span><span class="n">i</span><span class="o">]</span> <span class="o">&lt;-</span> <span class="n">c</span><span class="o">;</span> <span class="n">decr</span> <span class="n">i</span><span class="o">)</span> <span class="n">s</span><span class="o">;</span>
  <span class="n">s&#39;</span>

<span class="k">let</span> <span class="n">commify</span> <span class="n">s</span> <span class="o">=</span>
  <span class="n">rev_string</span>
    <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">replace</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;(</span><span class="se">\\</span><span class="s2">d</span><span class="se">\\</span><span class="s2">d</span><span class="se">\\</span><span class="s2">d)(?=</span><span class="se">\\</span><span class="s2">d)(?!</span><span class="se">\\</span><span class="s2">d*</span><span class="se">\\</span><span class="s2">.)&quot;</span> <span class="o">~</span><span class="n">templ</span><span class="o">:</span><span class="s2">&quot;$1,&quot;</span>
       <span class="o">(</span><span class="n">rev_string</span> <span class="n">s</span><span class="o">))</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* more reasonable web counter :-) *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Random</span><span class="p">.</span><span class="n">self_init</span> <span class="bp">()</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">hits</span> <span class="o">=</span> <span class="nn">Random</span><span class="p">.</span><span class="n">int32</span> <span class="mi">2147483647</span><span class="n">l</span> <span class="k">in</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Your web page received %s accesses last month.</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="o">(</span><span class="n">commify</span> <span class="o">(</span><span class="nn">Int32</span><span class="p">.</span><span class="n">to_string</span> <span class="n">hits</span><span class="o">))</span>
<span class="c">(* Your web page received 1,670,658,439 accesses last month. *)</span>

<span class="c">(* @@PLEAC@@_2.18 *)</span>
<span class="c">(* Hardcoded examples can be done as follows: *)</span>
<span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;It took %d hour%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">n</span> <span class="o">(</span><span class="k">if</span> <span class="n">n</span> <span class="o">&lt;&gt;</span> <span class="mi">1</span> <span class="k">then</span> <span class="s2">&quot;s&quot;</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="o">);;</span>
<span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;It took %d centur%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">n</span> <span class="o">(</span><span class="k">if</span> <span class="n">n</span> <span class="o">&lt;&gt;</span> <span class="mi">1</span> <span class="k">then</span> <span class="s2">&quot;ies&quot;</span> <span class="k">else</span> <span class="s2">&quot;y&quot;</span><span class="o">);;</span>

<span class="c">(* For a more general solution *)</span>
<span class="c">(* First define the rules *)</span>
<span class="c">(* Note: the OS needs to support dynamic loading of C libraries for this *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">rules</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="o">(</span><span class="n">fst</span> <span class="n">x</span><span class="o">)),(</span><span class="n">snd</span> <span class="n">x</span><span class="o">))</span>
    <span class="o">[</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">([psc]h</span><span class="se">\\</span><span class="s2">)$</span><span class="se">\\</span><span class="s2">|z$&quot;</span><span class="o">,</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">0es&quot;</span><span class="o">;</span>
     <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">(ff</span><span class="se">\\</span><span class="s2">)$</span><span class="se">\\</span><span class="s2">|</span><span class="se">\\</span><span class="s2">(ey</span><span class="se">\\</span><span class="s2">)$&quot;</span><span class="o">,</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">0s&quot;</span><span class="o">;</span>
     <span class="s2">&quot;f$&quot;</span><span class="o">,</span><span class="s2">&quot;ves&quot;</span><span class="o">;</span>
     <span class="s2">&quot;y$&quot;</span><span class="o">,</span><span class="s2">&quot;ies&quot;</span><span class="o">;</span>
     <span class="s2">&quot;ix$&quot;</span><span class="o">,</span><span class="s2">&quot;ices&quot;</span><span class="o">;</span>
     <span class="s2">&quot;ius$&quot;</span><span class="o">,</span><span class="s2">&quot;ii&quot;</span><span class="o">;</span>
     <span class="s2">&quot;[sx]$&quot;</span><span class="o">,</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">0es&quot;</span><span class="o">;</span>
     <span class="s2">&quot;non&quot;</span><span class="o">,</span><span class="s2">&quot;na&quot;</span><span class="o">];;</span>

<span class="k">let</span> <span class="n">f</span> <span class="n">w</span> <span class="n">x</span> <span class="o">=</span>
  <span class="n">ignore</span><span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span> <span class="o">(</span><span class="n">fst</span> <span class="n">x</span><span class="o">)</span> <span class="n">w</span> <span class="mi">0</span><span class="o">);</span>
  <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span> <span class="o">(</span><span class="n">fst</span> <span class="n">x</span><span class="o">)</span> <span class="o">(</span><span class="n">snd</span> <span class="n">x</span><span class="o">)</span> <span class="n">w</span><span class="o">;;</span>

<span class="k">let</span> <span class="k">rec</span> <span class="n">exn_map</span> <span class="n">ex</span> <span class="n">fn1</span> <span class="n">fn2</span> <span class="n">l</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">l</span> <span class="k">with</span>
    <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="n">fn2</span>
  <span class="o">|</span> <span class="n">h</span><span class="o">::</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="k">try</span> <span class="o">(</span><span class="n">fn1</span> <span class="n">h</span><span class="o">)</span> <span class="k">with</span> <span class="n">ex</span> <span class="o">-&gt;</span> <span class="n">exn_map</span> <span class="n">ex</span> <span class="n">fn1</span> <span class="n">fn2</span> <span class="n">t</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">pluralize</span> <span class="n">x</span> <span class="o">=</span> <span class="c">(* &quot;wish&quot; in *)</span>
  <span class="n">exn_map</span> <span class="nc">Not_found</span> <span class="o">(</span><span class="n">f</span> <span class="n">x</span><span class="o">)</span> <span class="o">(</span><span class="n">x</span> <span class="o">^</span> <span class="s2">&quot;s&quot;</span><span class="o">)</span> <span class="n">rules</span><span class="o">;;</span>

<span class="c">(* Note: This next example doesn&#39;t work on the odd cases *)</span>
<span class="k">let</span> <span class="n">nouns</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;fish&quot;</span><span class="o">;</span> <span class="s2">&quot;fly&quot;</span><span class="o">;</span> <span class="s2">&quot;ox&quot;</span><span class="o">;</span> <span class="s2">&quot;species&quot;</span><span class="o">;</span> <span class="s2">&quot;genus&quot;</span><span class="o">;</span> <span class="s2">&quot;phylum&quot;</span><span class="o">;</span> <span class="s2">&quot;cherub&quot;</span><span class="o">;</span>
             <span class="s2">&quot;radius&quot;</span><span class="o">;</span> <span class="s2">&quot;jockey&quot;</span><span class="o">;</span> <span class="s2">&quot;index&quot;</span><span class="o">;</span> <span class="s2">&quot;matrix&quot;</span><span class="o">;</span> <span class="s2">&quot;mythos&quot;</span><span class="o">;</span> <span class="s2">&quot;phenomenon&quot;</span><span class="o">;</span>
             <span class="s2">&quot;formula&quot;</span><span class="o">];;</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">printf</span> <span class="s2">&quot;One %s, two %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">x</span> <span class="o">(</span><span class="n">pluralize</span> <span class="n">x</span><span class="o">))</span> <span class="n">nouns</span><span class="o">;;</span>


<span class="c">(* @@PLEAC@@_2.19 *)</span>
<span class="c">(* Note: the OS needs to support dynamic loading of C libraries for this</span>
<span class="c">   otherwise you will need to link the nums library with the code at comple time *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;nums.cma&quot;</span><span class="o">;;</span>
<span class="k">open</span> <span class="nc">Big_int</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">cmd</span> <span class="o">=</span> <span class="o">[|</span><span class="s2">&quot;bigfact&quot;</span><span class="o">;</span> <span class="s2">&quot;8&quot;</span><span class="o">;</span> <span class="s2">&quot;9&quot;</span><span class="o">;</span> <span class="s2">&quot;96&quot;</span><span class="o">;</span> <span class="s2">&quot;2178&quot;</span><span class="o">;</span>
            <span class="s2">&quot;239322000000000000000000&quot;</span><span class="o">;</span> <span class="s2">&quot;25000000000000000000000000&quot;</span><span class="o">;</span> <span class="s2">&quot;17&quot;</span><span class="o">|];;</span>

<span class="c">(* This will raise an exception if a nonnumeric string is in the argument list</span>
<span class="c">*)</span>
<span class="k">let</span> <span class="n">argList</span> <span class="o">=</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">map</span> <span class="n">big_int_of_string</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">sub</span> <span class="n">cmd</span> <span class="mi">1</span> <span class="o">((</span><span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">cmd</span><span class="o">)</span> <span class="o">-</span> <span class="mi">1</span><span class="o">));;</span>

<span class="k">let</span> <span class="n">factorize</span> <span class="n">num</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">two</span> <span class="o">=</span> <span class="n">big_int_of_int</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">four</span> <span class="o">=</span> <span class="n">big_int_of_int</span> <span class="mi">4</span> <span class="k">in</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">genFactors</span> <span class="o">(</span><span class="n">i</span><span class="o">,</span><span class="n">sqi</span><span class="o">)</span> <span class="n">n</span> <span class="n">fList</span> <span class="o">=</span>
    <span class="k">if</span> <span class="n">eq_big_int</span> <span class="n">n</span> <span class="n">unit_big_int</span> <span class="k">then</span> <span class="n">fList</span> <span class="k">else</span>
    <span class="k">if</span> <span class="n">lt_big_int</span> <span class="n">n</span> <span class="n">sqi</span> <span class="k">then</span> <span class="o">((</span><span class="n">n</span><span class="o">,</span><span class="mi">1</span><span class="o">)::</span><span class="n">fList</span><span class="o">)</span> <span class="k">else</span>
      <span class="k">let</span> <span class="n">newn</span> <span class="o">=</span> <span class="n">ref</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">fcount</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
      <span class="k">while</span>  <span class="o">(</span><span class="n">eq_big_int</span> <span class="o">(</span><span class="n">mod_big_int</span> <span class="o">!</span><span class="n">newn</span> <span class="n">i</span><span class="o">)</span> <span class="n">zero_big_int</span><span class="o">)</span> <span class="k">do</span>
          <span class="n">newn</span> <span class="o">:=</span> <span class="n">div_big_int</span> <span class="o">!</span><span class="n">newn</span> <span class="n">i</span><span class="o">;</span>
          <span class="n">fcount</span> <span class="o">:=</span> <span class="o">!</span><span class="n">fcount</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span>
      <span class="k">done</span><span class="o">;</span>
      <span class="k">let</span> <span class="n">nexti</span><span class="o">,</span><span class="n">nextsqi</span> <span class="o">=</span>
          <span class="k">if</span> <span class="n">eq_big_int</span> <span class="n">i</span> <span class="n">two</span> <span class="k">then</span>
              <span class="o">(</span><span class="n">add_big_int</span> <span class="n">i</span> <span class="n">unit_big_int</span><span class="o">),</span>
                <span class="o">(</span><span class="n">add_big_int</span> <span class="n">sqi</span> <span class="o">(</span><span class="n">add_big_int</span> <span class="o">(</span><span class="n">mult_big_int</span> <span class="n">i</span> <span class="n">two</span><span class="o">)</span>
                 <span class="n">unit_big_int</span><span class="o">))</span>
          <span class="k">else</span>
              <span class="o">(</span><span class="n">add_big_int</span> <span class="n">i</span> <span class="n">two</span><span class="o">),</span>
                <span class="o">(</span><span class="n">add_big_int</span> <span class="n">sqi</span> <span class="o">(</span><span class="n">add_big_int</span> <span class="o">(</span><span class="n">mult_big_int</span> <span class="n">i</span> <span class="n">four</span><span class="o">)</span> <span class="n">two</span><span class="o">))</span> <span class="k">in</span>
      <span class="n">genFactors</span> <span class="o">(</span><span class="n">nexti</span><span class="o">,</span><span class="n">nextsqi</span><span class="o">)</span> <span class="o">!</span><span class="n">newn</span> <span class="o">(</span><span class="k">if</span> <span class="o">!</span><span class="n">fcount</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">then</span> <span class="n">fList</span> <span class="k">else</span>
          <span class="o">((</span><span class="n">i</span><span class="o">,!</span><span class="n">fcount</span><span class="o">)::</span><span class="n">fList</span><span class="o">))</span> <span class="k">in</span>
   <span class="n">genFactors</span> <span class="o">(</span><span class="n">two</span><span class="o">,</span><span class="n">four</span><span class="o">)</span> <span class="n">num</span> <span class="bp">[]</span><span class="o">;;</span>

<span class="k">let</span> <span class="o">_</span> <span class="o">=</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">iter</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">n</span> <span class="o">-&gt;</span>
    <span class="k">let</span> <span class="n">l</span> <span class="o">=</span> <span class="n">factorize</span> <span class="n">n</span> <span class="k">in</span>
    <span class="k">match</span> <span class="n">l</span> <span class="k">with</span>
      <span class="o">[(</span><span class="n">x</span><span class="o">,</span><span class="mi">1</span><span class="o">)]</span> <span class="o">-&gt;</span> <span class="n">printf</span> <span class="s2">&quot;%s</span><span class="se">\t</span><span class="s2">Prime!</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">string_of_big_int</span> <span class="n">x</span><span class="o">)</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span>
        <span class="n">printf</span> <span class="s2">&quot;%s</span><span class="se">\t</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">string_of_big_int</span> <span class="n">n</span><span class="o">);</span>
        <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
          <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span><span class="n">count</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="k">let</span> <span class="n">sx</span> <span class="o">=</span> <span class="n">string_of_big_int</span> <span class="n">x</span> <span class="k">in</span>
            <span class="k">if</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">then</span> <span class="n">printf</span> <span class="s2">&quot;%s &quot;</span> <span class="n">sx</span>
            <span class="k">else</span> <span class="n">printf</span> <span class="s2">&quot;%s**%d &quot;</span> <span class="n">sx</span> <span class="n">count</span><span class="o">)</span>
          <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="n">l</span><span class="o">);</span>
    <span class="n">print_newline</span><span class="bp">()</span><span class="o">)</span> <span class="n">argList</span><span class="o">;;</span>


<span class="c">(* @@PLEAC@@_3.0 *)</span>
<span class="c">(*-----------------------------*)</span>

<span class="c">(* The unix module acts as a thin wrapper around the standard C</span>
<span class="c">** Posix API. It comes standard with the Ocaml compiler but is</span>
<span class="c">** not automatcially linked.</span>
<span class="c">** If you are not using the command line interpreter, delete the</span>
<span class="c">** the &quot;#load&quot; line</span>
<span class="c">*)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span> <span class="o">;;</span>
<span class="k">open</span> <span class="nc">Unix</span> <span class="o">;;</span>
<span class="k">let</span> <span class="n">t</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">localtime</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">time</span> <span class="bp">()</span><span class="o">);;</span>

<span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Today is day %d of the current year.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">t</span><span class="o">.</span><span class="n">tm_yday</span> <span class="o">;;</span>

<span class="c">(* @@PLEAC@@_3.1 *)</span>
<span class="c">(*-----------------------------*)</span>
<span class="c">(* Finding todays date *)</span>

<span class="k">let</span> <span class="o">(</span><span class="n">day</span><span class="o">,</span> <span class="n">month</span><span class="o">,</span> <span class="n">year</span><span class="o">)</span> <span class="o">=</span> <span class="o">(</span><span class="n">t</span><span class="o">.</span><span class="n">tm_mday</span><span class="o">,</span> <span class="n">t</span><span class="o">.</span><span class="n">tm_mon</span><span class="o">,</span> <span class="n">t</span><span class="o">.</span><span class="n">tm_year</span><span class="o">)</span> <span class="o">;;</span>
<span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;The current date is %04d-%02d-%02d</span><span class="se">\n</span><span class="s2">&quot;</span>
  <span class="o">(</span><span class="mi">1900</span> <span class="o">+</span> <span class="n">year</span><span class="o">)</span> <span class="o">(</span><span class="n">month</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">day</span> <span class="o">;;</span>

<span class="c">(* @@PLEAC@@_3.2 *)</span>
<span class="c">(*-----------------------------*)</span>
<span class="c">(*</span>
<span class="c">** Converting DMYHMS to Epoch Seconds</span>
<span class="c">** Again, use the Unix module.</span>
<span class="c">*)</span>

<span class="c">(* For the local timezone *)</span>
<span class="k">let</span> <span class="n">ttup</span> <span class="o">=</span> <span class="n">mktime</span> <span class="o">(</span><span class="n">localtime</span> <span class="o">(</span><span class="n">time</span> <span class="bp">()</span><span class="o">))</span> <span class="o">;;</span>
<span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Epoch Seconds (local): %.0f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">fst</span> <span class="n">ttup</span><span class="o">)</span> <span class="o">;;</span>

<span class="c">(* For UTC *)</span>
<span class="k">let</span> <span class="n">ttup</span> <span class="o">=</span> <span class="n">mktime</span> <span class="o">(</span><span class="n">gmtime</span> <span class="o">(</span><span class="n">time</span> <span class="bp">()</span><span class="o">))</span> <span class="o">;;</span>
<span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Epoch Seconds (UTC): %.0f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">fst</span> <span class="n">ttup</span><span class="o">)</span> <span class="o">;;</span>

<span class="c">(* @@PLEAC@@_3.3 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">time</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">time</span> <span class="bp">()</span>

<span class="k">let</span> <span class="o">{</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_sec</span><span class="o">=</span><span class="n">seconds</span><span class="o">;</span> <span class="n">tm_min</span><span class="o">=</span><span class="n">minutes</span><span class="o">;</span> <span class="n">tm_hour</span><span class="o">=</span><span class="n">hours</span><span class="o">;</span>
     <span class="n">tm_mday</span><span class="o">=</span><span class="n">day_of_month</span><span class="o">;</span> <span class="n">tm_mon</span><span class="o">=</span><span class="n">month</span><span class="o">;</span> <span class="n">tm_year</span><span class="o">=</span><span class="n">year</span><span class="o">;</span>
     <span class="n">tm_wday</span><span class="o">=</span><span class="n">wday</span><span class="o">;</span> <span class="n">tm_yday</span><span class="o">=</span><span class="n">yday</span><span class="o">;</span> <span class="n">tm_isdst</span><span class="o">=</span><span class="n">isdst</span><span class="o">}</span> <span class="o">=</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">localtime</span> <span class="n">time</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Dateline: %02d:%02d:%02d-%04d/%02d/%02d</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">hours</span> <span class="n">minutes</span> <span class="n">seconds</span> <span class="o">(</span><span class="n">year</span> <span class="o">+</span> <span class="mi">1900</span><span class="o">)</span> <span class="o">(</span><span class="n">month</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">day_of_month</span>

<span class="c">(* @@PLEAC@@_3.4 *)</span>
<span class="k">let</span> <span class="n">birthtime</span> <span class="o">=</span> <span class="mi">96176750</span><span class="o">.</span>                     <span class="c">(* 18/Jan/1973, 3:45:50 am *)</span>
<span class="k">let</span> <span class="n">interval</span> <span class="o">=</span> <span class="mi">5</span><span class="o">.</span> <span class="o">+.</span>                          <span class="c">(* 5 seconds *)</span>
               <span class="mi">17</span><span class="o">.</span> <span class="o">*.</span> <span class="mi">60</span><span class="o">.</span> <span class="o">+.</span>                  <span class="c">(* 17 minutes *)</span>
               <span class="mi">2</span><span class="o">.</span>  <span class="o">*.</span> <span class="mi">60</span><span class="o">.</span> <span class="o">*.</span> <span class="mi">60</span><span class="o">.</span> <span class="o">+.</span>           <span class="c">(* 2 hours *)</span>
               <span class="mi">55</span><span class="o">.</span> <span class="o">*.</span> <span class="mi">60</span><span class="o">.</span> <span class="o">*.</span> <span class="mi">60</span><span class="o">.</span> <span class="o">*.</span> <span class="mi">24</span><span class="o">.</span>       <span class="c">(* and 55 days *)</span>
<span class="k">let</span> <span class="k">then&#39;</span> <span class="o">=</span> <span class="n">birthtime</span> <span class="o">+.</span> <span class="n">interval</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* format_time is defined in section 3.8. *)</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Then is %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">format_time</span> <span class="k">then&#39;</span><span class="o">);</span>
  <span class="c">(* Then is Tue Mar 13 23:02:55 1973 *)</span>

<span class="c">(* @@PLEAC@@_3.5 *)</span>
<span class="k">let</span> <span class="n">bree</span> <span class="o">=</span> <span class="mi">361535725</span><span class="o">.</span>                   <span class="c">(* 16 Jun 1981, 4:35:25 *)</span>
<span class="k">let</span> <span class="n">nat</span>  <span class="o">=</span>  <span class="mi">96201950</span><span class="o">.</span>                   <span class="c">(* 18 Jan 1973, 3:45:50 *)</span>

<span class="k">let</span> <span class="n">difference</span> <span class="o">=</span> <span class="n">bree</span> <span class="o">-.</span> <span class="n">nat</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;There were %.f seconds between Nat and Bree</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">difference</span>
  <span class="c">(* There were 265333775 seconds between Nat and Bree *)</span>

<span class="k">let</span> <span class="n">seconds</span>    <span class="o">=</span>  <span class="n">mod_float</span> <span class="n">difference</span> <span class="mi">60</span><span class="o">.</span>
<span class="k">let</span> <span class="n">difference</span> <span class="o">=</span> <span class="o">(</span><span class="n">difference</span> <span class="o">-.</span> <span class="n">seconds</span><span class="o">)</span> <span class="o">/.</span> <span class="mi">60</span><span class="o">.</span>
<span class="k">let</span> <span class="n">minutes</span>    <span class="o">=</span>  <span class="n">mod_float</span> <span class="n">difference</span> <span class="mi">60</span><span class="o">.</span>
<span class="k">let</span> <span class="n">difference</span> <span class="o">=</span> <span class="o">(</span><span class="n">difference</span> <span class="o">-.</span> <span class="n">minutes</span><span class="o">)</span> <span class="o">/.</span> <span class="mi">60</span><span class="o">.</span>
<span class="k">let</span> <span class="n">hours</span>      <span class="o">=</span>  <span class="n">mod_float</span> <span class="n">difference</span> <span class="mi">24</span><span class="o">.</span>
<span class="k">let</span> <span class="n">difference</span> <span class="o">=</span> <span class="o">(</span><span class="n">difference</span> <span class="o">-.</span> <span class="n">hours</span><span class="o">)</span>   <span class="o">/.</span> <span class="mi">24</span><span class="o">.</span>
<span class="k">let</span> <span class="n">days</span>       <span class="o">=</span>  <span class="n">mod_float</span> <span class="n">difference</span> <span class="mi">7</span><span class="o">.</span>
<span class="k">let</span> <span class="n">weeks</span>      <span class="o">=</span> <span class="o">(</span><span class="n">difference</span> <span class="o">-.</span> <span class="n">days</span><span class="o">)</span>    <span class="o">/.</span>  <span class="mi">7</span><span class="o">.</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;(%.f weeks, %.f days, %.f:%.f:%.f)</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">weeks</span> <span class="n">days</span> <span class="n">hours</span> <span class="n">minutes</span> <span class="n">seconds</span>
  <span class="c">(* (438 weeks, 4 days, 23:49:35) *)</span>

<span class="c">(* @@PLEAC@@_3.6 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="o">{</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_mday</span><span class="o">=</span><span class="n">monthday</span><span class="o">;</span> <span class="n">tm_wday</span><span class="o">=</span><span class="n">weekday</span><span class="o">;</span> <span class="n">tm_yday</span><span class="o">=</span><span class="n">yearday</span><span class="o">}</span> <span class="o">=</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">localtime</span> <span class="n">date</span>
<span class="k">let</span> <span class="n">weeknum</span> <span class="o">=</span> <span class="n">yearday</span> <span class="o">/</span> <span class="mi">7</span> <span class="o">+</span> <span class="mi">1</span>

<span class="c">(* @@PLEAC@@_3.7 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">epoch_seconds</span> <span class="n">date</span> <span class="o">=</span>
  <span class="nn">Scanf</span><span class="p">.</span><span class="n">sscanf</span> <span class="n">date</span> <span class="s2">&quot;%04d-%02d-%02d&quot;</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">yyyy</span> <span class="n">mm</span> <span class="n">dd</span> <span class="o">-&gt;</span>
       <span class="n">fst</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">mktime</span> <span class="o">{</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_sec</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">tm_min</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">tm_hour</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span>
                         <span class="n">tm_mday</span><span class="o">=</span><span class="n">dd</span><span class="o">;</span> <span class="n">tm_mon</span><span class="o">=</span><span class="n">mm</span><span class="o">-</span><span class="mi">1</span><span class="o">;</span> <span class="n">tm_year</span><span class="o">=</span><span class="n">yyyy</span><span class="o">-</span><span class="mi">1900</span><span class="o">;</span>
                         <span class="n">tm_wday</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">tm_yday</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">tm_isdst</span><span class="o">=</span><span class="bp">false</span><span class="o">}))</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">read_line</span> <span class="bp">()</span> <span class="k">in</span>
    <span class="k">try</span>
      <span class="k">let</span> <span class="n">date</span> <span class="o">=</span> <span class="n">epoch_seconds</span> <span class="n">line</span> <span class="k">in</span>
      <span class="k">let</span> <span class="o">{</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_mday</span><span class="o">=</span><span class="n">day</span><span class="o">;</span> <span class="n">tm_mon</span><span class="o">=</span><span class="n">month</span><span class="o">;</span> <span class="n">tm_year</span><span class="o">=</span><span class="n">year</span><span class="o">}</span> <span class="o">=</span>
        <span class="nn">Unix</span><span class="p">.</span><span class="n">localtime</span> <span class="n">date</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">month</span> <span class="o">=</span> <span class="n">month</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">year</span> <span class="o">=</span> <span class="n">year</span> <span class="o">+</span> <span class="mi">1900</span> <span class="k">in</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Date was %d/%d/%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">month</span> <span class="n">day</span> <span class="n">year</span>
    <span class="k">with</span>
      <span class="o">|</span> <span class="nn">Scanf</span><span class="p">.</span><span class="nc">Scan_failure</span> <span class="o">_</span>
      <span class="o">|</span> <span class="nc">End_of_file</span>
      <span class="o">|</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">ERANGE</span><span class="o">,</span> <span class="s2">&quot;mktime&quot;</span><span class="o">,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
          <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Bad date string: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">line</span>
  <span class="k">done</span>

<span class="c">(* @@PLEAC@@_3.8 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">open</span> <span class="nc">Unix</span>
<span class="k">open</span> <span class="nc">Printf</span>

<span class="k">let</span> <span class="n">days</span> <span class="o">=</span> <span class="o">[|</span> <span class="s2">&quot;Sun&quot;</span><span class="o">;</span> <span class="s2">&quot;Mon&quot;</span><span class="o">;</span> <span class="s2">&quot;Tue&quot;</span><span class="o">;</span> <span class="s2">&quot;Wed&quot;</span><span class="o">;</span> <span class="s2">&quot;Thu&quot;</span><span class="o">;</span> <span class="s2">&quot;Fri&quot;</span><span class="o">;</span> <span class="s2">&quot;Sat&quot;</span> <span class="o">|]</span>
<span class="k">let</span> <span class="n">months</span> <span class="o">=</span> <span class="o">[|</span> <span class="s2">&quot;Jan&quot;</span><span class="o">;</span> <span class="s2">&quot;Feb&quot;</span><span class="o">;</span> <span class="s2">&quot;Mar&quot;</span><span class="o">;</span> <span class="s2">&quot;Apr&quot;</span><span class="o">;</span> <span class="s2">&quot;May&quot;</span><span class="o">;</span> <span class="s2">&quot;Jun&quot;</span><span class="o">;</span>
                <span class="s2">&quot;Jul&quot;</span><span class="o">;</span> <span class="s2">&quot;Aug&quot;</span><span class="o">;</span> <span class="s2">&quot;Sep&quot;</span><span class="o">;</span> <span class="s2">&quot;Oct&quot;</span><span class="o">;</span> <span class="s2">&quot;Nov&quot;</span><span class="o">;</span> <span class="s2">&quot;Dec&quot;</span> <span class="o">|]</span>

<span class="k">let</span> <span class="n">format_time</span> <span class="n">time</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">tm</span> <span class="o">=</span> <span class="n">localtime</span> <span class="n">time</span> <span class="k">in</span>
  <span class="n">sprintf</span> <span class="s2">&quot;%s %s %2d %02d:%02d:%02d %04d&quot;</span>
    <span class="n">days</span><span class="o">.(</span><span class="n">tm</span><span class="o">.</span><span class="n">tm_wday</span><span class="o">)</span>
    <span class="n">months</span><span class="o">.(</span><span class="n">tm</span><span class="o">.</span><span class="n">tm_mon</span><span class="o">)</span>
    <span class="n">tm</span><span class="o">.</span><span class="n">tm_mday</span>
    <span class="n">tm</span><span class="o">.</span><span class="n">tm_hour</span>
    <span class="n">tm</span><span class="o">.</span><span class="n">tm_min</span>
    <span class="n">tm</span><span class="o">.</span><span class="n">tm_sec</span>
    <span class="o">(</span><span class="n">tm</span><span class="o">.</span><span class="n">tm_year</span> <span class="o">+</span> <span class="mi">1900</span><span class="o">)</span>

<span class="k">let</span> <span class="n">time</span> <span class="o">=</span> <span class="n">fst</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">mktime</span> <span class="o">{</span><span class="n">tm_sec</span><span class="o">=</span><span class="mi">50</span><span class="o">;</span> <span class="n">tm_min</span><span class="o">=</span><span class="mi">45</span><span class="o">;</span> <span class="n">tm_hour</span><span class="o">=</span><span class="mi">3</span><span class="o">;</span>
                             <span class="n">tm_mday</span><span class="o">=</span><span class="mi">18</span><span class="o">;</span> <span class="n">tm_mon</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">tm_year</span><span class="o">=</span><span class="mi">73</span><span class="o">;</span>
                             <span class="n">tm_wday</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">tm_yday</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">tm_isdst</span><span class="o">=</span><span class="bp">false</span><span class="o">})</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">printf</span> <span class="s2">&quot;format_time gives: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">format_time</span> <span class="n">time</span><span class="o">)</span>

<span class="c">(* @@PLEAC@@_3.9 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">t0</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">gettimeofday</span> <span class="bp">()</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">print_string</span> <span class="s2">&quot;Press return when ready: &quot;</span><span class="o">;</span> <span class="n">ignore</span> <span class="o">(</span><span class="n">read_line</span> <span class="bp">()</span><span class="o">)</span>
<span class="k">let</span> <span class="n">t1</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">gettimeofday</span> <span class="bp">()</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;You took %f seconds.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">t1</span> <span class="o">-.</span> <span class="n">t0</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">500</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">number_of_times</span> <span class="o">=</span> <span class="mi">100</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">total_time</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span><span class="o">.</span> <span class="k">in</span>

<span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">to</span> <span class="n">number_of_times</span> <span class="k">do</span>
  <span class="k">let</span> <span class="kt">array</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">init</span> <span class="n">size</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nn">Random</span><span class="p">.</span><span class="n">bits</span><span class="bp">()</span><span class="o">)</span> <span class="k">in</span>

  <span class="k">let</span> <span class="n">before</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">gettimeofday</span><span class="bp">()</span> <span class="k">in</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">stable_sort</span> <span class="n">compare</span> <span class="kt">array</span> <span class="o">;</span>
  <span class="k">let</span> <span class="n">time</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">gettimeofday</span><span class="bp">()</span> <span class="o">-.</span> <span class="n">before</span> <span class="k">in</span>
  <span class="n">total_time</span> <span class="o">:=</span> <span class="o">!</span><span class="n">total_time</span> <span class="o">+.</span> <span class="n">time</span>
<span class="k">done</span> <span class="o">;</span>

<span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;On average, sorting %d random numbers takes %.5f seconds</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">size</span> <span class="o">(!</span><span class="n">total_time</span> <span class="o">/.</span> <span class="kt">float</span> <span class="n">number_of_times</span><span class="o">)</span>

<span class="c">(* @@PLEAC@@_3.10 *)</span>
<span class="k">let</span> <span class="n">usleep</span> <span class="n">time</span> <span class="o">=</span>
  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">select</span> <span class="bp">[]</span> <span class="bp">[]</span> <span class="bp">[]</span> <span class="n">time</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
    <span class="n">usleep</span> <span class="mi">0</span><span class="o">.</span><span class="mi">25</span><span class="o">;</span>
    <span class="n">print_newline</span> <span class="bp">()</span><span class="o">;</span>
  <span class="k">done</span>

<span class="c">(* @@PLEAC@@_3.11 *)</span>
<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* hopdelta - feed mail header, produce lines</span>
<span class="c">              showing delay at each hop. *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="c">(* Modify this function to tweak the format of results. *)</span>
<span class="k">let</span> <span class="n">print_result</span> <span class="n">sender</span> <span class="n">recipient</span> <span class="n">time</span> <span class="n">delta</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%-30s %-30s %-20s   %s</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">sender</span> <span class="n">recipient</span> <span class="n">time</span> <span class="n">delta</span>

<span class="c">(* Produce a stream of lines from an input channel. *)</span>
<span class="k">let</span> <span class="n">line_stream_of_channel</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">channel</span><span class="o">)</span> <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="nc">None</span><span class="o">)</span>

<span class="c">(* Turn a stream of lines into a stream of paragraphs, where each</span>
<span class="c">   paragraph is a stream of lines. Paragraphs are delimited by one</span>
<span class="c">   or more empty lines. *)</span>
<span class="k">let</span> <span class="n">paragraphs</span> <span class="n">lines</span> <span class="o">=</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">next</span> <span class="n">para_lines</span> <span class="n">i</span> <span class="o">=</span>
    <span class="k">match</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">peek</span> <span class="n">lines</span><span class="o">,</span> <span class="n">para_lines</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">None</span><span class="o">,</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="nc">None</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="s2">&quot;&quot;</span><span class="o">,</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">lines</span><span class="o">;</span> <span class="n">next</span> <span class="n">para_lines</span> <span class="n">i</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="s2">&quot;&quot;</span><span class="o">,</span> <span class="o">_</span> <span class="o">|</span> <span class="nc">None</span><span class="o">,</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nc">Some</span> <span class="o">(</span><span class="nn">Stream</span><span class="p">.</span><span class="n">of_list</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="n">para_lines</span><span class="o">))</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">line</span><span class="o">,</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">lines</span><span class="o">;</span> <span class="n">next</span> <span class="o">(</span><span class="n">line</span> <span class="o">::</span> <span class="n">para_lines</span><span class="o">)</span> <span class="n">i</span> <span class="k">in</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span> <span class="o">(</span><span class="n">next</span> <span class="bp">[]</span><span class="o">)</span>

<span class="c">(* Find blocks of email headers in a stream of paragraphs. Headers</span>
<span class="c">   are all assumed to have a first line starting with &quot;From&quot; and</span>
<span class="c">   containing a &#39;@&#39; character. This is not very robust. *)</span>
<span class="k">let</span> <span class="n">header_blocks</span> <span class="n">paras</span> <span class="o">=</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">next</span> <span class="n">i</span> <span class="o">=</span>
    <span class="k">match</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">peek</span> <span class="n">paras</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">lines</span> <span class="o">-&gt;</span>
          <span class="k">if</span> <span class="o">(</span><span class="k">match</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">peek</span> <span class="n">lines</span> <span class="k">with</span>
                <span class="o">|</span> <span class="nc">Some</span> <span class="n">line</span> <span class="o">-&gt;</span>
                    <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">line</span> <span class="o">&gt;=</span> <span class="mi">5</span>
                     <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">line</span> <span class="mi">0</span> <span class="mi">5</span> <span class="o">=</span> <span class="s2">&quot;From &quot;</span><span class="o">)</span>
                     <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">contains</span> <span class="n">line</span> <span class="sc">&#39;@&#39;</span><span class="o">))</span>
                <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="bp">false</span><span class="o">)</span>
          <span class="k">then</span> <span class="nc">Some</span> <span class="o">(</span><span class="nn">Stream</span><span class="p">.</span><span class="n">next</span> <span class="n">paras</span><span class="o">)</span>
          <span class="k">else</span> <span class="o">(</span><span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">paras</span><span class="o">;</span> <span class="n">next</span> <span class="n">i</span><span class="o">)</span>
      <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="nc">None</span> <span class="k">in</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span> <span class="n">next</span>

<span class="c">(* Pattern to detect continuation lines. *)</span>
<span class="k">let</span> <span class="n">continuation_regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;^[</span><span class="se">\t</span><span class="s2"> ]+&quot;</span>

<span class="c">(* Transform a stream of lines such that continuation lines are joined</span>
<span class="c">   with previous lines by a single space. *)</span>
<span class="k">let</span> <span class="n">join_continuations</span> <span class="n">lines</span> <span class="o">=</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">continuations</span> <span class="bp">()</span> <span class="o">=</span>
    <span class="k">match</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">peek</span> <span class="n">lines</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">line</span> <span class="o">-&gt;</span>
          <span class="k">let</span> <span class="n">found</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span> <span class="k">in</span>
          <span class="k">let</span> <span class="n">trimmed</span> <span class="o">=</span>
            <span class="nn">Str</span><span class="p">.</span><span class="n">substitute_first</span>
              <span class="n">continuation_regexp</span>
              <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">found</span> <span class="o">:=</span> <span class="bp">true</span><span class="o">;</span> <span class="s2">&quot;&quot;</span><span class="o">)</span>
              <span class="n">line</span> <span class="k">in</span>
          <span class="k">if</span> <span class="o">!</span><span class="n">found</span>
          <span class="k">then</span> <span class="o">(</span><span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">lines</span><span class="o">;</span> <span class="s2">&quot; &quot;</span> <span class="o">^</span> <span class="n">trimmed</span> <span class="o">^</span> <span class="n">continuations</span> <span class="bp">()</span><span class="o">)</span>
          <span class="k">else</span> <span class="s2">&quot;&quot;</span>
      <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="s2">&quot;&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">next</span> <span class="n">i</span> <span class="o">=</span>
    <span class="k">match</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">peek</span> <span class="n">lines</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">line</span> <span class="o">-&gt;</span>
          <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">lines</span><span class="o">;</span>
          <span class="nc">Some</span> <span class="o">(</span><span class="n">line</span> <span class="o">^</span> <span class="n">continuations</span> <span class="bp">()</span><span class="o">)</span>
      <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="nc">None</span> <span class="k">in</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span> <span class="n">next</span>

<span class="c">(* A type for headers, where &quot;from&quot; contains the text of the &quot;From&quot;</span>
<span class="c">   line, and the rest of the headers are parsed into a (key, value)</span>
<span class="c">   list called &quot;params&quot;. *)</span>
<span class="k">type</span> <span class="n">header</span> <span class="o">=</span> <span class="o">{</span> <span class="n">from</span> <span class="o">:</span> <span class="kt">string</span><span class="o">;</span>
                <span class="n">params</span> <span class="o">:</span> <span class="o">(</span><span class="kt">string</span> <span class="o">*</span> <span class="kt">string</span><span class="o">)</span> <span class="kt">list</span> <span class="o">}</span>

<span class="c">(* Given a stream of header blocks, produce a stream of values of the</span>
<span class="c">   above &quot;header&quot; type. *)</span>
<span class="k">let</span> <span class="n">headers</span> <span class="n">blocks</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">parse_from</span> <span class="n">line</span> <span class="o">=</span>
    <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">line</span> <span class="mi">5</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">line</span> <span class="o">-</span> <span class="mi">5</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">parse_param</span> <span class="n">params</span> <span class="n">line</span> <span class="o">=</span>
    <span class="k">try</span>
      <span class="k">let</span> <span class="n">index</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">index</span> <span class="n">line</span> <span class="sc">&#39;:&#39;</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">key</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">line</span> <span class="mi">0</span> <span class="n">index</span> <span class="k">in</span>
      <span class="k">let</span> <span class="k">value</span> <span class="o">=</span>
        <span class="k">if</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">line</span> <span class="o">&gt;</span> <span class="n">index</span> <span class="o">+</span> <span class="mi">2</span>
        <span class="k">then</span>
          <span class="nn">String</span><span class="p">.</span><span class="n">sub</span>
            <span class="n">line</span>
            <span class="o">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">2</span><span class="o">)</span>
            <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">line</span> <span class="o">-</span> <span class="n">index</span> <span class="o">-</span> <span class="mi">2</span><span class="o">)</span>
        <span class="k">else</span> <span class="s2">&quot;&quot;</span> <span class="k">in</span>
      <span class="n">params</span> <span class="o">:=</span> <span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="k">value</span><span class="o">)</span> <span class="o">::</span> <span class="o">!</span><span class="n">params</span>
    <span class="k">with</span>
      <span class="o">|</span> <span class="nc">Not_found</span>
      <span class="o">|</span> <span class="nc">Invalid_argument</span> <span class="s2">&quot;String.sub&quot;</span> <span class="o">-&gt;</span>
          <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Unable to parse header: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">line</span><span class="o">;</span>
          <span class="bp">()</span> <span class="k">in</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">next</span> <span class="n">i</span> <span class="o">=</span>
    <span class="k">try</span>
      <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">next</span> <span class="n">blocks</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">join_continuations</span> <span class="n">lines</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">from</span> <span class="o">=</span> <span class="n">parse_from</span> <span class="o">(</span><span class="nn">Stream</span><span class="p">.</span><span class="n">next</span> <span class="n">lines</span><span class="o">)</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">params</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
      <span class="nn">Stream</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="n">parse_param</span> <span class="n">params</span><span class="o">)</span> <span class="n">lines</span><span class="o">;</span>
      <span class="nc">Some</span> <span class="o">{</span> <span class="n">from</span> <span class="o">=</span> <span class="n">from</span><span class="o">;</span> <span class="n">params</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="o">!</span><span class="n">params</span> <span class="o">}</span>
    <span class="k">with</span> <span class="nn">Stream</span><span class="p">.</span><span class="nc">Failure</span> <span class="o">-&gt;</span>
      <span class="nc">None</span> <span class="k">in</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span> <span class="n">next</span>

<span class="c">(* Combine the above stream transformers to produce a function from</span>
<span class="c">   input channels to streams of headers. *)</span>
<span class="k">let</span> <span class="n">header_stream_of_channel</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="n">headers</span>
    <span class="o">(</span><span class="n">header_blocks</span>
       <span class="o">(</span><span class="n">paragraphs</span>
          <span class="o">(</span><span class="n">line_stream_of_channel</span> <span class="n">channel</span><span class="o">)))</span>

<span class="c">(* Association list mapping month abbreviations to 0-based month</span>
<span class="c">   numbers as required by Unix.mktime. *)</span>
<span class="k">let</span> <span class="n">months</span> <span class="o">=</span>
  <span class="o">[</span><span class="s2">&quot;Jan&quot;</span><span class="o">,</span> <span class="mi">0</span><span class="o">;</span> <span class="s2">&quot;Feb&quot;</span><span class="o">,</span> <span class="mi">1</span><span class="o">;</span> <span class="s2">&quot;Mar&quot;</span><span class="o">,</span> <span class="mi">2</span><span class="o">;</span> <span class="s2">&quot;Apr&quot;</span><span class="o">,</span> <span class="mi">3</span><span class="o">;</span> <span class="s2">&quot;May&quot;</span><span class="o">,</span> <span class="mi">4</span><span class="o">;</span> <span class="s2">&quot;Jun&quot;</span><span class="o">,</span> <span class="mi">5</span><span class="o">;</span>
   <span class="s2">&quot;Jul&quot;</span><span class="o">,</span> <span class="mi">6</span><span class="o">;</span> <span class="s2">&quot;Aug&quot;</span><span class="o">,</span> <span class="mi">7</span><span class="o">;</span> <span class="s2">&quot;Sep&quot;</span><span class="o">,</span> <span class="mi">8</span><span class="o">;</span> <span class="s2">&quot;Oct&quot;</span><span class="o">,</span> <span class="mi">9</span><span class="o">;</span> <span class="s2">&quot;Nov&quot;</span><span class="o">,</span> <span class="mi">10</span><span class="o">;</span> <span class="s2">&quot;Dec&quot;</span><span class="o">,</span> <span class="mi">11</span><span class="o">]</span>

<span class="c">(* Turn a time zone into an offset in minutes. Not exhaustive. *)</span>
<span class="k">let</span> <span class="n">parse_tz</span> <span class="o">=</span> <span class="k">function</span>
  <span class="o">|</span> <span class="s2">&quot;&quot;</span> <span class="o">|</span> <span class="s2">&quot;Z&quot;</span> <span class="o">|</span> <span class="s2">&quot;GMT&quot;</span> <span class="o">|</span> <span class="s2">&quot;UTC&quot;</span> <span class="o">|</span> <span class="s2">&quot;UT&quot;</span> <span class="o">-&gt;</span> <span class="mi">0</span>
  <span class="o">|</span> <span class="s2">&quot;PST&quot;</span> <span class="o">-&gt;</span> <span class="o">-</span><span class="mi">480</span>
  <span class="o">|</span> <span class="s2">&quot;MST&quot;</span> <span class="o">|</span> <span class="s2">&quot;PDT&quot;</span> <span class="o">-&gt;</span> <span class="o">-</span><span class="mi">420</span>
  <span class="o">|</span> <span class="s2">&quot;CST&quot;</span> <span class="o">|</span> <span class="s2">&quot;MDT&quot;</span> <span class="o">-&gt;</span> <span class="o">-</span><span class="mi">360</span>
  <span class="o">|</span> <span class="s2">&quot;EST&quot;</span> <span class="o">|</span> <span class="s2">&quot;CDT&quot;</span> <span class="o">-&gt;</span> <span class="o">-</span><span class="mi">300</span>
  <span class="o">|</span> <span class="s2">&quot;EDT&quot;</span> <span class="o">-&gt;</span> <span class="o">-</span><span class="mi">240</span>
  <span class="o">|</span> <span class="kt">string</span> <span class="o">-&gt;</span>
      <span class="nn">Scanf</span><span class="p">.</span><span class="n">sscanf</span> <span class="kt">string</span> <span class="s2">&quot;%c%02d%_[:]%02d&quot;</span>
        <span class="o">(</span><span class="k">fun</span> <span class="n">sign</span> <span class="n">hour</span> <span class="n">min</span> <span class="o">-&gt;</span>
           <span class="n">min</span> <span class="o">+</span> <span class="n">hour</span> <span class="o">*</span> <span class="o">(</span><span class="k">if</span> <span class="n">sign</span> <span class="o">=</span> <span class="sc">&#39;-&#39;</span> <span class="k">then</span> <span class="o">-</span><span class="mi">60</span> <span class="k">else</span> <span class="mi">60</span><span class="o">))</span>

<span class="c">(* List of date-parsing functions from strings to epoch seconds. *)</span>
<span class="k">let</span> <span class="n">date_parsers</span> <span class="o">=</span>
  <span class="o">[</span>
    <span class="o">(</span><span class="k">fun</span> <span class="kt">string</span> <span class="o">-&gt;</span>
       <span class="nn">Scanf</span><span class="p">.</span><span class="n">sscanf</span> <span class="kt">string</span> <span class="s2">&quot;%d %s %d %d:%d:%d %s&quot;</span>
         <span class="o">(</span><span class="k">fun</span> <span class="n">mday</span> <span class="n">mon</span> <span class="n">year</span> <span class="n">hour</span> <span class="n">min</span> <span class="n">sec</span> <span class="n">tz</span> <span class="o">-&gt;</span>
            <span class="k">let</span> <span class="n">mon</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">assoc</span> <span class="n">mon</span> <span class="n">months</span> <span class="k">in</span>
            <span class="n">fst</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">mktime</span>
                   <span class="o">{</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_sec</span><span class="o">=</span><span class="n">sec</span><span class="o">;</span> <span class="n">tm_min</span><span class="o">=</span><span class="n">min</span><span class="o">;</span> <span class="n">tm_hour</span><span class="o">=</span><span class="n">hour</span><span class="o">;</span>
                    <span class="n">tm_mday</span><span class="o">=</span><span class="n">mday</span><span class="o">;</span> <span class="n">tm_mon</span><span class="o">=</span><span class="n">mon</span><span class="o">;</span> <span class="n">tm_year</span><span class="o">=</span><span class="n">year</span><span class="o">-</span><span class="mi">1900</span><span class="o">;</span>
                    <span class="n">tm_wday</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">tm_yday</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">tm_isdst</span><span class="o">=</span><span class="bp">false</span><span class="o">})</span>
            <span class="o">-.</span> <span class="o">(</span><span class="kt">float</span> <span class="o">(</span><span class="n">parse_tz</span> <span class="n">tz</span><span class="o">)</span> <span class="o">*.</span> <span class="mi">60</span><span class="o">.</span><span class="mi">0</span><span class="o">)));</span>
    <span class="o">(</span><span class="k">fun</span> <span class="kt">string</span> <span class="o">-&gt;</span>
       <span class="nn">Scanf</span><span class="p">.</span><span class="n">sscanf</span> <span class="kt">string</span> <span class="s2">&quot;%3s, %d %s %4d %d:%d:%d %s&quot;</span>
         <span class="o">(</span><span class="k">fun</span> <span class="n">wday</span> <span class="n">mday</span> <span class="n">mon</span> <span class="n">year</span> <span class="n">hour</span> <span class="n">min</span> <span class="n">sec</span> <span class="n">tz</span> <span class="o">-&gt;</span>
            <span class="k">let</span> <span class="n">mon</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">assoc</span> <span class="n">mon</span> <span class="n">months</span> <span class="k">in</span>
            <span class="n">fst</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">mktime</span>
                   <span class="o">{</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_sec</span><span class="o">=</span><span class="n">sec</span><span class="o">;</span> <span class="n">tm_min</span><span class="o">=</span><span class="n">min</span><span class="o">;</span> <span class="n">tm_hour</span><span class="o">=</span><span class="n">hour</span><span class="o">;</span>
                    <span class="n">tm_mday</span><span class="o">=</span><span class="n">mday</span><span class="o">;</span> <span class="n">tm_mon</span><span class="o">=</span><span class="n">mon</span><span class="o">;</span> <span class="n">tm_year</span><span class="o">=</span><span class="n">year</span><span class="o">-</span><span class="mi">1900</span><span class="o">;</span>
                    <span class="n">tm_wday</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">tm_yday</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">tm_isdst</span><span class="o">=</span><span class="bp">false</span><span class="o">})</span>
            <span class="o">-.</span> <span class="o">(</span><span class="kt">float</span> <span class="o">(</span><span class="n">parse_tz</span> <span class="n">tz</span><span class="o">)</span> <span class="o">*.</span> <span class="mi">60</span><span class="o">.</span><span class="mi">0</span><span class="o">)));</span>
    <span class="o">(</span><span class="k">fun</span> <span class="kt">string</span> <span class="o">-&gt;</span>
       <span class="nn">Scanf</span><span class="p">.</span><span class="n">sscanf</span> <span class="kt">string</span> <span class="s2">&quot;%3s, %d %s %2d %d:%d:%d %s&quot;</span>
         <span class="o">(</span><span class="k">fun</span> <span class="n">wday</span> <span class="n">mday</span> <span class="n">mon</span> <span class="n">year</span> <span class="n">hour</span> <span class="n">min</span> <span class="n">sec</span> <span class="n">tz</span> <span class="o">-&gt;</span>
            <span class="k">let</span> <span class="n">mon</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">assoc</span> <span class="n">mon</span> <span class="n">months</span> <span class="k">in</span>
            <span class="n">fst</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">mktime</span>
                   <span class="o">{</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_sec</span><span class="o">=</span><span class="n">sec</span><span class="o">;</span> <span class="n">tm_min</span><span class="o">=</span><span class="n">min</span><span class="o">;</span> <span class="n">tm_hour</span><span class="o">=</span><span class="n">hour</span><span class="o">;</span>
                    <span class="n">tm_mday</span><span class="o">=</span><span class="n">mday</span><span class="o">;</span> <span class="n">tm_mon</span><span class="o">=</span><span class="n">mon</span><span class="o">;</span> <span class="n">tm_year</span><span class="o">=</span><span class="n">year</span><span class="o">;</span>
                    <span class="n">tm_wday</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">tm_yday</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">tm_isdst</span><span class="o">=</span><span class="bp">false</span><span class="o">})</span>
            <span class="o">-.</span> <span class="o">(</span><span class="kt">float</span> <span class="o">(</span><span class="n">parse_tz</span> <span class="n">tz</span><span class="o">)</span> <span class="o">*.</span> <span class="mi">60</span><span class="o">.</span><span class="mi">0</span><span class="o">)));</span>
  <span class="o">]</span>

<span class="c">(* Tries each of the above date parsers, one at a time, until one</span>
<span class="c">   of them doesn&#39;t throw an exception. If they all fail, returns</span>
<span class="c">   a value of 0.0. *)</span>
<span class="k">let</span> <span class="n">getdate</span> <span class="kt">string</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">result</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">parsers</span> <span class="o">=</span> <span class="n">ref</span> <span class="n">date_parsers</span> <span class="k">in</span>
  <span class="k">while</span> <span class="o">!</span><span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">parsers</span> <span class="o">&lt;&gt;</span> <span class="bp">[]</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">parse</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">hd</span> <span class="o">!</span><span class="n">parsers</span> <span class="k">in</span>
    <span class="n">parsers</span> <span class="o">:=</span> <span class="nn">List</span><span class="p">.</span><span class="n">tl</span> <span class="o">!</span><span class="n">parsers</span><span class="o">;</span>
    <span class="k">try</span> <span class="n">result</span> <span class="o">:=</span> <span class="n">parse</span> <span class="kt">string</span> <span class="k">with</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span>
  <span class="k">done</span><span class="o">;</span>
  <span class="o">!</span><span class="n">result</span>

<span class="c">(* Formats a date given in epoch seconds for display. *)</span>
<span class="k">let</span> <span class="n">fmtdate</span> <span class="n">epoch</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">tm</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">localtime</span> <span class="n">epoch</span> <span class="k">in</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;%02d:%02d:%02d %04d/%02d/%02d&quot;</span>
    <span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_hour</span> <span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_min</span> <span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_sec</span>
    <span class="o">(</span><span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_year</span> <span class="o">+</span> <span class="mi">1900</span><span class="o">)</span> <span class="o">(</span><span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_mon</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_mday</span>

<span class="c">(* Formats the difference between two epoch times for display. *)</span>
<span class="k">let</span> <span class="n">fmtdelta</span> <span class="n">delta</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">sign</span>    <span class="o">=</span> <span class="k">if</span> <span class="n">delta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span> <span class="k">then</span> <span class="sc">&#39;-&#39;</span> <span class="k">else</span> <span class="sc">&#39; &#39;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">delta</span>   <span class="o">=</span> <span class="n">abs_float</span> <span class="n">delta</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">seconds</span> <span class="o">=</span> <span class="n">mod_float</span> <span class="n">delta</span> <span class="mi">60</span><span class="o">.</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">delta</span>   <span class="o">=</span> <span class="o">(</span><span class="n">delta</span> <span class="o">-.</span> <span class="n">seconds</span><span class="o">)</span> <span class="o">/.</span> <span class="mi">60</span><span class="o">.</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">minutes</span> <span class="o">=</span> <span class="n">mod_float</span> <span class="n">delta</span> <span class="mi">60</span><span class="o">.</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">delta</span>   <span class="o">=</span> <span class="o">(</span><span class="n">delta</span> <span class="o">-.</span> <span class="n">minutes</span><span class="o">)</span> <span class="o">/.</span> <span class="mi">60</span><span class="o">.</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">hours</span>   <span class="o">=</span> <span class="n">mod_float</span> <span class="n">delta</span> <span class="mi">24</span><span class="o">.</span> <span class="k">in</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;%c%02.f:%02.f:%02.f&quot;</span> <span class="n">sign</span> <span class="n">hours</span> <span class="n">minutes</span> <span class="n">seconds</span>

<span class="c">(* Process the header for a single email. *)</span>
<span class="k">let</span> <span class="n">process_header</span> <span class="n">header</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">start_from</span> <span class="o">=</span>
    <span class="k">try</span> <span class="nn">List</span><span class="p">.</span><span class="n">assoc</span> <span class="s2">&quot;From&quot;</span> <span class="n">header</span><span class="o">.</span><span class="n">params</span>
    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="n">header</span><span class="o">.</span><span class="n">from</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">start_from</span> <span class="o">=</span>
    <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span>
      <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;.*@</span><span class="se">\\</span><span class="s2">([^ &gt;]*</span><span class="se">\\</span><span class="s2">).*&quot;</span><span class="o">)</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">1&quot;</span> <span class="n">start_from</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">start_date</span> <span class="o">=</span>
    <span class="k">try</span> <span class="nn">List</span><span class="p">.</span><span class="n">assoc</span> <span class="s2">&quot;Date&quot;</span> <span class="n">header</span><span class="o">.</span><span class="n">params</span>
    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="s2">&quot;&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">start_date</span> <span class="o">=</span>
    <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span>
      <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot; +(.*$&quot;</span><span class="o">)</span> <span class="s2">&quot;&quot;</span> <span class="n">start_date</span> <span class="k">in</span>
  <span class="k">let</span> <span class="k">then&#39;</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="n">getdate</span> <span class="n">start_date</span><span class="o">)</span> <span class="k">in</span>
  <span class="n">print_result</span> <span class="s2">&quot;Sender&quot;</span> <span class="s2">&quot;Recipient&quot;</span> <span class="s2">&quot;Time&quot;</span> <span class="s2">&quot; Delta&quot;</span><span class="o">;</span>
  <span class="n">print_result</span> <span class="s2">&quot;Start&quot;</span> <span class="n">start_from</span> <span class="o">(</span><span class="n">fmtdate</span> <span class="o">!</span><span class="k">then&#39;</span><span class="o">)</span> <span class="s2">&quot;&quot;</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">prevfrom</span> <span class="o">=</span> <span class="n">ref</span> <span class="n">start_from</span> <span class="k">in</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="k">value</span><span class="o">)</span> <span class="o">-&gt;</span>
       <span class="k">if</span> <span class="n">key</span> <span class="o">=</span> <span class="s2">&quot;Received&quot;</span>
       <span class="k">then</span>
         <span class="k">begin</span>
           <span class="k">let</span> <span class="k">when&#39;</span> <span class="o">=</span>
             <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span>
               <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;.*; +</span><span class="se">\\</span><span class="s2">(.*</span><span class="se">\\</span><span class="s2">)$&quot;</span><span class="o">)</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">1&quot;</span> <span class="k">value</span> <span class="k">in</span>
           <span class="k">let</span> <span class="k">when&#39;</span> <span class="o">=</span>
             <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span>
               <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot; +(.*$&quot;</span><span class="o">)</span> <span class="s2">&quot;&quot;</span> <span class="k">when&#39;</span> <span class="k">in</span>
           <span class="k">let</span> <span class="n">from&#39;</span> <span class="o">=</span>
             <span class="k">try</span>
               <span class="n">ignore</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span>
                         <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;from +</span><span class="se">\\</span><span class="s2">([^ )]+</span><span class="se">\\</span><span class="s2">)&quot;</span><span class="o">)</span> <span class="k">value</span> <span class="mi">0</span><span class="o">);</span>
               <span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">1</span> <span class="k">value</span>
             <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
               <span class="k">try</span>
                 <span class="n">ignore</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span>
                           <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;(</span><span class="se">\\</span><span class="s2">([^)]*</span><span class="se">\\</span><span class="s2">))&quot;</span><span class="o">)</span> <span class="k">value</span> <span class="mi">0</span><span class="o">);</span>
                 <span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">1</span> <span class="k">value</span>
               <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="s2">&quot;&quot;</span> <span class="k">in</span>
           <span class="k">let</span> <span class="n">from&#39;</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;)$&quot;</span><span class="o">)</span> <span class="s2">&quot;&quot;</span> <span class="n">from&#39;</span> <span class="k">in</span>
           <span class="k">let</span> <span class="n">by&#39;</span> <span class="o">=</span>
             <span class="k">try</span>
               <span class="n">ignore</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span>
                         <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;by +</span><span class="se">\\</span><span class="s2">([^ ]+</span><span class="se">\\</span><span class="s2">.[^ ]+</span><span class="se">\\</span><span class="s2">)&quot;</span><span class="o">)</span> <span class="k">value</span> <span class="mi">0</span><span class="o">);</span>
               <span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">1</span> <span class="k">value</span>
             <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="s2">&quot;&quot;</span> <span class="k">in</span>
           <span class="k">let</span> <span class="n">now</span> <span class="o">=</span> <span class="n">getdate</span> <span class="k">when&#39;</span> <span class="k">in</span>
           <span class="k">let</span> <span class="n">delta</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-.</span> <span class="o">!</span><span class="k">then&#39;</span> <span class="k">in</span>
           <span class="n">print_result</span>
             <span class="o">(</span><span class="k">if</span> <span class="o">!</span><span class="n">prevfrom</span> <span class="o">&lt;&gt;</span> <span class="s2">&quot;&quot;</span> <span class="k">then</span> <span class="o">!</span><span class="n">prevfrom</span> <span class="k">else</span> <span class="n">from&#39;</span><span class="o">)</span>
             <span class="n">by&#39;</span>
             <span class="o">(</span><span class="n">fmtdate</span> <span class="n">now</span><span class="o">)</span>
             <span class="o">(</span><span class="n">fmtdelta</span> <span class="n">delta</span><span class="o">);</span>
           <span class="k">then&#39;</span> <span class="o">:=</span> <span class="n">now</span><span class="o">;</span>
           <span class="n">prevfrom</span> <span class="o">:=</span> <span class="n">by&#39;</span><span class="o">;</span>
         <span class="k">end</span><span class="o">)</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="n">header</span><span class="o">.</span><span class="n">params</span><span class="o">);</span>
  <span class="n">print_newline</span> <span class="bp">()</span><span class="o">;</span>
  <span class="n">flush</span> <span class="n">stdout</span>

<span class="c">(* Process all emails from standard input. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">iter</span> <span class="n">process_header</span> <span class="o">(</span><span class="n">header_stream_of_channel</span> <span class="n">stdin</span><span class="o">)</span>


<span class="c">(* @@PLEAC@@_4.0 *)</span>
<span class="k">let</span> <span class="n">nested</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;this&quot;</span><span class="o">;</span> <span class="s2">&quot;that&quot;</span><span class="o">;</span> <span class="s2">&quot;the&quot;</span><span class="o">;</span> <span class="s2">&quot;other&quot;</span><span class="o">]</span> <span class="c">(* string list *)</span>

<span class="c">(* there is no such non-homogeneous list. You can do things with tuples: *)</span>
<span class="k">let</span> <span class="n">nested</span> <span class="o">=</span> <span class="o">(</span><span class="s2">&quot;this&quot;</span><span class="o">,</span> <span class="s2">&quot;that&quot;</span><span class="o">,</span> <span class="o">[</span><span class="s2">&quot;the&quot;</span><span class="o">;</span> <span class="s2">&quot;other&quot;</span><span class="o">])</span> <span class="c">(* string * string * string list *)</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="n">tune</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;The&quot;</span><span class="o">;</span> <span class="s2">&quot;Star-Spangled&quot;</span><span class="o">;</span> <span class="s2">&quot;Banner&quot;</span><span class="o">]</span>
<span class="c">(*-----------------------------*)</span>

<span class="c">(* @@PLEAC@@_4.1 *)</span>
<span class="c">(* Note that Perl sort of munges OCaml lists and arrays into a single data</span>
<span class="c"> * structure.  In OCaml, they are two distinct data structures, and one needs to</span>
<span class="c"> * learn when it is best to use lists vs. arrays. *)</span>

<span class="c">(* To initialize a list *)</span>
<span class="k">let</span> <span class="n">l</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;quick&quot;</span><span class="o">;</span> <span class="s2">&quot;brown&quot;</span><span class="o">;</span> <span class="s2">&quot;fox&quot;</span><span class="o">];;</span>

<span class="c">(* To initialize an array *)</span>
<span class="k">let</span> <span class="n">a</span> <span class="o">=</span> <span class="o">[|</span><span class="s2">&quot;quick&quot;</span><span class="o">;</span> <span class="s2">&quot;brown&quot;</span><span class="o">;</span> <span class="s2">&quot;fox&quot;</span><span class="o">|];;</span>

<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="n">words</span> <span class="n">s</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">split</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[ </span><span class="se">\t</span><span class="s2">]+&quot;</span><span class="o">)</span> <span class="n">s</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">l</span> <span class="o">=</span> <span class="n">words</span> <span class="s2">&quot;Why are you teasing me?&quot;</span><span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="n">str</span> <span class="o">=</span> <span class="s2">&quot;  The boy stood on the burning deck,</span>
<span class="s2">  It was as hot as glass.</span>
<span class="s2">&quot;</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">f</span> <span class="n">l</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">sep</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[ </span><span class="se">\t\n</span><span class="s2">]*</span><span class="se">\\</span><span class="s2">(.+</span><span class="se">\\</span><span class="s2">)&quot;</span> <span class="k">in</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">s</span> <span class="o">-&gt;</span>
    <span class="k">if</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">sep</span> <span class="n">s</span> <span class="mi">0</span><span class="o">)</span> <span class="k">then</span>
      <span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">1</span> <span class="n">s</span>
    <span class="k">else</span>
      <span class="s2">&quot;&quot;</span>
  <span class="o">)</span> <span class="n">l</span>
<span class="k">in</span>
<span class="n">f</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">split</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp_string</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span> <span class="n">str</span><span class="o">);;</span>
<span class="c">(*</span>
<span class="c"> * - : string list =</span>
<span class="c"> * [&quot;The boy stood on the burning deck,&quot;; &quot;It was as hot as glass.&quot;]</span>
<span class="c"> *)</span>

<span class="k">let</span> <span class="n">data</span> <span class="o">=</span> <span class="n">open_in</span> <span class="s2">&quot;mydatafile&quot;</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">bigarray</span> <span class="o">=</span> <span class="n">readlines</span> <span class="n">data</span> <span class="k">in</span>
<span class="n">bigarray</span><span class="o">;;</span>


<span class="c">(* @@PLEAC@@_4.2 *)</span>

<span class="k">let</span> <span class="n">commify_series</span> <span class="n">l</span> <span class="o">=</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">sepChar</span> <span class="n">l</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">l</span> <span class="k">with</span>
    <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="s2">&quot;, &quot;</span>
  <span class="o">|</span> <span class="n">h</span><span class="o">::</span><span class="n">t</span> <span class="o">-&gt;</span>
       <span class="k">if</span> <span class="nn">String</span><span class="p">.</span><span class="n">contains</span> <span class="n">h</span> <span class="sc">&#39;,&#39;</span> <span class="k">then</span> <span class="s2">&quot;; &quot;</span> <span class="k">else</span> <span class="n">sepChar</span> <span class="n">t</span> <span class="k">in</span>
  <span class="k">match</span> <span class="n">l</span> <span class="k">with</span>
    <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="s2">&quot;&quot;</span>
  <span class="o">|</span> <span class="n">h</span><span class="o">::</span><span class="bp">[]</span> <span class="o">-&gt;</span> <span class="n">h</span>
  <span class="o">|</span> <span class="n">h1</span><span class="o">::</span><span class="n">h2</span><span class="o">::</span><span class="bp">[]</span> <span class="o">-&gt;</span> <span class="n">h1</span> <span class="o">^</span> <span class="s2">&quot; and &quot;</span> <span class="o">^</span> <span class="n">h2</span>
  <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span>
     <span class="k">let</span> <span class="n">l&#39;</span> <span class="o">=</span>
        <span class="k">let</span> <span class="n">last</span><span class="o">::</span><span class="n">rest</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="n">l</span> <span class="k">in</span>
        <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="o">((</span><span class="s2">&quot;and &quot;</span> <span class="o">^</span> <span class="n">last</span><span class="o">)::</span><span class="n">rest</span><span class="o">))</span> <span class="k">in</span>
     <span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="o">(</span><span class="n">sepChar</span> <span class="n">l</span><span class="o">)</span> <span class="n">l&#39;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">lists</span> <span class="o">=</span>
  <span class="o">[</span>
    <span class="o">[</span> <span class="s2">&quot;just one thing&quot;</span> <span class="o">];</span>
    <span class="o">[</span> <span class="s2">&quot;Mutt&quot;</span><span class="o">;</span> <span class="s2">&quot;Jeff&quot;</span> <span class="o">];</span>
    <span class="o">[</span> <span class="s2">&quot;Peter&quot;</span><span class="o">;</span> <span class="s2">&quot;Paul&quot;</span><span class="o">;</span> <span class="s2">&quot;Mary&quot;</span> <span class="o">];</span>
    <span class="o">[</span> <span class="s2">&quot;To our parents&quot;</span><span class="o">;</span> <span class="s2">&quot;Mother Theresa&quot;</span><span class="o">;</span> <span class="s2">&quot;God&quot;</span> <span class="o">];</span>
    <span class="o">[</span> <span class="s2">&quot;pastrami&quot;</span><span class="o">;</span> <span class="s2">&quot;ham and cheese&quot;</span><span class="o">;</span> <span class="s2">&quot;peanut butter and jelly&quot;</span><span class="o">;</span> <span class="s2">&quot;tuna&quot;</span> <span class="o">];</span>
    <span class="o">[</span> <span class="s2">&quot;recycle tired, old phrases&quot;</span><span class="o">;</span> <span class="s2">&quot;ponder big, happy thoughts&quot;</span> <span class="o">];</span>
    <span class="o">[</span> <span class="s2">&quot;recycle tired, old phrases&quot;</span><span class="o">;</span>
      <span class="s2">&quot;ponder big, happy thoughts&quot;</span><span class="o">;</span>
      <span class="s2">&quot;sleep and dream peacefully&quot;</span> <span class="o">]</span>
  <span class="o">];;</span>

<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">printf</span> <span class="s2">&quot;The list is: %s.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">commify_series</span> <span class="n">x</span><span class="o">))</span> <span class="n">lists</span><span class="o">;;</span>

<span class="c">(*</span>
<span class="c">The list is: just one thing.</span>
<span class="c">The list is: Mutt and Jeff.</span>
<span class="c">The list is: Peter, Paul, and Mary.</span>
<span class="c">The list is: To our parents, Mother Theresa, and God.</span>
<span class="c">The list is: pastrami, ham and cheese, peanut butter and jelly, and tuna.</span>
<span class="c">The list is: recycle tired, old phrases and ponder big, happy thoughts.</span>
<span class="c">The list is: recycle tired, old phrases; ponder big, happy thoughts; and sleep and dream peacefully.</span>
<span class="c">*)</span>

<span class="c">(* Note that if you are actually using arrays instead of lists, you can either</span>
<span class="c"> * reuse the above code by calling &quot;commify_series (Array.to_list a)&quot;, or you</span>
<span class="c"> * can use the following solution (which won&#39;t work with lists, but is probably</span>
<span class="c"> * more efficient).</span>
<span class="c">*)</span>

<span class="k">let</span> <span class="n">commify_array</span> <span class="n">a</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">len</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">a</span> <span class="k">in</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">sepChar</span> <span class="n">a</span> <span class="o">=</span>
    <span class="k">try</span>
      <span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span> <span class="k">to</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">do</span>
        <span class="k">if</span> <span class="nn">String</span><span class="p">.</span><span class="n">contains</span> <span class="n">a</span><span class="o">.(</span><span class="n">i</span><span class="o">)</span> <span class="sc">&#39;,&#39;</span> <span class="k">then</span> <span class="k">raise</span> <span class="nc">Not_found</span>
      <span class="k">done</span><span class="o">;</span>
      <span class="s2">&quot;, &quot;</span>
    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="s2">&quot;; &quot;</span> <span class="k">in</span>
  <span class="k">match</span> <span class="n">len</span> <span class="k">with</span>
    <span class="mi">0</span> <span class="o">-&gt;</span> <span class="s2">&quot;&quot;</span>
  <span class="o">|</span> <span class="mi">1</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span>
  <span class="o">|</span> <span class="mi">2</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span> <span class="o">^</span> <span class="s2">&quot; and &quot;</span> <span class="o">^</span> <span class="n">a</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span>
  <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span>
      <span class="k">let</span> <span class="n">buf</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">create</span> <span class="mi">10</span>
      <span class="ow">and</span> <span class="n">sep</span> <span class="o">=</span> <span class="n">sepChar</span> <span class="n">a</span> <span class="k">in</span>
      <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">to</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">2</span> <span class="k">do</span>
        <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_string</span> <span class="n">buf</span> <span class="n">a</span><span class="o">.(</span><span class="n">i</span><span class="o">);</span>
        <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_string</span> <span class="n">buf</span> <span class="n">sep</span><span class="o">;</span>
      <span class="k">done</span><span class="o">;</span>
      <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_string</span> <span class="n">buf</span> <span class="s2">&quot;and &quot;</span><span class="o">;</span>
      <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_string</span> <span class="n">buf</span> <span class="n">a</span><span class="o">.(</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
      <span class="nn">Buffer</span><span class="p">.</span><span class="n">contents</span> <span class="n">buf</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">arrays</span> <span class="o">=</span>
  <span class="o">[|</span>
    <span class="o">[|</span> <span class="s2">&quot;just one thing&quot;</span> <span class="o">|];</span>
    <span class="o">[|</span> <span class="s2">&quot;Mutt&quot;</span><span class="o">;</span> <span class="s2">&quot;Jeff&quot;</span> <span class="o">|];</span>
    <span class="o">[|</span> <span class="s2">&quot;Peter&quot;</span><span class="o">;</span> <span class="s2">&quot;Paul&quot;</span><span class="o">;</span> <span class="s2">&quot;Mary&quot;</span> <span class="o">|];</span>
    <span class="o">[|</span> <span class="s2">&quot;To our parents&quot;</span><span class="o">;</span> <span class="s2">&quot;Mother Theresa&quot;</span><span class="o">;</span> <span class="s2">&quot;God&quot;</span> <span class="o">|];</span>
    <span class="o">[|</span> <span class="s2">&quot;pastrami&quot;</span><span class="o">;</span> <span class="s2">&quot;ham and cheese&quot;</span><span class="o">;</span> <span class="s2">&quot;peanut butter and jelly&quot;</span><span class="o">;</span> <span class="s2">&quot;tuna&quot;</span> <span class="o">|];</span>
    <span class="o">[|</span> <span class="s2">&quot;recycle tired, old phrases&quot;</span><span class="o">;</span> <span class="s2">&quot;ponder big, happy thoughts&quot;</span> <span class="o">|];</span>
    <span class="o">[|</span> <span class="s2">&quot;recycle tired, old phrases&quot;</span><span class="o">;</span>
      <span class="s2">&quot;ponder big, happy thoughts&quot;</span><span class="o">;</span>
      <span class="s2">&quot;sleep and dream peacefully&quot;</span> <span class="o">|]</span>
  <span class="o">|];;</span>

<span class="nn">Array</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">printf</span> <span class="s2">&quot;The list is: %s.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">commify_array</span> <span class="n">x</span><span class="o">))</span> <span class="n">arrays</span><span class="o">;;</span>

<span class="c">(* @@PLEAC@@_4.3 *)</span>

<span class="c">(*</span>
<span class="c">   OK, OCaml just doesn&#39;t work with arrays the same way tha Perl does.  In</span>
<span class="c">   Ocaml, Arrays are immutable in their shape, while containing mutable</span>
<span class="c">   contents.  You can simulate this example as shown below (which only works for</span>
<span class="c">   string arrays), or you can get resizeable arrays from a library such as</span>
<span class="c">   extlib &lt;http://ocaml-lib.sourceforge.net/&gt;</span>
<span class="c">*)</span>

<span class="k">let</span> <span class="n">what_about_that_array</span> <span class="n">a</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">len</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">a</span> <span class="k">in</span>
  <span class="n">printf</span> <span class="s2">&quot;The array now has %d elements.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">len</span><span class="o">;</span>
  <span class="n">printf</span> <span class="s2">&quot;The index of the last element is %d.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="k">if</span> <span class="n">len</span><span class="o">=</span><span class="mi">0</span> <span class="k">then</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">len</span><span class="o">-</span><span class="mi">1</span><span class="o">);</span>
  <span class="n">printf</span> <span class="s2">&quot;Element 3 is </span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">a</span><span class="o">.(</span><span class="mi">3</span><span class="o">);;</span>

<span class="k">let</span> <span class="n">resizeArray</span> <span class="n">a</span> <span class="n">s</span> <span class="o">=</span>
  <span class="c">(* begin stupid hack to work like the Perl example *)</span>
  <span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">in</span>
  <span class="c">(* end stupid hack to work like the Perl example *)</span>
  <span class="k">assert</span> <span class="o">(</span><span class="n">s</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">);</span>
  <span class="k">let</span> <span class="n">len</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">a</span> <span class="k">in</span>
  <span class="k">if</span> <span class="n">s</span> <span class="o">=</span> <span class="n">len</span> <span class="k">then</span> <span class="n">a</span> <span class="k">else</span>
    <span class="k">if</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="k">then</span>
      <span class="nn">Array</span><span class="p">.</span><span class="n">sub</span> <span class="n">a</span> <span class="mi">0</span> <span class="n">s</span>
    <span class="k">else</span>
      <span class="nn">Array</span><span class="p">.</span><span class="n">append</span> <span class="n">a</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">make</span> <span class="o">(</span><span class="n">s</span> <span class="o">-</span> <span class="n">len</span><span class="o">)</span> <span class="s2">&quot;&quot;</span><span class="o">);;</span>

<span class="k">let</span> <span class="n">people</span> <span class="o">=</span> <span class="o">[|</span><span class="s2">&quot;Crosby&quot;</span><span class="o">;</span> <span class="s2">&quot;Stills&quot;</span><span class="o">;</span> <span class="s2">&quot;Nash&quot;</span><span class="o">;</span> <span class="s2">&quot;Young&quot;</span><span class="o">|];;</span>
<span class="n">what_about_that_array</span> <span class="n">people</span><span class="o">;;</span>

<span class="c">(*</span>
<span class="c">The array now has 4 elements.</span>
<span class="c">The index of the last element is 3.</span>
<span class="c">Element 3 is &quot;Young&quot;.</span>
<span class="c">*)</span>

<span class="k">let</span> <span class="n">people</span> <span class="o">=</span> <span class="n">resizeArray</span> <span class="n">people</span> <span class="mi">2</span><span class="o">;;</span>
<span class="n">what_about_that_array</span> <span class="n">people</span><span class="o">;;</span>

<span class="c">(*</span>
<span class="c">The array now has 3 elements.</span>
<span class="c">The index of the last element is 2.</span>
<span class="c">Exception: Invalid_argument &quot;index out of bounds&quot;.</span>
<span class="c">*)</span>

<span class="k">let</span> <span class="n">people</span> <span class="o">=</span> <span class="n">resizeArray</span> <span class="n">people</span> <span class="mi">10000</span><span class="o">;;</span>
<span class="n">what_about_that_array</span> <span class="n">people</span><span class="o">;;</span>
<span class="c">(*</span>
<span class="c">The array now has 10001 elements.</span>
<span class="c">The index of the last element is 10000.</span>
<span class="c">Element 3 is &quot;&quot;.</span>
<span class="c">*)</span>

<span class="c">(* @@PLEAC@@_4.4 *)</span>

<span class="nn">Array</span><span class="p">.</span><span class="n">iter</span> <span class="n">complain</span> <span class="n">bad_users</span><span class="o">;;</span>
<span class="c">(* Or for lists *)</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="n">complain</span> <span class="n">bad_users</span><span class="o">;;</span>

<span class="c">(* For the hashtable example, we&#39;d iterate over the table itself *)</span>

<span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">k</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">printf</span> <span class="s2">&quot;%s=%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">k</span> <span class="n">v</span><span class="o">)</span> <span class="n">h</span><span class="o">;;</span>

<span class="c">(* Of course if you want to iterate over the keys in lexicographic order, then</span>
<span class="c"> * you&#39;ll need to build a list of keys, sort it, then iterate over that *)</span>

<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">printf</span> <span class="s2">&quot;%s=%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">x</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">env</span> <span class="n">x</span><span class="o">))</span>
  <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">sort</span> <span class="n">compare</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">fold</span> <span class="o">(</span><span class="k">fun</span> <span class="n">k</span> <span class="n">v</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">k</span><span class="o">::</span><span class="n">b</span><span class="o">)</span> <span class="n">env</span> <span class="bp">[]</span><span class="o">));;</span>

<span class="nn">Array</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">get_usage</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">max_quota</span> <span class="k">then</span> <span class="n">complain</span> <span class="n">x</span><span class="o">)</span> <span class="n">all_users</span><span class="o">;;</span>
<span class="c">(* or for lists of users *)</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">get_usage</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="n">max_quota</span> <span class="k">then</span> <span class="n">complain</span> <span class="n">x</span><span class="o">)</span> <span class="n">all_users</span><span class="o">;;</span>

<span class="c">(* for this example, we&#39;re going to assume that the output of the who command is</span>
<span class="c"> * contained in the list named who, with one line of output per list element.</span>
<span class="c"> * This example requires the use of the Str module which is not loaded or linked</span>
<span class="c"> * by default (but is part of the standard library), at the toplevel, use the</span>
<span class="c"> * directive &quot;#load &quot;str.cma&quot;</span>
<span class="c">*)</span>

<span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span>
    <span class="k">try</span>
      <span class="n">ignore</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">quote</span> <span class="s2">&quot;tchrist&quot;</span><span class="o">)</span> <span class="n">x</span> <span class="mi">0</span><span class="o">);</span>
      <span class="n">print_endline</span> <span class="n">x</span><span class="o">;</span>
    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">)</span> <span class="n">who</span><span class="o">;;</span>

<span class="c">(* To iterate over all lines read in from some channel we would do the following *)</span>

<span class="k">let</span> <span class="n">iter_channel</span> <span class="n">f</span> <span class="n">ic</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="n">f</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">ic</span><span class="o">)</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">;;</span>

<span class="c">(* and the example would then be written as *)</span>
<span class="n">iter_channel</span>
  <span class="o">(</span><span class="k">fun</span>  <span class="n">s</span> <span class="o">-&gt;</span>
    <span class="k">let</span> <span class="n">reverse</span> <span class="n">s</span> <span class="o">=</span><span class="k">&#39;let</span> <span class="n">len</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">s&#39;</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">create</span> <span class="n">len</span> <span class="k">in</span>
      <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">to</span> <span class="n">len</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">do</span>
        <span class="n">s&#39;</span><span class="o">.[</span><span class="n">len</span><span class="o">-</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="o">]</span> <span class="o">&lt;-</span> <span class="n">s</span><span class="o">.[</span><span class="n">i</span><span class="o">]</span>
      <span class="k">done</span><span class="o">;</span>
      <span class="n">s&#39;</span> <span class="k">in</span>
    <span class="c">(* assuming we have written a chomp workalike *)</span>
    <span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="n">chomp</span> <span class="n">s</span> <span class="k">in</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
      <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">print_endline</span> <span class="o">(</span><span class="n">reverse</span> <span class="n">x</span><span class="o">))</span>
      <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">split</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[ </span><span class="se">\t</span><span class="s2">]+&quot;</span><span class="o">)</span> <span class="n">s</span><span class="o">))</span> <span class="n">fh</span><span class="o">;;</span>

<span class="c">(* In OCaml the iterator variable also is an alias for the current element,</span>
<span class="c"> * however, because of the functional nature of OCaml, unless the elements of</span>
<span class="c"> * the array are references, the only way to change them is by resetting the</span>
<span class="c"> * value of the array to something new -- this is best done using iteri *)</span>

<span class="k">let</span> <span class="n">a</span> <span class="o">=</span> <span class="o">[|</span><span class="mi">1</span><span class="o">;</span> <span class="mi">2</span><span class="o">;</span> <span class="mi">3</span><span class="o">|];;</span>
<span class="nn">Array</span><span class="p">.</span><span class="n">iteri</span> <span class="o">(</span><span class="k">fun</span> <span class="n">i</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.(</span><span class="n">i</span><span class="o">)</span> <span class="o">&lt;-</span> <span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="o">)</span> <span class="n">a</span><span class="o">;;</span>

<span class="c">(* or, with references *)</span>

<span class="k">let</span> <span class="n">a</span> <span class="o">=</span> <span class="o">[|</span> <span class="n">ref</span> <span class="mi">1</span><span class="o">;</span> <span class="n">ref</span> <span class="mi">2</span><span class="o">;</span> <span class="n">ref</span> <span class="mi">3</span> <span class="o">|];;</span>
<span class="nn">Array</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span> <span class="o">:=</span> <span class="o">!</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="n">a</span><span class="o">;;</span>

<span class="c">(* You can, of course, use map to create a new array with the desired contents</span>
<span class="c"> * as well *)</span>
<span class="k">let</span> <span class="n">a</span> <span class="o">=</span> <span class="o">[|</span> <span class="mi">0</span><span class="o">.</span><span class="mi">5</span><span class="o">;</span> <span class="mi">3</span><span class="o">.|];;</span>
<span class="k">let</span> <span class="n">b</span> <span class="o">=</span> <span class="o">[|</span><span class="mi">0</span><span class="o">.;</span> <span class="mi">1</span><span class="o">.|];;</span>
<span class="nn">Array</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="n">printf</span> <span class="s2">&quot;%f &quot;</span><span class="o">)</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">map</span> <span class="o">((</span> <span class="o">*.</span> <span class="o">)</span> <span class="mi">7</span><span class="o">.)</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">append</span> <span class="n">a</span> <span class="n">b</span><span class="o">));;</span>


<span class="k">let</span> <span class="n">strip</span> <span class="n">s</span> <span class="o">=</span>
  <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;^[ </span><span class="se">\t\n</span><span class="s2">]&quot;</span><span class="o">)</span> <span class="s2">&quot;&quot;</span>
    <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[ </span><span class="se">\t\n</span><span class="s2">$]&quot;</span><span class="o">)</span> <span class="s2">&quot;&quot;</span> <span class="n">s</span><span class="o">);;</span>


<span class="k">let</span> <span class="n">sc</span><span class="o">,</span><span class="n">ar</span><span class="o">,</span><span class="n">h</span> <span class="o">=</span>
  <span class="n">strip</span> <span class="n">sc</span><span class="o">,</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">map</span> <span class="n">strip</span> <span class="n">ar</span><span class="o">,</span>
  <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">k</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">h</span> <span class="n">k</span> <span class="o">(</span><span class="n">strip</span> <span class="n">v</span><span class="o">))</span> <span class="n">h</span><span class="o">;</span> <span class="n">h</span><span class="o">);;</span>

<span class="c">(* of course, the Hashtbl.replace already destructively updates the old</span>
<span class="c"> * hashtable... *)</span>

<span class="c">(* @@PLEAC@@_4.5 *)</span>

<span class="c">(* iterate over elements of array in arrayref *)</span>

<span class="nn">Array</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="c">(* do something with x *)</span><span class="o">)</span> <span class="o">!</span><span class="n">arrayref</span><span class="o">;;</span>

<span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">to</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="o">!</span><span class="n">arrayref</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">do</span>
  <span class="c">(* do something with !arrayref.(i) *)</span>
<span class="k">done</span>

<span class="k">let</span> <span class="n">fruits</span> <span class="o">=</span> <span class="o">[|</span> <span class="s2">&quot;Apple&quot;</span><span class="o">;</span> <span class="s2">&quot;Blackberry&quot;</span> <span class="o">|];;</span>
<span class="k">let</span> <span class="n">fruit_ref</span> <span class="o">=</span> <span class="n">ref</span> <span class="n">fruits</span><span class="o">;;</span>
<span class="nn">Array</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="n">printf</span> <span class="s2">&quot;%s tastes good in a pie.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span> <span class="o">!</span><span class="n">fruit_ref</span><span class="o">;;</span>

<span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">to</span>  <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="o">!</span><span class="n">fruit_ref</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">do</span>
  <span class="n">printf</span> <span class="s2">&quot;%s tastes good in a pie.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">!</span><span class="n">fruit_ref</span><span class="o">.(</span><span class="n">i</span><span class="o">)</span>
<span class="k">done</span><span class="o">;;</span>

<span class="nn">Hashtbl</span><span class="p">.</span><span class="n">add</span> <span class="n">namelist</span> <span class="s2">&quot;felines&quot;</span> <span class="o">(</span><span class="n">ref</span> <span class="n">rogue_cats</span><span class="o">);;</span>
<span class="nn">Array</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="n">printf</span> <span class="s2">&quot;%s purrs hypnotically.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span> <span class="o">!(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">namelist</span>
<span class="s2">&quot;felines&quot;</span><span class="o">);;</span>
<span class="n">print_endline</span> <span class="s2">&quot;--More--</span><span class="se">\n</span><span class="s2">You are controlled.&quot;</span><span class="o">;;</span>

<span class="k">for</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span> <span class="k">to</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="o">!(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">namelist</span> <span class="s2">&quot;felines&quot;</span><span class="o">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">do</span>
  <span class="n">printf</span> <span class="s2">&quot;%s purrs hypnotically.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">!(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">namelist</span> <span class="s2">&quot;felines&quot;</span><span class="o">).(</span><span class="n">i</span><span class="o">)</span>
<span class="k">done</span><span class="o">;;</span>

<span class="c">(* @@PLEAC@@_4.6 *)</span>

<span class="c">(* For lists, the most &quot;natural&quot; way to do this is by walking the list and</span>
<span class="c"> * looking for duplicates of each item *)</span>

<span class="k">let</span> <span class="k">rec</span> <span class="n">uniquesOnly</span> <span class="n">l</span> <span class="o">=</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">contains</span> <span class="n">x</span> <span class="n">l</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">l</span> <span class="k">with</span>
      <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="bp">false</span>
    <span class="o">|</span> <span class="n">h</span><span class="o">::</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">x</span> <span class="o">=</span> <span class="n">h</span> <span class="k">then</span> <span class="bp">true</span> <span class="k">else</span> <span class="n">contains</span> <span class="n">x</span> <span class="n">t</span> <span class="k">in</span>
  <span class="k">match</span> <span class="n">l</span> <span class="k">with</span>
    <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="bp">[]</span>
  <span class="o">|</span> <span class="n">h</span><span class="o">::</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">contains</span> <span class="n">h</span> <span class="n">t</span> <span class="k">then</span> <span class="n">uniquesOnly</span> <span class="n">t</span> <span class="k">else</span> <span class="n">h</span><span class="o">::(</span><span class="n">uniquesOnly</span> <span class="n">t</span><span class="o">);;</span>

<span class="c">(* if you have a lot of duplicates, it might be better to use List.filter *)</span>
<span class="k">let</span> <span class="k">rec</span> <span class="n">uniquesOnly</span> <span class="n">l</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">l</span> <span class="k">with</span>
    <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="bp">[]</span>
  <span class="o">|</span> <span class="n">h</span><span class="o">::</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="n">h</span><span class="o">::(</span><span class="n">uniquesOnly</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">filter</span> <span class="o">((&lt;&gt;)</span> <span class="n">h</span><span class="o">)</span> <span class="n">t</span><span class="o">));;</span>

<span class="c">(* Or, for lists or arrays, you can use a hashtable *)</span>
<span class="c">(* Straightforward *)</span>
<span class="k">let</span> <span class="n">uniquesOnly</span> <span class="n">l</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">seen</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">17</span>
  <span class="ow">and</span> <span class="n">uniq</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span>
      <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">mem</span> <span class="n">seen</span> <span class="n">x</span><span class="o">)</span> <span class="k">then</span>
        <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">add</span> <span class="n">seen</span> <span class="n">x</span> <span class="mi">1</span><span class="o">;</span> <span class="n">uniq</span> <span class="o">:=</span> <span class="o">(</span><span class="n">x</span><span class="o">::!</span><span class="n">uniq</span><span class="o">)))</span>
    <span class="n">l</span><span class="o">;</span>
  <span class="o">!</span><span class="n">uniq</span><span class="o">;;</span>

<span class="c">(* Or more likely *)</span>
<span class="k">let</span> <span class="n">uniquesOnly</span> <span class="n">l</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">seen</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">17</span> <span class="k">in</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">seen</span> <span class="n">x</span> <span class="mi">1</span><span class="o">)</span> <span class="n">l</span><span class="o">;</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">fold</span> <span class="o">(</span><span class="k">fun</span> <span class="n">k</span> <span class="n">v</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">k</span><span class="o">::</span><span class="n">b</span><span class="o">)</span> <span class="n">seen</span> <span class="bp">[]</span><span class="o">;;</span>

<span class="c">(* To apply a user function to each unique element of a list, one would likely</span>
<span class="c"> * do something like *)</span>

<span class="k">let</span> <span class="n">userUnique</span> <span class="n">f</span> <span class="n">l</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">f</span> <span class="o">(</span><span class="n">uniquesOnly</span> <span class="n">l</span><span class="o">);;</span>

<span class="c">(* Generate a list of users logged in, removing duplicates.  Note that this</span>
<span class="c"> * example requires linking with the Unix and Str libraries. *)</span>
<span class="k">let</span> <span class="n">who</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">w</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_in</span> <span class="s2">&quot;who&quot;</span>
  <span class="ow">and</span> <span class="n">l</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="n">l</span> <span class="o">:=</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">w</span><span class="o">)::!</span><span class="n">l</span>
	<span class="k">done</span><span class="o">;</span>
	<span class="o">!</span><span class="n">l</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="o">!</span><span class="n">l</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">ucnt</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">17</span><span class="o">;;</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span>
    <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">ucnt</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[ </span><span class="se">\t</span><span class="s2">].*$&quot;</span><span class="o">)</span> <span class="s2">&quot;&quot;</span> <span class="n">x</span><span class="o">)</span> <span class="mi">1</span><span class="o">)</span>
  <span class="o">(</span><span class="n">who</span> <span class="bp">()</span><span class="o">);;</span>
<span class="k">let</span> <span class="n">users</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">fold</span> <span class="o">(</span><span class="k">fun</span> <span class="n">k</span> <span class="n">v</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">k</span><span class="o">::</span><span class="n">b</span><span class="o">)</span> <span class="n">ucnt</span> <span class="bp">[]</span><span class="o">;;</span>

<span class="n">printf</span> <span class="s2">&quot;users logged in: %s&quot;</span><span class="o">;;</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="n">printf</span> <span class="s2">&quot;%s &quot;</span><span class="o">)</span> <span class="n">users</span><span class="o">;;</span>

<span class="c">(* @@PLEAC@@_4.7 *)</span>

<span class="c">(* using hashtables, like the cookbook *)</span>
<span class="k">let</span> <span class="n">arrayDiff</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">seen</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">17</span>
  <span class="ow">and</span> <span class="n">l</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">add</span> <span class="n">seen</span> <span class="n">x</span> <span class="mi">1</span><span class="o">)</span> <span class="n">b</span><span class="o">;</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">mem</span> <span class="n">seen</span> <span class="n">x</span><span class="o">)</span> <span class="k">then</span> <span class="n">l</span> <span class="o">:=</span> <span class="n">x</span><span class="o">::!</span><span class="n">l</span><span class="o">)</span> <span class="n">a</span><span class="o">;</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">of_list</span> <span class="o">!</span><span class="n">l</span><span class="o">;;</span>


<span class="c">(* @@PLEAC@@_4.8 *)</span>

<span class="k">let</span> <span class="n">a</span> <span class="o">=</span> <span class="o">[</span> <span class="mi">1</span><span class="o">;</span><span class="mi">3</span><span class="o">;</span><span class="mi">5</span><span class="o">;</span><span class="mi">6</span><span class="o">;</span><span class="mi">7</span><span class="o">;</span><span class="mi">8</span> <span class="o">];;</span>
<span class="k">let</span> <span class="n">b</span> <span class="o">=</span> <span class="o">[</span> <span class="mi">2</span><span class="o">;</span><span class="mi">3</span><span class="o">;</span><span class="mi">5</span><span class="o">;</span><span class="mi">7</span><span class="o">;</span><span class="mi">9</span> <span class="o">];;</span>

<span class="k">let</span> <span class="n">union</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">13</span>
<span class="ow">and</span> <span class="n">isect</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">13</span>
<span class="ow">and</span> <span class="n">diff</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">13</span><span class="o">;;</span>

<span class="c">(* simple solution for union and intersection *)</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">add</span> <span class="n">union</span> <span class="n">x</span> <span class="mi">1</span><span class="o">)</span> <span class="n">a</span><span class="o">;;</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">hashtbl</span><span class="o">.</span><span class="n">add</span> <span class="o">(</span><span class="k">if</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">mem</span> <span class="n">union</span> <span class="n">x</span> <span class="k">then</span> <span class="n">isect</span> <span class="k">else</span> <span class="n">union</span><span class="o">)</span> <span class="n">x</span> <span class="mi">1</span><span class="o">)</span> <span class="n">b</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">u</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">fold</span> <span class="o">(</span><span class="k">fun</span> <span class="n">k</span> <span class="n">v</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">k</span><span class="o">::</span><span class="n">b</span><span class="o">)</span> <span class="n">union</span> <span class="bp">[]</span>
<span class="ow">and</span> <span class="n">i</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">fold</span> <span class="o">(</span><span class="k">fun</span> <span class="n">k</span> <span class="n">v</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">k</span><span class="o">::</span><span class="n">b</span><span class="o">)</span> <span class="n">isect</span> <span class="bp">[]</span><span class="o">;;</span>

<span class="c">(* Union, intersection, and symmetric difference *)</span>
<span class="k">let</span> <span class="n">hincr</span> <span class="n">h</span> <span class="n">x</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">v</span> <span class="o">=</span> <span class="k">try</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">h</span> <span class="n">x</span> <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">h</span> <span class="n">x</span> <span class="o">(</span><span class="n">v</span><span class="o">+</span><span class="mi">1</span><span class="o">);;</span>

<span class="k">let</span> <span class="n">count</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">13</span><span class="o">;;</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">add</span> <span class="n">count</span> <span class="n">x</span> <span class="mi">1</span><span class="o">)</span> <span class="n">a</span><span class="o">;;</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="n">hincr</span> <span class="n">count</span><span class="o">)</span> <span class="n">b</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">u</span><span class="o">,</span><span class="n">i</span><span class="o">,</span><span class="n">d</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">u</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">fold</span> <span class="o">(</span><span class="k">fun</span> <span class="n">k</span> <span class="n">v</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">k</span><span class="o">,</span><span class="n">v</span><span class="o">)::</span><span class="n">b</span><span class="o">)</span> <span class="n">count</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">i</span><span class="o">,</span><span class="n">d</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">partition</span><span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">snd</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">2</span><span class="o">)</span> <span class="n">u</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">vo</span> <span class="n">l</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">fst</span> <span class="n">l</span> <span class="k">in</span>
  <span class="o">(</span><span class="n">vo</span> <span class="n">u</span><span class="o">),(</span><span class="n">vo</span> <span class="n">i</span><span class="o">),(</span><span class="n">vo</span> <span class="n">d</span><span class="o">);;</span>


<span class="c">(* @@PLEAC@@_4.9 *)</span>

<span class="c">(* For lists, use the @ operator for two lists, or List.concat for a list of</span>
<span class="c"> * lists, for arrays, use Array.append for two arrays, or Array.concat for a</span>
<span class="c"> * list of arrays*)</span>

<span class="k">let</span> <span class="n">list1</span> <span class="o">=</span> <span class="n">list1</span> <span class="o">@</span> <span class="n">list2</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">array1</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">append</span> <span class="n">array1</span> <span class="n">array2</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">members</span> <span class="o">=</span> <span class="o">[|</span> <span class="s2">&quot;Time&quot;</span><span class="o">;</span> <span class="s2">&quot;Flies&quot;</span> <span class="o">|];;</span>
<span class="k">let</span> <span class="n">initiates</span> <span class="o">=</span> <span class="o">[|</span> <span class="s2">&quot;An&quot;</span><span class="o">;</span> <span class="s2">&quot;Arrow&quot;</span> <span class="o">|];;</span>
<span class="k">let</span> <span class="n">members</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">append</span> <span class="n">members</span> <span class="n">initiates</span><span class="o">;;</span>

<span class="c">(* It is easiest to write a splice workalike and then just use the new function</span>
<span class="c"> * much like in Perl *)</span>

<span class="k">let</span> <span class="n">splice</span> <span class="o">?</span><span class="n">length</span> <span class="o">?</span><span class="kt">list</span> <span class="n">arr</span> <span class="n">off</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">len</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">arr</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">off</span> <span class="o">=</span> <span class="k">if</span> <span class="n">off</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="n">len</span> <span class="o">+</span> <span class="n">off</span> <span class="k">else</span> <span class="n">off</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">l</span><span class="o">,</span><span class="n">back</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">length</span> <span class="k">with</span>
      <span class="nc">None</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">len</span> <span class="o">-</span> <span class="n">off</span><span class="o">),[||]</span>
    <span class="o">|</span> <span class="nc">Some</span> <span class="n">l</span> <span class="o">-&gt;</span>
        <span class="n">l</span><span class="o">,</span>
        <span class="o">(</span><span class="k">let</span> <span class="n">boff</span> <span class="o">=</span> <span class="n">off</span> <span class="o">+</span> <span class="n">l</span> <span class="k">in</span>
        <span class="k">try</span> <span class="nn">Array</span><span class="p">.</span><span class="n">sub</span> <span class="n">arr</span> <span class="n">boff</span> <span class="o">(</span><span class="n">len</span> <span class="o">-</span> <span class="n">boff</span><span class="o">)</span>  <span class="k">with</span> <span class="nc">Invalid_argument</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="o">[||])</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">front</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">sub</span> <span class="n">arr</span> <span class="mi">0</span> <span class="n">off</span>
  <span class="ow">and</span> <span class="n">mid</span> <span class="o">=</span>
    <span class="k">match</span> <span class="kt">list</span> <span class="k">with</span>
      <span class="nc">None</span> <span class="o">-&gt;</span> <span class="o">[||]</span>
    <span class="o">|</span> <span class="nc">Some</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">a</span>
  <span class="ow">and</span> <span class="n">sp</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">sub</span> <span class="n">arr</span> <span class="n">off</span> <span class="n">l</span> <span class="k">in</span>
  <span class="n">sp</span><span class="o">,</span><span class="nn">Array</span><span class="p">.</span><span class="n">concat</span> <span class="o">[</span><span class="n">front</span><span class="o">;</span><span class="n">mid</span><span class="o">;</span><span class="n">back</span><span class="o">];;</span>

<span class="k">let</span> <span class="o">_,</span><span class="n">members</span> <span class="o">=</span>
  <span class="n">splice</span> <span class="n">members</span> <span class="mi">2</span> <span class="o">~</span><span class="n">length</span><span class="o">:</span><span class="mi">0</span> <span class="o">~</span><span class="kt">list</span><span class="o">:(</span><span class="nn">Array</span><span class="p">.</span><span class="n">append</span> <span class="o">[|</span><span class="s2">&quot;Like&quot;</span><span class="o">|]</span> <span class="n">initiates</span><span class="o">);;</span>
<span class="nn">Array</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="n">printf</span> <span class="s2">&quot;%s &quot;</span><span class="o">)</span> <span class="n">members</span><span class="o">;</span> <span class="n">print_newline</span> <span class="bp">()</span><span class="o">;;</span>

<span class="k">let</span> <span class="o">_,</span><span class="n">members</span> <span class="o">=</span> <span class="n">splice</span> <span class="n">members</span> <span class="mi">0</span> <span class="o">~</span><span class="n">length</span><span class="o">:</span><span class="mi">1</span> <span class="o">~</span><span class="kt">list</span><span class="o">:[|</span><span class="s2">&quot;Fruit&quot;</span><span class="o">|];;</span>
<span class="k">let</span> <span class="o">_,</span><span class="n">members</span> <span class="o">=</span> <span class="n">splice</span> <span class="n">members</span> <span class="o">(-</span><span class="mi">2</span><span class="o">)</span> <span class="o">~</span><span class="n">length</span><span class="o">:</span><span class="mi">2</span> <span class="o">~</span><span class="kt">list</span><span class="o">:[|</span><span class="s2">&quot;A&quot;</span><span class="o">;</span> <span class="s2">&quot;Banana&quot;</span><span class="o">|];;</span>
<span class="nn">Array</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="n">printf</span> <span class="s2">&quot;%s &quot;</span><span class="o">)</span> <span class="n">members</span><span class="o">;</span> <span class="n">print_newline</span> <span class="bp">()</span><span class="o">;;</span>

<span class="c">(* @@PLEAC@@_4.10 *)</span>

<span class="c">(* To reverse a list, use List.rev *)</span>
<span class="k">let</span> <span class="n">reversed</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="n">l</span><span class="o">;;</span>

<span class="c">(* For an array, it is probably easiest to use Array.init *)</span>

<span class="k">let</span> <span class="n">revArray</span> <span class="n">a</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">len</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">a</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">in</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">init</span> <span class="n">len</span><span class="o">+</span><span class="mi">1</span> <span class="o">(</span><span class="k">fun</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.(</span><span class="n">len</span> <span class="o">-</span> <span class="n">i</span><span class="o">);;</span>

<span class="k">let</span> <span class="n">reversed</span> <span class="o">=</span> <span class="n">revArray</span> <span class="n">a</span><span class="o">;;</span>

<span class="c">(* Or one can use a for loop *)</span>
<span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">a</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">downto</span> <span class="mi">0</span> <span class="k">do</span>
  <span class="c">(* Do something to a.(i) *)</span>
<span class="k">done</span><span class="o">;;</span>

<span class="c">(* @@PLEAC@@_4.11 *)</span>

<span class="c">(* To remove multiple elements from an array at once, one can use the splice</span>
<span class="c"> * function from section 4.9 *)</span>

<span class="c">(* Remove n elements from the front of arr *)</span>
<span class="n">front</span><span class="o">,</span><span class="n">arr</span> <span class="o">=</span> <span class="n">splice</span> <span class="n">arr</span> <span class="mi">0</span> <span class="o">~</span><span class="n">length</span><span class="o">:</span><span class="n">n</span><span class="o">;;</span>
<span class="n">rear</span><span class="o">,</span><span class="n">arr</span> <span class="o">=</span> <span class="n">splice</span> <span class="n">arr</span> <span class="o">(-</span><span class="n">n</span><span class="o">);;</span>

<span class="c">(* this can also be wrapped as an explicit function *)</span>

<span class="k">let</span> <span class="n">shift2</span> <span class="n">a</span> <span class="o">=</span> <span class="n">splice</span> <span class="n">a</span> <span class="mi">0</span> <span class="o">~</span><span class="n">length</span><span class="o">:</span><span class="mi">2</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">pop2</span> <span class="n">a</span> <span class="o">=</span> <span class="n">splice</span> <span class="n">a</span> <span class="o">(-</span><span class="mi">2</span><span class="o">);;</span>

<span class="c">(* This lets you do something like Perl&#39;s hinkey pattern matching *)</span>
<span class="k">let</span> <span class="n">friends</span> <span class="o">=</span> <span class="o">[|</span><span class="s2">&quot;Peter&quot;</span><span class="o">;</span> <span class="s2">&quot;Paul&quot;</span><span class="o">;</span> <span class="s2">&quot;Mary&quot;</span><span class="o">;</span> <span class="s2">&quot;Jim&quot;</span><span class="o">;</span> <span class="s2">&quot;Tim&quot;</span> <span class="o">|];;</span>
<span class="k">let</span> <span class="o">[|</span><span class="n">this</span><span class="o">;</span> <span class="n">that</span><span class="o">|],</span><span class="n">friends</span> <span class="o">=</span> <span class="n">shift2</span> <span class="n">friends</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">beverages</span> <span class="o">=</span> <span class="o">[|</span><span class="s2">&quot;Dew&quot;</span><span class="o">;</span> <span class="s2">&quot;Jolt&quot;</span><span class="o">;</span> <span class="s2">&quot;Cola&quot;</span><span class="o">;</span> <span class="s2">&quot;Sprite&quot;</span><span class="o">;</span> <span class="s2">&quot;Fresca&quot;</span><span class="o">|];;;</span>
<span class="k">let</span> <span class="n">pair</span><span class="o">,</span><span class="n">beverages</span> <span class="o">=</span>  <span class="n">pop2</span> <span class="n">beverages</span><span class="o">;;</span>

<span class="c">(* @@PLEAC@@_4.12 *)</span>

<span class="c">(* To find the first element in a list that satisfies some predicate, just use</span>
<span class="c"> * the List.find function to return an &#39;a option *)</span>

<span class="k">match</span>
  <span class="o">(</span><span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">find</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="o">)</span> <span class="n">l</span><span class="o">)</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="nc">None</span><span class="o">)</span>
<span class="k">with</span>
    <span class="nc">None</span> <span class="o">-&gt;</span> <span class="c">(* unfound *)</span>
  <span class="o">|</span> <span class="nc">Some</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="c">(* Do something with x *)</span><span class="o">;;</span>

<span class="c">(* Note that this is a very general form, and can be shortened in some cases *)</span>
<span class="k">let</span> <span class="n">pf</span> <span class="n">l</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="n">printf</span> <span class="s2">&quot;hah! Found %d!</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">find</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="o">)</span> <span class="n">l</span><span class="o">)</span>
  <span class="k">with</span>
    <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="s2">&quot;Sorry charly!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;;</span>

<span class="c">(*</span>
<span class="c"># pf [1;2;3;4;5;6];;</span>
<span class="c">Sorry charly!</span>

<span class="c"># pf [1;2;3;50;100];;</span>
<span class="c">Hah!  Found 50!</span>
<span class="c">*)</span>

<span class="c">(* To return the index of a matching element in an array, we can use exceptions</span>
<span class="c"> * to short circuit the search *)</span>

<span class="k">exception</span> <span class="nc">Found</span> <span class="k">of</span> <span class="kt">int</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">findi</span> <span class="n">pred</span> <span class="n">arr</span> <span class="o">=</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">iteri</span> <span class="o">(</span><span class="k">fun</span> <span class="n">i</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">pred</span> <span class="n">x</span> <span class="k">then</span> <span class="k">raise</span> <span class="o">(</span><span class="nc">Found</span> <span class="n">i</span><span class="o">))</span> <span class="n">arr</span><span class="o">;</span>
  <span class="k">raise</span> <span class="nc">Not_found</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">f</span> <span class="n">arr</span> <span class="o">=</span>
<span class="k">try</span>
  <span class="n">findi</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="o">)</span> <span class="n">arr</span>
<span class="k">with</span>
  <span class="nc">Found</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">printf</span> <span class="s2">&quot;element %d is a big element - %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">i</span> <span class="n">arr</span><span class="o">.(</span><span class="n">i</span><span class="o">)</span>
<span class="o">|</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="n">printf</span> <span class="s2">&quot;Only small values here!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;;</span>

<span class="c">(*</span>
<span class="c"># f [|1; 2; 3; 4; 5; 6|];;</span>
<span class="c">Only small values here!</span>

<span class="c"># f [|1; 2; 3; 4; 5; 60; 8; 9; 100|];;</span>
<span class="c">element 5 is a big element - 60</span>
<span class="c">*)</span>

<span class="k">let</span> <span class="n">highest_engineer</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">find</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">#</span><span class="n">category</span> <span class="o">=</span> <span class="s2">&quot;engineer&quot;</span><span class="o">)</span> <span class="n">employees</span> <span class="k">in</span>
  <span class="n">printf</span> <span class="s2">&quot;Highest paid engineer is: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">highest_engineer</span><span class="o">#</span><span class="n">name</span><span class="o">;;</span>


<span class="c">(* @@PLEAC@@_4.13 *)</span>

<span class="c">(* to find all elements of a list that satisfy a certain predicate, just use the</span>
<span class="c"> * List.find_all function *)</span>

<span class="k">let</span> <span class="n">matching</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">find_all</span> <span class="o">(</span> <span class="c">(* predicate *)</span> <span class="n">l</span><span class="o">;;</span>

<span class="c">(* for an array, it&#39;s likely easiest to convert the original array to a list,</span>
<span class="c"> * use List.find_all, and convert that list into an array *)</span>
<span class="k">let</span> <span class="n">matching</span> <span class="o">=</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">ofList</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">find_all</span> <span class="o">(</span> <span class="c">(*predicate *)</span> <span class="o">)</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="n">a</span><span class="o">));;</span>

<span class="c">(* the next example requires use of the Str library, which must be linked in.</span>
<span class="c"> * In the toplevel environment use `#load &quot;str.cma&quot;&#39; *)</span>

<span class="k">let</span> <span class="n">bigs</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">find_all</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">1000000</span><span class="o">)</span> <span class="n">nums</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">pigs</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">find_all</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">users</span> <span class="n">x</span><span class="o">)</span> <span class="o">&gt;</span> <span class="mf">1e7</span><span class="o">)</span>
            <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">fold</span> <span class="o">(</span><span class="k">fun</span> <span class="n">k</span> <span class="n">v</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">k</span><span class="o">::</span><span class="n">b</span><span class="o">)</span> <span class="n">users</span> <span class="bp">[]</span><span class="o">);;</span>

<span class="k">let</span> <span class="n">matching</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">find_all</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;gnat&quot;</span><span class="o">)</span> <span class="n">x</span> <span class="mi">0</span><span class="o">)</span> <span class="o">(</span><span class="n">who</span> <span class="bp">()</span><span class="o">);;</span>

<span class="k">let</span> <span class="n">engineers</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">find_all</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">#</span><span class="n">position</span> <span class="o">=</span> <span class="s2">&quot;Engineer&quot;</span><span class="o">)</span> <span class="n">employees</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">secondary_assistance</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">find_all</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">#</span><span class="n">income</span> <span class="o">&gt;=</span> <span class="mi">26000</span> <span class="o">&amp;&amp;</span> <span class="n">x</span><span class="o">#</span><span class="n">income</span> <span class="o">&lt;</span> <span class="mi">30000</span><span class="o">)</span> <span class="n">applicants</span><span class="o">;;</span>

<span class="c">(* @@PLEAC@@_4.14 *)</span>

<span class="c">(* OCaml is smart enough to figure out if a list is full of numbers or</span>
<span class="c"> * non-numbers, so the polymorphic compare function works just fine *)</span>
<span class="k">let</span> <span class="n">sorted</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">sort</span> <span class="n">compare</span> <span class="n">unsorted</span><span class="o">;;</span>

<span class="c">(* note that Array.sort sorts the given array in place, so unexpected results</span>
<span class="c"> * can occur, e.g.</span>
<span class="c">let sorted = Array.sort compare unsorted;;</span>

<span class="c"> * results in unsorted referring to the now sorted array, and sorted referring</span>
<span class="c"> * to something of type unit *)</span>

<span class="c">(* pids is an unsorted list of process IDs *)</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="n">printf</span> <span class="s2">&quot;%d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">sort</span> <span class="n">compare</span> <span class="n">pids</span><span class="o">);;</span>
<span class="n">print_endline</span> <span class="s2">&quot;Select a process ID to kill:&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">read_int</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">kill</span> <span class="n">pid</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigterm</span><span class="o">;</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">sleep</span> <span class="mi">2</span><span class="o">;</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">kill</span> <span class="n">pid</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigterm</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">descending</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">sort</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="n">y</span> <span class="o">-&gt;</span> <span class="n">compare</span> <span class="n">y</span> <span class="n">x</span><span class="o">)</span> <span class="n">unsorted</span><span class="o">;;</span>

<span class="c">(* @@PLEAC@@_4.15 *)</span>
<span class="c">(* since compare orders tuples by first comparing the first slot then, if they</span>
<span class="c"> * were equal, comparing the second slot, and so on, we can sort by computable</span>
<span class="c"> * fields as follows *)</span>

<span class="k">let</span> <span class="n">sorted</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">snd</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">sort</span> <span class="n">compare</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span><span class="o">-&gt;</span> <span class="o">(</span><span class="n">compute</span> <span class="n">x</span><span class="o">),</span><span class="n">x</span><span class="o">)</span> <span class="n">unsorted</span><span class="o">));;</span>

<span class="k">let</span> <span class="n">ordered</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">sort</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="n">y</span> <span class="o">-&gt;</span> <span class="n">compare</span> <span class="n">x</span><span class="o">#</span><span class="n">name</span> <span class="n">y</span><span class="o">#</span><span class="n">name</span><span class="o">)</span> <span class="n">employees</span><span class="o">;;</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">printf</span> <span class="s2">&quot;%s earns $%2f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">x</span><span class="o">#</span><span class="n">name</span> <span class="n">x</span><span class="o">#</span><span class="n">salary</span><span class="o">)</span>
  <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">sort</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="n">y</span> <span class="o">-&gt;</span> <span class="n">compare</span> <span class="n">x</span><span class="o">#</span><span class="n">name</span> <span class="n">y</span><span class="o">#</span><span class="n">name</span><span class="o">)</span> <span class="n">employees</span><span class="o">);;</span>

<span class="k">let</span> <span class="n">sorted_employees</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">snd</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">sort</span> <span class="n">compare</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span><span class="o">-&gt;</span> <span class="o">(</span><span class="n">compute</span> <span class="n">x</span><span class="o">),</span><span class="n">x</span><span class="o">)</span> <span class="n">unsorted</span><span class="o">))</span> <span class="k">in</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">printf</span> <span class="s2">&quot;%s earns $%2f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">x</span><span class="o">#</span><span class="n">name</span> <span class="n">x</span><span class="o">#</span><span class="n">salary</span><span class="o">)</span> <span class="n">sorted_employees</span><span class="o">;</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">mem</span> <span class="n">bonus</span> <span class="n">x</span><span class="o">#</span><span class="n">ssn</span> <span class="k">then</span> <span class="n">printf</span> <span class="s2">&quot;%s got a bonus!</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">x</span><span class="o">#</span><span class="n">name</span><span class="o">)</span>
    <span class="n">sorted_employees</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">sorted</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">sort</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="n">y</span> <span class="o">-&gt;</span>
      <span class="k">match</span> <span class="n">compare</span> <span class="n">x</span><span class="o">#</span><span class="n">name</span> <span class="n">y</span><span class="o">#</span><span class="n">name</span> <span class="k">with</span>
        <span class="mi">0</span> <span class="o">-&gt;</span> <span class="n">compare</span> <span class="n">x</span><span class="o">#</span><span class="n">age</span> <span class="n">y</span><span class="o">#</span><span class="n">age</span>
      <span class="o">|</span> <span class="n">c</span> <span class="o">-&gt;</span> <span class="n">c</span><span class="o">)</span>
    <span class="n">employees</span><span class="o">;;</span>

<span class="c">(* Assuming we have a getpwent function that returns a value of type users, or</span>
<span class="c"> * throws an End_of_file exception when done (not sure what getpwent is supposed</span>
<span class="c"> * to do), then we can write *)</span>

<span class="k">let</span> <span class="n">getUsers</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">l</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="n">l</span> <span class="o">:=</span> <span class="o">(</span><span class="n">getpwent</span> <span class="bp">()</span><span class="o">)::!</span><span class="n">l</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="o">!</span><span class="n">l</span><span class="o">;;</span>

<span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">print_endline</span> <span class="n">x</span><span class="o">#</span><span class="n">name</span><span class="o">)</span>
  <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">sort</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="n">y</span> <span class="o">-&gt;</span> <span class="n">compare</span> <span class="n">x</span><span class="o">#</span><span class="n">name</span> <span class="n">y</span><span class="o">#</span><span class="n">name</span><span class="o">)</span> <span class="o">(</span><span class="n">getUsers</span> <span class="bp">()</span><span class="o">));;</span>

<span class="k">let</span> <span class="n">sorted</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">sort</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="n">y</span> <span class="o">-&gt;</span> <span class="n">compare</span> <span class="n">x</span><span class="o">.[</span><span class="mi">1</span><span class="o">]</span> <span class="n">y</span><span class="o">.[</span><span class="mi">1</span><span class="o">])</span> <span class="n">strings</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">sorted</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">snd</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">sort</span> <span class="n">compare</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">x</span><span class="o">),</span><span class="n">x</span><span class="o">)</span> <span class="n">strings</span><span class="o">));;</span>

<span class="k">let</span> <span class="n">sorted_fields</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">snd</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">sort</span> <span class="n">compare</span>
      <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span>
        <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span>
          <span class="o">(</span><span class="k">try</span>
            <span class="n">ignore</span><span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[0-9]+&quot;</span><span class="o">)</span> <span class="n">x</span> <span class="mi">0</span><span class="o">);</span>
            <span class="n">int_of_string</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">matched_string</span> <span class="n">x</span><span class="o">)</span>
          <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="n">max_int</span><span class="o">),</span><span class="n">x</span><span class="o">)</span>
        <span class="n">strings</span><span class="o">));;</span>

<span class="k">let</span> <span class="n">passwd</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">w</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_in</span> <span class="s2">&quot;cat /etc/passwd&quot;</span>
  <span class="ow">and</span> <span class="n">l</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="n">l</span> <span class="o">:=</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">w</span><span class="o">)::!</span><span class="n">l</span>
	<span class="k">done</span><span class="o">;</span>
	<span class="o">!</span><span class="n">l</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="o">!</span><span class="n">l</span><span class="o">;;</span>

<span class="c">(* for illustration purposes, we provide a function to return the (non-comment)</span>
<span class="c"> * contents of /etc/passwd *)</span>
<span class="k">let</span> <span class="n">passwd</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">w</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_in</span> <span class="s2">&quot;cat /etc/passwd&quot;</span>
  <span class="ow">and</span> <span class="n">l</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="n">l</span> <span class="o">:=</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">w</span><span class="o">)::!</span><span class="n">l</span>
	<span class="k">done</span><span class="o">;</span>
	<span class="o">!</span><span class="n">l</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">filter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">.[</span><span class="mi">0</span><span class="o">]</span> <span class="o">&lt;&gt;</span> <span class="sc">&#39;#&#39;</span><span class="o">)</span> <span class="o">!</span><span class="n">l</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">sortedPasswd</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="nc">Some</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">snd</span> <span class="n">x</span><span class="o">)</span>
  <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">sort</span> <span class="n">compare</span>
   <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">filter</span> <span class="o">(</span><span class="k">function</span> <span class="nc">Some</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="bp">true</span> <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="bp">false</span><span class="o">)</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span>
      <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span>
        <span class="k">match</span> <span class="nn">Str</span><span class="p">.</span><span class="n">split</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;:&quot;</span><span class="o">)</span> <span class="n">x</span> <span class="k">with</span>
          <span class="n">name</span><span class="o">::_::</span><span class="n">uid</span><span class="o">::</span><span class="n">gid</span><span class="o">::</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="nc">Some</span> <span class="o">((</span><span class="n">gid</span><span class="o">,</span><span class="n">uid</span><span class="o">,</span><span class="n">name</span><span class="o">),</span><span class="n">x</span><span class="o">)</span>
        <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nc">None</span><span class="o">)</span>
     <span class="o">(</span><span class="n">passwd</span> <span class="bp">()</span><span class="o">))));;</span>

<span class="c">(* @@PLEAC@@_4.16 *)</span>

<span class="c">(* To get a true circular list, one can use the let rec construct *)</span>

<span class="k">let</span> <span class="k">rec</span> <span class="n">processes</span> <span class="o">=</span> <span class="mi">1</span><span class="o">::</span><span class="mi">2</span><span class="o">::</span><span class="mi">3</span><span class="o">::</span><span class="mi">4</span><span class="o">::</span><span class="mi">5</span><span class="o">::</span><span class="n">processes</span><span class="o">;;</span>
<span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
  <span class="k">let</span> <span class="n">process</span><span class="o">::</span><span class="n">processes</span> <span class="o">=</span> <span class="n">process</span> <span class="k">in</span>
  <span class="n">printf</span> <span class="s2">&quot;Handling process %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">process</span><span class="o">;</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">sleep</span> <span class="mi">2</span><span class="o">;</span>
<span class="k">done</span><span class="o">;;</span>

<span class="c">(* or one can use these somewhat inefficient functions to simulate the Perl</span>
<span class="c"> * examples *)</span>

<span class="k">let</span> <span class="n">popleft</span> <span class="n">l</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">l</span> <span class="k">with</span>
    <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="k">raise</span> <span class="nc">Not_found</span>
  <span class="o">|</span> <span class="n">h</span><span class="o">::</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="n">h</span><span class="o">,(</span><span class="n">t</span> <span class="o">@</span> <span class="o">[</span><span class="n">h</span><span class="o">]);;</span>

<span class="k">let</span> <span class="n">popright</span> <span class="n">l</span> <span class="o">=</span>
  <span class="k">match</span> <span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="n">l</span> <span class="k">with</span>
    <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="k">raise</span> <span class="nc">Not_found</span>
  <span class="o">|</span> <span class="n">h</span><span class="o">::</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="n">h</span><span class="o">,(</span><span class="n">h</span><span class="o">::(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="n">t</span><span class="o">));;</span>

<span class="k">let</span> <span class="n">processes</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">[</span><span class="mi">1</span><span class="o">;</span><span class="mi">2</span><span class="o">;</span><span class="mi">3</span><span class="o">;</span><span class="mi">4</span><span class="o">;</span><span class="mi">5</span><span class="o">];;</span>
<span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
  <span class="k">let</span> <span class="n">process</span><span class="o">,</span><span class="n">np</span> <span class="o">=</span> <span class="n">popleft</span> <span class="o">!</span><span class="n">processes</span> <span class="k">in</span>
  <span class="n">processes</span> <span class="o">:=</span> <span class="n">np</span><span class="o">;</span>
  <span class="n">printf</span> <span class="s2">&quot;Handling process %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">process</span><span class="o">;</span>
  <span class="n">flush_all</span> <span class="bp">()</span><span class="o">;</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">sleep</span> <span class="mi">1</span><span class="o">;</span>
<span class="k">done</span><span class="o">;;</span>

<span class="c">(* @@PLEAC@@_4.17 *)</span>

<span class="k">let</span> <span class="n">fisher_yates_shuffle</span> <span class="n">a</span> <span class="o">=</span>
  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">a</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">downto</span> <span class="mi">1</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">a</span><span class="o">.(</span><span class="n">i</span><span class="o">)</span>
    <span class="ow">and</span> <span class="n">r</span> <span class="o">=</span> <span class="nn">Random</span><span class="p">.</span><span class="n">int</span> <span class="o">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">)</span> <span class="k">in</span>
    <span class="n">a</span><span class="o">.(</span><span class="n">i</span><span class="o">)</span> <span class="o">&lt;-</span> <span class="n">a</span><span class="o">.(</span><span class="n">r</span><span class="o">);</span>
    <span class="n">a</span><span class="o">.(</span><span class="n">r</span><span class="o">)</span> <span class="o">&lt;-</span> <span class="n">x</span><span class="o">;</span>
  <span class="k">done</span><span class="o">;;</span>

<span class="c">(* @@PLEAC@@_4.18 *)</span>

<span class="c">(* Assuming we start with a list of all the data called data, and assuming we</span>
<span class="c"> * already have the curent number of screen columns in a variable cols *)</span>

<span class="k">let</span> <span class="n">words</span> <span class="n">data</span> <span class="n">cols</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">strippedData</span> <span class="o">=</span>
    <span class="nn">Array</span><span class="p">.</span><span class="n">of_list</span>
      <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[ </span><span class="se">\t\n</span><span class="s2">]+$&quot;</span><span class="o">)</span> <span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="n">data</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">maxlen</span> <span class="o">=</span>
    <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">fold_left</span> <span class="o">(</span><span class="k">fun</span> <span class="n">m</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">max</span> <span class="n">m</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span><span class="o">))</span> <span class="mi">0</span> <span class="n">strippedData</span><span class="o">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">cols</span> <span class="o">=</span> <span class="k">if</span> <span class="n">cols</span> <span class="o">&lt;</span> <span class="n">maxlen</span> <span class="k">then</span> <span class="mi">1</span> <span class="k">else</span> <span class="n">cols</span> <span class="o">/</span> <span class="n">maxlen</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">rows</span> <span class="o">=</span> <span class="o">((</span><span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">strippedData</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">+</span> <span class="n">cols</span><span class="o">)/</span><span class="n">cols</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">bufs</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">init</span> <span class="n">rows</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">create</span> <span class="o">(</span><span class="n">cols</span> <span class="o">*</span> <span class="n">maxlen</span><span class="o">))</span> <span class="k">in</span>
  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">to</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">strippedData</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">dst</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="n">maxlen</span> <span class="sc">&#39; &#39;</span>
    <span class="ow">and</span> <span class="n">src</span> <span class="o">=</span> <span class="n">strippedData</span><span class="o">.(</span><span class="n">i</span><span class="o">)</span> <span class="k">in</span>
    <span class="nn">String</span><span class="p">.</span><span class="n">blit</span> <span class="n">src</span> <span class="mi">0</span> <span class="n">dst</span> <span class="mi">0</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">src</span><span class="o">);</span>
    <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_string</span> <span class="n">bufs</span><span class="o">.(</span><span class="n">i</span> <span class="ow">mod</span> <span class="n">rows</span><span class="o">)</span> <span class="n">dst</span>
  <span class="k">done</span><span class="o">;</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">print_endline</span> <span class="o">(</span><span class="nn">Buffer</span><span class="p">.</span><span class="n">contents</span> <span class="n">x</span><span class="o">))</span> <span class="n">bufs</span><span class="o">;;</span>

<span class="c">(* @@PLEAC@@_4.19 *)</span>

<span class="c">(* Note: This routine uses the splice routine written in section 4.9 *)</span>

<span class="k">let</span> <span class="n">tsc_permute</span> <span class="n">arr</span> <span class="o">=</span>
  <span class="k">if</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">arr</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="n">print_endline</span> <span class="s2">&quot;Perms:&quot;</span><span class="o">;</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">permute</span> <span class="n">arr</span> <span class="n">perms</span> <span class="o">=</span>
    <span class="k">match</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">arr</span> <span class="k">with</span>
      <span class="mi">0</span> <span class="o">-&gt;</span> <span class="nn">Array</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="n">printf</span> <span class="s2">&quot;%s &quot;</span><span class="o">)</span> <span class="n">perms</span><span class="o">;</span> <span class="n">print_newline</span> <span class="bp">()</span><span class="o">;</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span>
        <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">to</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">arr</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">do</span>
          <span class="k">let</span> <span class="n">v</span><span class="o">,</span><span class="n">ni</span> <span class="o">=</span> <span class="n">splice</span> <span class="n">arr</span> <span class="n">i</span> <span class="o">~</span><span class="n">length</span><span class="o">:</span><span class="mi">1</span> <span class="k">in</span>
          <span class="n">permute</span> <span class="n">ni</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">append</span> <span class="n">v</span> <span class="n">perms</span><span class="o">);</span>
        <span class="k">done</span> <span class="k">in</span>
  <span class="n">permute</span> <span class="n">arr</span> <span class="o">[||];;</span>

<span class="c">(* Note: This example is going to permute the words of a given string - also, I</span>
<span class="c"> * don&#39;t feel like bringing in the BigInt module, so we will trim any array</span>
<span class="c"> * longer than 12 elements down to 12 before permuting *)</span>

<span class="k">let</span> <span class="n">fact</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">append</span> <span class="o">[|</span><span class="nc">Some</span> <span class="mi">1</span><span class="o">|]</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">make</span> <span class="mi">11</span> <span class="nc">None</span><span class="o">);;</span>
<span class="k">let</span> <span class="k">rec</span> <span class="n">factorial</span> <span class="n">n</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">fact</span><span class="o">.(</span><span class="n">n</span><span class="o">)</span> <span class="k">with</span>
    <span class="nc">Some</span> <span class="n">f</span> <span class="o">-&gt;</span> <span class="n">f</span>
  <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="k">let</span> <span class="n">f</span> <span class="o">=</span> <span class="n">n</span><span class="o">*(</span><span class="n">factorial</span> <span class="o">(</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="o">))</span> <span class="k">in</span> <span class="n">fact</span><span class="o">.(</span><span class="n">n</span><span class="o">)</span> <span class="o">&lt;-</span> <span class="nc">Some</span> <span class="n">f</span><span class="o">;</span> <span class="n">f</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">n2pat</span> <span class="n">n</span> <span class="n">len</span> <span class="o">=</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">nh</span> <span class="n">n</span> <span class="n">i</span> <span class="n">pat</span> <span class="o">=</span>
    <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">len</span><span class="o">+</span><span class="mi">1</span> <span class="k">then</span> <span class="n">pat</span>
    <span class="k">else</span>
      <span class="n">nh</span> <span class="o">(</span><span class="n">n</span><span class="o">/</span><span class="n">i</span><span class="o">)</span> <span class="o">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="o">)</span> <span class="o">((</span><span class="n">n</span> <span class="ow">mod</span> <span class="n">i</span><span class="o">)::</span><span class="n">pat</span><span class="o">)</span> <span class="k">in</span>
  <span class="n">nh</span> <span class="n">n</span> <span class="mi">1</span> <span class="bp">[]</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">pat2perm</span> <span class="n">pat</span> <span class="o">=</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">ph</span> <span class="n">source</span> <span class="n">pat</span> <span class="n">perm</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">pat</span> <span class="k">with</span>
      <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="n">perm</span>
    <span class="o">|</span> <span class="n">h</span><span class="o">::</span><span class="n">t</span> <span class="o">-&gt;</span>
        <span class="k">let</span> <span class="n">v</span><span class="o">,</span><span class="n">s</span> <span class="o">=</span> <span class="n">splice</span> <span class="n">source</span> <span class="n">h</span> <span class="o">~</span><span class="n">length</span><span class="o">:</span><span class="mi">1</span> <span class="k">in</span>
        <span class="n">ph</span> <span class="n">s</span> <span class="n">t</span> <span class="o">(</span><span class="n">v</span><span class="o">.(</span><span class="mi">0</span><span class="o">)::</span><span class="n">perm</span><span class="o">)</span> <span class="k">in</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">of_list</span> <span class="o">(</span><span class="n">ph</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">init</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">length</span> <span class="n">pat</span><span class="o">)</span> <span class="o">(</span><span class="k">fun</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">i</span><span class="o">))</span> <span class="n">pat</span> <span class="bp">[]</span><span class="o">);;</span>

<span class="k">let</span> <span class="n">n2perm</span> <span class="n">n</span> <span class="n">len</span> <span class="o">=</span>
  <span class="n">pat2perm</span> <span class="o">(</span><span class="n">n2pat</span> <span class="n">n</span> <span class="n">len</span><span class="o">);;</span>

<span class="k">let</span> <span class="n">mjd_permute</span> <span class="n">s</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">arr</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">arr</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">of_list</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">split</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[ </span><span class="se">\t</span><span class="s2">]+&quot;</span><span class="o">)</span> <span class="n">s</span><span class="o">)</span> <span class="k">in</span>
    <span class="k">try</span>
      <span class="nn">Array</span><span class="p">.</span><span class="n">sub</span> <span class="n">arr</span> <span class="mi">0</span> <span class="mi">12</span>
    <span class="k">with</span> <span class="nc">Invalid_argument</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">arr</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">len</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">arr</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">in</span>
  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">to</span> <span class="n">factorial</span> <span class="o">(</span><span class="n">len</span><span class="o">+</span><span class="mi">1</span><span class="o">)</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">perm</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">arr</span><span class="o">.(</span><span class="n">i</span><span class="o">))</span> <span class="o">(</span><span class="n">n2perm</span> <span class="n">i</span> <span class="n">len</span><span class="o">)</span> <span class="k">in</span>
    <span class="nn">Array</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="n">printf</span> <span class="s2">&quot;%s &quot;</span><span class="o">)</span> <span class="n">perm</span><span class="o">;</span> <span class="n">print_newline</span> <span class="bp">()</span><span class="o">;</span>
  <span class="k">done</span><span class="o">;;</span>


<span class="c">(* @@PLEAC@@_5.0 *)</span>
<span class="c">(*-----------------------------*)</span>
<span class="c">(* build an hash table element by element *)</span>
<span class="k">let</span> <span class="n">age</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">3</span> <span class="o">;;</span>  <span class="c">(* 3 is the supposed average size for the</span>
<span class="c">                                  hash table *)</span>
<span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">age</span> <span class="s2">&quot;Nat&quot;</span> <span class="mi">24</span> <span class="o">;</span>
<span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">age</span> <span class="s2">&quot;Jules&quot;</span> <span class="mi">25</span> <span class="o">;</span>
<span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">age</span> <span class="s2">&quot;Josh&quot;</span> <span class="mi">17</span> <span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="n">assoc_list2hashtbl</span> <span class="n">assoc_list</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">h</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">k</span><span class="o">,</span><span class="n">v</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">h</span> <span class="n">k</span> <span class="n">v</span><span class="o">)</span> <span class="n">assoc_list</span> <span class="o">;</span>
  <span class="n">h</span>

<span class="k">let</span> <span class="n">food_color</span> <span class="o">=</span> <span class="n">assoc_list2hashtbl</span>
    <span class="o">[</span> <span class="s2">&quot;Apple&quot;</span><span class="o">,</span> <span class="s2">&quot;red&quot;</span> <span class="o">;</span>
      <span class="s2">&quot;Banana&quot;</span><span class="o">,</span> <span class="s2">&quot;yellow&quot;</span> <span class="o">;</span>
      <span class="s2">&quot;Lemon&quot;</span><span class="o">,</span> <span class="s2">&quot;yellow&quot;</span> <span class="o">;</span>
      <span class="s2">&quot;Carrot&quot;</span><span class="o">,</span> <span class="s2">&quot;orange&quot;</span> <span class="o">;</span>
    <span class="o">]</span> <span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>

<span class="c">(* @@PLEAC@@_5.1 *)</span>
<span class="c">(*-----------------------------*)</span>
<span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">tbl</span> <span class="n">key</span> <span class="k">value</span> <span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="c">(* food_color defined per the introduction *)</span>
<span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">food_color</span> <span class="s2">&quot;Raspberry&quot;</span> <span class="s2">&quot;pink&quot;</span> <span class="o">;;</span>


<span class="k">let</span> <span class="n">hashtbl_keys</span> <span class="n">h</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">fold</span> <span class="o">(</span><span class="k">fun</span> <span class="n">key</span> <span class="o">_</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="n">key</span> <span class="o">::</span> <span class="n">l</span><span class="o">)</span> <span class="n">h</span> <span class="bp">[]</span>
<span class="k">let</span> <span class="n">hashtbl_values</span> <span class="n">h</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">fold</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="k">value</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="k">value</span> <span class="o">::</span> <span class="n">l</span><span class="o">)</span> <span class="n">h</span> <span class="bp">[]</span>
<span class="k">let</span> <span class="n">hashtbl2assoc_list</span> <span class="n">h</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">fold</span> <span class="o">(</span><span class="k">fun</span> <span class="n">key</span> <span class="k">value</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="k">value</span><span class="o">)</span> <span class="o">::</span> <span class="n">l</span><span class="o">)</span> <span class="n">h</span> <span class="bp">[]</span>
<span class="o">;;</span>
<span class="n">print_string</span> <span class="s2">&quot;Known_foods:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">;</span>
<span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">food</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">print_endline</span> <span class="n">food</span><span class="o">)</span> <span class="n">food_color</span> <span class="o">;</span>
<span class="n">print_string</span> <span class="s2">&quot;Known_foods:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">;</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="n">print_endline</span> <span class="o">(</span><span class="n">hashtbl_keys</span> <span class="n">food_color</span><span class="o">)</span> <span class="o">;;</span>
<span class="c">(*</span>
<span class="c">&gt; Known_foods:</span>
<span class="c">&gt; Banana</span>
<span class="c">&gt; Raspberry</span>
<span class="c">&gt; Apple</span>
<span class="c">&gt; Carrot</span>
<span class="c">&gt; Lemon</span>
<span class="c">*)</span>
<span class="c">(*-----------------------------*)</span>

<span class="c">(* @@PLEAC@@_5.2 *)</span>
<span class="c">(*-----------------------------*)</span>
<span class="c">(* does %HASH have a value for $KEY ?  *)</span>
<span class="k">if</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">mem</span> <span class="n">hash</span> <span class="n">key</span><span class="o">)</span> <span class="k">then</span>
  <span class="c">(* it exists *)</span>
<span class="k">else</span>
  <span class="c">(* id doesn&#39;t exists *)</span>
 <span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="c">(* food_color defined per the introduction *)</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">name</span> <span class="o">-&gt;</span>
  <span class="k">let</span> <span class="n">kind</span> <span class="o">=</span> <span class="k">if</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">mem</span> <span class="n">food_color</span> <span class="n">name</span> <span class="k">then</span> <span class="s2">&quot;food&quot;</span> <span class="k">else</span> <span class="s2">&quot;drink&quot;</span> <span class="k">in</span>
  <span class="n">printf</span> <span class="s2">&quot;%s is a %s.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">name</span> <span class="n">kind</span>
<span class="o">)</span> <span class="o">[</span><span class="s2">&quot;Banana&quot;</span><span class="o">;</span> <span class="s2">&quot;Martini&quot;</span><span class="o">]</span> <span class="o">;;</span>
<span class="c">(*</span>
<span class="c">&gt; Banana is a food.</span>
<span class="c">&gt; Martini is a drink.</span>
<span class="c">*)</span>
<span class="c">(*-----------------------------*)</span>
<span class="c">(* there&#39;s no such thing called &quot;undef&quot;, &quot;nil&quot; or &quot;null&quot; in Caml</span>
<span class="c">   if you really want such a value, use type &quot;option&quot; as shown below *)</span>
<span class="k">let</span> <span class="n">age</span> <span class="o">=</span> <span class="n">assoc_list2hashtbl</span>
    <span class="o">[</span> <span class="s2">&quot;Toddler&quot;</span><span class="o">,</span> <span class="mi">3</span> <span class="o">;</span> <span class="s2">&quot;Unborn&quot;</span><span class="o">,</span> <span class="mi">0</span> <span class="o">]</span> <span class="o">;;</span>
<span class="c">(*&gt; val age : (string, int) Hashtbl.t = &lt;abstr&gt; *)</span>

<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">thing</span> <span class="o">-&gt;</span>
  <span class="n">printf</span> <span class="s2">&quot;%s: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">thing</span>
    <span class="o">(</span><span class="k">try</span> <span class="k">match</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">age</span> <span class="n">thing</span> <span class="k">with</span>
    <span class="o">|</span> <span class="mi">0</span> <span class="o">-&gt;</span> <span class="s2">&quot;Exists&quot;</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="s2">&quot;Exists NonNull&quot;</span>
    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="s2">&quot;&quot;</span><span class="o">)</span>
<span class="o">)</span> <span class="o">[</span><span class="s2">&quot;Toddler&quot;</span> <span class="o">;</span> <span class="s2">&quot;Unborn&quot;</span> <span class="o">;</span> <span class="s2">&quot;Phantasm&quot;</span> <span class="o">;</span> <span class="s2">&quot;Relic&quot;</span> <span class="o">]</span>

<span class="k">let</span> <span class="n">age</span> <span class="o">=</span> <span class="n">assoc_list2hashtbl</span>
    <span class="o">[</span> <span class="s2">&quot;Toddler&quot;</span><span class="o">,</span> <span class="nc">Some</span> <span class="mi">3</span> <span class="o">;</span> <span class="s2">&quot;Unborn&quot;</span><span class="o">,</span> <span class="nc">Some</span> <span class="mi">0</span> <span class="o">;</span> <span class="s2">&quot;Phantasm&quot;</span><span class="o">,</span> <span class="nc">None</span> <span class="o">]</span> <span class="o">;;</span>
<span class="c">(*&gt; val age : (string, int option) Hashtbl.t = &lt;abstr&gt; *)</span>

<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">thing</span> <span class="o">-&gt;</span>
  <span class="n">printf</span> <span class="s2">&quot;%s: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">thing</span>
    <span class="o">(</span><span class="k">try</span> <span class="k">match</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">age</span> <span class="n">thing</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="s2">&quot;Exists&quot;</span>
    <span class="o">|</span> <span class="nc">Some</span> <span class="mi">0</span> <span class="o">-&gt;</span> <span class="s2">&quot;Exists Defined&quot;</span>
    <span class="o">|</span> <span class="nc">Some</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="s2">&quot;Exists Defined NonNull&quot;</span>
    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="s2">&quot;&quot;</span><span class="o">)</span>
<span class="o">)</span> <span class="o">[</span><span class="s2">&quot;Toddler&quot;</span> <span class="o">;</span> <span class="s2">&quot;Unborn&quot;</span> <span class="o">;</span> <span class="s2">&quot;Phantasm&quot;</span> <span class="o">;</span> <span class="s2">&quot;Relic&quot;</span> <span class="o">]</span>
<span class="c">(*</span>
<span class="c">&gt; Toddler: Exists Defined NonNull</span>
<span class="c">&gt; Unborn: Exists Defined</span>
<span class="c">&gt; Phantasm: Exists</span>
<span class="c">&gt; Relic:</span>
<span class="c">*)</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="n">size</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">20</span> <span class="k">in</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">f</span> <span class="o">-&gt;</span>
  <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">mem</span> <span class="n">size</span> <span class="n">f</span><span class="o">)</span> <span class="k">then</span>
    <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">size</span> <span class="n">f</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">stat</span> <span class="n">f</span><span class="o">).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">st_size</span><span class="o">;</span>
<span class="o">)</span> <span class="o">(</span><span class="n">readlines</span> <span class="n">stdin</span><span class="o">);</span>
<span class="c">(*-----------------------------*)</span>
<span class="c">(* here is a more complete solution which does stat 2 times the same file (to</span>
<span class="c">be mimic perl&#39;s version) *)</span>
<span class="k">let</span> <span class="n">size</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">20</span> <span class="k">in</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">f</span> <span class="o">-&gt;</span>
  <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">mem</span> <span class="n">size</span> <span class="n">f</span><span class="o">)</span> <span class="k">then</span>
    <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">size</span> <span class="n">f</span> <span class="o">(</span><span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">stat</span> <span class="n">f</span><span class="o">).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">st_size</span> <span class="k">with</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nc">None</span><span class="o">)</span>
<span class="o">)</span> <span class="o">(</span><span class="n">readlines</span> <span class="n">stdin</span><span class="o">);</span>


<span class="c">(* @@PLEAC@@_5.3 *)</span>
<span class="c">(*-----------------------------*)</span>
<span class="c">(* remove $KEY and its value from %HASH *)</span>
<span class="nn">Hashtbl</span><span class="p">.</span><span class="n">remove</span> <span class="n">hash</span> <span class="n">key</span> <span class="o">;</span>
<span class="c">(*-----------------------------*)</span>
<span class="c">(* food_color as per Introduction *)</span>
<span class="k">open</span> <span class="nc">Printf</span>

<span class="k">let</span> <span class="n">print_foods</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">printf</span> <span class="s2">&quot;Keys: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot; &quot;</span> <span class="o">(</span><span class="n">hashtbl_keys</span> <span class="n">food_color</span><span class="o">))</span> <span class="o">;</span>
  <span class="n">printf</span> <span class="s2">&quot;Values: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot; &quot;</span> <span class="o">(</span><span class="n">hashtbl_values</span> <span class="n">food_color</span><span class="o">))</span>
<span class="o">;;</span>
<span class="n">print_string</span> <span class="s2">&quot;Initially:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
<span class="n">print_foods</span> <span class="bp">()</span><span class="o">;</span>

<span class="n">print_string</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">With Banana deleted</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
<span class="nn">Hashtbl</span><span class="p">.</span><span class="n">remove</span> <span class="n">food_color</span> <span class="s2">&quot;Banana&quot;</span><span class="o">;</span>
<span class="n">print_foods</span> <span class="bp">()</span>
<span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="nn">Hashtbl</span><span class="p">.</span><span class="n">clear</span> <span class="n">food_color</span> <span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>

<span class="c">(* @@PLEAC@@_5.4 *)</span>
<span class="c">(*-----------------------------*)</span>
<span class="c">(* in this section consider opened the Printf module using: *)</span>
<span class="k">open</span> <span class="nc">Printf</span><span class="o">;;</span>

<span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">key</span> <span class="k">value</span> <span class="o">-&gt;</span>
    <span class="c">(*</span>
<span class="c">      do something with key and value</span>
<span class="c">    *)</span>
  <span class="o">)</span>
  <span class="n">hash</span>
<span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">key</span> <span class="o">-&gt;</span>
  <span class="k">let</span> <span class="k">value</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">hash</span> <span class="n">key</span> <span class="k">in</span>
    <span class="c">(*</span>
<span class="c">      do something with key and value</span>
<span class="c">    *)</span>
<span class="o">)</span> <span class="o">(</span><span class="n">hashtbl_keys</span> <span class="n">hash</span><span class="o">)</span>
<span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="c">(* food_color as defined in the introduction *)</span>
<span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="n">printf</span> <span class="s2">&quot;%s is %s.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span> <span class="n">food_color</span><span class="o">;</span>
<span class="c">(*</span>
<span class="c">&gt; Lemon is yellow.</span>
<span class="c">&gt; Apple is red.</span>
<span class="c">&gt; Carrot is orange.</span>
<span class="c">&gt; Banana is yellow.</span>
<span class="c">*)</span>
<span class="c">(* but beware of: *)</span>
<span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="n">printf</span> <span class="s2">&quot;food_color: %s is %s.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span> <span class="n">food_color</span><span class="o">;</span>
<span class="c">(*</span>
<span class="c">&gt; food_color: Lemon is yellow.</span>
<span class="c">&gt; Apple is red.</span>
<span class="c">&gt; Carrot is orange.</span>
<span class="c">&gt; Banana is yellow.</span>
<span class="c">*)</span>
<span class="c">(* write this instead:</span>
<span class="c">  (more on it at http://caml.inria.fr/ocaml/htmlman/manual055.html) *)</span>
<span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">k</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">printf</span> <span class="s2">&quot;food_color: %s is %s.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">k</span> <span class="n">v</span><span class="o">)</span> <span class="n">food_color</span><span class="o">;</span>
<span class="c">(*</span>
<span class="c">&gt; food_color: Lemon is yellow.</span>
<span class="c">&gt; food_color: Apple is red.</span>
<span class="c">&gt; food_color: Carrot is orange.</span>
<span class="c">&gt; food_color: Banana is yellow.</span>
<span class="c">*)</span>

<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">key</span> <span class="o">-&gt;</span>
  <span class="k">let</span> <span class="k">value</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">food_color</span> <span class="n">key</span> <span class="k">in</span>
  <span class="n">printf</span> <span class="s2">&quot;%s is %s.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">key</span> <span class="k">value</span>
<span class="o">)</span> <span class="o">(</span><span class="n">hashtbl_keys</span> <span class="n">food_color</span><span class="o">)</span> <span class="o">;</span>
<span class="c">(*</span>
<span class="c">&gt; Lemon is yellow.</span>
<span class="c">&gt; Apple is red.</span>
<span class="c">&gt; Carrot is orange.</span>
<span class="c">&gt; Banana is yellow.</span>
<span class="c">*)</span>

<span class="c">(*-----------------------------*)</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">key</span> <span class="o">-&gt;</span>
    <span class="n">printf</span> <span class="s2">&quot;%s is %s.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">key</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">food_color</span> <span class="n">key</span><span class="o">)</span>
  <span class="o">)</span>
  <span class="o">(</span><span class="n">sort_</span> <span class="o">(</span><span class="n">hashtbl_keys</span> <span class="n">food_color</span><span class="o">))</span>
<span class="o">;;</span>

<span class="c">(*</span>
<span class="c">&gt; Apple is red.</span>
<span class="c">&gt; Banana is yellow.</span>
<span class="c">&gt; Carrot is orange.</span>
<span class="c">&gt; Lemon is yellow.</span>
<span class="c">*)</span>

<span class="c">(*-----------------------------*)</span>
<span class="c">(* Ocaml is safe in loop, so you can&#39;t reset the hash iterator as in</span>
<span class="c">Perl and you don&#39;t risk infinite loops using, say, List.iter or</span>
<span class="c">Hashtbl.iter, but if you really want to infinite loop on the first key</span>
<span class="c">you get ... *)</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">key</span> <span class="o">-&gt;</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="n">printf</span> <span class="s2">&quot;Processing %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">key</span>
    <span class="k">done</span>
  <span class="o">)</span>
  <span class="o">(</span><span class="n">hashtbl_keys</span> <span class="n">food_color</span><span class="o">)</span>
<span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="c">(* countfrom - count number of messages from each sender *)</span>
<span class="k">let</span> <span class="n">main</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">file</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">files</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
    <span class="nn">Arg</span><span class="p">.</span><span class="n">parse</span> <span class="bp">[]</span> <span class="o">(</span><span class="k">fun</span> <span class="n">file</span> <span class="o">-&gt;</span> <span class="n">files</span> <span class="o">:=</span> <span class="o">!</span><span class="n">files</span> <span class="o">@</span> <span class="o">[</span><span class="n">file</span><span class="o">])</span> <span class="s2">&quot;&quot;</span><span class="o">;</span>
    <span class="k">try</span>
      <span class="n">open_in</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">hd</span> <span class="o">!</span><span class="n">files</span><span class="o">)</span>
    <span class="k">with</span> <span class="nc">Failure</span> <span class="s2">&quot;hd&quot;</span> <span class="o">-&gt;</span> <span class="n">stdin</span>
  <span class="k">in</span>
  <span class="k">let</span> <span class="n">from</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">50</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">add_from</span> <span class="n">address</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">old_count</span> <span class="o">=</span>
      <span class="k">try</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">from</span> <span class="n">address</span>
      <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="mi">0</span>
    <span class="k">in</span>
    <span class="k">let</span> <span class="n">new_count</span> <span class="o">=</span> <span class="n">old_count</span> <span class="o">+</span> <span class="mi">1</span> <span class="k">in</span>
    <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">from</span> <span class="n">address</span> <span class="n">new_count</span><span class="o">;</span>
  <span class="k">in</span>
  <span class="k">let</span> <span class="n">extractfrom</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;^From: </span><span class="err">\</span><span class="s2">(.*</span><span class="err">\</span><span class="s2">)&quot;</span> <span class="k">in</span>

  <span class="n">iter_lines</span> <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span>
    <span class="k">if</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">extractfrom</span> <span class="n">line</span> <span class="mi">0</span><span class="o">)</span> <span class="k">then</span>
      <span class="n">add_from</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">1</span> <span class="n">line</span><span class="o">)</span>
    <span class="k">else</span> <span class="bp">()</span>
  <span class="o">)</span> <span class="n">file</span><span class="o">;</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="n">printf</span> <span class="s2">&quot;%s: %d</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span> <span class="n">from</span>
<span class="o">;;</span>
<span class="n">main</span><span class="bp">()</span> <span class="o">;</span>

<span class="c">(* @@PLEAC@@_5.5 *)</span>
<span class="c">(*-----------------------------*)</span>
<span class="c">(* note that OCaml does not have a native polymorphic print function, so</span>
<span class="c">examples in this section work for hashes that map string keys to string</span>
<span class="c">values *)</span>
<span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="n">printf</span> <span class="s2">&quot;%s =&gt; %s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span> <span class="n">hash</span> <span class="o">;</span>
<span class="c">(*-----------------------------*)</span>

<span class="c">(* map in ocaml maps a function on a list, rather that evaluate an</span>
<span class="c">expression in turn on a list as Perl does *)</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">key</span> <span class="o">-&gt;</span>
    <span class="n">printf</span> <span class="s2">&quot;%s =&gt; %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">key</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">hash</span> <span class="n">key</span><span class="o">)</span>
  <span class="o">)</span>
  <span class="o">(</span><span class="n">hashtbl_keys</span> <span class="n">hash</span><span class="o">)</span> <span class="o">;</span>
<span class="c">(*-----------------------------*)</span>

<span class="c">(* build a list from an hash table, note that this is possibile only if</span>
<span class="c">the type of key and value are the same *)</span>
<span class="k">let</span> <span class="n">hashtbl2list</span> <span class="n">hash</span> <span class="o">=</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">fold</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">key</span> <span class="k">value</span> <span class="n">init</span> <span class="o">-&gt;</span> <span class="n">key</span> <span class="o">::</span> <span class="k">value</span> <span class="o">::</span> <span class="n">init</span><span class="o">)</span>
    <span class="n">hash</span>
    <span class="bp">[]</span>
<span class="o">;;</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="n">printf</span> <span class="s2">&quot;%s &quot;</span><span class="o">)</span> <span class="o">(</span><span class="n">hashtbl2list</span> <span class="n">hash</span><span class="o">)</span> <span class="o">;</span>
<span class="c">(* or *)</span>
<span class="n">print_endline</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot; &quot;</span> <span class="o">(</span><span class="n">hashtbl2list</span> <span class="n">hash</span><span class="o">))</span> <span class="o">;</span>

<span class="c">(* @@PLEAC@@_5.6 *)</span>
<span class="c">(*-----------------------------*)</span>
<span class="c">(* In OCaml one usually use association lists which really is a list of</span>
<span class="c">(key,value). Note that insertion and lookup is O(n) (!!!) *)</span>

<span class="c">(* initialization *)</span>
<span class="k">let</span> <span class="n">empty_food_color</span> <span class="o">=</span> <span class="bp">[]</span>
<span class="k">let</span> <span class="n">food_color</span> <span class="o">=</span>
    <span class="o">[</span> <span class="s2">&quot;Banana&quot;</span><span class="o">,</span> <span class="s2">&quot;Yellow&quot;</span> <span class="o">;</span>
      <span class="s2">&quot;Apple&quot;</span><span class="o">,</span> <span class="s2">&quot;Green&quot;</span> <span class="o">;</span>
      <span class="s2">&quot;Lemon&quot;</span><span class="o">,</span> <span class="s2">&quot;Yellow&quot;</span> <span class="o">;</span>
    <span class="o">]</span>
<span class="c">(* adding *)</span>
<span class="k">let</span> <span class="n">food_color&#39;</span> <span class="o">=</span> <span class="n">food_color</span> <span class="o">@</span> <span class="o">[</span> <span class="s2">&quot;Carrot&quot;</span><span class="o">,</span> <span class="s2">&quot;orange&quot;</span> <span class="o">]</span>
<span class="o">;;</span>
<span class="c">(* output entries in insertion order *)</span>
<span class="n">print_endline</span> <span class="s2">&quot;In insertion order, the foods are:&quot;</span><span class="o">;</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="n">printf</span> <span class="s2">&quot;%s is colored %s.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span> <span class="n">food_color</span><span class="o">;</span>
<span class="c">(*</span>
<span class="c">&gt; Banana is colored Yellow.</span>
<span class="c">&gt; Apple is colored Green.</span>
<span class="c">&gt; Lemon is colored Yellow.</span>
<span class="c">*)</span>
<span class="c">(* is it a key? *)</span>
<span class="k">let</span> <span class="n">has_food</span> <span class="n">food</span> <span class="o">=</span> <span class="n">mem_assoc</span> <span class="n">food</span> <span class="n">food_color</span>
<span class="c">(* remove a key *)</span>
<span class="k">let</span> <span class="n">remove_food</span> <span class="n">food</span> <span class="o">=</span> <span class="n">remove_assoc</span> <span class="n">food</span> <span class="n">food_color</span>
<span class="c">(* searching *)</span>
<span class="k">let</span> <span class="n">what_color</span> <span class="n">food</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">let</span> <span class="n">color</span> <span class="o">=</span> <span class="n">assoc</span> <span class="n">food</span> <span class="n">food_color</span> <span class="k">in</span>
    <span class="n">printf</span> <span class="s2">&quot;%s is colored %s.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">food</span> <span class="n">color</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="n">printf</span> <span class="s2">&quot;i don&#39;t know the color of %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">food</span>
<span class="o">;;</span>
<span class="c">(* @@PLEAC@@_5.7 *)</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="n">re</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;^</span><span class="err">\</span><span class="s2">([^ ]*</span><span class="err">\</span><span class="s2">) *</span><span class="err">\</span><span class="s2">([^ ]*</span><span class="err">\</span><span class="s2">)&quot;</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">readlines</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_in</span> <span class="s2">&quot;who&quot;</span><span class="o">)</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">ttys</span> <span class="o">=</span> <span class="n">filter_some</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span>
  <span class="k">if</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">re</span> <span class="n">line</span> <span class="mi">0</span><span class="o">)</span> <span class="k">then</span>
    <span class="nc">Some</span><span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">1</span> <span class="n">line</span><span class="o">,</span> <span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">2</span> <span class="n">line</span><span class="o">)</span>
  <span class="k">else</span> <span class="nc">None</span><span class="o">)</span> <span class="n">lines</span><span class="o">)</span> <span class="k">in</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">user</span> <span class="o">-&gt;</span>
    <span class="n">printf</span> <span class="s2">&quot;%s: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">user</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot; &quot;</span> <span class="o">(</span><span class="n">all_assoc</span> <span class="n">user</span> <span class="n">ttys</span><span class="o">))</span>
  <span class="o">)</span> <span class="o">(</span><span class="n">sort_</span> <span class="o">(</span><span class="n">uniq</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">fst</span> <span class="n">ttys</span><span class="o">)))</span>
<span class="o">;</span>
<span class="c">(*-----------------------------*)</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">user</span> <span class="o">-&gt;</span>
    <span class="k">let</span> <span class="n">ttylist</span> <span class="o">=</span> <span class="n">all_assoc</span> <span class="n">user</span> <span class="n">ttys</span> <span class="k">in</span>
    <span class="n">printf</span> <span class="s2">&quot;%s: %d ttys.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">user</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">length</span> <span class="n">ttylist</span><span class="o">);</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
      <span class="o">(</span><span class="k">fun</span> <span class="n">tty</span> <span class="o">-&gt;</span>
        <span class="k">let</span> <span class="n">uname</span> <span class="o">=</span>
          <span class="k">try</span>
            <span class="k">let</span> <span class="n">uid</span> <span class="o">=</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">stat</span> <span class="o">(</span><span class="s2">&quot;/dev/&quot;</span> <span class="o">^</span> <span class="n">tty</span><span class="o">)).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">st_uid</span> <span class="k">in</span>
            <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">getpwuid</span> <span class="n">uid</span><span class="o">).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">pw_name</span>
          <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="s2">&quot;(not available)&quot;</span>
        <span class="k">in</span>
        <span class="n">printf</span> <span class="s2">&quot;%s (owned by %s)</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">tty</span> <span class="n">uname</span>
      <span class="o">)</span> <span class="n">ttylist</span>
  <span class="o">)</span> <span class="o">(</span><span class="n">sort_</span> <span class="o">(</span><span class="n">uniq</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">fst</span> <span class="n">ttys</span><span class="o">)))</span>
<span class="c">(*-----------------------------*)</span>
<span class="c">(* @@PLEAC@@_5.8 *)</span>
<span class="c">(*-----------------------------*)</span>

<span class="k">open</span> <span class="nc">Hashtbl</span>

<span class="c">(* size of an hash, i.e. number of bindings *)</span>
<span class="k">let</span> <span class="n">hashtbl_size</span> <span class="n">h</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">length</span> <span class="o">(</span><span class="n">hashtbl_keys</span> <span class="n">h</span><span class="o">);;</span>

<span class="c">(* in OCaml does not exists a builtin function like &quot;reverse&quot;, here is</span>
<span class="c">an equivalent one: *)</span>
<span class="k">let</span> <span class="n">hashtbl_reverse</span> <span class="n">h</span> <span class="o">=</span>
  <span class="n">assoc_list2hashtbl</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">combine</span> <span class="o">(</span><span class="n">hashtbl_values</span> <span class="n">h</span><span class="o">)</span> <span class="o">(</span><span class="n">hashtbl_keys</span> <span class="n">h</span><span class="o">))</span>
<span class="c">(* or *)</span>
<span class="k">let</span> <span class="n">hashtbl_reverse</span> <span class="n">h</span> <span class="o">=</span>
  <span class="n">assoc_list2hashtbl</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">a</span><span class="o">,</span><span class="n">b</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">b</span><span class="o">,</span><span class="n">a</span><span class="o">))</span> <span class="o">(</span><span class="n">hashtbl2assoc_list</span> <span class="n">h</span><span class="o">))</span>
<span class="o">;;</span>
<span class="c">(* or *)</span>
<span class="k">let</span> <span class="n">hashtbl_reverse_multi</span> <span class="n">h</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">newhash</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="o">(</span><span class="n">hashtbl_size</span> <span class="n">h</span><span class="o">)</span> <span class="k">in</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">add</span> <span class="n">newhash</span> <span class="o">(</span><span class="n">find</span> <span class="n">h</span> <span class="n">v</span><span class="o">)</span> <span class="n">v</span><span class="o">)</span>
    <span class="o">(</span><span class="n">hashtbl_keys</span> <span class="n">h</span><span class="o">);</span>
  <span class="n">newhash</span>
<span class="c">(* note that the last  implementation maintain also multiple binding for the</span>
<span class="c">same key, see Hashtbl.add in the standard OCaml library for more info *)</span>

<span class="c">(*-----------------------------*)</span>
<span class="c">(* example of hashtbl_reverse *)</span>

<span class="k">let</span> <span class="n">reverse</span> <span class="o">=</span> <span class="n">hashtbl_reverse</span> <span class="n">lookup</span><span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="n">surname</span> <span class="o">=</span> <span class="n">assoc_list2hashtbl</span> <span class="o">[</span><span class="s2">&quot;Mickey&quot;</span><span class="o">,</span> <span class="s2">&quot;Mantle&quot;</span><span class="o">;</span> <span class="s2">&quot;Babe&quot;</span><span class="o">,</span> <span class="s2">&quot;Ruth&quot;</span><span class="o">]</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">firstname</span> <span class="o">=</span> <span class="n">hashtbl_reverse</span> <span class="n">surname</span> <span class="k">in</span>
<span class="n">print_endline</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">firstname</span> <span class="s2">&quot;Mantle&quot;</span><span class="o">);;</span>
<span class="c">(*</span>
<span class="c">&gt; Mickey</span>
<span class="c">*)</span>

<span class="c">(*-----------------------------*)</span>
<span class="c">(* foodfind - find match for food or color *)</span>

<span class="k">let</span> <span class="n">given</span> <span class="o">=</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">color</span> <span class="o">=</span> <span class="n">assoc_list2hashtbl</span>
  <span class="o">[</span><span class="s2">&quot;Apple&quot;</span><span class="o">,</span> <span class="s2">&quot;red&quot;</span><span class="o">;</span>
   <span class="s2">&quot;Banana&quot;</span><span class="o">,</span> <span class="s2">&quot;yellow&quot;</span><span class="o">;</span>
   <span class="s2">&quot;Lemon&quot;</span><span class="o">,</span> <span class="s2">&quot;yellow&quot;</span><span class="o">;</span>
   <span class="s2">&quot;Carrot&quot;</span><span class="o">,</span> <span class="s2">&quot;orange&quot;</span><span class="o">]</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">food</span> <span class="o">=</span> <span class="n">hashtbl_reverse</span> <span class="n">color</span> <span class="k">in</span>
<span class="o">(</span><span class="k">try</span>
  <span class="n">printf</span> <span class="s2">&quot;%s is a food with color %s.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">given</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">color</span> <span class="n">given</span><span class="o">);</span>
<span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">);</span>
<span class="o">(</span><span class="k">try</span>
  <span class="n">printf</span> <span class="s2">&quot;%s is a food with color %s.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">food</span> <span class="n">given</span><span class="o">)</span> <span class="n">given</span>
<span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">)</span>
<span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="c">(* food_color defined as previous *)</span>

<span class="k">let</span> <span class="n">foods_with_color</span> <span class="o">=</span> <span class="n">hashtbl_reverse</span> <span class="n">food_color</span> <span class="k">in</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="n">printf</span> <span class="s2">&quot;%s &quot;</span><span class="o">)</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find_all</span> <span class="n">foods_with_color</span> <span class="s2">&quot;yellow&quot;</span><span class="o">);</span>
<span class="n">print_endline</span> <span class="s2">&quot;were yellow foods.&quot;</span>
<span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>

<span class="c">(* @@PLEAC@@_5.9 *)</span>
<span class="c">(*-----------------------------*)</span>

<span class="c">(* you may define your own compare function to be used in sorting *)</span>
<span class="k">let</span> <span class="n">keys</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">sort</span> <span class="n">compare_function</span> <span class="o">(</span><span class="n">hashtbl_keys</span> <span class="n">hash</span><span class="o">)</span> <span class="k">in</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">key</span> <span class="o">-&gt;</span>
    <span class="k">let</span> <span class="k">value</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">hash</span> <span class="n">key</span> <span class="k">in</span>
    <span class="c">(* do something with key and value *)</span>
    <span class="bp">()</span>
  <span class="o">)</span>
  <span class="n">keys</span> <span class="o">;</span>
<span class="c">(* or use this one if you want to compare not only on keys *)</span>
<span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span>
  <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="k">value</span><span class="o">)</span> <span class="o">-&gt;</span>
    <span class="c">(* do something with key and value *)</span>
    <span class="bp">()</span>
  <span class="o">)</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">sort</span> <span class="n">compare_function</span> <span class="o">(</span><span class="n">hashtbl2assoc_list</span> <span class="n">hash</span><span class="o">))</span> <span class="o">;</span>
<span class="c">(*-----------------------------*)</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">food</span> <span class="o">-&gt;</span>
    <span class="n">printf</span> <span class="s2">&quot;%s is %s.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">food</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">food_color</span> <span class="n">food</span><span class="o">)</span>
  <span class="o">)</span>
  <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">sort</span> <span class="o">(</span><span class="n">hashtbl_keys</span> <span class="n">food_color</span><span class="o">))</span>
<span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="c">(* examples of &quot;compare_function&quot;: *)</span>

<span class="c">(* alphabetical sort on the hash value *)</span>
<span class="k">let</span> <span class="n">compare_function</span> <span class="o">(_,</span><span class="n">color1</span><span class="o">)</span> <span class="o">(_,</span><span class="n">color2</span><span class="o">)</span> <span class="o">=</span> <span class="n">compare</span> <span class="n">color1</span> <span class="n">color2</span>

<span class="c">(* length sort on the hash value *)</span>
<span class="k">let</span> <span class="n">compare_function</span> <span class="o">(_,</span><span class="n">color1</span><span class="o">)</span> <span class="o">(_,</span><span class="n">color2</span><span class="o">)</span> <span class="o">=</span> <span class="n">compare</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">color1</span><span class="o">)</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">color2</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* @@PLEAC@@_5.10 *)</span>
<span class="c">(*-----------------------------*)</span>
<span class="c">(* definition of merge function on hashes: *)</span>
<span class="k">let</span> <span class="n">hashtbl_merge</span> <span class="n">h1</span> <span class="n">h2</span> <span class="o">=</span> <span class="n">assoc_list2hashtbl</span> <span class="o">(</span><span class="n">hashtbl2assoc_list</span> <span class="n">h1</span> <span class="o">@</span> <span class="n">hashtbl2assoc_list</span> <span class="n">h2</span><span class="o">)</span>

<span class="c">(* usage: *)</span>
<span class="k">let</span> <span class="n">merged</span> <span class="o">=</span> <span class="n">hashtbl_merge</span> <span class="n">a</span> <span class="n">b</span><span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="n">merged</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span> <span class="k">in</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
  <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">k</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">add</span> <span class="n">merged</span> <span class="n">k</span> <span class="n">v</span><span class="o">))</span>
  <span class="o">[</span><span class="n">a</span><span class="o">;</span><span class="n">b</span><span class="o">]</span>
<span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="n">drink_color</span> <span class="o">=</span> <span class="n">assoc_list2hashtbl</span>
    <span class="o">[</span><span class="s2">&quot;Galliano&quot;</span><span class="o">,</span> <span class="s2">&quot;yellow&quot;</span><span class="o">;</span>
     <span class="s2">&quot;Mai Tai&quot;</span><span class="o">,</span> <span class="s2">&quot;blue&quot;</span><span class="o">]</span>
<span class="o">;;</span>

<span class="k">let</span> <span class="n">ingested_color</span> <span class="o">=</span> <span class="n">hashtbl_merge</span> <span class="n">drink_color</span> <span class="n">food_color</span><span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="n">substance_color</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span> <span class="k">in</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
  <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">k</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">add</span> <span class="n">merged</span> <span class="n">k</span> <span class="n">v</span><span class="o">))</span>
  <span class="o">[</span><span class="n">food_color</span><span class="o">;</span> <span class="n">drink_color</span><span class="o">]</span>
<span class="o">;;</span>

<span class="c">(* @@PLEAC@@_5.11 *)</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="n">common</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">filter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">key</span> <span class="o">-&gt;</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">mem</span> <span class="n">hash2</span> <span class="n">key</span><span class="o">)</span>
    <span class="o">(</span><span class="n">hashtbl_keys</span> <span class="n">hash1</span><span class="o">)</span>
<span class="o">;;</span>
<span class="c">(* common now contains commne keys, note that a key may appear multiple</span>
<span class="c">times in this list due tu multiple bindings allowed in Hashtbl</span>
<span class="c">implementation *)</span>

<span class="k">let</span> <span class="n">this_not_that</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">filter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">key</span> <span class="o">-&gt;</span> <span class="n">not</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">mem</span> <span class="n">hash2</span> <span class="n">key</span><span class="o">))</span>
    <span class="o">(</span><span class="n">hashtbl_keys</span> <span class="n">hash1</span><span class="o">)</span>
<span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="n">citrus_color</span> <span class="o">=</span> <span class="n">assoc_list2hashtbl</span>
                      <span class="o">[</span><span class="s2">&quot;Lemon&quot;</span><span class="o">,</span> <span class="s2">&quot;yellow&quot;</span><span class="o">;</span>
                       <span class="s2">&quot;Orange&quot;</span><span class="o">,</span> <span class="s2">&quot;orange&quot;</span><span class="o">;</span>
                       <span class="s2">&quot;Lime&quot;</span><span class="o">,</span> <span class="s2">&quot;green&quot;</span><span class="o">]</span>
<span class="k">in</span>
<span class="k">let</span> <span class="n">non_citrus</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">3</span> <span class="k">in</span>
<span class="nn">List</span><span class="p">.</span><span class="n">filter</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">key</span> <span class="o">-&gt;</span> <span class="n">not</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">mem</span> <span class="n">citrus_color</span> <span class="n">key</span><span class="o">))</span>
  <span class="o">(</span><span class="n">hashtbl_keys</span> <span class="n">food_color</span><span class="o">)</span>
<span class="o">;;</span>

<span class="c">(*-----------------------------*)</span>
<span class="c">(* @@PLEAC@@_5.12 *)</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">open</span> <span class="nc">Unix</span><span class="o">;;</span>
<span class="k">open</span> <span class="nc">Printf</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">filenames</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;/etc/printcap&quot;</span><span class="o">;</span> <span class="s2">&quot;/vmlinuz&quot;</span><span class="o">;</span> <span class="s2">&quot;/bin/cat&quot;</span><span class="o">]</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">openfiles</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">3</span> <span class="k">in</span>
<span class="n">print_newline</span><span class="bp">()</span><span class="o">;</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">fname</span> <span class="o">-&gt;</span>
    <span class="n">printf</span> <span class="s2">&quot;%s is %d bytes long.</span><span class="se">\n</span><span class="s2">&quot;</span>
      <span class="n">fname</span>
      <span class="o">(</span><span class="n">stat</span> <span class="n">fname</span><span class="o">).</span><span class="n">st_size</span>
  <span class="o">)</span>
  <span class="n">filenames</span>
<span class="o">;;</span>

<span class="c">(*-----------------------------*)</span>
<span class="c">(* @@PLEAC@@_5.13 *)</span>
<span class="c">(*-----------------------------*)</span>

<span class="c">(* presize hash to num elements *)</span>
<span class="k">let</span> <span class="n">hash</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="n">num</span><span class="o">;;</span>
<span class="c">(* other examples of initial size on hashes *)</span>
<span class="k">let</span> <span class="n">hash</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">512</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">hash</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">1000</span><span class="o">;;</span>

<span class="c">(*-----------------------------*)</span>
<span class="c">(* @@PLEAC@@_5.14 *)</span>
<span class="c">(*-----------------------------*)</span>

<span class="c">(* size of an array named &quot;a&quot; *)</span>
<span class="k">let</span> <span class="n">count</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">a</span><span class="o">;;</span>

<span class="c">(* size of a list named &quot;l&quot; *)</span>
<span class="k">let</span> <span class="n">count</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">length</span> <span class="n">l</span><span class="o">;;</span>

<span class="c">(*-----------------------------*)</span>
<span class="c">(* @@PLEAC@@_5.15 *)</span>
<span class="c">(*-----------------------------*)</span>

<span class="k">open</span> <span class="nc">Printf</span><span class="o">;;</span>
<span class="k">open</span> <span class="nc">Hashtbl</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">father</span> <span class="o">=</span> <span class="n">assoc_list2hashtbl</span>
  <span class="o">[</span> <span class="s2">&quot;Cain&quot;</span><span class="o">,</span> <span class="s2">&quot;Adam&quot;</span><span class="o">;</span>
    <span class="s2">&quot;Abel&quot;</span><span class="o">,</span> <span class="s2">&quot;Adam&quot;</span><span class="o">;</span>
    <span class="s2">&quot;Seth&quot;</span><span class="o">,</span> <span class="s2">&quot;Adam&quot;</span><span class="o">;</span>
    <span class="s2">&quot;Enoch&quot;</span><span class="o">,</span> <span class="s2">&quot;Cain&quot;</span><span class="o">;</span>
    <span class="s2">&quot;Irad&quot;</span><span class="o">,</span> <span class="s2">&quot;Enoch&quot;</span><span class="o">;</span>
    <span class="s2">&quot;Mehujael&quot;</span><span class="o">,</span> <span class="s2">&quot;Irad&quot;</span><span class="o">;</span>
    <span class="s2">&quot;Methusael&quot;</span><span class="o">,</span> <span class="s2">&quot;Mehujael&quot;</span><span class="o">;</span>
    <span class="s2">&quot;Lamech&quot;</span><span class="o">,</span> <span class="s2">&quot;Methusael&quot;</span><span class="o">;</span>
    <span class="s2">&quot;Jabal&quot;</span><span class="o">,</span> <span class="s2">&quot;Lamech&quot;</span><span class="o">;</span>
    <span class="s2">&quot;Jubal&quot;</span><span class="o">,</span> <span class="s2">&quot;Lamech&quot;</span><span class="o">;</span>
    <span class="s2">&quot;Tubalcain&quot;</span><span class="o">,</span> <span class="s2">&quot;Lamech&quot;</span><span class="o">;</span>
    <span class="s2">&quot;Enos&quot;</span><span class="o">,</span> <span class="s2">&quot;Seth&quot;</span><span class="o">]</span> <span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="c">(* recursively print all parents of a given name *)</span>
<span class="k">let</span> <span class="k">rec</span> <span class="n">parents</span> <span class="n">s</span> <span class="o">=</span>
  <span class="n">printf</span> <span class="s2">&quot;%s &quot;</span> <span class="n">s</span><span class="o">;</span>
  <span class="k">if</span> <span class="n">mem</span> <span class="n">father</span> <span class="n">s</span> <span class="k">then</span>
    <span class="n">parents</span> <span class="o">(</span><span class="n">find</span> <span class="n">father</span> <span class="n">s</span><span class="o">)</span>
  <span class="k">else</span>
    <span class="n">printf</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
<span class="k">in</span>
  <span class="n">iter_lines</span> <span class="n">parents</span> <span class="n">stdin</span>
<span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="n">children</span> <span class="o">=</span> <span class="n">hashtbl_reverse_multi</span> <span class="n">father</span> <span class="k">in</span>
<span class="n">iter_lines</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="n">printf</span> <span class="s2">&quot;%s &quot;</span><span class="o">)</span> <span class="o">(</span><span class="n">find_all</span> <span class="n">children</span> <span class="n">line</span><span class="o">);</span>
    <span class="n">print_newline</span><span class="bp">()</span>
  <span class="o">)</span>
  <span class="n">stdin</span><span class="o">;</span>
<span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="c">(* build an hash that map filename to list of included file *)</span>
<span class="k">open</span> <span class="nc">Hashtbl</span><span class="o">;;</span>
<span class="k">open</span> <span class="nc">Str</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">includes</span> <span class="o">=</span> <span class="n">create</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">length</span> <span class="n">files</span><span class="o">);;</span>
<span class="k">let</span> <span class="n">includeRE</span> <span class="o">=</span> <span class="n">regexp</span> <span class="s2">&quot;^#include &lt;</span><span class="err">\</span><span class="s2">([a-zA-Z0-9.]+</span><span class="err">\</span><span class="s2">)&gt;&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">isincludeline</span> <span class="n">l</span> <span class="o">=</span> <span class="n">string_match</span> <span class="n">includeRE</span> <span class="n">l</span> <span class="mi">0</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">getincludes</span> <span class="n">fname</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">includelines</span> <span class="o">=</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">filter</span> <span class="n">isincludeline</span> <span class="o">(</span><span class="n">readlines</span> <span class="o">(</span><span class="n">open_in</span> <span class="n">fname</span><span class="o">))</span>
  <span class="k">in</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="n">replace_first</span> <span class="n">includeRE</span> <span class="s2">&quot;</span><span class="err">\</span><span class="s2">1&quot;</span><span class="o">)</span> <span class="n">includelines</span>
<span class="o">;;</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">fname</span> <span class="o">-&gt;</span> <span class="n">add</span> <span class="n">includes</span> <span class="n">fname</span> <span class="o">(</span><span class="n">getincludes</span> <span class="n">fname</span><span class="o">))</span> <span class="n">files</span><span class="o">;;</span>

<span class="c">(*-----------------------------*)</span>
<span class="c">(* build a list of files that does not include system headers *)</span>
<span class="k">let</span> <span class="n">hasnoinclude</span> <span class="n">fname</span> <span class="o">=</span> <span class="o">(</span><span class="n">find</span> <span class="n">includes</span> <span class="n">fname</span> <span class="o">=</span> <span class="bp">[]</span><span class="o">)</span> <span class="k">in</span>
<span class="nn">List</span><span class="p">.</span><span class="n">filter</span> <span class="n">hasnoinclude</span> <span class="o">(</span><span class="n">uniq</span> <span class="o">(</span><span class="n">hashtbl_keys</span> <span class="n">includes</span><span class="o">));;</span>

<span class="c">(*-----------------------------*)</span>
<span class="c">(* @@PLEAC@@_5.16 *)</span>
<span class="c">(*-----------------------------*)</span>

<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* dutree - print sorted indented rendition of du output *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">dirsize</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span>
<span class="k">let</span> <span class="n">kids</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span>

<span class="c">(* run du, read in input, save sizes and kids *)</span>
<span class="c">(* return last directory (file?) read *)</span>
<span class="k">let</span> <span class="n">input</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">last_name</span> <span class="o">=</span> <span class="n">ref</span> <span class="s2">&quot;&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">last_push</span> <span class="o">=</span> <span class="n">ref</span> <span class="nc">None</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">argv</span> <span class="o">=</span> <span class="s2">&quot;du&quot;</span> <span class="o">::</span> <span class="nn">List</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">ch</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_in</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot; &quot;</span> <span class="n">argv</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">begin</span>
    <span class="k">try</span>
      <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
        <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">ch</span> <span class="k">in</span>
        <span class="k">match</span> <span class="nn">Str</span><span class="p">.</span><span class="n">bounded_split</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[ </span><span class="se">\t</span><span class="s2">]+&quot;</span><span class="o">)</span> <span class="n">line</span> <span class="mi">2</span> <span class="k">with</span>
          <span class="o">|</span> <span class="o">[</span><span class="n">size</span><span class="o">;</span> <span class="n">name</span><span class="o">]</span> <span class="o">-&gt;</span>
              <span class="k">let</span> <span class="n">size</span> <span class="o">=</span> <span class="n">int_of_string</span> <span class="n">size</span> <span class="k">in</span>
              <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">dirsize</span> <span class="n">name</span> <span class="n">size</span><span class="o">;</span>
              <span class="k">let</span> <span class="n">parent</span> <span class="o">=</span>
                <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;/[^/]+$&quot;</span><span class="o">)</span> <span class="s2">&quot;&quot;</span> <span class="n">name</span> <span class="k">in</span>
              <span class="n">last_name</span> <span class="o">:=</span> <span class="n">name</span><span class="o">;</span>
              <span class="n">last_push</span> <span class="o">:=</span>
                <span class="nc">Some</span> <span class="o">(</span><span class="n">parent</span><span class="o">,</span>
                      <span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">kids</span> <span class="n">parent</span><span class="o">)</span>
                      <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="nc">None</span><span class="o">);</span>
              <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">kids</span> <span class="n">parent</span>
                <span class="o">(</span><span class="n">name</span> <span class="o">::</span>
                   <span class="o">(</span><span class="k">try</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">kids</span> <span class="n">parent</span>
                    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">[]</span><span class="o">))</span>
          <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="n">line</span>
      <span class="k">done</span>
    <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
      <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_in</span> <span class="n">ch</span><span class="o">)</span>
  <span class="k">end</span><span class="o">;</span>
  <span class="k">begin</span>
    <span class="k">match</span> <span class="o">!</span><span class="n">last_push</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="bp">()</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">parent</span><span class="o">,</span> <span class="nc">None</span><span class="o">)</span> <span class="o">-&gt;</span>
          <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">remove</span> <span class="n">kids</span> <span class="n">parent</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">parent</span><span class="o">,</span> <span class="nc">Some</span> <span class="n">previous</span><span class="o">)</span> <span class="o">-&gt;</span>
          <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">kids</span> <span class="n">parent</span> <span class="n">previous</span>
  <span class="k">end</span><span class="o">;</span>
  <span class="o">!</span><span class="n">last_name</span>

<span class="c">(* figure out how much is taken up in each directory *)</span>
<span class="c">(* that isn&#39;t stored in subdirectories.  add a new *)</span>
<span class="c">(* fake kid called &quot;.&quot; containing that much. *)</span>
<span class="k">let</span> <span class="k">rec</span> <span class="n">getdots</span> <span class="n">root</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">size</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">dirsize</span> <span class="n">root</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">cursize</span> <span class="o">=</span> <span class="n">ref</span> <span class="n">size</span> <span class="k">in</span>
  <span class="k">if</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">mem</span> <span class="n">kids</span> <span class="n">root</span>
  <span class="k">then</span>
    <span class="k">begin</span>
      <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
        <span class="o">(</span><span class="k">fun</span> <span class="n">kid</span> <span class="o">-&gt;</span>
           <span class="n">cursize</span> <span class="o">:=</span> <span class="o">!</span><span class="n">cursize</span> <span class="o">-</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">dirsize</span> <span class="n">kid</span><span class="o">;</span>
           <span class="n">getdots</span> <span class="n">kid</span><span class="o">)</span>
        <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">kids</span> <span class="n">root</span><span class="o">)</span>
    <span class="k">end</span><span class="o">;</span>
  <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;&gt;</span> <span class="o">!</span><span class="n">cursize</span>
  <span class="k">then</span>
    <span class="k">begin</span>
      <span class="k">let</span> <span class="n">dot</span> <span class="o">=</span> <span class="n">root</span> <span class="o">^</span> <span class="s2">&quot;/.&quot;</span> <span class="k">in</span>
      <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">dirsize</span> <span class="n">dot</span> <span class="o">!</span><span class="n">cursize</span><span class="o">;</span>
      <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">kids</span> <span class="n">root</span>
        <span class="o">(</span><span class="n">dot</span> <span class="o">::</span>
           <span class="o">(</span><span class="k">try</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">kids</span> <span class="n">root</span>
            <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">[]</span><span class="o">))</span>
    <span class="k">end</span>

<span class="c">(* recursively output everything, *)</span>
<span class="c">(* passing padding and number width in as well *)</span>
<span class="c">(* on recursive calls *)</span>
<span class="k">let</span> <span class="k">rec</span> <span class="n">output</span> <span class="o">?(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="o">?(</span><span class="n">width</span><span class="o">=</span><span class="mi">0</span><span class="o">)</span> <span class="n">root</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">path</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;.*/&quot;</span><span class="o">)</span> <span class="s2">&quot;&quot;</span> <span class="n">root</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">size</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">dirsize</span> <span class="n">root</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;%*d %s&quot;</span> <span class="n">width</span> <span class="n">size</span> <span class="n">path</span> <span class="k">in</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">prefix</span> <span class="n">line</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">prefix</span> <span class="o">=</span>
    <span class="nn">Str</span><span class="p">.</span><span class="n">global_replace</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[^|]&quot;</span><span class="o">)</span> <span class="s2">&quot; &quot;</span>
      <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[0-9] &quot;</span><span class="o">)</span> <span class="s2">&quot;| &quot;</span>
         <span class="o">(</span><span class="n">prefix</span> <span class="o">^</span> <span class="n">line</span><span class="o">))</span> <span class="k">in</span>
  <span class="k">if</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">mem</span> <span class="n">kids</span> <span class="n">root</span>
  <span class="k">then</span>
    <span class="k">begin</span>
      <span class="k">let</span> <span class="n">kids</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">kids</span> <span class="n">root</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">kids</span> <span class="o">=</span>
        <span class="nn">List</span><span class="p">.</span><span class="n">rev_map</span>
          <span class="o">(</span><span class="k">fun</span> <span class="n">kid</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">dirsize</span> <span class="n">kid</span><span class="o">,</span> <span class="n">kid</span><span class="o">))</span> <span class="n">kids</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">kids</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">sort</span> <span class="n">compare</span> <span class="n">kids</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">kids</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">rev_map</span> <span class="o">(</span><span class="k">fun</span> <span class="o">(_,</span> <span class="n">kid</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">kid</span><span class="o">)</span> <span class="n">kids</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">width</span> <span class="o">=</span>
        <span class="nn">String</span><span class="p">.</span><span class="n">length</span>
          <span class="o">(</span><span class="n">string_of_int</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">dirsize</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">hd</span> <span class="n">kids</span><span class="o">)))</span> <span class="k">in</span>
      <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="n">output</span> <span class="o">~</span><span class="n">prefix</span> <span class="o">~</span><span class="n">width</span><span class="o">)</span> <span class="n">kids</span>
    <span class="k">end</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">topdir</span> <span class="o">=</span> <span class="n">input</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="n">getdots</span> <span class="n">topdir</span><span class="o">;</span>
  <span class="n">output</span> <span class="n">topdir</span>


<span class="c">(* @@PLEAC@@_6.0 *)</span>
<span class="c">(* We will use the Str library distributed with OCaml for regular expressions.</span>
<span class="c"> * There are two ways to use the str library, building a top or passing it to ocaml.</span>
<span class="c"> * Under Unix, you can create a new toplevel which has the Str module:</span>
<span class="c"> *      $ ocamlmktop -o strtop str.cma</span>
<span class="c"> *      $ ./strtop</span>
<span class="c"> *   Now you don&#39;t need to prefix the contents of the str module with Str.</span>
<span class="c"> * The alternative is to pass str.cma as a parameter:</span>
<span class="c"> *     $ ocaml str.cma</span>
<span class="c"> *   Now you may refer to the contents of the str module by using Str.</span>
<span class="c"> * Under Windows, if you are using ocamlwin.exe you can simply load Str:</span>
<span class="c"> *      # load &quot;str.cma&quot;;;</span>
<span class="c"> *)</span>
<span class="c">(* Str.search_forward returns an int or throws an exception if the pattern isn&#39;t found.</span>
<span class="c"> * In Perl, the =~ operator returns null. Since these two values have different</span>
<span class="c"> * types in OCaml, we cannot copy this behaviour directly.</span>
<span class="c"> * Instead, we return an impossible index, -1 using try ... with.</span>
<span class="c"> * Another method would be to define an =~ operator and use that directly:</span>
<span class="c"># let (=~) s re = Str.string_match (Str.regexp re) s 0;;</span>
<span class="c">val ( =~ ) : string -&gt; string -&gt; bool = &lt;fun&gt;</span>
<span class="c"># &quot;abc&quot; =~ &quot;a&quot;;;</span>
<span class="c">- : bool = true</span>
<span class="c"># &quot;bc&quot; =~ &quot;a&quot;;;</span>
<span class="c">- : bool = false</span>
<span class="c"> * Don&#39;t underestimate the power of this. Many of the following examples could be</span>
<span class="c"> * simplified by defining infix operators.</span>
<span class="c"> *)</span>
<span class="k">try</span> <span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="n">pattern</span><span class="o">)</span> <span class="kt">string</span> <span class="mi">0</span><span class="o">;</span>
<span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="o">;;</span>

<span class="k">try</span> <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="n">pattern</span><span class="o">)</span> <span class="n">replacement</span> <span class="kt">string</span><span class="o">;</span>
<span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="s2">&quot;&quot;</span><span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">try</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;sheep&quot;</span><span class="o">)</span> <span class="n">meadow</span> <span class="mi">0</span><span class="o">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
<span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">false</span><span class="o">;;</span> <span class="c">(* true if meadow contains &quot;sheep&quot; *)</span>

<span class="k">try</span> <span class="n">not</span> <span class="o">((</span><span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;sheep&quot;</span><span class="o">)</span> <span class="n">meadow</span> <span class="mi">0</span><span class="o">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="o">);</span>
<span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">true</span><span class="o">;;</span> <span class="c">(* true if meadow doesn&#39;t contain &quot;sheep&quot; *)</span>

<span class="k">let</span> <span class="n">meadow</span> <span class="o">=</span>
    <span class="k">try</span> <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;old&quot;</span><span class="o">)</span> <span class="s2">&quot;new&quot;</span> <span class="n">meadow</span><span class="o">;</span>
    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="n">meadow</span><span class="o">;;</span> <span class="c">(* Replace &quot;old&quot; with &quot;new&quot; in meadow *)</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">try</span>
    <span class="k">let</span> <span class="n">temp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">bovines?</span><span class="se">\\</span><span class="s2">b&quot;</span><span class="o">)</span> <span class="n">meadow</span> <span class="mi">0</span> <span class="k">in</span>
        <span class="n">print_string</span> <span class="s2">&quot;Here be sheep!&quot;</span><span class="o">;</span>
<span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="kt">string</span> <span class="o">=</span> <span class="s2">&quot;good food&quot;</span> <span class="k">in</span>
    <span class="k">try</span>
        <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;o*&quot;</span><span class="o">)</span> <span class="s2">&quot;e&quot;</span> <span class="kt">string</span><span class="o">;</span>
    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="kt">string</span><span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="c">(* There is no way to take command line parameters to ocaml that I know of.</span>
<span class="c"> * You would first have to compile your OCaml program using ocamlc.</span>
<span class="c"> *)</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="k">rec</span> <span class="n">match_num</span> <span class="n">s</span> <span class="n">start</span><span class="o">=</span>
    <span class="k">if</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">then</span>
        <span class="k">try</span>
            <span class="k">let</span> <span class="n">temp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[0123456789]+&quot;</span><span class="o">)</span> <span class="n">s</span> <span class="n">start</span> <span class="k">in</span>
                <span class="n">print_string</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="o">(</span><span class="s2">&quot;Found number &quot;</span> <span class="o">::</span> <span class="nn">Str</span><span class="p">.</span><span class="n">matched_string</span> <span class="n">s</span> <span class="o">::</span> <span class="o">[</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">]));</span>
                <span class="n">match_num</span> <span class="n">s</span> <span class="o">(</span><span class="n">temp</span> <span class="o">+</span> <span class="mi">1</span><span class="o">);</span>
        <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">;</span>
    <span class="k">else</span>
        <span class="bp">()</span><span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="k">rec</span> <span class="n">match_group</span> <span class="n">s</span> <span class="n">start</span> <span class="n">numbers</span><span class="o">=</span>
    <span class="k">if</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">then</span>
        <span class="k">try</span>
            <span class="k">let</span> <span class="n">temp</span> <span class="o">=</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[0123456789]+&quot;</span><span class="o">)</span> <span class="n">s</span> <span class="n">start</span><span class="o">)</span> <span class="k">in</span>
                <span class="k">let</span> <span class="n">numbers</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">matched_string</span> <span class="n">s</span> <span class="o">::</span> <span class="n">numbers</span> <span class="k">in</span>
                    <span class="n">match_group</span> <span class="n">s</span> <span class="o">(</span><span class="n">temp</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">numbers</span><span class="o">;</span>
        <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="n">numbers</span><span class="o">;</span>
    <span class="k">else</span>
        <span class="n">numbers</span><span class="o">;;</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="o">(=+)</span> <span class="n">s</span> <span class="n">re</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">result</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
    <span class="k">while</span> <span class="o">((</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span><span class="o">)</span> <span class="o">&gt;</span> <span class="o">!</span><span class="n">offset</span><span class="o">)</span> <span class="k">do</span>
        <span class="k">try</span>
            <span class="n">offset</span> <span class="o">:=</span> <span class="mi">1</span> <span class="o">+</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="n">re</span><span class="o">)</span> <span class="n">s</span> <span class="o">!</span><span class="n">offset</span><span class="o">);</span>
            <span class="n">result</span> <span class="o">:=</span> <span class="o">!</span><span class="n">result</span> <span class="o">@</span> <span class="o">[</span><span class="nn">Str</span><span class="p">.</span><span class="n">matched_string</span> <span class="n">s</span><span class="o">]</span> <span class="o">@</span> <span class="bp">[]</span><span class="o">;</span>
        <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="n">ignore</span> <span class="o">(</span><span class="n">offset</span> <span class="o">:=</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span><span class="o">)</span>
    <span class="k">done</span><span class="o">;</span>
    <span class="n">result</span><span class="o">;;</span>

<span class="k">let</span> <span class="o">(=-)</span> <span class="n">s</span> <span class="n">re</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">result</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
    <span class="k">while</span> <span class="o">((</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span><span class="o">)</span> <span class="o">&gt;</span> <span class="o">!</span><span class="n">offset</span><span class="o">)</span> <span class="k">do</span>
        <span class="k">try</span>
            <span class="n">ignore</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="n">re</span><span class="o">)</span> <span class="n">s</span> <span class="o">!</span><span class="n">offset</span><span class="o">);</span>
            <span class="n">offset</span> <span class="o">:=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">match_end</span> <span class="bp">()</span><span class="o">;</span>
            <span class="n">result</span> <span class="o">:=</span> <span class="o">!</span><span class="n">result</span> <span class="o">@</span> <span class="o">[</span><span class="nn">Str</span><span class="p">.</span><span class="n">matched_string</span> <span class="n">s</span><span class="o">]</span> <span class="o">@</span> <span class="bp">[]</span><span class="o">;</span>
        <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="n">ignore</span> <span class="o">(</span><span class="n">offset</span> <span class="o">:=</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span><span class="o">)</span>
    <span class="k">done</span><span class="o">;</span>
    <span class="n">result</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">digits</span> <span class="o">=</span> <span class="s2">&quot;123456789&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">yeslap</span> <span class="o">=</span> <span class="n">digits</span> <span class="o">=+</span> <span class="s2">&quot;[1234567890][1234567890][1234567890]&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">nonlap</span> <span class="o">=</span> <span class="n">digits</span> <span class="o">=-</span> <span class="s2">&quot;[1234567890][1234567890][1234567890]&quot;</span><span class="o">;;</span>

<span class="n">print_string</span> <span class="s2">&quot;Non-overlapping: &quot;</span><span class="o">;</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">print_string</span> <span class="o">(</span><span class="n">v</span> <span class="o">^</span> <span class="s2">&quot; &quot;</span><span class="o">))</span> <span class="o">!</span><span class="n">nonlap</span><span class="o">;</span>
<span class="n">print_string</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;;</span>
<span class="c">(* Non-overlapping: 123 456 789 *)</span>

<span class="n">print_string</span> <span class="s2">&quot;Overlapping: &quot;</span><span class="o">;</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">v</span> <span class="o">-&gt;</span> <span class="n">print_string</span> <span class="o">(</span><span class="n">v</span> <span class="o">^</span> <span class="s2">&quot; &quot;</span><span class="o">))</span> <span class="o">!</span><span class="n">yeslap</span><span class="o">;</span>
<span class="n">print_string</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;;</span>
<span class="c">(* Overlapping: 123 234 345 456 567 678 789 *)</span>
<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="n">index</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span><span class="o">;;</span>
<span class="k">let</span> <span class="kt">string</span> <span class="o">=</span> <span class="s2">&quot;And little lambs eat ivy&quot;</span><span class="o">;;</span>
<span class="k">try</span>
    <span class="n">index</span> <span class="o">:=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;l[^s]*s&quot;</span><span class="o">)</span> <span class="kt">string</span> <span class="mi">0</span><span class="o">;</span>
<span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">;;</span>

<span class="n">print_string</span> <span class="o">(</span><span class="s2">&quot;(&quot;</span> <span class="o">^</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="kt">string</span> <span class="mi">0</span> <span class="o">!</span><span class="n">index</span><span class="o">)</span> <span class="o">^</span> <span class="s2">&quot;) &quot;</span><span class="o">);</span>
<span class="n">print_string</span> <span class="o">(</span><span class="s2">&quot;(&quot;</span> <span class="o">^</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">matched_string</span> <span class="kt">string</span><span class="o">)</span> <span class="o">^</span> <span class="s2">&quot;) &quot;</span><span class="o">);</span>
<span class="n">print_string</span> <span class="o">(</span><span class="s2">&quot;(&quot;</span> <span class="o">^</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">string_after</span> <span class="kt">string</span> <span class="mi">16</span><span class="o">)</span> <span class="o">^</span> <span class="s2">&quot;)</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">);;</span>
<span class="c">(* (And ) (little lambs) ( eat ivy) *)</span>

<span class="c">(* @@PLEAC@@_6.1 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="c">(* The Str module doesn&#39;t modify strings in place; you always get</span>
<span class="c">   a copy when you perform a substitution. *)</span>
<span class="k">let</span> <span class="n">dst</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">global_replace</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;this&quot;</span><span class="o">)</span> <span class="s2">&quot;that&quot;</span> <span class="n">src</span>

<span class="c">(* Strip to basename. *)</span>
<span class="k">let</span> <span class="n">progname</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;^.*/&quot;</span><span class="o">)</span> <span class="s2">&quot;&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span>

<span class="c">(* Make All Words Title-Cased. *)</span>
<span class="k">let</span> <span class="n">capword</span> <span class="o">=</span>
  <span class="nn">Str</span><span class="p">.</span><span class="n">global_substitute</span>
    <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">b.&quot;</span><span class="o">)</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="nn">String</span><span class="p">.</span><span class="n">uppercase</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">matched_string</span> <span class="n">s</span><span class="o">))</span>
    <span class="n">words</span>

<span class="c">(* /usr/man/man3/foo.1 changes to /usr/man/cat3/foo.1 *)</span>
<span class="k">let</span> <span class="n">catpage</span> <span class="o">=</span>
  <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;man</span><span class="se">\\</span><span class="s2">([0-9]</span><span class="se">\\</span><span class="s2">)&quot;</span><span class="o">)</span> <span class="s2">&quot;cat</span><span class="se">\\</span><span class="s2">1&quot;</span> <span class="n">manpage</span>

<span class="c">(* Copy and substitute on all strings in a list. *)</span>
<span class="k">let</span> <span class="n">bindirs</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;/usr/bin&quot;</span><span class="o">;</span> <span class="s2">&quot;/bin&quot;</span><span class="o">;</span> <span class="s2">&quot;/usr/local/bin&quot;</span><span class="o">]</span>
<span class="k">let</span> <span class="n">libdirs</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;bin&quot;</span><span class="o">)</span> <span class="s2">&quot;lib&quot;</span> <span class="n">s</span><span class="o">)</span>
    <span class="n">bindirs</span>
<span class="c">(* [&quot;/usr/lib&quot;; &quot;/lib&quot;; &quot;/usr/local/lib&quot;] *)</span>

<span class="c">(* @@PLEAC@@_6.2 *)</span>
<span class="c">(* Str can do a simple character range match, but it isn&#39;t very</span>
<span class="c">   practical for matching alphabetic characters in general. *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;^[A-Za-z]+$&quot;</span><span class="o">)</span> <span class="n">var</span> <span class="mi">0</span>
  <span class="k">then</span> <span class="n">print_endline</span> <span class="s2">&quot;var is purely alphabetic&quot;</span>

<span class="c">(* With Pcre, you can use UTF8 support and match characters with</span>
<span class="c">   the letter property. *)</span>
<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+pcre&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;pcre.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span> <span class="o">~</span><span class="n">rex</span><span class="o">:(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="o">~</span><span class="n">flags</span><span class="o">:[`</span><span class="nc">UTF8</span><span class="o">]</span> <span class="s2">&quot;^</span><span class="se">\\</span><span class="s2">pL+$&quot;</span><span class="o">)</span> <span class="n">var</span>
  <span class="k">then</span> <span class="n">print_endline</span> <span class="s2">&quot;var is purely alphabetic&quot;</span>

<span class="c">(* @@PLEAC@@_6.3 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="c">(* Str&#39;s regexps lack a whitespace-matching pattern.</span>
<span class="c">   Here is a substitute. *)</span>
<span class="k">let</span> <span class="n">whitespace_chars</span> <span class="o">=</span>
  <span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="mi">1</span><span class="o">)</span>
       <span class="o">[</span>
         <span class="nn">Char</span><span class="p">.</span><span class="n">chr</span> <span class="mi">9</span><span class="o">;</span>  <span class="c">(* HT *)</span>
         <span class="nn">Char</span><span class="p">.</span><span class="n">chr</span> <span class="mi">10</span><span class="o">;</span> <span class="c">(* LF *)</span>
         <span class="nn">Char</span><span class="p">.</span><span class="n">chr</span> <span class="mi">11</span><span class="o">;</span> <span class="c">(* VT *)</span>
         <span class="nn">Char</span><span class="p">.</span><span class="n">chr</span> <span class="mi">12</span><span class="o">;</span> <span class="c">(* FF *)</span>
         <span class="nn">Char</span><span class="p">.</span><span class="n">chr</span> <span class="mi">13</span><span class="o">;</span> <span class="c">(* CR *)</span>
         <span class="nn">Char</span><span class="p">.</span><span class="n">chr</span> <span class="mi">32</span><span class="o">;</span> <span class="c">(* space *)</span>
       <span class="o">])</span>
<span class="k">let</span> <span class="n">space</span> <span class="o">=</span> <span class="s2">&quot;[&quot;</span> <span class="o">^</span> <span class="n">whitespace_chars</span> <span class="o">^</span> <span class="s2">&quot;]&quot;</span>
<span class="k">let</span> <span class="n">non_space</span> <span class="o">=</span> <span class="s2">&quot;[^&quot;</span> <span class="o">^</span> <span class="n">whitespace_chars</span> <span class="o">^</span> <span class="s2">&quot;]&quot;</span>

<span class="c">(* as many non-whitespace characters as possible *)</span>
<span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="o">(</span><span class="n">non_space</span> <span class="o">^</span> <span class="s2">&quot;+&quot;</span><span class="o">)</span>

<span class="c">(* as many letters, apostrophes, and hyphens *)</span>
<span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[A-Za-z&#39;-]+&quot;</span>

<span class="c">(* usually best *)</span>
<span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">b</span><span class="se">\\</span><span class="s2">([A-Za-z]+</span><span class="se">\\</span><span class="s2">)</span><span class="se">\\</span><span class="s2">b&quot;</span>

<span class="c">(* fails at ends or w/ punctuation *)</span>
<span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="o">(</span><span class="n">space</span> <span class="o">^</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">([A-Za-z]+</span><span class="se">\\</span><span class="s2">)&quot;</span> <span class="o">^</span> <span class="n">space</span><span class="o">)</span>

<span class="c">(* @@PLEAC@@_6.4 *)</span>
<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* resname - change all &quot;foo.bar.com&quot; style names in the input stream</span>
<span class="c">   into &quot;foo.bar.com [204.148.40.9]&quot; (or whatever) instead *)</span>

<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+pcre&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;pcre.cma&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span>
  <span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="o">~</span><span class="n">flags</span><span class="o">:[`</span><span class="nc">EXTENDED</span><span class="o">]</span> <span class="s2">&quot;</span>
<span class="s2">    (                     # capture the hostname in substring 1</span>
<span class="s2">      (?:                 # these parens for grouping only</span>
<span class="s2">        (?! [-_]  )       # lookahead for neither underscore nor dash</span>
<span class="s2">        [</span><span class="se">\\</span><span class="s2">w-] +          # hostname component</span>
<span class="s2">        </span><span class="se">\\</span><span class="s2">.               # and the domain dot</span>
<span class="s2">      ) +                 # now repeat that whole thing a bunch of times</span>
<span class="s2">      [A-Za-z]            # next must be a letter</span>
<span class="s2">      [</span><span class="se">\\</span><span class="s2">w-] +            # now trailing domain part</span>
<span class="s2">    )                     # end of substring 1 capture</span>
<span class="s2">  &quot;</span>

<span class="k">let</span> <span class="n">process</span> <span class="n">line</span> <span class="o">=</span>
  <span class="n">print_endline</span>
    <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">substitute_substrings</span>
       <span class="o">~</span><span class="n">rex</span><span class="o">:</span><span class="n">regexp</span>
       <span class="o">~</span><span class="n">subst</span><span class="o">:(</span><span class="k">fun</span> <span class="n">subs</span> <span class="o">-&gt;</span>
                 <span class="k">let</span> <span class="n">name</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">get_substring</span> <span class="n">subs</span> <span class="mi">1</span> <span class="k">in</span>
                 <span class="k">let</span> <span class="n">addr</span> <span class="o">=</span>
                   <span class="k">try</span>
                     <span class="nn">Unix</span><span class="p">.</span><span class="n">string_of_inet_addr</span>
                       <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">gethostbyname</span> <span class="n">name</span><span class="o">).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">h_addr_list</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span>
                   <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="s2">&quot;???&quot;</span> <span class="k">in</span>
                 <span class="n">name</span> <span class="o">^</span> <span class="s2">&quot; [&quot;</span> <span class="o">^</span> <span class="n">addr</span> <span class="o">^</span> <span class="s2">&quot;]&quot;</span><span class="o">)</span>
       <span class="n">line</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">read_line</span> <span class="bp">()</span> <span class="k">in</span>
      <span class="n">process</span> <span class="n">line</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">vars</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">vars</span> <span class="s2">&quot;name&quot;</span> <span class="s2">&quot;Bob&quot;</span><span class="o">;</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">vars</span> <span class="s2">&quot;flavor&quot;</span> <span class="s2">&quot;rhubarb&quot;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">print_endline</span>
    <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">substitute_substrings</span>
       <span class="o">~</span><span class="n">rex</span><span class="o">:(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="o">~</span><span class="n">flags</span><span class="o">:[`</span><span class="nc">EXTENDED</span><span class="o">]</span> <span class="s2">&quot;</span>
<span class="s2">               </span><span class="se">\\</span><span class="s2">#                #   a pound sign</span>
<span class="s2">               (</span><span class="se">\\</span><span class="s2">w+)             #   the variable name</span>
<span class="s2">               </span><span class="se">\\</span><span class="s2">#                #   another pound sign</span>
<span class="s2">             &quot;</span><span class="o">)</span>
       <span class="o">~</span><span class="n">subst</span><span class="o">:(</span><span class="k">fun</span> <span class="n">subs</span> <span class="o">-&gt;</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">vars</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">get_substring</span> <span class="n">subs</span> <span class="mi">1</span><span class="o">))</span>
       <span class="s2">&quot;Hello, #name#, would you like some #flavor# pie?&quot;</span><span class="o">)</span>

<span class="c">(* @@PLEAC@@_6.5 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">want</span> <span class="o">=</span> <span class="mi">3</span>
<span class="k">let</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>
<span class="k">let</span> <span class="n">pond</span> <span class="o">=</span> <span class="s2">&quot;One fish two fish red fish blue fish&quot;</span>
<span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp_case_fold</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">([a-z]+</span><span class="se">\\</span><span class="s2">)[ ]+fish</span><span class="se">\\</span><span class="s2">b&quot;</span>

<span class="k">exception</span> <span class="nc">Found</span> <span class="k">of</span> <span class="kt">string</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">start</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="n">ignore</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span> <span class="n">regexp</span> <span class="n">pond</span> <span class="o">!</span><span class="n">start</span><span class="o">);</span>
      <span class="n">start</span> <span class="o">:=</span> <span class="o">!</span><span class="n">start</span> <span class="o">+</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">matched_string</span> <span class="n">pond</span><span class="o">);</span>
      <span class="n">incr</span> <span class="n">count</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">!</span><span class="n">count</span> <span class="o">=</span> <span class="n">want</span> <span class="k">then</span> <span class="k">raise</span> <span class="o">(</span><span class="nc">Found</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">1</span> <span class="n">pond</span><span class="o">))</span>
    <span class="k">done</span>
  <span class="k">with</span>
    <span class="o">|</span> <span class="nc">Found</span> <span class="n">color</span> <span class="o">-&gt;</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;The third fish is a %s one.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">color</span>
    <span class="o">|</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Only found %d fish!</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">!</span><span class="n">count</span>

<span class="c">(* The third fish is a red one. *)</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">colors</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">start</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">fish</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="k">begin</span>
    <span class="k">try</span>
      <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
        <span class="n">ignore</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span> <span class="n">regexp</span> <span class="n">pond</span> <span class="o">!</span><span class="n">start</span><span class="o">);</span>
        <span class="n">start</span> <span class="o">:=</span> <span class="o">!</span><span class="n">start</span> <span class="o">+</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">matched_string</span> <span class="n">pond</span><span class="o">));</span>
        <span class="n">fish</span> <span class="o">:=</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">1</span> <span class="n">pond</span><span class="o">)</span> <span class="o">::</span> <span class="o">!</span><span class="n">fish</span>
      <span class="k">done</span><span class="o">;</span>
    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">()</span>
  <span class="k">end</span><span class="o">;</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">of_list</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="o">!</span><span class="n">fish</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;The third fish in the pond is %s.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">colors</span><span class="o">.(</span><span class="mi">2</span><span class="o">)</span>

<span class="c">(* The third fish in the pond is red. *)</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">evens</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">colors&#39;</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">iteri</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">i</span> <span class="n">color</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">mod</span> <span class="mi">2</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">then</span> <span class="n">colors&#39;</span> <span class="o">:=</span> <span class="n">color</span> <span class="o">::</span> <span class="o">!</span><span class="n">colors&#39;</span><span class="o">)</span>
    <span class="n">colors</span><span class="o">;</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="o">!</span><span class="n">colors&#39;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Even numbered fish are %s.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot; &quot;</span> <span class="n">evens</span><span class="o">)</span>

<span class="c">(* Even numbered fish are two blue. *)</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="n">print_endline</span>
    <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">global_substitute</span>
       <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp_case_fold</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">b</span><span class="se">\\</span><span class="s2">([a-z]+</span><span class="se">\\</span><span class="s2">)</span><span class="se">\\</span><span class="s2">([ ]+fish</span><span class="se">\\</span><span class="s2">b</span><span class="se">\\</span><span class="s2">)&quot;</span><span class="o">)</span>
       <span class="o">(</span><span class="k">fun</span> <span class="n">s</span> <span class="o">-&gt;</span>
          <span class="n">incr</span> <span class="n">count</span><span class="o">;</span>
          <span class="k">if</span> <span class="o">!</span><span class="n">count</span> <span class="o">=</span> <span class="mi">4</span>
          <span class="k">then</span> <span class="s2">&quot;sushi&quot;</span> <span class="o">^</span> <span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">2</span> <span class="n">s</span>
          <span class="k">else</span> <span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">1</span> <span class="n">s</span> <span class="o">^</span> <span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">2</span> <span class="n">s</span><span class="o">)</span>
       <span class="n">pond</span><span class="o">)</span>

<span class="c">(* One fish two fish red fish sushi fish *)</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">pond</span> <span class="o">=</span> <span class="s2">&quot;One fish two fish red fish blue fish swim here.&quot;</span>
<span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp_case_fold</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">b</span><span class="se">\\</span><span class="s2">([a-z]+</span><span class="se">\\</span><span class="s2">)[ ]+fish</span><span class="se">\\</span><span class="s2">b&quot;</span>
<span class="k">let</span> <span class="n">colors</span> <span class="o">=</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span> <span class="n">start</span> <span class="n">acc</span> <span class="o">=</span>
    <span class="k">try</span>
      <span class="n">ignore</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span> <span class="n">regexp</span> <span class="n">pond</span> <span class="n">start</span><span class="o">);</span>
      <span class="n">loop</span>
        <span class="o">(</span><span class="n">start</span> <span class="o">+</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">matched_string</span> <span class="n">pond</span><span class="o">))</span>
        <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">1</span> <span class="n">pond</span> <span class="o">::</span> <span class="n">acc</span><span class="o">)</span>
    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
      <span class="n">acc</span> <span class="k">in</span>
  <span class="n">loop</span> <span class="mi">0</span> <span class="bp">[]</span>
<span class="k">let</span> <span class="n">color</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">hd</span> <span class="n">colors</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Last fish is %s.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">color</span>

<span class="c">(* Last fish is blue. *)</span>

<span class="c">(* @@PLEAC@@_6.6 *)</span>
<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* killtags - very bad html tag killer *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;&lt;[^&gt;]*&gt;&quot;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">filename</span> <span class="o">-&gt;</span>
       <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
       <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span> <span class="n">open_in</span> <span class="n">filename</span> <span class="k">in</span>
       <span class="k">try</span>
         <span class="k">begin</span>
           <span class="k">try</span> <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span> <span class="n">lines</span> <span class="o">:=</span> <span class="n">input_line</span> <span class="n">in_channel</span> <span class="o">::</span> <span class="o">!</span><span class="n">lines</span> <span class="k">done</span>
           <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span>
         <span class="k">end</span><span class="o">;</span>
         <span class="k">let</span> <span class="n">contents</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="o">!</span><span class="n">lines</span><span class="o">)</span> <span class="k">in</span>
         <span class="n">print_endline</span>
           <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span>
              <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span>
                 <span class="o">(</span><span class="k">function</span>
                    <span class="o">|</span> <span class="nn">Str</span><span class="p">.</span><span class="nc">Text</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span>
                    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="s2">&quot;&quot;</span><span class="o">)</span>
                 <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">full_split</span> <span class="n">regexp</span> <span class="n">contents</span><span class="o">)));</span>
         <span class="n">close_in</span> <span class="n">in_channel</span>
       <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span>
         <span class="n">close_in</span> <span class="n">in_channel</span><span class="o">;</span>
         <span class="k">raise</span> <span class="n">e</span><span class="o">)</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">))</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* headerfy - change certain chapter headers to html *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">line_stream_of_channel</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">channel</span><span class="o">)</span> <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="nc">None</span><span class="o">)</span>

<span class="k">let</span> <span class="n">paragraph_stream_of_channel</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">line_stream_of_channel</span> <span class="n">channel</span> <span class="k">in</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">next</span> <span class="n">para_lines</span> <span class="n">i</span> <span class="o">=</span>
    <span class="k">match</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">peek</span> <span class="n">lines</span><span class="o">,</span> <span class="n">para_lines</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">None</span><span class="o">,</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="nc">None</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="s2">&quot;&quot;</span><span class="o">,</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">lines</span><span class="o">;</span> <span class="n">next</span> <span class="n">para_lines</span> <span class="n">i</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="s2">&quot;&quot;</span><span class="o">,</span> <span class="o">_</span>
      <span class="o">|</span> <span class="nc">None</span><span class="o">,</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nc">Some</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="n">para_lines</span><span class="o">))</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">line</span><span class="o">,</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">lines</span><span class="o">;</span> <span class="n">next</span> <span class="o">(</span><span class="n">line</span> <span class="o">::</span> <span class="n">para_lines</span><span class="o">)</span> <span class="n">i</span> <span class="k">in</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span> <span class="o">(</span><span class="n">next</span> <span class="bp">[]</span><span class="o">)</span>

<span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;^Chapter[</span><span class="se">\r\n\t</span><span class="s2"> ]+[0-9]+[</span><span class="se">\r\n\t</span><span class="s2"> ]*:[^</span><span class="se">\r\n</span><span class="s2">]*&quot;</span>

<span class="k">let</span> <span class="n">headerfy</span> <span class="n">chunk</span> <span class="o">=</span>
  <span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span>
       <span class="o">(</span><span class="k">function</span>
          <span class="o">|</span> <span class="nn">Str</span><span class="p">.</span><span class="nc">Text</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span>
          <span class="o">|</span> <span class="nn">Str</span><span class="p">.</span><span class="nc">Delim</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="s2">&quot;&lt;H1&gt;&quot;</span> <span class="o">^</span> <span class="n">s</span> <span class="o">^</span> <span class="s2">&quot;&lt;/H1&gt;&quot;</span><span class="o">)</span>
       <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">full_split</span> <span class="n">regexp</span> <span class="n">chunk</span><span class="o">))</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">filename</span> <span class="o">-&gt;</span>
       <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span> <span class="n">open_in</span> <span class="n">filename</span> <span class="k">in</span>
       <span class="k">try</span>
         <span class="nn">Stream</span><span class="p">.</span><span class="n">iter</span>
           <span class="o">(</span><span class="k">fun</span> <span class="n">para</span> <span class="o">-&gt;</span>
              <span class="n">print_endline</span> <span class="o">(</span><span class="n">headerfy</span> <span class="n">para</span><span class="o">);</span>
              <span class="n">print_newline</span> <span class="bp">()</span><span class="o">)</span>
           <span class="o">(</span><span class="n">paragraph_stream_of_channel</span> <span class="n">in_channel</span><span class="o">);</span>
         <span class="n">close_in</span> <span class="n">in_channel</span>
       <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span>
         <span class="n">close_in</span> <span class="n">in_channel</span><span class="o">;</span>
         <span class="k">raise</span> <span class="n">e</span><span class="o">)</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">))</span>

<span class="c">(* @@PLEAC@@_6.7 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">chunks</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="k">begin</span>
    <span class="k">try</span> <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span> <span class="n">lines</span> <span class="o">:=</span> <span class="n">input_line</span> <span class="n">stdin</span> <span class="o">::</span> <span class="o">!</span><span class="n">lines</span> <span class="k">done</span>
    <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span>
  <span class="k">end</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">contents</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="o">!</span><span class="n">lines</span><span class="o">)</span> <span class="k">in</span>
  <span class="nn">Str</span><span class="p">.</span><span class="n">full_split</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;^</span><span class="se">\\</span><span class="s2">.</span><span class="se">\\</span><span class="s2">(Ch</span><span class="se">\\</span><span class="s2">|Se</span><span class="se">\\</span><span class="s2">|Ss</span><span class="se">\\</span><span class="s2">)$&quot;</span><span class="o">)</span> <span class="n">contents</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span>
    <span class="s2">&quot;I read %d chunks.</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">length</span> <span class="n">chunks</span><span class="o">)</span>

<span class="c">(* @@PLEAC@@_6.8 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="c">(* Creates a stream that produces ranges of items from another stream.</span>
<span class="c">   Production of items starts when when (start_test count item) returns</span>
<span class="c">   true and stops when (finish_test count item) returns true. Multiple</span>
<span class="c">   ranges will be produced if start_test returns true again. The count</span>
<span class="c">   starts at 1. Ranges are inclusive; the item that causes finish_test</span>
<span class="c">   to return true will be produced. *)</span>
<span class="k">let</span> <span class="n">stream_range</span> <span class="n">start_test</span> <span class="n">finish_test</span> <span class="n">stream</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">active</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">1</span> <span class="k">in</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">next</span> <span class="n">i</span> <span class="o">=</span>
    <span class="k">match</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">peek</span> <span class="n">stream</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="nc">None</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">item</span> <span class="o">-&gt;</span>
          <span class="k">if</span> <span class="n">not</span> <span class="o">!</span><span class="n">active</span> <span class="k">then</span>
            <span class="k">begin</span>
              <span class="k">if</span> <span class="n">start_test</span> <span class="o">!</span><span class="n">count</span> <span class="n">item</span>
              <span class="k">then</span> <span class="o">(</span><span class="n">active</span> <span class="o">:=</span> <span class="bp">true</span><span class="o">;</span> <span class="n">next</span> <span class="n">i</span><span class="o">)</span>
              <span class="k">else</span> <span class="o">(</span><span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">stream</span><span class="o">;</span> <span class="n">incr</span> <span class="n">count</span><span class="o">;</span> <span class="n">next</span> <span class="n">i</span><span class="o">)</span>
            <span class="k">end</span>
          <span class="k">else</span>
            <span class="k">begin</span>
              <span class="k">if</span> <span class="n">finish_test</span> <span class="o">!</span><span class="n">count</span> <span class="n">item</span> <span class="k">then</span> <span class="n">active</span> <span class="o">:=</span> <span class="bp">false</span><span class="o">;</span>
              <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">stream</span><span class="o">;</span>
              <span class="n">incr</span> <span class="n">count</span><span class="o">;</span>
              <span class="nc">Some</span> <span class="n">item</span>
            <span class="k">end</span> <span class="k">in</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span> <span class="n">next</span>

<span class="c">(* Creates a stream that produces items between a pair of indices.</span>
<span class="c">   If start = 2 and finish = 4, items 2, 3, and 4 will be produced.</span>
<span class="c">   The first item is number 1. *)</span>
<span class="k">let</span> <span class="n">stream_range_numbers</span> <span class="n">start</span> <span class="n">finish</span> <span class="n">stream</span> <span class="o">=</span>
  <span class="n">stream_range</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">count</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">count</span> <span class="o">=</span> <span class="n">start</span><span class="o">)</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">count</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">count</span> <span class="o">=</span> <span class="n">finish</span><span class="o">)</span>
    <span class="n">stream</span>

<span class="c">(* Creates a stream that produces strings between a pair of regexps.</span>
<span class="c">   The regexp will be tested using Str.string_match. *)</span>
<span class="k">let</span> <span class="n">stream_range_patterns</span> <span class="n">start</span> <span class="n">finish</span> <span class="n">stream</span> <span class="o">=</span>
  <span class="n">stream_range</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="n">line</span> <span class="o">-&gt;</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">start</span> <span class="n">line</span> <span class="mi">0</span><span class="o">)</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="n">line</span> <span class="o">-&gt;</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">finish</span> <span class="n">line</span> <span class="mi">0</span><span class="o">)</span>
    <span class="n">stream</span>

<span class="c">(* Produce a stream of lines from an input channel. *)</span>
<span class="k">let</span> <span class="n">line_stream_of_channel</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">channel</span><span class="o">)</span> <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="nc">None</span><span class="o">)</span>

<span class="c">(* Print lines 15 through 17 inclusive. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">iter</span>
    <span class="n">print_endline</span>
    <span class="o">(</span><span class="n">stream_range_numbers</span> <span class="mi">15</span> <span class="mi">17</span>
       <span class="o">(</span><span class="n">line_stream_of_channel</span> <span class="o">(</span><span class="n">open_in</span> <span class="n">datafile</span><span class="o">)))</span>

<span class="c">(* Print out all &lt;XMP&gt; .. &lt;/XMP&gt; displays from HTML doc. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">iter</span>
    <span class="n">print_endline</span>
    <span class="o">(</span><span class="n">stream_range_patterns</span>
       <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;.*&lt;XMP&gt;&quot;</span><span class="o">)</span>
       <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;.*&lt;/XMP&gt;&quot;</span><span class="o">)</span>
       <span class="o">(</span><span class="n">line_stream_of_channel</span> <span class="n">stdin</span><span class="o">))</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">in_header</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">true</span>
<span class="k">let</span> <span class="n">in_body</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span>
       <span class="k">if</span> <span class="o">!</span><span class="n">in_header</span> <span class="o">&amp;&amp;</span> <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
       <span class="k">then</span> <span class="o">(</span><span class="n">in_header</span> <span class="o">:=</span> <span class="bp">false</span><span class="o">;</span> <span class="n">in_body</span> <span class="o">:=</span> <span class="bp">true</span><span class="o">)</span>
       <span class="k">else</span>
         <span class="k">begin</span>
           <span class="c">(* do something with line *)</span>
         <span class="k">end</span><span class="o">)</span>
    <span class="o">(</span><span class="n">line_stream_of_channel</span> <span class="n">stdin</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">module</span> <span class="nc">StringSet</span> <span class="o">=</span> <span class="nn">Set</span><span class="p">.</span><span class="nc">Make</span><span class="o">(</span><span class="nc">String</span><span class="o">)</span>
<span class="k">let</span> <span class="n">seen</span> <span class="o">=</span> <span class="n">ref</span> <span class="nn">StringSet</span><span class="p">.</span><span class="n">empty</span>
<span class="k">let</span> <span class="n">email_regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">([^&lt;&gt;(),; </span><span class="se">\t</span><span class="s2">]+@[^&lt;&gt;(),; </span><span class="se">\t</span><span class="s2">]+</span><span class="se">\\</span><span class="s2">)&quot;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span>
       <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
         <span class="o">(</span><span class="k">function</span>
            <span class="o">|</span> <span class="nn">Str</span><span class="p">.</span><span class="nc">Delim</span> <span class="n">email</span> <span class="o">-&gt;</span>
                <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="nn">StringSet</span><span class="p">.</span><span class="n">mem</span> <span class="n">email</span> <span class="o">!</span><span class="n">seen</span><span class="o">)</span>
                <span class="k">then</span>
                  <span class="k">begin</span>
                    <span class="n">seen</span> <span class="o">:=</span> <span class="nn">StringSet</span><span class="p">.</span><span class="n">add</span> <span class="n">email</span> <span class="o">!</span><span class="n">seen</span><span class="o">;</span>
                    <span class="n">print_endline</span> <span class="n">email</span><span class="o">;</span>
                  <span class="k">end</span>
            <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">)</span>
         <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">full_split</span> <span class="n">email_regexp</span> <span class="n">line</span><span class="o">))</span>
    <span class="o">(</span><span class="n">stream_range_patterns</span>
       <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;^From:?[ </span><span class="se">\t</span><span class="s2">]&quot;</span><span class="o">)</span>
       <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;^$&quot;</span><span class="o">)</span>
       <span class="o">(</span><span class="n">line_stream_of_channel</span> <span class="n">stdin</span><span class="o">))</span>

<span class="c">(* @@PLEAC@@_6.9 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">regexp_string_of_glob</span> <span class="n">s</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">i</span><span class="o">,</span> <span class="n">buffer</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(-</span><span class="mi">1</span><span class="o">),</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">create</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span> <span class="o">+</span> <span class="mi">8</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">read</span> <span class="bp">()</span> <span class="o">=</span>
    <span class="n">incr</span> <span class="n">i</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">!</span><span class="n">i</span> <span class="o">&lt;</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span>
    <span class="k">then</span> <span class="nc">Some</span> <span class="n">s</span><span class="o">.[!</span><span class="n">i</span><span class="o">]</span>
    <span class="k">else</span> <span class="nc">None</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">write</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_string</span> <span class="n">buffer</span> <span class="k">in</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">parse_glob</span> <span class="bp">()</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">read</span> <span class="bp">()</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="sc">&#39;*&#39;</span> <span class="o">-&gt;</span> <span class="n">write</span> <span class="s2">&quot;.*&quot;</span><span class="o">;</span> <span class="n">parse_glob</span> <span class="bp">()</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="sc">&#39;?&#39;</span> <span class="o">-&gt;</span> <span class="n">write</span> <span class="s2">&quot;.&quot;</span><span class="o">;</span> <span class="n">parse_glob</span> <span class="bp">()</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="sc">&#39;[&#39;</span> <span class="o">-&gt;</span> <span class="n">parse_bracket</span> <span class="s2">&quot;&quot;</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">c</span> <span class="o">-&gt;</span> <span class="n">write</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">quote</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="mi">1</span> <span class="n">c</span><span class="o">));</span> <span class="n">parse_glob</span> <span class="bp">()</span>
      <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="bp">()</span>
  <span class="ow">and</span> <span class="n">parse_bracket</span> <span class="n">text</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">read</span> <span class="bp">()</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="sc">&#39;!&#39;</span> <span class="k">when</span> <span class="n">text</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">-&gt;</span> <span class="n">parse_bracket</span> <span class="s2">&quot;^&quot;</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="sc">&#39;]&#39;</span> <span class="o">-&gt;</span> <span class="n">write</span> <span class="o">(</span><span class="s2">&quot;[&quot;</span> <span class="o">^</span> <span class="n">text</span> <span class="o">^</span> <span class="s2">&quot;]&quot;</span><span class="o">);</span> <span class="n">parse_glob</span> <span class="bp">()</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">c</span> <span class="o">-&gt;</span> <span class="n">parse_bracket</span> <span class="o">(</span><span class="n">text</span> <span class="o">^</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="mi">1</span> <span class="n">c</span><span class="o">))</span>
      <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="n">write</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">quote</span> <span class="o">(</span><span class="s2">&quot;[&quot;</span> <span class="o">^</span> <span class="n">text</span><span class="o">))</span> <span class="k">in</span>
  <span class="n">write</span> <span class="s2">&quot;^&quot;</span><span class="o">;</span>
  <span class="n">parse_glob</span> <span class="bp">()</span><span class="o">;</span>
  <span class="n">write</span> <span class="s2">&quot;$&quot;</span><span class="o">;</span>
  <span class="nn">Buffer</span><span class="p">.</span><span class="n">contents</span> <span class="n">buffer</span>

<span class="k">let</span> <span class="n">regexp_of_glob</span> <span class="n">s</span> <span class="o">=</span>
  <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="o">(</span><span class="n">regexp_string_of_glob</span> <span class="n">s</span><span class="o">)</span>

<span class="k">let</span> <span class="n">regexp_of_glob_case_fold</span> <span class="n">s</span> <span class="o">=</span>
  <span class="nn">Str</span><span class="p">.</span><span class="n">regexp_case_fold</span> <span class="o">(</span><span class="n">regexp_string_of_glob</span> <span class="n">s</span><span class="o">)</span>

<span class="c">(* @@PLEAC@@_6.10 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">popstates</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;CO&quot;</span><span class="o">;</span> <span class="s2">&quot;ON&quot;</span><span class="o">;</span> <span class="s2">&quot;MI&quot;</span><span class="o">;</span> <span class="s2">&quot;WI&quot;</span><span class="o">;</span> <span class="s2">&quot;MN&quot;</span><span class="o">]</span>

<span class="c">(* Naive version: Compile a regexp each time it is needed. *)</span>
<span class="k">let</span> <span class="n">popgrep1</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">begin</span>
      <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
        <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">stdin</span> <span class="k">in</span>
        <span class="k">try</span>
          <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
            <span class="o">(</span><span class="k">fun</span> <span class="n">state</span> <span class="o">-&gt;</span>
               <span class="k">if</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span>
                     <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="o">(</span><span class="s2">&quot;.*</span><span class="se">\\</span><span class="s2">b&quot;</span> <span class="o">^</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">quote</span> <span class="n">state</span><span class="o">)</span> <span class="o">^</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">b&quot;</span><span class="o">))</span>
                     <span class="n">line</span> <span class="mi">0</span><span class="o">)</span>
               <span class="k">then</span> <span class="o">(</span><span class="n">print_endline</span> <span class="n">line</span><span class="o">;</span> <span class="k">raise</span> <span class="nc">Exit</span><span class="o">))</span>
            <span class="n">popstates</span>
        <span class="k">with</span> <span class="nc">Exit</span> <span class="o">-&gt;</span> <span class="bp">()</span>
      <span class="k">done</span>
    <span class="k">end</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span>

<span class="c">(* First optimization: Compile the regexps in advance. *)</span>
<span class="k">let</span> <span class="n">popgrep2</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">popstate_regexps</span> <span class="o">=</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">map</span>
      <span class="o">(</span><span class="k">fun</span> <span class="n">state</span> <span class="o">-&gt;</span>
         <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="o">(</span><span class="s2">&quot;.*</span><span class="se">\\</span><span class="s2">b&quot;</span> <span class="o">^</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">quote</span> <span class="n">state</span><span class="o">)</span> <span class="o">^</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">b&quot;</span><span class="o">))</span>
      <span class="n">popstates</span> <span class="k">in</span>
  <span class="k">try</span>
    <span class="k">begin</span>
      <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
        <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">stdin</span> <span class="k">in</span>
        <span class="k">try</span>
          <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
            <span class="o">(</span><span class="k">fun</span> <span class="n">regexp</span> <span class="o">-&gt;</span>
               <span class="k">if</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">regexp</span> <span class="n">line</span> <span class="mi">0</span><span class="o">)</span>
               <span class="k">then</span> <span class="o">(</span><span class="n">print_endline</span> <span class="n">line</span><span class="o">;</span> <span class="k">raise</span> <span class="nc">Exit</span><span class="o">))</span>
            <span class="n">popstate_regexps</span>
        <span class="k">with</span> <span class="nc">Exit</span> <span class="o">-&gt;</span> <span class="bp">()</span>
      <span class="k">done</span>
    <span class="k">end</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span>

<span class="c">(* Second optimization: Build a single regexp for all states. *)</span>
<span class="k">let</span> <span class="n">popgrep3</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">popstates_regexp</span> <span class="o">=</span>
    <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span>
      <span class="o">(</span><span class="s2">&quot;.*</span><span class="se">\\</span><span class="s2">b</span><span class="se">\\</span><span class="s2">(&quot;</span>
       <span class="o">^</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">|&quot;</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="nn">Str</span><span class="p">.</span><span class="n">quote</span> <span class="n">popstates</span><span class="o">))</span>
       <span class="o">^</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">)</span><span class="se">\\</span><span class="s2">b&quot;</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">try</span>
    <span class="k">begin</span>
      <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
        <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">stdin</span> <span class="k">in</span>
        <span class="k">if</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">popstates_regexp</span> <span class="n">line</span> <span class="mi">0</span>
        <span class="k">then</span> <span class="n">print_endline</span> <span class="n">line</span>
      <span class="k">done</span>
    <span class="k">end</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span>

<span class="c">(* Speed tests with a 15,000 line input file: *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">popgrep1</span> <span class="bp">()</span>         <span class="c">(* time: 13.670s *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">popgrep2</span> <span class="bp">()</span>         <span class="c">(* time:  0.264s *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">popgrep3</span> <span class="bp">()</span>         <span class="c">(* time:  0.123s *)</span>

<span class="c">(* @@PLEAC@@_6.11 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
    <span class="n">print_string</span> <span class="s2">&quot;Pattern? &quot;</span><span class="o">;</span>
    <span class="n">flush</span> <span class="n">stdout</span><span class="o">;</span>
    <span class="k">let</span> <span class="n">pattern</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">stdin</span> <span class="k">in</span>
    <span class="k">try</span> <span class="n">ignore</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="n">pattern</span><span class="o">)</span>
    <span class="k">with</span> <span class="nc">Failure</span> <span class="n">message</span> <span class="o">-&gt;</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;INVALID PATTERN: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">message</span>
  <span class="k">done</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">is_valid_pattern</span> <span class="n">pattern</span> <span class="o">=</span>
  <span class="k">try</span> <span class="n">ignore</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="n">pattern</span><span class="o">);</span> <span class="bp">true</span>
  <span class="k">with</span> <span class="nc">Failure</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* paragrep - trivial paragraph grepper *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">line_stream_of_channel</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">channel</span><span class="o">)</span> <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="nc">None</span><span class="o">)</span>

<span class="k">let</span> <span class="n">paragraph_stream_of_channel</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">line_stream_of_channel</span> <span class="n">channel</span> <span class="k">in</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">next</span> <span class="n">para_lines</span> <span class="n">i</span> <span class="o">=</span>
    <span class="k">match</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">peek</span> <span class="n">lines</span><span class="o">,</span> <span class="n">para_lines</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">None</span><span class="o">,</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="nc">None</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="s2">&quot;&quot;</span><span class="o">,</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">lines</span><span class="o">;</span> <span class="n">next</span> <span class="n">para_lines</span> <span class="n">i</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="s2">&quot;&quot;</span><span class="o">,</span> <span class="o">_</span>
      <span class="o">|</span> <span class="nc">None</span><span class="o">,</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nc">Some</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="n">para_lines</span><span class="o">))</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">line</span><span class="o">,</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">lines</span><span class="o">;</span> <span class="n">next</span> <span class="o">(</span><span class="n">line</span> <span class="o">::</span> <span class="n">para_lines</span><span class="o">)</span> <span class="n">i</span> <span class="k">in</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span> <span class="o">(</span><span class="n">next</span> <span class="bp">[]</span><span class="o">)</span>

<span class="k">let</span> <span class="n">paragrep</span> <span class="n">pat</span> <span class="n">files</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span>
    <span class="k">begin</span>
      <span class="k">try</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="n">pat</span>
      <span class="k">with</span> <span class="nc">Failure</span> <span class="n">msg</span> <span class="o">-&gt;</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s: Bad pattern %s: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span> <span class="n">pat</span> <span class="n">msg</span><span class="o">;</span>
        <span class="n">exit</span> <span class="mi">1</span>
    <span class="k">end</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">file</span> <span class="o">-&gt;</span>
       <span class="k">let</span> <span class="n">channel</span> <span class="o">=</span>
         <span class="k">if</span> <span class="n">file</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
         <span class="k">then</span> <span class="n">stdin</span>
         <span class="k">else</span> <span class="n">open_in</span> <span class="n">file</span> <span class="k">in</span>
       <span class="k">try</span>
         <span class="nn">Stream</span><span class="p">.</span><span class="n">iter</span>
           <span class="o">(</span><span class="k">fun</span> <span class="n">para</span> <span class="o">-&gt;</span>
              <span class="n">incr</span> <span class="n">count</span><span class="o">;</span>
              <span class="k">try</span>
                <span class="n">ignore</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span> <span class="n">regexp</span> <span class="n">para</span> <span class="mi">0</span><span class="o">);</span>
                <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s %d: %s</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="n">file</span> <span class="o">!</span><span class="n">count</span> <span class="n">para</span>
              <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">)</span>
           <span class="o">(</span><span class="n">paragraph_stream_of_channel</span> <span class="n">channel</span><span class="o">);</span>
         <span class="n">close_in</span> <span class="n">channel</span>
       <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span>
         <span class="n">close_in</span> <span class="n">channel</span><span class="o">;</span>
         <span class="k">raise</span> <span class="n">e</span><span class="o">)</span>
    <span class="n">files</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">match</span> <span class="nn">List</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">)</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">pat</span> <span class="o">::</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="n">paragrep</span> <span class="n">pat</span> <span class="o">[</span><span class="s2">&quot;-&quot;</span><span class="o">]</span>
    <span class="o">|</span> <span class="n">pat</span> <span class="o">::</span> <span class="n">files</span> <span class="o">-&gt;</span> <span class="n">paragrep</span> <span class="n">pat</span> <span class="n">files</span>
    <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;usage: %s pat [files]</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">safe_pat</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">quote</span> <span class="n">pat</span>

<span class="c">(* @@PLEAC@@_6.12 *)</span>
<span class="c">(* OCaml does not provide a way to change the locale, and PCRE does</span>
<span class="c">   not appear to be sensitive to the default locale. Regardless, Str</span>
<span class="c">   does not support locales, and PCRE only matches ASCII characters</span>
<span class="c">   for \w and friends. This example instead demonstrates the use of</span>
<span class="c">   PCRE&#39;s UTF-8 support to match words, and it does not use locales. *)</span>

<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+pcre&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;pcre.cma&quot;</span><span class="o">;;</span>

<span class="c">(* encoded as UTF-8 *)</span>
<span class="k">let</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;andreas k</span><span class="se">\xc3\xb6</span><span class="s2">nig&quot;</span>

<span class="c">(* the original regexp which is not Unicode-aware *)</span>
<span class="k">let</span> <span class="n">ascii_regexp</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">b(</span><span class="se">\\</span><span class="s2">w+)</span><span class="se">\\</span><span class="s2">b&quot;</span>

<span class="c">(* a revised regexp which tests for Unicode letters and numbers *)</span>
<span class="k">let</span> <span class="n">utf8_regexp</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="o">~</span><span class="n">flags</span><span class="o">:[`</span><span class="nc">UTF8</span><span class="o">]</span> <span class="s2">&quot;([</span><span class="se">\\</span><span class="s2">pL</span><span class="se">\\</span><span class="s2">pN]+)&quot;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">enc</span><span class="o">,</span> <span class="n">regexp</span><span class="o">)</span> <span class="o">-&gt;</span>
       <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s names: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">enc</span>
         <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot; &quot;</span>
            <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span>
               <span class="nn">String</span><span class="p">.</span><span class="n">capitalize</span>
               <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">flatten</span>
                  <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span>
                     <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">map</span>
                        <span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span>
                        <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">extract_all</span>
                           <span class="o">~</span><span class="n">full_match</span><span class="o">:</span><span class="bp">false</span>
                           <span class="o">~</span><span class="n">rex</span><span class="o">:</span><span class="n">regexp</span>
                           <span class="n">name</span><span class="o">)))))))</span>
    <span class="o">[</span><span class="s2">&quot;ASCII&quot;</span><span class="o">,</span> <span class="n">ascii_regexp</span><span class="o">;</span> <span class="s2">&quot;UTF-8&quot;</span><span class="o">,</span> <span class="n">utf8_regexp</span><span class="o">]</span>

<span class="c">(*</span>
<span class="c">  ASCII names: Andreas K Nig</span>
<span class="c">  UTF-8 names: Andreas König</span>
<span class="c">*)</span>

<span class="c">(* @@PLEAC@@_6.13 *)</span>
<span class="c">(* Calculates the Levenshtein, or edit distance, between two strings. *)</span>
<span class="k">let</span> <span class="n">levenshtein</span> <span class="n">s</span> <span class="n">t</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">n</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">m</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">t</span> <span class="k">in</span>
  <span class="k">match</span> <span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="n">n</span><span class="o">)</span> <span class="k">with</span>
    <span class="o">|</span> <span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">m</span>
    <span class="o">|</span> <span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">n</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">n</span>
    <span class="o">|</span> <span class="o">(</span><span class="n">m</span><span class="o">,</span> <span class="n">n</span><span class="o">)</span> <span class="o">-&gt;</span>
        <span class="k">let</span> <span class="n">d</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">init</span> <span class="o">(</span><span class="n">m</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">)</span> <span class="k">in</span>
        <span class="k">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
        <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">to</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">do</span>
          <span class="k">let</span> <span class="n">e</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="k">in</span>
          <span class="k">for</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">to</span> <span class="n">m</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">do</span>
            <span class="k">let</span> <span class="n">cost</span> <span class="o">=</span> <span class="k">if</span> <span class="n">s</span><span class="o">.[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="n">t</span><span class="o">.[</span><span class="n">j</span><span class="o">]</span> <span class="k">then</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span> <span class="k">in</span>
            <span class="n">x</span> <span class="o">:=</span>
              <span class="n">min</span>
                <span class="o">(</span><span class="n">d</span><span class="o">.(</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span>      <span class="c">(* insertion *)</span>
                <span class="o">(</span><span class="n">min</span>
                   <span class="o">(!</span><span class="n">e</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span>          <span class="c">(* deletion *)</span>
                   <span class="o">(</span><span class="n">d</span><span class="o">.(</span><span class="n">j</span><span class="o">)</span> <span class="o">+</span> <span class="n">cost</span><span class="o">));</span>  <span class="c">(* substitution *)</span>
            <span class="n">d</span><span class="o">.(</span><span class="n">j</span><span class="o">)</span> <span class="o">&lt;-</span> <span class="o">!</span><span class="n">e</span><span class="o">;</span>
            <span class="n">e</span> <span class="o">:=</span> <span class="o">!</span><span class="n">x</span>
          <span class="k">done</span><span class="o">;</span>
          <span class="n">d</span><span class="o">.(</span><span class="n">m</span><span class="o">)</span> <span class="o">&lt;-</span> <span class="o">!</span><span class="n">x</span>
        <span class="k">done</span><span class="o">;</span>
        <span class="o">!</span><span class="n">x</span>

<span class="c">(* Determines if two strings are an approximate match. *)</span>
<span class="k">let</span> <span class="n">amatch</span> <span class="o">?(</span><span class="n">percentage</span><span class="o">=</span><span class="mi">20</span><span class="o">)</span> <span class="n">s</span> <span class="n">t</span> <span class="o">=</span>
  <span class="n">levenshtein</span> <span class="n">s</span> <span class="n">t</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span> <span class="o">&lt;=</span> <span class="n">percentage</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">dict</span> <span class="o">=</span> <span class="n">open_in</span> <span class="s2">&quot;/usr/dict/words&quot;</span> <span class="k">in</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="k">let</span> <span class="n">word</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">dict</span> <span class="k">in</span>
      <span class="k">if</span> <span class="n">amatch</span> <span class="s2">&quot;balast&quot;</span> <span class="n">word</span>
      <span class="k">then</span> <span class="n">print_endline</span> <span class="n">word</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="n">close_in</span> <span class="n">dict</span>

<span class="c">(*</span>
<span class="c">  ballast</span>
<span class="c">  blast</span>
<span class="c">*)</span>

<span class="c">(* @@PLEAC@@_6.14 *)</span>
<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+pcre&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;pcre.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;12 345 hello 6 7world89 10&quot;</span>
<span class="k">let</span> <span class="n">rex</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;(</span><span class="se">\\</span><span class="s2">d+)&quot;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">subs</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">exec</span> <span class="o">~</span><span class="n">rex</span> <span class="n">s</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Found %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">get_substring</span> <span class="o">!</span><span class="n">subs</span> <span class="mi">1</span><span class="o">);</span>
      <span class="n">subs</span> <span class="o">:=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">next_match</span> <span class="o">~</span><span class="n">rex</span> <span class="o">!</span><span class="n">subs</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">()</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">n</span> <span class="o">=</span> <span class="s2">&quot;   49 here&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">n</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">replace</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">G &quot;</span> <span class="o">~</span><span class="n">templ</span><span class="o">:</span><span class="s2">&quot;0&quot;</span> <span class="n">n</span> <span class="k">in</span>
  <span class="n">print_endline</span> <span class="n">n</span>

<span class="c">(* 00049 here *)</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;3,4,5,9,120&quot;</span>
<span class="k">let</span> <span class="n">rex</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">G,?(</span><span class="se">\\</span><span class="s2">d+)&quot;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">subs</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">exec</span> <span class="o">~</span><span class="n">rex</span> <span class="n">s</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Found number %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">get_substring</span> <span class="o">!</span><span class="n">subs</span> <span class="mi">1</span><span class="o">);</span>
      <span class="n">subs</span> <span class="o">:=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">next_match</span> <span class="o">~</span><span class="n">rex</span> <span class="o">!</span><span class="n">subs</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">()</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;The year 1752 lost 10 days on the 3rd of September&quot;</span>

<span class="k">let</span> <span class="n">rex</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;(</span><span class="se">\\</span><span class="s2">d+)&quot;</span>
<span class="k">let</span> <span class="n">subs</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">exec</span> <span class="o">~</span><span class="n">rex</span> <span class="n">s</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Found number %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">get_substring</span> <span class="o">!</span><span class="n">subs</span> <span class="mi">1</span><span class="o">);</span>
      <span class="n">subs</span> <span class="o">:=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">next_match</span> <span class="o">~</span><span class="n">rex</span> <span class="o">!</span><span class="n">subs</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">()</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">rex</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">G(</span><span class="se">\\</span><span class="s2">S+)&quot;</span> <span class="k">in</span>
  <span class="n">subs</span> <span class="o">:=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">next_match</span> <span class="o">~</span><span class="n">rex</span> <span class="o">!</span><span class="n">subs</span><span class="o">;</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Found %s after the last number.</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">get_substring</span> <span class="o">!</span><span class="n">subs</span> <span class="mi">1</span><span class="o">)</span>

<span class="c">(*</span>
<span class="c">  Found number 1752</span>
<span class="c">  Found number 10</span>
<span class="c">  Found number 3</span>
<span class="c">  Found rd after the last number.</span>
<span class="c">*)</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">match</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">get_substring_ofs</span> <span class="o">!</span><span class="n">subs</span> <span class="mi">1</span> <span class="k">with</span>
    <span class="o">|</span> <span class="o">(</span><span class="n">start</span><span class="o">,</span> <span class="n">finish</span><span class="o">)</span> <span class="o">-&gt;</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span>
          <span class="s2">&quot;The position in &#39;s&#39; is %d..%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">start</span> <span class="n">finish</span>

<span class="c">(* The position in &#39;s&#39; is 35..37 *)</span>

<span class="c">(* @@PLEAC@@_6.15 *)</span>
<span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;Even &lt;TT&gt;vi&lt;/TT&gt; can edit &lt;TT&gt;troff&lt;/TT&gt; effectively.&quot;</span>

<span class="c">(* The Str library does not support non-greedy matches. In many cases,</span>
<span class="c">   you can turn a non-greedy match into a greedy one, however: *)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">print_endline</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">global_replace</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;&lt;.*&gt;&quot;</span><span class="o">)</span> <span class="s2">&quot;&quot;</span> <span class="n">s</span><span class="o">)</span>
<span class="c">(* Even  effectively. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">print_endline</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">global_replace</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;&lt;[^&gt;]*&gt;&quot;</span><span class="o">)</span> <span class="s2">&quot;&quot;</span> <span class="n">s</span><span class="o">)</span>
<span class="c">(* Even vi can edit troff effectively. *)</span>

<span class="c">(* If you need non-greedy matches, you&#39;ll want to use PCRE instead: *)</span>

<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+pcre&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;pcre.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">print_endline</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">replace</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;&lt;.*?&gt;&quot;</span> <span class="o">~</span><span class="n">templ</span><span class="o">:</span><span class="s2">&quot;&quot;</span> <span class="n">s</span><span class="o">)</span>
<span class="c">(* Even vi can edit troff effectively. *)</span>

<span class="c">(* Non-greedy matches don&#39;t always work the way you expect: *)</span>

<span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;&lt;b&gt;&lt;i&gt;this&lt;/i&gt; and &lt;i&gt;that&lt;/i&gt; are important&lt;/b&gt; Oh, &lt;b&gt;&lt;i&gt;me too!&lt;/i&gt;&lt;/b&gt;&quot;</span>

<span class="k">let</span> <span class="n">rex</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;&lt;b&gt;&lt;i&gt;(.*?)&lt;/i&gt;&lt;/b&gt;&quot;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">print_endline</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">extract</span> <span class="o">~</span><span class="n">rex</span> <span class="n">s</span><span class="o">).(</span><span class="mi">1</span><span class="o">)</span>
<span class="c">(* this&lt;/i&gt; and &lt;i&gt;that&lt;/i&gt; are important&lt;/b&gt; Oh, &lt;b&gt;&lt;i&gt;me too! *)</span>

<span class="c">(* One solution is to use a non-grouping negative lookahead assertion: *)</span>

<span class="k">let</span> <span class="n">rex</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;&lt;b&gt;&lt;i&gt;((?:(?!&lt;/b&gt;|&lt;/i&gt;).)*)&lt;/i&gt;&lt;/b&gt;&quot;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">print_endline</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">extract</span> <span class="o">~</span><span class="n">rex</span> <span class="n">s</span><span class="o">).(</span><span class="mi">1</span><span class="o">)</span>
<span class="c">(* me too! *)</span>

<span class="c">(* If performance is important, here is a faster technique: *)</span>

<span class="k">let</span> <span class="n">rex</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="o">~</span><span class="n">flags</span><span class="o">:[`</span><span class="nc">DOTALL</span><span class="o">;</span> <span class="o">`</span><span class="nc">EXTENDED</span><span class="o">]</span> <span class="s2">&quot;</span>
<span class="s2">    &lt;b&gt;&lt;i&gt;</span>
<span class="s2">    [^&lt;]*  # stuff not possibly bad, and not possibly the end.</span>
<span class="s2">    (?:</span>
<span class="s2"> # at this point, we can have &#39;&lt;&#39; if not part of something bad</span>
<span class="s2">     (?!  &lt;/?[ib]&gt;  )   # what we can&#39;t have</span>
<span class="s2">     &lt;                  # okay, so match the &#39;&lt;&#39;</span>
<span class="s2">     [^&lt;]*              # and continue with more safe stuff</span>
<span class="s2">    ) *</span>
<span class="s2">    &lt;/i&gt;&lt;/b&gt;</span>
<span class="s2">&quot;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">print_endline</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">extract</span> <span class="o">~</span><span class="n">rex</span> <span class="n">s</span><span class="o">).(</span><span class="mi">0</span><span class="o">)</span>
<span class="c">(* &lt;b&gt;&lt;i&gt;me too!&lt;/i&gt;&lt;/b&gt; *)</span>

<span class="c">(* @@PLEAC@@_6.16 *)</span>
<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+pcre&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;pcre.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">line_stream_of_channel</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">channel</span><span class="o">)</span> <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="nc">None</span><span class="o">)</span>

<span class="k">let</span> <span class="n">paragraph_stream_of_channel</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">line_stream_of_channel</span> <span class="n">channel</span> <span class="k">in</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">next</span> <span class="n">para_lines</span> <span class="n">i</span> <span class="o">=</span>
    <span class="k">match</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">peek</span> <span class="n">lines</span><span class="o">,</span> <span class="n">para_lines</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">None</span><span class="o">,</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="nc">None</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="s2">&quot;&quot;</span><span class="o">,</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">lines</span><span class="o">;</span> <span class="n">next</span> <span class="n">para_lines</span> <span class="n">i</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="s2">&quot;&quot;</span><span class="o">,</span> <span class="o">_</span>
      <span class="o">|</span> <span class="nc">None</span><span class="o">,</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nc">Some</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="n">para_lines</span><span class="o">))</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">line</span><span class="o">,</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">lines</span><span class="o">;</span> <span class="n">next</span> <span class="o">(</span><span class="n">line</span> <span class="o">::</span> <span class="n">para_lines</span><span class="o">)</span> <span class="n">i</span> <span class="k">in</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span> <span class="o">(</span><span class="n">next</span> <span class="bp">[]</span><span class="o">)</span>

<span class="k">let</span> <span class="n">find_dup_words</span> <span class="n">files</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">rex</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="o">~</span><span class="n">flags</span><span class="o">:[`</span><span class="nc">CASELESS</span><span class="o">;</span> <span class="o">`</span><span class="nc">EXTENDED</span><span class="o">]</span> <span class="s2">&quot;</span>
<span class="s2">      </span><span class="se">\\</span><span class="s2">b            # start at a word boundary (begin letters)</span>
<span class="s2">      (</span><span class="se">\\</span><span class="s2">S+)         # find chunk of non-whitespace</span>
<span class="s2">      </span><span class="se">\\</span><span class="s2">b            # until another word boundary (end letters)</span>
<span class="s2">      (</span>
<span class="s2">          </span><span class="se">\\</span><span class="s2">s+       # separated by some whitespace</span>
<span class="s2">          </span><span class="se">\\</span><span class="s2">1        # and that very same chunk again</span>
<span class="s2">          </span><span class="se">\\</span><span class="s2">b        # until another word boundary</span>
<span class="s2">      ) +            # one or more sets of those</span>
<span class="s2">  &quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">file</span> <span class="o">-&gt;</span>
       <span class="k">let</span> <span class="n">channel</span> <span class="o">=</span> <span class="k">if</span> <span class="n">file</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span> <span class="k">then</span> <span class="n">stdin</span> <span class="k">else</span> <span class="n">open_in</span> <span class="n">file</span> <span class="k">in</span>
       <span class="k">try</span>
         <span class="nn">Stream</span><span class="p">.</span><span class="n">iter</span>
           <span class="o">(</span><span class="k">fun</span> <span class="n">para</span> <span class="o">-&gt;</span>
              <span class="n">incr</span> <span class="n">count</span><span class="o">;</span>
              <span class="k">try</span>
                <span class="k">let</span> <span class="n">subs</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">exec</span> <span class="o">~</span><span class="n">rex</span> <span class="n">para</span><span class="o">)</span> <span class="k">in</span>
                <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
                  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;dup word &#39;%s&#39; at paragraph %d.</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">get_substring</span> <span class="o">!</span><span class="n">subs</span> <span class="mi">1</span><span class="o">)</span>
                    <span class="o">!</span><span class="n">count</span><span class="o">;</span>
                  <span class="n">flush</span> <span class="n">stdout</span><span class="o">;</span>
                  <span class="n">subs</span> <span class="o">:=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">next_match</span> <span class="o">~</span><span class="n">rex</span> <span class="o">!</span><span class="n">subs</span><span class="o">;</span>
                <span class="k">done</span>
              <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">)</span>
           <span class="o">(</span><span class="n">paragraph_stream_of_channel</span> <span class="n">channel</span><span class="o">);</span>
         <span class="n">close_in</span> <span class="n">channel</span>
       <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span>
         <span class="n">close_in</span> <span class="n">channel</span><span class="o">;</span>
         <span class="k">raise</span> <span class="n">e</span><span class="o">)</span>
    <span class="n">files</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">match</span> <span class="nn">List</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">)</span> <span class="k">with</span>
    <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="n">find_dup_words</span> <span class="o">[</span><span class="s2">&quot;-&quot;</span><span class="o">]</span>
    <span class="o">|</span> <span class="n">files</span> <span class="o">-&gt;</span> <span class="n">find_dup_words</span> <span class="n">files</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(*</span>
<span class="c">  This is a test</span>
<span class="c">  test of the duplicate word finder.</span>
<span class="c">*)</span>

<span class="c">(* dup word &#39;test&#39; at paragraph 1. *)</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">a</span> <span class="o">=</span> <span class="s2">&quot;nobody&quot;</span>
<span class="k">let</span> <span class="n">b</span> <span class="o">=</span> <span class="s2">&quot;bodysnatcher&quot;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">let</span> <span class="n">subs</span> <span class="o">=</span>
      <span class="nn">Pcre</span><span class="p">.</span><span class="n">exec</span>
        <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;^(</span><span class="se">\\</span><span class="s2">w+)(</span><span class="se">\\</span><span class="s2">w+) </span><span class="se">\\</span><span class="s2">2(</span><span class="se">\\</span><span class="s2">w+)$&quot;</span>
        <span class="o">(</span><span class="n">a</span> <span class="o">^</span> <span class="s2">&quot; &quot;</span> <span class="o">^</span> <span class="n">b</span><span class="o">)</span> <span class="k">in</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s overlaps in %s-%s-%s</span><span class="se">\n</span><span class="s2">&quot;</span>
      <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">get_substring</span> <span class="n">subs</span> <span class="mi">2</span><span class="o">)</span>
      <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">get_substring</span> <span class="n">subs</span> <span class="mi">1</span><span class="o">)</span>
      <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">get_substring</span> <span class="n">subs</span> <span class="mi">2</span><span class="o">)</span>
      <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">get_substring</span> <span class="n">subs</span> <span class="mi">3</span><span class="o">)</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
    <span class="bp">()</span>

<span class="c">(* body overlaps in no-body-snatcher *)</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* prime_pattern -- find prime factors of argument using pattern matching *)</span>
<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+pcre&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;pcre.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">arg</span> <span class="o">=</span> <span class="k">try</span> <span class="n">int_of_string</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span> <span class="k">with</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="mi">0</span>
<span class="k">let</span> <span class="n">n</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="n">arg</span> <span class="sc">&#39;o&#39;</span><span class="o">)</span>
<span class="k">let</span> <span class="n">rex</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;^(oo+?)</span><span class="se">\\</span><span class="s2">1+$&quot;</span>
<span class="k">let</span> <span class="n">templ</span> <span class="o">=</span> <span class="s2">&quot;o&quot;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="k">let</span> <span class="n">pat</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">get_substring</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">exec</span> <span class="o">~</span><span class="n">rex</span> <span class="o">!</span><span class="n">n</span><span class="o">)</span> <span class="mi">1</span> <span class="k">in</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%d &quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">pat</span><span class="o">);</span>
      <span class="n">n</span> <span class="o">:=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">replace</span> <span class="o">~</span><span class="n">pat</span> <span class="o">~</span><span class="n">templ</span> <span class="o">!</span><span class="n">n</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="o">!</span><span class="n">n</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">exception</span> <span class="nc">Found</span> <span class="k">of</span> <span class="o">(</span><span class="kt">int</span> <span class="o">*</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">int</span><span class="o">)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">match</span>
      <span class="nn">Pcre</span><span class="p">.</span><span class="n">extract</span>
        <span class="o">~</span><span class="n">full_match</span><span class="o">:</span><span class="bp">false</span>
        <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;^(o*)</span><span class="se">\\</span><span class="s2">1{11}(o*)</span><span class="se">\\</span><span class="s2">2{14}(o*)</span><span class="se">\\</span><span class="s2">3{15}$&quot;</span>
        <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="mi">281</span> <span class="sc">&#39;o&#39;</span><span class="o">)</span>
    <span class="k">with</span>
      <span class="o">|</span> <span class="o">[|</span> <span class="n">x</span><span class="o">;</span> <span class="n">y</span><span class="o">;</span> <span class="n">z</span> <span class="o">|]</span> <span class="o">-&gt;</span> <span class="k">raise</span> <span class="o">(</span><span class="nc">Found</span>
                                  <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">x</span><span class="o">,</span>
                                   <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">y</span><span class="o">,</span>
                                   <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">z</span><span class="o">))</span>
      <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">raise</span> <span class="nc">Not_found</span>
  <span class="k">with</span>
    <span class="o">|</span> <span class="nc">Found</span> <span class="o">(</span><span class="n">x</span><span class="o">,</span> <span class="n">y</span><span class="o">,</span> <span class="n">z</span><span class="o">)</span> <span class="o">-&gt;</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;One solution is: x=%d; y=%d; z=%d.</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="n">x</span> <span class="n">y</span> <span class="n">z</span>
    <span class="o">|</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;No solution.</span><span class="se">\n</span><span class="s2">&quot;</span>

<span class="c">(* One solution is: x=17; y=3; z=2. *)</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;^(o+)</span><span class="se">\\</span><span class="s2">1{11}(o+)</span><span class="se">\\</span><span class="s2">2{14}(o+)</span><span class="se">\\</span><span class="s2">3{15}$&quot;</span>
<span class="c">(* One solution is: x=17; y=3; z=2. *)</span>

<span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;^(o*?)</span><span class="se">\\</span><span class="s2">1{11}(o*)</span><span class="se">\\</span><span class="s2">2{14}(o*)</span><span class="se">\\</span><span class="s2">3{15}$&quot;</span>
<span class="c">(* One solution is: x=0; y=7; z=11. *)</span>

<span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;^(o+?)</span><span class="se">\\</span><span class="s2">1{11}(o*)</span><span class="se">\\</span><span class="s2">2{14}(o*)</span><span class="se">\\</span><span class="s2">3{15}$&quot;</span>
<span class="c">(* One solution is: x=1; y=3; z=14. *)</span>

<span class="c">(* @@PLEAC@@_6.17 *)</span>
<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+pcre&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;pcre.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">pat</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">config_channel</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="k">if</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span> <span class="o">~</span><span class="n">pat</span> <span class="n">data</span> <span class="k">then</span> <span class="c">(* ... *)</span> <span class="bp">()</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* alpha OR beta *)</span>
<span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;alpha|beta&quot;</span>

<span class="c">(* alpha AND beta *)</span>
<span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="o">~</span><span class="n">flags</span><span class="o">:[`</span><span class="nc">DOTALL</span><span class="o">]</span> <span class="s2">&quot;^(?=.*alpha)(?=.*beta)&quot;</span>

<span class="c">(* alpha AND beta, no overlap *)</span>
<span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="o">~</span><span class="n">flags</span><span class="o">:[`</span><span class="nc">DOTALL</span><span class="o">]</span> <span class="s2">&quot;alpha.*beta|beta.*alpha&quot;</span>

<span class="c">(* NOT pat *)</span>
<span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="o">~</span><span class="n">flags</span><span class="o">:[`</span><span class="nc">DOTALL</span><span class="o">]</span> <span class="s2">&quot;^(?:(?!pat).)*$&quot;</span>

<span class="c">(* NOT bad BUT good *)</span>
<span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="o">~</span><span class="n">flags</span><span class="o">:[`</span><span class="nc">DOTALL</span><span class="o">]</span> <span class="s2">&quot;(?=(?:(?!bad).)*$)good&quot;</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span> <span class="o">~</span><span class="n">rex</span><span class="o">:</span><span class="n">regexp</span> <span class="n">text</span><span class="o">)</span>
  <span class="k">then</span> <span class="n">something</span> <span class="bp">()</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span> <span class="o">~</span><span class="n">rex</span><span class="o">:</span><span class="n">rexexp1</span> <span class="n">text</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span> <span class="o">~</span><span class="n">rex</span><span class="o">:</span><span class="n">rexexp2</span> <span class="n">text</span><span class="o">)</span>
  <span class="k">then</span> <span class="n">something</span> <span class="bp">()</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span> <span class="o">~</span><span class="n">rex</span><span class="o">:</span><span class="n">rexexp1</span> <span class="n">text</span><span class="o">)</span> <span class="o">||</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span> <span class="o">~</span><span class="n">rex</span><span class="o">:</span><span class="n">rexexp2</span> <span class="n">text</span><span class="o">)</span>
  <span class="k">then</span> <span class="n">something</span> <span class="bp">()</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* minigrep - trivial grep *)</span>
<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+pcre&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;pcre.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">line_stream_of_channel</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">channel</span><span class="o">)</span> <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="nc">None</span><span class="o">)</span>

<span class="k">let</span> <span class="n">minigrep</span> <span class="n">pat</span> <span class="n">files</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">rex</span> <span class="o">=</span>
    <span class="k">try</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="n">pat</span>
    <span class="k">with</span> <span class="nn">Pcre</span><span class="p">.</span><span class="nc">BadPattern</span> <span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s: Bad pattern %s: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span> <span class="n">pat</span> <span class="n">msg</span><span class="o">;</span>
      <span class="n">exit</span> <span class="mi">1</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">process</span> <span class="n">file</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">channel</span> <span class="o">=</span> <span class="k">if</span> <span class="n">file</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span> <span class="k">then</span> <span class="n">stdin</span> <span class="k">else</span> <span class="n">open_in</span> <span class="n">file</span> <span class="k">in</span>
    <span class="k">try</span>
      <span class="nn">Stream</span><span class="p">.</span><span class="n">iter</span>
        <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span> <span class="o">~</span><span class="n">rex</span> <span class="n">line</span> <span class="k">then</span> <span class="n">print_endline</span> <span class="n">line</span><span class="o">)</span>
        <span class="o">(</span><span class="n">line_stream_of_channel</span> <span class="n">channel</span><span class="o">);</span>
      <span class="n">close_in</span> <span class="n">channel</span>
    <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span>
      <span class="n">close_in</span> <span class="n">channel</span><span class="o">;</span>
      <span class="k">raise</span> <span class="n">e</span> <span class="k">in</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="n">process</span> <span class="n">files</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">match</span> <span class="nn">List</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">)</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">pat</span> <span class="o">::</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="n">minigrep</span> <span class="n">pat</span> <span class="o">[</span><span class="s2">&quot;-&quot;</span><span class="o">]</span>
    <span class="o">|</span> <span class="n">pat</span> <span class="o">::</span> <span class="n">files</span> <span class="o">-&gt;</span> <span class="n">minigrep</span> <span class="n">pat</span> <span class="n">files</span>
    <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;usage: %s pat [files]</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="kt">string</span> <span class="o">=</span> <span class="s2">&quot;labelled&quot;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%b</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span>
       <span class="o">~</span><span class="n">rex</span><span class="o">:(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="o">~</span><span class="n">flags</span><span class="o">:[`</span><span class="nc">DOTALL</span><span class="o">]</span> <span class="s2">&quot;^(?=.*bell)(?=.*lab)&quot;</span><span class="o">)</span>
       <span class="kt">string</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%b</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;bell&quot;</span> <span class="kt">string</span> <span class="o">&amp;&amp;</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;lab&quot;</span> <span class="kt">string</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span>
        <span class="o">~</span><span class="n">rex</span><span class="o">:(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="o">~</span><span class="n">flags</span><span class="o">:[`</span><span class="nc">DOTALL</span><span class="o">;</span> <span class="o">`</span><span class="nc">EXTENDED</span><span class="o">]</span> <span class="s2">&quot;</span>
<span class="s2">             ^              # start of string</span>
<span class="s2">            (?=             # zero-width lookahead</span>
<span class="s2">                .*          # any amount of intervening stuff</span>
<span class="s2">                bell        # the desired bell string</span>
<span class="s2">            )               # rewind, since we were only looking</span>
<span class="s2">            (?=             # and do the same thing</span>
<span class="s2">                .*          # any amount of intervening stuff</span>
<span class="s2">                lab         # and the lab part</span>
<span class="s2">            )&quot;</span><span class="o">)</span>
        <span class="kt">string</span><span class="o">)</span>
  <span class="k">then</span> <span class="n">print_endline</span> <span class="s2">&quot;Looks like Bell Labs might be in Murray Hill!&quot;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%b</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;(?:^.*bell.*lab)|(?:^.*lab.*bell)&quot;</span> <span class="kt">string</span><span class="o">)</span>

<span class="k">let</span> <span class="n">brand</span> <span class="o">=</span> <span class="s2">&quot;labelled&quot;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span>
        <span class="o">~</span><span class="n">rex</span><span class="o">:(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="o">~</span><span class="n">flags</span><span class="o">:[`</span><span class="nc">DOTALL</span><span class="o">;</span> <span class="o">`</span><span class="nc">EXTENDED</span><span class="o">]</span> <span class="s2">&quot;</span>
<span class="s2">        (?:                 # non-capturing grouper</span>
<span class="s2">            ^ .*?           # any amount of stuff at the front</span>
<span class="s2">              bell          # look for a bell</span>
<span class="s2">              .*?           # followed by any amount of anything</span>
<span class="s2">              lab           # look for a lab</span>
<span class="s2">          )                 # end grouper</span>
<span class="s2">    |                       # otherwise, try the other direction</span>
<span class="s2">        (?:                 # non-capturing grouper</span>
<span class="s2">            ^ .*?           # any amount of stuff at the front</span>
<span class="s2">              lab           # look for a lab</span>
<span class="s2">              .*?           # followed by any amount of anything</span>
<span class="s2">              bell          # followed by a bell</span>
<span class="s2">          )                 # end grouper</span>
<span class="s2">      &quot;</span><span class="o">)</span> <span class="n">brand</span><span class="o">)</span>
  <span class="k">then</span> <span class="n">print_endline</span> <span class="s2">&quot;Our brand has bell and lab separate.&quot;</span>

<span class="k">let</span> <span class="n">map</span> <span class="o">=</span> <span class="s2">&quot;a map of the world&quot;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%b</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span>
       <span class="o">~</span><span class="n">rex</span><span class="o">:(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="o">~</span><span class="n">flags</span><span class="o">:[`</span><span class="nc">DOTALL</span><span class="o">]</span> <span class="s2">&quot;^(?:(?!waldo).)*$&quot;</span><span class="o">)</span>
       <span class="n">map</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span>
        <span class="o">~</span><span class="n">rex</span><span class="o">:(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="o">~</span><span class="n">flags</span><span class="o">:[`</span><span class="nc">DOTALL</span><span class="o">;</span> <span class="o">`</span><span class="nc">EXTENDED</span><span class="o">]</span> <span class="s2">&quot;</span>
<span class="s2">        ^                   # start of string</span>
<span class="s2">        (?:                 # non-capturing grouper</span>
<span class="s2">            (?!             # look ahead negation</span>
<span class="s2">                waldo       # is he ahead of us now?</span>
<span class="s2">            )               # is so, the negation failed</span>
<span class="s2">            .               # any character (cuzza /s)</span>
<span class="s2">        ) *                 # repeat that grouping 0 or more</span>
<span class="s2">        $                   # through the end of the string</span>
<span class="s2">      &quot;</span><span class="o">)</span> <span class="n">map</span><span class="o">)</span>
  <span class="k">then</span> <span class="n">print_endline</span> <span class="s2">&quot;There&#39;s no waldo here!&quot;</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">%</span> <span class="n">w</span> <span class="o">|</span> <span class="n">minigrep</span> <span class="k">&#39;</span><span class="o">^(?!.*</span><span class="n">ttyp</span><span class="o">).*</span><span class="n">tchrist&#39;</span>

<span class="c">(*-----------------------------*)</span>

<span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="o">~</span><span class="n">flags</span><span class="o">:[`</span><span class="nc">EXTENDED</span><span class="o">]</span> <span class="s2">&quot;</span>
<span class="s2">    ^                       # anchored to the start</span>
<span class="s2">    (?!                     # zero-width look-ahead assertion</span>
<span class="s2">        .*                  # any amount of anything (faster than .*?)</span>
<span class="s2">        ttyp                # the string you don&#39;t want to find</span>
<span class="s2">    )                       # end look-ahead negation; rewind to start</span>
<span class="s2">    .*                      # any amount of anything (faster than .*?)</span>
<span class="s2">    tchrist                 # now try to find Tom</span>
<span class="s2">&quot;</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">%</span> <span class="n">w</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">tchrist</span> <span class="o">|</span> <span class="n">grep</span> <span class="o">-</span><span class="n">v</span> <span class="n">ttyp</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">%</span> <span class="n">grep</span> <span class="o">-</span><span class="n">i</span> <span class="k">&#39;</span><span class="n">pattern&#39;</span> <span class="n">files</span>
<span class="o">%</span> <span class="n">minigrep</span> <span class="k">&#39;</span><span class="o">(?</span><span class="n">i</span><span class="o">)</span><span class="n">pattern&#39;</span> <span class="n">files</span>

<span class="c">(* @@PLEAC@@_6.18 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="c">(* Regexp text for an EUC-JP character *)</span>
<span class="k">let</span> <span class="n">eucjp</span> <span class="o">=</span>
  <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">|&quot;</span>
     <span class="c">(* EUC-JP encoding subcomponents: *)</span>
     <span class="o">[</span>
       <span class="c">(* ASCII/JIS-Roman (one-byte/character) *)</span>
       <span class="s2">&quot;[</span><span class="se">\x00</span><span class="s2">-</span><span class="se">\x7F</span><span class="s2">]&quot;</span><span class="o">;</span>

       <span class="c">(* half-width katakana (two bytes/char) *)</span>
       <span class="s2">&quot;</span><span class="se">\x8E</span><span class="s2">[</span><span class="se">\xA0</span><span class="s2">-</span><span class="se">\xDF</span><span class="s2">]&quot;</span><span class="o">;</span>

       <span class="c">(* JIS X 0212-1990 (three bytes/char) *)</span>
       <span class="s2">&quot;</span><span class="se">\x8F</span><span class="s2">[</span><span class="se">\xA1</span><span class="s2">-</span><span class="se">\xFE</span><span class="s2">][</span><span class="se">\xA1</span><span class="s2">-</span><span class="se">\xFE</span><span class="s2">]&quot;</span><span class="o">;</span>

       <span class="c">(* JIS X 0208:1997 (two bytes/char) *)</span>
       <span class="s2">&quot;[</span><span class="se">\xA1</span><span class="s2">-</span><span class="se">\xFE</span><span class="s2">][</span><span class="se">\xA1</span><span class="s2">-</span><span class="se">\xFE</span><span class="s2">]&quot;</span><span class="o">;</span>
     <span class="o">])</span>

<span class="c">(* Match any number of EUC-JP characters preceding Tokyo *)</span>
<span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="o">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">(</span><span class="se">\\</span><span class="s2">(&quot;</span> <span class="o">^</span> <span class="n">eucjp</span> <span class="o">^</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">)*</span><span class="se">\\</span><span class="s2">)</span><span class="se">\\</span><span class="s2">(</span><span class="se">\xC5\xEC\xB5\xFE\\</span><span class="s2">)&quot;</span><span class="o">)</span>

<span class="c">(* Search from the beginning for a match *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">regexp</span> <span class="kt">string</span> <span class="mi">0</span>
  <span class="k">then</span> <span class="n">print_endline</span> <span class="s2">&quot;Found Tokyo&quot;</span>

<span class="c">(* Replace Tokyo with Osaka *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">create</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="kt">string</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">start</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="k">while</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">regexp</span> <span class="kt">string</span> <span class="o">!</span><span class="n">start</span> <span class="k">do</span>
    <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_string</span> <span class="n">buffer</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">1</span> <span class="kt">string</span><span class="o">);</span>
    <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_string</span> <span class="n">buffer</span> <span class="n">osaka</span><span class="o">;</span> <span class="c">(* Assuming osaka is defined *)</span>
    <span class="n">start</span> <span class="o">:=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">match_end</span> <span class="bp">()</span><span class="o">;</span>
  <span class="k">done</span><span class="o">;</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">start</span> <span class="o">&lt;</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="kt">string</span>
  <span class="k">then</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_substring</span> <span class="n">buffer</span> <span class="kt">string</span>
    <span class="o">!</span><span class="n">start</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="kt">string</span> <span class="o">-</span> <span class="o">!</span><span class="n">start</span><span class="o">);</span>
  <span class="n">print_endline</span> <span class="o">(</span><span class="nn">Buffer</span><span class="p">.</span><span class="n">contents</span> <span class="n">buffer</span><span class="o">)</span>

<span class="c">(* Split a multi-byte string into characters *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* One character per list element *)</span>
  <span class="k">let</span> <span class="n">chars</span> <span class="o">=</span>
    <span class="nn">Array</span><span class="p">.</span><span class="n">map</span>
      <span class="o">(</span><span class="k">function</span>
         <span class="o">|</span> <span class="nn">Str</span><span class="p">.</span><span class="nc">Delim</span> <span class="n">c</span> <span class="o">-&gt;</span> <span class="n">c</span>
         <span class="o">|</span> <span class="nn">Str</span><span class="p">.</span><span class="nc">Text</span> <span class="n">c</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="o">(</span><span class="s2">&quot;invalid char: &quot;</span> <span class="o">^</span> <span class="n">c</span><span class="o">))</span>
      <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">of_list</span>
         <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">full_split</span>
            <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="n">eucjp</span><span class="o">)</span>
            <span class="kt">string</span><span class="o">))</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">length</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">chars</span> <span class="k">in</span>
  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">to</span> <span class="n">length</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">do</span>
    <span class="k">if</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">chars</span><span class="o">.(</span><span class="n">i</span><span class="o">)</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">then</span>
      <span class="k">begin</span>
        <span class="c">(* Do something interesting with this one-byte character *)</span>
      <span class="k">end</span>
    <span class="k">else</span>
      <span class="k">begin</span>
        <span class="c">(* Do something interesting with this multi-byte character *)</span>
      <span class="k">end</span>
  <span class="k">done</span><span class="o">;</span>
  <span class="c">(* Glue list back together *)</span>
  <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="n">chars</span><span class="o">)</span> <span class="k">in</span>
  <span class="n">print_endline</span> <span class="n">line</span>

<span class="c">(* Determine if an entire string is valid EUC-JP *)</span>
<span class="k">let</span> <span class="n">is_eucjp</span> <span class="n">s</span> <span class="o">=</span>
  <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span>
    <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="o">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">(&quot;</span> <span class="o">^</span> <span class="n">eucjp</span> <span class="o">^</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">)*$&quot;</span><span class="o">))</span> <span class="n">s</span> <span class="mi">0</span>

<span class="c">(* Assuming a similar string has been defined for Shift-JIS *)</span>
<span class="k">let</span> <span class="n">is_sjis</span> <span class="n">s</span> <span class="o">=</span>
  <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span>
    <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="o">(</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">(&quot;</span> <span class="o">^</span> <span class="n">sjis</span> <span class="o">^</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">)*$&quot;</span><span class="o">))</span> <span class="n">s</span> <span class="mi">0</span>

<span class="c">(* Convert from EUC-JP to Unicode, assuming a Hashtbl named</span>
<span class="c">   euc2uni is defined with the appropriate character mappings *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">chars</span> <span class="o">=</span>
    <span class="nn">Array</span><span class="p">.</span><span class="n">map</span>
      <span class="o">(</span><span class="k">function</span>
         <span class="o">|</span> <span class="nn">Str</span><span class="p">.</span><span class="nc">Delim</span> <span class="n">c</span> <span class="o">-&gt;</span> <span class="n">c</span>
         <span class="o">|</span> <span class="nn">Str</span><span class="p">.</span><span class="nc">Text</span> <span class="n">c</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="o">(</span><span class="s2">&quot;invalid char: &quot;</span> <span class="o">^</span> <span class="n">c</span><span class="o">))</span>
      <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">of_list</span>
         <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">full_split</span>
            <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="n">eucjp</span><span class="o">)</span>
            <span class="kt">string</span><span class="o">))</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">length</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">chars</span> <span class="k">in</span>
  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">to</span> <span class="n">length</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">do</span>
    <span class="k">if</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">mem</span> <span class="n">euc2uni</span> <span class="n">chars</span><span class="o">.(</span><span class="n">i</span><span class="o">)</span>
    <span class="k">then</span>
      <span class="k">begin</span>
        <span class="n">chars</span><span class="o">.(</span><span class="n">i</span><span class="o">)</span> <span class="o">&lt;-</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">euc2uni</span> <span class="n">chars</span><span class="o">.(</span><span class="n">i</span><span class="o">))</span>
      <span class="k">end</span>
    <span class="k">else</span>
      <span class="k">begin</span>
        <span class="c">(* deal with unknown EUC-&gt;Unicode mapping here *)</span>
      <span class="k">end</span>
  <span class="k">done</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="n">chars</span><span class="o">)</span> <span class="k">in</span>
  <span class="n">print_endline</span> <span class="n">line</span>

<span class="c">(* @@PLEAC@@_6.19 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="c">(* Not foolproof, but works in most common cases. *)</span>
<span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span>
  <span class="nn">Str</span><span class="p">.</span><span class="n">regexp_case_fold</span>
    <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">b[A-Z0-9._%+-]+@[A-Z0-9.-]+</span><span class="se">\\</span><span class="s2">.[A-Z][A-Z][A-Z]?[A-Z]?</span><span class="se">\\</span><span class="s2">b&quot;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="n">print_string</span> <span class="s2">&quot;Email: &quot;</span><span class="o">;</span>
      <span class="n">flush</span> <span class="n">stdout</span><span class="o">;</span>
      <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">stdin</span> <span class="k">in</span>
      <span class="k">try</span>
        <span class="k">let</span> <span class="n">start</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
        <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
          <span class="n">start</span> <span class="o">:=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span> <span class="n">regexp</span> <span class="n">line</span> <span class="o">!</span><span class="n">start</span><span class="o">;</span>
          <span class="k">let</span> <span class="kt">string</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">matched_string</span> <span class="n">line</span> <span class="k">in</span>
          <span class="n">start</span> <span class="o">:=</span> <span class="o">!</span><span class="n">start</span> <span class="o">+</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="kt">string</span><span class="o">;</span>
          <span class="n">print_string</span> <span class="s2">&quot;Found: &quot;</span><span class="o">;</span>
          <span class="n">print_endline</span> <span class="kt">string</span><span class="o">;</span>
        <span class="k">done</span>
      <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">()</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span>

<span class="c">(* @@PLEAC@@_6.20 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="n">print_string</span> <span class="s2">&quot;Action: &quot;</span><span class="o">;</span>
      <span class="n">flush</span> <span class="n">stdout</span><span class="o">;</span>
      <span class="k">let</span> <span class="n">answer</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">stdin</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp_string_case_fold</span> <span class="n">answer</span> <span class="k">in</span>
      <span class="k">if</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">regexp</span> <span class="s2">&quot;SEND&quot;</span> <span class="mi">0</span>
      <span class="k">then</span> <span class="n">print_endline</span> <span class="s2">&quot;Action is send&quot;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">regexp</span> <span class="s2">&quot;STOP&quot;</span> <span class="mi">0</span>
      <span class="k">then</span> <span class="n">print_endline</span> <span class="s2">&quot;Action is stop&quot;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">regexp</span> <span class="s2">&quot;ABORT&quot;</span> <span class="mi">0</span>
      <span class="k">then</span> <span class="n">print_endline</span> <span class="s2">&quot;Action is abort&quot;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">regexp</span> <span class="s2">&quot;LIST&quot;</span> <span class="mi">0</span>
      <span class="k">then</span> <span class="n">print_endline</span> <span class="s2">&quot;Action is list&quot;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">regexp</span> <span class="s2">&quot;EDIT&quot;</span> <span class="mi">0</span>
      <span class="k">then</span> <span class="n">print_endline</span> <span class="s2">&quot;Action is edit&quot;</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* assumes that invoke_editor, deliver_message, *)</span>
<span class="c">(* file and pager are defined somewhere else. *)</span>
<span class="k">let</span> <span class="n">actions</span> <span class="o">=</span>
  <span class="o">[</span>
    <span class="s2">&quot;edit&quot;</span><span class="o">,</span> <span class="n">invoke_editor</span><span class="o">;</span>
    <span class="s2">&quot;send&quot;</span><span class="o">,</span> <span class="n">deliver_message</span><span class="o">;</span>
    <span class="s2">&quot;list&quot;</span><span class="o">,</span> <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="n">ignore</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="n">command</span> <span class="o">(</span><span class="n">pager</span> <span class="o">^</span> <span class="s2">&quot; &quot;</span> <span class="o">^</span> <span class="n">file</span><span class="o">)));</span>
    <span class="s2">&quot;abort&quot;</span><span class="o">,</span> <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="n">print_endline</span> <span class="s2">&quot;See ya!&quot;</span><span class="o">;</span> <span class="n">exit</span> <span class="mi">0</span><span class="o">);</span>
  <span class="o">]</span>

<span class="k">let</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="n">print_string</span> <span class="s2">&quot;Action: &quot;</span><span class="o">;</span>
      <span class="n">flush</span> <span class="n">stdout</span><span class="o">;</span>
      <span class="k">let</span> <span class="n">answer</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">stdin</span> <span class="k">in</span>
      <span class="c">(* trim leading white space *)</span>
      <span class="k">let</span> <span class="n">answer</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;^[ </span><span class="se">\t</span><span class="s2">]+&quot;</span><span class="o">)</span> <span class="s2">&quot;&quot;</span> <span class="n">answer</span> <span class="k">in</span>
      <span class="c">(* trim trailing white space *)</span>
      <span class="k">let</span> <span class="n">answer</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[ </span><span class="se">\t</span><span class="s2">]+$&quot;</span><span class="o">)</span> <span class="s2">&quot;&quot;</span> <span class="n">answer</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp_string_case_fold</span> <span class="n">answer</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">found</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span> <span class="k">in</span>
      <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
        <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">action</span><span class="o">,</span> <span class="n">handler</span><span class="o">)</span> <span class="o">-&gt;</span>
           <span class="k">if</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">regexp</span> <span class="n">action</span> <span class="mi">0</span>
           <span class="k">then</span> <span class="o">(</span><span class="n">found</span> <span class="o">:=</span> <span class="bp">true</span><span class="o">;</span> <span class="n">handler</span> <span class="bp">()</span><span class="o">))</span>
        <span class="n">actions</span><span class="o">;</span>
      <span class="k">if</span> <span class="n">not</span> <span class="o">!</span><span class="n">found</span>
      <span class="k">then</span> <span class="o">(</span><span class="n">incr</span> <span class="n">errors</span><span class="o">;</span> <span class="n">print_endline</span> <span class="o">(</span><span class="s2">&quot;Unknown command: &quot;</span> <span class="o">^</span> <span class="n">answer</span><span class="o">))</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span>

<span class="c">(* @@PLEAC@@_6.21 *)</span>
<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* urlify - wrap HTML links around URL-like constructs *)</span>
<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+pcre&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;pcre.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">urls</span> <span class="o">=</span> <span class="s2">&quot;(http|telnet|gopher|file|wais|ftp)&quot;</span>
<span class="k">let</span> <span class="n">ltrs</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">w&quot;</span>
<span class="k">let</span> <span class="n">gunk</span> <span class="o">=</span> <span class="s2">&quot;/#~:.?+=&amp;%@!</span><span class="se">\\</span><span class="s2">-&quot;</span>
<span class="k">let</span> <span class="n">punc</span> <span class="o">=</span> <span class="s2">&quot;.:?</span><span class="se">\\</span><span class="s2">-&quot;</span>
<span class="k">let</span> <span class="n">any</span>  <span class="o">=</span> <span class="n">ltrs</span> <span class="o">^</span> <span class="n">gunk</span> <span class="o">^</span> <span class="n">punc</span>

<span class="k">let</span> <span class="n">rex</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="o">~</span><span class="n">flags</span><span class="o">:[`</span><span class="nc">CASELESS</span><span class="o">;</span> <span class="o">`</span><span class="nc">EXTENDED</span><span class="o">]</span>
  <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;</span>
<span class="s2">      </span><span class="se">\\</span><span class="s2">b                   # start at word boundary</span>
<span class="s2">      (                     # begin $1  {</span>
<span class="s2">       %s        :          # need resource and a colon</span>
<span class="s2">       [%s] +?              # followed by one or more</span>
<span class="s2">                            #  of any valid character, but</span>
<span class="s2">                            #  be conservative and take only</span>
<span class="s2">                            #  what you need to....</span>
<span class="s2">      )                     # end   $1  }</span>
<span class="s2">      (?=                   # look-ahead non-consumptive assertion</span>
<span class="s2">       [%s]*                # either 0 or more punctuation</span>
<span class="s2">       [^%s]                #   followed by a non-url char</span>
<span class="s2">       |                    # or else</span>
<span class="s2">       $                    #   then end of the string</span>
<span class="s2">      )</span>
<span class="s2">&quot;</span> <span class="n">urls</span> <span class="n">any</span> <span class="n">punc</span> <span class="n">any</span><span class="o">)</span>

<span class="k">let</span> <span class="n">templ</span> <span class="o">=</span> <span class="s2">&quot;&lt;A HREF=</span><span class="se">\&quot;</span><span class="s2">$1</span><span class="se">\&quot;</span><span class="s2">&gt;$1&lt;/A&gt;&quot;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">stdin</span> <span class="k">in</span>
      <span class="n">print_endline</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">replace</span> <span class="o">~</span><span class="n">rex</span> <span class="o">~</span><span class="n">templ</span> <span class="n">line</span><span class="o">)</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
    <span class="bp">()</span>

<span class="c">(* @@PLEAC@@_6.22 *)</span>
<span class="o">%</span> <span class="n">tcgrep</span> <span class="o">-</span><span class="n">ril</span> <span class="k">&#39;</span><span class="o">^</span><span class="nc">From</span><span class="o">:</span> <span class="o">.*</span><span class="n">kate&#39;</span> <span class="o">~/</span><span class="n">mail</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* tcgrep: rewrite of tom christiansen&#39;s rewrite of grep *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="c">(* http://ocaml.info/home/ocaml_sources.html#pcre-ocaml *)</span>
<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+pcre&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;pcre.cma&quot;</span><span class="o">;;</span>

<span class="c">(* http://alain.frisch.fr/soft.html#Getopt *)</span>
<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+getopt&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;getopt.cma&quot;</span><span class="o">;;</span>

<span class="c">(* Initialize globals. *)</span>
<span class="k">let</span> <span class="n">me</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">replace</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;.*/&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span>
<span class="k">let</span> <span class="n">matches</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>
<span class="k">let</span> <span class="n">errors</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>
<span class="k">let</span> <span class="n">grand_total</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>
<span class="k">let</span> <span class="n">mult</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span>
<span class="k">let</span> <span class="n">compress</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;.z&quot;</span><span class="o">,</span> <span class="s2">&quot;zcat&quot;</span><span class="o">;</span> <span class="s2">&quot;.gz&quot;</span><span class="o">,</span> <span class="s2">&quot;zcat&quot;</span><span class="o">;</span> <span class="s2">&quot;.Z&quot;</span><span class="o">,</span> <span class="s2">&quot;zcat&quot;</span><span class="o">]</span>

<span class="c">(* Prints usage and exits. *)</span>
<span class="k">let</span> <span class="n">usage</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;usage: %s [flags] [files]</span>

<span class="s2">Standard grep options:</span>
<span class="s2">        i   case insensitive</span>
<span class="s2">        n   number lines</span>
<span class="s2">        c   give count of lines matching</span>
<span class="s2">        C   ditto, but &gt;1 match per line possible</span>
<span class="s2">        w   word boundaries only</span>
<span class="s2">        s   silent mode</span>
<span class="s2">        x   exact matches only</span>
<span class="s2">        v   invert search sense (lines that DON&#39;T match)</span>
<span class="s2">        h   hide filenames</span>
<span class="s2">        e   expression (for exprs beginning with -)</span>
<span class="s2">        f   file with expressions</span>
<span class="s2">        l   list filenames matching</span>

<span class="s2">Specials:</span>
<span class="s2">        1   1 match per file</span>
<span class="s2">        H   highlight matches</span>
<span class="s2">        u   underline matches</span>
<span class="s2">        r   recursive on directories or dot if none</span>
<span class="s2">        t   process directories in &#39;ls -t&#39; order</span>
<span class="s2">        p   paragraph mode (default: line mode)</span>
<span class="s2">        P   ditto, but specify separator, e.g. -P &#39;%%&#39;</span>
<span class="s2">        a   all files, not just plain text files (not implemented)</span>
<span class="s2">        q   quiet about failed file and dir opens</span>
<span class="s2">        T   trace files as opened</span>

<span class="s2">May use a TCGREP environment variable to set default options.</span>
<span class="s2">&quot;</span> <span class="n">me</span><span class="o">;</span>
  <span class="n">exit</span> <span class="mi">255</span>

<span class="c">(* Produces a stream of lines from an input channel. *)</span>
<span class="k">let</span> <span class="n">line_stream_of_channel</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">channel</span><span class="o">)</span> <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="nc">None</span><span class="o">)</span>

<span class="c">(* Produces a stream of chunks from an input channel given a delimiter. *)</span>
<span class="k">let</span> <span class="n">delimited_stream_of_channel</span> <span class="n">delim</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">line_stream_of_channel</span> <span class="n">channel</span> <span class="k">in</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">next</span> <span class="n">para_lines</span> <span class="n">i</span> <span class="o">=</span>
    <span class="k">match</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">peek</span> <span class="n">lines</span><span class="o">,</span> <span class="n">para_lines</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">None</span><span class="o">,</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="nc">None</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">delim&#39;</span><span class="o">,</span> <span class="bp">[]</span> <span class="k">when</span> <span class="n">delim&#39;</span> <span class="o">=</span> <span class="n">delim</span> <span class="o">-&gt;</span>
          <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">lines</span><span class="o">;</span> <span class="n">next</span> <span class="n">para_lines</span> <span class="n">i</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">delim&#39;</span><span class="o">,</span> <span class="o">_</span> <span class="k">when</span> <span class="n">delim&#39;</span> <span class="o">=</span> <span class="n">delim</span> <span class="o">-&gt;</span>
          <span class="nc">Some</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="n">para_lines</span><span class="o">))</span>
      <span class="o">|</span> <span class="nc">None</span><span class="o">,</span> <span class="o">_</span> <span class="o">-&gt;</span>
          <span class="nc">Some</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="n">para_lines</span><span class="o">))</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">line</span><span class="o">,</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">lines</span><span class="o">;</span> <span class="n">next</span> <span class="o">(</span><span class="n">line</span> <span class="o">::</span> <span class="n">para_lines</span><span class="o">)</span> <span class="n">i</span> <span class="k">in</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span> <span class="o">(</span><span class="n">next</span> <span class="bp">[]</span><span class="o">)</span>

<span class="c">(* An empty delimiter corresponds to an empty line, so we can create</span>
<span class="c">   a paragraph stream in terms of the previous function. *)</span>
<span class="k">let</span> <span class="n">paragraph_stream_of_channel</span> <span class="o">=</span> <span class="n">delimited_stream_of_channel</span> <span class="s2">&quot;&quot;</span>

<span class="c">(* By default, the stream builder will produce lines. This can be changed</span>
<span class="c">   by the -p and -P options. *)</span>
<span class="k">let</span> <span class="n">stream_of_channel</span> <span class="o">=</span> <span class="n">ref</span> <span class="n">line_stream_of_channel</span>

<span class="c">(* Type for command-line options and their values. *)</span>
<span class="k">type</span> <span class="n">opt</span> <span class="o">=</span> <span class="nc">OBool</span> <span class="k">of</span> <span class="kt">bool</span> <span class="o">|</span> <span class="nc">OStr</span> <span class="k">of</span> <span class="kt">string</span>

<span class="c">(* Set an option. *)</span>
<span class="k">let</span> <span class="n">opt_set</span> <span class="n">opt</span> <span class="n">c</span> <span class="o">=</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">opt</span> <span class="n">c</span> <span class="o">(</span><span class="nc">OBool</span> <span class="bp">true</span><span class="o">)</span>

<span class="c">(* Test an option. *)</span>
<span class="k">let</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="n">c</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">match</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">opt</span> <span class="n">c</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">OBool</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">b</span>
      <span class="o">|</span> <span class="nc">OStr</span> <span class="s2">&quot;&quot;</span> <span class="o">-&gt;</span> <span class="bp">false</span>
      <span class="o">|</span> <span class="nc">OStr</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">true</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
    <span class="bp">false</span>

<span class="c">(* Convert an option to a string. *)</span>
<span class="k">let</span> <span class="n">opt_str</span> <span class="n">opt</span> <span class="n">c</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">match</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">opt</span> <span class="n">c</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">OBool</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">string_of_bool</span> <span class="n">b</span>
      <span class="o">|</span> <span class="nc">OStr</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
    <span class="s2">&quot;&quot;</span>

<span class="c">(* Gets terminal escape characters. *)</span>
<span class="k">let</span> <span class="n">tput</span> <span class="n">cap</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">ch</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_in</span> <span class="o">(</span><span class="s2">&quot;tput &quot;</span> <span class="o">^</span> <span class="n">cap</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">try</span>
    <span class="k">let</span> <span class="n">result</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">ch</span> <span class="k">in</span>
    <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_in</span> <span class="n">ch</span><span class="o">);</span>
    <span class="n">result</span>
  <span class="k">with</span>
    <span class="o">|</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
        <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_in</span> <span class="n">ch</span><span class="o">);</span>
        <span class="s2">&quot;&quot;</span>
    <span class="o">|</span> <span class="n">e</span> <span class="o">-&gt;</span>
        <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_in</span> <span class="n">ch</span><span class="o">);</span>
        <span class="k">raise</span> <span class="n">e</span>

<span class="c">(* Splits a filename into its base and extension. *)</span>
<span class="k">let</span> <span class="n">splitext</span> <span class="n">name</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">let</span> <span class="n">base</span> <span class="o">=</span> <span class="nn">Filename</span><span class="p">.</span><span class="n">chop_extension</span> <span class="n">name</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">i</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">base</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">ext</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">name</span> <span class="n">i</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">name</span> <span class="o">-</span> <span class="n">i</span><span class="o">)</span> <span class="k">in</span>
    <span class="n">base</span><span class="o">,</span> <span class="n">ext</span>
  <span class="k">with</span> <span class="nc">Invalid_argument</span> <span class="o">_</span> <span class="o">-&gt;</span>
    <span class="n">name</span><span class="o">,</span> <span class="s2">&quot;&quot;</span>

<span class="c">(* Parses command-line arguments. *)</span>
<span class="k">let</span> <span class="n">parse_args</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">opt</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">args</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>

  <span class="k">let</span> <span class="n">optstring</span> <span class="o">=</span> <span class="s2">&quot;incCwsxvhe:f:l1HurtpP:aqT&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">optstream</span> <span class="o">=</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">of_string</span> <span class="n">optstring</span> <span class="k">in</span>

  <span class="c">(* Prepare options for Getopt. *)</span>
  <span class="k">let</span> <span class="n">opts</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">str_setter</span> <span class="n">c</span> <span class="o">=</span>
      <span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="nn">Getopt</span><span class="p">.</span><span class="n">nolong</span><span class="o">,</span>
       <span class="nc">None</span><span class="o">,</span>
       <span class="nc">Some</span> <span class="o">(</span><span class="k">fun</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">opt</span> <span class="n">c</span> <span class="o">(</span><span class="nc">OStr</span> <span class="n">s</span><span class="o">)))</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">int_setter</span> <span class="n">c</span> <span class="o">=</span>
      <span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="nn">Getopt</span><span class="p">.</span><span class="n">nolong</span><span class="o">,</span>
       <span class="nc">Some</span> <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">opt</span> <span class="n">c</span> <span class="o">(</span><span class="nc">OBool</span> <span class="bp">true</span><span class="o">)),</span>
       <span class="nc">None</span><span class="o">)</span> <span class="k">in</span>
    <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span> <span class="n">acc</span> <span class="o">=</span>
      <span class="k">match</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">peek</span> <span class="n">optstream</span> <span class="k">with</span>
        <span class="o">|</span> <span class="nc">Some</span> <span class="n">c</span> <span class="o">-&gt;</span>
            <span class="o">(</span><span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">optstream</span><span class="o">;</span>
             <span class="k">match</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">peek</span> <span class="n">optstream</span> <span class="k">with</span>
               <span class="o">|</span> <span class="nc">Some</span> <span class="sc">&#39;:&#39;</span> <span class="o">-&gt;</span>
                   <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">optstream</span><span class="o">;</span>
                   <span class="n">loop</span> <span class="o">(</span><span class="n">str_setter</span> <span class="n">c</span> <span class="o">::</span> <span class="n">acc</span><span class="o">)</span>
               <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span>
                   <span class="n">loop</span> <span class="o">(</span><span class="n">int_setter</span> <span class="n">c</span> <span class="o">::</span> <span class="n">acc</span><span class="o">))</span>
        <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="n">acc</span> <span class="k">in</span>
    <span class="n">loop</span> <span class="bp">[]</span> <span class="k">in</span>

  <span class="c">(* Handle TCGREP environment variable. *)</span>
  <span class="k">let</span> <span class="n">cmdline</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">))</span> <span class="k">in</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">env</span> <span class="o">-&gt;</span>
       <span class="k">if</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">env</span> <span class="o">&gt;</span> <span class="mi">7</span>
           <span class="o">&amp;&amp;</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">env</span> <span class="mi">0</span> <span class="mi">7</span> <span class="o">=</span> <span class="s2">&quot;TCGREP=&quot;</span><span class="o">)</span>
       <span class="k">then</span>
         <span class="k">begin</span>
           <span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">env</span> <span class="mi">7</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">env</span> <span class="o">-</span> <span class="mi">7</span><span class="o">)</span> <span class="k">in</span>
           <span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="k">if</span> <span class="n">s</span><span class="o">.[</span><span class="mi">0</span><span class="o">]</span> <span class="o">&lt;&gt;</span> <span class="sc">&#39;-&#39;</span> <span class="k">then</span> <span class="s2">&quot;-&quot;</span> <span class="o">^</span> <span class="n">s</span> <span class="k">else</span> <span class="n">s</span> <span class="k">in</span>
           <span class="n">cmdline</span> <span class="o">:=</span> <span class="n">s</span> <span class="o">::</span> <span class="o">!</span><span class="n">cmdline</span>
         <span class="k">end</span><span class="o">)</span>
    <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">environment</span> <span class="bp">()</span><span class="o">);</span>
  <span class="k">let</span> <span class="n">cmdline</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">of_list</span> <span class="o">!</span><span class="n">cmdline</span> <span class="k">in</span>

  <span class="c">(* Parse command-line options using Getopt. *)</span>
  <span class="k">begin</span>
    <span class="k">try</span>
      <span class="nn">Getopt</span><span class="p">.</span><span class="n">parse</span>
        <span class="n">opts</span> <span class="o">(</span><span class="k">fun</span> <span class="n">arg</span> <span class="o">-&gt;</span> <span class="n">args</span> <span class="o">:=</span> <span class="n">arg</span> <span class="o">::</span> <span class="o">!</span><span class="n">args</span><span class="o">)</span>
        <span class="n">cmdline</span> <span class="mi">0</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">cmdline</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);</span>
      <span class="n">args</span> <span class="o">:=</span> <span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="o">!</span><span class="n">args</span>
    <span class="k">with</span> <span class="nn">Getopt</span><span class="p">.</span><span class="nc">Error</span> <span class="n">e</span> <span class="o">-&gt;</span>
      <span class="n">prerr_endline</span> <span class="n">e</span><span class="o">;</span>
      <span class="n">usage</span> <span class="bp">()</span>
  <span class="k">end</span><span class="o">;</span>

  <span class="c">(* Read patterns from file or command line. *)</span>
  <span class="k">let</span> <span class="n">patterns</span> <span class="o">=</span>
    <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;f&#39;</span>
    <span class="k">then</span>
      <span class="k">begin</span>
        <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span>
          <span class="k">try</span> <span class="n">open_in</span> <span class="o">(</span><span class="n">opt_str</span> <span class="n">opt</span> <span class="sc">&#39;f&#39;</span><span class="o">)</span>
          <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span>
            <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s: can&#39;t open %s: %s</span><span class="se">\n</span><span class="s2">&quot;</span>
              <span class="n">me</span> <span class="o">(</span><span class="n">opt_str</span> <span class="n">opt</span> <span class="sc">&#39;f&#39;</span><span class="o">)</span> <span class="o">(</span><span class="nn">Printexc</span><span class="p">.</span><span class="n">to_string</span> <span class="n">e</span><span class="o">);</span>
            <span class="n">exit</span> <span class="mi">255</span> <span class="k">in</span>
        <span class="k">try</span>
          <span class="k">let</span> <span class="n">acc</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
          <span class="nn">Stream</span><span class="p">.</span><span class="n">iter</span>
            <span class="o">(</span><span class="k">fun</span> <span class="n">pat</span> <span class="o">-&gt;</span> <span class="n">acc</span> <span class="o">:=</span> <span class="n">pat</span> <span class="o">::</span> <span class="o">!</span><span class="n">acc</span><span class="o">)</span>
            <span class="o">(</span><span class="n">line_stream_of_channel</span> <span class="n">in_channel</span><span class="o">);</span>
          <span class="n">close_in</span> <span class="n">in_channel</span><span class="o">;</span>
          <span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="o">!</span><span class="n">acc</span>
        <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span>
          <span class="n">close_in</span> <span class="n">in_channel</span><span class="o">;</span>
          <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s: error reading %s: %s</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">me</span> <span class="o">(</span><span class="n">opt_str</span> <span class="n">opt</span> <span class="sc">&#39;f&#39;</span><span class="o">)</span> <span class="o">(</span><span class="nn">Printexc</span><span class="p">.</span><span class="n">to_string</span> <span class="n">e</span><span class="o">);</span>
          <span class="n">exit</span> <span class="mi">255</span>
      <span class="k">end</span>
    <span class="k">else</span> <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;e&#39;</span>
    <span class="k">then</span> <span class="o">[</span><span class="n">opt_str</span> <span class="n">opt</span> <span class="sc">&#39;e&#39;</span><span class="o">]</span>
    <span class="k">else</span> <span class="o">[</span><span class="k">match</span> <span class="o">!</span><span class="n">args</span> <span class="k">with</span> <span class="n">h</span> <span class="o">::</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">args</span> <span class="o">:=</span> <span class="n">t</span><span class="o">;</span> <span class="n">h</span><span class="o">)</span> <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="n">usage</span> <span class="bp">()</span><span class="o">]</span> <span class="k">in</span>

  <span class="c">(* Terminal escape characters for highlighting options. *)</span>
  <span class="k">let</span> <span class="n">highlight</span> <span class="o">=</span>
    <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;H&#39;</span>
    <span class="k">then</span> <span class="n">tput</span> <span class="s2">&quot;smso&quot;</span> <span class="o">^</span> <span class="s2">&quot;$1&quot;</span> <span class="o">^</span> <span class="n">tput</span> <span class="s2">&quot;rmso&quot;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;u&#39;</span>
    <span class="k">then</span> <span class="n">tput</span> <span class="s2">&quot;smul&quot;</span> <span class="o">^</span> <span class="s2">&quot;$1&quot;</span> <span class="o">^</span> <span class="n">tput</span> <span class="s2">&quot;rmul&quot;</span>
    <span class="k">else</span> <span class="s2">&quot;$1&quot;</span> <span class="k">in</span>

  <span class="c">(* Regular expression flags to use. *)</span>
  <span class="k">let</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;i&#39;</span> <span class="k">then</span> <span class="n">flags</span> <span class="o">:=</span> <span class="o">`</span><span class="nc">CASELESS</span> <span class="o">::</span> <span class="o">!</span><span class="n">flags</span><span class="o">;</span>

  <span class="c">(* Options for paragraph modes. *)</span>
  <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;p&#39;</span>
  <span class="k">then</span> <span class="n">stream_of_channel</span> <span class="o">:=</span> <span class="n">paragraph_stream_of_channel</span><span class="o">;</span>
  <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;P&#39;</span>
  <span class="k">then</span> <span class="n">stream_of_channel</span> <span class="o">:=</span> <span class="n">delimited_stream_of_channel</span> <span class="o">(</span><span class="n">opt_str</span> <span class="n">opt</span> <span class="sc">&#39;P&#39;</span><span class="o">);</span>

  <span class="c">(* Word boundary option. *)</span>
  <span class="k">let</span> <span class="n">patterns</span> <span class="o">=</span>
    <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;w&#39;</span>
    <span class="k">then</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">pat</span> <span class="o">-&gt;</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">b&quot;</span> <span class="o">^</span> <span class="n">pat</span> <span class="o">^</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">b&quot;</span><span class="o">)</span> <span class="n">patterns</span>
    <span class="k">else</span> <span class="n">patterns</span> <span class="k">in</span>

  <span class="c">(* Exact match option. *)</span>
  <span class="k">let</span> <span class="n">patterns</span> <span class="o">=</span>
    <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;x&#39;</span>
    <span class="k">then</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">pat</span> <span class="o">-&gt;</span> <span class="s2">&quot;^&quot;</span> <span class="o">^</span> <span class="n">pat</span> <span class="o">^</span> <span class="s2">&quot;$&quot;</span><span class="o">)</span> <span class="n">patterns</span>
    <span class="k">else</span> <span class="n">patterns</span> <span class="k">in</span>

  <span class="c">(* Options that imply other options. *)</span>
  <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;l&#39;</span> <span class="k">then</span> <span class="n">opt_set</span> <span class="n">opt</span> <span class="sc">&#39;1&#39;</span><span class="o">;</span>
  <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;u&#39;</span> <span class="k">then</span> <span class="n">opt_set</span> <span class="n">opt</span> <span class="sc">&#39;H&#39;</span><span class="o">;</span>
  <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;C&#39;</span> <span class="k">then</span> <span class="n">opt_set</span> <span class="n">opt</span> <span class="sc">&#39;c&#39;</span><span class="o">;</span>
  <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;c&#39;</span> <span class="k">then</span> <span class="n">opt_set</span> <span class="n">opt</span> <span class="sc">&#39;s&#39;</span><span class="o">;</span>
  <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;s&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">not</span> <span class="o">(</span><span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;c&#39;</span><span class="o">)</span> <span class="k">then</span> <span class="n">opt_set</span> <span class="n">opt</span> <span class="sc">&#39;1&#39;</span><span class="o">;</span>

  <span class="c">(* Compile the regular expression patterns. *)</span>
  <span class="k">let</span> <span class="n">rexes</span> <span class="o">=</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">map</span>
      <span class="o">(</span><span class="k">fun</span> <span class="n">pat</span> <span class="o">-&gt;</span>
         <span class="k">try</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="o">~</span><span class="n">flags</span><span class="o">:!</span><span class="n">flags</span> <span class="o">(</span><span class="s2">&quot;(&quot;</span> <span class="o">^</span> <span class="n">pat</span> <span class="o">^</span> <span class="s2">&quot;)&quot;</span><span class="o">)</span>
         <span class="k">with</span> <span class="nn">Pcre</span><span class="p">.</span><span class="nc">BadPattern</span> <span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
           <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s: bad pattern %s: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">me</span> <span class="n">pat</span> <span class="n">msg</span><span class="o">;</span>
           <span class="n">exit</span> <span class="mi">255</span><span class="o">)</span>
      <span class="n">patterns</span> <span class="k">in</span>

  <span class="c">(* Increments the matches variable by the number of matches</span>
<span class="c">     (or non-matches) in the given line. *)</span>
  <span class="k">let</span> <span class="n">count_matches</span> <span class="n">line</span> <span class="o">=</span>
    <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;v&#39;</span>
    <span class="k">then</span> <span class="k">fun</span> <span class="n">rex</span> <span class="o">-&gt;</span>
      <span class="o">(</span><span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span> <span class="o">~</span><span class="n">rex</span> <span class="n">line</span><span class="o">)</span> <span class="k">then</span> <span class="n">incr</span> <span class="n">matches</span><span class="o">)</span>
    <span class="k">else</span> <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;C&#39;</span>
    <span class="k">then</span> <span class="k">fun</span> <span class="n">rex</span> <span class="o">-&gt;</span>
      <span class="o">(</span><span class="n">matches</span> <span class="o">:=</span> <span class="o">!</span><span class="n">matches</span> <span class="o">+</span> <span class="o">(</span><span class="k">try</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">extract_all</span> <span class="o">~</span><span class="n">rex</span> <span class="n">line</span><span class="o">)</span>
                              <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="mi">0</span><span class="o">))</span>
    <span class="k">else</span> <span class="k">fun</span> <span class="n">rex</span> <span class="o">-&gt;</span>
      <span class="o">(</span><span class="k">if</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span> <span class="o">~</span><span class="n">rex</span> <span class="n">line</span> <span class="k">then</span> <span class="n">incr</span> <span class="n">matches</span><span class="o">)</span> <span class="k">in</span>

  <span class="c">(* Counts matches in a line and returns the line with any</span>
<span class="c">     necessary highlighting. *)</span>
  <span class="k">let</span> <span class="n">matcher</span> <span class="n">line</span> <span class="o">=</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="n">count_matches</span> <span class="n">line</span><span class="o">)</span> <span class="n">rexes</span><span class="o">;</span>
    <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;H&#39;</span>
    <span class="k">then</span>
      <span class="nn">List</span><span class="p">.</span><span class="n">fold_left</span>
        <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="n">rex</span> <span class="o">-&gt;</span>
           <span class="nn">Pcre</span><span class="p">.</span><span class="n">replace</span> <span class="o">~</span><span class="n">rex</span> <span class="o">~</span><span class="n">templ</span><span class="o">:</span><span class="n">highlight</span> <span class="n">line</span><span class="o">)</span>
        <span class="n">line</span> <span class="n">rexes</span>
    <span class="k">else</span> <span class="n">line</span> <span class="k">in</span>

  <span class="c">(* List of files or directories to process. *)</span>
  <span class="k">let</span> <span class="n">files</span> <span class="o">=</span>
    <span class="k">match</span> <span class="o">!</span><span class="n">args</span> <span class="k">with</span>
      <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;r&#39;</span> <span class="k">then</span> <span class="o">[</span><span class="s2">&quot;.&quot;</span><span class="o">]</span> <span class="k">else</span> <span class="o">[</span><span class="s2">&quot;-&quot;</span><span class="o">]</span>
      <span class="o">|</span> <span class="o">[</span><span class="n">arg</span><span class="o">]</span> <span class="o">-&gt;</span> <span class="o">[</span><span class="n">arg</span><span class="o">]</span>
      <span class="o">|</span> <span class="n">args</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">mult</span> <span class="o">:=</span> <span class="bp">true</span><span class="o">;</span> <span class="n">args</span><span class="o">)</span> <span class="k">in</span>

  <span class="c">(* Overrides for options that affect the multiple-file flag. *)</span>
  <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;h&#39;</span> <span class="k">then</span> <span class="n">mult</span> <span class="o">:=</span> <span class="bp">false</span><span class="o">;</span>
  <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;r&#39;</span> <span class="k">then</span> <span class="n">mult</span> <span class="o">:=</span> <span class="bp">true</span><span class="o">;</span>

  <span class="c">(* Return the three values to be processed by matchfiles. *)</span>
  <span class="n">opt</span><span class="o">,</span> <span class="n">matcher</span><span class="o">,</span> <span class="n">files</span>

<span class="c">(* Used to break out of loops and abort processing of the current file. *)</span>
<span class="k">exception</span> <span class="nc">NextFile</span>

<span class="c">(* Runs given matcher on a list of files using the specified options. *)</span>
<span class="k">let</span> <span class="k">rec</span> <span class="n">matchfiles</span> <span class="n">opt</span> <span class="n">matcher</span> <span class="n">files</span> <span class="o">=</span>
  <span class="c">(* Handles a single directory. *)</span>
  <span class="k">let</span> <span class="n">matchdir</span> <span class="n">dir</span> <span class="o">=</span>
    <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;r&#39;</span><span class="o">)</span>
    <span class="k">then</span>
      <span class="k">begin</span>
        <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;T&#39;</span>
        <span class="k">then</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s: </span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> is a directory, but no -r given</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">me</span> <span class="n">dir</span><span class="o">;</span>
              <span class="n">flush</span> <span class="n">stderr</span><span class="o">)</span>
      <span class="k">end</span>
    <span class="k">else</span>
      <span class="k">begin</span>
        <span class="k">let</span> <span class="n">files</span> <span class="o">=</span>
          <span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="n">readdir</span> <span class="n">dir</span><span class="o">)</span>
          <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span>
            <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;q&#39;</span><span class="o">)</span>
            <span class="k">then</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s: can&#39;t readdir %s: %s</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">me</span> <span class="n">dir</span> <span class="o">(</span><span class="nn">Printexc</span><span class="p">.</span><span class="n">to_string</span> <span class="n">e</span><span class="o">);</span>
                  <span class="n">flush</span> <span class="n">stderr</span><span class="o">);</span>
            <span class="n">incr</span> <span class="n">errors</span><span class="o">;</span>
            <span class="nc">None</span> <span class="k">in</span>
        <span class="k">match</span> <span class="n">files</span> <span class="k">with</span>
          <span class="o">|</span> <span class="nc">Some</span> <span class="n">files</span> <span class="o">-&gt;</span>
              <span class="k">let</span> <span class="n">by_mtime</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span>
                <span class="n">compare</span>
                  <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">stat</span> <span class="o">(</span><span class="nn">Filename</span><span class="p">.</span><span class="n">concat</span> <span class="n">dir</span> <span class="n">b</span><span class="o">)).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">st_mtime</span>
                  <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">stat</span> <span class="o">(</span><span class="nn">Filename</span><span class="p">.</span><span class="n">concat</span> <span class="n">dir</span> <span class="n">a</span><span class="o">)).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">st_mtime</span> <span class="k">in</span>
              <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;t&#39;</span>
              <span class="k">then</span> <span class="nn">Array</span><span class="p">.</span><span class="n">sort</span> <span class="n">by_mtime</span> <span class="n">files</span><span class="o">;</span>
              <span class="n">matchfiles</span> <span class="n">opt</span> <span class="n">matcher</span>
                <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span>
                   <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">map</span>
                      <span class="o">(</span><span class="nn">Filename</span><span class="p">.</span><span class="n">concat</span> <span class="n">dir</span><span class="o">)</span>
                      <span class="n">files</span><span class="o">))</span>
          <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="bp">()</span>
      <span class="k">end</span> <span class="k">in</span>

  <span class="c">(* Handles a single file. *)</span>
  <span class="k">let</span> <span class="n">matchfile</span> <span class="n">file</span> <span class="o">=</span>
    <span class="c">(* Keep a running total of matches for this file. *)</span>
    <span class="k">let</span> <span class="n">total</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>

    <span class="c">(* Keep track of the current line number. *)</span>
    <span class="k">let</span> <span class="n">line_num</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>

    <span class="c">(* Shadow close_in to properly close process channels for compressed</span>
<span class="c">       files and avoid closing stdin. *)</span>
    <span class="k">let</span> <span class="n">process_open</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">close_in</span> <span class="n">channel</span> <span class="o">=</span>
      <span class="k">if</span> <span class="o">!</span><span class="n">process_open</span>
      <span class="k">then</span> <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_in</span> <span class="n">channel</span><span class="o">)</span>
      <span class="k">else</span> <span class="k">if</span> <span class="n">channel</span> <span class="o">!=</span> <span class="n">stdin</span> <span class="k">then</span> <span class="n">close_in</span> <span class="n">channel</span> <span class="k">in</span>

    <span class="c">(* Process a line (or paragraph, with -p or -P) of input. *)</span>
    <span class="k">let</span> <span class="n">matchline</span> <span class="n">line</span> <span class="o">=</span>
       <span class="n">incr</span> <span class="n">line_num</span><span class="o">;</span>
       <span class="n">matches</span> <span class="o">:=</span> <span class="mi">0</span><span class="o">;</span>
       <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">matcher</span> <span class="n">line</span> <span class="k">in</span>
       <span class="k">if</span> <span class="o">!</span><span class="n">matches</span> <span class="o">&gt;</span> <span class="mi">0</span>
       <span class="k">then</span>
         <span class="k">begin</span>
           <span class="n">total</span> <span class="o">:=</span> <span class="o">!</span><span class="n">total</span> <span class="o">+</span> <span class="o">!</span><span class="n">matches</span><span class="o">;</span>
           <span class="n">grand_total</span> <span class="o">:=</span> <span class="o">!</span><span class="n">grand_total</span> <span class="o">+</span> <span class="o">!</span><span class="n">matches</span><span class="o">;</span>
           <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;l&#39;</span>
           <span class="k">then</span> <span class="o">(</span><span class="n">print_endline</span> <span class="n">file</span><span class="o">;</span> <span class="k">raise</span> <span class="nc">NextFile</span><span class="o">)</span>
           <span class="k">else</span> <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;s&#39;</span><span class="o">)</span>
           <span class="k">then</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s%s%s%s</span><span class="se">\n</span><span class="s2">&quot;</span>
                   <span class="o">(</span><span class="k">if</span> <span class="o">!</span><span class="n">mult</span>
                    <span class="k">then</span> <span class="n">file</span> <span class="o">^</span> <span class="s2">&quot;:&quot;</span>
                    <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="o">)</span>
                   <span class="o">(</span><span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;n&#39;</span>
                    <span class="k">then</span> <span class="o">(</span><span class="n">string_of_int</span> <span class="o">!</span><span class="n">line_num</span>
                          <span class="o">^</span> <span class="o">(</span><span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;p&#39;</span> <span class="o">||</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;P&#39;</span>
                             <span class="k">then</span> <span class="s2">&quot;:</span><span class="se">\n</span><span class="s2">&quot;</span>
                             <span class="k">else</span> <span class="s2">&quot;:&quot;</span><span class="o">))</span>
                    <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="o">)</span>
                   <span class="n">line</span>
                   <span class="o">(</span><span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;p&#39;</span> <span class="o">||</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;P&#39;</span>
                    <span class="k">then</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">^</span> <span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="mi">20</span> <span class="sc">&#39;-&#39;</span>
                    <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="o">);</span>
                 <span class="n">flush</span> <span class="n">stdout</span><span class="o">);</span>
           <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;1&#39;</span> <span class="k">then</span> <span class="k">raise</span> <span class="nc">NextFile</span>
         <span class="k">end</span> <span class="k">in</span>

    <span class="c">(* Get a channel for the file, starting a decompression process if</span>
<span class="c">       necessary. If None, the file will be skipped. *)</span>
    <span class="k">let</span> <span class="n">maybe_channel</span> <span class="o">=</span>
      <span class="k">if</span> <span class="n">file</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
      <span class="k">then</span> <span class="o">(</span><span class="k">if</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">isatty</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span> <span class="o">&amp;&amp;</span> <span class="n">not</span> <span class="o">(</span><span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;q&#39;</span><span class="o">)</span>
            <span class="k">then</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s: reading from stdin</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">me</span><span class="o">;</span>
                  <span class="n">flush</span> <span class="n">stderr</span><span class="o">);</span>
            <span class="nc">Some</span> <span class="n">stdin</span><span class="o">)</span>
      <span class="k">else</span> <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="n">file_exists</span> <span class="n">file</span><span class="o">)</span>
      <span class="k">then</span> <span class="o">(</span><span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;q&#39;</span><span class="o">)</span>
            <span class="k">then</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s: file </span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> does not exist</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">me</span> <span class="n">file</span><span class="o">;</span>
                  <span class="n">flush</span> <span class="n">stderr</span><span class="o">);</span>
            <span class="n">incr</span> <span class="n">errors</span><span class="o">;</span>
            <span class="nc">None</span><span class="o">)</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nn">List</span><span class="p">.</span><span class="n">mem_assoc</span> <span class="o">(</span><span class="n">snd</span> <span class="o">(</span><span class="n">splitext</span> <span class="n">file</span><span class="o">))</span> <span class="n">compress</span>
      <span class="k">then</span> <span class="o">(</span><span class="n">process_open</span> <span class="o">:=</span> <span class="bp">true</span><span class="o">;</span>
            <span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_in</span>
                        <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">assoc</span> <span class="o">(</span><span class="n">snd</span> <span class="o">(</span><span class="n">splitext</span> <span class="n">file</span><span class="o">))</span> <span class="n">compress</span>
                         <span class="o">^</span> <span class="s2">&quot; &lt; &quot;</span> <span class="o">^</span> <span class="n">file</span><span class="o">))</span>
            <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span>
              <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;q&#39;</span><span class="o">)</span>
              <span class="k">then</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s: %s: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">me</span> <span class="n">file</span>
                      <span class="o">(</span><span class="nn">Printexc</span><span class="p">.</span><span class="n">to_string</span> <span class="n">e</span><span class="o">);</span>
                    <span class="n">flush</span> <span class="n">stderr</span><span class="o">);</span>
              <span class="n">incr</span> <span class="n">errors</span><span class="o">;</span>
              <span class="nc">None</span><span class="o">)</span>
      <span class="k">else</span> <span class="o">(</span><span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">open_in</span> <span class="n">file</span><span class="o">)</span>
            <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span>
              <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;q&#39;</span><span class="o">)</span>
              <span class="k">then</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s: %s: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">me</span> <span class="n">file</span>
                      <span class="o">(</span><span class="nn">Printexc</span><span class="p">.</span><span class="n">to_string</span> <span class="n">e</span><span class="o">);</span>
                    <span class="n">flush</span> <span class="n">stderr</span><span class="o">);</span>
              <span class="n">incr</span> <span class="n">errors</span><span class="o">;</span>
              <span class="nc">None</span><span class="o">)</span> <span class="k">in</span>

    <span class="c">(* Run matcher on the open channel, then close the channel. *)</span>
    <span class="k">match</span> <span class="n">maybe_channel</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="bp">()</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">channel</span> <span class="o">-&gt;</span>
          <span class="k">begin</span>
            <span class="k">try</span>
              <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;T&#39;</span>
              <span class="k">then</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s: checking %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">me</span> <span class="n">file</span><span class="o">;</span>
                    <span class="n">flush</span> <span class="n">stderr</span><span class="o">);</span>
              <span class="nn">Stream</span><span class="p">.</span><span class="n">iter</span> <span class="n">matchline</span> <span class="o">(!</span><span class="n">stream_of_channel</span> <span class="n">channel</span><span class="o">);</span>
              <span class="n">close_in</span> <span class="n">channel</span>
            <span class="k">with</span>
              <span class="o">|</span> <span class="nc">NextFile</span> <span class="o">-&gt;</span>
                  <span class="n">close_in</span> <span class="n">channel</span>
              <span class="o">|</span> <span class="n">e</span> <span class="o">-&gt;</span>
                  <span class="n">close_in</span> <span class="n">channel</span><span class="o">;</span>
                  <span class="k">raise</span> <span class="n">e</span>
          <span class="k">end</span><span class="o">;</span>
          <span class="k">if</span> <span class="n">opt_test</span> <span class="n">opt</span> <span class="sc">&#39;c&#39;</span>
          <span class="k">then</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s%d</span><span class="se">\n</span><span class="s2">&quot;</span>
                  <span class="o">(</span><span class="k">if</span> <span class="o">!</span><span class="n">mult</span> <span class="k">then</span> <span class="n">file</span> <span class="o">^</span> <span class="s2">&quot;:&quot;</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="o">)</span>
                  <span class="o">!</span><span class="n">total</span><span class="o">;</span>
                <span class="n">flush</span> <span class="n">stdout</span><span class="o">)</span> <span class="k">in</span>

  <span class="c">(* Handle each of the specified files and directories. *)</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">file</span> <span class="o">-&gt;</span>
       <span class="k">if</span> <span class="n">file</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
       <span class="k">then</span> <span class="n">matchfile</span> <span class="n">file</span>
       <span class="k">else</span> <span class="k">if</span> <span class="k">try</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">is_directory</span> <span class="n">file</span> <span class="k">with</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>
       <span class="k">then</span> <span class="n">matchdir</span> <span class="n">file</span>
       <span class="k">else</span> <span class="n">matchfile</span> <span class="n">file</span><span class="o">)</span>
    <span class="n">files</span>

<span class="c">(* Parse command line arguments, run matcher, and set result status. *)</span>
<span class="k">let</span> <span class="n">opt</span><span class="o">,</span> <span class="n">matcher</span><span class="o">,</span> <span class="n">files</span> <span class="o">=</span> <span class="n">parse_args</span> <span class="bp">()</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">matchfiles</span> <span class="n">opt</span> <span class="n">matcher</span> <span class="n">files</span><span class="o">;</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">errors</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="n">exit</span> <span class="mi">2</span><span class="o">;</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">grand_total</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="n">exit</span> <span class="mi">0</span><span class="o">;</span>
  <span class="n">exit</span> <span class="mi">1</span>

<span class="c">(* @@PLEAC@@_6.23 *)</span>
<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+pcre&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;pcre.cma&quot;</span><span class="o">;;</span>

<span class="c">(*-----------------------------*)</span>

<span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span>
  <span class="o">~</span><span class="n">rex</span><span class="o">:(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span>
          <span class="o">~</span><span class="n">flags</span><span class="o">:[`</span><span class="nc">CASELESS</span><span class="o">]</span>
          <span class="s2">&quot;^m*(d?c{0,3}|c[dm])(l?x{0,3}|x[lc])(v?i{0,3}|i[vx])$&quot;</span><span class="o">)</span>
  <span class="n">input</span>

<span class="c">(*-----------------------------*)</span>

<span class="nn">Pcre</span><span class="p">.</span><span class="n">replace</span>
  <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;(</span><span class="se">\\</span><span class="s2">S+)(</span><span class="se">\\</span><span class="s2">s+)(</span><span class="se">\\</span><span class="s2">S+)&quot;</span>
  <span class="o">~</span><span class="n">templ</span><span class="o">:</span><span class="s2">&quot;$3$2$1&quot;</span>
  <span class="n">input</span>

<span class="c">(*-----------------------------*)</span>

<span class="nn">Pcre</span><span class="p">.</span><span class="n">extract</span>
  <span class="o">~</span><span class="n">full_match</span><span class="o">:</span><span class="bp">false</span>
  <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;(</span><span class="se">\\</span><span class="s2">w+)</span><span class="se">\\</span><span class="s2">s*=</span><span class="se">\\</span><span class="s2">s*(.*)</span><span class="se">\\</span><span class="s2">s*$&quot;</span>
  <span class="n">input</span>

<span class="c">(*-----------------------------*)</span>

<span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span>
  <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;.{80,}&quot;</span>
  <span class="n">input</span>

<span class="c">(*-----------------------------*)</span>

<span class="nn">Pcre</span><span class="p">.</span><span class="n">extract</span>
  <span class="o">~</span><span class="n">full_match</span><span class="o">:</span><span class="bp">false</span>
  <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;(</span><span class="se">\\</span><span class="s2">d+)/(</span><span class="se">\\</span><span class="s2">d+)/(</span><span class="se">\\</span><span class="s2">d+) (</span><span class="se">\\</span><span class="s2">d+):(</span><span class="se">\\</span><span class="s2">d+):(</span><span class="se">\\</span><span class="s2">d+)&quot;</span>
  <span class="n">input</span>

<span class="c">(*-----------------------------*)</span>

<span class="nn">Pcre</span><span class="p">.</span><span class="n">replace</span>
  <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;/usr/bin&quot;</span>
  <span class="o">~</span><span class="n">templ</span><span class="o">:</span><span class="s2">&quot;/usr/local/bin&quot;</span>
  <span class="n">input</span>

<span class="c">(*-----------------------------*)</span>

<span class="nn">Pcre</span><span class="p">.</span><span class="n">substitute_substrings</span>
  <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;%([0-9A-Fa-f][0-9A-Fa-f])&quot;</span>
  <span class="o">~</span><span class="n">subst</span><span class="o">:(</span><span class="k">fun</span> <span class="n">subs</span> <span class="o">-&gt;</span>
            <span class="k">let</span> <span class="n">c</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">get_substring</span> <span class="n">subs</span> <span class="mi">1</span> <span class="k">in</span>
            <span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="mi">1</span> <span class="o">(</span><span class="nn">Char</span><span class="p">.</span><span class="n">chr</span> <span class="o">(</span><span class="n">int_of_string</span> <span class="o">(</span><span class="s2">&quot;0x&quot;</span> <span class="o">^</span> <span class="n">c</span><span class="o">))))</span>
  <span class="n">input</span>

<span class="c">(*-----------------------------*)</span>

<span class="nn">Pcre</span><span class="p">.</span><span class="n">replace</span>
  <span class="o">~</span><span class="n">rex</span><span class="o">:(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span>
          <span class="o">~</span><span class="n">flags</span><span class="o">:[`</span><span class="nc">DOTALL</span><span class="o">;</span> <span class="o">`</span><span class="nc">EXTENDED</span><span class="o">]</span> <span class="s2">&quot;</span>
<span class="s2">            /</span><span class="se">\\</span><span class="s2">*  # Match the opening delimiter</span>
<span class="s2">            .*?   # Match a minimal number of characters</span>
<span class="s2">            </span><span class="se">\\</span><span class="s2">*/  # Match the closing delimiter</span>
<span class="s2">          &quot;</span><span class="o">)</span>
  <span class="n">input</span>

<span class="c">(*-----------------------------*)</span>

<span class="nn">Pcre</span><span class="p">.</span><span class="n">replace</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;^</span><span class="se">\\</span><span class="s2">s+&quot;</span> <span class="n">input</span>
<span class="nn">Pcre</span><span class="p">.</span><span class="n">replace</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">s+$&quot;</span> <span class="n">input</span>

<span class="c">(*-----------------------------*)</span>

<span class="nn">Pcre</span><span class="p">.</span><span class="n">replace</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">n&quot;</span> <span class="o">~</span><span class="n">templ</span><span class="o">:</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">input</span>

<span class="c">(*-----------------------------*)</span>

<span class="nn">Pcre</span><span class="p">.</span><span class="n">replace</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;^.*::&quot;</span> <span class="n">input</span>

<span class="c">(*-----------------------------*)</span>

<span class="nn">Pcre</span><span class="p">.</span><span class="n">extract</span>
  <span class="o">~</span><span class="n">full_match</span><span class="o">:</span><span class="bp">false</span>
  <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;^([01]?</span><span class="se">\\</span><span class="s2">d</span><span class="se">\\</span><span class="s2">d|2[0-4]</span><span class="se">\\</span><span class="s2">d|25[0-5])</span><span class="se">\\</span><span class="s2">.([01]?</span><span class="se">\\</span><span class="s2">d</span><span class="se">\\</span><span class="s2">d|2[0-4]</span><span class="se">\\</span><span class="s2">d|25[0-5])</span><span class="se">\\</span><span class="s2">.\</span>
<span class="s2">         ([01]?</span><span class="se">\\</span><span class="s2">d</span><span class="se">\\</span><span class="s2">d|2[0-4]</span><span class="se">\\</span><span class="s2">d|25[0-5])</span><span class="se">\\</span><span class="s2">.([01]?</span><span class="se">\\</span><span class="s2">d</span><span class="se">\\</span><span class="s2">d|2[0-4]</span><span class="se">\\</span><span class="s2">d|25[0-5])$&quot;</span>
  <span class="n">input</span>

<span class="c">(*-----------------------------*)</span>

<span class="nn">Pcre</span><span class="p">.</span><span class="n">replace</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;^.*/&quot;</span> <span class="n">input</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">termcap</span> <span class="o">=</span> <span class="s2">&quot;:co#80:li#24:&quot;</span>
<span class="k">let</span> <span class="n">cols</span> <span class="o">=</span>
  <span class="k">try</span> <span class="n">int_of_string</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">extract</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;:co#(</span><span class="se">\\</span><span class="s2">d+):&quot;</span> <span class="n">termcap</span><span class="o">).(</span><span class="mi">1</span><span class="o">)</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">|</span> <span class="nc">Failure</span> <span class="s2">&quot;int_of_string&quot;</span> <span class="o">-&gt;</span> <span class="mi">80</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">name</span> <span class="o">=</span>
  <span class="nn">Pcre</span><span class="p">.</span><span class="n">replace</span>
    <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot; /</span><span class="se">\\</span><span class="s2">S+/&quot;</span>
    <span class="o">~</span><span class="n">templ</span><span class="o">:</span><span class="s2">&quot; &quot;</span>
    <span class="o">(</span><span class="s2">&quot; &quot;</span> <span class="o">^</span> <span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot; &quot;</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">))</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">ch</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_in</span> <span class="s2">&quot;uname -a&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">os</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">ch</span> <span class="k">in</span>
  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_in</span> <span class="n">ch</span><span class="o">);</span>
  <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span> <span class="o">~</span><span class="n">rex</span><span class="o">:(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="o">~</span><span class="n">flags</span><span class="o">:[`</span><span class="nc">CASELESS</span><span class="o">]</span> <span class="s2">&quot;linux&quot;</span><span class="o">)</span> <span class="n">os</span><span class="o">)</span>
  <span class="k">then</span> <span class="n">print_endline</span> <span class="s2">&quot;This isn&#39;t Linux&quot;</span>

<span class="c">(*-----------------------------*)</span>

<span class="nn">Pcre</span><span class="p">.</span><span class="n">replace</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;</span><span class="se">\n\\</span><span class="s2">s+&quot;</span> <span class="o">~</span><span class="n">templ</span><span class="o">:</span><span class="s2">&quot; &quot;</span> <span class="n">input</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">nums</span> <span class="o">=</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">map</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">group</span> <span class="o">-&gt;</span> <span class="n">float_of_string</span> <span class="n">group</span><span class="o">.(</span><span class="mi">1</span><span class="o">))</span>
    <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">extract_all</span>
       <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;(</span><span class="se">\\</span><span class="s2">d+</span><span class="se">\\</span><span class="s2">.?</span><span class="se">\\</span><span class="s2">d*|</span><span class="se">\\</span><span class="s2">.</span><span class="se">\\</span><span class="s2">d+)&quot;</span>
       <span class="n">input</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">capwords</span> <span class="o">=</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">map</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">group</span> <span class="o">-&gt;</span> <span class="n">group</span><span class="o">.(</span><span class="mi">1</span><span class="o">))</span>
    <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">extract_all</span>
       <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;(</span><span class="se">\\</span><span class="s2">b[^</span><span class="se">\\</span><span class="s2">Wa-z0-9_]+</span><span class="se">\\</span><span class="s2">b)&quot;</span>
       <span class="n">input</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">lowords</span> <span class="o">=</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">map</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">group</span> <span class="o">-&gt;</span> <span class="n">group</span><span class="o">.(</span><span class="mi">1</span><span class="o">))</span>
    <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">extract_all</span>
       <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;(</span><span class="se">\\</span><span class="s2">b[^</span><span class="se">\\</span><span class="s2">WA-Z0-9_]+</span><span class="se">\\</span><span class="s2">b)&quot;</span>
       <span class="n">input</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">icwords</span> <span class="o">=</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">map</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">group</span> <span class="o">-&gt;</span> <span class="n">group</span><span class="o">.(</span><span class="mi">1</span><span class="o">))</span>
    <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">extract_all</span>
       <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;(</span><span class="se">\\</span><span class="s2">b[^</span><span class="se">\\</span><span class="s2">Wa-z0-9_][^</span><span class="se">\\</span><span class="s2">WA-Z0-9_]*</span><span class="se">\\</span><span class="s2">b)&quot;</span>
       <span class="n">input</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">links</span> <span class="o">=</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">map</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">group</span> <span class="o">-&gt;</span> <span class="n">group</span><span class="o">.(</span><span class="mi">1</span><span class="o">))</span>
    <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">extract_all</span>
       <span class="o">~</span><span class="n">rex</span><span class="o">:(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span>
               <span class="o">~</span><span class="n">flags</span><span class="o">:[`</span><span class="nc">DOTALL</span><span class="o">;</span> <span class="o">`</span><span class="nc">CASELESS</span><span class="o">]</span>
               <span class="s2">&quot;&lt;A[^&gt;]+?HREF</span><span class="se">\\</span><span class="s2">s*=</span><span class="se">\\</span><span class="s2">s*[</span><span class="se">\&quot;</span><span class="s2">&#39;]?([^&#39;</span><span class="se">\&quot;</span><span class="s2"> &gt;]+?)[ &#39;</span><span class="se">\&quot;</span><span class="s2">]?&gt;&quot;</span><span class="o">)</span>
       <span class="n">input</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">initial</span> <span class="o">=</span>
  <span class="k">try</span> <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">extract</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;^</span><span class="se">\\</span><span class="s2">S+</span><span class="se">\\</span><span class="s2">s+(</span><span class="se">\\</span><span class="s2">S)</span><span class="se">\\</span><span class="s2">S*</span><span class="se">\\</span><span class="s2">s+</span><span class="se">\\</span><span class="s2">S&quot;</span> <span class="n">input</span><span class="o">).(</span><span class="mi">1</span><span class="o">)</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="s2">&quot;&quot;</span>

<span class="c">(*-----------------------------*)</span>

<span class="nn">Pcre</span><span class="p">.</span><span class="n">replace</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">([^</span><span class="se">\&quot;</span><span class="s2">]*)</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">~</span><span class="n">templ</span><span class="o">:</span><span class="s2">&quot;``$1&#39;&#39;&quot;</span> <span class="n">input</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">sentences</span> <span class="o">=</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">map</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">group</span> <span class="o">-&gt;</span> <span class="n">group</span><span class="o">.(</span><span class="mi">1</span><span class="o">))</span>
    <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">extract_all</span>
       <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;(</span><span class="se">\\</span><span class="s2">S.*?</span><span class="se">\\</span><span class="s2">pP)(?=  |</span><span class="se">\\</span><span class="s2">Z)&quot;</span>
       <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">replace</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot; {3,}&quot;</span> <span class="o">~</span><span class="n">templ</span><span class="o">:</span><span class="s2">&quot;  &quot;</span>
          <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">replace</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">~</span><span class="n">templ</span><span class="o">:</span><span class="s2">&quot; &quot;</span>
             <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">replace</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;(</span><span class="se">\\</span><span class="s2">pP</span><span class="se">\n</span><span class="s2">)&quot;</span> <span class="o">~</span><span class="n">templ</span><span class="o">:</span><span class="s2">&quot;$1  &quot;</span>
                <span class="n">input</span><span class="o">))))</span>

<span class="c">(*-----------------------------*)</span>

<span class="nn">Pcre</span><span class="p">.</span><span class="n">extract</span> <span class="o">~</span><span class="n">full_match</span><span class="o">:</span><span class="bp">false</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;(</span><span class="se">\\</span><span class="s2">d{4})-(</span><span class="se">\\</span><span class="s2">d</span><span class="se">\\</span><span class="s2">d)-(</span><span class="se">\\</span><span class="s2">d</span><span class="se">\\</span><span class="s2">d)&quot;</span> <span class="n">input</span>

<span class="c">(*-----------------------------*)</span>

<span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span>
  <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;^[01]?[- .]?(</span><span class="se">\\</span><span class="s2">([2-9]</span><span class="se">\\</span><span class="s2">d{2}</span><span class="se">\\</span><span class="s2">)|[2-9]</span><span class="se">\\</span><span class="s2">d{2})[- .]?</span><span class="se">\\</span><span class="s2">d{3}[- .]?</span><span class="se">\\</span><span class="s2">d{4}$&quot;</span>
  <span class="n">input</span>

<span class="c">(*-----------------------------*)</span>

<span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span>
  <span class="o">~</span><span class="n">rex</span><span class="o">:(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span>
          <span class="o">~</span><span class="n">flags</span><span class="o">:[`</span><span class="nc">CASELESS</span><span class="o">]</span>
          <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">boh</span><span class="se">\\</span><span class="s2">s+my</span><span class="se">\\</span><span class="s2">s+gh?o(d(dess(es)?|s?)|odness|sh)</span><span class="se">\\</span><span class="s2">b&quot;</span><span class="o">)</span>
  <span class="n">input</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">lines</span> <span class="o">=</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">map</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">group</span> <span class="o">-&gt;</span> <span class="n">group</span><span class="o">.(</span><span class="mi">1</span><span class="o">))</span>
    <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">extract_all</span>
       <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;([^</span><span class="se">\010\013</span><span class="s2">]*)(</span><span class="se">\010\013</span><span class="s2">?|</span><span class="se">\013\010</span><span class="s2">?)&quot;</span>
       <span class="n">input</span><span class="o">)</span>


<span class="c">(* @@PLEAC@@_7.0 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="c">(* Print all lines that contain the word &quot;blue&quot; in the input file</span>
<span class="c">   /usr/local/widgets/data to stdout. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span> <span class="n">open_in</span> <span class="s2">&quot;/usr/local/widgets/data&quot;</span> <span class="k">in</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">in_channel</span> <span class="k">in</span>
      <span class="k">try</span>
        <span class="n">ignore</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp_string</span> <span class="s2">&quot;blue&quot;</span><span class="o">)</span> <span class="n">line</span> <span class="mi">0</span><span class="o">);</span>
        <span class="n">print_endline</span> <span class="n">line</span>
      <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">()</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
    <span class="n">close_in</span> <span class="n">in_channel</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;.*[0-9]&quot;</span> <span class="k">in</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="c">(* reads from stdin *)</span>
      <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">stdin</span> <span class="k">in</span>
      <span class="c">(* writes to stderr *)</span>
      <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">regexp</span> <span class="n">line</span> <span class="mi">0</span><span class="o">)</span>
      <span class="k">then</span> <span class="n">prerr_endline</span> <span class="s2">&quot;No digit found.&quot;</span><span class="o">;</span>
      <span class="c">(* writes to stdout *)</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Read: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">line</span><span class="o">;</span>
      <span class="n">flush</span> <span class="n">stdout</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
    <span class="n">close_out</span> <span class="n">stdout</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Write to an output file the usual way. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">logfile</span> <span class="o">=</span> <span class="n">open_out</span> <span class="s2">&quot;/tmp/log&quot;</span> <span class="k">in</span>
  <span class="n">output_string</span> <span class="n">logfile</span> <span class="s2">&quot;Countdown initiated...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
  <span class="n">close_out</span> <span class="n">logfile</span><span class="o">;</span>
  <span class="n">print_endline</span> <span class="s2">&quot;You have 30 seconds to reach minimum safety distance.&quot;</span>

<span class="c">(* Write to an output file using redirection. *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">logfile</span> <span class="o">=</span> <span class="n">open_out</span> <span class="s2">&quot;/tmp/log&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">old_descr</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">dup</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdout</span> <span class="k">in</span>
  <span class="c">(* switch to logfile for output *)</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">dup2</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">descr_of_out_channel</span> <span class="n">logfile</span><span class="o">)</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdout</span><span class="o">;</span>
  <span class="n">print_endline</span> <span class="s2">&quot;Countdown initiated...&quot;</span><span class="o">;</span>
  <span class="c">(* return to original output *)</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">dup2</span> <span class="n">old_descr</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdout</span><span class="o">;</span>
  <span class="n">print_endline</span> <span class="s2">&quot;You have 30 seconds to reach minimum safety distance.&quot;</span>

<span class="c">(* @@PLEAC@@_7.1 *)</span>
<span class="c">(* open file &quot;path&quot; for reading only *)</span>
<span class="k">let</span> <span class="n">source</span> <span class="o">=</span>
  <span class="k">try</span> <span class="n">open_in</span> <span class="n">path</span>
  <span class="k">with</span> <span class="nc">Sys_error</span> <span class="n">msg</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="o">(</span><span class="s2">&quot;Couldn&#39;t read from &quot;</span> <span class="o">^</span> <span class="n">msg</span><span class="o">)</span>

<span class="c">(* open file &quot;path&quot; for writing only *)</span>
<span class="k">let</span> <span class="n">sink</span> <span class="o">=</span>
  <span class="k">try</span> <span class="n">open_out</span> <span class="n">path</span>
  <span class="k">with</span> <span class="nc">Sys_error</span> <span class="n">msg</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="o">(</span><span class="s2">&quot;Couldn&#39;t write to &quot;</span> <span class="o">^</span> <span class="n">msg</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="c">(* open file &quot;path&quot; for reading only *)</span>
<span class="k">let</span> <span class="n">source</span> <span class="o">=</span>
  <span class="k">try</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">openfile</span> <span class="n">path</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">O_RDONLY</span><span class="o">]</span> <span class="mo">0o644</span>
  <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="n">code</span><span class="o">,</span> <span class="n">func</span><span class="o">,</span> <span class="n">param</span><span class="o">)</span> <span class="o">-&gt;</span>
    <span class="n">failwith</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;Couldn&#39;t open %s for reading: %s&quot;</span>
                <span class="n">path</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">error_message</span> <span class="n">code</span><span class="o">))</span>

<span class="c">(* open file &quot;path&quot; for writing only *)</span>
<span class="k">let</span> <span class="n">sink</span> <span class="o">=</span>
  <span class="k">try</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">openfile</span> <span class="n">path</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">O_WRONLY</span><span class="o">;</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">O_CREAT</span><span class="o">]</span> <span class="mo">0o644</span>
  <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="n">code</span><span class="o">,</span> <span class="n">func</span><span class="o">,</span> <span class="n">param</span><span class="o">)</span> <span class="o">-&gt;</span>
    <span class="n">failwith</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;Couldn&#39;t open %s for writing: %s&quot;</span>
                <span class="n">path</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">error_message</span> <span class="n">code</span><span class="o">))</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* open file &quot;path&quot; for reading and writing *)</span>
<span class="k">let</span> <span class="n">fh</span> <span class="o">=</span>
  <span class="k">try</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">openfile</span> <span class="n">filename</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">O_RDWR</span><span class="o">]</span> <span class="mo">0o644</span>
  <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="n">code</span><span class="o">,</span> <span class="n">func</span><span class="o">,</span> <span class="n">param</span><span class="o">)</span> <span class="o">-&gt;</span>
    <span class="n">failwith</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;Couldn&#39;t open %s for read and write: %s&quot;</span>
                <span class="n">filename</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">error_message</span> <span class="n">code</span><span class="o">))</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* open file &quot;path&quot; read only *)</span>
<span class="k">let</span> <span class="n">fh</span> <span class="o">=</span> <span class="n">open_in</span> <span class="n">path</span>
<span class="k">let</span> <span class="n">fh</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">openfile</span> <span class="n">path</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">O_RDONLY</span><span class="o">]</span> <span class="mo">0o644</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* open file &quot;path&quot; write only, create it if it does not exist *)</span>
<span class="k">let</span> <span class="n">fh</span> <span class="o">=</span> <span class="n">open_out</span> <span class="n">path</span>
<span class="k">let</span> <span class="n">fh</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">openfile</span> <span class="n">path</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">O_WRONLY</span><span class="o">;</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">O_TRUNC</span><span class="o">;</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">O_CREAT</span><span class="o">]</span> <span class="mo">0o600</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* open file &quot;path&quot; write only, fails if file exists *)</span>
<span class="k">let</span> <span class="n">fh</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">openfile</span> <span class="n">path</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">O_WRONLY</span><span class="o">;</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">O_EXCL</span><span class="o">;</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">O_CREAT</span><span class="o">]</span> <span class="mo">0o600</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* open file &quot;path&quot; for appending *)</span>
<span class="k">let</span> <span class="n">fh</span> <span class="o">=</span>
  <span class="n">open_out_gen</span> <span class="o">[</span><span class="nc">Open_wronly</span><span class="o">;</span> <span class="nc">Open_append</span><span class="o">;</span> <span class="nc">Open_creat</span><span class="o">]</span> <span class="mo">0o600</span> <span class="n">path</span>
<span class="k">let</span> <span class="n">fh</span> <span class="o">=</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">openfile</span> <span class="n">path</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">O_WRONLY</span><span class="o">;</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">O_APPEND</span><span class="o">;</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">O_CREAT</span><span class="o">]</span> <span class="mo">0o600</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* open file &quot;path&quot; for appending only when file exists *)</span>
<span class="k">let</span> <span class="n">fh</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">openfile</span> <span class="n">path</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">O_WRONLY</span><span class="o">;</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">O_APPEND</span><span class="o">]</span> <span class="mo">0o600</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* open file &quot;path&quot; for reading and writing *)</span>
<span class="k">let</span> <span class="n">fh</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">openfile</span> <span class="n">path</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">O_RDWR</span><span class="o">]</span> <span class="mo">0o600</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* open file &quot;path&quot; for reading and writing,</span>
<span class="c">   create a new file if it does not exist *)</span>
<span class="k">let</span> <span class="n">fh</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">openfile</span> <span class="n">path</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">O_RDWR</span><span class="o">;</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">O_CREAT</span><span class="o">]</span> <span class="mo">0o600</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* open file &quot;path&quot; for reading and writing, fails if file exists *)</span>
<span class="k">let</span> <span class="n">fh</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">openfile</span> <span class="n">path</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">O_RDWR</span><span class="o">;</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">O_EXCL</span><span class="o">;</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">O_CREAT</span><span class="o">]</span> <span class="mo">0o600</span>

<span class="c">(* @@PLEAC@@_7.2 *)</span>
<span class="c">(* Nothing different needs to be done with OCaml *)</span>

<span class="c">(* @@PLEAC@@_7.3 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">expanduser</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;^~</span><span class="se">\\</span><span class="s2">([^/]*</span><span class="se">\\</span><span class="s2">)&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">replace</span> <span class="n">s</span> <span class="o">=</span>
    <span class="k">match</span> <span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">1</span> <span class="n">s</span> <span class="k">with</span>
      <span class="o">|</span> <span class="s2">&quot;&quot;</span> <span class="o">-&gt;</span>
          <span class="o">(</span><span class="k">try</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">getenv</span> <span class="s2">&quot;HOME&quot;</span>
           <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
             <span class="o">(</span><span class="k">try</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">getenv</span> <span class="s2">&quot;LOGDIR&quot;</span>
              <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
                <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">getpwuid</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">getuid</span> <span class="bp">()</span><span class="o">)).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">pw_dir</span><span class="o">))</span>
      <span class="o">|</span> <span class="n">user</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">getpwnam</span> <span class="n">user</span><span class="o">).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">pw_dir</span> <span class="k">in</span>
  <span class="nn">Str</span><span class="p">.</span><span class="n">substitute_first</span> <span class="n">regexp</span> <span class="n">replace</span>

<span class="c">(*-----------------------------*)</span>

    <span class="o">~</span><span class="n">user</span>
    <span class="o">~</span><span class="n">user</span><span class="o">/</span><span class="n">blah</span>
    <span class="o">~</span>
    <span class="o">~/</span><span class="n">blah</span>

<span class="c">(* @@PLEAC@@_7.4 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">open</span> <span class="nc">Unix</span>

<span class="c">(* Raises an exception on failure. *)</span>
<span class="k">let</span> <span class="n">file</span> <span class="o">=</span> <span class="n">openfile</span> <span class="n">filename</span> <span class="o">[</span> <span class="nc">O_RDONLY</span> <span class="o">]</span> <span class="mo">0o640</span>

<span class="k">exception</span> <span class="nc">ErrString</span> <span class="k">of</span> <span class="kt">string</span>

<span class="k">let</span> <span class="n">file</span> <span class="o">=</span>
  <span class="k">try</span> <span class="n">openfile</span> <span class="n">filename</span> <span class="o">[</span> <span class="nc">O_RDONLY</span> <span class="o">]</span> <span class="mo">0o640</span>
  <span class="k">with</span> <span class="nc">Unix_error</span> <span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="n">f</span><span class="o">,</span> <span class="n">n</span><span class="o">)</span> <span class="o">-&gt;</span>
    <span class="k">raise</span> <span class="o">(</span><span class="nc">ErrString</span>
             <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;Could not open %s for read: %s&quot;</span>
                <span class="n">n</span> <span class="o">(</span><span class="n">error_message</span> <span class="n">e</span><span class="o">)))</span>

<span class="c">(* @@PLEAC@@_7.5 *)</span>
<span class="c">(* Open a new temporary file for writing. Filename.open_temp_file</span>
<span class="c">   safeguards against race conditions and returns both the filename</span>
<span class="c">   and an output channel. *)</span>
<span class="k">let</span> <span class="n">name</span><span class="o">,</span> <span class="n">out_channel</span> <span class="o">=</span> <span class="nn">Filename</span><span class="p">.</span><span class="n">open_temp_file</span> <span class="s2">&quot;prefix-&quot;</span> <span class="s2">&quot;.suffix&quot;</span>

<span class="c">(* Install an at_exit handler to remove the temporary file when this</span>
<span class="c">   program exits. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">at_exit</span> <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">remove</span> <span class="n">name</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* Open a temporary file for reading and writing. *)</span>
  <span class="k">let</span> <span class="n">name</span> <span class="o">=</span> <span class="nn">Filename</span><span class="p">.</span><span class="n">temp_file</span> <span class="s2">&quot;prefix-&quot;</span> <span class="s2">&quot;.suffix&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">descr</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">openfile</span> <span class="n">name</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">O_RDWR</span><span class="o">]</span> <span class="mo">0o600</span> <span class="k">in</span>

  <span class="c">(* Write ten lines of output. *)</span>
  <span class="k">let</span> <span class="n">out_channel</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">out_channel_of_descr</span> <span class="n">descr</span> <span class="k">in</span>
  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">to</span> <span class="mi">10</span> <span class="k">do</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">fprintf</span> <span class="n">out_channel</span> <span class="s2">&quot;%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">i</span>
  <span class="k">done</span><span class="o">;</span>
  <span class="n">flush</span> <span class="n">out_channel</span><span class="o">;</span>

  <span class="c">(* Seek to the beginning and read the lines back in. *)</span>
  <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">in_channel_of_descr</span> <span class="n">descr</span> <span class="k">in</span>
  <span class="n">seek_in</span> <span class="n">in_channel</span> <span class="mi">0</span><span class="o">;</span>
  <span class="n">print_endline</span> <span class="s2">&quot;Tmp file has:&quot;</span><span class="o">;</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span> <span class="bp">()</span> <span class="o">=</span>
    <span class="n">print_endline</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">in_channel</span><span class="o">);</span>
    <span class="n">loop</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="k">try</span> <span class="n">loop</span><span class="bp">()</span> <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">;</span>

  <span class="c">(* Close the underlying file descriptor and remove the file. *)</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="n">descr</span><span class="o">;</span>
  <span class="nn">Sys</span><span class="p">.</span><span class="n">remove</span> <span class="n">name</span>

<span class="c">(* @@PLEAC@@_7.6 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">main</span> <span class="n">data</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span>
       <span class="c">(* process the line *)</span>
       <span class="bp">()</span><span class="o">)</span>
    <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">split</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span> <span class="n">data</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">main</span> <span class="s2">&quot;\</span>
<span class="s2">your data goes here</span>
<span class="s2">&quot;</span>

<span class="c">(* @@PLEAC@@_7.7 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">parse_args</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">match</span> <span class="nn">List</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">)</span> <span class="k">with</span>
    <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="o">[</span><span class="s2">&quot;-&quot;</span><span class="o">]</span>
    <span class="o">|</span> <span class="n">args</span> <span class="o">-&gt;</span> <span class="n">args</span>

<span class="k">let</span> <span class="n">run_filter</span> <span class="n">func</span> <span class="n">args</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">arg</span> <span class="o">-&gt;</span>
       <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span>
         <span class="k">match</span> <span class="n">arg</span> <span class="k">with</span>
           <span class="o">|</span> <span class="s2">&quot;-&quot;</span> <span class="o">-&gt;</span> <span class="n">stdin</span>
           <span class="o">|</span> <span class="n">arg</span> <span class="o">-&gt;</span> <span class="n">open_in</span> <span class="n">arg</span> <span class="k">in</span>
       <span class="k">try</span>
         <span class="k">begin</span>
           <span class="k">try</span>
             <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
               <span class="n">func</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">in_channel</span><span class="o">)</span>
             <span class="k">done</span>
           <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span>
         <span class="k">end</span><span class="o">;</span>
         <span class="n">close_in</span> <span class="n">in_channel</span>
       <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span>
         <span class="n">close_in</span> <span class="n">in_channel</span><span class="o">;</span>
         <span class="k">raise</span> <span class="n">e</span><span class="o">)</span>
    <span class="n">args</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">run_filter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span>
       <span class="c">(* do something with the line *)</span>
       <span class="bp">()</span><span class="o">)</span>
    <span class="o">(</span><span class="n">parse_args</span> <span class="bp">()</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* arg demo 1: Process optional -c flag *)</span>
<span class="k">let</span> <span class="n">chop_first</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span>
<span class="k">let</span> <span class="n">args</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">parse_args</span> <span class="bp">()</span> <span class="k">with</span>
    <span class="o">|</span> <span class="s2">&quot;-c&quot;</span> <span class="o">::</span> <span class="n">rest</span> <span class="o">-&gt;</span> <span class="n">chop_first</span> <span class="o">:=</span> <span class="bp">true</span><span class="o">;</span> <span class="n">rest</span>
    <span class="o">|</span> <span class="n">args</span> <span class="o">-&gt;</span> <span class="n">args</span>

<span class="c">(* arg demo 2: Process optional -NUMBER flag *)</span>
<span class="k">let</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">ref</span> <span class="nc">None</span>
<span class="k">let</span> <span class="n">args</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">parse_args</span> <span class="bp">()</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">arg</span> <span class="o">::</span> <span class="n">rest</span>
      <span class="k">when</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;^-</span><span class="se">\\</span><span class="s2">([0-9]+</span><span class="se">\\</span><span class="s2">)$&quot;</span><span class="o">)</span> <span class="n">arg</span> <span class="mi">0</span> <span class="o">-&gt;</span>
        <span class="n">columns</span> <span class="o">:=</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">int_of_string</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">1</span> <span class="n">arg</span><span class="o">));</span>
        <span class="n">rest</span>
    <span class="o">|</span> <span class="n">args</span> <span class="o">-&gt;</span> <span class="n">args</span>

<span class="c">(* arg demo 3: Process clustering -a, -i, -n, or -u flags *)</span>
<span class="k">let</span> <span class="n">append</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span>
<span class="k">let</span> <span class="n">ignore_ints</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span>
<span class="k">let</span> <span class="n">nostdout</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span>
<span class="k">let</span> <span class="n">unbuffer</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span>
<span class="k">let</span> <span class="n">args</span> <span class="o">=</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">parse_flags</span> <span class="o">=</span> <span class="k">function</span>
    <span class="o">|</span> <span class="s2">&quot;&quot;</span> <span class="o">-&gt;</span> <span class="bp">()</span>
    <span class="o">|</span> <span class="n">s</span> <span class="o">-&gt;</span>
        <span class="o">(</span><span class="k">match</span> <span class="n">s</span><span class="o">.[</span><span class="mi">0</span><span class="o">]</span> <span class="k">with</span>
           <span class="o">|</span> <span class="sc">&#39;a&#39;</span> <span class="o">-&gt;</span> <span class="n">append</span>      <span class="o">:=</span> <span class="bp">true</span>
           <span class="o">|</span> <span class="sc">&#39;i&#39;</span> <span class="o">-&gt;</span> <span class="n">ignore_ints</span> <span class="o">:=</span> <span class="bp">true</span>
           <span class="o">|</span> <span class="sc">&#39;n&#39;</span> <span class="o">-&gt;</span> <span class="n">nostdout</span>    <span class="o">:=</span> <span class="bp">true</span>
           <span class="o">|</span> <span class="sc">&#39;u&#39;</span> <span class="o">-&gt;</span> <span class="n">unbuffer</span>    <span class="o">:=</span> <span class="bp">true</span>
           <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span>
               <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;usage: %s [-ainu] [filenames] ...</span><span class="se">\n</span><span class="s2">&quot;</span>
                 <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">);</span>
               <span class="n">flush</span> <span class="n">stderr</span><span class="o">;</span>
               <span class="n">exit</span> <span class="mi">255</span><span class="o">);</span>
        <span class="n">parse_flags</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">s</span> <span class="mi">1</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span> <span class="o">-</span> <span class="mi">1</span><span class="o">))</span> <span class="k">in</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">rev</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">fold_left</span>
       <span class="o">(</span><span class="k">fun</span> <span class="n">acc</span> <span class="o">-&gt;</span>
          <span class="k">function</span>
            <span class="o">|</span> <span class="s2">&quot;&quot;</span> <span class="o">-&gt;</span> <span class="n">acc</span>
            <span class="o">|</span> <span class="n">s</span> <span class="k">when</span> <span class="n">s</span><span class="o">.[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="sc">&#39;-&#39;</span> <span class="o">-&gt;</span>
                <span class="n">parse_flags</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">s</span> <span class="mi">1</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span> <span class="o">-</span> <span class="mi">1</span><span class="o">));</span>
                <span class="n">acc</span>
            <span class="o">|</span> <span class="n">arg</span> <span class="o">-&gt;</span> <span class="n">arg</span> <span class="o">::</span> <span class="n">acc</span><span class="o">)</span>
       <span class="bp">[]</span>
       <span class="o">(</span><span class="n">parse_args</span> <span class="bp">()</span><span class="o">))</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* findlogin - print all lines containing the string &quot;login&quot; *)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">run_filter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span>
       <span class="k">if</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;.*login.*&quot;</span><span class="o">)</span> <span class="n">line</span> <span class="mi">0</span>
       <span class="k">then</span> <span class="n">print_endline</span> <span class="n">line</span><span class="o">)</span>
    <span class="o">(</span><span class="n">parse_args</span> <span class="bp">()</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* lowercase - turn all lines into lowercase *)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">run_filter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span> <span class="n">print_endline</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">lowercase</span> <span class="n">line</span><span class="o">))</span>
    <span class="o">(</span><span class="n">parse_args</span> <span class="bp">()</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* countchunks - count how many words are used *)</span>

<span class="k">let</span> <span class="n">chunks</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">run_filter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span>
       <span class="k">if</span> <span class="n">line</span> <span class="o">&lt;&gt;</span> <span class="s2">&quot;&quot;</span> <span class="o">&amp;&amp;</span> <span class="n">line</span><span class="o">.[</span><span class="mi">0</span><span class="o">]</span> <span class="o">==</span> <span class="sc">&#39;#&#39;</span>
       <span class="k">then</span> <span class="bp">()</span>
       <span class="k">else</span> <span class="n">chunks</span> <span class="o">:=</span> <span class="o">!</span><span class="n">chunks</span>
         <span class="o">+</span> <span class="nn">List</span><span class="p">.</span><span class="n">length</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">split</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[ </span><span class="se">\t</span><span class="s2">]+&quot;</span><span class="o">)</span> <span class="n">line</span><span class="o">))</span>
    <span class="o">(</span><span class="n">parse_args</span> <span class="bp">()</span><span class="o">);</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Found %d chunks</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">!</span><span class="n">chunks</span>

<span class="c">(* @@PLEAC@@_7.8 *)</span>
<span class="c">(* Modify a file in place. *)</span>
<span class="k">let</span> <span class="n">modify</span> <span class="n">func</span> <span class="n">old</span> <span class="k">new&#39;</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">old_in</span> <span class="o">=</span> <span class="n">open_in</span> <span class="n">old</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">new_out</span> <span class="o">=</span> <span class="n">open_out</span> <span class="k">new&#39;</span> <span class="k">in</span>
  <span class="k">begin</span>
    <span class="k">try</span>
      <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
        <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">old_in</span> <span class="k">in</span>
        <span class="n">func</span> <span class="n">new_out</span> <span class="n">line</span>
      <span class="k">done</span>
    <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span>
  <span class="k">end</span><span class="o">;</span>
  <span class="n">close_in</span> <span class="n">old_in</span><span class="o">;</span>
  <span class="n">close_out</span> <span class="n">new_out</span><span class="o">;</span>
  <span class="nn">Sys</span><span class="p">.</span><span class="n">rename</span> <span class="n">old</span> <span class="o">(</span><span class="n">old</span> <span class="o">^</span> <span class="s2">&quot;.orig&quot;</span><span class="o">);</span>
  <span class="nn">Sys</span><span class="p">.</span><span class="n">rename</span> <span class="k">new&#39;</span> <span class="n">old</span>

<span class="c">(* Insert lines at line 20. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="n">modify</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">out</span> <span class="n">line</span> <span class="o">-&gt;</span>
       <span class="n">incr</span> <span class="n">count</span><span class="o">;</span>
       <span class="k">if</span> <span class="o">!</span><span class="n">count</span> <span class="o">=</span> <span class="mi">20</span>
       <span class="k">then</span> <span class="o">(</span><span class="n">output_string</span> <span class="n">out</span> <span class="s2">&quot;Extra line 1</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
             <span class="n">output_string</span> <span class="n">out</span> <span class="s2">&quot;Extra line 2</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">);</span>
       <span class="n">output_string</span> <span class="n">out</span> <span class="n">line</span><span class="o">;</span>
       <span class="n">output_string</span> <span class="n">out</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span>
    <span class="n">old</span> <span class="k">new&#39;</span>

<span class="c">(* Delete lines 20..30. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="n">modify</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">out</span> <span class="n">line</span> <span class="o">-&gt;</span>
       <span class="n">incr</span> <span class="n">count</span><span class="o">;</span>
       <span class="k">if</span> <span class="o">!</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">20</span> <span class="o">||</span> <span class="o">!</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">30</span>
       <span class="k">then</span> <span class="o">(</span><span class="n">output_string</span> <span class="n">out</span> <span class="n">line</span><span class="o">;</span>
             <span class="n">output_string</span> <span class="n">out</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">))</span>
    <span class="n">old</span> <span class="k">new&#39;</span>

<span class="c">(* @@PLEAC@@_7.9 *)</span>
<span class="c">(* An equivalent of Perl&#39;s -i switch does not exist in OCaml. *)</span>

<span class="c">(* @@PLEAC@@_7.10 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="c">(* Modify a file in place. *)</span>
<span class="k">let</span> <span class="n">modify</span> <span class="n">func</span> <span class="n">file</span> <span class="o">=</span>
  <span class="k">let</span> <span class="k">in&#39;</span> <span class="o">=</span> <span class="n">open_in</span> <span class="n">file</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="k">begin</span>
    <span class="k">try</span>
      <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
        <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="k">in&#39;</span> <span class="k">in</span>
        <span class="n">lines</span> <span class="o">:=</span> <span class="n">func</span> <span class="n">line</span> <span class="o">::</span> <span class="o">!</span><span class="n">lines</span>
      <span class="k">done</span>
    <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span>
  <span class="k">end</span><span class="o">;</span>
  <span class="n">close_in</span> <span class="k">in&#39;</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="o">!</span><span class="n">lines</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">out</span> <span class="o">=</span> <span class="n">open_out</span> <span class="n">file</span> <span class="k">in</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span>
       <span class="n">output_string</span> <span class="n">out</span> <span class="n">line</span><span class="o">;</span>
       <span class="n">output_string</span> <span class="n">out</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span>
    <span class="n">lines</span><span class="o">;</span>
  <span class="n">close_out</span> <span class="n">out</span>

<span class="c">(* Replace DATE with the current date. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">tm</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">localtime</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">time</span> <span class="bp">()</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">date</span> <span class="o">=</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;%02d/%02d/%04d&quot;</span>
    <span class="o">(</span><span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_mon</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span>
    <span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_mday</span>
    <span class="o">(</span><span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_year</span> <span class="o">+</span> <span class="mi">1900</span><span class="o">)</span> <span class="k">in</span>
  <span class="n">modify</span>
    <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">global_replace</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;DATE&quot;</span><span class="o">)</span> <span class="n">date</span><span class="o">)</span>
    <span class="n">infile</span>

<span class="c">(* @@PLEAC@@_7.11 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">descr</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">openfile</span> <span class="n">path</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">O_RDWR</span><span class="o">]</span> <span class="mo">0o664</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">lockf</span> <span class="n">descr</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">F_LOCK</span> <span class="mi">0</span><span class="o">;</span>
  <span class="c">(* update file, then ... *)</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="n">descr</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">lockf</span> <span class="n">descr</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">F_TLOCK</span> <span class="mi">0</span>
  <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="n">error</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span>
      <span class="s2">&quot;can&#39;t immediately write-lock the file (%s), blocking ...</span><span class="se">\n</span><span class="s2">&quot;</span>
      <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">error_message</span> <span class="n">error</span><span class="o">);</span>
    <span class="n">flush</span> <span class="n">stderr</span><span class="o">;</span>
    <span class="nn">Unix</span><span class="p">.</span><span class="n">lockf</span> <span class="n">descr</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">F_LOCK</span> <span class="mi">0</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">descr</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">openfile</span> <span class="s2">&quot;numfile&quot;</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">O_RDWR</span><span class="o">;</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">O_CREAT</span><span class="o">]</span> <span class="mo">0o664</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">lockf</span> <span class="n">descr</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">F_LOCK</span> <span class="mi">0</span><span class="o">;</span>
  <span class="c">(* Now we have acquired the lock, it&#39;s safe for I/O *)</span>
  <span class="k">let</span> <span class="n">num</span> <span class="o">=</span>
    <span class="k">try</span> <span class="n">int_of_string</span> <span class="o">(</span><span class="n">input_line</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">in_channel_of_descr</span> <span class="n">descr</span><span class="o">))</span>
    <span class="k">with</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">lseek</span> <span class="n">descr</span> <span class="mi">0</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">SEEK_SET</span><span class="o">);</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">ftruncate</span> <span class="n">descr</span> <span class="mi">0</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">out</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">out_channel_of_descr</span> <span class="n">descr</span> <span class="k">in</span>
  <span class="n">output_string</span> <span class="n">out</span> <span class="o">(</span><span class="n">string_of_int</span> <span class="o">(</span><span class="n">num</span> <span class="o">+</span> <span class="mi">1</span><span class="o">));</span>
  <span class="n">output_string</span> <span class="n">out</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
  <span class="n">flush</span> <span class="n">out</span><span class="o">;</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="n">descr</span>

<span class="c">(* @@PLEAC@@_7.12 *)</span>
<span class="c">(* OCaml automatically flushes after calling these functions: *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">print_endline</span> <span class="s2">&quot;I get flushed.&quot;</span><span class="o">;</span>
  <span class="n">print_newline</span> <span class="bp">()</span><span class="o">;</span> <span class="c">(* Me too! *)</span>
  <span class="n">prerr_endline</span> <span class="s2">&quot;So do I.&quot;</span><span class="o">;</span>
  <span class="n">prerr_newline</span> <span class="bp">()</span> <span class="c">(* As do I. *)</span>

<span class="c">(* The Printf functions allow a format specifier of &quot;%!&quot; to trigger</span>
<span class="c">   an immediate flush. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;I flush %s%! and %s!</span><span class="se">\n</span><span class="s2">%!&quot;</span> <span class="s2">&quot;here&quot;</span> <span class="s2">&quot;there&quot;</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* seeme - demo stdio output buffering *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">output_string</span> <span class="n">stdout</span> <span class="s2">&quot;Now you don&#39;t see it...&quot;</span><span class="o">;</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">sleep</span> <span class="mi">2</span><span class="o">;</span>
  <span class="n">print_endline</span> <span class="s2">&quot;now you do&quot;</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* A channel can be explicitly flushed: *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">flush</span> <span class="n">stderr</span>

<span class="c">(* All channels can be flushed at once (errors are ignored): *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">flush_all</span> <span class="bp">()</span>

<span class="c">(* Closing a channel flushes automatically: *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">output_string</span> <span class="n">stdout</span> <span class="s2">&quot;I get written.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
  <span class="n">close_out</span> <span class="n">stdout</span>

<span class="c">(* Calls to exit result in a flush_all, and exit is always called at</span>
<span class="c">   termination even if an error occurs. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">output_string</span> <span class="n">stderr</span> <span class="s2">&quot;Bye!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
  <span class="n">exit</span> <span class="mi">0</span>

<span class="c">(* @@PLEAC@@_7.13 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* list all file descriptors to poll *)</span>
  <span class="k">let</span> <span class="n">readers</span> <span class="o">=</span> <span class="o">[</span><span class="n">file_descr1</span><span class="o">;</span> <span class="n">file_descr2</span><span class="o">;</span> <span class="n">file_descr3</span><span class="o">]</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">ready</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">select</span> <span class="n">readers</span> <span class="bp">[]</span> <span class="bp">[]</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span> <span class="k">in</span>
  <span class="c">(* input waiting on the filehandles in &quot;ready&quot; *)</span>
  <span class="bp">()</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">in_channel_of_descr</span> <span class="n">file_descr</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">found</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">select</span> <span class="o">[</span><span class="n">file_descr</span><span class="o">]</span> <span class="bp">[]</span> <span class="bp">[]</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span> <span class="c">(* just check *)</span> <span class="k">in</span>
  <span class="k">match</span> <span class="n">found</span> <span class="k">with</span>
    <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="bp">()</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span>
        <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">in_channel</span> <span class="k">in</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;I read %s</span><span class="se">\n</span><span class="s2">%!&quot;</span> <span class="n">line</span>

<span class="c">(* @@PLEAC@@_7.14 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="c">(* Pass the O_NONBLOCK flag when calling Unix.openfile. *)</span>
<span class="k">let</span> <span class="n">file_descr</span> <span class="o">=</span>
  <span class="k">try</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">openfile</span> <span class="s2">&quot;/dev/cua0&quot;</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">O_RDWR</span><span class="o">;</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">O_NONBLOCK</span><span class="o">]</span> <span class="mo">0o666</span>
  <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="n">code</span><span class="o">,</span> <span class="n">func</span><span class="o">,</span> <span class="n">param</span><span class="o">)</span> <span class="o">-&gt;</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Can&#39;t open modem: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">error_message</span> <span class="n">code</span><span class="o">);</span>
    <span class="n">exit</span> <span class="mi">2</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* If the file descriptor already exists, use Unix.set_nonblock. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">set_nonblock</span> <span class="n">file_descr</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* In non-blocking mode, calls that would block throw exceptions. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">chars_written</span> <span class="o">=</span>
    <span class="k">try</span>
      <span class="nc">Some</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">single_write</span> <span class="n">file_descr</span> <span class="n">buffer</span> <span class="mi">0</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">buffer</span><span class="o">))</span>
    <span class="k">with</span>
      <span class="o">|</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">EAGAIN</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span>
      <span class="o">|</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">EWOULDBLOCK</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="o">-&gt;</span> <span class="nc">None</span> <span class="k">in</span>
  <span class="k">match</span> <span class="n">chars_written</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">Some</span> <span class="n">n</span> <span class="k">when</span> <span class="n">n</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">buffer</span> <span class="o">-&gt;</span>
        <span class="c">(* successfully wrote *)</span>
        <span class="bp">()</span>
    <span class="o">|</span> <span class="nc">Some</span> <span class="n">n</span> <span class="o">-&gt;</span>
        <span class="c">(* incomplete write *)</span>
        <span class="bp">()</span>
    <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span>
        <span class="c">(* would block *)</span>
        <span class="bp">()</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">chars_read</span> <span class="o">=</span>
    <span class="k">try</span>
      <span class="nc">Some</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">read</span> <span class="n">file_descr</span> <span class="n">buffer</span> <span class="mi">0</span> <span class="n">buffer_size</span><span class="o">)</span>
    <span class="k">with</span>
      <span class="o">|</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">EAGAIN</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span>
      <span class="o">|</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">EWOULDBLOCK</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="o">-&gt;</span> <span class="nc">None</span> <span class="k">in</span>
  <span class="k">match</span> <span class="n">chars_read</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">Some</span> <span class="n">n</span> <span class="o">-&gt;</span>
        <span class="c">(* successfully read n bytes from file_descr *)</span>
        <span class="bp">()</span>
    <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span>
        <span class="c">(* would block *)</span>
        <span class="bp">()</span>

<span class="c">(* @@PLEAC@@_7.15 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="c">(* OCaml does not expose the FIONREAD ioctl call. It&#39;s better to use</span>
<span class="c">   non-blocking reads anyway. There is the following function in</span>
<span class="c">   Pervasives which gives you the length of an input channel, but it</span>
<span class="c">   works by doing a seek so it only works on regular files: *)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">length</span> <span class="o">=</span> <span class="n">in_channel_length</span> <span class="n">in_channel</span> <span class="k">in</span>
  <span class="c">(* ... *)</span>
  <span class="bp">()</span>

<span class="c">(* @@PLEAC@@_7.16 *)</span>
<span class="c">(* Channels and file descriptors are ordinary, first-class values in</span>
<span class="c">   OCaml. No special contortions are necessary to store them in data</span>
<span class="c">   structures, pass them as arguments, etc. *)</span>

<span class="c">(* @@PLEAC@@_7.17 *)</span>
<span class="k">module</span> <span class="nc">FileCache</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">let</span> <span class="n">isopen</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span>
  <span class="k">let</span> <span class="n">maxopen</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">16</span>

  <span class="k">let</span> <span class="n">resize</span> <span class="bp">()</span> <span class="o">=</span>
    <span class="k">if</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">length</span> <span class="n">isopen</span> <span class="o">&gt;=</span> <span class="o">!</span><span class="n">maxopen</span>
    <span class="k">then</span>
      <span class="k">begin</span>
        <span class="k">let</span> <span class="n">newlen</span> <span class="o">=</span> <span class="o">!</span><span class="n">maxopen</span> <span class="o">/</span> <span class="mi">3</span> <span class="k">in</span>
        <span class="k">let</span> <span class="n">items</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
        <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span>
          <span class="o">(</span><span class="k">fun</span> <span class="n">filename</span> <span class="o">(</span><span class="n">chan</span><span class="o">,</span> <span class="n">count</span><span class="o">)</span> <span class="o">-&gt;</span>
             <span class="n">items</span> <span class="o">:=</span> <span class="o">(</span><span class="n">count</span><span class="o">,</span> <span class="n">filename</span><span class="o">,</span> <span class="n">chan</span><span class="o">)</span> <span class="o">::</span> <span class="o">!</span><span class="n">items</span><span class="o">)</span>
          <span class="n">isopen</span><span class="o">;</span>
        <span class="k">let</span> <span class="n">items</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">of_list</span> <span class="o">!</span><span class="n">items</span> <span class="k">in</span>
        <span class="nn">Array</span><span class="p">.</span><span class="n">sort</span> <span class="n">compare</span> <span class="n">items</span><span class="o">;</span>
        <span class="k">let</span> <span class="n">pivot</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">items</span> <span class="o">-</span> <span class="n">newlen</span> <span class="k">in</span>
        <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">to</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">items</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">do</span>
          <span class="k">let</span> <span class="o">(</span><span class="n">count</span><span class="o">,</span> <span class="n">filename</span><span class="o">,</span> <span class="n">chan</span><span class="o">)</span> <span class="o">=</span> <span class="n">items</span><span class="o">.(</span><span class="n">i</span><span class="o">)</span> <span class="k">in</span>
          <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pivot</span>
          <span class="k">then</span> <span class="o">(</span><span class="n">close_out</span> <span class="n">chan</span><span class="o">;</span>
                <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">remove</span> <span class="n">isopen</span> <span class="n">filename</span><span class="o">)</span>
          <span class="k">else</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">isopen</span> <span class="n">filename</span> <span class="o">(</span><span class="n">chan</span><span class="o">,</span> <span class="mi">0</span><span class="o">))</span>
        <span class="k">done</span>
      <span class="k">end</span>

  <span class="k">let</span> <span class="n">output</span> <span class="o">?(</span><span class="n">mode</span><span class="o">=[</span><span class="nc">Open_creat</span><span class="o">;</span> <span class="nc">Open_append</span><span class="o">])</span> <span class="o">?(</span><span class="n">perm</span><span class="o">=</span><span class="mo">0o640</span><span class="o">)</span> <span class="n">filename</span> <span class="n">data</span> <span class="o">=</span>
    <span class="k">let</span> <span class="o">(</span><span class="n">chan</span><span class="o">,</span> <span class="n">count</span><span class="o">)</span> <span class="o">=</span>
      <span class="k">try</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">isopen</span> <span class="n">filename</span>
      <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
        <span class="n">resize</span> <span class="bp">()</span><span class="o">;</span>
        <span class="o">(</span><span class="n">open_out_gen</span> <span class="n">mode</span> <span class="n">perm</span> <span class="n">filename</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span> <span class="k">in</span>
    <span class="n">output_string</span> <span class="n">chan</span> <span class="n">data</span><span class="o">;</span>
    <span class="n">flush</span> <span class="n">chan</span><span class="o">;</span>
    <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">isopen</span> <span class="n">filename</span> <span class="o">(</span><span class="n">chan</span><span class="o">,</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span>

  <span class="k">let</span> <span class="n">close</span> <span class="n">filename</span> <span class="o">=</span>
    <span class="k">try</span>
      <span class="k">match</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">isopen</span> <span class="n">filename</span> <span class="k">with</span> <span class="o">(</span><span class="n">chan</span><span class="o">,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
        <span class="n">close_out</span> <span class="n">chan</span><span class="o">;</span>
        <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">remove</span> <span class="n">isopen</span> <span class="n">filename</span>
    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">()</span>
<span class="k">end</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* splitwulog - split wuftpd log by authenticated user *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">outdir</span> <span class="o">=</span> <span class="s2">&quot;/var/log/ftp/by-user&quot;</span>
<span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot; &quot;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">stdin</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">chunks</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">of_list</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">split</span> <span class="n">regexp</span> <span class="n">line</span><span class="o">)</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">user</span> <span class="o">=</span> <span class="n">chunks</span><span class="o">.(</span><span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">chunks</span> <span class="o">-</span> <span class="mi">5</span><span class="o">)</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">path</span> <span class="o">=</span> <span class="nn">Filename</span><span class="p">.</span><span class="n">concat</span> <span class="n">outdir</span> <span class="n">user</span> <span class="k">in</span>
      <span class="nn">FileCache</span><span class="p">.</span><span class="n">output</span> <span class="n">path</span> <span class="o">(</span><span class="n">line</span> <span class="o">^</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span>

<span class="c">(* @@PLEAC@@_7.18 *)</span>
<span class="c">(* Save your channels in a list and iterate through them normally. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">channel</span> <span class="o">-&gt;</span>
       <span class="n">output_string</span> <span class="n">channel</span> <span class="n">stuff_to_print</span><span class="o">)</span>
    <span class="n">channels</span>

<span class="c">(* For convenience, you can define a helper function and use currying. *)</span>
<span class="k">let</span> <span class="n">write</span> <span class="n">data</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">output_string</span> <span class="n">channel</span> <span class="n">data</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="n">write</span> <span class="n">stuff_to_print</span><span class="o">)</span> <span class="n">channels</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Open a pipe to &quot;tee&quot;. Requires a Unix environment. *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">channel</span> <span class="o">=</span>
    <span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_out</span> <span class="s2">&quot;tee file1 file2 file3 &gt;/dev/null&quot;</span> <span class="k">in</span>
  <span class="n">output_string</span> <span class="n">channel</span> <span class="s2">&quot;whatever</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_out</span> <span class="n">channel</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Redirect standard output to a tee. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">reader</span><span class="o">,</span> <span class="n">writer</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">pipe</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="k">match</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">fork</span> <span class="bp">()</span> <span class="k">with</span>
    <span class="o">|</span> <span class="mi">0</span> <span class="o">-&gt;</span>
        <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="n">writer</span><span class="o">;</span>
        <span class="nn">Unix</span><span class="p">.</span><span class="n">dup2</span> <span class="n">reader</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span><span class="o">;</span>
        <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="n">reader</span><span class="o">;</span>
        <span class="nn">Unix</span><span class="p">.</span><span class="n">execvp</span> <span class="s2">&quot;tee&quot;</span> <span class="o">[|</span> <span class="s2">&quot;tee&quot;</span><span class="o">;</span> <span class="s2">&quot;file1&quot;</span><span class="o">;</span> <span class="s2">&quot;file2&quot;</span><span class="o">;</span> <span class="s2">&quot;file3&quot;</span> <span class="o">|]</span>
    <span class="o">|</span> <span class="n">pid</span> <span class="o">-&gt;</span>
        <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="n">reader</span><span class="o">;</span>
        <span class="nn">Unix</span><span class="p">.</span><span class="n">dup2</span> <span class="n">writer</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdout</span><span class="o">;</span>
        <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="n">writer</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">print_endline</span> <span class="s2">&quot;whatever&quot;</span><span class="o">;</span>
  <span class="n">close_out</span> <span class="n">stdout</span><span class="o">;</span>
  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">wait</span> <span class="bp">()</span><span class="o">)</span>

<span class="c">(* @@PLEAC@@_7.19 *)</span>
<span class="c">(* An abstraction barrier exists between file descriptor numbers and</span>
<span class="c">   file_descr values, but Ocamlnet provides functions in the Netsys</span>
<span class="c">   module to map between the two. *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+netsys&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;netsys.cma&quot;</span><span class="o">;;</span>

<span class="c">(* Open the descriptor itself. *)</span>
<span class="k">let</span> <span class="n">file_descr</span> <span class="o">=</span> <span class="nn">Netsys</span><span class="p">.</span><span class="n">file_descr_of_int</span> <span class="n">fdnum</span>
<span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">in_channel_of_descr</span> <span class="n">file_descr</span>

<span class="c">(* Open a copy of the descriptor. *)</span>
<span class="k">let</span> <span class="n">file_descr</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">dup</span> <span class="o">(</span><span class="nn">Netsys</span><span class="p">.</span><span class="n">file_descr_of_int</span> <span class="n">fdnum</span><span class="o">)</span>
<span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">in_channel_of_descr</span> <span class="n">file_descr</span>

<span class="c">(* After processing... *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">close_in</span> <span class="n">in_channel</span>

<span class="c">(* @@PLEAC@@_7.20 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* Take copies of the file descriptors. *)</span>
  <span class="k">let</span> <span class="n">oldout</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">dup</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdout</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">olderr</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">dup</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stderr</span> <span class="k">in</span>

  <span class="c">(* Redirect stdout and stderr. *)</span>
  <span class="k">let</span> <span class="n">output</span> <span class="o">=</span>
    <span class="nn">Unix</span><span class="p">.</span><span class="n">openfile</span>
      <span class="s2">&quot;/tmp/program.out&quot;</span>
      <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">O_WRONLY</span><span class="o">;</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">O_CREAT</span><span class="o">;</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">O_TRUNC</span><span class="o">]</span>
      <span class="mo">0o666</span> <span class="k">in</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">dup2</span> <span class="n">output</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdout</span><span class="o">;</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="n">output</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">copy</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">dup</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdout</span> <span class="k">in</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">dup2</span> <span class="n">copy</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stderr</span><span class="o">;</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="n">copy</span><span class="o">;</span>

  <span class="c">(* Run the program. *)</span>
  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">system</span> <span class="n">joe_random_process</span><span class="o">);</span>

  <span class="c">(* Close the redirected file handles. *)</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdout</span><span class="o">;</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stderr</span><span class="o">;</span>

  <span class="c">(* Restore stdout and stderr. *)</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">dup2</span> <span class="n">oldout</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdout</span><span class="o">;</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">dup2</span> <span class="n">olderr</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stderr</span><span class="o">;</span>

  <span class="c">(* Avoid leaks by closing the independent copies. *)</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="n">oldout</span><span class="o">;</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="n">olderr</span>

<span class="c">(* @@PLEAC@@_7.21 *)</span>
<span class="n">drivelock</span><span class="o">.</span><span class="n">ml</span><span class="o">:</span>

<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* drivelock - demo LockDir module *)</span>
<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;netlock.ml&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">die</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">prerr_endline</span> <span class="n">msg</span><span class="o">;</span> <span class="n">exit</span> <span class="mi">1</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Sys</span><span class="p">.</span><span class="n">set_signal</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigint</span>
    <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="nc">Signal_handle</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">die</span> <span class="s2">&quot;outta here&quot;</span><span class="o">));</span>
  <span class="nn">LockDir</span><span class="p">.</span><span class="n">debug</span> <span class="o">:=</span> <span class="bp">true</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">path</span> <span class="o">=</span>
    <span class="k">try</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span>
    <span class="k">with</span> <span class="nc">Invalid_argument</span> <span class="o">_</span> <span class="o">-&gt;</span>
      <span class="n">die</span> <span class="o">(</span><span class="s2">&quot;usage: &quot;</span> <span class="o">^</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span> <span class="o">^</span> <span class="s2">&quot; &lt;path&gt;&quot;</span><span class="o">)</span> <span class="k">in</span>
  <span class="o">(</span><span class="k">try</span> <span class="nn">LockDir</span><span class="p">.</span><span class="n">nflock</span> <span class="o">~</span><span class="n">naptime</span><span class="o">:</span><span class="mi">2</span> <span class="n">path</span>
   <span class="k">with</span> <span class="nn">LockDir</span><span class="p">.</span><span class="nc">Error</span> <span class="o">_</span> <span class="o">-&gt;</span>
     <span class="n">die</span> <span class="o">(</span><span class="s2">&quot;couldn&#39;t lock &quot;</span> <span class="o">^</span> <span class="n">path</span> <span class="o">^</span> <span class="s2">&quot; in 2 seconds&quot;</span><span class="o">));</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">sleep</span> <span class="mi">100</span><span class="o">;</span>
  <span class="nn">LockDir</span><span class="p">.</span><span class="n">nunflock</span> <span class="n">path</span>

<span class="c">(*-----------------------------*)</span>

<span class="n">netlock</span><span class="o">.</span><span class="n">ml</span><span class="o">:</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="c">(* module to provide very basic filename-level *)</span>
<span class="c">(* locks.  No fancy systems calls.  In theory, *)</span>
<span class="c">(* directory info is sync&#39;d over NFS.  Not *)</span>
<span class="c">(* stress tested. *)</span>

<span class="k">module</span> <span class="nc">LockDir</span> <span class="o">:</span>
<span class="k">sig</span>

  <span class="k">exception</span> <span class="nc">Error</span> <span class="k">of</span> <span class="kt">string</span>

  <span class="k">val</span> <span class="n">debug</span> <span class="o">:</span> <span class="kt">bool</span> <span class="n">ref</span>
  <span class="k">val</span> <span class="n">check</span> <span class="o">:</span> <span class="kt">int</span> <span class="n">ref</span>
  <span class="k">val</span> <span class="n">nflock</span> <span class="o">:</span> <span class="o">?</span><span class="n">naptime</span><span class="o">:</span><span class="kt">int</span> <span class="o">-&gt;</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="kt">unit</span>
  <span class="k">val</span> <span class="n">nunflock</span> <span class="o">:</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="kt">unit</span>

<span class="k">end</span> <span class="o">=</span> <span class="k">struct</span>

  <span class="k">exception</span> <span class="nc">Error</span> <span class="k">of</span> <span class="kt">string</span>

  <span class="k">let</span> <span class="n">debug</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span>
  <span class="k">let</span> <span class="n">check</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">1</span>

  <span class="k">module</span> <span class="nc">StringSet</span> <span class="o">=</span> <span class="nn">Set</span><span class="p">.</span><span class="nc">Make</span><span class="o">(</span><span class="nc">String</span><span class="o">)</span>
  <span class="k">let</span> <span class="n">locked_files</span> <span class="o">=</span> <span class="n">ref</span> <span class="nn">StringSet</span><span class="p">.</span><span class="n">empty</span>

  <span class="c">(* helper function *)</span>
  <span class="k">let</span> <span class="n">name2lock</span> <span class="n">pathname</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">dir</span> <span class="o">=</span> <span class="nn">Filename</span><span class="p">.</span><span class="n">dirname</span> <span class="n">pathname</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">file</span> <span class="o">=</span> <span class="nn">Filename</span><span class="p">.</span><span class="n">basename</span> <span class="n">pathname</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">dir</span> <span class="o">=</span> <span class="k">if</span> <span class="n">dir</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span> <span class="k">then</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">getcwd</span> <span class="bp">()</span> <span class="k">else</span> <span class="n">dir</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">lockname</span> <span class="o">=</span> <span class="nn">Filename</span><span class="p">.</span><span class="n">concat</span> <span class="n">dir</span> <span class="o">(</span><span class="n">file</span> <span class="o">^</span> <span class="s2">&quot;.LOCKDIR&quot;</span><span class="o">)</span> <span class="k">in</span>
    <span class="n">lockname</span>

  <span class="k">let</span> <span class="n">nflock</span> <span class="o">?(</span><span class="n">naptime</span><span class="o">=</span><span class="mi">0</span><span class="o">)</span> <span class="n">pathname</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">lockname</span> <span class="o">=</span> <span class="n">name2lock</span> <span class="n">pathname</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">whosegot</span> <span class="o">=</span> <span class="nn">Filename</span><span class="p">.</span><span class="n">concat</span> <span class="n">lockname</span> <span class="s2">&quot;owner&quot;</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">start</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">time</span> <span class="bp">()</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">missed</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>

    <span class="c">(* if locking what I&#39;ve already locked, raise exception *)</span>
    <span class="k">if</span> <span class="nn">StringSet</span><span class="p">.</span><span class="n">mem</span> <span class="n">pathname</span> <span class="o">!</span><span class="n">locked_files</span>
    <span class="k">then</span> <span class="k">raise</span> <span class="o">(</span><span class="nc">Error</span> <span class="o">(</span><span class="n">pathname</span> <span class="o">^</span> <span class="s2">&quot; already locked&quot;</span><span class="o">));</span>

    <span class="nn">Unix</span><span class="p">.</span><span class="n">access</span> <span class="o">(</span><span class="nn">Filename</span><span class="p">.</span><span class="n">dirname</span> <span class="n">pathname</span><span class="o">)</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">W_OK</span><span class="o">];</span>

    <span class="k">begin</span>
      <span class="k">try</span>
        <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
          <span class="k">try</span>
            <span class="nn">Unix</span><span class="p">.</span><span class="n">mkdir</span> <span class="n">lockname</span> <span class="mo">0o777</span><span class="o">;</span>
            <span class="k">raise</span> <span class="nc">Exit</span>
          <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
            <span class="n">incr</span> <span class="n">missed</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">!</span><span class="n">missed</span> <span class="o">&gt;</span> <span class="mi">10</span>
            <span class="k">then</span> <span class="k">raise</span> <span class="o">(</span><span class="nc">Error</span>
                          <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;can&#39;t get %s: %s&quot;</span>
                             <span class="n">lockname</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">error_message</span> <span class="n">e</span><span class="o">)));</span>
            <span class="k">if</span> <span class="o">!</span><span class="n">debug</span>
            <span class="k">then</span>
              <span class="k">begin</span>
                <span class="k">let</span> <span class="n">owner</span> <span class="o">=</span> <span class="n">open_in</span> <span class="n">whosegot</span> <span class="k">in</span>
                <span class="k">let</span> <span class="n">lockee</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">owner</span> <span class="k">in</span>
                <span class="n">close_in</span> <span class="n">owner</span><span class="o">;</span>
                <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s[%d]: lock on %s held by %s</span><span class="se">\n</span><span class="s2">%!&quot;</span>
                  <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">getpid</span> <span class="bp">()</span><span class="o">)</span> <span class="n">pathname</span> <span class="n">lockee</span>
              <span class="k">end</span><span class="o">;</span>
            <span class="nn">Unix</span><span class="p">.</span><span class="n">sleep</span> <span class="o">!</span><span class="n">check</span><span class="o">;</span>
            <span class="k">if</span> <span class="n">naptime</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">time</span> <span class="bp">()</span> <span class="o">&gt;</span> <span class="n">start</span> <span class="o">+.</span> <span class="kt">float</span> <span class="n">naptime</span>
            <span class="k">then</span> <span class="k">raise</span> <span class="nc">Exit</span>
        <span class="k">done</span>
      <span class="k">with</span> <span class="nc">Exit</span> <span class="o">-&gt;</span> <span class="bp">()</span>
    <span class="k">end</span><span class="o">;</span>

    <span class="k">let</span> <span class="n">owner</span> <span class="o">=</span>
      <span class="k">try</span>
        <span class="n">open_out_gen</span> <span class="o">[</span><span class="nc">Open_wronly</span><span class="o">;</span> <span class="nc">Open_creat</span><span class="o">;</span> <span class="nc">Open_excl</span><span class="o">]</span> <span class="mo">0o666</span> <span class="n">whosegot</span>
      <span class="k">with</span> <span class="nc">Sys_error</span> <span class="n">e</span> <span class="o">-&gt;</span>
        <span class="k">raise</span> <span class="o">(</span><span class="nc">Error</span> <span class="o">(</span><span class="s2">&quot;can&#39;t create &quot;</span> <span class="o">^</span> <span class="n">e</span><span class="o">))</span> <span class="k">in</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">fprintf</span> <span class="n">owner</span> <span class="s2">&quot;%s[%d] on %s</span><span class="se">\n</span><span class="s2">&quot;</span>
      <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">getpid</span> <span class="bp">()</span><span class="o">)</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">gethostname</span> <span class="bp">()</span><span class="o">);</span>
    <span class="n">close_out</span> <span class="n">owner</span><span class="o">;</span>
    <span class="n">locked_files</span> <span class="o">:=</span> <span class="nn">StringSet</span><span class="p">.</span><span class="n">add</span> <span class="n">pathname</span> <span class="o">!</span><span class="n">locked_files</span>

  <span class="c">(* free the locked file *)</span>
  <span class="k">let</span> <span class="n">nunflock</span> <span class="n">pathname</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">lockname</span> <span class="o">=</span> <span class="n">name2lock</span> <span class="n">pathname</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">whosegot</span> <span class="o">=</span> <span class="nn">Filename</span><span class="p">.</span><span class="n">concat</span> <span class="n">lockname</span> <span class="s2">&quot;owner&quot;</span> <span class="k">in</span>
    <span class="nn">Unix</span><span class="p">.</span><span class="n">unlink</span> <span class="n">whosegot</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">!</span><span class="n">debug</span> <span class="k">then</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;releasing lock on %s</span><span class="se">\n</span><span class="s2">%!&quot;</span> <span class="n">lockname</span><span class="o">;</span>
    <span class="n">locked_files</span> <span class="o">:=</span> <span class="nn">StringSet</span><span class="p">.</span><span class="n">remove</span> <span class="n">pathname</span> <span class="o">!</span><span class="n">locked_files</span><span class="o">;</span>
    <span class="nn">Unix</span><span class="p">.</span><span class="n">rmdir</span> <span class="n">lockname</span>

  <span class="c">(* anything forgotten? *)</span>
  <span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
    <span class="n">at_exit</span>
      <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span>
         <span class="nn">StringSet</span><span class="p">.</span><span class="n">iter</span>
           <span class="o">(</span><span class="k">fun</span> <span class="n">pathname</span> <span class="o">-&gt;</span>
              <span class="k">let</span> <span class="n">lockname</span> <span class="o">=</span> <span class="n">name2lock</span> <span class="n">pathname</span> <span class="k">in</span>
              <span class="k">let</span> <span class="n">whosegot</span> <span class="o">=</span> <span class="nn">Filename</span><span class="p">.</span><span class="n">concat</span> <span class="n">lockname</span> <span class="s2">&quot;owner&quot;</span> <span class="k">in</span>
              <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;releasing forgotten %s</span><span class="se">\n</span><span class="s2">%!&quot;</span> <span class="n">lockname</span><span class="o">;</span>
              <span class="nn">Unix</span><span class="p">.</span><span class="n">unlink</span> <span class="n">whosegot</span><span class="o">;</span>
              <span class="nn">Unix</span><span class="p">.</span><span class="n">rmdir</span> <span class="n">lockname</span><span class="o">)</span>
           <span class="o">!</span><span class="n">locked_files</span><span class="o">)</span>
<span class="k">end</span>

<span class="c">(* @@PLEAC@@_7.22 *)</span>
<span class="c">(* The &quot;fcntl&quot; system call is not available in the OCaml standard library.</span>
<span class="c">   You would have to drop down to C in order to lock regions of a file as</span>
<span class="c">   described in the original Perl recipe. *)</span>


<span class="c">(* @@PLEAC@@_8.0 *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">datafile</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">size</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">line</span> <span class="k">in</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">size</span>             <span class="c">(* output size of line *)</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">line_stream_of_channel</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">channel</span><span class="o">)</span> <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="nc">None</span><span class="o">)</span>

<span class="k">let</span> <span class="n">output_size</span> <span class="n">line</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">line</span><span class="o">)</span> <span class="c">(* output size of line *)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">iter</span> <span class="n">output_size</span> <span class="o">(</span><span class="n">line_stream_of_channel</span> <span class="n">datafile</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">lines</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">xs</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">xs</span> <span class="o">:=</span> <span class="n">x</span> <span class="o">::</span> <span class="o">!</span><span class="n">xs</span><span class="o">)</span>
    <span class="o">(</span><span class="n">line_stream_of_channel</span> <span class="n">datafile</span><span class="o">);</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="o">!</span><span class="n">xs</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">slurp_channel</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">buffer_size</span> <span class="o">=</span> <span class="mi">4096</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">create</span> <span class="n">buffer_size</span> <span class="k">in</span>
  <span class="k">let</span> <span class="kt">string</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">create</span> <span class="n">buffer_size</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">chars_read</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">1</span> <span class="k">in</span>
  <span class="k">while</span> <span class="o">!</span><span class="n">chars_read</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="k">do</span>
    <span class="n">chars_read</span> <span class="o">:=</span> <span class="n">input</span> <span class="n">channel</span> <span class="kt">string</span> <span class="mi">0</span> <span class="n">buffer_size</span><span class="o">;</span>
    <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_substring</span> <span class="n">buffer</span> <span class="kt">string</span> <span class="mi">0</span> <span class="o">!</span><span class="n">chars_read</span>
  <span class="k">done</span><span class="o">;</span>
  <span class="nn">Buffer</span><span class="p">.</span><span class="n">contents</span> <span class="n">buffer</span>

<span class="k">let</span> <span class="n">slurp_file</span> <span class="n">filename</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">open_in_bin</span> <span class="n">filename</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">result</span> <span class="o">=</span>
    <span class="k">try</span> <span class="n">slurp_channel</span> <span class="n">channel</span>
    <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">close_in</span> <span class="n">channel</span><span class="o">;</span> <span class="k">raise</span> <span class="n">e</span> <span class="k">in</span>
  <span class="n">close_in</span> <span class="n">channel</span><span class="o">;</span>
  <span class="n">result</span>

<span class="k">let</span> <span class="n">whole_file</span> <span class="o">=</span> <span class="n">slurp_file</span> <span class="n">filename</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* Onetwothree *)</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="n">output_string</span> <span class="n">handle</span><span class="o">)</span> <span class="o">[</span><span class="s2">&quot;One&quot;</span><span class="o">;</span> <span class="s2">&quot;two&quot;</span><span class="o">;</span> <span class="s2">&quot;three&quot;</span><span class="o">];</span>

  <span class="c">(* Sent to default output handle *)</span>
  <span class="n">print_string</span> <span class="s2">&quot;Baa baa black sheep</span><span class="se">\n</span><span class="s2">&quot;</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="mi">4096</span> <span class="sc">&#39;\000&#39;</span>
<span class="k">let</span> <span class="n">rv</span> <span class="o">=</span> <span class="n">input</span> <span class="n">handle</span> <span class="n">buffer</span> <span class="mi">0</span> <span class="mi">4096</span>
<span class="c">(* rv is the number of bytes read, *)</span>
<span class="c">(* buffer holds the data read *)</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">ftruncate</span> <span class="n">descr</span> <span class="n">length</span><span class="o">;</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">truncate</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;/tmp/%d.pid&quot;</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">getpid</span> <span class="bp">()</span><span class="o">))</span> <span class="n">length</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">pos</span> <span class="o">=</span> <span class="n">pos_in</span> <span class="n">datafile</span> <span class="k">in</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;I&#39;m %d bytes from the start of datafile.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">pos</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">seek_in</span> <span class="n">in_channel</span> <span class="n">pos</span><span class="o">;</span>
  <span class="n">seek_out</span> <span class="n">out_channel</span> <span class="n">pos</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">lseek</span> <span class="n">descr</span> <span class="mi">0</span>     <span class="nn">Unix</span><span class="p">.</span><span class="nc">SEEK_END</span><span class="o">;</span> <span class="c">(* seek to the end    *)</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">lseek</span> <span class="n">descr</span> <span class="n">pos</span>   <span class="nn">Unix</span><span class="p">.</span><span class="nc">SEEK_SET</span><span class="o">;</span> <span class="c">(* seek to pos        *)</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">lseek</span> <span class="n">descr</span> <span class="o">(-</span><span class="mi">20</span><span class="o">)</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">SEEK_CUR</span><span class="o">;</span> <span class="c">(* seek back 20 bytes *)</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">written</span> <span class="o">=</span>
    <span class="nn">Unix</span><span class="p">.</span><span class="n">write</span> <span class="n">datafile</span> <span class="n">mystring</span> <span class="mi">0</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">mystring</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">read</span> <span class="o">=</span>
    <span class="nn">Unix</span><span class="p">.</span><span class="n">read</span> <span class="n">datafile</span> <span class="n">mystring</span> <span class="mi">5</span> <span class="mi">256</span> <span class="k">in</span>
  <span class="k">if</span> <span class="n">read</span> <span class="o">&lt;&gt;</span> <span class="mi">256</span> <span class="k">then</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;only read %d bytes, not 256</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">read</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* don&#39;t change position *)</span>
  <span class="k">let</span> <span class="n">pos</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">lseek</span> <span class="n">handle</span> <span class="mi">0</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">SEEK_CUR</span> <span class="k">in</span>
  <span class="c">(* ... *)</span>
  <span class="bp">()</span>

<span class="c">(* @@PLEAC@@_8.1 *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">create</span> <span class="mi">16</span> <span class="k">in</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span> <span class="bp">()</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">chan</span> <span class="k">in</span>
    <span class="k">if</span> <span class="n">line</span> <span class="o">&lt;&gt;</span> <span class="s2">&quot;&quot;</span> <span class="o">&amp;&amp;</span> <span class="n">line</span><span class="o">.[</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">line</span> <span class="o">-</span> <span class="mi">1</span><span class="o">]</span> <span class="o">=</span> <span class="sc">&#39;\\&#39;</span>
    <span class="k">then</span> <span class="o">(</span><span class="nn">Buffer</span><span class="p">.</span><span class="n">add_string</span>
            <span class="n">buffer</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">line</span> <span class="mi">0</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">line</span> <span class="o">-</span> <span class="mi">1</span><span class="o">));</span>
          <span class="n">loop</span> <span class="bp">()</span><span class="o">)</span>
    <span class="k">else</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_string</span> <span class="n">buffer</span> <span class="n">line</span><span class="o">;</span>
    <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">contents</span> <span class="n">buffer</span> <span class="k">in</span>
    <span class="nn">Buffer</span><span class="p">.</span><span class="n">clear</span> <span class="n">buffer</span><span class="o">;</span>
    <span class="c">(* process full record in line here *)</span>
    <span class="n">loop</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="k">try</span> <span class="n">loop</span> <span class="bp">()</span> <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span>

<span class="c">(* @@PLEAC@@_8.2 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">proc</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_in</span> <span class="o">(</span><span class="s2">&quot;wc -l &lt; &quot;</span> <span class="o">^</span> <span class="n">file</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">count</span> <span class="o">=</span> <span class="n">int_of_string</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">proc</span><span class="o">)</span> <span class="k">in</span>
  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_in</span> <span class="n">proc</span><span class="o">);</span>
  <span class="c">(* count now holds the number of lines read *)</span>
  <span class="bp">()</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">open_in</span> <span class="n">file</span> <span class="k">in</span>
  <span class="o">(</span><span class="k">try</span>
     <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
       <span class="n">ignore</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">chan</span><span class="o">);</span>
       <span class="n">incr</span> <span class="n">count</span>
     <span class="k">done</span>
   <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="n">close_in</span> <span class="n">chan</span><span class="o">);</span>
  <span class="c">(* !count now holds the number of lines read *)</span>
  <span class="bp">()</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">delim</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[ </span><span class="se">\n\r\t</span><span class="s2">]*$&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">in_para</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">open_in</span> <span class="n">file</span> <span class="k">in</span>
  <span class="o">(</span><span class="k">try</span>
     <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
       <span class="k">if</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">delim</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">chan</span><span class="o">)</span> <span class="mi">0</span>
       <span class="k">then</span> <span class="n">in_para</span> <span class="o">:=</span> <span class="bp">false</span>
       <span class="k">else</span> <span class="k">begin</span>
         <span class="k">if</span> <span class="n">not</span> <span class="o">!</span><span class="n">in_para</span> <span class="k">then</span> <span class="n">incr</span> <span class="n">count</span><span class="o">;</span>
         <span class="n">in_para</span> <span class="o">:=</span> <span class="bp">true</span>
       <span class="k">end</span>
     <span class="k">done</span>
   <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="n">close_in</span> <span class="n">chan</span><span class="o">);</span>
  <span class="c">(* !count now holds the number of paragraphs read *)</span>
  <span class="bp">()</span>

<span class="c">(* @@PLEAC@@_8.3 *)</span>
<span class="k">let</span> <span class="n">word_stream_of_channel</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="c">(* Thanks to Mac Mason for figuring this out. *)</span>
  <span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="o">(</span><span class="nn">Scanf</span><span class="p">.</span><span class="nn">Scanning</span><span class="p">.</span><span class="n">from_channel</span> <span class="n">channel</span><span class="o">)</span> <span class="k">in</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">count</span> <span class="o">-&gt;</span>
       <span class="k">try</span>
         <span class="k">match</span> <span class="nn">Scanf</span><span class="p">.</span><span class="n">bscanf</span> <span class="n">buffer</span> <span class="s2">&quot; %s &quot;</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">)</span> <span class="k">with</span>
           <span class="o">|</span> <span class="s2">&quot;&quot;</span> <span class="o">-&gt;</span> <span class="nc">None</span>
           <span class="o">|</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="nc">Some</span> <span class="n">s</span>
       <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
         <span class="nc">None</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">chunk</span> <span class="o">-&gt;</span>
       <span class="c">(* do something with chunk *)</span>
       <span class="bp">()</span><span class="o">)</span>
    <span class="o">(</span><span class="n">word_stream_of_channel</span> <span class="n">stdin</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Make a word frequency count *)</span>
<span class="k">let</span> <span class="n">seen</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">word</span> <span class="o">-&gt;</span>
       <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">seen</span> <span class="n">word</span>
         <span class="o">(</span><span class="k">try</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">seen</span> <span class="n">word</span> <span class="o">+</span> <span class="mi">1</span>
          <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="mi">1</span><span class="o">))</span>
    <span class="o">(</span><span class="n">word_stream_of_channel</span> <span class="n">stdin</span><span class="o">)</span>

<span class="c">(* output hash in a descending numeric sort of its values *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">words</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">word</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">words</span> <span class="o">:=</span> <span class="n">word</span> <span class="o">::</span> <span class="o">!</span><span class="n">words</span><span class="o">)</span> <span class="n">seen</span><span class="o">;</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">word</span> <span class="o">-&gt;</span>
       <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%5d %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">seen</span> <span class="n">word</span><span class="o">)</span> <span class="n">word</span><span class="o">)</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">sort</span>
       <span class="o">(</span><span class="k">fun</span> <span class="n">a</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">compare</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">seen</span> <span class="n">b</span><span class="o">)</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">seen</span> <span class="n">a</span><span class="o">))</span>
       <span class="o">!</span><span class="n">words</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Line frequency count *)</span>

<span class="k">let</span> <span class="n">line_stream_of_channel</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">channel</span><span class="o">)</span> <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="nc">None</span><span class="o">)</span>

<span class="k">let</span> <span class="n">seen</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span>
       <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">seen</span> <span class="n">line</span>
         <span class="o">(</span><span class="k">try</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">seen</span> <span class="n">line</span> <span class="o">+</span> <span class="mi">1</span>
          <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="mi">1</span><span class="o">))</span>
    <span class="o">(</span><span class="n">line_stream_of_channel</span> <span class="n">stdin</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">lines</span> <span class="o">:=</span> <span class="n">line</span> <span class="o">::</span> <span class="o">!</span><span class="n">lines</span><span class="o">)</span> <span class="n">seen</span><span class="o">;</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span>
       <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%5d %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">seen</span> <span class="n">line</span><span class="o">)</span> <span class="n">line</span><span class="o">)</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">sort</span>
       <span class="o">(</span><span class="k">fun</span> <span class="n">a</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">compare</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">seen</span> <span class="n">b</span><span class="o">)</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">seen</span> <span class="n">a</span><span class="o">))</span>
       <span class="o">!</span><span class="n">lines</span><span class="o">)</span>

<span class="c">(* @@PLEAC@@_8.4 *)</span>
<span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="n">lines</span> <span class="o">:=</span> <span class="n">input_line</span> <span class="n">chan</span> <span class="o">::</span> <span class="o">!</span><span class="n">lines</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span>
       <span class="c">(* do something with line *)</span>
       <span class="bp">()</span><span class="o">)</span>
    <span class="o">!</span><span class="n">lines</span>

<span class="c">(* @@PLEAC@@_8.5 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">sometime</span> <span class="o">=</span> <span class="mi">1</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">chan</span> <span class="o">=</span> <span class="n">open_in</span> <span class="n">file</span> <span class="k">in</span>
  <span class="k">while</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">file_exists</span> <span class="n">file</span> <span class="k">do</span>
    <span class="o">(</span><span class="k">try</span>
       <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">chan</span> <span class="k">in</span>
       <span class="c">(* ... *)</span>
       <span class="bp">()</span>
     <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
       <span class="nn">Unix</span><span class="p">.</span><span class="n">sleep</span> <span class="n">sometime</span><span class="o">)</span>
  <span class="k">done</span><span class="o">;</span>
  <span class="n">close_in</span> <span class="n">chan</span>

<span class="c">(* @@PLEAC@@_8.6 *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Random</span><span class="p">.</span><span class="n">self_init</span> <span class="bp">()</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">1</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">ref</span> <span class="s2">&quot;&quot;</span> <span class="k">in</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="k">let</span> <span class="n">next</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">stdin</span> <span class="k">in</span>
      <span class="k">if</span> <span class="nn">Random</span><span class="p">.</span><span class="n">int</span> <span class="o">!</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="k">then</span> <span class="n">line</span> <span class="o">:=</span> <span class="n">next</span><span class="o">;</span>
      <span class="n">incr</span> <span class="n">count</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
    <span class="c">(* !line is the random line *)</span>
    <span class="bp">()</span>

<span class="c">(* @@PLEAC@@_8.7 *)</span>
<span class="c">(* assumes the fisher_yates_shuffle function from Chapter 4 *)</span>
<span class="k">let</span> <span class="n">shuffle</span> <span class="kt">list</span> <span class="o">=</span>
  <span class="k">let</span> <span class="kt">array</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">of_list</span> <span class="kt">list</span> <span class="k">in</span>
  <span class="n">fisher_yates_shuffle</span> <span class="kt">array</span><span class="o">;</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="kt">array</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Random</span><span class="p">.</span><span class="n">self_init</span> <span class="bp">()</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="o">(</span><span class="k">try</span>
     <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
       <span class="n">lines</span> <span class="o">:=</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">input</span><span class="o">)</span> <span class="o">::</span> <span class="o">!</span><span class="n">lines</span>
     <span class="k">done</span>
   <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">);</span>
  <span class="k">let</span> <span class="n">reordered</span> <span class="o">=</span> <span class="n">shuffle</span> <span class="o">!</span><span class="n">lines</span> <span class="k">in</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span>
       <span class="n">output_string</span> <span class="n">output</span> <span class="n">line</span><span class="o">;</span>
       <span class="n">output_char</span> <span class="n">output</span> <span class="sc">&#39;\n&#39;</span><span class="o">)</span>
    <span class="n">reordered</span>

<span class="c">(* @@PLEAC@@_8.8 *)</span>
<span class="c">(* Read lines until the desired line number is found. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">ref</span> <span class="s2">&quot;&quot;</span> <span class="k">in</span>
  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">to</span> <span class="n">desired_line_number</span> <span class="k">do</span> <span class="n">line</span> <span class="o">:=</span> <span class="n">input_line</span> <span class="n">handle</span> <span class="k">done</span><span class="o">;</span>
  <span class="n">print_endline</span> <span class="o">!</span><span class="n">line</span>

<span class="c">(* Read lines into an array. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="o">(</span><span class="k">try</span> <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span> <span class="n">lines</span> <span class="o">:=</span> <span class="n">input_line</span> <span class="n">handle</span> <span class="o">::</span> <span class="o">!</span><span class="n">lines</span> <span class="k">done</span>
   <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">);</span>
  <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">of_list</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="o">!</span><span class="n">lines</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="o">.(</span><span class="n">desired_line_number</span><span class="o">)</span> <span class="k">in</span>
  <span class="n">print_endline</span> <span class="n">line</span>

<span class="c">(* Build an index file containing line offsets. *)</span>
<span class="k">let</span> <span class="n">build_index</span> <span class="n">data_file</span> <span class="n">index_file</span> <span class="o">=</span>
  <span class="n">set_binary_mode_out</span> <span class="n">index_file</span> <span class="bp">true</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="n">ignore</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">data_file</span><span class="o">);</span>
      <span class="n">output_binary_int</span> <span class="n">index_file</span> <span class="o">!</span><span class="n">offset</span><span class="o">;</span>
      <span class="n">offset</span> <span class="o">:=</span> <span class="n">pos_in</span> <span class="n">data_file</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
    <span class="n">flush</span> <span class="n">index_file</span>

<span class="c">(* Read a line using the index file. *)</span>
<span class="k">let</span> <span class="n">line_with_index</span> <span class="n">data_file</span> <span class="n">index_file</span> <span class="n">line_number</span> <span class="o">=</span>
  <span class="n">set_binary_mode_in</span> <span class="n">index_file</span> <span class="bp">true</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">4</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">i_offset</span> <span class="o">=</span> <span class="n">size</span> <span class="o">*</span> <span class="o">(</span><span class="n">line_number</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="k">in</span>
  <span class="n">seek_in</span> <span class="n">index_file</span> <span class="n">i_offset</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">d_offset</span> <span class="o">=</span> <span class="n">input_binary_int</span> <span class="n">index_file</span> <span class="k">in</span>
  <span class="n">seek_in</span> <span class="n">data_file</span> <span class="n">d_offset</span><span class="o">;</span>
  <span class="n">input_line</span> <span class="n">data_file</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* print_line-v1 - linear style *)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="o">&lt;&gt;</span> <span class="mi">3</span>
  <span class="k">then</span> <span class="o">(</span><span class="n">prerr_endline</span> <span class="s2">&quot;usage: print_line FILENAME LINE_NUMBER&quot;</span><span class="o">;</span> <span class="n">exit</span> <span class="mi">255</span><span class="o">);</span>

  <span class="k">let</span> <span class="n">filename</span> <span class="o">=</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">line_number</span> <span class="o">=</span> <span class="n">int_of_string</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">2</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">infile</span> <span class="o">=</span>
    <span class="k">try</span> <span class="n">open_in</span> <span class="n">filename</span>
    <span class="k">with</span> <span class="nc">Sys_error</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">prerr_endline</span> <span class="n">e</span><span class="o">;</span> <span class="n">exit</span> <span class="mi">255</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">ref</span> <span class="s2">&quot;&quot;</span> <span class="k">in</span>
  <span class="k">begin</span>
    <span class="k">try</span>
      <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">to</span> <span class="n">line_number</span> <span class="k">do</span> <span class="n">line</span> <span class="o">:=</span> <span class="n">input_line</span> <span class="n">infile</span> <span class="k">done</span>
    <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Didn&#39;t find line %d in %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">line_number</span> <span class="n">filename</span><span class="o">;</span>
      <span class="n">exit</span> <span class="mi">255</span>
  <span class="k">end</span><span class="o">;</span>
  <span class="n">print_endline</span> <span class="o">!</span><span class="n">line</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* print_line-v2 - index style *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>
<span class="c">(* build_index and line_with_index from above *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="o">&lt;&gt;</span> <span class="mi">3</span>
  <span class="k">then</span> <span class="o">(</span><span class="n">prerr_endline</span> <span class="s2">&quot;usage: print_line FILENAME LINE_NUMBER&quot;</span><span class="o">;</span> <span class="n">exit</span> <span class="mi">255</span><span class="o">);</span>

  <span class="k">let</span> <span class="n">filename</span> <span class="o">=</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">line_number</span> <span class="o">=</span> <span class="n">int_of_string</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">2</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">orig</span> <span class="o">=</span>
    <span class="k">try</span> <span class="n">open_in</span> <span class="n">filename</span>
    <span class="k">with</span> <span class="nc">Sys_error</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">prerr_endline</span> <span class="n">e</span><span class="o">;</span> <span class="n">exit</span> <span class="mi">255</span><span class="o">)</span> <span class="k">in</span>

  <span class="c">(* open the index and build it if necessary *)</span>
  <span class="c">(* there&#39;s a race condition here: two copies of this *)</span>
  <span class="c">(* program can notice there&#39;s no index for the file and *)</span>
  <span class="c">(* try to build one.  This would be easily solved with *)</span>
  <span class="c">(* locking *)</span>
  <span class="k">let</span> <span class="n">indexname</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">^</span> <span class="s2">&quot;.index&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">idx</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">openfile</span> <span class="n">indexname</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">O_CREAT</span><span class="o">;</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">O_RDWR</span><span class="o">]</span> <span class="mo">0o666</span> <span class="k">in</span>
  <span class="n">build_index</span> <span class="n">orig</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">out_channel_of_descr</span> <span class="n">idx</span><span class="o">);</span>

  <span class="k">let</span> <span class="n">line</span> <span class="o">=</span>
    <span class="k">try</span>
      <span class="n">line_with_index</span> <span class="n">orig</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">in_channel_of_descr</span> <span class="n">idx</span><span class="o">)</span> <span class="n">line_number</span>
    <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Didn&#39;t find line %d in %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">line_number</span> <span class="n">filename</span><span class="o">;</span>
      <span class="n">exit</span> <span class="mi">255</span> <span class="k">in</span>
  <span class="n">print_endline</span> <span class="n">line</span>

<span class="c">(* @@PLEAC@@_8.9 *)</span>
<span class="c">(* given &quot;record&quot; with field separated by &quot;pattern&quot;,</span>
<span class="c">   extract &quot;fields&quot;. *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="n">pattern</span>
<span class="k">let</span> <span class="n">fields</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">split_delim</span> <span class="n">regexp</span> <span class="n">record</span>

<span class="c">(* same as above using PCRE library, available at:</span>
<span class="c">   http://www.ocaml.info/home/ocaml_sources.html#pcre-ocaml *)</span>
<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+pcre&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;pcre.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">fields</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">split</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="n">pattern</span> <span class="n">record</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#</span> <span class="nn">Str</span><span class="p">.</span><span class="n">full_split</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[+-]&quot;</span><span class="o">)</span> <span class="s2">&quot;3+5-2&quot;</span><span class="o">;;</span>
<span class="o">-</span> <span class="o">:</span> <span class="nn">Str</span><span class="p">.</span><span class="n">split_result</span> <span class="kt">list</span> <span class="o">=</span>
<span class="o">[</span><span class="nn">Str</span><span class="p">.</span><span class="nc">Text</span> <span class="s2">&quot;3&quot;</span><span class="o">;</span> <span class="nn">Str</span><span class="p">.</span><span class="nc">Delim</span> <span class="s2">&quot;+&quot;</span><span class="o">;</span> <span class="nn">Str</span><span class="p">.</span><span class="nc">Text</span> <span class="s2">&quot;5&quot;</span><span class="o">;</span> <span class="nn">Str</span><span class="p">.</span><span class="nc">Delim</span> <span class="s2">&quot;-&quot;</span><span class="o">;</span> <span class="nn">Str</span><span class="p">.</span><span class="nc">Text</span> <span class="s2">&quot;2&quot;</span><span class="o">]</span>

<span class="o">#</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">split</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;([+-])&quot;</span> <span class="s2">&quot;3+5-2&quot;</span><span class="o">;;</span>
<span class="o">-</span> <span class="o">:</span> <span class="kt">string</span> <span class="kt">list</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;3&quot;</span><span class="o">;</span> <span class="s2">&quot;+&quot;</span><span class="o">;</span> <span class="s2">&quot;5&quot;</span><span class="o">;</span> <span class="s2">&quot;-&quot;</span><span class="o">;</span> <span class="s2">&quot;2&quot;</span><span class="o">]</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">fields</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">split_delim</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;:&quot;</span><span class="o">)</span> <span class="n">record</span>
<span class="k">let</span> <span class="n">fields</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">split_delim</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[ </span><span class="se">\n\r\t</span><span class="s2">]+&quot;</span><span class="o">)</span> <span class="n">record</span>
<span class="k">let</span> <span class="n">fields</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">split_delim</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot; &quot;</span><span class="o">)</span> <span class="n">record</span>

<span class="k">let</span> <span class="n">fields</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">split</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;:&quot;</span> <span class="n">record</span>
<span class="k">let</span> <span class="n">fields</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">split</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">s+&quot;</span> <span class="n">record</span>
<span class="k">let</span> <span class="n">fields</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">split</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot; &quot;</span> <span class="n">record</span>

<span class="c">(* @@PLEAC@@_8.10 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">descr</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">openfile</span> <span class="n">file</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">O_RDWR</span><span class="o">]</span> <span class="mo">0o666</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">in_channel_of_descr</span> <span class="n">descr</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">position</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">last_position</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="k">begin</span>
    <span class="k">try</span>
      <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
        <span class="n">ignore</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">in_channel</span><span class="o">);</span>
        <span class="n">last_position</span> <span class="o">:=</span> <span class="o">!</span><span class="n">position</span><span class="o">;</span>
        <span class="n">position</span> <span class="o">:=</span> <span class="n">pos_in</span> <span class="n">in_channel</span><span class="o">;</span>
      <span class="k">done</span>
    <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span>
  <span class="k">end</span><span class="o">;</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">ftruncate</span> <span class="n">descr</span> <span class="o">!</span><span class="n">last_position</span><span class="o">;</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="n">descr</span>

<span class="c">(* @@PLEAC@@_8.11 *)</span>
<span class="n">set_binary_mode_in</span> <span class="n">in_channel</span> <span class="bp">true</span>
<span class="n">set_binary_mode_out</span> <span class="n">out_channel</span> <span class="bp">true</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">gifname</span> <span class="o">=</span> <span class="s2">&quot;picture.gif&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">gif</span> <span class="o">=</span> <span class="n">open_in</span> <span class="n">gifname</span> <span class="k">in</span>
  <span class="n">set_binary_mode_in</span> <span class="n">gif</span> <span class="bp">true</span><span class="o">;</span>
  <span class="c">(* now DOS won&#39;t mangle binary input from &quot;gif&quot; *)</span>
  <span class="n">set_binary_mode_out</span> <span class="n">stdout</span> <span class="bp">true</span><span class="o">;</span>
  <span class="c">(* now DOS won&#39;t mangle binary output to &quot;stdout&quot; *)</span>
  <span class="k">let</span> <span class="n">buff</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="mi">8192</span> <span class="sc">&#39;\000&#39;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">len</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(-</span><span class="mi">1</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">while</span> <span class="o">!</span><span class="n">len</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="k">do</span>
    <span class="n">len</span> <span class="o">:=</span> <span class="n">input</span> <span class="n">gif</span> <span class="n">buff</span> <span class="mi">0</span> <span class="mi">8192</span><span class="o">;</span>
    <span class="n">output</span> <span class="n">stdout</span> <span class="n">buff</span> <span class="mi">0</span> <span class="o">!</span><span class="n">len</span>
  <span class="k">done</span>

<span class="c">(* @@PLEAC@@_8.12 *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">address</span> <span class="o">=</span> <span class="n">recsize</span> <span class="o">*</span> <span class="n">recno</span> <span class="k">in</span>
  <span class="n">seek_in</span> <span class="n">fh</span> <span class="n">address</span><span class="o">;</span>
  <span class="n">really_input</span> <span class="n">fh</span> <span class="n">buffer</span> <span class="mi">0</span> <span class="n">recsize</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">address</span> <span class="o">=</span> <span class="n">recsize</span> <span class="o">*</span> <span class="o">(</span><span class="n">recno</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="k">in</span>
  <span class="c">(* ... *)</span>
  <span class="bp">()</span>

<span class="c">(* @@PLEAC@@_8.13 *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">address</span> <span class="o">=</span> <span class="n">recsize</span> <span class="o">*</span> <span class="n">recno</span> <span class="k">in</span>
  <span class="n">seek_in</span> <span class="n">in_channel</span> <span class="n">address</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">create</span> <span class="n">recsize</span> <span class="k">in</span>
  <span class="n">really_input</span> <span class="n">in_channel</span> <span class="n">buffer</span> <span class="mi">0</span> <span class="n">recsize</span><span class="o">;</span>
  <span class="n">close_in</span> <span class="n">in_channel</span><span class="o">;</span>
  <span class="c">(* update fields, then *)</span>
  <span class="n">seek_out</span> <span class="n">out_channel</span> <span class="n">address</span><span class="o">;</span>
  <span class="n">output_string</span> <span class="n">out_channel</span> <span class="n">buffer</span><span class="o">;</span>
  <span class="n">close_out</span> <span class="n">out_channel</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* weekearly -- set someone&#39;s login date back a week *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">sizeof</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">+</span> <span class="mi">16</span>
<span class="k">let</span> <span class="n">user</span> <span class="o">=</span>
  <span class="k">if</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="o">&gt;</span> <span class="mi">1</span>
  <span class="k">then</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span>
  <span class="k">else</span> <span class="o">(</span><span class="k">try</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">getenv</span> <span class="s2">&quot;USER&quot;</span>
        <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">getenv</span> <span class="s2">&quot;LOGNAME&quot;</span><span class="o">)</span>

<span class="k">let</span> <span class="n">address</span> <span class="o">=</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">getpwnam</span> <span class="n">user</span><span class="o">).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">pw_uid</span> <span class="o">*</span> <span class="n">sizeof</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">lastlog</span> <span class="o">=</span> <span class="n">open_in</span> <span class="s2">&quot;/var/log/lastlog&quot;</span> <span class="k">in</span>
  <span class="n">seek_in</span> <span class="n">lastlog</span> <span class="n">address</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="mi">12</span> <span class="sc">&#39; &#39;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">host</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="mi">16</span> <span class="sc">&#39; &#39;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">time</span> <span class="o">=</span> <span class="n">input_binary_int</span> <span class="n">lastlog</span> <span class="k">in</span>
  <span class="n">really_input</span> <span class="n">lastlog</span> <span class="n">line</span> <span class="mi">0</span> <span class="mi">12</span><span class="o">;</span>
  <span class="n">really_input</span> <span class="n">lastlog</span> <span class="n">host</span> <span class="mi">0</span> <span class="mi">16</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">create</span> <span class="n">sizeof</span> <span class="k">in</span>
  <span class="n">really_input</span> <span class="n">lastlog</span> <span class="n">buffer</span> <span class="mi">0</span> <span class="n">sizeof</span><span class="o">;</span>
  <span class="n">close_in</span> <span class="n">lastlog</span><span class="o">;</span>

  <span class="k">let</span> <span class="n">time</span> <span class="o">=</span> <span class="n">time</span> <span class="o">-</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">7</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="k">in</span> <span class="c">(* back-date a week *)</span>

  <span class="k">let</span> <span class="n">lastlog</span> <span class="o">=</span> <span class="n">open_out_gen</span> <span class="o">[</span><span class="nc">Open_wronly</span><span class="o">]</span> <span class="mo">0o666</span> <span class="s2">&quot;/var/log/lastlog&quot;</span> <span class="k">in</span>
  <span class="n">seek_out</span> <span class="n">lastlog</span> <span class="n">address</span><span class="o">;</span>
  <span class="n">output_binary_int</span> <span class="n">lastlog</span> <span class="n">time</span><span class="o">;</span>
  <span class="n">close_out</span> <span class="n">lastlog</span>

<span class="c">(* @@PLEAC@@_8.14 *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span> <span class="n">open_in_bin</span> <span class="n">file</span> <span class="k">in</span>
  <span class="n">seek_in</span> <span class="n">in_channel</span> <span class="n">addr</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="n">input_char</span> <span class="n">in_channel</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">while</span> <span class="o">!</span><span class="n">ch</span> <span class="o">&lt;&gt;</span> <span class="sc">&#39;\000&#39;</span> <span class="k">do</span>
    <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_char</span> <span class="n">buffer</span> <span class="o">!</span><span class="n">ch</span><span class="o">;</span>
    <span class="n">ch</span> <span class="o">:=</span> <span class="n">input_char</span> <span class="n">in_channel</span><span class="o">;</span>
  <span class="k">done</span><span class="o">;</span>
  <span class="n">close_in</span> <span class="n">in_channel</span><span class="o">;</span>
  <span class="k">let</span> <span class="kt">string</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">contents</span> <span class="n">buffer</span> <span class="k">in</span>
  <span class="n">print_endline</span> <span class="kt">string</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* bgets - get a string from an address in a binary file *)</span>
<span class="k">open</span> <span class="nc">Printf</span>

<span class="k">let</span> <span class="n">file</span><span class="o">,</span> <span class="n">addrs</span> <span class="o">=</span>
  <span class="k">match</span> <span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="k">with</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">::</span> <span class="n">file</span> <span class="o">::</span> <span class="n">addrs</span> <span class="k">when</span> <span class="nn">List</span><span class="p">.</span><span class="n">length</span> <span class="n">addrs</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">-&gt;</span> <span class="n">file</span><span class="o">,</span> <span class="n">addrs</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">eprintf</span> <span class="s2">&quot;usage: %s file addr ...</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">);</span> <span class="n">exit</span> <span class="mi">0</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span> <span class="n">open_in_bin</span> <span class="n">file</span> <span class="k">in</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">addr</span> <span class="o">-&gt;</span>
       <span class="k">let</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">int_of_string</span> <span class="n">addr</span> <span class="k">in</span>
       <span class="n">seek_in</span> <span class="n">in_channel</span> <span class="n">addr</span><span class="o">;</span>
       <span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span> <span class="k">in</span>
       <span class="k">let</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="n">input_char</span> <span class="n">in_channel</span><span class="o">)</span> <span class="k">in</span>
       <span class="k">while</span> <span class="o">!</span><span class="n">ch</span> <span class="o">&lt;&gt;</span> <span class="sc">&#39;\000&#39;</span> <span class="k">do</span>
         <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_char</span> <span class="n">buffer</span> <span class="o">!</span><span class="n">ch</span><span class="o">;</span>
         <span class="n">ch</span> <span class="o">:=</span> <span class="n">input_char</span> <span class="n">in_channel</span><span class="o">;</span>
       <span class="k">done</span><span class="o">;</span>
       <span class="n">printf</span> <span class="s2">&quot;%#x %#o %d </span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span>
         <span class="n">addr</span> <span class="n">addr</span> <span class="n">addr</span> <span class="o">(</span><span class="nn">Buffer</span><span class="p">.</span><span class="n">contents</span> <span class="n">buffer</span><span class="o">))</span>
    <span class="n">addrs</span><span class="o">;</span>
  <span class="n">close_in</span> <span class="n">in_channel</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* strings - pull strings out of a binary file *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">find_strings</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">pat</span> <span class="o">=</span> <span class="s2">&quot;[</span><span class="se">\040</span><span class="s2">-</span><span class="se">\176\r\n\t</span><span class="s2"> ]&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="o">(</span><span class="n">pat</span> <span class="o">^</span> <span class="n">pat</span> <span class="o">^</span> <span class="n">pat</span> <span class="o">^</span> <span class="n">pat</span> <span class="o">^</span> <span class="s2">&quot;+&quot;</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">fun</span> <span class="n">f</span> <span class="n">input</span> <span class="o">-&gt;</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
      <span class="o">(</span><span class="k">function</span> <span class="nn">Str</span><span class="p">.</span><span class="nc">Delim</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="kt">string</span> <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">)</span>
      <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">full_split</span> <span class="n">regexp</span> <span class="n">input</span><span class="o">)</span>

<span class="k">let</span> <span class="n">file</span> <span class="o">=</span>
  <span class="k">try</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span>
  <span class="k">with</span> <span class="nc">Invalid_argument</span> <span class="o">_</span> <span class="o">-&gt;</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;usage: %s file</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">);</span>
    <span class="n">exit</span> <span class="mi">0</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span> <span class="n">open_in_bin</span> <span class="n">file</span> <span class="k">in</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="n">input_char</span> <span class="n">in_channel</span><span class="o">)</span> <span class="k">in</span>
      <span class="k">while</span> <span class="o">!</span><span class="n">ch</span> <span class="o">&lt;&gt;</span> <span class="sc">&#39;\000&#39;</span> <span class="k">do</span>
        <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_char</span> <span class="n">buffer</span> <span class="o">!</span><span class="n">ch</span><span class="o">;</span>
        <span class="n">ch</span> <span class="o">:=</span> <span class="n">input_char</span> <span class="n">in_channel</span><span class="o">;</span>
      <span class="k">done</span><span class="o">;</span>
      <span class="n">find_strings</span> <span class="n">print_endline</span> <span class="o">(</span><span class="nn">Buffer</span><span class="p">.</span><span class="n">contents</span> <span class="n">buffer</span><span class="o">)</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
    <span class="n">close_in</span> <span class="n">in_channel</span>

<span class="c">(* @@PLEAC@@_8.15 *)</span>
<span class="c">(* Using the Bitstring library by Richard W.M. Jones.</span>
<span class="c">   http://code.google.com/p/bitstring/ *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="k">let</span> <span class="n">bitstring</span> <span class="o">=</span> <span class="nn">Bitstring</span><span class="p">.</span><span class="n">bitstring_of_chan_max</span> <span class="n">file</span> <span class="n">recordsize</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">fields</span> <span class="o">=</span> <span class="n">unpack</span> <span class="n">bitstring</span> <span class="k">in</span>
      <span class="c">(* ... *)</span>
      <span class="bp">()</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">Match_failure</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Layout based on /usr/include/bits/utmp.h for a Linux system. *)</span>
<span class="k">let</span> <span class="n">recordsize</span> <span class="o">=</span> <span class="mi">384</span>
<span class="k">let</span> <span class="n">unpack</span> <span class="n">bits</span> <span class="o">=</span>
  <span class="n">bitmatch</span> <span class="n">bits</span> <span class="k">with</span>
    <span class="o">|</span> <span class="o">{</span> <span class="n">ut_type</span> <span class="o">:</span> <span class="mi">16</span> <span class="o">:</span> <span class="n">littleendian</span><span class="o">;</span>
        <span class="o">_</span> <span class="o">:</span> <span class="mi">16</span><span class="o">;</span> <span class="c">(* padding *)</span>
        <span class="n">ut_pid</span> <span class="o">:</span> <span class="mi">32</span> <span class="o">:</span> <span class="n">littleendian</span><span class="o">;</span>
        <span class="n">ut_line</span> <span class="o">:</span> <span class="mi">256</span> <span class="o">:</span> <span class="kt">string</span><span class="o">;</span>
        <span class="n">ut_id</span> <span class="o">:</span> <span class="mi">32</span> <span class="o">:</span> <span class="n">littleendian</span><span class="o">;</span>
        <span class="n">ut_user</span> <span class="o">:</span> <span class="mi">256</span> <span class="o">:</span> <span class="kt">string</span><span class="o">;</span>
        <span class="n">ut_host</span> <span class="o">:</span> <span class="mi">2048</span> <span class="o">:</span> <span class="kt">string</span><span class="o">;</span>
        <span class="n">ut_exit</span> <span class="o">:</span> <span class="mi">32</span> <span class="o">:</span> <span class="n">littleendian</span><span class="o">;</span>
        <span class="n">ut_session</span> <span class="o">:</span> <span class="mi">32</span> <span class="o">:</span> <span class="n">littleendian</span><span class="o">;</span>
        <span class="n">ut_tv_sec</span> <span class="o">:</span> <span class="mi">32</span> <span class="o">:</span> <span class="n">littleendian</span><span class="o">;</span>
        <span class="n">ut_tv_usec</span> <span class="o">:</span> <span class="mi">32</span> <span class="o">:</span> <span class="n">littleendian</span><span class="o">;</span>
        <span class="n">ut_addr_v6</span> <span class="o">:</span> <span class="mi">128</span> <span class="o">:</span> <span class="kt">string</span> <span class="o">}</span> <span class="o">-&gt;</span>
        <span class="o">(</span><span class="n">ut_type</span><span class="o">,</span> <span class="n">ut_pid</span><span class="o">,</span> <span class="n">ut_line</span><span class="o">,</span> <span class="n">ut_id</span><span class="o">,</span> <span class="n">ut_user</span><span class="o">,</span> <span class="n">ut_host</span><span class="o">,</span>
         <span class="n">ut_exit</span><span class="o">,</span> <span class="n">ut_session</span><span class="o">,</span> <span class="n">ut_tv_sec</span><span class="o">,</span> <span class="n">ut_tv_usec</span><span class="o">,</span> <span class="n">ut_addr_v6</span><span class="o">)</span>

<span class="c">(* @@PLEAC@@_8.16 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">user_preferences</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">comments</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;#.*&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">leading_white</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;^[ </span><span class="se">\t</span><span class="s2">]+&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">trailing_white</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[ </span><span class="se">\t</span><span class="s2">]+$&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">equals_delim</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[ </span><span class="se">\t</span><span class="s2">]*=[ </span><span class="se">\t</span><span class="s2">]*&quot;</span> <span class="k">in</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">s</span> <span class="o">-&gt;</span>
       <span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span> <span class="n">comments</span> <span class="s2">&quot;&quot;</span> <span class="n">s</span> <span class="k">in</span>
       <span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span> <span class="n">leading_white</span> <span class="s2">&quot;&quot;</span> <span class="n">s</span> <span class="k">in</span>
       <span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span> <span class="n">trailing_white</span> <span class="s2">&quot;&quot;</span> <span class="n">s</span> <span class="k">in</span>
       <span class="c">(* anything left? *)</span>
       <span class="k">if</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">then</span>
         <span class="k">match</span> <span class="nn">Str</span><span class="p">.</span><span class="n">bounded_split_delim</span> <span class="n">equals_delim</span> <span class="n">s</span> <span class="mi">2</span> <span class="k">with</span>
           <span class="o">|</span> <span class="o">[</span><span class="n">var</span><span class="o">;</span> <span class="k">value</span><span class="o">]</span> <span class="o">-&gt;</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">user_preferences</span> <span class="n">var</span> <span class="k">value</span>
           <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="n">s</span><span class="o">)</span>
    <span class="c">(* defined in this chapter&#39;s introduction *)</span>
    <span class="o">(</span><span class="n">line_stream_of_channel</span> <span class="n">config</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* load variables from ocaml source - toplevel scripts only *)</span>
<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;.progrc&quot;</span><span class="o">;;</span>

<span class="c">(* @@PLEAC@@_8.17 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">let</span> <span class="o">{</span><span class="nn">Unix</span><span class="p">.</span><span class="n">st_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">;</span>
         <span class="n">st_ino</span> <span class="o">=</span> <span class="n">ino</span><span class="o">;</span>
         <span class="n">st_kind</span> <span class="o">=</span> <span class="n">kind</span><span class="o">;</span>
         <span class="n">st_perm</span> <span class="o">=</span> <span class="n">perm</span><span class="o">;</span>
         <span class="n">st_nlink</span> <span class="o">=</span> <span class="n">nlink</span><span class="o">;</span>
         <span class="n">st_uid</span> <span class="o">=</span> <span class="n">uid</span><span class="o">;</span>
         <span class="n">st_gid</span> <span class="o">=</span> <span class="n">gid</span><span class="o">;</span>
         <span class="n">st_rdev</span> <span class="o">=</span> <span class="n">rdev</span><span class="o">;</span>
         <span class="n">st_size</span> <span class="o">=</span> <span class="n">size</span><span class="o">;</span>
         <span class="n">st_atime</span> <span class="o">=</span> <span class="n">atime</span><span class="o">;</span>
         <span class="n">st_mtime</span> <span class="o">=</span> <span class="n">mtime</span><span class="o">;</span>
         <span class="n">st_ctime</span> <span class="o">=</span> <span class="n">ctime</span><span class="o">}</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stat</span> <span class="n">filename</span> <span class="k">in</span>
    <span class="c">(* ... *)</span>
    <span class="bp">()</span>
  <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;no %s: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">filename</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">error_message</span> <span class="n">e</span><span class="o">);</span>
    <span class="n">exit</span> <span class="mi">0</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">info</span> <span class="o">=</span>
    <span class="k">try</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stat</span> <span class="n">filename</span>
    <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;no %s: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">filename</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">error_message</span> <span class="n">e</span><span class="o">);</span>
      <span class="n">exit</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">st_uid</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">then</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Superuser owns %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">filename</span><span class="o">;</span>
  <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">st_atime</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">st_mtime</span>
  <span class="k">then</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s has been read since it was written.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">filename</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">is_safe</span> <span class="n">path</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">info</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stat</span> <span class="n">path</span> <span class="k">in</span>
  <span class="c">(* owner neither superuser nor me *)</span>
  <span class="c">(* the real uid can be retrieved with Unix.getuid () *)</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">info</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">st_uid</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">info</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">st_uid</span> <span class="o">&lt;&gt;</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">getuid</span> <span class="bp">()</span><span class="o">)</span>
  <span class="k">then</span> <span class="bp">false</span>
  <span class="k">else</span>
    <span class="c">(* check whether the group or other can write file. *)</span>
    <span class="c">(* use 0o066 to detect either reading or writing *)</span>
    <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">st_perm</span> <span class="ow">land</span> <span class="mo">0o022</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">then</span> <span class="bp">true</span>  <span class="c">(* no one else can write this *)</span>
    <span class="k">else</span> <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">st_kind</span> <span class="o">&lt;&gt;</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">S_DIR</span>
    <span class="k">then</span> <span class="bp">false</span> <span class="c">(* non-directories aren&#39;t safe *)</span>
    <span class="k">else</span> <span class="k">if</span> <span class="n">info</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">st_perm</span> <span class="ow">land</span> <span class="mo">0o1000</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span>
    <span class="k">then</span> <span class="bp">true</span>  <span class="c">(* but directories with the sticky bit (0o1000) are *)</span>
    <span class="k">else</span> <span class="bp">false</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">is_verysafe</span> <span class="n">path</span> <span class="o">=</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span> <span class="n">path</span> <span class="n">parent</span> <span class="o">=</span>
    <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="n">is_safe</span> <span class="n">path</span><span class="o">)</span>
    <span class="k">then</span> <span class="bp">false</span>
    <span class="k">else</span> <span class="k">if</span> <span class="n">path</span> <span class="o">&lt;&gt;</span> <span class="n">parent</span>
    <span class="k">then</span> <span class="n">loop</span> <span class="n">parent</span> <span class="o">(</span><span class="nn">Filename</span><span class="p">.</span><span class="n">dirname</span> <span class="n">parent</span><span class="o">)</span>
    <span class="k">else</span> <span class="bp">true</span> <span class="k">in</span>
  <span class="n">loop</span> <span class="n">path</span> <span class="o">(</span><span class="nn">Filename</span><span class="p">.</span><span class="n">dirname</span> <span class="n">path</span><span class="o">)</span>

<span class="c">(* @@PLEAC@@_8.18 *)</span>
<span class="c">(*pp camlp4o -I /path/to/bitstring bitstring.cma pa_bitstring.cmo *)</span>

<span class="c">(* tailwtmp - watch for logins and logouts; *)</span>
<span class="c">(* uses linux utmp structure, from utmp(5)  *)</span>

<span class="k">let</span> <span class="n">days</span> <span class="o">=</span> <span class="o">[|</span> <span class="s2">&quot;Sun&quot;</span><span class="o">;</span> <span class="s2">&quot;Mon&quot;</span><span class="o">;</span> <span class="s2">&quot;Tue&quot;</span><span class="o">;</span> <span class="s2">&quot;Wed&quot;</span><span class="o">;</span> <span class="s2">&quot;Thu&quot;</span><span class="o">;</span> <span class="s2">&quot;Fri&quot;</span><span class="o">;</span> <span class="s2">&quot;Sat&quot;</span> <span class="o">|]</span>
<span class="k">let</span> <span class="n">months</span> <span class="o">=</span> <span class="o">[|</span> <span class="s2">&quot;Jan&quot;</span><span class="o">;</span> <span class="s2">&quot;Feb&quot;</span><span class="o">;</span> <span class="s2">&quot;Mar&quot;</span><span class="o">;</span> <span class="s2">&quot;Apr&quot;</span><span class="o">;</span> <span class="s2">&quot;May&quot;</span><span class="o">;</span> <span class="s2">&quot;Jun&quot;</span><span class="o">;</span>
                <span class="s2">&quot;Jul&quot;</span><span class="o">;</span> <span class="s2">&quot;Aug&quot;</span><span class="o">;</span> <span class="s2">&quot;Sep&quot;</span><span class="o">;</span> <span class="s2">&quot;Oct&quot;</span><span class="o">;</span> <span class="s2">&quot;Nov&quot;</span><span class="o">;</span> <span class="s2">&quot;Dec&quot;</span> <span class="o">|]</span>

<span class="k">let</span> <span class="n">string_of_tm</span> <span class="n">tm</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;%s %s %2d %02d:%02d:%02d %04d&quot;</span>
    <span class="n">days</span><span class="o">.(</span><span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_wday</span><span class="o">)</span>
    <span class="n">months</span><span class="o">.(</span><span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_mon</span><span class="o">)</span>
    <span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_mday</span>
    <span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_hour</span>
    <span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_min</span>
    <span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_sec</span>
    <span class="o">(</span><span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_year</span> <span class="o">+</span> <span class="mi">1900</span><span class="o">)</span>

<span class="k">let</span> <span class="n">trim_asciiz</span> <span class="n">s</span> <span class="o">=</span>
  <span class="k">try</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">s</span> <span class="mi">0</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">index</span> <span class="n">s</span> <span class="sc">&#39;\000&#39;</span><span class="o">)</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="n">s</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">sizeof</span> <span class="o">=</span> <span class="mi">384</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">wtmp</span> <span class="o">=</span> <span class="n">open_in</span> <span class="s2">&quot;/var/log/wtmp&quot;</span> <span class="k">in</span>
  <span class="n">seek_in</span> <span class="n">wtmp</span> <span class="o">(</span><span class="n">in_channel_length</span> <span class="n">wtmp</span><span class="o">);</span>
  <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">Bitstring</span><span class="p">.</span><span class="n">bitstring_of_chan_max</span> <span class="n">wtmp</span> <span class="n">sizeof</span> <span class="k">in</span>
    <span class="o">(</span><span class="n">bitmatch</span> <span class="n">buffer</span> <span class="k">with</span>
       <span class="o">|</span> <span class="o">{</span> <span class="n">ut_type</span> <span class="o">:</span> <span class="mi">16</span> <span class="o">:</span> <span class="n">littleendian</span><span class="o">;</span>
           <span class="o">_</span> <span class="o">:</span> <span class="mi">16</span><span class="o">;</span> <span class="c">(* padding *)</span>
           <span class="n">ut_pid</span> <span class="o">:</span> <span class="mi">32</span> <span class="o">:</span> <span class="n">littleendian</span><span class="o">;</span>
           <span class="n">ut_line</span> <span class="o">:</span> <span class="mi">256</span> <span class="o">:</span> <span class="kt">string</span><span class="o">;</span>
           <span class="n">ut_id</span> <span class="o">:</span> <span class="mi">32</span> <span class="o">:</span> <span class="n">littleendian</span><span class="o">;</span>
           <span class="n">ut_user</span> <span class="o">:</span> <span class="mi">256</span> <span class="o">:</span> <span class="kt">string</span><span class="o">;</span>
           <span class="n">ut_host</span> <span class="o">:</span> <span class="mi">2048</span> <span class="o">:</span> <span class="kt">string</span><span class="o">;</span>
           <span class="n">ut_exit</span> <span class="o">:</span> <span class="mi">32</span> <span class="o">:</span> <span class="n">littleendian</span><span class="o">;</span>
           <span class="n">ut_session</span> <span class="o">:</span> <span class="mi">32</span> <span class="o">:</span> <span class="n">littleendian</span><span class="o">;</span>
           <span class="n">ut_tv_sec</span> <span class="o">:</span> <span class="mi">32</span> <span class="o">:</span> <span class="n">littleendian</span><span class="o">;</span>
           <span class="n">ut_tv_usec</span> <span class="o">:</span> <span class="mi">32</span> <span class="o">:</span> <span class="n">littleendian</span><span class="o">;</span>
           <span class="n">ut_addr_v6</span> <span class="o">:</span> <span class="mi">128</span> <span class="o">:</span> <span class="kt">string</span> <span class="o">}</span> <span class="o">-&gt;</span>
           <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%1d %-8s %-12s %10ld %-24s %-16s %5ld %-32s</span><span class="se">\n</span><span class="s2">%!&quot;</span>
             <span class="n">ut_type</span> <span class="o">(</span><span class="n">trim_asciiz</span> <span class="n">ut_user</span><span class="o">)</span> <span class="o">(</span><span class="n">trim_asciiz</span> <span class="n">ut_line</span><span class="o">)</span> <span class="n">ut_id</span>
             <span class="o">(</span><span class="n">string_of_tm</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">localtime</span> <span class="o">(</span><span class="nn">Int32</span><span class="p">.</span><span class="n">to_float</span> <span class="n">ut_tv_sec</span><span class="o">)))</span>
             <span class="o">(</span><span class="n">trim_asciiz</span> <span class="n">ut_host</span><span class="o">)</span> <span class="n">ut_pid</span> <span class="o">(</span><span class="nn">Digest</span><span class="p">.</span><span class="n">to_hex</span> <span class="n">ut_addr_v6</span><span class="o">)</span>
       <span class="o">|</span> <span class="o">{</span> <span class="o">_</span> <span class="o">}</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">);</span>
    <span class="k">if</span> <span class="n">pos_in</span> <span class="n">wtmp</span> <span class="o">=</span> <span class="n">in_channel_length</span> <span class="n">wtmp</span>
    <span class="k">then</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">sleep</span> <span class="mi">1</span>
  <span class="k">done</span>

<span class="c">(* @@PLEAC@@_8.19 *)</span>
<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* tctee - clone that groks process tees *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">ignore_ints</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span>
<span class="k">let</span> <span class="n">append</span>      <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span>
<span class="k">let</span> <span class="n">unbuffer</span>    <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span>
<span class="k">let</span> <span class="n">nostdout</span>    <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span>
<span class="k">let</span> <span class="n">names</span>       <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Arg</span><span class="p">.</span><span class="n">parse</span>
    <span class="o">[</span>
      <span class="s2">&quot;-a&quot;</span><span class="o">,</span> <span class="nn">Arg</span><span class="p">.</span><span class="nc">Set</span> <span class="n">append</span><span class="o">,</span>      <span class="s2">&quot;Append to output files&quot;</span><span class="o">;</span>
      <span class="s2">&quot;-i&quot;</span><span class="o">,</span> <span class="nn">Arg</span><span class="p">.</span><span class="nc">Set</span> <span class="n">ignore_ints</span><span class="o">,</span> <span class="s2">&quot;Ignore interrupts&quot;</span><span class="o">;</span>
      <span class="s2">&quot;-u&quot;</span><span class="o">,</span> <span class="nn">Arg</span><span class="p">.</span><span class="nc">Set</span> <span class="n">unbuffer</span><span class="o">,</span>    <span class="s2">&quot;Unbuffered output&quot;</span><span class="o">;</span>
      <span class="s2">&quot;-n&quot;</span><span class="o">,</span> <span class="nn">Arg</span><span class="p">.</span><span class="nc">Set</span> <span class="n">nostdout</span><span class="o">,</span>    <span class="s2">&quot;No standard output&quot;</span><span class="o">;</span>
    <span class="o">]</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">name</span> <span class="o">-&gt;</span> <span class="n">names</span> <span class="o">:=</span> <span class="n">name</span> <span class="o">::</span> <span class="o">!</span><span class="n">names</span><span class="o">)</span>
    <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;Usage: %s [-a] [-i] [-u] [-n] [filenames] ...&quot;</span>
       <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">));</span>
  <span class="n">names</span> <span class="o">:=</span> <span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="o">!</span><span class="n">names</span>

<span class="k">let</span> <span class="n">fhs</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span>
<span class="k">let</span> <span class="n">status</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">not</span> <span class="o">!</span><span class="n">nostdout</span> <span class="k">then</span>
    <span class="c">(* always go to stdout *)</span>
    <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">fhs</span> <span class="n">stdout</span> <span class="s2">&quot;standard output&quot;</span><span class="o">;</span>

  <span class="k">if</span> <span class="o">!</span><span class="n">ignore_ints</span>
  <span class="k">then</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
      <span class="o">(</span><span class="k">fun</span> <span class="n">signal</span> <span class="o">-&gt;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">set_signal</span> <span class="n">signal</span> <span class="nn">Sys</span><span class="p">.</span><span class="nc">Signal_ignore</span><span class="o">)</span>
      <span class="o">[</span><span class="nn">Sys</span><span class="p">.</span><span class="n">sigint</span><span class="o">;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigterm</span><span class="o">;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sighup</span><span class="o">;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigquit</span><span class="o">];</span>

  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">name</span> <span class="o">-&gt;</span>
       <span class="k">if</span> <span class="n">name</span><span class="o">.[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="sc">&#39;|&#39;</span>
       <span class="k">then</span>
         <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">fhs</span>
           <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_out</span>
              <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">name</span> <span class="mi">1</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">name</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)))</span>
           <span class="n">name</span>
       <span class="k">else</span>
         <span class="k">begin</span>
           <span class="k">let</span> <span class="n">mode</span> <span class="o">=</span>
             <span class="k">if</span> <span class="o">!</span><span class="n">append</span>
             <span class="k">then</span> <span class="o">[</span><span class="nc">Open_wronly</span><span class="o">;</span> <span class="nc">Open_creat</span><span class="o">;</span> <span class="nc">Open_append</span><span class="o">]</span>
             <span class="k">else</span> <span class="o">[</span><span class="nc">Open_wronly</span><span class="o">;</span> <span class="nc">Open_creat</span><span class="o">;</span> <span class="nc">Open_trunc</span><span class="o">]</span> <span class="k">in</span>
           <span class="k">try</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">fhs</span> <span class="o">(</span><span class="n">open_out_gen</span> <span class="n">mode</span> <span class="mo">0o666</span> <span class="n">name</span><span class="o">)</span> <span class="n">name</span>
           <span class="k">with</span> <span class="nc">Sys_error</span> <span class="n">e</span> <span class="o">-&gt;</span>
             <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s: couldn&#39;t open %s: %s</span><span class="se">\n</span><span class="s2">%!&quot;</span>
               <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span> <span class="n">name</span> <span class="n">e</span><span class="o">;</span>
             <span class="n">incr</span> <span class="n">status</span>
         <span class="k">end</span><span class="o">)</span>
    <span class="o">!</span><span class="n">names</span><span class="o">;</span>

  <span class="k">begin</span>
    <span class="k">try</span>
      <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
        <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">stdin</span> <span class="k">in</span>
        <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span>
          <span class="o">(</span><span class="k">fun</span> <span class="n">fh</span> <span class="n">name</span> <span class="o">-&gt;</span>
             <span class="k">try</span>
               <span class="n">output_string</span> <span class="n">fh</span> <span class="n">line</span><span class="o">;</span>
               <span class="n">output_string</span> <span class="n">fh</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
               <span class="k">if</span> <span class="o">!</span><span class="n">unbuffer</span> <span class="k">then</span> <span class="n">flush</span> <span class="n">fh</span>
             <span class="k">with</span> <span class="nc">Sys_error</span> <span class="n">e</span> <span class="o">-&gt;</span>
               <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s: couldn&#39;t write to %s: %s</span><span class="se">\n</span><span class="s2">%!&quot;</span>
                 <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span> <span class="n">name</span> <span class="n">e</span><span class="o">;</span>
               <span class="n">incr</span> <span class="n">status</span><span class="o">)</span>
          <span class="n">fhs</span>
      <span class="k">done</span>
    <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span>
  <span class="k">end</span><span class="o">;</span>

  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">fh</span> <span class="n">name</span> <span class="o">-&gt;</span>
       <span class="k">let</span> <span class="n">close</span> <span class="o">=</span>
         <span class="k">if</span> <span class="n">name</span><span class="o">.[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="sc">&#39;|&#39;</span>
         <span class="k">then</span> <span class="k">fun</span> <span class="n">p</span> <span class="o">-&gt;</span> <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_out</span> <span class="n">p</span><span class="o">)</span>
         <span class="k">else</span> <span class="n">close_out</span> <span class="k">in</span>
       <span class="k">try</span> <span class="n">close</span> <span class="n">fh</span>
       <span class="k">with</span> <span class="nc">Sys_error</span> <span class="n">e</span> <span class="o">-&gt;</span>
         <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s: couldn&#39;t close %s: %s</span><span class="se">\n</span><span class="s2">%!&quot;</span>
           <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span> <span class="n">name</span> <span class="n">e</span><span class="o">;</span>
         <span class="n">incr</span> <span class="n">status</span><span class="o">)</span>
    <span class="n">fhs</span><span class="o">;</span>

  <span class="n">exit</span> <span class="o">!</span><span class="n">status</span>

<span class="c">(* @@PLEAC@@_8.20 *)</span>
<span class="c">(* laston - find out when a given user last logged on *)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">open</span> <span class="nc">Printf</span>
<span class="k">open</span> <span class="nc">Unix</span>

<span class="k">let</span> <span class="n">lastlog</span> <span class="o">=</span> <span class="n">open_in</span> <span class="s2">&quot;/var/log/lastlog&quot;</span>
<span class="k">let</span> <span class="n">sizeof</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">+</span> <span class="mi">16</span>
<span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="mi">12</span> <span class="sc">&#39; &#39;</span>
<span class="k">let</span> <span class="n">host</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="mi">16</span> <span class="sc">&#39; &#39;</span>

<span class="k">let</span> <span class="n">days</span> <span class="o">=</span> <span class="o">[|</span> <span class="s2">&quot;Sun&quot;</span><span class="o">;</span> <span class="s2">&quot;Mon&quot;</span><span class="o">;</span> <span class="s2">&quot;Tue&quot;</span><span class="o">;</span> <span class="s2">&quot;Wed&quot;</span><span class="o">;</span> <span class="s2">&quot;Thu&quot;</span><span class="o">;</span> <span class="s2">&quot;Fri&quot;</span><span class="o">;</span> <span class="s2">&quot;Sat&quot;</span> <span class="o">|]</span>
<span class="k">let</span> <span class="n">months</span> <span class="o">=</span> <span class="o">[|</span> <span class="s2">&quot;Jan&quot;</span><span class="o">;</span> <span class="s2">&quot;Feb&quot;</span><span class="o">;</span> <span class="s2">&quot;Mar&quot;</span><span class="o">;</span> <span class="s2">&quot;Apr&quot;</span><span class="o">;</span> <span class="s2">&quot;May&quot;</span><span class="o">;</span> <span class="s2">&quot;Jun&quot;</span><span class="o">;</span>
                <span class="s2">&quot;Jul&quot;</span><span class="o">;</span> <span class="s2">&quot;Aug&quot;</span><span class="o">;</span> <span class="s2">&quot;Sep&quot;</span><span class="o">;</span> <span class="s2">&quot;Oct&quot;</span><span class="o">;</span> <span class="s2">&quot;Nov&quot;</span><span class="o">;</span> <span class="s2">&quot;Dec&quot;</span> <span class="o">|]</span>

<span class="k">let</span> <span class="n">format_time</span> <span class="n">time</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">tm</span> <span class="o">=</span> <span class="n">localtime</span> <span class="n">time</span> <span class="k">in</span>
  <span class="n">sprintf</span> <span class="s2">&quot;%s %s %2d %02d:%02d:%02d %04d&quot;</span>
    <span class="n">days</span><span class="o">.(</span><span class="n">tm</span><span class="o">.</span><span class="n">tm_wday</span><span class="o">)</span>
    <span class="n">months</span><span class="o">.(</span><span class="n">tm</span><span class="o">.</span><span class="n">tm_mon</span><span class="o">)</span>
    <span class="n">tm</span><span class="o">.</span><span class="n">tm_mday</span>
    <span class="n">tm</span><span class="o">.</span><span class="n">tm_hour</span>
    <span class="n">tm</span><span class="o">.</span><span class="n">tm_min</span>
    <span class="n">tm</span><span class="o">.</span><span class="n">tm_sec</span>
    <span class="o">(</span><span class="n">tm</span><span class="o">.</span><span class="n">tm_year</span> <span class="o">+</span> <span class="mi">1900</span><span class="o">)</span>

<span class="k">let</span> <span class="n">trim_asciiz</span> <span class="n">s</span> <span class="o">=</span>
  <span class="k">try</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">s</span> <span class="mi">0</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">index</span> <span class="n">s</span> <span class="sc">&#39;\000&#39;</span><span class="o">)</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="n">s</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">user</span> <span class="o">-&gt;</span>
       <span class="k">try</span>
         <span class="k">let</span> <span class="n">u</span> <span class="o">=</span>
           <span class="k">try</span> <span class="n">getpwuid</span> <span class="o">(</span><span class="n">int_of_string</span> <span class="n">user</span><span class="o">)</span>
           <span class="k">with</span> <span class="nc">Failure</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">getpwnam</span> <span class="n">user</span> <span class="k">in</span>
         <span class="n">seek_in</span> <span class="n">lastlog</span> <span class="o">(</span><span class="n">u</span><span class="o">.</span><span class="n">pw_uid</span> <span class="o">*</span> <span class="n">sizeof</span><span class="o">);</span>
         <span class="k">let</span> <span class="n">time</span> <span class="o">=</span> <span class="n">input_binary_int</span> <span class="n">lastlog</span> <span class="k">in</span>
         <span class="n">really_input</span> <span class="n">lastlog</span> <span class="n">line</span> <span class="mi">0</span> <span class="mi">12</span><span class="o">;</span>
         <span class="n">really_input</span> <span class="n">lastlog</span> <span class="n">host</span> <span class="mi">0</span> <span class="mi">16</span><span class="o">;</span>
         <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">trim_asciiz</span> <span class="n">line</span> <span class="k">in</span>
         <span class="k">let</span> <span class="n">host</span> <span class="o">=</span> <span class="n">trim_asciiz</span> <span class="n">host</span> <span class="k">in</span>
         <span class="n">printf</span> <span class="s2">&quot;%-8s UID %5d %s%s%s</span><span class="se">\n</span><span class="s2">&quot;</span>
           <span class="n">u</span><span class="o">.</span><span class="n">pw_name</span>
           <span class="n">u</span><span class="o">.</span><span class="n">pw_uid</span>
           <span class="o">(</span><span class="k">if</span> <span class="n">time</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span>
            <span class="k">then</span> <span class="n">format_time</span> <span class="o">(</span><span class="n">float_of_int</span> <span class="n">time</span><span class="o">)</span>
            <span class="k">else</span> <span class="s2">&quot;never logged in&quot;</span><span class="o">)</span>
           <span class="o">(</span><span class="k">if</span> <span class="n">line</span> <span class="o">&lt;&gt;</span> <span class="s2">&quot;&quot;</span> <span class="k">then</span> <span class="s2">&quot; on &quot;</span> <span class="o">^</span> <span class="n">line</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="o">)</span>
           <span class="o">(</span><span class="k">if</span> <span class="n">host</span> <span class="o">&lt;&gt;</span> <span class="s2">&quot;&quot;</span> <span class="k">then</span> <span class="s2">&quot; from &quot;</span> <span class="o">^</span> <span class="n">host</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="o">)</span>
       <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
         <span class="n">printf</span> <span class="s2">&quot;no such uid %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">user</span><span class="o">)</span>
    <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">sub</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="mi">1</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="o">-</span> <span class="mi">1</span><span class="o">))</span>


<span class="c">(* @@PLEAC@@_9.0 *)</span>
<span class="k">open</span> <span class="nc">Unix</span>

<span class="c">(* handle_unix_error generates a nice error message and exits *)</span>
<span class="k">let</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">handle_unix_error</span> <span class="n">stat</span> <span class="s2">&quot;/usr/bin/vi&quot;</span>
<span class="k">let</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">handle_unix_error</span> <span class="n">stat</span> <span class="s2">&quot;/usr/bin/&quot;</span>
<span class="k">let</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">handle_unix_error</span> <span class="n">fstat</span> <span class="n">filedescr</span>

<span class="c">(* without handle_unix_error an exception is raised for errors *)</span>
<span class="k">let</span> <span class="n">inode</span> <span class="o">=</span> <span class="n">stat</span> <span class="s2">&quot;/usr/bin/vi&quot;</span>
<span class="k">let</span> <span class="n">ctime</span> <span class="o">=</span> <span class="n">inode</span><span class="o">.</span><span class="n">st_ctime</span>
<span class="k">let</span> <span class="n">size</span> <span class="o">=</span> <span class="n">inode</span><span class="o">.</span><span class="n">st_size</span>

<span class="c">(* don&#39;t know any equivalent in ocaml *)</span>
<span class="c">(* maybe one could use file(1) (to know if it is an ASCII text file) *)</span>
<span class="k">let</span> <span class="n">dirhandle</span> <span class="o">=</span> <span class="n">handle_unix_error</span> <span class="n">opendir</span> <span class="s2">&quot;/usr/bin&quot;</span> <span class="k">in</span>
<span class="k">begin</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="k">let</span> <span class="n">file</span> <span class="o">=</span> <span class="n">readdir</span> <span class="n">dirhandle</span> <span class="k">in</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Inside /usr/bin is something called %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">file</span>
    <span class="k">done</span>
  <span class="k">with</span>
    <span class="o">|</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span>
<span class="k">end</span><span class="o">;</span>
<span class="n">closedir</span> <span class="n">dirhandle</span><span class="o">;;</span>

<span class="c">(* @@PLEAC@@_9.1 *)</span>
<span class="k">let</span> <span class="o">(</span><span class="n">readtime</span><span class="o">,</span> <span class="n">writetime</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">inode</span> <span class="o">=</span> <span class="n">stat</span> <span class="n">filename</span> <span class="k">in</span>
  <span class="o">(</span><span class="n">inode</span><span class="o">.</span><span class="n">st_atime</span><span class="o">,</span> <span class="n">inode</span><span class="o">.</span><span class="n">st_mtime</span><span class="o">);;</span>

<span class="n">utimes</span> <span class="n">filename</span> <span class="n">newreadtime</span> <span class="n">newwritetime</span><span class="o">;;</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">second_per_day</span> <span class="o">=</span> <span class="mi">60</span><span class="o">.</span> <span class="o">*.</span> <span class="mi">60</span><span class="o">.</span> <span class="o">*.</span> <span class="mi">24</span><span class="o">.</span> <span class="k">in</span>
<span class="k">let</span> <span class="o">(</span><span class="n">atime</span><span class="o">,</span> <span class="n">mtime</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">inode</span> <span class="o">=</span> <span class="n">stat</span> <span class="n">filename</span> <span class="k">in</span>
  <span class="o">(</span><span class="n">inode</span><span class="o">.</span><span class="n">st_atime</span><span class="o">,</span> <span class="n">inode</span><span class="o">.</span><span class="n">st_mtime</span><span class="o">)</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">newreadtime</span> <span class="o">=</span> <span class="n">atime</span> <span class="o">-.</span> <span class="mi">7</span><span class="o">.</span> <span class="o">*.</span> <span class="n">second_per_day</span>
<span class="ow">and</span> <span class="n">newwritetime</span> <span class="o">=</span> <span class="n">mtime</span> <span class="o">-.</span> <span class="mi">7</span><span class="o">.</span> <span class="o">*.</span> <span class="n">second_per_day</span> <span class="k">in</span>
<span class="k">try</span>
  <span class="n">utimes</span> <span class="n">filename</span> <span class="n">newreadtime</span> <span class="n">newwritetime</span>
<span class="k">with</span>
  <span class="o">|</span> <span class="nc">Unix_error</span> <span class="o">(</span><span class="n">er</span><span class="o">,_,_)</span> <span class="o">-&gt;</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span>
	<span class="s2">&quot;couldn&#39;t backdate %s by a week w/ utime: %s</span><span class="se">\n</span><span class="s2">&quot;</span>
	<span class="n">filename</span> <span class="o">(</span><span class="n">error_message</span> <span class="n">er</span><span class="o">);;</span>

<span class="c">(*-----------------------------*)</span>
<span class="k">let</span> <span class="n">mtime</span> <span class="o">=</span> <span class="o">(</span><span class="n">stat</span> <span class="n">file</span><span class="o">).</span><span class="n">st_mtime</span> <span class="k">in</span>
<span class="n">utimes</span> <span class="n">file</span> <span class="o">(</span><span class="n">time</span> <span class="bp">()</span><span class="o">)</span> <span class="n">mtime</span>  <span class="o">;;</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* compile with ocamlc unix.cma uvi.ml -o uvi *)</span>
<span class="k">open</span> <span class="nc">Unix</span>

<span class="k">let</span> <span class="n">main</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="o">&lt;&gt;</span> <span class="mi">2</span><span class="o">)</span>
  <span class="k">then</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Usage: uvi filename</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">filename</span> <span class="o">=</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">atime</span><span class="o">,</span><span class="n">mtime</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">st</span> <span class="o">=</span> <span class="n">stat</span> <span class="n">filename</span> <span class="k">in</span>
    <span class="o">(</span><span class="n">st</span><span class="o">.</span><span class="n">st_atime</span><span class="o">,</span> <span class="n">st</span><span class="o">.</span><span class="n">st_mtime</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">editor</span> <span class="o">=</span>
    <span class="k">begin</span>
      <span class="k">try</span>
	<span class="nn">Sys</span><span class="p">.</span><span class="n">getenv</span> <span class="s2">&quot;editor&quot;</span>
      <span class="k">with</span>
	<span class="o">|</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="s2">&quot;vi&quot;</span>
    <span class="k">end</span> <span class="k">in</span>
  <span class="nn">Sys</span><span class="p">.</span><span class="n">command</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;%s %s&quot;</span> <span class="n">editor</span> <span class="n">filename</span><span class="o">);</span>
  <span class="n">utimes</span> <span class="n">filename</span> <span class="n">atime</span> <span class="n">mtime</span> <span class="k">in</span>
<span class="n">main</span> <span class="bp">()</span><span class="o">;;</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* @@PLEAC@@_9.2 *)</span>
<span class="n">unlink</span> <span class="n">filename</span><span class="o">;;</span>			<span class="c">(* use unix library *)</span>
<span class="nn">Sys</span><span class="p">.</span><span class="n">remove</span> <span class="n">filename</span><span class="o">;;</span>			<span class="c">(* in the standard library *)</span>

<span class="k">let</span> <span class="n">error_flag</span> <span class="o">=</span> <span class="n">ref</span><span class="o">(</span><span class="nc">None</span><span class="o">)</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">local_unlink</span> <span class="n">filename</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="n">unlink</span> <span class="n">filename</span>
  <span class="k">with</span>
    <span class="o">|</span> <span class="nc">Unix_error</span> <span class="o">(</span><span class="n">er</span><span class="o">,_,_)</span> <span class="o">-&gt;</span>
	<span class="n">error_flag</span> <span class="o">:=</span> <span class="o">(</span><span class="nc">Some</span> <span class="n">er</span><span class="o">)</span> <span class="k">in</span>
<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="n">local_unlink</span> <span class="n">filenames</span><span class="o">;</span>
<span class="k">match</span> <span class="o">!</span><span class="n">error_flag</span> <span class="k">with</span>
  <span class="o">|</span> <span class="nc">Some</span> <span class="n">er</span> <span class="o">-&gt;</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Couldn&#39;t unlink all of&quot;</span><span class="o">;</span>
      <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot; %s&quot;</span><span class="o">)</span> <span class="n">filenames</span><span class="o">;</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">error_message</span> <span class="n">er</span><span class="o">)</span>
  <span class="o">|</span> <span class="nc">None</span> <span class="bp">()</span><span class="o">;;</span>


<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">error_flag</span> <span class="o">=</span> <span class="n">ref</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">local_unlink</span> <span class="n">count</span> <span class="n">filename</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="n">unlink</span> <span class="n">filename</span><span class="o">;</span>
    <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>
  <span class="k">with</span>
    <span class="o">|</span> <span class="nc">Unix_error</span> <span class="o">(</span><span class="n">er</span><span class="o">,_,_)</span> <span class="o">-&gt;</span>
	<span class="n">count</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">count</span> <span class="o">=</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">fold_left</span> <span class="n">local_unlink</span> <span class="n">filenames</span> <span class="mi">0</span><span class="o">)</span>
<span class="ow">and</span> <span class="n">len</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">length</span> <span class="n">filenames</span> <span class="k">in</span>
<span class="k">if</span> <span class="n">count</span> <span class="o">&lt;&gt;</span> <span class="n">len</span>
<span class="k">then</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Could only delete %i of %i file</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">count</span> <span class="n">len</span><span class="o">;;</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* @@PLEAC@@_9.3 *)</span>
<span class="c">(*-----------------------------*)</span>

<span class="c">(* Note : this doesn&#39;t use the unix library, only the standard one *)</span>

<span class="k">let</span> <span class="n">copy</span> <span class="n">oldfile</span> <span class="n">newfile</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">infile</span> <span class="o">=</span> <span class="n">open_in</span> <span class="n">oldfile</span>
  <span class="ow">and</span> <span class="n">outfile</span> <span class="o">=</span> <span class="n">open_out</span> <span class="n">newfile</span>
  <span class="ow">and</span> <span class="n">blksize</span> <span class="o">=</span> <span class="mi">16384</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">buf</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">create</span> <span class="n">blksize</span> <span class="k">in</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">real_copy</span> <span class="bp">()</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">byte_read</span> <span class="o">=</span> <span class="n">input</span> <span class="n">infile</span> <span class="n">buf</span> <span class="mi">0</span> <span class="n">blksize</span> <span class="k">in</span>
    <span class="k">if</span> <span class="n">byte_read</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="k">then</span>
      <span class="k">begin</span>
	<span class="c">(* Handle partialle write : nothing to do *)</span>
	<span class="n">output</span> <span class="n">outfile</span> <span class="n">buf</span> <span class="mi">0</span> <span class="n">byte_read</span><span class="o">;</span>
	<span class="n">real_copy</span> <span class="bp">()</span>
      <span class="k">end</span> <span class="k">in</span>
  <span class="n">real_copy</span> <span class="bp">()</span><span class="o">;</span>
  <span class="n">close_in</span> <span class="n">infile</span><span class="o">;</span>
  <span class="n">close_out</span> <span class="n">outfile</span><span class="o">;;</span>

<span class="c">(*-----------------------------*)</span>
<span class="nn">Sys</span><span class="p">.</span><span class="n">command</span> <span class="o">(</span><span class="s2">&quot;cp &quot;</span> <span class="o">^</span> <span class="n">oldfile</span> <span class="o">^</span> <span class="s2">&quot; &quot;</span> <span class="o">^</span> <span class="n">newfile</span><span class="o">)</span>	<span class="c">(* Unix *)</span>
<span class="nn">Sys</span><span class="p">.</span><span class="n">command</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot; &quot;</span> <span class="o">[</span><span class="s2">&quot;copy&quot;</span><span class="o">;</span><span class="n">oldfile</span><span class="o">;</span><span class="n">newfile</span><span class="o">])</span> <span class="c">(* Dos *)</span>

<span class="c">(*-----------------------------*)</span>

<span class="nn">Unix</span><span class="p">.</span><span class="n">copy</span> <span class="s2">&quot;datafile.dat&quot;</span> <span class="s2">&quot;datafile.bak&quot;</span><span class="o">;;</span>

<span class="nn">Sys</span><span class="p">.</span><span class="n">rename</span> <span class="s2">&quot;datafile.dat&quot;</span> <span class="s2">&quot;datafile.bak&quot;</span><span class="o">;;</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* @@PLEAC@@_9.4 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="c">(* Count the number of times a (dev, ino) pair is seen. *)</span>
<span class="k">let</span> <span class="n">seen</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span>
<span class="k">let</span> <span class="n">do_my_thing</span> <span class="n">filename</span> <span class="o">=</span>
  <span class="k">let</span> <span class="o">{</span><span class="nn">Unix</span><span class="p">.</span><span class="n">st_dev</span><span class="o">=</span><span class="n">dev</span><span class="o">;</span> <span class="n">st_ino</span><span class="o">=</span><span class="n">ino</span><span class="o">}</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stat</span> <span class="n">filename</span> <span class="k">in</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">seen</span> <span class="o">(</span><span class="n">dev</span><span class="o">,</span> <span class="n">ino</span><span class="o">)</span>
    <span class="o">(</span><span class="k">try</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">seen</span> <span class="o">(</span><span class="n">dev</span><span class="o">,</span> <span class="n">ino</span><span class="o">)</span> <span class="o">+</span> <span class="mi">1</span>
     <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="mi">1</span><span class="o">);</span>
  <span class="k">if</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">seen</span> <span class="o">(</span><span class="n">dev</span><span class="o">,</span> <span class="n">ino</span><span class="o">)</span> <span class="o">=</span> <span class="mi">1</span>
  <span class="k">then</span>
    <span class="k">begin</span>
      <span class="c">(* do something with filename because we haven&#39;t</span>
<span class="c">         seen it before. *)</span>
    <span class="k">end</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Maintain a list of files for each (dev, ino) pair. *)</span>
<span class="k">let</span> <span class="n">seen</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">filename</span> <span class="o">-&gt;</span>
       <span class="k">let</span> <span class="o">{</span><span class="nn">Unix</span><span class="p">.</span><span class="n">st_dev</span><span class="o">=</span><span class="n">dev</span><span class="o">;</span> <span class="n">st_ino</span><span class="o">=</span><span class="n">ino</span><span class="o">}</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stat</span> <span class="n">filename</span> <span class="k">in</span>
       <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">seen</span> <span class="o">(</span><span class="n">dev</span><span class="o">,</span> <span class="n">ino</span><span class="o">)</span>
         <span class="o">(</span><span class="k">try</span> <span class="n">filename</span> <span class="o">::</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">seen</span> <span class="o">(</span><span class="n">dev</span><span class="o">,</span> <span class="n">ino</span><span class="o">)</span>
          <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="o">[</span><span class="n">filename</span><span class="o">]))</span>
    <span class="n">files</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">dev</span><span class="o">,</span> <span class="n">ino</span><span class="o">)</span> <span class="n">filenames</span> <span class="o">-&gt;</span>
       <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;(%d, %d) =&gt; [%s]</span><span class="se">\n</span><span class="s2">&quot;</span>
         <span class="n">dev</span> <span class="n">ino</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;, &quot;</span> <span class="n">filenames</span><span class="o">))</span>
    <span class="n">seen</span>

<span class="c">(* @@PLEAC@@_9.5 *)</span>
<span class="c">(* Using Sys.readdir. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">file</span> <span class="o">-&gt;</span>
       <span class="k">let</span> <span class="n">path</span> <span class="o">=</span> <span class="nn">Filename</span><span class="p">.</span><span class="n">concat</span> <span class="n">dirname</span> <span class="n">file</span> <span class="k">in</span>
       <span class="c">(* do something with path *)</span>
       <span class="bp">()</span><span class="o">)</span>
    <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="n">readdir</span> <span class="n">dirname</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Using Unix.opendir, readdir, and closedir. Note that the &quot;.&quot; and &quot;..&quot;</span>
<span class="c">   directories are included in the result unlike with Sys.readdir. *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">dir</span> <span class="o">=</span>
    <span class="k">try</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">opendir</span> <span class="n">dirname</span>
    <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;can&#39;t opendir %s: %s</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">dirname</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">error_message</span> <span class="n">e</span><span class="o">);</span>
      <span class="n">exit</span> <span class="mi">255</span> <span class="k">in</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="k">let</span> <span class="n">file</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">readdir</span> <span class="n">dir</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">path</span> <span class="o">=</span> <span class="nn">Filename</span><span class="p">.</span><span class="n">concat</span> <span class="n">dirname</span> <span class="n">file</span> <span class="k">in</span>
      <span class="c">(* do something with path *)</span>
      <span class="bp">()</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
    <span class="nn">Unix</span><span class="p">.</span><span class="n">closedir</span> <span class="n">dir</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Get a list of full paths to plain files. *)</span>
<span class="k">let</span> <span class="n">plainfiles</span> <span class="n">dir</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">filter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">path</span> <span class="o">-&gt;</span>
       <span class="k">match</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">lstat</span> <span class="n">path</span> <span class="k">with</span>
         <span class="o">|</span> <span class="o">{</span><span class="nn">Unix</span><span class="p">.</span><span class="n">st_kind</span><span class="o">=</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">S_REG</span><span class="o">}</span> <span class="o">-&gt;</span> <span class="bp">true</span>
         <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">false</span><span class="o">)</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span>
       <span class="o">(</span><span class="nn">Filename</span><span class="p">.</span><span class="n">concat</span> <span class="n">dir</span><span class="o">)</span>
       <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="n">readdir</span> <span class="n">dir</span><span class="o">)))</span>

<span class="c">(* @@PLEAC@@_9.6 *)</span>
<span class="c">(* See recipe 6.9 for a more powerful globber. *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="c">(* OCaml does not come with a globbing function. As a workaround, the</span>
<span class="c">   following function builds a regular expression from a glob pattern.</span>
<span class="c">   Only the &#39;*&#39; and &#39;?&#39; wildcards are recognized. *)</span>
<span class="k">let</span> <span class="n">regexp_of_glob</span> <span class="n">pat</span> <span class="o">=</span>
  <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span>
    <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;^%s$&quot;</span>
       <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span>
          <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span>
             <span class="o">(</span><span class="k">function</span>
                <span class="o">|</span> <span class="nn">Str</span><span class="p">.</span><span class="nc">Text</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="nn">Str</span><span class="p">.</span><span class="n">quote</span> <span class="n">s</span>
                <span class="o">|</span> <span class="nn">Str</span><span class="p">.</span><span class="nc">Delim</span> <span class="s2">&quot;*&quot;</span> <span class="o">-&gt;</span> <span class="s2">&quot;.*&quot;</span>
                <span class="o">|</span> <span class="nn">Str</span><span class="p">.</span><span class="nc">Delim</span> <span class="s2">&quot;?&quot;</span> <span class="o">-&gt;</span> <span class="s2">&quot;.&quot;</span>
                <span class="o">|</span> <span class="nn">Str</span><span class="p">.</span><span class="nc">Delim</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">assert</span> <span class="bp">false</span><span class="o">)</span>
             <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">full_split</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[*?]&quot;</span><span class="o">)</span> <span class="n">pat</span><span class="o">))))</span>

<span class="c">(* Now we can build a very basic globber. Only the filename part will</span>
<span class="c">   be used in the glob pattern, so directory wildcards will break in</span>
<span class="c">   this simple example. *)</span>
<span class="k">let</span> <span class="n">glob</span> <span class="n">pat</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">basedir</span> <span class="o">=</span> <span class="nn">Filename</span><span class="p">.</span><span class="n">dirname</span> <span class="n">pat</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">files</span> <span class="o">=</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">readdir</span> <span class="n">basedir</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="n">regexp_of_glob</span> <span class="o">(</span><span class="nn">Filename</span><span class="p">.</span><span class="n">basename</span> <span class="n">pat</span><span class="o">)</span> <span class="k">in</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">map</span>
    <span class="o">(</span><span class="nn">Filename</span><span class="p">.</span><span class="n">concat</span> <span class="n">basedir</span><span class="o">)</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">filter</span>
       <span class="o">(</span><span class="k">fun</span> <span class="n">file</span> <span class="o">-&gt;</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">regexp</span> <span class="n">file</span> <span class="mi">0</span><span class="o">)</span>
       <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="n">files</span><span class="o">))</span>

<span class="c">(* Find all data files in the pleac directory. *)</span>
<span class="k">let</span> <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span> <span class="s2">&quot;pleac/*.data&quot;</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Find and sort directories with numeric names. *)</span>
<span class="k">let</span> <span class="n">dirs</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">snd</span>                             <span class="c">(* extract pathnames *)</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">sort</span> <span class="n">compare</span>                     <span class="c">(* sort names numerically *)</span>
       <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">filter</span>                        <span class="c">(* path is a dir *)</span>
          <span class="o">(</span><span class="k">fun</span> <span class="o">(_,</span> <span class="n">s</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">is_directory</span> <span class="n">s</span><span class="o">)</span>
          <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span>                        <span class="c">(* form (name, path) *)</span>
             <span class="o">(</span><span class="k">fun</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">int_of_string</span> <span class="n">s</span><span class="o">,</span> <span class="nn">Filename</span><span class="p">.</span><span class="n">concat</span> <span class="n">path</span> <span class="n">s</span><span class="o">))</span>
             <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">filter</span>                  <span class="c">(* just numerics *)</span>
                <span class="o">(</span><span class="k">fun</span> <span class="n">s</span> <span class="o">-&gt;</span>
                   <span class="k">try</span> <span class="n">ignore</span> <span class="o">(</span><span class="n">int_of_string</span> <span class="n">s</span><span class="o">);</span> <span class="bp">true</span>
                   <span class="k">with</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">false</span><span class="o">)</span>
                <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span>
                   <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="n">readdir</span> <span class="n">path</span><span class="o">))))))</span> <span class="c">(* all files *)</span>

<span class="c">(* @@PLEAC@@_9.7 *)</span>
<span class="k">let</span> <span class="k">rec</span> <span class="n">find_files</span> <span class="n">f</span> <span class="n">error</span> <span class="n">root</span> <span class="o">=</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">filename</span> <span class="o">-&gt;</span>
       <span class="k">let</span> <span class="n">path</span> <span class="o">=</span> <span class="nn">Filename</span><span class="p">.</span><span class="n">concat</span> <span class="n">root</span> <span class="n">filename</span> <span class="k">in</span>
       <span class="k">let</span> <span class="n">is_dir</span> <span class="o">=</span>
         <span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="n">is_directory</span> <span class="n">path</span><span class="o">)</span>
         <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">error</span> <span class="n">root</span> <span class="n">e</span><span class="o">;</span> <span class="nc">None</span> <span class="k">in</span>
       <span class="k">match</span> <span class="n">is_dir</span> <span class="k">with</span>
         <span class="o">|</span> <span class="nc">Some</span> <span class="bp">true</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="n">f</span> <span class="n">path</span> <span class="k">then</span> <span class="n">find_files</span> <span class="n">f</span> <span class="n">error</span> <span class="n">path</span>
         <span class="o">|</span> <span class="nc">Some</span> <span class="bp">false</span> <span class="o">-&gt;</span> <span class="n">ignore</span> <span class="o">(</span><span class="n">f</span> <span class="n">path</span><span class="o">)</span>
         <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">)</span>
    <span class="o">(</span><span class="k">try</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">readdir</span> <span class="n">root</span> <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">error</span> <span class="n">root</span> <span class="n">e</span><span class="o">;</span> <span class="o">[|</span> <span class="o">|])</span>

<span class="k">let</span> <span class="n">process_file</span> <span class="n">fn</span> <span class="o">=</span>
  <span class="c">(* Print the name of each directory and file found. *)</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s: %s</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="o">(</span><span class="k">if</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">is_directory</span> <span class="n">fn</span> <span class="k">then</span> <span class="s2">&quot;directory&quot;</span> <span class="k">else</span> <span class="s2">&quot;file&quot;</span><span class="o">)</span> <span class="n">fn</span><span class="o">;</span>

  <span class="c">(* Prune directories named &quot;.svn&quot;. *)</span>
  <span class="n">not</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="n">is_directory</span> <span class="n">fn</span> <span class="o">&amp;&amp;</span> <span class="nn">Filename</span><span class="p">.</span><span class="n">basename</span> <span class="n">fn</span> <span class="o">=</span> <span class="s2">&quot;.svn&quot;</span><span class="o">)</span>

<span class="k">let</span> <span class="n">handle_error</span> <span class="n">fn</span> <span class="n">exc</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Error reading %s: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">fn</span> <span class="o">(</span><span class="nn">Printexc</span><span class="p">.</span><span class="n">to_string</span> <span class="n">exc</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="n">find_files</span> <span class="n">process_file</span> <span class="n">handle_error</span><span class="o">)</span> <span class="n">dirlist</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Add a trailing slash to the names of directories. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="n">find_files</span>
       <span class="o">(</span><span class="k">fun</span> <span class="n">fn</span> <span class="o">-&gt;</span>
          <span class="n">print_endline</span>
            <span class="o">(</span><span class="k">if</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">is_directory</span> <span class="n">fn</span> <span class="k">then</span> <span class="o">(</span><span class="n">fn</span> <span class="o">^</span> <span class="s2">&quot;/&quot;</span><span class="o">)</span> <span class="k">else</span> <span class="n">fn</span><span class="o">);</span>
          <span class="bp">true</span><span class="o">)</span>
       <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">))</span>
    <span class="o">(</span><span class="k">match</span> <span class="nn">List</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">)</span> <span class="k">with</span>
       <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="o">[</span><span class="s2">&quot;.&quot;</span><span class="o">]</span>
       <span class="o">|</span> <span class="n">dirs</span> <span class="o">-&gt;</span> <span class="n">dirs</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Sum the file sizes of a directory tree. *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="n">find_files</span>
       <span class="o">(</span><span class="k">fun</span> <span class="n">fn</span> <span class="o">-&gt;</span>
          <span class="n">sum</span> <span class="o">:=</span> <span class="o">!</span><span class="n">sum</span> <span class="o">+</span> <span class="o">(</span><span class="k">match</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stat</span> <span class="n">fn</span>
                         <span class="k">with</span> <span class="o">{</span><span class="nn">Unix</span><span class="p">.</span><span class="n">st_size</span><span class="o">=</span><span class="n">size</span><span class="o">}</span> <span class="o">-&gt;</span> <span class="n">size</span><span class="o">);</span>
          <span class="bp">true</span><span class="o">)</span>
       <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">))</span>
    <span class="o">(</span><span class="k">match</span> <span class="nn">List</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">)</span> <span class="k">with</span>
       <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="o">[</span><span class="s2">&quot;.&quot;</span><span class="o">]</span>
       <span class="o">|</span> <span class="n">dirs</span> <span class="o">-&gt;</span> <span class="n">dirs</span><span class="o">);</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s contains %d bytes</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot; &quot;</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">)))</span> <span class="o">!</span><span class="n">sum</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Find the largest file in a directory tree. *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">saved_size</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>
<span class="k">let</span> <span class="n">saved_name</span> <span class="o">=</span> <span class="n">ref</span> <span class="s2">&quot;&quot;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="n">find_files</span>
       <span class="o">(</span><span class="k">fun</span> <span class="n">fn</span> <span class="o">-&gt;</span>
          <span class="o">(</span><span class="k">match</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stat</span> <span class="n">fn</span> <span class="k">with</span>
             <span class="o">|</span> <span class="o">{</span><span class="nn">Unix</span><span class="p">.</span><span class="n">st_size</span><span class="o">=</span><span class="n">size</span><span class="o">}</span> <span class="o">-&gt;</span>
                 <span class="k">if</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="o">!</span><span class="n">saved_size</span>
                 <span class="k">then</span> <span class="o">(</span><span class="n">saved_size</span> <span class="o">:=</span> <span class="n">size</span><span class="o">;</span> <span class="n">saved_name</span> <span class="o">:=</span> <span class="n">fn</span><span class="o">));</span>
          <span class="bp">true</span><span class="o">)</span>
       <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">))</span>
    <span class="o">(</span><span class="k">match</span> <span class="nn">List</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">)</span> <span class="k">with</span>
       <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="o">[</span><span class="s2">&quot;.&quot;</span><span class="o">]</span>
       <span class="o">|</span> <span class="n">dirs</span> <span class="o">-&gt;</span> <span class="n">dirs</span><span class="o">);</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Biggest file %s in %s is %d bytes long.</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="o">!</span><span class="n">saved_name</span>
    <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot; &quot;</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">)))</span>
    <span class="o">!</span><span class="n">saved_size</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Find the youngest file or directory. *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">saved_age</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span><span class="o">.</span>
<span class="k">let</span> <span class="n">saved_name</span> <span class="o">=</span> <span class="n">ref</span> <span class="s2">&quot;&quot;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="n">find_files</span>
       <span class="o">(</span><span class="k">fun</span> <span class="n">fn</span> <span class="o">-&gt;</span>
          <span class="o">(</span><span class="k">match</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stat</span> <span class="n">fn</span> <span class="k">with</span>
             <span class="o">|</span> <span class="o">{</span><span class="nn">Unix</span><span class="p">.</span><span class="n">st_mtime</span><span class="o">=</span><span class="n">age</span><span class="o">}</span> <span class="o">-&gt;</span>
                 <span class="k">if</span> <span class="n">age</span> <span class="o">&gt;</span> <span class="o">!</span><span class="n">saved_age</span>
                 <span class="k">then</span> <span class="o">(</span><span class="n">saved_age</span> <span class="o">:=</span> <span class="n">age</span><span class="o">;</span> <span class="n">saved_name</span> <span class="o">:=</span> <span class="n">fn</span><span class="o">));</span>
          <span class="bp">true</span><span class="o">)</span>
       <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">))</span>
    <span class="o">(</span><span class="k">match</span> <span class="nn">List</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">)</span> <span class="k">with</span>
       <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="o">[</span><span class="s2">&quot;.&quot;</span><span class="o">]</span>
       <span class="o">|</span> <span class="n">dirs</span> <span class="o">-&gt;</span> <span class="n">dirs</span><span class="o">);</span>
  <span class="k">match</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">localtime</span> <span class="o">!</span><span class="n">saved_age</span> <span class="k">with</span>
    <span class="o">|</span> <span class="o">{</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_year</span><span class="o">=</span><span class="n">year</span><span class="o">;</span> <span class="n">tm_mon</span><span class="o">=</span><span class="n">month</span><span class="o">;</span> <span class="n">tm_mday</span><span class="o">=</span><span class="n">day</span><span class="o">}</span> <span class="o">-&gt;</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%04d-%02d-%02d %s</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="o">(</span><span class="n">year</span> <span class="o">+</span> <span class="mi">1900</span><span class="o">)</span> <span class="o">(</span><span class="n">month</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">day</span>
          <span class="o">!</span><span class="n">saved_name</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* fdirs - find all directories *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="n">find_files</span>
       <span class="o">(</span><span class="k">fun</span> <span class="n">fn</span> <span class="o">-&gt;</span>
          <span class="k">if</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">is_directory</span> <span class="n">fn</span> <span class="k">then</span> <span class="n">print_endline</span> <span class="n">fn</span><span class="o">;</span>
          <span class="bp">true</span><span class="o">)</span>
       <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">))</span>
    <span class="o">(</span><span class="k">match</span> <span class="nn">List</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">)</span> <span class="k">with</span>
       <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="o">[</span><span class="s2">&quot;.&quot;</span><span class="o">]</span>
       <span class="o">|</span> <span class="n">dirs</span> <span class="o">-&gt;</span> <span class="n">dirs</span><span class="o">)</span>

<span class="c">(* @@PLEAC@@_9.8 *)</span>
<span class="c">(* rmtree - remove whole directory trees like rm -r *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="k">rec</span> <span class="n">finddepth</span> <span class="n">f</span> <span class="n">roots</span> <span class="o">=</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">root</span> <span class="o">-&gt;</span>
       <span class="o">(</span><span class="k">match</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">lstat</span> <span class="n">root</span> <span class="k">with</span>
          <span class="o">|</span> <span class="o">{</span><span class="nn">Unix</span><span class="p">.</span><span class="n">st_kind</span><span class="o">=</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">S_DIR</span><span class="o">}</span> <span class="o">-&gt;</span>
              <span class="n">finddepth</span> <span class="n">f</span>
                <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="nn">Filename</span><span class="p">.</span><span class="n">concat</span> <span class="n">root</span><span class="o">)</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="n">readdir</span> <span class="n">root</span><span class="o">))</span>
          <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">);</span>
       <span class="n">f</span> <span class="n">root</span><span class="o">)</span>
    <span class="n">roots</span>

<span class="k">let</span> <span class="n">zap</span> <span class="n">path</span> <span class="o">=</span>
  <span class="k">match</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">lstat</span> <span class="n">path</span> <span class="k">with</span>
    <span class="o">|</span> <span class="o">{</span><span class="nn">Unix</span><span class="p">.</span><span class="n">st_kind</span><span class="o">=</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">S_DIR</span><span class="o">}</span> <span class="o">-&gt;</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;rmdir %s</span><span class="se">\n</span><span class="s2">%!&quot;</span> <span class="n">path</span><span class="o">;</span>
        <span class="nn">Unix</span><span class="p">.</span><span class="n">rmdir</span> <span class="n">path</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;unlink %s</span><span class="se">\n</span><span class="s2">%!&quot;</span> <span class="n">path</span><span class="o">;</span>
        <span class="nn">Unix</span><span class="p">.</span><span class="n">unlink</span> <span class="n">path</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="o">&lt;</span> <span class="mi">2</span>
  <span class="k">then</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;usage: %s dir ..</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">);</span> <span class="n">exit</span> <span class="mi">1</span><span class="o">);</span>
  <span class="n">finddepth</span> <span class="n">zap</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">sub</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="mi">1</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="o">-</span> <span class="mi">1</span><span class="o">))</span>

<span class="c">(* @@PLEAC@@_9.9 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
  <span class="o">(</span><span class="k">fun</span> <span class="n">file</span> <span class="o">-&gt;</span>
     <span class="k">let</span> <span class="n">newname</span> <span class="o">=</span> <span class="n">file</span> <span class="k">in</span>
     <span class="c">(* change newname *)</span>
     <span class="nn">Unix</span><span class="p">.</span><span class="n">rename</span> <span class="n">file</span> <span class="n">newname</span><span class="o">)</span>
  <span class="n">names</span>

<span class="c">(* rename - Larry&#39;s filename fixer *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+pcre&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;pcre.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">match</span> <span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">prog</span> <span class="o">::</span> <span class="n">pat</span> <span class="o">::</span> <span class="n">templ</span> <span class="o">::</span> <span class="n">files</span> <span class="o">-&gt;</span>
        <span class="k">let</span> <span class="n">replace</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">replace</span> <span class="o">~</span><span class="n">pat</span> <span class="o">~</span><span class="n">templ</span> <span class="k">in</span>
        <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
          <span class="o">(</span><span class="k">fun</span> <span class="n">file</span> <span class="o">-&gt;</span>
             <span class="k">let</span> <span class="n">file&#39;</span> <span class="o">=</span> <span class="n">replace</span> <span class="n">file</span> <span class="k">in</span>
             <span class="nn">Unix</span><span class="p">.</span><span class="n">rename</span> <span class="n">file</span> <span class="n">file&#39;</span><span class="o">)</span>
          <span class="n">files</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">prerr_endline</span> <span class="s2">&quot;Usage: rename pattern replacment [files]&quot;</span>

<span class="c">(*</span>
<span class="c">  % rename &#39;\.orig$&#39; &#39;&#39; *.orig</span>
<span class="c">  % rename &#39;$&#39; &#39;.bad&#39; *.f</span>
<span class="c">  % rename &#39;([^/]+)~$&#39; &#39;.#$1&#39; /tmp/*~</span>
<span class="c">  % find /tmp -name &#39;*~&#39; -exec rename &#39;([^/]+)~$&#39; &#39;.#$1&#39; {} \;</span>
<span class="c">*)</span>

<span class="c">(* @@PLEAC@@_9.10 *)</span>
<span class="k">let</span> <span class="n">splitext</span> <span class="n">name</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">let</span> <span class="n">root</span> <span class="o">=</span> <span class="nn">Filename</span><span class="p">.</span><span class="n">chop_extension</span> <span class="n">name</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">i</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">root</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">ext</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">name</span> <span class="n">i</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">name</span> <span class="o">-</span> <span class="n">i</span><span class="o">)</span> <span class="k">in</span>
    <span class="n">root</span><span class="o">,</span> <span class="n">ext</span>
  <span class="k">with</span> <span class="nc">Invalid_argument</span> <span class="o">_</span> <span class="o">-&gt;</span>
    <span class="n">name</span><span class="o">,</span> <span class="s2">&quot;&quot;</span>

<span class="k">let</span> <span class="n">dir</span> <span class="o">=</span> <span class="nn">Filename</span><span class="p">.</span><span class="n">dirname</span> <span class="n">path</span>
<span class="k">let</span> <span class="n">file</span> <span class="o">=</span> <span class="nn">Filename</span><span class="p">.</span><span class="n">basename</span> <span class="n">path</span>
<span class="k">let</span> <span class="n">name</span><span class="o">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">splitext</span> <span class="n">file</span>

<span class="c">(* @@PLEAC@@_9.11 *)</span>
<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* symirror - build spectral forest of symlinks *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">open</span> <span class="nc">Printf</span>

<span class="k">let</span> <span class="n">die</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">prerr_endline</span> <span class="n">msg</span><span class="o">;</span> <span class="n">exit</span> <span class="mi">1</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="o">&lt;&gt;</span> <span class="mi">3</span>
  <span class="k">then</span> <span class="n">die</span> <span class="o">(</span><span class="n">sprintf</span> <span class="s2">&quot;usage: %s realdir mirrordir&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">))</span>

<span class="k">let</span> <span class="n">srcdir</span><span class="o">,</span> <span class="n">dstdir</span> <span class="o">=</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">),</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">2</span><span class="o">)</span>
<span class="k">let</span> <span class="n">cwd</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">getcwd</span> <span class="bp">()</span>

<span class="k">let</span> <span class="n">fix_relative</span> <span class="n">path</span> <span class="o">=</span>
  <span class="k">if</span> <span class="nn">Filename</span><span class="p">.</span><span class="n">is_relative</span> <span class="n">path</span>
  <span class="k">then</span> <span class="nn">Filename</span><span class="p">.</span><span class="n">concat</span> <span class="n">cwd</span> <span class="n">path</span>
  <span class="k">else</span> <span class="n">path</span>

<span class="k">let</span> <span class="n">is_dir</span> <span class="n">dir</span> <span class="o">=</span>
  <span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="n">is_directory</span> <span class="n">dir</span><span class="o">)</span>
  <span class="k">with</span> <span class="nc">Sys_error</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nc">None</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">match</span> <span class="o">(</span><span class="n">is_dir</span> <span class="n">srcdir</span><span class="o">,</span> <span class="n">is_dir</span> <span class="n">dstdir</span><span class="o">)</span> <span class="k">with</span>
    <span class="o">|</span> <span class="o">(</span><span class="nc">None</span><span class="o">,</span> <span class="o">_)</span> <span class="o">|</span> <span class="o">(</span><span class="nc">Some</span> <span class="bp">false</span><span class="o">,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
        <span class="n">die</span> <span class="o">(</span><span class="n">sprintf</span> <span class="s2">&quot;%s: %s is not a directory&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span> <span class="n">srcdir</span><span class="o">)</span>
    <span class="o">|</span> <span class="o">(_,</span> <span class="nc">Some</span> <span class="bp">false</span><span class="o">)</span> <span class="o">-&gt;</span>
        <span class="n">die</span> <span class="o">(</span><span class="n">sprintf</span> <span class="s2">&quot;%s: %s is not a directory&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span> <span class="n">dstdir</span><span class="o">)</span>
    <span class="o">|</span> <span class="o">(_,</span> <span class="nc">None</span><span class="o">)</span> <span class="o">-&gt;</span>
        <span class="nn">Unix</span><span class="p">.</span><span class="n">mkdir</span> <span class="n">dstdir</span> <span class="mo">0o7777</span>        <span class="c">(* be forgiving *)</span>
    <span class="o">|</span> <span class="o">(</span><span class="nc">Some</span> <span class="o">_,</span> <span class="nc">Some</span> <span class="o">_)</span> <span class="o">-&gt;</span>
        <span class="bp">()</span>                              <span class="c">(* cool *)</span>

<span class="c">(* fix relative paths *)</span>
<span class="k">let</span> <span class="n">srcdir</span><span class="o">,</span> <span class="n">dstdir</span> <span class="o">=</span> <span class="n">fix_relative</span> <span class="n">srcdir</span><span class="o">,</span> <span class="n">fix_relative</span> <span class="n">dstdir</span>

<span class="k">let</span> <span class="k">rec</span> <span class="n">find</span> <span class="n">f</span> <span class="n">roots</span> <span class="o">=</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">root</span> <span class="o">-&gt;</span>
       <span class="n">f</span> <span class="n">root</span><span class="o">;</span>
       <span class="k">match</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">lstat</span> <span class="n">root</span> <span class="k">with</span>
         <span class="o">|</span> <span class="o">{</span><span class="nn">Unix</span><span class="p">.</span><span class="n">st_kind</span><span class="o">=</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">S_DIR</span><span class="o">}</span> <span class="o">-&gt;</span>
             <span class="n">find</span> <span class="n">f</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">map</span>
                       <span class="o">(</span><span class="nn">Filename</span><span class="p">.</span><span class="n">concat</span> <span class="n">root</span><span class="o">)</span>
                       <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="n">readdir</span> <span class="n">root</span><span class="o">))</span>
         <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">)</span>
    <span class="n">roots</span>

<span class="k">let</span> <span class="n">wanted</span> <span class="n">name</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">name</span> <span class="o">&lt;&gt;</span> <span class="nn">Filename</span><span class="p">.</span><span class="n">current_dir_name</span>
  <span class="k">then</span>
    <span class="k">let</span> <span class="o">{</span><span class="nn">Unix</span><span class="p">.</span><span class="n">st_dev</span><span class="o">=</span><span class="n">dev</span><span class="o">;</span> <span class="n">st_ino</span><span class="o">=</span><span class="n">ino</span><span class="o">;</span> <span class="n">st_kind</span><span class="o">=</span><span class="n">kind</span><span class="o">;</span> <span class="n">st_perm</span><span class="o">=</span><span class="n">perm</span><span class="o">}</span> <span class="o">=</span>
      <span class="nn">Unix</span><span class="p">.</span><span class="n">lstat</span> <span class="n">name</span> <span class="k">in</span>
    <span class="c">(* preserve directory permissions *)</span>
    <span class="k">let</span> <span class="n">perm</span> <span class="o">=</span> <span class="n">perm</span> <span class="ow">land</span> <span class="mo">0o7777</span> <span class="k">in</span>
    <span class="c">(* correct name *)</span>
    <span class="k">let</span> <span class="n">name</span> <span class="o">=</span>
      <span class="k">if</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">name</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">name</span> <span class="mi">0</span> <span class="mi">2</span> <span class="o">=</span> <span class="s2">&quot;./&quot;</span>
      <span class="k">then</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">name</span> <span class="mi">2</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">name</span> <span class="o">-</span> <span class="mi">2</span><span class="o">)</span>
      <span class="k">else</span> <span class="n">name</span> <span class="k">in</span>
    <span class="k">if</span> <span class="n">kind</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">S_DIR</span>
    <span class="k">then</span>
      <span class="c">(* make a real directory *)</span>
      <span class="nn">Unix</span><span class="p">.</span><span class="n">mkdir</span> <span class="o">(</span><span class="nn">Filename</span><span class="p">.</span><span class="n">concat</span> <span class="n">dstdir</span> <span class="n">name</span><span class="o">)</span> <span class="n">perm</span>
    <span class="k">else</span>
      <span class="c">(* shadow everything else *)</span>
      <span class="nn">Unix</span><span class="p">.</span><span class="n">symlink</span>
        <span class="o">(</span><span class="nn">Filename</span><span class="p">.</span><span class="n">concat</span> <span class="n">srcdir</span> <span class="n">name</span><span class="o">)</span>
        <span class="o">(</span><span class="nn">Filename</span><span class="p">.</span><span class="n">concat</span> <span class="n">dstdir</span> <span class="n">name</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">chdir</span> <span class="n">srcdir</span><span class="o">;</span>
  <span class="n">find</span> <span class="n">wanted</span> <span class="o">[|</span><span class="s2">&quot;.&quot;</span><span class="o">|]</span>

<span class="c">(* @@PLEAC@@_9.12 *)</span>
<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* lst - list sorted directory contents (depth first) *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">open</span> <span class="nc">Unix</span>
<span class="k">open</span> <span class="nc">Printf</span>

<span class="k">let</span> <span class="n">opt_m</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span>
<span class="k">let</span> <span class="n">opt_u</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span>
<span class="k">let</span> <span class="n">opt_c</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span>
<span class="k">let</span> <span class="n">opt_s</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span>
<span class="k">let</span> <span class="n">opt_r</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span>
<span class="k">let</span> <span class="n">opt_i</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span>
<span class="k">let</span> <span class="n">opt_l</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span>
<span class="k">let</span> <span class="n">names</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Arg</span><span class="p">.</span><span class="n">parse</span>
    <span class="o">[</span>
      <span class="s2">&quot;-m&quot;</span><span class="o">,</span> <span class="nn">Arg</span><span class="p">.</span><span class="nc">Set</span> <span class="n">opt_m</span><span class="o">,</span> <span class="s2">&quot;Use mtime (modify time) [DEFAULT]&quot;</span><span class="o">;</span>
      <span class="s2">&quot;-u&quot;</span><span class="o">,</span> <span class="nn">Arg</span><span class="p">.</span><span class="nc">Set</span> <span class="n">opt_u</span><span class="o">,</span> <span class="s2">&quot;Use atime (access time)&quot;</span><span class="o">;</span>
      <span class="s2">&quot;-c&quot;</span><span class="o">,</span> <span class="nn">Arg</span><span class="p">.</span><span class="nc">Set</span> <span class="n">opt_c</span><span class="o">,</span> <span class="s2">&quot;Use ctime (inode change time)&quot;</span><span class="o">;</span>
      <span class="s2">&quot;-s&quot;</span><span class="o">,</span> <span class="nn">Arg</span><span class="p">.</span><span class="nc">Set</span> <span class="n">opt_s</span><span class="o">,</span> <span class="s2">&quot;Use size for sorting&quot;</span><span class="o">;</span>
      <span class="s2">&quot;-r&quot;</span><span class="o">,</span> <span class="nn">Arg</span><span class="p">.</span><span class="nc">Set</span> <span class="n">opt_r</span><span class="o">,</span> <span class="s2">&quot;Reverse sort&quot;</span><span class="o">;</span>
      <span class="s2">&quot;-i&quot;</span><span class="o">,</span> <span class="nn">Arg</span><span class="p">.</span><span class="nc">Set</span> <span class="n">opt_i</span><span class="o">,</span> <span class="s2">&quot;Read pathnames from stdin&quot;</span><span class="o">;</span>
      <span class="s2">&quot;-l&quot;</span><span class="o">,</span> <span class="nn">Arg</span><span class="p">.</span><span class="nc">Set</span> <span class="n">opt_l</span><span class="o">,</span> <span class="s2">&quot;Long listing&quot;</span><span class="o">;</span>
    <span class="o">]</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">name</span> <span class="o">-&gt;</span> <span class="n">names</span> <span class="o">:=</span> <span class="n">name</span> <span class="o">::</span> <span class="o">!</span><span class="n">names</span><span class="o">)</span>
    <span class="o">(</span><span class="n">sprintf</span>
       <span class="s2">&quot;Usage: %s [-m] [-u] [-c] [-s] [-r] [-i] [-l] [dirs ...]</span>
<span class="s2"> or    %s -i [-m] [-u] [-c] [-s] [-r] [-l] &lt; filelist&quot;</span>
       <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">));</span>
  <span class="n">names</span> <span class="o">:=</span>
    <span class="k">match</span> <span class="o">!</span><span class="n">names</span> <span class="k">with</span>
      <span class="o">|</span> <span class="bp">[]</span> <span class="k">when</span> <span class="n">not</span> <span class="o">!</span><span class="n">opt_i</span> <span class="o">-&gt;</span> <span class="o">[</span><span class="s2">&quot;.&quot;</span><span class="o">]</span>
      <span class="o">|</span> <span class="n">names</span> <span class="o">-&gt;</span> <span class="n">names</span>

<span class="k">let</span> <span class="n">die</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">prerr_endline</span> <span class="n">msg</span><span class="o">;</span> <span class="n">exit</span> <span class="mi">1</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">int_of_bool</span> <span class="o">=</span> <span class="k">function</span> <span class="bp">true</span> <span class="o">-&gt;</span> <span class="mi">1</span> <span class="o">|</span> <span class="bp">false</span> <span class="o">-&gt;</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">int_of_bool</span> <span class="o">!</span><span class="n">opt_c</span>
      <span class="o">+</span> <span class="n">int_of_bool</span> <span class="o">!</span><span class="n">opt_u</span>
      <span class="o">+</span> <span class="n">int_of_bool</span> <span class="o">!</span><span class="n">opt_s</span>
      <span class="o">+</span> <span class="n">int_of_bool</span> <span class="o">!</span><span class="n">opt_m</span><span class="o">)</span> <span class="o">&gt;</span> <span class="mi">1</span>
  <span class="k">then</span> <span class="n">die</span> <span class="s2">&quot;can only sort on one time or size&quot;</span>

<span class="k">let</span> <span class="n">idx</span> <span class="o">=</span> <span class="k">fun</span> <span class="o">{</span><span class="n">st_mtime</span><span class="o">=</span><span class="n">t</span><span class="o">}</span> <span class="o">-&gt;</span> <span class="n">t</span>
<span class="k">let</span> <span class="n">idx</span> <span class="o">=</span> <span class="k">if</span> <span class="o">!</span><span class="n">opt_u</span> <span class="k">then</span> <span class="k">fun</span> <span class="o">{</span><span class="n">st_atime</span><span class="o">=</span><span class="n">t</span><span class="o">}</span> <span class="o">-&gt;</span> <span class="n">t</span> <span class="k">else</span> <span class="n">idx</span>
<span class="k">let</span> <span class="n">idx</span> <span class="o">=</span> <span class="k">if</span> <span class="o">!</span><span class="n">opt_c</span> <span class="k">then</span> <span class="k">fun</span> <span class="o">{</span><span class="n">st_ctime</span><span class="o">=</span><span class="n">t</span><span class="o">}</span> <span class="o">-&gt;</span> <span class="n">t</span> <span class="k">else</span> <span class="n">idx</span>
<span class="k">let</span> <span class="n">idx</span> <span class="o">=</span> <span class="k">if</span> <span class="o">!</span><span class="n">opt_s</span> <span class="k">then</span> <span class="k">fun</span> <span class="o">{</span><span class="n">st_size</span><span class="o">=</span><span class="n">s</span><span class="o">}</span> <span class="o">-&gt;</span> <span class="kt">float</span> <span class="n">s</span> <span class="k">else</span> <span class="n">idx</span>
<span class="k">let</span> <span class="n">time_idx</span> <span class="o">=</span> <span class="k">if</span> <span class="o">!</span><span class="n">opt_s</span> <span class="k">then</span> <span class="k">fun</span> <span class="o">{</span><span class="n">st_mtime</span><span class="o">=</span><span class="n">t</span><span class="o">}</span> <span class="o">-&gt;</span> <span class="n">t</span> <span class="k">else</span> <span class="n">idx</span>

<span class="k">let</span> <span class="k">rec</span> <span class="n">find</span> <span class="n">f</span> <span class="n">roots</span> <span class="o">=</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">root</span> <span class="o">-&gt;</span>
       <span class="n">f</span> <span class="n">root</span><span class="o">;</span>
       <span class="k">match</span> <span class="n">lstat</span> <span class="n">root</span> <span class="k">with</span>
         <span class="o">|</span> <span class="o">{</span><span class="n">st_kind</span><span class="o">=</span><span class="nc">S_DIR</span><span class="o">}</span> <span class="o">-&gt;</span>
             <span class="n">find</span> <span class="n">f</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">map</span>
                       <span class="o">(</span><span class="nn">Filename</span><span class="p">.</span><span class="n">concat</span> <span class="n">root</span><span class="o">)</span>
                       <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="n">readdir</span> <span class="n">root</span><span class="o">))</span>
         <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">)</span>
    <span class="n">roots</span>

<span class="k">let</span> <span class="n">time</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span>
<span class="k">let</span> <span class="n">stat</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span>

<span class="c">(* get stat info on the file, saving the desired *)</span>
<span class="c">(* sort criterion (mtime, atime, ctime, or size) *)</span>
<span class="c">(* in the time hash indexed by filename.         *)</span>
<span class="c">(* if they want a long list, we have to save the *)</span>
<span class="c">(* entire stat structure in stat.                *)</span>
<span class="k">let</span> <span class="n">wanted</span> <span class="n">name</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">let</span> <span class="n">sb</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stat</span> <span class="n">name</span> <span class="k">in</span>
    <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">time</span> <span class="n">name</span> <span class="o">(</span><span class="n">idx</span> <span class="n">sb</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">!</span><span class="n">opt_l</span> <span class="k">then</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">stat</span> <span class="n">name</span> <span class="n">sb</span>
  <span class="k">with</span> <span class="nc">Unix_error</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span>

<span class="c">(* cache user number to name conversions *)</span>
<span class="k">let</span> <span class="n">user</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">user</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="k">fun</span> <span class="n">uid</span> <span class="o">-&gt;</span>
    <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">user</span> <span class="n">uid</span>
      <span class="o">(</span><span class="k">try</span> <span class="o">(</span><span class="n">getpwuid</span> <span class="n">uid</span><span class="o">).</span><span class="n">pw_name</span>
       <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="s2">&quot;#&quot;</span> <span class="o">^</span> <span class="n">string_of_int</span> <span class="n">uid</span><span class="o">));</span>
    <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">user</span> <span class="n">uid</span>

<span class="c">(* cache group number to name conversions *)</span>
<span class="k">let</span> <span class="n">group</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">group</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="k">fun</span> <span class="n">gid</span> <span class="o">-&gt;</span>
    <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">group</span> <span class="n">gid</span>
      <span class="o">(</span><span class="k">try</span> <span class="o">(</span><span class="n">getgrgid</span> <span class="n">gid</span><span class="o">).</span><span class="n">gr_name</span>
       <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="s2">&quot;#&quot;</span> <span class="o">^</span> <span class="n">string_of_int</span> <span class="n">gid</span><span class="o">));</span>
    <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">group</span> <span class="n">gid</span>

<span class="k">let</span> <span class="n">days</span> <span class="o">=</span> <span class="o">[|</span> <span class="s2">&quot;Sun&quot;</span><span class="o">;</span> <span class="s2">&quot;Mon&quot;</span><span class="o">;</span> <span class="s2">&quot;Tue&quot;</span><span class="o">;</span> <span class="s2">&quot;Wed&quot;</span><span class="o">;</span> <span class="s2">&quot;Thu&quot;</span><span class="o">;</span> <span class="s2">&quot;Fri&quot;</span><span class="o">;</span> <span class="s2">&quot;Sat&quot;</span> <span class="o">|]</span>
<span class="k">let</span> <span class="n">months</span> <span class="o">=</span> <span class="o">[|</span> <span class="s2">&quot;Jan&quot;</span><span class="o">;</span> <span class="s2">&quot;Feb&quot;</span><span class="o">;</span> <span class="s2">&quot;Mar&quot;</span><span class="o">;</span> <span class="s2">&quot;Apr&quot;</span><span class="o">;</span> <span class="s2">&quot;May&quot;</span><span class="o">;</span> <span class="s2">&quot;Jun&quot;</span><span class="o">;</span>
                <span class="s2">&quot;Jul&quot;</span><span class="o">;</span> <span class="s2">&quot;Aug&quot;</span><span class="o">;</span> <span class="s2">&quot;Sep&quot;</span><span class="o">;</span> <span class="s2">&quot;Oct&quot;</span><span class="o">;</span> <span class="s2">&quot;Nov&quot;</span><span class="o">;</span> <span class="s2">&quot;Dec&quot;</span> <span class="o">|]</span>

<span class="k">let</span> <span class="n">format_time</span> <span class="n">time</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">tm</span> <span class="o">=</span> <span class="n">localtime</span> <span class="n">time</span> <span class="k">in</span>
  <span class="n">sprintf</span> <span class="s2">&quot;%s %s %2d %02d:%02d:%02d %04d&quot;</span>
    <span class="n">days</span><span class="o">.(</span><span class="n">tm</span><span class="o">.</span><span class="n">tm_wday</span><span class="o">)</span>
    <span class="n">months</span><span class="o">.(</span><span class="n">tm</span><span class="o">.</span><span class="n">tm_mon</span><span class="o">)</span>
    <span class="n">tm</span><span class="o">.</span><span class="n">tm_mday</span>
    <span class="n">tm</span><span class="o">.</span><span class="n">tm_hour</span>
    <span class="n">tm</span><span class="o">.</span><span class="n">tm_min</span>
    <span class="n">tm</span><span class="o">.</span><span class="n">tm_sec</span>
    <span class="o">(</span><span class="n">tm</span><span class="o">.</span><span class="n">tm_year</span> <span class="o">+</span> <span class="mi">1900</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">opt_i</span>
  <span class="k">then</span>
    <span class="k">begin</span>
      <span class="k">begin</span>
        <span class="k">try</span>
          <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
            <span class="n">names</span> <span class="o">:=</span> <span class="o">(</span><span class="n">input_line</span> <span class="nn">Pervasives</span><span class="p">.</span><span class="n">stdin</span><span class="o">)</span> <span class="o">::</span> <span class="o">!</span><span class="n">names</span>
          <span class="k">done</span>
        <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span>
      <span class="k">end</span><span class="o">;</span>
      <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="n">wanted</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="o">!</span><span class="n">names</span><span class="o">)</span>
    <span class="k">end</span>
  <span class="k">else</span> <span class="n">find</span> <span class="n">wanted</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">of_list</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="o">!</span><span class="n">names</span><span class="o">))</span>

<span class="c">(* sort the files by their cached times, youngest first *)</span>
<span class="k">let</span> <span class="n">skeys</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">sort</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">a</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">compare</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">time</span> <span class="n">b</span><span class="o">)</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">time</span> <span class="n">a</span><span class="o">))</span>
    <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">fold</span> <span class="o">(</span><span class="k">fun</span> <span class="n">k</span> <span class="n">v</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">k</span> <span class="o">::</span> <span class="n">a</span><span class="o">)</span> <span class="n">time</span> <span class="bp">[]</span><span class="o">)</span>

<span class="c">(* but flip the order if -r was supplied on command line *)</span>
<span class="k">let</span> <span class="n">skeys</span> <span class="o">=</span> <span class="k">if</span> <span class="o">!</span><span class="n">opt_r</span> <span class="k">then</span> <span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="n">skeys</span> <span class="k">else</span> <span class="n">skeys</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">skey</span> <span class="o">-&gt;</span>
       <span class="k">if</span> <span class="o">!</span><span class="n">opt_l</span>
       <span class="k">then</span>
         <span class="k">let</span> <span class="n">sb</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">stat</span> <span class="n">skey</span> <span class="k">in</span>
         <span class="n">printf</span> <span class="s2">&quot;%6d %04o %6d %8s %8s %8d %s %s</span><span class="se">\n</span><span class="s2">&quot;</span>
           <span class="n">sb</span><span class="o">.</span><span class="n">st_ino</span>
           <span class="o">(</span><span class="n">sb</span><span class="o">.</span><span class="n">st_perm</span> <span class="ow">land</span> <span class="mo">0o7777</span><span class="o">)</span>
           <span class="n">sb</span><span class="o">.</span><span class="n">st_nlink</span>
           <span class="o">(</span><span class="n">user</span> <span class="n">sb</span><span class="o">.</span><span class="n">st_uid</span><span class="o">)</span>
           <span class="o">(</span><span class="n">group</span> <span class="n">sb</span><span class="o">.</span><span class="n">st_gid</span><span class="o">)</span>
           <span class="n">sb</span><span class="o">.</span><span class="n">st_size</span>
           <span class="o">(</span><span class="n">format_time</span> <span class="o">(</span><span class="n">time_idx</span> <span class="n">sb</span><span class="o">))</span>
           <span class="n">skey</span>
       <span class="k">else</span>
         <span class="n">print_endline</span> <span class="n">skey</span><span class="o">)</span>
    <span class="n">skeys</span>


<span class="c">(* @@PLEAC@@_10.0 *)</span>

<span class="c">(* A function is bound to a variable (as with everything) with the let keyword</span>
<span class="c">*)</span>

<span class="k">let</span> <span class="n">hello</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">incr</span> <span class="n">greeted</span><span class="o">;</span> <span class="c">(* global reference *)</span>
  <span class="n">printf</span> <span class="s2">&quot;hi there!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;;</span>

<span class="c">(* Other forms for declaring a function are as follows *)</span>

<span class="k">let</span> <span class="n">hello</span> <span class="o">=</span>
  <span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span>
    <span class="n">incr</span> <span class="n">greeted</span><span class="o">;</span> <span class="c">(* global reference *)</span>
    <span class="n">printf</span> <span class="s2">&quot;hi there!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">hello</span> <span class="o">=</span>
  <span class="k">function</span> <span class="bp">()</span> <span class="o">-&gt;</span>
    <span class="n">incr</span> <span class="n">greeted</span><span class="o">;</span> <span class="c">(* global reference *)</span>
    <span class="n">printf</span> <span class="s2">&quot;hi there!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;;</span>

<span class="c">(* The typical way of calling this function is *)</span>

<span class="n">hello</span> <span class="bp">()</span><span class="o">;;</span>

<span class="c">(* @@PLEAC@@_10.1 *)</span>

<span class="c">(* All values passed to a function must be named in the paramater list to the</span>
<span class="c"> * function *)</span>

<span class="k">let</span> <span class="n">hypotenuse</span> <span class="n">side1</span> <span class="n">side2</span> <span class="o">=</span>
  <span class="n">sqrt</span> <span class="o">((</span><span class="n">side1</span> <span class="o">**</span> <span class="mi">2</span><span class="o">.)</span> <span class="o">+.</span> <span class="o">(</span><span class="n">side2</span> <span class="o">**</span> <span class="mi">2</span><span class="o">.));;</span>

<span class="c">(* Note, however, that if the parameters are defined/sent as a tuple then they</span>
<span class="c"> * can be accessed in one of two equivalent ways *)</span>

<span class="k">let</span> <span class="n">hypotenuse</span> <span class="o">(</span><span class="n">side1</span><span class="o">,</span><span class="n">side2</span><span class="o">)</span> <span class="o">=</span>
  <span class="n">sqrt</span> <span class="o">((</span><span class="n">side1</span> <span class="o">**</span> <span class="mi">2</span><span class="o">.)</span> <span class="o">+.</span> <span class="o">(</span><span class="n">side2</span> <span class="o">**</span> <span class="mi">2</span><span class="o">.));;</span>

<span class="k">let</span> <span class="n">hypotenuse</span> <span class="n">sides</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">side1</span><span class="o">,</span><span class="n">side2</span> <span class="o">=</span> <span class="n">sides</span> <span class="k">in</span>
  <span class="n">sqrt</span> <span class="o">((</span><span class="n">side1</span> <span class="o">**</span> <span class="mi">2</span><span class="o">.)</span> <span class="o">+.</span> <span class="o">(</span><span class="n">side2</span> <span class="o">**</span> <span class="mi">2</span><span class="o">.));;</span>

<span class="c">(* In both of these cases, however, we must pass the arguments as a tuple *)</span>

<span class="n">print_float</span> <span class="n">hypotenuse</span> <span class="o">(</span><span class="mi">3</span><span class="o">.,</span><span class="mi">4</span><span class="o">.);;</span>

<span class="c">(* since most data structures are immutable, one generally does not need to copy</span>
<span class="c"> * the parameters into local variables *)</span>

<span class="k">let</span> <span class="n">nums</span> <span class="o">=</span> <span class="o">[</span><span class="mi">1</span><span class="o">.</span><span class="mi">4</span><span class="o">;</span> <span class="mi">3</span><span class="o">.</span><span class="mi">5</span><span class="o">;</span> <span class="mi">6</span><span class="o">.</span><span class="mi">7</span><span class="o">];;</span>
<span class="k">let</span> <span class="n">int_all</span> <span class="n">l</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">int_of_float</span> <span class="n">l</span><span class="o">;;</span>

<span class="c">(*</span>
<span class="c"># let ints = int_all nums;;</span>
<span class="c">val ints : int list = [1; 3; 6]</span>

<span class="c"># nums;;</span>
<span class="c">- : float list = [1.4; 3.5; 6.7]</span>
<span class="c">*)</span>

<span class="c">(* However, one needs to be careful when mutable data is passed in and</span>
<span class="c"> * operations that alter that data are used *)</span>

<span class="k">let</span> <span class="n">nums</span> <span class="o">=</span> <span class="o">[|</span><span class="mi">1</span><span class="o">.</span><span class="mi">4</span><span class="o">;</span> <span class="mi">3</span><span class="o">.</span><span class="mi">5</span><span class="o">;</span> <span class="mi">6</span><span class="o">.</span><span class="mi">7</span> <span class="o">|];;</span>
<span class="k">let</span> <span class="n">int_all2</span> <span class="n">a</span> <span class="o">=</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">iteri</span> <span class="o">(</span><span class="k">fun</span> <span class="n">i</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">a</span><span class="o">.(</span><span class="n">i</span><span class="o">)</span> <span class="o">&lt;-</span> <span class="mi">10</span><span class="o">.</span> <span class="o">*.</span> <span class="n">x</span><span class="o">)</span> <span class="n">a</span><span class="o">;</span>
  <span class="n">a</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">int_all3</span> <span class="n">a</span> <span class="o">=</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">map</span> <span class="n">int_of_float</span> <span class="n">a</span><span class="o">;;</span>

<span class="c">(*</span>
<span class="c"># let a2 = int_all2 nums;;</span>
<span class="c">val a2 : int array = [|1; 3; 6|]</span>

<span class="c"># nums;;</span>
<span class="c">- : float array = [|1.4; 3.5; 6.7|]</span>

<span class="c"># let a3 = times10 nums;;</span>
<span class="c">val a3 : float array = [|14.; 35.; 67.|]</span>

<span class="c"># nums;;</span>
<span class="c">- : float array = [|14.; 35.; 67.|]</span>
<span class="c">*)</span>

<span class="c">(* To write functions that change their caller&#39;s variables, those variables must</span>
<span class="c"> * be mutable structures, such as references *)</span>
<span class="k">let</span> <span class="n">nums</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">[</span><span class="mi">1</span><span class="o">.</span><span class="mi">4</span><span class="o">;</span> <span class="mi">3</span><span class="o">.</span><span class="mi">5</span><span class="o">;</span> <span class="mi">6</span><span class="o">.</span><span class="mi">7</span><span class="o">];;</span>
<span class="k">let</span> <span class="n">trunc_em</span> <span class="n">l</span> <span class="o">=</span>
  <span class="n">l</span><span class="o">:=</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">floor</span> <span class="o">!</span><span class="n">l</span><span class="o">;</span>
  <span class="o">!</span><span class="n">l</span><span class="o">;;</span>

<span class="c">(*</span>

<span class="c"># let n2 = trunc_em nums;;</span>
<span class="c">val n2 : float list = [1.; 3.; 6.]</span>

<span class="c"># !nums;;</span>
<span class="c">- : float list = [1.; 3.; 6.]</span>
<span class="c">*)</span>

<span class="c">(* @@PLEAC@@_10.2 *)</span>

<span class="c">(* to declare a variable local to a function, simply use let inside the function</span>
<span class="c"> * body *)</span>

<span class="k">let</span> <span class="n">somefunc</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">variable</span> <span class="o">=</span> <span class="o">...</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">another</span><span class="o">,</span><span class="n">anarray</span><span class="o">,</span><span class="n">ahash</span> <span class="o">=</span> <span class="o">...</span> <span class="k">in</span>
  <span class="o">...</span> <span class="o">;;</span>

<span class="k">let</span> <span class="n">check_x</span> <span class="n">x</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">y</span> <span class="o">=</span> <span class="s2">&quot;whatever&quot;</span> <span class="k">in</span>
  <span class="n">run_check</span> <span class="bp">()</span><span class="o">;</span>
  <span class="k">if</span> <span class="n">condition</span> <span class="k">then</span> <span class="n">printf</span> <span class="s2">&quot;got %s&quot;</span> <span class="n">x</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">save_array</span> <span class="n">arguments</span> <span class="o">=</span>
  <span class="n">global_list</span> <span class="o">:=</span> <span class="n">arguments</span> <span class="o">@</span> <span class="o">!</span><span class="n">global_list</span><span class="o">;;</span>

<span class="c">(* @@PLEAC@@_10.3 *)</span>

<span class="k">let</span> <span class="n">mysub</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">variable</span> <span class="o">=</span> <span class="o">...</span> <span class="k">in</span>
  <span class="k">fun</span> <span class="n">args</span> <span class="o">-&gt;</span> <span class="o">...</span> <span class="o">;;</span>

<span class="c">(* To write a counter *)</span>
<span class="k">let</span> <span class="n">next_counter</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">counter</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span>
    <span class="n">incr</span> <span class="n">counter</span><span class="o">;</span>
    <span class="o">!</span><span class="n">counter</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">next_counter</span><span class="o">,</span><span class="n">prev_counter</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">counter</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">42</span> <span class="k">in</span>
  <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="n">incr</span> <span class="n">counter</span><span class="o">;</span> <span class="o">!</span><span class="n">counter</span><span class="o">),</span>
  <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="n">decr</span> <span class="n">counter</span><span class="o">;</span> <span class="o">!</span><span class="n">counter</span><span class="o">);;</span>

<span class="c">(* @@PLEAC@@_10.4 *)</span>
<span class="c">(* The names of functions are not available at runtime. However, using the</span>
<span class="c">   camlp4 preprocessor, we can expose various pieces of static information.</span>

<span class="c">   The &quot;macro&quot; parser provides the current file and location as __FILE__ and</span>
<span class="c">   __LOCATION__, respectively. With a bit more customization, we can expose</span>
<span class="c">   the current function name as well.</span>

<span class="c">   To do this, we&#39;ll make a copy of camlp4/Camlp4Filters/Camlp4Profiler.ml</span>
<span class="c">   from the OCaml sources and rename it to &quot;Camlp4FuncNamer.ml&quot;. Then,</span>
<span class="c">   we&#39;ll change the definition of &quot;decorate_this_expr&quot; to the following: *)</span>

<span class="c">(*---------------------------*)</span>

<span class="k">value</span> <span class="n">decorate_this_expr</span> <span class="n">e</span> <span class="n">id</span> <span class="o">=</span>
  <span class="k">let</span> <span class="o">_</span><span class="n">loc</span> <span class="o">=</span> <span class="nn">Ast</span><span class="p">.</span><span class="n">loc_of_expr</span> <span class="n">e</span> <span class="k">in</span>
  <span class="o">&lt;:</span><span class="n">expr</span><span class="o">&lt;</span> <span class="k">let</span> <span class="o">__</span><span class="n">FUNC__</span> <span class="o">=</span> <span class="o">$`</span><span class="n">str</span><span class="o">:</span><span class="n">id</span><span class="o">$</span> <span class="k">in</span> <span class="o">$</span><span class="n">e</span><span class="o">$</span> <span class="o">&gt;&gt;;</span>

<span class="c">(*---------------------------*)</span>

<span class="c">(* This has the effect of exposing the current function name as the</span>
<span class="c">   string, __FUNC__, which we can use just like __FILE__. To build this</span>
<span class="c">   syntax extension, use a command like the following: *)</span>

<span class="n">ocamlc</span> <span class="o">-</span><span class="n">c</span> <span class="o">-</span><span class="n">pp</span> <span class="n">camlp4rf</span> <span class="o">-</span><span class="nc">I</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ocaml</span><span class="o">/</span><span class="mi">3</span><span class="o">.</span><span class="mi">10</span><span class="o">.</span><span class="mi">2</span><span class="o">/</span><span class="n">camlp4</span> <span class="nn">Camlp4FuncNamer</span><span class="p">.</span><span class="n">ml</span>

<span class="c">(*---------------------------*)</span>

<span class="c">(* Now, we&#39;ll write a simple test program called &quot;main.ml&quot;: *)</span>

<span class="c">(* Comment out this line to silence log messages. *)</span>
<span class="nc">DEFINE</span> <span class="nc">DEBUG</span>

<span class="c">(* Default function name if Camlp4FuncNamer doesn&#39;t provide one. *)</span>
<span class="k">let</span> <span class="o">__</span><span class="n">FUNC__</span> <span class="o">=</span> <span class="s2">&quot;&lt;toplevel&gt;&quot;</span>

<span class="c">(* Log macro with Printf formatting. *)</span>
<span class="nc">DEFINE</span> <span class="nc">LOG</span> <span class="o">=</span>
  <span class="nc">IFDEF</span> <span class="nc">DEBUG</span> <span class="nc">THEN</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">kprintf</span>
      <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s[%s]: %s</span><span class="se">\n</span><span class="s2">%!&quot;</span> <span class="o">__</span><span class="n">FUNC__</span> <span class="o">__</span><span class="n">FILE__</span><span class="o">)</span>
  <span class="nc">ELSE</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">kprintf</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">)</span>
  <span class="nc">END</span>

<span class="c">(* An example named function. *)</span>
<span class="k">let</span> <span class="n">test_function</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">str</span> <span class="o">=</span> <span class="s2">&quot;Hello, world!&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">num</span> <span class="o">=</span> <span class="mi">42</span> <span class="k">in</span>
  <span class="nc">LOG</span> <span class="s2">&quot;str=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2">, num=%d&quot;</span> <span class="n">str</span> <span class="n">num</span><span class="o">;</span>
  <span class="n">print_endline</span> <span class="s2">&quot;test complete&quot;</span>

<span class="c">(* Some code to run at the toplevel. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nc">LOG</span> <span class="s2">&quot;not in a function&quot;</span><span class="o">;</span>
  <span class="n">test_function</span> <span class="bp">()</span>

<span class="c">(*---------------------------*)</span>

<span class="c">(* We can compile this program as follows: *)</span>

<span class="n">ocamlc</span> <span class="o">-</span><span class="n">pp</span> <span class="s2">&quot;camlp4of Camlp4FuncNamer.cmo&quot;</span> <span class="err">\</span>
    <span class="o">-</span><span class="nc">I</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ocaml</span><span class="o">/</span><span class="mi">3</span><span class="o">.</span><span class="mi">10</span><span class="o">.</span><span class="mi">2</span><span class="o">/</span><span class="n">camlp4</span> <span class="err">\</span>
    <span class="o">-</span><span class="n">o</span> <span class="n">main</span> <span class="n">main</span><span class="o">.</span><span class="n">ml</span>

<span class="c">(* Running it, we get this output: *)</span>

<span class="o">&lt;</span><span class="n">toplevel</span><span class="o">&gt;[</span><span class="n">main</span><span class="o">.</span><span class="n">ml</span><span class="o">]:</span> <span class="n">not</span> <span class="k">in</span> <span class="n">a</span> <span class="k">function</span>
<span class="n">test_function</span><span class="o">[</span><span class="n">main</span><span class="o">.</span><span class="n">ml</span><span class="o">]:</span> <span class="n">str</span><span class="o">=</span><span class="s2">&quot;Hello, world!&quot;</span><span class="o">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">42</span>
<span class="n">test</span> <span class="n">complete</span>

<span class="c">(* @@PLEAC@@_10.5 *)</span>
<span class="c">(* Because all OCaml variables represent pointers to their data, all function</span>
<span class="c"> * arguments are implicitly passed by reference *)</span>

<span class="n">array_diff</span> <span class="n">array1</span> <span class="n">array2</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">a</span> <span class="o">=</span> <span class="o">[|</span> <span class="mi">1</span><span class="o">;</span> <span class="mi">2</span> <span class="o">|];;</span>
<span class="k">let</span> <span class="n">b</span> <span class="o">=</span> <span class="o">[|</span> <span class="mi">5</span><span class="o">;</span> <span class="mi">8</span> <span class="o">|];;</span>
<span class="k">let</span> <span class="n">add_vec_pair</span> <span class="n">x</span> <span class="n">y</span> <span class="o">=</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">init</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">x</span><span class="o">)</span> <span class="o">(</span><span class="k">fun</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">.(</span><span class="n">i</span><span class="o">)</span> <span class="o">+</span> <span class="n">y</span><span class="o">.(</span><span class="n">i</span><span class="o">));;</span>

<span class="c">(*</span>
<span class="c"># let c = add_vec_pair a b;;</span>
<span class="c">val c : int array = [|6; 10|]</span>
<span class="c">*)</span>

<span class="c">(* @@PLEAC@@_10.6 *)</span>
<span class="c">(* OCaml&#39;s type safety doesn&#39;t allow this kind of shenanigans unless you bring</span>
<span class="c"> * union types into play -- but you still need to ensure that the return type of</span>
<span class="c"> * all three contexts is the same *)</span>

<span class="k">type</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">lORs</span> <span class="o">=</span>
    <span class="nc">List</span> <span class="k">of</span> <span class="k">&#39;</span><span class="n">a</span> <span class="kt">list</span>
  <span class="o">|</span> <span class="nc">Scalar</span> <span class="k">of</span> <span class="k">&#39;</span><span class="n">a</span>
  <span class="o">|</span> <span class="nc">Void</span> <span class="k">of</span> <span class="kt">unit</span> <span class="o">;;</span>

<span class="k">let</span> <span class="n">mysub</span> <span class="n">arg</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">arg</span> <span class="k">with</span>
    <span class="nc">List</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="c">(* list context, do something with l *)</span>
  <span class="o">|</span> <span class="nc">Scalar</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="c">(* scalar context, do something with s *)</span>
  <span class="o">|</span> <span class="nc">Void</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="c">(* void context, do something with nothing *)</span><span class="o">;;</span>

<span class="c">(* or equivalently *)</span>
<span class="k">let</span> <span class="n">mysub</span> <span class="o">=</span> <span class="k">function</span>
    <span class="nc">List</span> <span class="n">l</span> <span class="o">-&gt;</span> <span class="c">(* list context, do something with l *)</span>
  <span class="o">|</span> <span class="nc">Scalar</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span> <span class="c">(* scalar context, do something with s *)</span>
  <span class="o">|</span> <span class="nc">Void</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="c">(* void context, do something with nothing *)</span><span class="o">;;</span>

<span class="n">mysub</span> <span class="o">(</span><span class="nc">Void</span> <span class="bp">()</span><span class="o">);;</span>         <span class="c">(* void context *)</span>
<span class="n">mysub</span> <span class="o">(</span><span class="nc">Scalar</span> <span class="n">arg</span><span class="o">);;</span>      <span class="c">(* scalar context *)</span>
<span class="n">mysub</span> <span class="o">(</span><span class="nc">List</span> <span class="n">arg</span><span class="o">);;</span>        <span class="c">(* list context *)</span>

<span class="c">(* @@PLEAC@@_10.7 *)</span>
<span class="c">(* To name the arguments of a function, use labels *)</span>
<span class="k">let</span> <span class="n">thefunc</span> <span class="o">~</span><span class="n">increment</span> <span class="o">~</span><span class="n">finish</span> <span class="o">~</span><span class="n">start</span> <span class="o">=</span>
  <span class="o">...</span> <span class="o">;;</span>

<span class="c">(* It can be called like *)</span>
<span class="n">thefunc</span> <span class="o">~</span><span class="n">increment</span><span class="o">:</span><span class="s2">&quot;20s&quot;</span> <span class="o">~</span><span class="n">start</span><span class="o">:</span><span class="s2">&quot;+5m&quot;</span> <span class="o">~</span><span class="n">finish</span><span class="o">:</span><span class="s2">&quot;+30m&quot;</span><span class="o">;;</span>

<span class="c">(* Note that you can use different names for the labels and variables, and if</span>
<span class="c"> * the application is total, the labels can be omitted *)</span>
<span class="k">let</span> <span class="n">divide</span> <span class="o">~</span><span class="n">numerator</span><span class="o">:</span><span class="n">x</span> <span class="o">~</span><span class="n">denominator</span><span class="o">:</span><span class="n">y</span> <span class="o">=</span>
  <span class="n">x</span> <span class="o">/</span> <span class="n">y</span><span class="o">;;</span>

<span class="c">(*</span>
<span class="c"># divide ~denominator:2 ~numerator:100;;</span>
<span class="c"> - : int = 50</span>

<span class="c"># divide 20 4;;</span>
<span class="c"> - : int = 5</span>
<span class="c">*)</span>

<span class="c">(* If you want to provide default values, you need to use optional arguments,</span>
<span class="c"> * but this requires at least one unlabelled argument *)</span>

<span class="k">let</span> <span class="n">fraction</span> <span class="o">?(</span><span class="n">y</span> <span class="o">=</span> <span class="mi">2</span><span class="o">)</span> <span class="n">x</span> <span class="o">=</span>
  <span class="n">x</span> <span class="o">/</span> <span class="n">y</span><span class="o">;;</span>

<span class="c">(*</span>
<span class="c">fraction 30 ~y:3;;</span>
<span class="c"> - : int = 10</span>

<span class="c">fraction 30;;</span>
<span class="c"> - : int = 15</span>
<span class="c">*)</span>

<span class="c">(* @@PLEAC@@_10.8 *)</span>
<span class="c">(* Use _, which matches any pattern and throws away the value it matches *)</span>

<span class="k">let</span> <span class="n">a</span><span class="o">,_,</span><span class="n">c</span> <span class="o">=</span> <span class="n">func</span> <span class="bp">()</span><span class="o">;;</span>
<span class="k">let</span> <span class="o">_,_,</span><span class="n">d</span> <span class="o">=</span> <span class="n">func</span> <span class="bp">()</span><span class="o">;;</span>

<span class="c">(* @@PLEAC@@_10.9 *)</span>
<span class="c">(* Just stick all of the values in a tuple and return it *)</span>
<span class="k">let</span> <span class="n">somefunc</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">arr</span> <span class="o">=</span> <span class="o">...</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">hash</span> <span class="o">=</span> <span class="o">...</span> <span class="k">in</span>
    <span class="o">...</span>
    <span class="o">(</span><span class="n">arr</span><span class="o">,</span><span class="n">hash</span><span class="o">);;</span>

<span class="k">let</span> <span class="n">a</span><span class="o">,</span><span class="n">h</span> <span class="o">=</span> <span class="n">somefunc</span> <span class="bp">()</span><span class="o">;;</span>

<span class="c">(* @@PLEAC@@_10.10 *)</span>
<span class="c">(* Use an appropriate exception *)</span>

<span class="k">let</span> <span class="n">failing_routine</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="o">...</span>
  <span class="k">raise</span> <span class="nc">Failure</span> <span class="s2">&quot;Bad things happened...&quot;</span><span class="o">;;</span>

<span class="k">try</span> <span class="n">failing_routine</span> <span class="bp">()</span> <span class="k">with</span>
  <span class="nc">Failure</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">printf</span> <span class="s2">&quot;failing_routine failed because: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">s</span><span class="o">;;</span>

<span class="c">(* @@PLEAC@@_10.11 *)</span>

<span class="c">(* This is pretty much unnecessary due to OCaml&#39;s type inference -- you will</span>
<span class="c"> * know at compile time if you try to pass invalid arguments to a function *)</span>

<span class="c">(* @@PLEAC@@_10.12 *)</span>
<span class="c">(* To handle exceptions, which are thrown with the raise keword, wrap the</span>
<span class="c"> * possibly exceptional call in a try ... with block.  You only need to do this</span>
<span class="c"> * where appropriate *)</span>

<span class="k">let</span> <span class="n">slurp_to_list</span> <span class="n">filename</span> <span class="o">=</span>
  <span class="c">(* Note, if filename does not exist in the current directory, it will raise a</span>
<span class="c">   * Sys_error exception *)</span>
  <span class="k">let</span> <span class="n">ic</span> <span class="o">=</span> <span class="n">open_in</span> <span class="n">filename</span> <span class="ow">and</span>
  <span class="n">l</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span> <span class="bp">()</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">ic</span> <span class="k">in</span>
    <span class="n">l</span> <span class="o">:=</span> <span class="n">line</span><span class="o">::!</span><span class="n">l</span><span class="o">;</span>
    <span class="n">loop</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="k">try</span> <span class="n">loop</span> <span class="bp">()</span> <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="n">close_in</span> <span class="n">ic</span><span class="o">;</span> <span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="o">!</span><span class="n">l</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">lfind</span> <span class="n">name</span> <span class="n">l</span> <span class="o">=</span>
  <span class="c">(* Note, if no elements in the list satisfy the predicate, List.find will</span>
<span class="c">   * raise the Not_found exception *)</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">find</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="o">(</span><span class="s2">&quot;$&quot;</span> <span class="o">^</span> <span class="n">name</span><span class="o">))</span> <span class="n">x</span> <span class="mi">0</span><span class="o">)</span> <span class="n">l</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">findSmurfette</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="n">print_endline</span> <span class="o">(</span><span class="n">lfind</span> <span class="s2">&quot;Smurfette&quot;</span> <span class="o">(</span><span class="n">slurp_to_list</span> <span class="s2">&quot;smurfs&quot;</span><span class="o">))</span>
  <span class="k">with</span>
    <span class="nc">Sys_error</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">prerr_endline</span> <span class="o">(</span><span class="s2">&quot;Dammit! - &quot;</span> <span class="o">^</span> <span class="n">s</span><span class="o">)</span>
  <span class="o">|</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="n">prerr_endline</span> <span class="s2">&quot;Hmmm... Smurfette is not in smurfs&quot;</span><span class="o">;;</span>

<span class="c">(* @@PLEAC@@_10.13 *)</span>
<span class="c">(* To do this in OCaml -- which doesn&#39;t like global state in the first place --</span>
<span class="c"> * you need to manually store the old value and replace it before exiting the</span>
<span class="c"> * block *)</span>

<span class="k">let</span> <span class="n">age</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">18</span><span class="o">;;</span>
<span class="k">if</span> <span class="n">condition</span> <span class="k">then</span>
  <span class="o">(</span>
    <span class="k">let</span> <span class="n">org_age</span> <span class="o">=</span> <span class="o">!</span><span class="n">age</span> <span class="k">in</span>
    <span class="n">age</span> <span class="o">:=</span> <span class="mi">23</span><span class="o">;</span>
    <span class="n">func</span> <span class="bp">()</span><span class="o">;</span>
    <span class="n">age</span> <span class="o">:=</span> <span class="n">org_age</span>
  <span class="o">);;</span>

<span class="c">(* for local handles, just create a new channel inside your block *)</span>
<span class="k">let</span> <span class="n">get_motd</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">motd</span> <span class="o">=</span> <span class="n">open_in</span> <span class="s2">&quot;/etc/motd&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">retval</span> <span class="o">=</span>
    <span class="o">...</span> <span class="k">in</span>
  <span class="n">close_in</span> <span class="n">motd</span><span class="o">;</span>
  <span class="n">retval</span><span class="o">;;</span>

<span class="c">(* @@PLEAC@@_10.14 *)</span>

<span class="c">(* If you want to redefine a function... go ahead.  Functions are first class</span>
<span class="c"> * members in OCaml *)</span>

<span class="k">let</span> <span class="n">f</span> <span class="n">x</span> <span class="n">y</span> <span class="o">=</span>
  <span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="o">;;</span>

<span class="n">f</span> <span class="mi">5</span> <span class="mi">7</span><span class="o">;;</span>
<span class="c">(*  - : int = 12 *)</span>

<span class="k">let</span> <span class="n">f</span> <span class="n">x</span> <span class="n">y</span> <span class="o">=</span>
  <span class="n">x</span> <span class="o">-</span> <span class="n">y</span><span class="o">;;</span>

<span class="n">f</span> <span class="mi">5</span> <span class="mi">7</span><span class="o">;;</span>

<span class="c">(*  - : int = -2 *)</span>

<span class="c">(* to do it temporarily, either save to old value and then restore it, or just</span>
<span class="c"> * redefine it in the current block.  The old value will be restored when you</span>
<span class="c"> * exit the scope of that block *)</span>

<span class="k">let</span> <span class="n">g</span> <span class="o">=</span> <span class="n">f</span>
<span class="ow">and</span> <span class="n">f</span> <span class="n">x</span> <span class="n">y</span> <span class="o">=</span>
  <span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="o">;;</span>

<span class="n">f</span> <span class="mi">5</span> <span class="mi">7</span><span class="o">;;</span>

<span class="c">(*  - : int = 35 *)</span>

<span class="k">let</span> <span class="n">f</span> <span class="o">=</span> <span class="n">g</span><span class="o">;;</span>

<span class="n">f</span> <span class="mi">5</span> <span class="mi">7</span><span class="o">;;</span>

<span class="c">(*  - : int = -2 *)</span>

<span class="k">let</span> <span class="n">g</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">f</span> <span class="n">x</span> <span class="n">y</span> <span class="o">=</span>
    <span class="n">x</span> <span class="o">/</span> <span class="n">y</span> <span class="k">in</span>
  <span class="n">f</span> <span class="mi">5</span> <span class="mi">7</span><span class="o">;;</span>

<span class="n">g</span> <span class="bp">()</span><span class="o">;;</span>

<span class="c">(*  - : int = 0 *)</span>

<span class="n">f</span> <span class="mi">5</span> <span class="mi">7</span><span class="o">;;</span>

<span class="c">(*  - : int = -2 *)</span>

<span class="c">(* @@PLEAC@@_10.15 *)</span>
<span class="c">(* Since OCaml is statically typed, any attempt to call an undefined</span>
<span class="c">   function will result in a compiler error. There is no way to capture</span>
<span class="c">   and handle this event at runtime. *)</span>

<span class="c">(* @@PLEAC@@_10.16 *)</span>

<span class="c">(* Just define the inner function within the outer one *)</span>
<span class="k">let</span> <span class="n">outer</span> <span class="n">x</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="mi">35</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">inner</span> <span class="bp">()</span> <span class="o">=</span>
    <span class="n">x</span> <span class="o">*</span> <span class="mi">19</span> <span class="k">in</span>
  <span class="n">x</span> <span class="o">+</span> <span class="n">inner</span> <span class="bp">()</span><span class="o">;;</span>

<span class="c">(* @@PLEAC@@_10.17 *)</span>

<span class="k">let</span> <span class="n">slurp_to_string</span> <span class="n">filename</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">ic</span> <span class="o">=</span> <span class="n">open_in</span> <span class="n">filename</span> <span class="ow">and</span>
  <span class="n">buf</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">create</span> <span class="mi">4096</span> <span class="k">in</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span> <span class="bp">()</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">ic</span> <span class="k">in</span>
    <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_string</span> <span class="n">buf</span> <span class="n">line</span><span class="o">;</span>
    <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_string</span> <span class="n">buf</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
    <span class="n">loop</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="k">try</span> <span class="n">loop</span> <span class="bp">()</span> <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="n">close_in</span> <span class="n">ic</span><span class="o">;</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">contents</span> <span class="n">buf</span><span class="o">;;</span>

<span class="c">(* Note: The following function does something slightly different than the Perl</span>
<span class="c"> * version, as it returns a subject,message #,refrence to the message tuple</span>
<span class="c"> * sorted by subject -&gt; message number instead of just a list of messages sorted</span>
<span class="c"> * by subject -&gt; message number -- it&#39;s trivial to get just what the Perl</span>
<span class="c"> * version does from this... *)</span>

<span class="k">let</span> <span class="n">sortedMail</span> <span class="n">fn</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">msglist</span> <span class="o">=</span>
    <span class="c">(* I had to add this filtering step due to some wierd structure in my mbox</span>
<span class="c">     * file. go figure... *)</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">filter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">s</span> <span class="mi">0</span> <span class="mi">5</span> <span class="o">=</span> <span class="s2">&quot;From:&quot;</span><span class="o">)</span>
      <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="s2">&quot;From&quot;</span> <span class="o">^</span> <span class="n">x</span><span class="o">)</span>
        <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">split</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;^From&quot;</span><span class="o">)</span> <span class="o">(</span><span class="n">slurp_to_string</span> <span class="n">fn</span><span class="o">)))</span>
  <span class="ow">and</span> <span class="n">counter</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(-</span><span class="mi">1</span><span class="o">)</span> <span class="k">in</span>
<span class="c">(*  let subjList = *)</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">sort</span> <span class="n">compare</span>
      <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span>
        <span class="o">(</span><span class="k">fun</span> <span class="n">s</span> <span class="o">-&gt;</span>
          <span class="n">ignore</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span>
            <span class="c">(* Not positive this regex is equivalent to the Perl version, but it</span>
<span class="c">             * seems to work -- you can use the third party PCRE module if you</span>
<span class="c">             * want to be positive *)</span>
            <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;^Subject:[ </span><span class="se">\t</span><span class="s2">]*</span><span class="err">\</span><span class="s2">(:?[Rr][Ee]:[ </span><span class="se">\t</span><span class="s2">]*</span><span class="err">\</span><span class="s2">)*</span><span class="err">\</span><span class="s2">(.*</span><span class="err">\</span><span class="s2">)&quot;</span><span class="o">)</span> <span class="n">s</span> <span class="mi">0</span><span class="o">);</span>
          <span class="n">incr</span> <span class="n">counter</span><span class="o">;</span>
          <span class="o">(</span><span class="k">try</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">lowercase</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">2</span> <span class="n">s</span><span class="o">))</span> <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="s2">&quot;&quot;</span><span class="o">),</span>
           <span class="o">!</span><span class="n">counter</span><span class="o">,</span>
           <span class="n">ref</span> <span class="n">s</span><span class="o">)</span>
        <span class="n">msglist</span><span class="o">);;</span>

<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="o">(_,_,</span><span class="n">rm</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">print_endline</span> <span class="o">!</span><span class="n">rm</span><span class="o">)</span> <span class="o">(</span><span class="n">sortedMail</span> <span class="s2">&quot;mbox&quot;</span><span class="o">);;</span>

<span class="c">(* To sort by using a hashtable *)</span>

<span class="k">let</span> <span class="n">keys</span> <span class="n">h</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">k</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">fold</span> <span class="o">(</span><span class="k">fun</span> <span class="n">k</span> <span class="n">v</span> <span class="n">b</span> <span class="o">-&gt;</span> <span class="n">k</span><span class="o">::</span><span class="n">b</span><span class="o">)</span> <span class="n">h</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="c">(* filter out duplicates *)</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">fold_left</span> <span class="o">(</span><span class="k">fun</span> <span class="n">b</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="nn">List</span><span class="p">.</span><span class="n">mem</span> <span class="n">x</span> <span class="n">b</span> <span class="k">then</span> <span class="n">b</span> <span class="k">else</span> <span class="n">x</span><span class="o">::</span><span class="n">b</span><span class="o">)</span> <span class="bp">[]</span> <span class="n">k</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">sortedMailByHash</span> <span class="n">fn</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">msglist</span> <span class="o">=</span>
    <span class="c">(* I had to add this filtering step due to some wierd structure in my mbox</span>
<span class="c">     * file. go figure... *)</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">filter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">s</span> <span class="mi">0</span> <span class="mi">5</span> <span class="o">=</span> <span class="s2">&quot;From:&quot;</span><span class="o">)</span>
      <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="s2">&quot;From&quot;</span> <span class="o">^</span> <span class="n">x</span><span class="o">)</span>
        <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">split</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;^From&quot;</span><span class="o">)</span> <span class="o">(</span><span class="n">slurp_to_string</span> <span class="n">fn</span><span class="o">)))</span>
  <span class="ow">and</span> <span class="n">counter</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(-</span><span class="mi">1</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">h</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">length</span> <span class="n">msglist</span><span class="o">)</span> <span class="k">in</span>
<span class="c">(*  let subjList = *)</span>
<span class="c">(*    List.sort compare *)</span>
      <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
        <span class="o">(</span><span class="k">fun</span> <span class="n">s</span> <span class="o">-&gt;</span>
          <span class="n">ignore</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span>
            <span class="c">(* Not positive this regex is equivalent to the Perl version, but it</span>
<span class="c">             * seems to work -- you can use the third party PCRE module if you</span>
<span class="c">             * want to be positive *)</span>
            <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;^Subject:[ </span><span class="se">\t</span><span class="s2">]*</span><span class="err">\</span><span class="s2">(:?[Rr][Ee]:[ </span><span class="se">\t</span><span class="s2">]*</span><span class="err">\</span><span class="s2">)*</span><span class="err">\</span><span class="s2">(.*</span><span class="err">\</span><span class="s2">)&quot;</span><span class="o">)</span> <span class="n">s</span> <span class="mi">0</span><span class="o">);</span>
          <span class="n">incr</span> <span class="n">counter</span><span class="o">;</span>
          <span class="k">let</span> <span class="n">sub</span> <span class="o">=</span>
            <span class="k">try</span>
              <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">lowercase</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">2</span> <span class="n">s</span><span class="o">))</span>
          <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="s2">&quot;&quot;</span> <span class="k">in</span>
          <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">add</span> <span class="n">h</span> <span class="n">sub</span> <span class="n">s</span><span class="o">))</span>
        <span class="n">msglist</span><span class="o">;</span>
      <span class="nn">List</span><span class="p">.</span><span class="n">flatten</span>
        <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find_all</span> <span class="n">h</span> <span class="n">x</span><span class="o">))</span>
          <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">sort</span> <span class="o">(</span><span class="n">keys</span> <span class="n">h</span><span class="o">)));;</span>

<span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">m</span> <span class="o">-&gt;</span> <span class="n">print_endline</span> <span class="n">m</span><span class="o">)</span> <span class="o">(</span><span class="n">sortedMailByHash</span> <span class="s2">&quot;mbox&quot;</span><span class="o">);;</span>


<span class="c">(* @@PLEAC@@_11.0 *)</span>
<span class="c">(* Create a reference to an integer *)</span>
<span class="k">let</span> <span class="n">aref</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* Assign to aref&#39;s contents *)</span>
  <span class="n">aref</span> <span class="o">:=</span> <span class="mi">3</span><span class="o">;</span>

  <span class="c">(* Print the value that the reference &quot;aref&quot; refers to *)</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">!</span><span class="n">aref</span><span class="o">;</span>

  <span class="c">(* Since references are just records with a single field, &quot;contents&quot;,</span>
<span class="c">     the following operations have the same effect as above *)</span>
  <span class="n">aref</span><span class="o">.</span><span class="n">contents</span> <span class="o">&lt;-</span> <span class="mi">3</span><span class="o">;</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">aref</span><span class="o">.</span><span class="n">contents</span><span class="o">;</span>

  <span class="c">(* Fast increment and decrement operations are available for int refs *)</span>
  <span class="n">incr</span> <span class="n">aref</span><span class="o">;</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;after incr: %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">!</span><span class="n">aref</span><span class="o">;</span>
  <span class="n">decr</span> <span class="n">aref</span><span class="o">;</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;after decr: %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">!</span><span class="n">aref</span>

<span class="c">(* Create a type for &quot;person&quot; records *)</span>
<span class="k">type</span> <span class="n">person</span> <span class="o">=</span> <span class="o">{</span> <span class="n">name</span> <span class="o">:</span> <span class="kt">string</span><span class="o">;</span>
                <span class="n">address</span> <span class="o">:</span> <span class="kt">string</span><span class="o">;</span>
                <span class="n">birthday</span> <span class="o">:</span> <span class="kt">int</span><span class="o">;</span>
              <span class="o">}</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* Create a &quot;person&quot; record *)</span>
  <span class="k">let</span> <span class="n">nat</span> <span class="o">=</span> <span class="o">{</span> <span class="n">name</span>     <span class="o">=</span> <span class="s2">&quot;Leonhard Euler&quot;</span><span class="o">;</span>
              <span class="n">address</span>  <span class="o">=</span> <span class="s2">&quot;1729 Ramunjan Lane</span><span class="se">\n</span><span class="s2">Mathword, PI 31416&quot;</span><span class="o">;</span>
              <span class="n">birthday</span> <span class="o">=</span> <span class="mh">0x5bb5580</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">in</span>

  <span class="c">(* Display the person&#39;s name and address *)</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">name: %s</span><span class="se">\n</span><span class="s2">address: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">nat</span><span class="o">.</span><span class="n">name</span> <span class="n">nat</span><span class="o">.</span><span class="n">address</span><span class="o">;</span>

  <span class="c">(* Same as above, using pattern-matching *)</span>
  <span class="k">let</span> <span class="o">{</span><span class="n">name</span><span class="o">=</span><span class="n">n</span><span class="o">;</span> <span class="n">address</span><span class="o">=</span><span class="n">a</span><span class="o">}</span> <span class="o">=</span> <span class="n">nat</span> <span class="k">in</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">name: %s</span><span class="se">\n</span><span class="s2">address: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">n</span> <span class="n">a</span>

<span class="c">(* @@PLEAC@@_11.1 *)</span>
<span class="c">(* The following two sections use lists instead of arrays since</span>
<span class="c">   list refs can be enlarged and copied easily. Also, arrays are</span>
<span class="c">   mutable in OCaml, whereas lists are immutable. *)</span>

<span class="c">(* Create a reference to a list *)</span>
<span class="k">let</span> <span class="n">lref</span>      <span class="o">=</span> <span class="n">ref</span> <span class="kt">list</span>
<span class="k">let</span> <span class="n">anon_list</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">[</span><span class="mi">9</span><span class="o">;</span> <span class="mi">7</span><span class="o">;</span> <span class="mi">5</span><span class="o">;</span> <span class="mi">3</span><span class="o">;</span> <span class="mi">1</span><span class="o">]</span>
<span class="k">let</span> <span class="n">anon_copy</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">!</span><span class="n">anon_list</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* Add an item to the list *)</span>
  <span class="n">anon_list</span> <span class="o">:=</span> <span class="mi">11</span> <span class="o">::</span> <span class="o">!</span><span class="n">anon_list</span><span class="o">;</span>

  <span class="c">(* Get the number of items from the list ref *)</span>
  <span class="k">let</span> <span class="n">num_items</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">length</span> <span class="o">!</span><span class="n">anon_list</span> <span class="k">in</span>

  <span class="c">(* Print original data *)</span>
  <span class="n">print_endline</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;, &quot;</span>
                   <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">string_of_int</span> <span class="n">i</span><span class="o">)</span> <span class="o">!</span><span class="n">anon_list</span><span class="o">));</span>

  <span class="c">(* Sort it *)</span>
  <span class="n">anon_list</span> <span class="o">:=</span> <span class="nn">List</span><span class="p">.</span><span class="n">sort</span> <span class="n">compare</span> <span class="o">!</span><span class="n">anon_list</span><span class="o">;</span>

  <span class="c">(* Print sorted data *)</span>
  <span class="n">print_endline</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;, &quot;</span>
                   <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">string_of_int</span> <span class="n">i</span><span class="o">)</span> <span class="o">!</span><span class="n">anon_list</span><span class="o">));</span>

<span class="c">(* @@PLEAC@@_11.2 *)</span>
<span class="c">(* Create a hash that maps strings to string lists *)</span>
<span class="k">let</span> <span class="o">(</span><span class="n">hash</span> <span class="o">:</span> <span class="o">(</span><span class="kt">string</span><span class="o">,</span> <span class="kt">string</span> <span class="kt">list</span><span class="o">)</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">t</span><span class="o">)</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span>

<span class="c">(* Define a function to add a string to the string list associated</span>
<span class="c">   with a key in the hash creating the string list if necessary *)</span>
<span class="k">let</span> <span class="n">add</span> <span class="n">hash</span> <span class="n">key</span> <span class="k">value</span> <span class="o">=</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">hash</span> <span class="n">key</span>
    <span class="o">(</span><span class="k">try</span> <span class="k">value</span> <span class="o">::</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">hash</span> <span class="n">key</span>
     <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="o">[</span><span class="k">value</span><span class="o">])</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* Populate the hash with some data *)</span>
  <span class="n">add</span> <span class="n">hash</span> <span class="s2">&quot;fruit&quot;</span> <span class="s2">&quot;apple&quot;</span><span class="o">;</span>
  <span class="n">add</span> <span class="n">hash</span> <span class="s2">&quot;fruit&quot;</span> <span class="s2">&quot;banana&quot;</span><span class="o">;</span>
  <span class="n">add</span> <span class="n">hash</span> <span class="s2">&quot;wine&quot;</span> <span class="s2">&quot;merlot&quot;</span><span class="o">;</span>
  <span class="n">add</span> <span class="n">hash</span> <span class="s2">&quot;cheese&quot;</span> <span class="s2">&quot;cheddar&quot;</span><span class="o">;</span>
  <span class="n">add</span> <span class="n">hash</span> <span class="s2">&quot;cheese&quot;</span> <span class="s2">&quot;brie&quot;</span><span class="o">;</span>
  <span class="n">add</span> <span class="n">hash</span> <span class="s2">&quot;cheese&quot;</span> <span class="s2">&quot;havarti&quot;</span><span class="o">;</span>

  <span class="c">(* Iterate and print out the hash&#39;s contents *)</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">key</span> <span class="n">values</span> <span class="o">-&gt;</span>
       <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">key</span>
         <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;, &quot;</span> <span class="n">values</span><span class="o">))</span>
    <span class="n">hash</span>

<span class="c">(* Hashtbl is somewhat unusual in that it allows multiple values for</span>
<span class="c">   a given key. By using Hashtbl.add instead of Hashtbl.replace, and</span>
<span class="c">   using strings as values instead of string lists, we can save some</span>
<span class="c">   memory *)</span>
<span class="k">let</span> <span class="o">(</span><span class="n">hash</span> <span class="o">:</span> <span class="o">(</span><span class="kt">string</span><span class="o">,</span> <span class="kt">string</span><span class="o">)</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">t</span><span class="o">)</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">add</span> <span class="n">hash</span> <span class="s2">&quot;foo&quot;</span> <span class="s2">&quot;bar&quot;</span><span class="o">;</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">add</span> <span class="n">hash</span> <span class="s2">&quot;foo&quot;</span> <span class="s2">&quot;baz&quot;</span><span class="o">;</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">add</span> <span class="n">hash</span> <span class="s2">&quot;goo&quot;</span> <span class="s2">&quot;arc&quot;</span><span class="o">;</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s =&gt; %s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span> <span class="n">hash</span>

<span class="c">(* @@PLEAC@@_11.3 *)</span>
<span class="c">(* Hashtbls are mutable, so creating a reference to a hash is usually</span>
<span class="c">   not necessary; it creates an *additional* level of indirection. *)</span>
<span class="k">let</span> <span class="n">href</span> <span class="o">=</span> <span class="n">ref</span> <span class="n">hash</span>
<span class="k">let</span> <span class="n">anon_hash</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span><span class="o">)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* Have some fun with locally-defined operators *)</span>
  <span class="k">let</span> <span class="o">(</span> <span class="o">=&gt;</span> <span class="o">)</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="o">!</span><span class="n">anon_hash</span> <span class="k">in</span>
  <span class="o">(</span> <span class="s2">&quot;key1&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;value1&quot;</span><span class="o">;</span> <span class="s2">&quot;key2&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;value2&quot;</span> <span class="o">)</span>
<span class="k">let</span> <span class="n">anon_hash_copy</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">copy</span> <span class="o">!</span><span class="n">href</span><span class="o">)</span>

<span class="c">(* @@PLEAC@@_11.4 *)</span>
<span class="c">(* Create a reference to a function *)</span>
<span class="k">let</span> <span class="n">fref</span> <span class="o">=</span> <span class="n">ref</span> <span class="n">func</span>
<span class="k">let</span> <span class="n">fref</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="c">(* ... *)</span> <span class="bp">()</span><span class="o">)</span>

<span class="c">(* Call the referent function *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="o">!</span><span class="n">fref</span> <span class="bp">()</span>

<span class="c">(* Create a reference to an association list with function values. *)</span>
<span class="k">let</span> <span class="n">commands</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="o">(</span> <span class="o">=&gt;</span> <span class="o">)</span> <span class="n">name</span> <span class="n">func</span> <span class="o">=</span> <span class="n">commands</span> <span class="o">:=</span> <span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">func</span><span class="o">)</span> <span class="o">::</span> <span class="o">!</span><span class="n">commands</span> <span class="k">in</span>
  <span class="o">(</span>
    <span class="s2">&quot;happy&quot;</span> <span class="o">=&gt;</span> <span class="n">joy</span><span class="o">;</span>
    <span class="s2">&quot;sad&quot;</span>   <span class="o">=&gt;</span> <span class="n">sullen</span><span class="o">;</span>
    <span class="s2">&quot;done&quot;</span>  <span class="o">=&gt;</span> <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="n">print_endline</span> <span class="s2">&quot;See ya!&quot;</span><span class="o">;</span> <span class="n">exit</span> <span class="mi">0</span><span class="o">);</span>
    <span class="s2">&quot;mad&quot;</span>   <span class="o">=&gt;</span> <span class="n">angry</span><span class="o">;</span>
  <span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
    <span class="n">print_string</span> <span class="s2">&quot;How are you? &quot;</span><span class="o">;</span>
    <span class="k">let</span> <span class="kt">string</span> <span class="o">=</span> <span class="n">read_line</span> <span class="bp">()</span> <span class="k">in</span>
    <span class="k">try</span>
      <span class="k">let</span> <span class="n">command</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">assoc</span> <span class="kt">string</span> <span class="o">!</span><span class="n">commands</span> <span class="k">in</span>
      <span class="n">command</span> <span class="bp">()</span>
    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;No such command: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="kt">string</span>
  <span class="k">done</span>

<span class="c">(* Use closures to generate functions that count. *)</span>

<span class="k">let</span> <span class="n">counter_maker</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">start</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span>                             <span class="c">(* this is a closure *)</span>
    <span class="k">let</span> <span class="n">result</span> <span class="o">=</span> <span class="o">!</span><span class="n">start</span> <span class="k">in</span>              <span class="c">(* lexical from enclosing scope *)</span>
    <span class="n">incr</span> <span class="n">start</span><span class="o">;</span> <span class="n">result</span>

<span class="k">let</span> <span class="n">counter1</span> <span class="o">=</span> <span class="n">counter_maker</span> <span class="bp">()</span>
<span class="k">let</span> <span class="n">counter2</span> <span class="o">=</span> <span class="n">counter_maker</span> <span class="bp">()</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">to</span> <span class="mi">4</span> <span class="k">do</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">counter1</span> <span class="bp">()</span><span class="o">)</span>
  <span class="k">done</span><span class="o">;</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%d %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">counter1</span> <span class="bp">()</span><span class="o">)</span> <span class="o">(</span><span class="n">counter2</span> <span class="bp">()</span><span class="o">)</span>
  <span class="c">(*</span>
<span class="c">    0</span>
<span class="c">    1</span>
<span class="c">    2</span>
<span class="c">    3</span>
<span class="c">    4</span>
<span class="c">    5 0</span>
<span class="c">  *)</span>

<span class="c">(* Use closures to generate functions that keep track of time.</span>
<span class="c">   Note that this example does not need references, since</span>
<span class="c">   since functions are just ordinary values in OCaml. *)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">timestamp</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">start_time</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">time</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="n">int_of_float</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">time</span> <span class="bp">()</span> <span class="o">-.</span> <span class="n">start_time</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">early</span> <span class="o">=</span> <span class="n">timestamp</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">sleep</span> <span class="mi">20</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">later</span> <span class="o">=</span> <span class="n">timestamp</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">sleep</span> <span class="mi">10</span><span class="o">;</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;It&#39;s been %d seconds since early.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">early</span> <span class="bp">()</span><span class="o">);</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;It&#39;s been %d seconds since later.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">later</span> <span class="bp">()</span><span class="o">);</span>
  <span class="c">(*</span>
<span class="c">    It&#39;s been 30 seconds since early.</span>
<span class="c">    It&#39;s been 10 seconds since later.</span>
<span class="c">  *)</span>

<span class="c">(* @@PLEAC@@_11.5 *)</span>
<span class="c">(* Environments are immutable in OCaml; there is no way to get a</span>
<span class="c">   reference to a value. If you need a mutable cell, use &quot;ref&quot; as</span>
<span class="c">   described in the introduction. If you need to refer to values</span>
<span class="c">   by name strings, use a Hashtbl.t or similar data structure. *)</span>

<span class="c">(* @@PLEAC@@_11.6 *)</span>
<span class="c">(* Create a couple of integer references *)</span>
<span class="k">let</span> <span class="n">a</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>
<span class="k">let</span> <span class="n">b</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>

<span class="c">(* Create an array of the references *)</span>
<span class="k">let</span> <span class="n">array_of_refs</span> <span class="o">=</span> <span class="o">[|</span> <span class="n">a</span><span class="o">;</span> <span class="n">b</span> <span class="o">|]</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* Set the value of an element *)</span>
  <span class="n">array_of_refs</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span> <span class="o">:=</span> <span class="mi">12</span><span class="o">;</span>              <span class="c">(* b := 12 *)</span>

  <span class="c">(* Note that this is *not* the same as array mutation! If we were to do:</span>
<span class="c">       array_of_refs.(1) &lt;- ref 12</span>
<span class="c">     (or drop the refs altogether) then we would no longer be aliasing &quot;b&quot;.</span>
<span class="c">  *)</span>

  <span class="c">(* Get the value of an element *)</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%d %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">!(</span><span class="n">array_of_refs</span><span class="o">.(</span><span class="mi">1</span><span class="o">))</span> <span class="o">!</span><span class="n">b</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="o">(</span><span class="n">a</span><span class="o">,</span> <span class="n">b</span><span class="o">,</span> <span class="n">c</span><span class="o">,</span> <span class="n">d</span><span class="o">)</span> <span class="o">=</span> <span class="o">(</span><span class="n">ref</span> <span class="mi">1</span><span class="o">,</span> <span class="n">ref</span> <span class="mi">2</span><span class="o">,</span> <span class="n">ref</span> <span class="mi">3</span><span class="o">,</span> <span class="n">ref</span> <span class="mi">4</span><span class="o">)</span> <span class="k">in</span> <span class="c">(* initialize *)</span>
  <span class="k">let</span> <span class="kt">array</span> <span class="o">=</span> <span class="o">[|</span> <span class="n">a</span><span class="o">;</span> <span class="n">b</span><span class="o">;</span> <span class="n">c</span><span class="o">;</span> <span class="n">d</span> <span class="o">|]</span> <span class="k">in</span>                    <span class="c">(* refs to each value *)</span>

  <span class="kt">array</span><span class="o">.(</span><span class="mi">2</span><span class="o">)</span> <span class="o">:=</span> <span class="o">!(</span><span class="kt">array</span><span class="o">.(</span><span class="mi">2</span><span class="o">))</span> <span class="o">+</span> <span class="mi">9</span><span class="o">;</span>        <span class="c">(* !c is now 12 *)</span>

  <span class="k">let</span> <span class="n">tmp</span> <span class="o">=</span> <span class="kt">array</span><span class="o">.(</span><span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="kt">array</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="k">in</span>
  <span class="n">tmp</span> <span class="o">:=</span> <span class="o">!</span><span class="n">tmp</span> <span class="o">*</span> <span class="mi">5</span><span class="o">;</span>                      <span class="c">(* !d is now 20 *)</span>

<span class="c">(* @@PLEAC@@_11.7 *)</span>
<span class="c">(* Since record field names must be unique to their enclosing module,</span>
<span class="c">   define a module to encapsulate the fields of the record type that</span>
<span class="c">   will contain the &quot;methods&quot;. *)</span>
<span class="k">module</span> <span class="nc">Counter</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">type</span> <span class="n">t</span> <span class="o">=</span> <span class="o">{</span> <span class="n">next</span>  <span class="o">:</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">int</span><span class="o">;</span>
             <span class="n">prev</span>  <span class="o">:</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">int</span><span class="o">;</span>
             <span class="n">last</span>  <span class="o">:</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">int</span><span class="o">;</span>
             <span class="n">get</span>   <span class="o">:</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">int</span><span class="o">;</span>
             <span class="n">set</span>   <span class="o">:</span> <span class="kt">int</span>  <span class="o">-&gt;</span> <span class="kt">unit</span><span class="o">;</span>
             <span class="n">bump</span>  <span class="o">:</span> <span class="kt">int</span>  <span class="o">-&gt;</span> <span class="kt">unit</span><span class="o">;</span>
             <span class="n">reset</span> <span class="o">:</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">int</span> <span class="o">}</span>

  <span class="k">let</span> <span class="n">make</span> <span class="n">count</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">start</span> <span class="o">=</span> <span class="n">count</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ref</span> <span class="n">start</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">prev</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">decr</span> <span class="n">count</span><span class="o">;</span> <span class="o">!</span><span class="n">count</span> <span class="k">in</span>
    <span class="o">{</span> <span class="n">next</span>  <span class="o">=</span> <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="n">incr</span> <span class="n">count</span><span class="o">;</span> <span class="o">!</span><span class="n">count</span><span class="o">);</span>
      <span class="n">prev</span>  <span class="o">=</span> <span class="n">prev</span><span class="o">;</span> <span class="n">last</span> <span class="o">=</span> <span class="n">prev</span><span class="o">;</span>
      <span class="n">get</span>   <span class="o">=</span> <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="o">!</span><span class="n">count</span><span class="o">);</span>
      <span class="n">set</span>   <span class="o">=</span> <span class="o">(</span><span class="k">fun</span> <span class="n">count&#39;</span> <span class="o">-&gt;</span> <span class="n">count</span> <span class="o">:=</span> <span class="n">count&#39;</span><span class="o">);</span>
      <span class="n">bump</span>  <span class="o">=</span> <span class="o">(</span><span class="k">fun</span> <span class="n">count&#39;</span> <span class="o">-&gt;</span> <span class="n">count</span> <span class="o">:=</span> <span class="o">!</span><span class="n">count</span> <span class="o">+</span> <span class="n">count&#39;</span><span class="o">);</span>
      <span class="n">reset</span> <span class="o">=</span> <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="n">count</span> <span class="o">:=</span> <span class="n">start</span><span class="o">;</span> <span class="o">!</span><span class="n">count</span><span class="o">)</span>
    <span class="o">}</span>
<span class="k">end</span>

<span class="c">(* Create and use a couple of counters. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">c1</span> <span class="o">=</span> <span class="nn">Counter</span><span class="p">.</span><span class="n">make</span> <span class="mi">20</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">c2</span> <span class="o">=</span> <span class="nn">Counter</span><span class="p">.</span><span class="n">make</span> <span class="mi">77</span> <span class="k">in</span>

  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;next c1: %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">c1</span><span class="o">.</span><span class="nn">Counter</span><span class="p">.</span><span class="n">next</span> <span class="bp">()</span><span class="o">);</span> <span class="c">(* 21 *)</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;next c2: %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">c2</span><span class="o">.</span><span class="nn">Counter</span><span class="p">.</span><span class="n">next</span> <span class="bp">()</span><span class="o">);</span> <span class="c">(* 78 *)</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;next c1: %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">c1</span><span class="o">.</span><span class="nn">Counter</span><span class="p">.</span><span class="n">next</span> <span class="bp">()</span><span class="o">);</span> <span class="c">(* 22 *)</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;last c1: %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">c1</span><span class="o">.</span><span class="nn">Counter</span><span class="p">.</span><span class="n">prev</span> <span class="bp">()</span><span class="o">);</span> <span class="c">(* 21 *)</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;old  c2: %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">c2</span><span class="o">.</span><span class="nn">Counter</span><span class="p">.</span><span class="n">reset</span> <span class="bp">()</span><span class="o">)</span> <span class="c">(* 77 *)</span>

<span class="c">(* Same as above, but using a &quot;local open&quot; to temporarily expose</span>
<span class="c">   the record fields for convenience. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">c1</span> <span class="o">=</span> <span class="nn">Counter</span><span class="p">.</span><span class="n">make</span> <span class="mi">20</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">c2</span> <span class="o">=</span> <span class="nn">Counter</span><span class="p">.</span><span class="n">make</span> <span class="mi">77</span> <span class="k">in</span>
  <span class="k">let</span> <span class="k">module</span> <span class="nc">Local</span> <span class="o">=</span> <span class="k">struct</span>
    <span class="k">open</span> <span class="nc">Counter</span>
    <span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;next c1: %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">c1</span><span class="o">.</span><span class="n">next</span> <span class="bp">()</span><span class="o">);</span> <span class="c">(* 21 *)</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;next c2: %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">c2</span><span class="o">.</span><span class="n">next</span> <span class="bp">()</span><span class="o">);</span> <span class="c">(* 78 *)</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;next c1: %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">c1</span><span class="o">.</span><span class="n">next</span> <span class="bp">()</span><span class="o">);</span> <span class="c">(* 22 *)</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;last c1: %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">c1</span><span class="o">.</span><span class="n">prev</span> <span class="bp">()</span><span class="o">);</span> <span class="c">(* 21 *)</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;old  c2: %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">c2</span><span class="o">.</span><span class="n">reset</span> <span class="bp">()</span><span class="o">)</span> <span class="c">(* 77 *)</span>
  <span class="k">end</span> <span class="k">in</span> <span class="bp">()</span>

<span class="c">(* @@PLEAC@@_11.8 *)</span>
<span class="c">(* There is no need to use references just to have a function that</span>
<span class="c">   calls a method. Either write a lambda: *)</span>

<span class="k">let</span> <span class="n">mref</span> <span class="o">=</span> <span class="k">fun</span> <span class="n">x</span> <span class="n">y</span> <span class="n">z</span> <span class="o">-&gt;</span> <span class="n">obj</span><span class="o">#</span><span class="n">meth</span> <span class="n">x</span> <span class="n">y</span> <span class="n">z</span>

<span class="c">(* Or, just refer to the method directly: *)</span>

<span class="k">let</span> <span class="n">mref</span> <span class="o">=</span> <span class="n">obj</span><span class="o">#</span><span class="n">meth</span>

<span class="c">(* Later... *)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">mref</span> <span class="s2">&quot;args&quot;</span> <span class="s2">&quot;go&quot;</span> <span class="s2">&quot;here&quot;</span>

<span class="c">(* @@PLEAC@@_11.9 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="k">type</span> <span class="n">record</span> <span class="o">=</span> <span class="o">{</span> <span class="n">name</span> <span class="o">:</span> <span class="kt">string</span><span class="o">;</span>
                <span class="n">empno</span> <span class="o">:</span> <span class="kt">int</span><span class="o">;</span>
                <span class="k">mutable</span> <span class="n">title</span> <span class="o">:</span> <span class="kt">string</span><span class="o">;</span>
                <span class="k">mutable</span> <span class="n">age</span> <span class="o">:</span> <span class="kt">int</span><span class="o">;</span>
                <span class="k">mutable</span> <span class="n">salary</span> <span class="o">:</span> <span class="kt">float</span><span class="o">;</span>
                <span class="k">mutable</span> <span class="n">pals</span> <span class="o">:</span> <span class="kt">string</span> <span class="kt">list</span><span class="o">;</span>
              <span class="o">}</span>

<span class="k">let</span> <span class="n">record</span> <span class="o">=</span> <span class="o">{</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Jason&quot;</span><span class="o">;</span>
               <span class="n">empno</span> <span class="o">=</span> <span class="mi">132</span><span class="o">;</span>
               <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;deputy peon&quot;</span><span class="o">;</span>
               <span class="n">age</span> <span class="o">=</span> <span class="mi">23</span><span class="o">;</span>
               <span class="n">salary</span> <span class="o">=</span> <span class="mi">37000</span><span class="o">.</span><span class="mi">00</span><span class="o">;</span>
               <span class="n">pals</span> <span class="o">=</span> <span class="o">[</span> <span class="s2">&quot;Norbert&quot;</span><span class="o">;</span> <span class="s2">&quot;Rhys&quot;</span><span class="o">;</span> <span class="s2">&quot;Phineas&quot;</span> <span class="o">]</span>
             <span class="o">}</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;I am %s, and my pals are %s.</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">record</span><span class="o">.</span><span class="n">name</span>
    <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;, &quot;</span> <span class="n">record</span><span class="o">.</span><span class="n">pals</span><span class="o">)</span>

<span class="k">let</span> <span class="n">byname</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* store record *)</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">byname</span> <span class="n">record</span><span class="o">.</span><span class="n">name</span> <span class="n">record</span><span class="o">;</span>

  <span class="c">(* later on, look up by name *)</span>
  <span class="k">begin</span>
    <span class="k">try</span>
      <span class="k">let</span> <span class="n">rp</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">byname</span> <span class="s2">&quot;Aron&quot;</span> <span class="k">in</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Aron is employee %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">rp</span><span class="o">.</span><span class="n">empno</span>
    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
      <span class="c">(* raised if missing *)</span>
      <span class="bp">()</span>
  <span class="k">end</span><span class="o">;</span>

  <span class="c">(* give jason a new pal *)</span>
  <span class="k">let</span> <span class="n">jason</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">byname</span> <span class="s2">&quot;Jason&quot;</span> <span class="k">in</span>
  <span class="n">jason</span><span class="o">.</span><span class="n">pals</span> <span class="o">&lt;-</span> <span class="s2">&quot;Theodore&quot;</span> <span class="o">::</span> <span class="n">jason</span><span class="o">.</span><span class="n">pals</span><span class="o">;</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Jason now has %d pals</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">length</span> <span class="n">jason</span><span class="o">.</span><span class="n">pals</span><span class="o">);</span>

  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">name</span> <span class="n">record</span> <span class="o">-&gt;</span>
       <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s is employee number %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">name</span> <span class="n">record</span><span class="o">.</span><span class="n">empno</span><span class="o">)</span>
    <span class="n">byname</span>

<span class="k">let</span> <span class="n">employees</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* store record *)</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">employees</span> <span class="n">record</span><span class="o">.</span><span class="n">empno</span> <span class="n">record</span><span class="o">;</span>

  <span class="c">(* lookup by id *)</span>
  <span class="k">begin</span>
    <span class="k">try</span>
      <span class="k">let</span> <span class="n">rp</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">employees</span> <span class="mi">132</span> <span class="k">in</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;employee number 132 is %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">rp</span><span class="o">.</span><span class="n">name</span>
    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
      <span class="bp">()</span>
  <span class="k">end</span><span class="o">;</span>

  <span class="k">let</span> <span class="n">jason</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">byname</span> <span class="s2">&quot;Jason&quot;</span> <span class="k">in</span>
  <span class="n">jason</span><span class="o">.</span><span class="n">salary</span> <span class="o">&lt;-</span> <span class="n">jason</span><span class="o">.</span><span class="n">salary</span> <span class="o">*.</span> <span class="mi">1</span><span class="o">.</span><span class="mi">035</span>

<span class="c">(* Return true if the string s contains the given substring. *)</span>
<span class="k">let</span> <span class="n">contains</span> <span class="n">s</span> <span class="n">substring</span> <span class="o">=</span>
  <span class="k">try</span> <span class="n">ignore</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp_string</span> <span class="n">substring</span><span class="o">)</span> <span class="n">s</span> <span class="mi">0</span><span class="o">);</span> <span class="bp">true</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">false</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* A filter function for hash tables, written as a fold. *)</span>
  <span class="k">let</span> <span class="n">grep</span> <span class="n">f</span> <span class="n">hash</span> <span class="o">=</span>
    <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">fold</span>
      <span class="o">(</span><span class="k">fun</span> <span class="n">key</span> <span class="k">value</span> <span class="n">result</span> <span class="o">-&gt;</span>
         <span class="k">if</span> <span class="n">f</span> <span class="k">value</span> <span class="k">then</span> <span class="k">value</span> <span class="o">::</span> <span class="n">result</span> <span class="k">else</span> <span class="n">result</span><span class="o">)</span>
      <span class="n">hash</span> <span class="bp">[]</span> <span class="k">in</span>

  <span class="c">(* Select records matching criteria. *)</span>
  <span class="k">let</span> <span class="n">peons</span> <span class="o">=</span>
    <span class="n">grep</span> <span class="o">(</span><span class="k">fun</span> <span class="n">employee</span> <span class="o">-&gt;</span> <span class="n">contains</span> <span class="n">employee</span><span class="o">.</span><span class="n">title</span> <span class="s2">&quot;peon&quot;</span><span class="o">)</span> <span class="n">employees</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">tsevens</span> <span class="o">=</span>
    <span class="n">grep</span> <span class="o">(</span><span class="k">fun</span> <span class="n">employee</span> <span class="o">-&gt;</span> <span class="n">employee</span><span class="o">.</span><span class="n">age</span> <span class="o">=</span> <span class="mi">27</span><span class="o">)</span> <span class="n">employees</span> <span class="k">in</span>

  <span class="c">(* Go through all records. *)</span>
  <span class="k">let</span> <span class="n">records</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">fold</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="n">v</span> <span class="n">a</span> <span class="o">-&gt;</span> <span class="n">v</span> <span class="o">::</span> <span class="n">a</span><span class="o">)</span> <span class="n">employees</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">rp</span> <span class="o">-&gt;</span>
       <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s is age %d.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">rp</span><span class="o">.</span><span class="n">name</span> <span class="n">rp</span><span class="o">.</span><span class="n">age</span><span class="o">)</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">sort</span> <span class="o">(</span><span class="k">fun</span> <span class="n">r1</span> <span class="n">r2</span> <span class="o">-&gt;</span> <span class="n">compare</span> <span class="n">r1</span><span class="o">.</span><span class="n">age</span> <span class="n">r2</span><span class="o">.</span><span class="n">age</span><span class="o">)</span> <span class="n">records</span><span class="o">)</span>

<span class="c">(* Create an array of lists of records by age. *)</span>
<span class="k">let</span> <span class="n">byage</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">create</span> <span class="mi">150</span> <span class="bp">[]</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="n">employee</span> <span class="o">-&gt;</span>
       <span class="n">byage</span><span class="o">.(</span><span class="n">employee</span><span class="o">.</span><span class="n">age</span><span class="o">)</span> <span class="o">&lt;-</span> <span class="n">employee</span> <span class="o">::</span> <span class="n">byage</span><span class="o">.(</span><span class="n">employee</span><span class="o">.</span><span class="n">age</span><span class="o">))</span>
    <span class="n">employees</span>

<span class="c">(* Print all employees by age. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">iteri</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">age</span> <span class="n">emps</span> <span class="o">-&gt;</span>
       <span class="k">match</span> <span class="n">emps</span> <span class="k">with</span>
         <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="bp">()</span>
         <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span>
             <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Age %d: &quot;</span> <span class="n">age</span><span class="o">;</span>
             <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">emp</span> <span class="o">-&gt;</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s &quot;</span> <span class="n">emp</span><span class="o">.</span><span class="n">name</span><span class="o">)</span> <span class="n">emps</span><span class="o">;</span>
             <span class="n">print_newline</span> <span class="bp">()</span><span class="o">)</span>
    <span class="n">byage</span>

<span class="c">(* Similar approach using List.map and String.concat. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">iteri</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">age</span> <span class="n">emps</span> <span class="o">-&gt;</span>
       <span class="k">match</span> <span class="n">emps</span> <span class="k">with</span>
         <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="bp">()</span>
         <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span>
             <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Age %d: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">age</span>
               <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;, &quot;</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">r</span> <span class="o">-&gt;</span> <span class="n">r</span><span class="o">.</span><span class="n">name</span><span class="o">)</span> <span class="n">emps</span><span class="o">)))</span>
    <span class="n">byage</span>

<span class="c">(* @@PLEAC@@_11.10 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="c">(* Define a list reference to contain our data. *)</span>
<span class="k">let</span> <span class="o">(</span><span class="n">list_of_records</span> <span class="o">:</span> <span class="o">(</span><span class="kt">string</span><span class="o">,</span> <span class="kt">string</span><span class="o">)</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">t</span> <span class="kt">list</span> <span class="n">ref</span><span class="o">)</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span>

<span class="c">(* Read records from standard input. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">([^:]+</span><span class="se">\\</span><span class="s2">):[ </span><span class="se">\t</span><span class="s2">]*</span><span class="se">\\</span><span class="s2">(.*</span><span class="se">\\</span><span class="s2">)&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">record</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">begin</span>
    <span class="k">try</span>
      <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
        <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">read_line</span> <span class="bp">()</span> <span class="k">in</span>
        <span class="k">if</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">regexp</span> <span class="n">line</span> <span class="mi">0</span>
        <span class="k">then</span>
          <span class="k">let</span> <span class="n">field</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">1</span> <span class="n">line</span> <span class="k">in</span>
          <span class="k">let</span> <span class="k">value</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">2</span> <span class="n">line</span> <span class="k">in</span>
          <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="o">!</span><span class="n">record</span> <span class="n">field</span> <span class="k">value</span>
        <span class="k">else</span>
          <span class="o">(</span><span class="n">list_of_records</span> <span class="o">:=</span> <span class="o">!</span><span class="n">record</span> <span class="o">::</span> <span class="o">!</span><span class="n">list_of_records</span><span class="o">;</span>
           <span class="n">record</span> <span class="o">:=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span><span class="o">)</span>
      <span class="k">done</span>
    <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
      <span class="k">if</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">length</span> <span class="o">!</span><span class="n">record</span> <span class="o">&gt;</span> <span class="mi">0</span>
      <span class="k">then</span> <span class="n">list_of_records</span> <span class="o">:=</span> <span class="o">!</span><span class="n">record</span> <span class="o">::</span> <span class="o">!</span><span class="n">list_of_records</span>
  <span class="k">end</span>

<span class="c">(* Write records to standard output. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">record</span> <span class="o">-&gt;</span>
       <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span>
         <span class="o">(</span><span class="k">fun</span> <span class="n">field</span> <span class="k">value</span> <span class="o">-&gt;</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">field</span> <span class="k">value</span><span class="o">)</span>
         <span class="n">record</span><span class="o">;</span>
       <span class="n">print_newline</span> <span class="bp">()</span><span class="o">)</span>
    <span class="o">!</span><span class="n">list_of_records</span>

<span class="c">(* @@PLEAC@@_11.11 *)</span>
<span class="c">(* If you are in the OCaml toplevel, simply enter an expression to</span>
<span class="c">   view its type and value. *)</span>
<span class="o">#</span> <span class="k">let</span> <span class="n">reference</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span> <span class="o">[</span> <span class="s2">&quot;foo&quot;</span><span class="o">,</span> <span class="s2">&quot;bar&quot;</span> <span class="o">],</span>
                        <span class="mi">3</span><span class="o">,</span>
                        <span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="n">print_endline</span> <span class="s2">&quot;hello, world&quot;</span> <span class="o">);;</span>
<span class="k">val</span> <span class="n">reference</span> <span class="o">:</span> <span class="o">((</span><span class="kt">string</span> <span class="o">*</span> <span class="kt">string</span><span class="o">)</span> <span class="kt">list</span> <span class="o">*</span> <span class="kt">int</span> <span class="o">*</span> <span class="o">(</span><span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">unit</span><span class="o">))</span> <span class="n">ref</span> <span class="o">=</span>
  <span class="o">{</span><span class="n">contents</span> <span class="o">=</span> <span class="o">([(</span><span class="s2">&quot;foo&quot;</span><span class="o">,</span> <span class="s2">&quot;bar&quot;</span><span class="o">)],</span> <span class="mi">3</span><span class="o">,</span> <span class="o">&lt;</span><span class="k">fun</span><span class="o">&gt;)}</span>

<span class="c">(* From within your own programs, use the Std.print and Std.dump</span>
<span class="c">   functions from the Extlib library, available at</span>
<span class="c">   http://ocaml-lib.sourceforge.net/ *)</span>
<span class="o">#</span> <span class="nn">Std</span><span class="p">.</span><span class="n">print</span> <span class="n">reference</span><span class="o">;;</span>
<span class="o">(([(</span><span class="s2">&quot;foo&quot;</span><span class="o">,</span> <span class="s2">&quot;bar&quot;</span><span class="o">)],</span> <span class="mi">3</span><span class="o">,</span> <span class="o">&lt;</span><span class="n">closure</span><span class="o">&gt;))</span>
<span class="o">-</span> <span class="o">:</span> <span class="kt">unit</span> <span class="o">=</span> <span class="bp">()</span>
<span class="o">#</span> <span class="nn">Std</span><span class="p">.</span><span class="n">dump</span> <span class="n">reference</span><span class="o">;;</span>
<span class="o">-</span> <span class="o">:</span> <span class="kt">string</span> <span class="o">=</span> <span class="s2">&quot;(([(</span><span class="se">\&quot;</span><span class="s2">foo</span><span class="se">\&quot;</span><span class="s2">, </span><span class="se">\&quot;</span><span class="s2">bar</span><span class="se">\&quot;</span><span class="s2">)], 3, &lt;closure&gt;))&quot;</span>

<span class="c">(* @@PLEAC@@_11.12 *)</span>
<span class="c">(* Immutable data structures such as int, char, float, tuple, list, Set,</span>
<span class="c">   and Map can be copied by assignment. *)</span>
<span class="k">let</span> <span class="n">v2</span> <span class="o">=</span> <span class="n">v1</span>
<span class="k">let</span> <span class="n">r2</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">!</span><span class="n">r1</span>

<span class="c">(* Objects can be shallow-copied using Oo.copy. *)</span>
<span class="k">let</span> <span class="n">o2</span> <span class="o">=</span> <span class="nn">Oo</span><span class="p">.</span><span class="n">copy</span> <span class="n">o1</span>

<span class="c">(* Several built-in types include copy functions. *)</span>
<span class="k">let</span> <span class="n">a2</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">copy</span> <span class="n">a1</span>
<span class="k">let</span> <span class="n">h2</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">copy</span> <span class="n">h1</span>
<span class="k">let</span> <span class="n">s2</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">copy</span> <span class="n">s1</span>

<span class="c">(* Any data structure can be deep-copied by running it through Marshal,</span>
<span class="c">   though this is not very efficient. *)</span>
<span class="k">let</span> <span class="o">(</span><span class="n">copy</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">fun</span> <span class="k">value</span> <span class="o">-&gt;</span>
    <span class="nn">Marshal</span><span class="p">.</span><span class="n">from_string</span>
      <span class="o">(</span><span class="nn">Marshal</span><span class="p">.</span><span class="n">to_string</span> <span class="k">value</span> <span class="o">[</span><span class="nn">Marshal</span><span class="p">.</span><span class="nc">Closures</span><span class="o">])</span>
      <span class="mi">0</span>

<span class="c">(* @@PLEAC@@_11.13 *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* Store a data structure to disk. *)</span>
  <span class="k">let</span> <span class="n">out_channel</span> <span class="o">=</span> <span class="n">open_out_bin</span> <span class="s2">&quot;filename&quot;</span> <span class="k">in</span>
  <span class="nn">Marshal</span><span class="p">.</span><span class="n">to_channel</span> <span class="n">out_channel</span> <span class="n">data</span> <span class="bp">[]</span><span class="o">;</span>
  <span class="n">close_out</span> <span class="n">out_channel</span><span class="o">;</span>

  <span class="c">(* Load a data structure from disk. *)</span>
  <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span> <span class="n">open_in_bin</span> <span class="s2">&quot;filename&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">data</span> <span class="o">=</span> <span class="nn">Marshal</span><span class="p">.</span><span class="n">from_channel</span> <span class="n">in_channel</span> <span class="k">in</span>
  <span class="c">(* ... *)</span>
  <span class="bp">()</span><span class="o">;;</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* Store a data structure to disk, with exclusive locking. *)</span>
  <span class="k">let</span> <span class="n">out_channel</span> <span class="o">=</span> <span class="n">open_out_bin</span> <span class="s2">&quot;filename&quot;</span> <span class="k">in</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">lockf</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">descr_of_out_channel</span> <span class="n">out_channel</span><span class="o">)</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">F_LOCK</span> <span class="mi">0</span><span class="o">;</span>
  <span class="nn">Marshal</span><span class="p">.</span><span class="n">to_channel</span> <span class="n">out_channel</span> <span class="n">data</span> <span class="bp">[]</span><span class="o">;</span>
  <span class="n">close_out</span> <span class="n">out_channel</span><span class="o">;</span>

  <span class="c">(* Load a data structure from disk, with shared locking. *)</span>
  <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span> <span class="n">open_in_bin</span> <span class="s2">&quot;filename&quot;</span> <span class="k">in</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">lockf</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">descr_of_in_channel</span> <span class="n">in_channel</span><span class="o">)</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">F_RLOCK</span> <span class="mi">0</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">data</span> <span class="o">=</span> <span class="nn">Marshal</span><span class="p">.</span><span class="n">from_channel</span> <span class="n">in_channel</span> <span class="k">in</span>
  <span class="c">(* ... *)</span>
  <span class="bp">()</span>

<span class="c">(* @@PLEAC@@_11.14 *)</span>
<span class="c">(* See recipes 14.8 and 14.9 for examples of (mostly) transparent</span>
<span class="c">   persistence using DBM and Marshal in a type-safe manner. *)</span>

<span class="c">(* @@PLEAC@@_11.15 *)</span>
<span class="c">(* bintree - binary tree demo program *)</span>

<span class="k">type</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">tree</span> <span class="o">=</span> <span class="o">{</span> <span class="k">value</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span><span class="o">;</span>
                 <span class="n">left</span>  <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">tree</span> <span class="n">option</span><span class="o">;</span>
                 <span class="n">right</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">tree</span> <span class="n">option</span> <span class="o">}</span>

<span class="k">let</span> <span class="k">rec</span> <span class="n">string_of_tree</span> <span class="n">tree</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;{ value = %d; left = %s; right = %s }&quot;</span>
    <span class="n">tree</span><span class="o">.</span><span class="k">value</span>
    <span class="o">(</span><span class="k">match</span> <span class="n">tree</span><span class="o">.</span><span class="n">left</span> <span class="k">with</span>
       <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="s2">&quot;None&quot;</span>
       <span class="o">|</span> <span class="nc">Some</span> <span class="n">tree</span> <span class="o">-&gt;</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;Some (%s)&quot;</span> <span class="o">(</span><span class="n">string_of_tree</span> <span class="n">tree</span><span class="o">))</span>
    <span class="o">(</span><span class="k">match</span> <span class="n">tree</span><span class="o">.</span><span class="n">right</span> <span class="k">with</span>
       <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="s2">&quot;None&quot;</span>
       <span class="o">|</span> <span class="nc">Some</span> <span class="n">tree</span> <span class="o">-&gt;</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;Some (%s)&quot;</span> <span class="o">(</span><span class="n">string_of_tree</span> <span class="n">tree</span><span class="o">))</span>

<span class="c">(* insert given value into proper point of</span>
<span class="c">   provided tree.  If no tree provided,</span>
<span class="c">   fill one in for our caller. *)</span>
<span class="k">let</span> <span class="k">rec</span> <span class="n">insert</span> <span class="n">tree</span> <span class="k">value</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">tree</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="o">{</span> <span class="k">value</span> <span class="o">=</span> <span class="k">value</span><span class="o">;</span> <span class="n">left</span> <span class="o">=</span> <span class="nc">None</span><span class="o">;</span> <span class="n">right</span> <span class="o">=</span> <span class="nc">None</span> <span class="o">}</span>
    <span class="o">|</span> <span class="nc">Some</span> <span class="n">tree</span> <span class="o">-&gt;</span>
        <span class="k">if</span> <span class="n">tree</span><span class="o">.</span><span class="k">value</span> <span class="o">&gt;</span> <span class="k">value</span>
        <span class="k">then</span> <span class="o">{</span> <span class="k">value</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="k">value</span><span class="o">;</span>
               <span class="n">left</span>  <span class="o">=</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">insert</span> <span class="n">tree</span><span class="o">.</span><span class="n">left</span> <span class="k">value</span><span class="o">);</span>
               <span class="n">right</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">right</span> <span class="o">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="n">tree</span><span class="o">.</span><span class="k">value</span> <span class="o">&lt;</span> <span class="k">value</span>
        <span class="k">then</span> <span class="o">{</span> <span class="k">value</span> <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="k">value</span><span class="o">;</span>
               <span class="n">left</span>  <span class="o">=</span> <span class="n">tree</span><span class="o">.</span><span class="n">left</span><span class="o">;</span>
               <span class="n">right</span> <span class="o">=</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">insert</span> <span class="n">tree</span><span class="o">.</span><span class="n">right</span> <span class="k">value</span><span class="o">)</span> <span class="o">}</span>
        <span class="k">else</span> <span class="n">tree</span>

<span class="c">(* recurse on left child,</span>
<span class="c">   then show current value,</span>
<span class="c">   then recurse on right child. *)</span>
<span class="k">let</span> <span class="k">rec</span> <span class="n">in_order</span> <span class="n">tree</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">tree</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="bp">()</span>
    <span class="o">|</span> <span class="nc">Some</span> <span class="n">tree</span> <span class="o">-&gt;</span>
        <span class="n">in_order</span> <span class="n">tree</span><span class="o">.</span><span class="n">left</span><span class="o">;</span>
        <span class="n">print_int</span> <span class="n">tree</span><span class="o">.</span><span class="k">value</span><span class="o">;</span>
        <span class="n">print_string</span> <span class="s2">&quot; &quot;</span><span class="o">;</span>
        <span class="n">in_order</span> <span class="n">tree</span><span class="o">.</span><span class="n">right</span>

<span class="c">(* show current value,</span>
<span class="c">   then recurse on left child,</span>
<span class="c">   then recurse on right child. *)</span>
<span class="k">let</span> <span class="k">rec</span> <span class="n">pre_order</span> <span class="n">tree</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">tree</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="bp">()</span>
    <span class="o">|</span> <span class="nc">Some</span> <span class="n">tree</span> <span class="o">-&gt;</span>
        <span class="n">print_int</span> <span class="n">tree</span><span class="o">.</span><span class="k">value</span><span class="o">;</span>
        <span class="n">print_string</span> <span class="s2">&quot; &quot;</span><span class="o">;</span>
        <span class="n">pre_order</span> <span class="n">tree</span><span class="o">.</span><span class="n">left</span><span class="o">;</span>
        <span class="n">pre_order</span> <span class="n">tree</span><span class="o">.</span><span class="n">right</span>

<span class="c">(* recurse on left child,</span>
<span class="c">   then recurse on right child,</span>
<span class="c">   then show current value. *)</span>
<span class="k">let</span> <span class="k">rec</span> <span class="n">post_order</span> <span class="n">tree</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">tree</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="bp">()</span>
    <span class="o">|</span> <span class="nc">Some</span> <span class="n">tree</span> <span class="o">-&gt;</span>
        <span class="n">post_order</span> <span class="n">tree</span><span class="o">.</span><span class="n">left</span><span class="o">;</span>
        <span class="n">post_order</span> <span class="n">tree</span><span class="o">.</span><span class="n">right</span><span class="o">;</span>
        <span class="n">print_int</span> <span class="n">tree</span><span class="o">.</span><span class="k">value</span><span class="o">;</span>
        <span class="n">print_string</span> <span class="s2">&quot; &quot;</span>

<span class="c">(* find out whether provided value is in the tree.</span>
<span class="c">   if so, return the node at which the value was found.</span>
<span class="c">   cut down search time by only looking in the correct</span>
<span class="c">   branch, based on current value. *)</span>
<span class="k">let</span> <span class="k">rec</span> <span class="n">search</span> <span class="n">tree</span> <span class="k">value</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">tree</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">Some</span> <span class="n">tree</span> <span class="o">-&gt;</span>
        <span class="k">if</span> <span class="n">tree</span><span class="o">.</span><span class="k">value</span> <span class="o">=</span> <span class="k">value</span>
        <span class="k">then</span> <span class="nc">Some</span> <span class="n">tree</span>
        <span class="k">else</span> <span class="n">search</span> <span class="o">(</span><span class="k">if</span> <span class="k">value</span> <span class="o">&lt;</span> <span class="n">tree</span><span class="o">.</span><span class="k">value</span> <span class="k">then</span> <span class="n">tree</span><span class="o">.</span><span class="n">left</span> <span class="k">else</span> <span class="n">tree</span><span class="o">.</span><span class="n">right</span><span class="o">)</span> <span class="k">value</span>
    <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="nc">None</span>

<span class="c">(* reference to the root of the tree *)</span>
<span class="k">let</span> <span class="n">root</span> <span class="o">=</span> <span class="n">ref</span> <span class="nc">None</span>

<span class="c">(* first generate 20 random inserts *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Random</span><span class="p">.</span><span class="n">self_init</span> <span class="bp">()</span><span class="o">;</span>
  <span class="k">for</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">to</span> <span class="mi">19</span> <span class="k">do</span>
    <span class="n">root</span> <span class="o">:=</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">insert</span> <span class="o">!</span><span class="n">root</span> <span class="o">(</span><span class="nn">Random</span><span class="p">.</span><span class="n">int</span> <span class="mi">1000</span><span class="o">))</span>
  <span class="k">done</span>

<span class="c">(* now dump out the tree all three ways *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">print_string</span> <span class="s2">&quot;Pre order: &quot;</span><span class="o">;</span> <span class="n">pre_order</span> <span class="o">!</span><span class="n">root</span><span class="o">;</span> <span class="n">print_newline</span> <span class="bp">()</span><span class="o">;</span>
  <span class="n">print_string</span> <span class="s2">&quot;In order: &quot;</span><span class="o">;</span> <span class="n">in_order</span> <span class="o">!</span><span class="n">root</span><span class="o">;</span> <span class="n">print_newline</span> <span class="bp">()</span><span class="o">;</span>
  <span class="n">print_string</span> <span class="s2">&quot;Post order: &quot;</span><span class="o">;</span> <span class="n">post_order</span> <span class="o">!</span><span class="n">root</span><span class="o">;</span> <span class="n">print_newline</span> <span class="bp">()</span>

<span class="c">(* prompt until EOF *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">read_line</span> <span class="bp">()</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">num</span> <span class="o">=</span> <span class="n">int_of_string</span> <span class="n">line</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">found</span> <span class="o">=</span> <span class="n">search</span> <span class="o">!</span><span class="n">root</span> <span class="n">num</span> <span class="k">in</span>
      <span class="k">match</span> <span class="n">found</span> <span class="k">with</span>
        <span class="o">|</span> <span class="nc">Some</span> <span class="n">tree</span> <span class="o">-&gt;</span>
            <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Found %d at %s, %d</span><span class="se">\n</span><span class="s2">&quot;</span>
              <span class="n">num</span>
              <span class="o">(</span><span class="n">string_of_tree</span> <span class="n">tree</span><span class="o">)</span>
              <span class="n">tree</span><span class="o">.</span><span class="k">value</span>
        <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span>
            <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;No %d in the tree</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">num</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
    <span class="bp">()</span>

<span class="c">(* @@PLEAC@@_12.0 *)</span>
<span class="c">(* When an OCaml source file is compiled, it becomes a module. The name</span>
<span class="c">   of the module is the capitalized form of the filename. For example,</span>
<span class="c">   if the source file is &quot;my_module.ml&quot;, the module name is &quot;My_module&quot;.</span>

<span class="c">   Modules can also be created explicitly within a source file. If</span>
<span class="c">   &quot;my_module.ml&quot; contains &quot;module Foo = struct ... end&quot;, a module named</span>
<span class="c">   &quot;My_module.Foo&quot; will be created.</span>

<span class="c">   Here is an example of the definition and use of two modules within a</span>
<span class="c">   single source file: *)</span>

<span class="k">module</span> <span class="nc">Alpha</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">let</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;first&quot;</span>
<span class="k">end</span>

<span class="k">module</span> <span class="nc">Omega</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">let</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;last&quot;</span>
<span class="k">end</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Alpha is %s, Omega is %s.</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="nn">Alpha</span><span class="p">.</span><span class="n">name</span> <span class="nn">Omega</span><span class="p">.</span><span class="n">name</span>

<span class="c">(* Alpha is first, Omega is last. *)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* The &quot;#use&quot; and &quot;#load&quot; commands are known as toplevel directives.</span>
<span class="c">   They can only be used while interacting with the interpreter or from</span>
<span class="c">   scripts that are run using the &quot;ocaml&quot; program. *)</span>

<span class="c">(* &quot;#use&quot; loads a source file into the current scope. *)</span>
<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;FileHandle.ml&quot;</span><span class="o">;;</span>

<span class="c">(* &quot;#load&quot; loads a module from a compiled bytecode file. This has the</span>
<span class="c">   same effect as including this file during bytecode compilation. *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;FileHandle.cmo&quot;</span><span class="o">;;</span>

<span class="c">(* &quot;#load&quot; can be used with libraries as well as modules. Bytecode</span>
<span class="c">   libraries use an extension of &quot;.cma&quot;. *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;library.cma&quot;</span><span class="o">;;</span>

<span class="c">(* The &quot;open&quot; statement can be used in any source file. It allows any</span>
<span class="c">   values defined within a module to be used without being prefixed by</span>
<span class="c">   the module name. *)</span>
<span class="k">open</span> <span class="nc">FileHandle</span>

<span class="c">(* Modules form a hierarchy; submodules can be opened in a similar</span>
<span class="c">   fashion by prefixing them with the parent module&#39;s name. *)</span>
<span class="k">open</span> <span class="nn">Cards</span><span class="p">.</span><span class="nc">Poker</span>

<span class="c">(* It is often convenient to use Gerd Stolpmann&#39;s &quot;findlib&quot; system,</span>
<span class="c">   which makes it considerably easier to load libraries into the</span>
<span class="c">   interpreter. *)</span>

<span class="o">#</span> <span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">-</span> <span class="o">:</span> <span class="kt">unit</span> <span class="o">=</span> <span class="bp">()</span>
<span class="nc">Findlib</span> <span class="n">has</span> <span class="n">been</span> <span class="n">successfully</span> <span class="n">loaded</span><span class="o">.</span> <span class="nc">Additional</span> <span class="n">directives</span><span class="o">:</span>
  <span class="o">#</span><span class="n">require</span> <span class="s2">&quot;package&quot;</span><span class="o">;;</span>      <span class="k">to</span> <span class="n">load</span> <span class="n">a</span> <span class="n">package</span>
  <span class="o">#</span><span class="kt">list</span><span class="o">;;</span>                   <span class="k">to</span> <span class="kt">list</span> <span class="n">the</span> <span class="n">available</span> <span class="n">packages</span>
  <span class="o">#</span><span class="n">camlp4o</span><span class="o">;;</span>                <span class="k">to</span> <span class="n">load</span> <span class="n">camlp4</span> <span class="o">(</span><span class="n">standard</span> <span class="n">syntax</span><span class="o">)</span>
  <span class="o">#</span><span class="n">camlp4r</span><span class="o">;;</span>                <span class="k">to</span> <span class="n">load</span> <span class="n">camlp4</span> <span class="o">(</span><span class="n">revised</span> <span class="n">syntax</span><span class="o">)</span>
  <span class="o">#</span><span class="n">predicates</span> <span class="s2">&quot;p,q,...&quot;</span><span class="o">;;</span>   <span class="k">to</span> <span class="n">set</span> <span class="n">these</span> <span class="n">predicates</span>
  <span class="nn">Topfind</span><span class="p">.</span><span class="n">reset</span><span class="bp">()</span><span class="o">;;</span>         <span class="k">to</span> <span class="n">force</span> <span class="n">that</span> <span class="n">packages</span> <span class="n">will</span> <span class="n">be</span> <span class="n">reloaded</span>
  <span class="o">#</span><span class="n">thread</span><span class="o">;;</span>                 <span class="k">to</span> <span class="n">enable</span> <span class="n">threads</span>

<span class="o">-</span> <span class="o">:</span> <span class="kt">unit</span> <span class="o">=</span> <span class="bp">()</span>
<span class="o">#</span> <span class="o">#</span><span class="n">require</span> <span class="s2">&quot;extlib&quot;</span><span class="o">;;</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ocaml</span><span class="o">/</span><span class="mi">3</span><span class="o">.</span><span class="mi">10</span><span class="o">.</span><span class="mi">2</span><span class="o">/</span><span class="n">extlib</span><span class="o">:</span> <span class="n">added</span> <span class="k">to</span> <span class="n">search</span> <span class="n">path</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ocaml</span><span class="o">/</span><span class="mi">3</span><span class="o">.</span><span class="mi">10</span><span class="o">.</span><span class="mi">2</span><span class="o">/</span><span class="n">extlib</span><span class="o">/</span><span class="n">extLib</span><span class="o">.</span><span class="n">cma</span><span class="o">:</span> <span class="n">loaded</span>

<span class="c">(* The above use of &quot;#require&quot; has the same effect as typing the</span>
<span class="c">   following: *)</span>

<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+extlib&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;extLib.cma&quot;</span><span class="o">;;</span>

<span class="c">(* More information on the &quot;findlib&quot; system is available here:</span>
<span class="c">   http://projects.camlcity.org/projects/findlib.html</span>

<span class="c">   The &quot;#directory&quot; directive above is built into OCaml and allows</span>
<span class="c">   you to add additional directories to the path that is searched</span>
<span class="c">   when loading modules. You can use a prefix of &#39;+&#39; to indicate that</span>
<span class="c">   the directory is under the standard library path, which is usually</span>
<span class="c">   something like &quot;/usr/lib/ocaml/3.10.2/&quot;.</span>

<span class="c">   Modules can be easily aliased using assignment. This will also</span>
<span class="c">   cause the interpreter to output the module&#39;s signature, which</span>
<span class="c">   can be used as a quick reference. *)</span>

<span class="o">#</span> <span class="k">module</span> <span class="nc">S</span> <span class="o">=</span> <span class="nn">ExtString</span><span class="p">.</span><span class="nc">String</span><span class="o">;;</span>
<span class="k">module</span> <span class="nc">S</span> <span class="o">:</span>
  <span class="k">sig</span>
    <span class="k">val</span> <span class="n">init</span> <span class="o">:</span> <span class="kt">int</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="kt">int</span> <span class="o">-&gt;</span> <span class="kt">char</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="kt">string</span>
    <span class="k">val</span> <span class="n">find</span> <span class="o">:</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="kt">int</span>
    <span class="k">val</span> <span class="n">split</span> <span class="o">:</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="kt">string</span> <span class="o">*</span> <span class="kt">string</span>
    <span class="k">val</span> <span class="n">nsplit</span> <span class="o">:</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="kt">string</span> <span class="kt">list</span>
    <span class="k">val</span> <span class="n">join</span> <span class="o">:</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="kt">string</span> <span class="kt">list</span> <span class="o">-&gt;</span> <span class="kt">string</span>
    <span class="o">...</span>
  <span class="k">end</span>
<span class="o">#</span> <span class="nn">S</span><span class="p">.</span><span class="n">join</span><span class="o">;;</span>
<span class="o">-</span> <span class="o">:</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="kt">string</span> <span class="kt">list</span> <span class="o">-&gt;</span> <span class="kt">string</span> <span class="o">=</span> <span class="o">&lt;</span><span class="k">fun</span><span class="o">&gt;</span>

<span class="c">(* Many useful libraries can be found at The Caml Hump:</span>
<span class="c">   http://caml.inria.fr/cgi-bin/hump.cgi *)</span>

<span class="c">(* @@PLEAC@@_12.1 *)</span>
<span class="c">(* Interfaces, also known as module types or signatures, are usually</span>
<span class="c">   saved in files with the same name as the corresponding module but</span>
<span class="c">   with a &quot;.mli&quot; extension. For instance, if the module is defined in</span>
<span class="c">   &quot;YourModule.ml&quot;, the interface will be in &quot;YourModule.mli&quot;. *)</span>

<span class="c">(* YourModule.mli *)</span>
<span class="k">val</span> <span class="n">version</span> <span class="o">:</span> <span class="kt">string</span>

<span class="c">(* YourModule.ml *)</span>
<span class="k">let</span> <span class="n">version</span> <span class="o">=</span> <span class="s2">&quot;1.00&quot;</span>

<span class="c">(* As with modules, interfaces can also be defined explicitly inside</span>
<span class="c">   of a source file. *)</span>

<span class="k">module</span> <span class="k">type</span> <span class="nc">YourModuleSignature</span> <span class="o">=</span>
<span class="k">sig</span>
  <span class="k">val</span> <span class="n">version</span> <span class="o">:</span> <span class="kt">string</span>
<span class="k">end</span>

<span class="k">module</span> <span class="nc">YourModule</span> <span class="o">:</span> <span class="nc">YourModuleSignature</span> <span class="o">=</span>
<span class="k">struct</span>
  <span class="k">let</span> <span class="n">version</span> <span class="o">=</span> <span class="s2">&quot;1.00&quot;</span>
<span class="k">end</span>

<span class="c">(* Signatures can also be anonymous. *)</span>

<span class="k">module</span> <span class="nc">YourModule</span> <span class="o">:</span>
<span class="k">sig</span>
  <span class="k">val</span> <span class="n">version</span> <span class="o">:</span> <span class="kt">string</span>
<span class="k">end</span> <span class="o">=</span>
<span class="k">struct</span>
  <span class="k">let</span> <span class="n">version</span> <span class="o">=</span> <span class="s2">&quot;1.00&quot;</span>
<span class="k">end</span>

<span class="c">(* @@PLEAC@@_12.2 *)</span>
<span class="c">(* Due to static typing, missing modules are detected at compilation</span>
<span class="c">   time, so this is not normally an error you can catch (or need to).</span>
<span class="c">   When using ocaml interactively or as an interpreter, the &quot;#load&quot;</span>
<span class="c">   directive can fail, resulting in a message like the following:</span>

<span class="c">       Cannot find file &lt;filename&gt;.</span>

<span class="c">   being printed to standard output. This is also not an error you can</span>
<span class="c">   catch, and its occurrence will not stop the script from executing.</span>
<span class="c">   It is possible to dynamically load modules and detect the failure of</span>
<span class="c">   this operation with Dynlink. An example is given in the next recipe. *)</span>

<span class="c">(* @@PLEAC@@_12.3 *)</span>
<span class="c">(* Registry.ml *)</span>
<span class="k">let</span> <span class="o">(</span><span class="n">registry</span> <span class="o">:</span> <span class="o">(</span><span class="kt">string</span><span class="o">,</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">unit</span><span class="o">)</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">t</span><span class="o">)</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">32</span>

<span class="c">(* SomeModule.ml *)</span>
<span class="k">let</span> <span class="n">say_hello</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">print_endline</span> <span class="s2">&quot;Hello, world!&quot;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="nn">Registry</span><span class="p">.</span><span class="n">registry</span> <span class="s2">&quot;say_hello&quot;</span> <span class="n">say_hello</span>

<span class="c">(* Main program *)</span>
<span class="k">let</span> <span class="n">filename</span> <span class="o">=</span> <span class="s2">&quot;SomeModule.cmo&quot;</span>
<span class="k">let</span> <span class="n">funcname</span> <span class="o">=</span> <span class="s2">&quot;say_hello&quot;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Dynlink</span><span class="p">.</span><span class="n">init</span> <span class="bp">()</span><span class="o">;</span>
  <span class="o">(</span><span class="k">try</span> <span class="nn">Dynlink</span><span class="p">.</span><span class="n">loadfile</span> <span class="n">filename</span>
   <span class="k">with</span> <span class="nn">Dynlink</span><span class="p">.</span><span class="nc">Error</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="o">(</span><span class="nn">Dynlink</span><span class="p">.</span><span class="n">error_message</span> <span class="n">e</span><span class="o">));</span>
  <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="nn">Registry</span><span class="p">.</span><span class="n">registry</span> <span class="n">funcname</span><span class="o">)</span> <span class="bp">()</span>

<span class="c">(* Note that the Dynlink module currently supports dynamic loading of</span>
<span class="c">   bytecode modules only. There is a project to add support for dynamic</span>
<span class="c">   loading of native code which has been merged with OCaml&#39;s CVS HEAD.</span>
<span class="c">   Details are available at http://alain.frisch.fr/natdynlink.html *)</span>

<span class="c">(* @@PLEAC@@_12.4 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>
<span class="k">module</span> <span class="nc">Flipper</span> <span class="o">:</span>
<span class="k">sig</span>
  <span class="k">val</span> <span class="n">flip_boundary</span> <span class="o">:</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="kt">string</span>
  <span class="k">val</span> <span class="n">flip_words</span> <span class="o">:</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="kt">string</span>
<span class="k">end</span> <span class="o">=</span>
<span class="k">struct</span>
  <span class="k">let</span> <span class="n">separatrix</span> <span class="o">=</span> <span class="n">ref</span> <span class="s2">&quot; &quot;</span>  <span class="c">(* hidden by signature *)</span>
  <span class="k">let</span> <span class="n">flip_boundary</span> <span class="n">sep</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">prev_sep</span> <span class="o">=</span> <span class="o">!</span><span class="n">separatrix</span> <span class="k">in</span>
    <span class="n">separatrix</span> <span class="o">:=</span> <span class="n">sep</span><span class="o">;</span>
    <span class="n">prev_sep</span>
  <span class="k">let</span> <span class="n">flip_words</span> <span class="n">line</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">words</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">split</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp_string</span> <span class="o">!</span><span class="n">separatrix</span><span class="o">)</span> <span class="n">line</span> <span class="k">in</span>
    <span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="o">!</span><span class="n">separatrix</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="n">words</span><span class="o">)</span>
<span class="k">end</span>

<span class="c">(* @@PLEAC@@_12.5 *)</span>
<span class="c">(* This is very difficult to do in OCaml due to the lack of reflection</span>
<span class="c">   capabilities. Determining the current module name is reasonably easy,</span>
<span class="c">   however, by using the __FILE__ constant exposed by camlp4&#39;s macro</span>
<span class="c">   extensions. *)</span>

<span class="c">(*pp camlp4of *)</span>
<span class="k">let</span> <span class="o">__</span><span class="n">MODULE__</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">capitalize</span> <span class="o">(</span><span class="nn">Filename</span><span class="p">.</span><span class="n">chop_extension</span> <span class="o">__</span><span class="n">FILE__</span><span class="o">)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;I am in module %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">__</span><span class="n">MODULE__</span>

<span class="c">(* @@PLEAC@@_12.6 *)</span>
<span class="c">(* Use the built-in function, &quot;at_exit&quot;, to schedule clean-up handlers</span>
<span class="c">   to run when the main program exits. *)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">logfile</span> <span class="o">=</span> <span class="s2">&quot;/tmp/mylog&quot;</span>
<span class="k">let</span> <span class="n">lf</span> <span class="o">=</span> <span class="n">open_out</span> <span class="n">logfile</span>

<span class="k">let</span> <span class="n">logmsg</span> <span class="n">msg</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">fprintf</span> <span class="n">lf</span> <span class="s2">&quot;%s %d: %s</span><span class="se">\n</span><span class="s2">%!&quot;</span>
    <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">getpid</span> <span class="bp">()</span><span class="o">)</span> <span class="n">msg</span>

<span class="c">(* Setup code. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">logmsg</span> <span class="s2">&quot;startup&quot;</span>

<span class="c">(* Clean-up code. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">at_exit</span>
    <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span>
       <span class="n">logmsg</span> <span class="s2">&quot;shutdown&quot;</span><span class="o">;</span>
       <span class="n">close_out</span> <span class="n">lf</span><span class="o">)</span>

<span class="c">(* @@PLEAC@@_12.7 *)</span>
<span class="c">(* To add a directory to the module include path, pass the &quot;-I&quot; option</span>
<span class="c">   to any of the compiler tools. For example, if you have a module in</span>
<span class="c">   ~/ocamllib called Utils with a filename of utils.cmo, you can build</span>
<span class="c">   against this module with the following: *)</span>

<span class="o">$</span> <span class="n">ocamlc</span> <span class="o">-</span><span class="nc">I</span> <span class="o">~/</span><span class="n">ocamllib</span> <span class="n">utils</span><span class="o">.</span><span class="n">cmo</span> <span class="n">test</span><span class="o">.</span><span class="n">ml</span> <span class="o">-</span><span class="n">o</span> <span class="n">test</span>

<span class="c">(* Within the toplevel interpreter, and from ocaml scripts, you can use</span>
<span class="c">   the &quot;#directory&quot; directive to add directories to the include path: *)</span>

<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;/home/myuser/ocamllib&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;utils.cmo&quot;</span><span class="o">;;</span>

<span class="c">(* In both cases, prefixing the include directory with a &#39;+&#39; indicates</span>
<span class="c">   that the directory should be found relative to the standard include</span>
<span class="c">   path. *)</span>

<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+pcre&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;pcre.cma&quot;</span><span class="o">;;</span>

<span class="c">(* If you have findlib installed, you can print out the include path by</span>
<span class="c">   typing &quot;ocamlfind printconf path&quot; at the command line. *)</span>

<span class="o">$</span> <span class="n">ocamlfind</span> <span class="n">printconf</span> <span class="n">path</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ocaml</span><span class="o">/</span><span class="mi">3</span><span class="o">.</span><span class="mi">10</span><span class="o">.</span><span class="mi">2</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ocaml</span><span class="o">/</span><span class="mi">3</span><span class="o">.</span><span class="mi">10</span><span class="o">.</span><span class="mi">2</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ocaml</span><span class="o">/</span><span class="mi">3</span><span class="o">.</span><span class="mi">10</span><span class="o">.</span><span class="mi">2</span><span class="o">/</span><span class="nc">METAS</span>

<span class="c">(* Instead of keeping a directory of &quot;.cmo&quot; (or &quot;.cmx&quot;) files, you may</span>
<span class="c">   prefer to build a library (&quot;.cma&quot; for bytecode, &quot;.cmxa&quot; for native).</span>
<span class="c">   This will pack all of your modules into a single file that is easy to</span>
<span class="c">   use during compilation: *)</span>

<span class="o">$</span> <span class="n">ocamlc</span> <span class="o">-</span><span class="n">a</span> <span class="n">slicer</span><span class="o">.</span><span class="n">cmo</span> <span class="n">dicer</span><span class="o">.</span><span class="n">cmo</span> <span class="o">-</span><span class="n">o</span> <span class="n">tools</span><span class="o">.</span><span class="n">cma</span>
<span class="o">$</span> <span class="n">ocamlc</span> <span class="n">tools</span><span class="o">.</span><span class="n">cma</span> <span class="n">myprog</span><span class="o">.</span><span class="n">ml</span> <span class="o">-</span><span class="n">o</span> <span class="n">myprog</span>

<span class="c">(* @@PLEAC@@_12.8 *)</span>
<span class="c">(* The easiest way to prepare a library for distribution is to build with</span>
<span class="c">   OCamlMakefile and include a META file for use with findlib.</span>

<span class="c">   OCamlMakefile is available here:</span>
<span class="c">   http://www.ocaml.info/home/ocaml_sources.html#OCamlMakefile</span>

<span class="c">   findlib is available here:</span>
<span class="c">   http://projects.camlcity.org/projects/findlib.html *)</span>

<span class="c">(* Put the following in a file called &quot;Makefile&quot; and edit to taste: *)</span>

<span class="nc">OCAMLMAKEFILE</span> <span class="o">=</span> <span class="nc">OCamlMakefile</span>

<span class="nc">RESULT</span> <span class="o">=</span> <span class="n">mylibrary</span>
<span class="nc">SOURCES</span> <span class="o">=</span> <span class="n">mylibrary</span><span class="o">.</span><span class="n">mli</span> <span class="n">mylibrary</span><span class="o">.</span><span class="n">ml</span>
<span class="nc">PACKS</span> <span class="o">=</span> <span class="n">pcre</span>

<span class="n">all</span><span class="o">:</span> <span class="n">native</span><span class="o">-</span><span class="n">code</span><span class="o">-</span><span class="n">library</span> <span class="n">byte</span><span class="o">-</span><span class="n">code</span><span class="o">-</span><span class="n">library</span>
<span class="n">install</span><span class="o">:</span> <span class="n">libinstall</span>
<span class="n">uninstall</span><span class="o">:</span> <span class="n">libuninstall</span>

<span class="k">include</span> <span class="o">$(</span><span class="nc">OCAMLMAKEFILE</span><span class="o">)</span>

<span class="c">(* Put the following in a file called &quot;META&quot; and edit to taste: *)</span>

<span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;mylibrary&quot;</span>
<span class="n">version</span> <span class="o">=</span> <span class="s2">&quot;1.0.0&quot;</span>
<span class="n">description</span> <span class="o">=</span> <span class="s2">&quot;My library&quot;</span>
<span class="n">requires</span> <span class="o">=</span> <span class="s2">&quot;pcre&quot;</span>
<span class="n">archive</span><span class="o">(</span><span class="n">byte</span><span class="o">)</span> <span class="o">=</span> <span class="s2">&quot;mylibrary.cma&quot;</span>
<span class="n">archive</span><span class="o">(</span><span class="n">native</span><span class="o">)</span> <span class="o">=</span> <span class="s2">&quot;mylibrary.cmxa&quot;</span>

<span class="c">(* Now you can build bytecode and native libraries with &quot;make&quot; and</span>
<span class="c">   install them into the standard library location with &quot;make install&quot;.</span>
<span class="c">   If you make a change, you will have to &quot;make uninstall&quot; before you</span>
<span class="c">   can &quot;make install&quot; again. Once a library is installed, it&#39;s simple</span>
<span class="c">   to use: *)</span>

<span class="o">$</span> <span class="n">ledit</span> <span class="n">ocaml</span>
        <span class="nc">Objective</span> <span class="nc">Caml</span> <span class="n">version</span> <span class="mi">3</span><span class="o">.</span><span class="mi">10</span><span class="o">.</span><span class="mi">2</span>

<span class="o">#</span> <span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">-</span> <span class="o">:</span> <span class="kt">unit</span> <span class="o">=</span> <span class="bp">()</span>
<span class="nc">Findlib</span> <span class="n">has</span> <span class="n">been</span> <span class="n">successfully</span> <span class="n">loaded</span><span class="o">.</span> <span class="nc">Additional</span> <span class="n">directives</span><span class="o">:</span>
  <span class="o">#</span><span class="n">require</span> <span class="s2">&quot;package&quot;</span><span class="o">;;</span>      <span class="k">to</span> <span class="n">load</span> <span class="n">a</span> <span class="n">package</span>
  <span class="o">#</span><span class="kt">list</span><span class="o">;;</span>                   <span class="k">to</span> <span class="kt">list</span> <span class="n">the</span> <span class="n">available</span> <span class="n">packages</span>
  <span class="o">#</span><span class="n">camlp4o</span><span class="o">;;</span>                <span class="k">to</span> <span class="n">load</span> <span class="n">camlp4</span> <span class="o">(</span><span class="n">standard</span> <span class="n">syntax</span><span class="o">)</span>
  <span class="o">#</span><span class="n">camlp4r</span><span class="o">;;</span>                <span class="k">to</span> <span class="n">load</span> <span class="n">camlp4</span> <span class="o">(</span><span class="n">revised</span> <span class="n">syntax</span><span class="o">)</span>
  <span class="o">#</span><span class="n">predicates</span> <span class="s2">&quot;p,q,...&quot;</span><span class="o">;;</span>   <span class="k">to</span> <span class="n">set</span> <span class="n">these</span> <span class="n">predicates</span>
  <span class="nn">Topfind</span><span class="p">.</span><span class="n">reset</span><span class="bp">()</span><span class="o">;;</span>         <span class="k">to</span> <span class="n">force</span> <span class="n">that</span> <span class="n">packages</span> <span class="n">will</span> <span class="n">be</span> <span class="n">reloaded</span>
  <span class="o">#</span><span class="n">thread</span><span class="o">;;</span>                 <span class="k">to</span> <span class="n">enable</span> <span class="n">threads</span>

<span class="o">-</span> <span class="o">:</span> <span class="kt">unit</span> <span class="o">=</span> <span class="bp">()</span>
<span class="o">#</span> <span class="o">#</span><span class="n">require</span> <span class="s2">&quot;mylibrary&quot;</span><span class="o">;;</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ocaml</span><span class="o">/</span><span class="mi">3</span><span class="o">.</span><span class="mi">10</span><span class="o">.</span><span class="mi">2</span><span class="o">/</span><span class="n">pcre</span><span class="o">:</span> <span class="n">added</span> <span class="k">to</span> <span class="n">search</span> <span class="n">path</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ocaml</span><span class="o">/</span><span class="mi">3</span><span class="o">.</span><span class="mi">10</span><span class="o">.</span><span class="mi">2</span><span class="o">/</span><span class="n">pcre</span><span class="o">/</span><span class="n">pcre</span><span class="o">.</span><span class="n">cma</span><span class="o">:</span> <span class="n">loaded</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ocaml</span><span class="o">/</span><span class="mi">3</span><span class="o">.</span><span class="mi">10</span><span class="o">.</span><span class="mi">2</span><span class="o">/</span><span class="n">mylibrary</span><span class="o">:</span> <span class="n">added</span> <span class="k">to</span> <span class="n">search</span> <span class="n">path</span>
<span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ocaml</span><span class="o">/</span><span class="mi">3</span><span class="o">.</span><span class="mi">10</span><span class="o">.</span><span class="mi">2</span><span class="o">/</span><span class="n">mylibrary</span><span class="o">/</span><span class="n">mylibrary</span><span class="o">.</span><span class="n">cma</span><span class="o">:</span> <span class="n">loaded</span>

<span class="c">(* To compile against your new library, use the &quot;ocamlfind&quot; tool as a</span>
<span class="c">   front-end to &quot;ocamlc&quot; and &quot;ocamlopt&quot;: *)</span>

<span class="o">$</span> <span class="n">ocamlfind</span> <span class="n">ocamlc</span> <span class="o">-</span><span class="n">package</span> <span class="n">mylibrary</span> <span class="n">myprogram</span><span class="o">.</span><span class="n">ml</span> <span class="o">-</span><span class="n">o</span> <span class="n">myprogram</span>
<span class="o">$</span> <span class="n">ocamlfind</span> <span class="n">ocamlopt</span> <span class="o">-</span><span class="n">package</span> <span class="n">mylibrary</span> <span class="n">myprogram</span><span class="o">.</span><span class="n">ml</span> <span class="o">-</span><span class="n">o</span> <span class="n">myprogram</span>

<span class="c">(* @@PLEAC@@_12.9 *)</span>
<span class="c">(* OCaml supports native compilation. If module load time is an issue,</span>
<span class="c">   it&#39;s hard to find a better solution than &quot;ocamlopt&quot;. If compilation</span>
<span class="c">   is slow as well, try &quot;ocamlopt.opt&quot;, which is the natively-compiled</span>
<span class="c">   native compiler. *)</span>

<span class="c">(* @@PLEAC@@_12.10 *)</span>
<span class="c">(* This recipe is not relevant or applicable to OCaml. *)</span>

<span class="c">(* @@PLEAC@@_12.11 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="c">(* The Unix module returns the time as a float. Using a local module</span>
<span class="c">   definition and an &quot;include&quot;, we can override this function to return</span>
<span class="c">   an int32 instead. (This is a bit silly, but it illustrates the basic</span>
<span class="c">   technique. *)</span>
<span class="k">module</span> <span class="nc">Unix</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">include</span> <span class="nc">Unix</span>
  <span class="k">let</span> <span class="n">time</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Int32</span><span class="p">.</span><span class="n">of_float</span> <span class="o">(</span><span class="n">time</span> <span class="bp">()</span><span class="o">)</span>
<span class="k">end</span>

<span class="c">(* Use the locally modified Unix.time function. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">start</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">time</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%ld</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">Int32</span><span class="p">.</span><span class="n">sub</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">time</span> <span class="bp">()</span><span class="o">)</span> <span class="n">start</span><span class="o">)</span>
  <span class="k">done</span>

<span class="c">(* Operators can also be locally modified. Here, we&#39;ll temporarily</span>
<span class="c">   define &#39;-&#39; as int32 subtraction. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="o">(</span> <span class="o">-</span> <span class="o">)</span> <span class="o">=</span> <span class="nn">Int32</span><span class="p">.</span><span class="n">sub</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">start</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">time</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%ld</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">time</span> <span class="bp">()</span> <span class="o">-</span> <span class="n">start</span><span class="o">)</span>
  <span class="k">done</span>

<span class="c">(* @@PLEAC@@_12.12 *)</span>
<span class="c">(* There are two built-in functions that raise standard exceptions.</span>
<span class="c">   Many standard library functions use these. &quot;invalid_arg&quot; raises</span>
<span class="c">   an Invalid_argument exception, which takes a string parameter: *)</span>
<span class="k">let</span> <span class="n">even_only</span> <span class="n">n</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">n</span> <span class="ow">land</span> <span class="mi">1</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="c">(* one way to test *)</span>
  <span class="k">then</span> <span class="n">invalid_arg</span> <span class="o">(</span><span class="n">string_of_int</span> <span class="n">n</span><span class="o">);</span>
  <span class="c">(* ... *)</span>
  <span class="bp">()</span>

<span class="c">(* &quot;failwith&quot; raises a Failure exception, which also takes a string</span>
<span class="c">   parameter (though it is typically used to identify the name of</span>
<span class="c">   the function as opposed to the argument). *)</span>
<span class="k">let</span> <span class="n">even_only</span> <span class="n">n</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">n</span> <span class="ow">mod</span> <span class="mi">2</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="c">(* here&#39;s another *)</span>
  <span class="k">then</span> <span class="n">failwith</span> <span class="s2">&quot;even_only&quot;</span><span class="o">;</span>
  <span class="c">(* ... *)</span>
  <span class="bp">()</span>

<span class="c">(* In most cases, it is preferable to define your own exceptions. *)</span>
<span class="k">exception</span> <span class="nc">Not_even</span> <span class="k">of</span> <span class="kt">int</span>
<span class="k">let</span> <span class="n">even_only</span> <span class="n">n</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">n</span> <span class="ow">land</span> <span class="mi">1</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="k">raise</span> <span class="o">(</span><span class="nc">Not_even</span> <span class="n">n</span><span class="o">);</span>
  <span class="c">(* ... *)</span>
  <span class="bp">()</span>

<span class="c">(* OCaml does not provide a facility for emitting warnings. You can</span>
<span class="c">   write to stderr, which may be an acceptable substitute. *)</span>
<span class="k">let</span> <span class="n">even_only</span> <span class="n">n</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">n</span> <span class="o">=</span>
    <span class="k">if</span> <span class="n">n</span> <span class="ow">land</span> <span class="mi">1</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="c">(* test whether odd number *)</span>
    <span class="k">then</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%d is not even, continuing</span><span class="se">\n</span><span class="s2">%!&quot;</span> <span class="n">n</span><span class="o">;</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span>
    <span class="k">else</span> <span class="n">n</span> <span class="k">in</span>
  <span class="c">(* ... *)</span>
  <span class="bp">()</span>

<span class="c">(* @@PLEAC@@_12.13 *)</span>
<span class="c">(* Generally, it is best to use tables of functions, possibly with</span>
<span class="c">   Dynlink, to delay the choice of module and function until runtime.</span>
<span class="c">   It is however possible--though inelegant--to (ab)use the toplevel</span>
<span class="c">   for this purpose. *)</span>

<span class="k">open</span> <span class="nc">Printf</span>

<span class="c">(* Toplevel evaluator. Not type-safe. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Toploop</span><span class="p">.</span><span class="n">initialize_toplevel_env</span> <span class="bp">()</span>
<span class="k">let</span> <span class="n">eval</span> <span class="n">text</span> <span class="o">=</span> <span class="k">let</span> <span class="n">lexbuf</span> <span class="o">=</span> <span class="o">(</span><span class="nn">Lexing</span><span class="p">.</span><span class="n">from_string</span> <span class="n">text</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">phrase</span> <span class="o">=</span> <span class="o">!</span><span class="nn">Toploop</span><span class="p">.</span><span class="n">parse_toplevel_phrase</span> <span class="n">lexbuf</span> <span class="k">in</span>
  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Toploop</span><span class="p">.</span><span class="n">execute_phrase</span> <span class="bp">false</span> <span class="nn">Format</span><span class="p">.</span><span class="n">std_formatter</span> <span class="n">phrase</span><span class="o">)</span>
<span class="k">let</span> <span class="n">get</span> <span class="n">name</span> <span class="o">=</span> <span class="nn">Obj</span><span class="p">.</span><span class="n">obj</span> <span class="o">(</span><span class="nn">Toploop</span><span class="p">.</span><span class="n">getvalue</span> <span class="n">name</span><span class="o">)</span>
<span class="k">let</span> <span class="n">set</span> <span class="n">name</span> <span class="k">value</span> <span class="o">=</span> <span class="nn">Toploop</span><span class="p">.</span><span class="n">setvalue</span> <span class="n">name</span> <span class="o">(</span><span class="nn">Obj</span><span class="p">.</span><span class="n">repr</span> <span class="k">value</span><span class="o">)</span>

<span class="c">(* Some module and value names, presumably not known until runtime. *)</span>
<span class="k">let</span> <span class="n">modname</span> <span class="o">=</span> <span class="s2">&quot;Sys&quot;</span>
<span class="k">let</span> <span class="n">varname</span> <span class="o">=</span> <span class="s2">&quot;ocaml_version&quot;</span>
<span class="k">let</span> <span class="n">aryname</span> <span class="o">=</span> <span class="s2">&quot;argv&quot;</span>
<span class="k">let</span> <span class="n">funcname</span> <span class="o">=</span> <span class="s2">&quot;getenv&quot;</span>

<span class="c">(* Use the toplevel to evaluate module lookups dynamically. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">eval</span> <span class="o">(</span><span class="n">sprintf</span> <span class="s2">&quot;let (value : string) = %s.%s;;&quot;</span> <span class="n">modname</span> <span class="n">varname</span><span class="o">);</span>
  <span class="n">print_endline</span> <span class="o">(</span><span class="n">get</span> <span class="s2">&quot;value&quot;</span><span class="o">);</span>
  <span class="n">eval</span> <span class="o">(</span><span class="n">sprintf</span> <span class="s2">&quot;let (values : string array) = %s.%s;;&quot;</span> <span class="n">modname</span> <span class="n">aryname</span><span class="o">);</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">iter</span> <span class="n">print_endline</span> <span class="o">(</span><span class="n">get</span> <span class="s2">&quot;values&quot;</span><span class="o">);</span>
  <span class="n">eval</span> <span class="o">(</span><span class="n">sprintf</span> <span class="s2">&quot;let (func : string -&gt; string) = %s.%s;;&quot;</span> <span class="n">modname</span> <span class="n">funcname</span><span class="o">);</span>
  <span class="n">print_endline</span> <span class="o">((</span><span class="n">get</span> <span class="s2">&quot;func&quot;</span><span class="o">)</span> <span class="s2">&quot;HOME&quot;</span><span class="o">);</span>

<span class="c">(* @@PLEAC@@_12.14 *)</span>
<span class="c">(* There are several tools for translating C header files to OCaml</span>
<span class="c">   bindings, many of which can be found at The Caml Hump:</span>

<span class="c">   http://caml.inria.fr/cgi-bin/hump.en.cgi?sort=0&amp;browse=42</span>

<span class="c">   Of the available tools, &quot;ocamlffi&quot; (also known as simply &quot;FFI&quot;) seems</span>
<span class="c">   to work best at accomplishing the task of parsing header files, but</span>
<span class="c">   it has not been maintained in many years and cannot handle the deep</span>
<span class="c">   use of preprocessor macros in today&#39;s Unix headers. As a result, it is</span>
<span class="c">   often necessary to create a header file by hand, and so long as this</span>
<span class="c">   is required, better results can be achieved with Xavier Leroy&#39;s</span>
<span class="c">   CamlIDL tool. CamlIDL can be found here:</span>

<span class="c">   http://caml.inria.fr/pub/old_caml_site/camlidl/</span>

<span class="c">   The following recipes will use CamlIDL. First, we&#39;ll wrap the Unix</span>
<span class="c">   &quot;gettimeofday&quot; system call by writing the following to a file named</span>
<span class="c">   &quot;time.idl&quot;: *)</span>

<span class="n">quote</span><span class="o">(</span><span class="nc">C</span><span class="o">,</span><span class="s2">&quot;#include &lt;sys/time.h&gt;&quot;</span><span class="o">);</span>

<span class="k">struct</span> <span class="n">timeval</span> <span class="o">{</span>
    <span class="o">[</span><span class="n">int32</span><span class="o">]</span> <span class="kt">int</span> <span class="n">tv_sec</span><span class="o">;</span>
    <span class="o">[</span><span class="n">int32</span><span class="o">]</span> <span class="kt">int</span> <span class="n">tv_usec</span><span class="o">;</span>
<span class="o">};</span>

<span class="k">struct</span> <span class="n">timezone</span> <span class="o">{</span>
    <span class="kt">int</span> <span class="n">tz_minuteswest</span><span class="o">;</span>
    <span class="kt">int</span> <span class="n">tz_dsttime</span><span class="o">;</span>
<span class="o">};</span>

<span class="kt">int</span> <span class="n">gettimeofday</span><span class="o">([</span><span class="n">out</span><span class="o">]</span> <span class="k">struct</span> <span class="n">timeval</span> <span class="o">*</span><span class="n">tv</span><span class="o">,</span> <span class="o">[</span><span class="k">in</span><span class="o">]</span> <span class="k">struct</span> <span class="n">timezone</span> <span class="o">*</span><span class="n">tz</span><span class="o">);</span>

<span class="c">(* We can now build three files, &quot;time.ml&quot;, &quot;time.mli&quot;, and</span>
<span class="c">   &quot;time_stubs.c&quot;, corresponding to the OCaml implementation, OCaml</span>
<span class="c">   interface, and OCaml-to-C stubs, by running the following command: *)</span>

<span class="o">$</span> <span class="n">camlidl</span> <span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="k">include</span> <span class="n">time</span><span class="o">.</span><span class="n">idl</span>

<span class="c">(* CamlIDL automatically translates the two structs defined in the IDL</span>
<span class="c">   into OCaml record types and builds an external function reference</span>
<span class="c">   for &quot;gettimeofday&quot;, resulting in the following generated OCaml</span>
<span class="c">   implementation in &quot;time.ml&quot;: *)</span>

<span class="c">(* File generated from time.idl *)</span>

<span class="k">type</span> <span class="n">timeval</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">tv_sec</span><span class="o">:</span> <span class="n">int32</span><span class="o">;</span>
  <span class="n">tv_usec</span><span class="o">:</span> <span class="n">int32</span><span class="o">;</span>
<span class="o">}</span>
<span class="ow">and</span> <span class="n">timezone</span> <span class="o">=</span> <span class="o">{</span>
  <span class="n">tz_minuteswest</span><span class="o">:</span> <span class="kt">int</span><span class="o">;</span>
  <span class="n">tz_dsttime</span><span class="o">:</span> <span class="kt">int</span><span class="o">;</span>
<span class="o">}</span>

<span class="k">external</span> <span class="n">gettimeofday</span> <span class="o">:</span> <span class="n">timezone</span> <span class="n">option</span> <span class="o">-&gt;</span> <span class="kt">int</span> <span class="o">*</span> <span class="n">timeval</span>
	<span class="o">=</span> <span class="s2">&quot;camlidl_time_gettimeofday&quot;</span>

<span class="c">(* Now, we can use &quot;ocamlc -c&quot; as a front-end to the C compiler to build</span>
<span class="c">   the stubs, producing time_stubs.o. *)</span>

<span class="o">$</span> <span class="n">ocamlc</span> <span class="o">-</span><span class="n">c</span> <span class="n">time_stubs</span><span class="o">.</span><span class="n">c</span>

<span class="c">(* The OCaml source can be built and packed into a library along with</span>
<span class="c">   the compiled stubs using &quot;ocamlc -a&quot;: *)</span>

<span class="o">$</span> <span class="n">ocamlc</span> <span class="o">-</span><span class="n">a</span> <span class="o">-</span><span class="n">custom</span> <span class="o">-</span><span class="n">o</span> <span class="n">time</span><span class="o">.</span><span class="n">cma</span> <span class="n">time</span><span class="o">.</span><span class="n">mli</span> <span class="n">time</span><span class="o">.</span><span class="n">ml</span> <span class="n">time_stubs</span><span class="o">.</span><span class="n">o</span> <span class="err">\</span>
		<span class="o">-</span><span class="n">cclib</span> <span class="o">-</span><span class="n">lcamlidl</span>

<span class="c">(* Finally, we can write a simple test program to use our newly-exposed</span>
<span class="c">   &quot;gettimeofday&quot; function. *)</span>

<span class="c">(* test.ml *)</span>
<span class="k">let</span> <span class="n">time</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">res</span><span class="o">,</span> <span class="o">{</span><span class="nn">Time</span><span class="p">.</span><span class="n">tv_sec</span><span class="o">=</span><span class="n">seconds</span><span class="o">;</span> <span class="n">tv_usec</span><span class="o">=</span><span class="n">microseconds</span><span class="o">}</span> <span class="o">=</span>
    <span class="nn">Time</span><span class="p">.</span><span class="n">gettimeofday</span> <span class="nc">None</span> <span class="k">in</span>
  <span class="nn">Int32</span><span class="p">.</span><span class="n">to_float</span> <span class="n">seconds</span> <span class="o">+.</span> <span class="o">(</span><span class="nn">Int32</span><span class="p">.</span><span class="n">to_float</span> <span class="n">microseconds</span> <span class="o">/.</span> <span class="mi">1_000_000</span><span class="o">.)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%f</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">time</span> <span class="bp">()</span><span class="o">)</span>

<span class="c">(* Compiling this test program is straightforward. *)</span>

<span class="o">$</span> <span class="n">ocamlc</span> <span class="o">-</span><span class="n">o</span> <span class="n">test</span> <span class="n">time</span><span class="o">.</span><span class="n">cma</span> <span class="n">test</span><span class="o">.</span><span class="n">ml</span>

<span class="c">(* Running it produces the current time with millisecond precision. *)</span>

<span class="o">$</span> <span class="o">./</span><span class="n">test</span>
<span class="mi">1217173408</span><span class="o">.</span><span class="mi">931277</span>

<span class="c">(*---------------------------*)</span>

<span class="c">(* The next two recipes will wrap the Unix &quot;ioctl&quot; function, allowing</span>
<span class="c">   us to make a few low-level I/O system calls. To make things easier,</span>
<span class="c">   we&#39;ll use the following Makefile (make sure you use tabs, not spaces,</span>
<span class="c">   if you cut and paste this code): *)</span>

<span class="n">all</span><span class="o">:</span> <span class="n">jam</span> <span class="n">winsz</span>

<span class="n">jam</span><span class="o">:</span> <span class="n">ioctl</span><span class="o">.</span><span class="n">cma</span> <span class="n">jam</span><span class="o">.</span><span class="n">ml</span>
	<span class="n">ocamlc</span> <span class="o">-</span><span class="n">o</span> <span class="n">jam</span> <span class="n">ioctl</span><span class="o">.</span><span class="n">cma</span> <span class="n">jam</span><span class="o">.</span><span class="n">ml</span>

<span class="n">winsz</span><span class="o">:</span> <span class="n">ioctl</span><span class="o">.</span><span class="n">cma</span> <span class="n">winsz</span><span class="o">.</span><span class="n">ml</span>
	<span class="n">ocamlc</span> <span class="o">-</span><span class="n">o</span> <span class="n">winsz</span> <span class="n">ioctl</span><span class="o">.</span><span class="n">cma</span> <span class="n">winsz</span><span class="o">.</span><span class="n">ml</span>

<span class="n">ioctl</span><span class="o">.</span><span class="n">cma</span><span class="o">:</span> <span class="n">ioctl</span><span class="o">.</span><span class="n">mli</span> <span class="n">ioctl</span><span class="o">.</span><span class="n">ml</span> <span class="n">ioctl_stubs</span><span class="o">.</span><span class="n">o</span>
	<span class="n">ocamlc</span> <span class="o">-</span><span class="n">a</span> <span class="o">-</span><span class="n">custom</span> <span class="o">-</span><span class="n">o</span> <span class="n">ioctl</span><span class="o">.</span><span class="n">cma</span> <span class="n">ioctl</span><span class="o">.</span><span class="n">mli</span> <span class="n">ioctl</span><span class="o">.</span><span class="n">ml</span> <span class="n">ioctl_stubs</span><span class="o">.</span><span class="n">o</span> <span class="err">\</span>
		<span class="o">-</span><span class="n">cclib</span> <span class="o">-</span><span class="n">lcamlidl</span>

<span class="n">ioctl_stubs</span><span class="o">.</span><span class="n">o</span><span class="o">:</span> <span class="n">ioctl_stubs</span><span class="o">.</span><span class="n">c</span>
	<span class="n">ocamlc</span> <span class="o">-</span><span class="n">c</span> <span class="n">ioctl_stubs</span><span class="o">.</span><span class="n">c</span>

<span class="n">ioctl</span><span class="o">.</span><span class="n">mli</span> <span class="n">ioctl</span><span class="o">.</span><span class="n">ml</span> <span class="n">ioctl_stubs</span><span class="o">.</span><span class="n">c</span><span class="o">:</span> <span class="n">ioctl</span><span class="o">.</span><span class="n">idl</span>
	<span class="n">camlidl</span> <span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="k">include</span> <span class="n">ioctl</span><span class="o">.</span><span class="n">idl</span>

<span class="n">clean</span><span class="o">:</span>
	<span class="n">rm</span> <span class="o">-</span><span class="n">f</span> <span class="o">*.</span><span class="n">cma</span> <span class="o">*.</span><span class="n">cmi</span> <span class="o">*.</span><span class="n">cmo</span> <span class="o">*.</span><span class="n">c</span> <span class="o">*.</span><span class="n">o</span> <span class="n">ioctl</span><span class="o">.</span><span class="n">ml</span> <span class="n">ioctl</span><span class="o">.</span><span class="n">mli</span> <span class="n">jam</span> <span class="n">winsz</span>

<span class="c">(*---------------------------*)</span>

<span class="c">(* ioctl.idl: *)</span>

<span class="n">quote</span><span class="o">(</span><span class="nc">C</span><span class="o">,</span><span class="s2">&quot;#include &lt;sys/ioctl.h&gt;&quot;</span><span class="o">);</span>

<span class="n">enum</span> <span class="n">ioctl</span> <span class="o">{</span>
    <span class="nc">TIOCSTI</span><span class="o">,</span>
    <span class="nc">TIOCGWINSZ</span><span class="o">,</span>
<span class="o">};</span>

<span class="kt">int</span> <span class="n">ioctl</span><span class="o">([</span><span class="k">in</span><span class="o">]</span> <span class="kt">int</span> <span class="n">fd</span><span class="o">,</span>
          <span class="o">[</span><span class="k">in</span><span class="o">]</span> <span class="n">enum</span> <span class="n">ioctl</span> <span class="n">request</span><span class="o">,</span>
          <span class="o">[</span><span class="k">in</span><span class="o">,</span> <span class="n">out</span><span class="o">,</span> <span class="kt">string</span><span class="o">]</span> <span class="kt">char</span> <span class="o">*</span><span class="n">argp</span><span class="o">);</span>

<span class="c">(*---------------------------*)</span>

<span class="c">(* jam - stuff characters down STDIN&#39;s throat *)</span>

<span class="c">(* Simulate input on a given terminal. *)</span>
<span class="k">let</span> <span class="n">jam</span> <span class="o">?(</span><span class="n">tty</span><span class="o">=</span><span class="mi">0</span><span class="o">)</span> <span class="n">s</span> <span class="o">=</span>
  <span class="nn">String</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">c</span> <span class="o">-&gt;</span> <span class="n">ignore</span> <span class="o">(</span><span class="nn">Ioctl</span><span class="p">.</span><span class="n">ioctl</span> <span class="n">tty</span> <span class="nn">Ioctl</span><span class="p">.</span><span class="nc">TIOCSTI</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="mi">1</span> <span class="n">c</span><span class="o">)))</span> <span class="n">s</span>

<span class="c">(* Stuff command-line arguments into STDIN. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">jam</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot; &quot;</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">))))</span>

<span class="c">(*---------------------------*)</span>

<span class="c">(* winsz - find x and y for chars and pixels *)</span>

<span class="c">(* Decode a little-endian short integer from a string and offset. *)</span>
<span class="k">let</span> <span class="n">decode_short</span> <span class="n">s</span> <span class="n">i</span> <span class="o">=</span>
  <span class="nn">Char</span><span class="p">.</span><span class="n">code</span> <span class="n">s</span><span class="o">.[</span><span class="n">i</span><span class="o">]</span> <span class="ow">lor</span> <span class="nn">Char</span><span class="p">.</span><span class="n">code</span> <span class="n">s</span><span class="o">.[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">]</span> <span class="ow">lsl</span> <span class="mi">8</span>

<span class="c">(* Read and display the window size. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">winsize</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="mi">8</span> <span class="sc">&#39;\000&#39;</span> <span class="k">in</span>
  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Ioctl</span><span class="p">.</span><span class="n">ioctl</span> <span class="mi">0</span> <span class="nn">Ioctl</span><span class="p">.</span><span class="nc">TIOCGWINSZ</span> <span class="n">winsize</span><span class="o">);</span>
  <span class="k">let</span> <span class="n">row</span> <span class="o">=</span> <span class="n">decode_short</span> <span class="n">winsize</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">col</span> <span class="o">=</span> <span class="n">decode_short</span> <span class="n">winsize</span> <span class="mi">2</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">xpixel</span> <span class="o">=</span> <span class="n">decode_short</span> <span class="n">winsize</span> <span class="mi">4</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">ypixel</span> <span class="o">=</span> <span class="n">decode_short</span> <span class="n">winsize</span> <span class="mi">6</span> <span class="k">in</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;(row,col) = (%d,%d)&quot;</span> <span class="n">row</span> <span class="n">col</span><span class="o">;</span>
  <span class="k">if</span> <span class="n">xpixel</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ypixel</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span>
  <span class="k">then</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;  (xpixel,ypixel) = (%d,%d)&quot;</span> <span class="n">xpixel</span> <span class="n">ypixel</span><span class="o">;</span>
  <span class="n">print_newline</span> <span class="bp">()</span>

<span class="c">(* @@PLEAC@@_12.15 *)</span>
<span class="c">(* Building libraries with C code is much easier with the aid of</span>
<span class="c">   OCamlMakefile. The following Makefile is all it takes to build</span>
<span class="c">   the &quot;time&quot; library from the previous recipe: *)</span>

<span class="nc">OCAMLMAKEFILE</span> <span class="o">=</span> <span class="nc">OCamlMakefile</span>

<span class="nc">RESULT</span> <span class="o">=</span> <span class="n">time</span>
<span class="nc">SOURCES</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">idl</span>
<span class="nc">NOIDLHEADER</span> <span class="o">=</span> <span class="n">yes</span>

<span class="n">all</span><span class="o">:</span> <span class="n">byte</span><span class="o">-</span><span class="n">code</span><span class="o">-</span><span class="n">library</span> <span class="n">native</span><span class="o">-</span><span class="n">code</span><span class="o">-</span><span class="n">library</span>

<span class="k">include</span> <span class="o">$(</span><span class="nc">OCAMLMAKEFILE</span><span class="o">)</span>

<span class="c">(* Now, a simple &quot;make&quot; will perform the code generation with camlidl</span>
<span class="c">   and produce static and dynamic libraries for bytecode and native</span>
<span class="c">   compilation. Furthermore, &quot;make top&quot; will build a custom toplevel</span>
<span class="c">   interpreter called &quot;time.top&quot; with the Time module built in: *)</span>

<span class="o">$</span> <span class="o">./</span><span class="n">time</span><span class="o">.</span><span class="n">top</span>
        <span class="nc">Objective</span> <span class="nc">Caml</span> <span class="n">version</span> <span class="mi">3</span><span class="o">.</span><span class="mi">10</span><span class="o">.</span><span class="mi">2</span>

<span class="o">#</span> <span class="nn">Time</span><span class="p">.</span><span class="n">gettimeofday</span> <span class="nc">None</span><span class="o">;;</span>
<span class="o">-</span> <span class="o">:</span> <span class="kt">int</span> <span class="o">*</span> <span class="nn">Time</span><span class="p">.</span><span class="n">timeval</span> <span class="o">=</span>
<span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="o">{</span><span class="nn">Time</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">=</span> <span class="mi">1217483550</span><span class="n">l</span><span class="o">;</span> <span class="nn">Time</span><span class="p">.</span><span class="n">tv_usec</span> <span class="o">=</span> <span class="mi">645204</span><span class="n">l</span><span class="o">})</span>

<span class="c">(* With the addition of a &quot;META&quot; file combined with the &quot;libinstall&quot;</span>
<span class="c">   and &quot;libuninstall&quot; targets, this library can be installed to the</span>
<span class="c">   standard location for use in other projects. See recipe 12.8,</span>
<span class="c">   &quot;Preparing a Module for Distribution&quot;, for an example. *)</span>

<span class="c">(* @@PLEAC@@_12.16 *)</span>
<span class="c">(** Documentation for OCaml programs can be generated with the ocamldoc</span>
<span class="c">    tool, included in the standard distribution. Special comments like</span>
<span class="c">    this one begin with two asterisks which triggers ocamldoc to</span>
<span class="c">    include them in the documentation. The first special comment in a</span>
<span class="c">    module becomes the main description for that module. *)</span>

<span class="c">(** Comments can be placed before variables... *)</span>
<span class="k">val</span> <span class="n">version</span> <span class="o">:</span> <span class="kt">string</span>

<span class="c">(** ...functions... *)</span>
<span class="k">val</span> <span class="n">cons</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="kt">list</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span> <span class="kt">list</span>

<span class="c">(** ...types... *)</span>
<span class="k">type</span> <span class="n">choice</span> <span class="o">=</span> <span class="nc">Yes</span> <span class="o">|</span> <span class="nc">No</span> <span class="o">|</span> <span class="nc">Maybe</span> <span class="k">of</span> <span class="kt">string</span>

<span class="c">(* ... and other constructs like classes, class types, modules, and</span>
<span class="c">   module types. Simple comments like this one are ignored. *)</span>

<span class="c">(** {2 Level-two headings look like this} *)</span>

<span class="c">(** Text in [square brackets] will be formatted using a monospace font,</span>
<span class="c">    ideal for identifiers and other bits of code. Text written in curly</span>
<span class="c">    braces with a bang in front {!Like.this} will be hyperlinked to the</span>
<span class="c">    corresponding definition. *)</span>

<span class="c">(* To generate HTML documentation, use a command like the following: *)</span>

<span class="o">$</span> <span class="n">ocamldoc</span> <span class="o">-</span><span class="n">html</span> <span class="o">-</span><span class="n">d</span> <span class="n">destdir</span> <span class="nn">Module1</span><span class="p">.</span><span class="n">mli</span> <span class="nn">Module1</span><span class="p">.</span><span class="n">ml</span> <span class="o">...</span>

<span class="c">(* To generate Latex documentation, use a command like the following: *)</span>

<span class="o">$</span> <span class="n">ocamldoc</span> <span class="o">-</span><span class="n">latex</span> <span class="o">-</span><span class="n">d</span> <span class="n">destdir</span> <span class="nn">Module1</span><span class="p">.</span><span class="n">mli</span> <span class="nn">Module1</span><span class="p">.</span><span class="n">ml</span> <span class="o">...</span>

<span class="c">(* If you use OCamlMakefile, you can type &quot;make doc&quot; to build HTML and</span>
<span class="c">   PDF documentation for your entire project. You may want to customize</span>
<span class="c">   the OCAMLDOC and DOC_FILES variables to suit your needs. *)</span>

<span class="c">(* @@PLEAC@@_12.17 *)</span>
<span class="c">(* Installing a module from The Caml Hump differs from project to</span>
<span class="c">   project, since it is not as standardized as CPAN. However, in most</span>
<span class="c">   cases, &quot;make&quot; and &quot;make install&quot; do what you expect. Here&#39;s how to</span>
<span class="c">   install easy-format, which can be found on the Hump at the following</span>
<span class="c">   URL: http://caml.inria.fr/cgi-bin/hump.en.cgi?contrib=651 *)</span>

<span class="o">$</span> <span class="n">tar</span> <span class="n">xzf</span> <span class="n">easy</span><span class="o">-</span><span class="n">format</span><span class="o">.</span><span class="n">tar</span><span class="o">.</span><span class="n">gz</span>
<span class="o">$</span> <span class="n">cd</span> <span class="n">easy</span><span class="o">-</span><span class="n">format</span>
<span class="o">$</span> <span class="n">make</span>
<span class="n">ocamlc</span> <span class="o">-</span><span class="n">c</span> <span class="n">easy_format</span><span class="o">.</span><span class="n">mli</span>
<span class="n">ocamlc</span> <span class="o">-</span><span class="n">c</span> <span class="o">-</span><span class="n">dtypes</span> <span class="n">easy_format</span><span class="o">.</span><span class="n">ml</span>
<span class="n">touch</span> <span class="n">bytecode</span>
<span class="n">ocamlc</span> <span class="o">-</span><span class="n">c</span> <span class="n">easy_format</span><span class="o">.</span><span class="n">mli</span>
<span class="n">ocamlopt</span> <span class="o">-</span><span class="n">c</span> <span class="o">-</span><span class="n">dtypes</span> <span class="n">easy_format</span><span class="o">.</span><span class="n">ml</span>
<span class="n">touch</span> <span class="n">nativecode</span>

<span class="o">$</span> <span class="n">sudo</span> <span class="n">make</span> <span class="n">install</span>
<span class="o">[</span><span class="n">sudo</span><span class="o">]</span> <span class="n">password</span> <span class="k">for</span> <span class="n">root</span><span class="o">:</span> <span class="o">........</span>
<span class="n">echo</span> <span class="s2">&quot;version = </span><span class="se">\&quot;</span><span class="s2">1.0.0</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">&gt;</span> <span class="nc">META</span><span class="o">;</span> <span class="n">cat</span> <span class="nn">META</span><span class="p">.</span><span class="n">tpl</span> <span class="o">&gt;&gt;</span> <span class="nc">META</span>
<span class="nc">INSTALL_FILES</span><span class="o">=</span><span class="s2">&quot;META easy_format.cmi easy_format.mli&quot;</span><span class="o">;</span> <span class="err">\</span>
                <span class="k">if</span> <span class="n">test</span> <span class="o">-</span><span class="n">f</span> <span class="n">bytecode</span><span class="o">;</span> <span class="k">then</span> <span class="err">\</span>
                  <span class="nc">INSTALL_FILES</span><span class="o">=</span><span class="s2">&quot;$INSTALL_FILES easy_format.cmo &quot;</span><span class="o">;</span> <span class="err">\</span>
                <span class="n">fi</span><span class="o">;</span> <span class="err">\</span>
                <span class="k">if</span> <span class="n">test</span> <span class="o">-</span><span class="n">f</span> <span class="n">nativecode</span><span class="o">;</span> <span class="k">then</span> <span class="err">\</span>
                  <span class="nc">INSTALL_FILES</span><span class="o">=</span><span class="s2">&quot;$INSTALL_FILES easy_format.cmx easy_format.o&quot;</span><span class="o">;</span> <span class="err">\</span>
                <span class="n">fi</span><span class="o">;</span> <span class="err">\</span>
                <span class="n">ocamlfind</span> <span class="n">install</span> <span class="n">easy</span><span class="o">-</span><span class="n">format</span> <span class="o">$</span><span class="nc">INSTALL_FILES</span>
<span class="nc">Installed</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ocaml</span><span class="o">/</span><span class="mi">3</span><span class="o">.</span><span class="mi">10</span><span class="o">.</span><span class="mi">2</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">format</span><span class="o">/</span><span class="n">easy_format</span><span class="o">.</span><span class="n">o</span>
<span class="nc">Installed</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ocaml</span><span class="o">/</span><span class="mi">3</span><span class="o">.</span><span class="mi">10</span><span class="o">.</span><span class="mi">2</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">format</span><span class="o">/</span><span class="n">easy_format</span><span class="o">.</span><span class="n">cmx</span>
<span class="nc">Installed</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ocaml</span><span class="o">/</span><span class="mi">3</span><span class="o">.</span><span class="mi">10</span><span class="o">.</span><span class="mi">2</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">format</span><span class="o">/</span><span class="n">easy_format</span><span class="o">.</span><span class="n">cmo</span>
<span class="nc">Installed</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ocaml</span><span class="o">/</span><span class="mi">3</span><span class="o">.</span><span class="mi">10</span><span class="o">.</span><span class="mi">2</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">format</span><span class="o">/</span><span class="n">easy_format</span><span class="o">.</span><span class="n">mli</span>
<span class="nc">Installed</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ocaml</span><span class="o">/</span><span class="mi">3</span><span class="o">.</span><span class="mi">10</span><span class="o">.</span><span class="mi">2</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">format</span><span class="o">/</span><span class="n">easy_format</span><span class="o">.</span><span class="n">cmi</span>
<span class="nc">Installed</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">ocaml</span><span class="o">/</span><span class="mi">3</span><span class="o">.</span><span class="mi">10</span><span class="o">.</span><span class="mi">2</span><span class="o">/</span><span class="n">easy</span><span class="o">-</span><span class="n">format</span><span class="o">/</span><span class="nc">META</span>

<span class="c">(* @@PLEAC@@_12.18 *)</span>
<span class="c">(* Some.ml *)</span>
<span class="k">module</span> <span class="nc">Module</span> <span class="o">=</span>
<span class="k">struct</span>
  <span class="c">(* set the version for version checking *)</span>
  <span class="k">let</span> <span class="n">version</span> <span class="o">=</span> <span class="s2">&quot;0.01&quot;</span>

  <span class="c">(* initialize module globals (accessible as Some.Module.var1 *)</span>
  <span class="k">let</span> <span class="n">var1</span> <span class="o">=</span> <span class="n">ref</span> <span class="s2">&quot;&quot;</span>
  <span class="k">let</span> <span class="n">hashit</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span>

  <span class="c">(* file-private lexicals go here *)</span>
  <span class="k">let</span> <span class="n">priv_var</span> <span class="o">=</span> <span class="n">ref</span> <span class="s2">&quot;&quot;</span>
  <span class="k">let</span> <span class="n">secret_hash</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span>

  <span class="c">(* here&#39;s a file-private function *)</span>
  <span class="k">let</span> <span class="n">priv_func</span> <span class="bp">()</span> <span class="o">=</span>
    <span class="c">(* stuff goes here. *)</span>
    <span class="bp">()</span>

  <span class="c">(* make all your functions, whether exported or not *)</span>
  <span class="k">let</span> <span class="n">func1</span> <span class="bp">()</span> <span class="o">=</span> <span class="c">(* ... *)</span> <span class="bp">()</span>
  <span class="k">let</span> <span class="n">func2</span> <span class="bp">()</span> <span class="o">=</span> <span class="c">(* ... *)</span> <span class="bp">()</span>
  <span class="k">let</span> <span class="n">func3</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="c">(* ... *)</span> <span class="bp">()</span>
  <span class="k">let</span> <span class="n">func4</span> <span class="n">h</span> <span class="o">=</span> <span class="c">(* ... *)</span> <span class="bp">()</span>

  <span class="c">(* module clean-up code here *)</span>
  <span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
    <span class="n">at_exit</span>
      <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span>
         <span class="c">(* ... *)</span>
         <span class="bp">()</span><span class="o">)</span>
<span class="k">end</span>

<span class="c">(* Some.mli *)</span>
<span class="k">module</span> <span class="nc">Module</span> <span class="o">:</span>
<span class="k">sig</span>
  <span class="k">val</span> <span class="n">version</span> <span class="o">:</span> <span class="kt">string</span>
  <span class="k">val</span> <span class="n">var1</span> <span class="o">:</span> <span class="kt">string</span> <span class="n">ref</span>
  <span class="k">val</span> <span class="n">hashit</span> <span class="o">:</span> <span class="o">(</span><span class="kt">string</span><span class="o">,</span> <span class="kt">string</span><span class="o">)</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">t</span>
  <span class="c">(* priv_var, secret_hash, and priv_func are omitted,</span>
<span class="c">     making them private and inaccessible... *)</span>
  <span class="k">val</span> <span class="n">func1</span> <span class="o">:</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">unit</span>
  <span class="k">val</span> <span class="n">func2</span> <span class="o">:</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">unit</span>
  <span class="k">val</span> <span class="n">func3</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">b</span> <span class="o">-&gt;</span> <span class="kt">unit</span>
  <span class="k">val</span> <span class="n">func4</span> <span class="o">:</span> <span class="o">(</span><span class="kt">string</span><span class="o">,</span> <span class="kt">string</span><span class="o">)</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">t</span> <span class="o">-&gt;</span> <span class="kt">unit</span>
<span class="k">end</span>

<span class="c">(* @@PLEAC@@_12.19 *)</span>
<span class="c">(* Use &quot;findlib&quot;. You can use the &quot;ocamlfind&quot; program to get a list of</span>
<span class="c">   installed libraries from the command line: *)</span>

<span class="o">$</span> <span class="n">ocamlfind</span> <span class="kt">list</span>
<span class="n">benchmark</span>           <span class="o">(</span><span class="n">version</span><span class="o">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">6</span><span class="o">)</span>
<span class="n">bigarray</span>            <span class="o">(</span><span class="n">version</span><span class="o">:</span> <span class="o">[</span><span class="n">distributed</span> <span class="k">with</span> <span class="nc">Ocaml</span><span class="o">])</span>
<span class="n">cairo</span>               <span class="o">(</span><span class="n">version</span><span class="o">:</span> <span class="n">n</span><span class="o">/</span><span class="n">a</span><span class="o">)</span>
<span class="n">cairo</span><span class="o">.</span><span class="n">lablgtk2</span>      <span class="o">(</span><span class="n">version</span><span class="o">:</span> <span class="n">n</span><span class="o">/</span><span class="n">a</span><span class="o">)</span>
<span class="n">calendar</span>            <span class="o">(</span><span class="n">version</span><span class="o">:</span> <span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">2</span><span class="o">)</span>
<span class="n">camlimages</span>          <span class="o">(</span><span class="n">version</span><span class="o">:</span> <span class="mi">2</span><span class="o">.</span><span class="mi">2</span><span class="o">.</span><span class="mi">0</span><span class="o">)</span>
<span class="n">camlimages</span><span class="o">.</span><span class="n">graphics</span> <span class="o">(</span><span class="n">version</span><span class="o">:</span> <span class="n">n</span><span class="o">/</span><span class="n">a</span><span class="o">)</span>
<span class="n">camlimages</span><span class="o">.</span><span class="n">lablgtk2</span> <span class="o">(</span><span class="n">version</span><span class="o">:</span> <span class="n">n</span><span class="o">/</span><span class="n">a</span><span class="o">)</span>
<span class="n">camlp4</span>              <span class="o">(</span><span class="n">version</span><span class="o">:</span> <span class="o">[</span><span class="n">distributed</span> <span class="k">with</span> <span class="nc">Ocaml</span><span class="o">])</span>
<span class="n">camlp4</span><span class="o">.</span><span class="n">exceptiontracer</span> <span class="o">(</span><span class="n">version</span><span class="o">:</span> <span class="o">[</span><span class="n">distributed</span> <span class="k">with</span> <span class="nc">Ocaml</span><span class="o">])</span>
<span class="n">camlp4</span><span class="o">.</span><span class="n">extend</span>       <span class="o">(</span><span class="n">version</span><span class="o">:</span> <span class="o">[</span><span class="n">distributed</span> <span class="k">with</span> <span class="nc">Ocaml</span><span class="o">])</span>
<span class="o">...</span>

<span class="c">(* You can also use the &quot;#list&quot; directive from the interpreter: *)</span>

<span class="o">$</span> <span class="n">ledit</span> <span class="n">ocaml</span>
        <span class="nc">Objective</span> <span class="nc">Caml</span> <span class="n">version</span> <span class="mi">3</span><span class="o">.</span><span class="mi">10</span><span class="o">.</span><span class="mi">2</span>

<span class="o">#</span> <span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">-</span> <span class="o">:</span> <span class="kt">unit</span> <span class="o">=</span> <span class="bp">()</span>
<span class="nc">Findlib</span> <span class="n">has</span> <span class="n">been</span> <span class="n">successfully</span> <span class="n">loaded</span><span class="o">.</span> <span class="nc">Additional</span> <span class="n">directives</span><span class="o">:</span>
  <span class="o">#</span><span class="n">require</span> <span class="s2">&quot;package&quot;</span><span class="o">;;</span>      <span class="k">to</span> <span class="n">load</span> <span class="n">a</span> <span class="n">package</span>
  <span class="o">#</span><span class="kt">list</span><span class="o">;;</span>                   <span class="k">to</span> <span class="kt">list</span> <span class="n">the</span> <span class="n">available</span> <span class="n">packages</span>
  <span class="o">#</span><span class="n">camlp4o</span><span class="o">;;</span>                <span class="k">to</span> <span class="n">load</span> <span class="n">camlp4</span> <span class="o">(</span><span class="n">standard</span> <span class="n">syntax</span><span class="o">)</span>
  <span class="o">#</span><span class="n">camlp4r</span><span class="o">;;</span>                <span class="k">to</span> <span class="n">load</span> <span class="n">camlp4</span> <span class="o">(</span><span class="n">revised</span> <span class="n">syntax</span><span class="o">)</span>
  <span class="o">#</span><span class="n">predicates</span> <span class="s2">&quot;p,q,...&quot;</span><span class="o">;;</span>   <span class="k">to</span> <span class="n">set</span> <span class="n">these</span> <span class="n">predicates</span>
  <span class="nn">Topfind</span><span class="p">.</span><span class="n">reset</span><span class="bp">()</span><span class="o">;;</span>         <span class="k">to</span> <span class="n">force</span> <span class="n">that</span> <span class="n">packages</span> <span class="n">will</span> <span class="n">be</span> <span class="n">reloaded</span>
  <span class="o">#</span><span class="n">thread</span><span class="o">;;</span>                 <span class="k">to</span> <span class="n">enable</span> <span class="n">threads</span>

<span class="o">-</span> <span class="o">:</span> <span class="kt">unit</span> <span class="o">=</span> <span class="bp">()</span>
<span class="o">#</span> <span class="o">#</span><span class="kt">list</span><span class="o">;;</span>
<span class="n">benchmark</span>           <span class="o">(</span><span class="n">version</span><span class="o">:</span> <span class="mi">0</span><span class="o">.</span><span class="mi">6</span><span class="o">)</span>
<span class="n">bigarray</span>            <span class="o">(</span><span class="n">version</span><span class="o">:</span> <span class="o">[</span><span class="n">distributed</span> <span class="k">with</span> <span class="nc">Ocaml</span><span class="o">])</span>
<span class="n">cairo</span>               <span class="o">(</span><span class="n">version</span><span class="o">:</span> <span class="n">n</span><span class="o">/</span><span class="n">a</span><span class="o">)</span>
<span class="n">cairo</span><span class="o">.</span><span class="n">lablgtk2</span>      <span class="o">(</span><span class="n">version</span><span class="o">:</span> <span class="n">n</span><span class="o">/</span><span class="n">a</span><span class="o">)</span>
<span class="o">...</span>


<span class="c">(* @@PLEAC@@_13.0 *)</span>
<span class="c">(* The simplest object possible. This object has no data, no methods,</span>
<span class="c">   and does not belong to any class. *)</span>
<span class="k">let</span> <span class="n">obj</span> <span class="o">=</span> <span class="k">object</span> <span class="k">end</span>

<span class="c">(* The simplest class possible, and an instance of it. *)</span>
<span class="k">class</span> <span class="n">encoder</span> <span class="o">=</span> <span class="k">object</span> <span class="k">end</span>
<span class="k">let</span> <span class="n">obj</span> <span class="o">=</span> <span class="k">new</span> <span class="n">encoder</span>

<span class="c">(* A class living inside of a module. *)</span>
<span class="k">module</span> <span class="nc">Data</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">class</span> <span class="n">encoder</span> <span class="o">=</span> <span class="k">object</span> <span class="k">end</span>
<span class="k">end</span>
<span class="k">let</span> <span class="n">obj</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Data</span><span class="p">.</span><span class="n">encoder</span>

<span class="c">(* An object with data and a method. *)</span>
<span class="k">let</span> <span class="n">obj</span> <span class="o">=</span> <span class="k">object</span>
  <span class="k">val</span> <span class="n">data</span> <span class="o">=</span> <span class="o">[</span><span class="mi">3</span><span class="o">;</span> <span class="mi">5</span><span class="o">]</span>
  <span class="k">method</span> <span class="n">at</span> <span class="n">n</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">nth</span> <span class="n">data</span> <span class="n">n</span>
<span class="k">end</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* Display the object&#39;s identity (an integer) and call a method. *)</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%d %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">Oo</span><span class="p">.</span><span class="n">id</span> <span class="n">obj</span><span class="o">)</span> <span class="o">(</span><span class="n">obj</span><span class="o">#</span><span class="n">at</span> <span class="mi">1</span><span class="o">)</span>

<span class="c">(* A module containing a class with data and a method. *)</span>
<span class="k">module</span> <span class="nc">Human</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">class</span> <span class="o">[</span><span class="k">&#39;</span><span class="n">a</span><span class="o">]</span> <span class="n">cannibal</span> <span class="n">data</span> <span class="o">=</span> <span class="k">object</span>
    <span class="k">val</span> <span class="n">data</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="kt">list</span> <span class="o">=</span> <span class="n">data</span>
    <span class="k">method</span> <span class="n">at</span> <span class="n">n</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">nth</span> <span class="n">data</span> <span class="n">n</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">obj</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Human</span><span class="p">.</span><span class="n">cannibal</span> <span class="o">[</span><span class="mi">3</span><span class="o">;</span> <span class="mi">5</span><span class="o">]</span> <span class="k">in</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%d %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">Oo</span><span class="p">.</span><span class="n">id</span> <span class="n">obj</span><span class="o">)</span> <span class="o">(</span><span class="n">obj</span><span class="o">#</span><span class="n">at</span> <span class="mi">1</span><span class="o">)</span>

<span class="c">(* Method calls are indicated by the &#39;#&#39; operator. *)</span>
<span class="k">let</span> <span class="n">encoded</span> <span class="o">=</span> <span class="n">obj</span><span class="o">#</span><span class="n">encode</span> <span class="s2">&quot;data&quot;</span>

<span class="c">(* There is no notion of a class method in OCaml.</span>
<span class="c">   Use a module-level function instead. *)</span>
<span class="k">let</span> <span class="n">encoded</span> <span class="o">=</span> <span class="nn">Data</span><span class="p">.</span><span class="nn">Encoder</span><span class="p">.</span><span class="n">encode</span> <span class="s2">&quot;data&quot;</span>

<span class="c">(* Using the &quot;class&quot; keyword is much like defining a function. *)</span>
<span class="k">class</span> <span class="n">klass</span> <span class="o">(</span><span class="n">initial_name</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span> <span class="k">object</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">my_name</span> <span class="o">=</span> <span class="n">initial_name</span>
  <span class="k">method</span> <span class="n">name</span> <span class="o">=</span> <span class="n">my_name</span>
  <span class="k">method</span> <span class="n">set_name</span> <span class="n">name</span> <span class="o">=</span> <span class="n">my_name</span> <span class="o">&lt;-</span> <span class="n">name</span>
<span class="k">end</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">obj</span> <span class="o">=</span> <span class="k">new</span> <span class="n">klass</span> <span class="s2">&quot;Class&quot;</span> <span class="k">in</span>
  <span class="n">print_endline</span> <span class="n">obj</span><span class="o">#</span><span class="n">name</span><span class="o">;</span>
  <span class="n">obj</span><span class="o">#</span><span class="n">set_name</span> <span class="s2">&quot;Clown&quot;</span><span class="o">;</span>
  <span class="n">print_endline</span> <span class="n">obj</span><span class="o">#</span><span class="n">name</span>

<span class="c">(* Initialization can be performed prior to object creation. *)</span>
<span class="k">class</span> <span class="n">random</span> <span class="n">n</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">rng</span> <span class="o">=</span> <span class="nn">Random</span><span class="p">.</span><span class="nn">State</span><span class="p">.</span><span class="n">make_self_init</span> <span class="bp">()</span> <span class="k">in</span>
<span class="k">object</span>
  <span class="k">method</span> <span class="n">next</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Random</span><span class="p">.</span><span class="nn">State</span><span class="p">.</span><span class="n">int</span> <span class="n">rng</span> <span class="n">n</span>
<span class="k">end</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">r</span> <span class="o">=</span> <span class="k">new</span> <span class="n">random</span> <span class="mi">10</span> <span class="k">in</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Three random numbers: %d, %d, %d.</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="o">(</span><span class="n">r</span><span class="o">#</span><span class="n">next</span> <span class="bp">()</span><span class="o">)</span> <span class="o">(</span><span class="n">r</span><span class="o">#</span><span class="n">next</span> <span class="bp">()</span><span class="o">)</span> <span class="o">(</span><span class="n">r</span><span class="o">#</span><span class="n">next</span> <span class="bp">()</span><span class="o">)</span>

<span class="c">(* Initialization can also be performed after object creation.</span>
<span class="c">   Note the &quot;self&quot; parameter, which can be used much like the</span>
<span class="c">   &quot;this&quot; reference in other OO languages. *)</span>
<span class="k">class</span> <span class="n">late_initializer</span> <span class="n">name</span> <span class="o">=</span> <span class="k">object</span> <span class="o">(</span><span class="n">self</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">my_name</span> <span class="o">=</span> <span class="n">name</span>
  <span class="k">method</span> <span class="n">prepare_name</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">capitalize</span> <span class="n">my_name</span>
  <span class="k">initializer</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s is ready</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">self</span><span class="o">#</span><span class="n">prepare_name</span> <span class="bp">()</span><span class="o">)</span>
<span class="k">end</span>
<span class="k">let</span> <span class="n">obj</span> <span class="o">=</span> <span class="k">new</span> <span class="n">late_initializer</span> <span class="s2">&quot;object&quot;</span>

<span class="c">(* Methods are curried just like functions. This allows them to</span>
<span class="c">   be used just like functions in many cases. It is customary for</span>
<span class="c">   methods to take at least one argument (even if it is unit)</span>
<span class="c">   unless they represent an object&#39;s attribute. *)</span>
<span class="k">module</span> <span class="nc">Human</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">class</span> <span class="n">cannibal</span> <span class="o">(</span><span class="n">name</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span> <span class="k">object</span>
    <span class="k">val</span> <span class="k">mutable</span> <span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="k">method</span> <span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
    <span class="k">method</span> <span class="n">feed</span> <span class="n">who</span> <span class="o">=</span> <span class="n">print_endline</span> <span class="o">(</span><span class="s2">&quot;Feeding &quot;</span> <span class="o">^</span> <span class="n">who</span><span class="o">)</span>
    <span class="k">method</span> <span class="n">move</span> <span class="n">where</span> <span class="o">=</span> <span class="n">print_endline</span> <span class="o">(</span><span class="s2">&quot;Moving to &quot;</span> <span class="o">^</span> <span class="n">where</span><span class="o">)</span>
    <span class="k">method</span> <span class="n">die</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">print_endline</span> <span class="s2">&quot;Dying&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">lector</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Human</span><span class="p">.</span><span class="n">cannibal</span> <span class="s2">&quot;Hannibal&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">feed</span><span class="o">,</span> <span class="n">move</span><span class="o">,</span> <span class="n">die</span> <span class="o">=</span> <span class="n">lector</span><span class="o">#</span><span class="n">feed</span><span class="o">,</span> <span class="n">lector</span><span class="o">#</span><span class="n">move</span><span class="o">,</span> <span class="n">lector</span><span class="o">#</span><span class="n">die</span> <span class="k">in</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Cannibal&#39;s name is %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">lector</span><span class="o">#</span><span class="n">name</span><span class="o">;</span>
  <span class="n">feed</span> <span class="s2">&quot;Zak&quot;</span><span class="o">;</span>
  <span class="n">move</span> <span class="s2">&quot;New York&quot;</span><span class="o">;</span>
  <span class="n">die</span> <span class="bp">()</span>

<span class="c">(* @@PLEAC@@_13.1 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">class</span> <span class="n">klass</span> <span class="n">args</span> <span class="o">=</span> <span class="k">object</span> <span class="o">(</span><span class="n">self</span><span class="o">)</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="o">.</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">age</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">val</span> <span class="n">extra</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span>

  <span class="c">(* Private method to initialize fields. Sets start to</span>
<span class="c">     the current time, and age to 0. If called with arguments,</span>
<span class="c">     init interprets them as key+value pairs to initialize the</span>
<span class="c">     hashtable &quot;extra&quot; with. *)</span>
  <span class="k">method</span> <span class="k">private</span> <span class="n">init</span> <span class="bp">()</span> <span class="o">=</span>
    <span class="n">start</span> <span class="o">&lt;-</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">time</span> <span class="bp">()</span><span class="o">;</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
      <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">extra</span> <span class="n">k</span> <span class="n">v</span><span class="o">)</span>
      <span class="n">args</span>

  <span class="k">initializer</span>
    <span class="n">self</span><span class="o">#</span><span class="n">init</span> <span class="bp">()</span>
<span class="k">end</span>

<span class="c">(* @@PLEAC@@_13.2 *)</span>
<span class="c">(* The Gc.finalise function can be used to create finalizers,</span>
<span class="c">   which are like destructors but run at garbage collection time,</span>
<span class="c">   for any value, not just objects. You can still use a method if</span>
<span class="c">   you want: *)</span>

<span class="k">class</span> <span class="n">klass</span> <span class="o">=</span>
<span class="k">object</span> <span class="o">(</span><span class="n">self</span><span class="o">)</span>
  <span class="k">initializer</span>
    <span class="nn">Gc</span><span class="p">.</span><span class="n">finalise</span> <span class="o">(</span><span class="k">fun</span> <span class="n">self</span> <span class="o">-&gt;</span> <span class="n">self</span><span class="o">#</span><span class="n">destroy</span> <span class="bp">()</span><span class="o">)</span> <span class="n">self</span>
  <span class="k">method</span> <span class="n">destroy</span> <span class="bp">()</span> <span class="o">=</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;klass %d is dying</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">Oo</span><span class="p">.</span><span class="n">id</span> <span class="n">self</span><span class="o">)</span>
<span class="k">end</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">ignore</span> <span class="o">(</span><span class="k">new</span> <span class="n">klass</span><span class="o">);</span>
  <span class="nn">Gc</span><span class="p">.</span><span class="n">full_major</span> <span class="bp">()</span>

<span class="c">(* The &quot;destroy&quot; method above is public. If you want to keep it</span>
<span class="c">   hidden, you can create a finalizer in a let-binding instead: *)</span>

<span class="k">class</span> <span class="n">klass</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">destroy</span> <span class="n">obj</span> <span class="o">=</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;klass %d is dying</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">Oo</span><span class="p">.</span><span class="n">id</span> <span class="n">obj</span><span class="o">)</span> <span class="k">in</span>
<span class="k">object</span> <span class="o">(</span><span class="n">self</span><span class="o">)</span>
  <span class="k">initializer</span> <span class="nn">Gc</span><span class="p">.</span><span class="n">finalise</span> <span class="n">destroy</span> <span class="n">self</span>
<span class="k">end</span>

<span class="c">(* @@PLEAC@@_13.3 *)</span>
<span class="c">(* Using a get and set method. *)</span>
<span class="k">class</span> <span class="n">person</span> <span class="o">=</span> <span class="k">object</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
  <span class="k">method</span> <span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
  <span class="k">method</span> <span class="n">set_name</span> <span class="n">name&#39;</span> <span class="o">=</span> <span class="n">name</span> <span class="o">&lt;-</span> <span class="n">name&#39;</span>
<span class="k">end</span>

<span class="c">(* Using a single method that does both get and set. *)</span>
<span class="k">class</span> <span class="n">person</span> <span class="o">=</span> <span class="k">object</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">age</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="c">(* Unit argument required due to optional argument. *)</span>
  <span class="k">method</span> <span class="n">age</span> <span class="o">?</span><span class="n">set</span> <span class="bp">()</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">set</span> <span class="k">with</span> <span class="nc">Some</span> <span class="n">age&#39;</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">age</span> <span class="o">&lt;-</span> <span class="n">age&#39;</span><span class="o">;</span> <span class="n">age</span><span class="o">)</span> <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="n">age</span>
<span class="k">end</span>

<span class="c">(* Sample call of get and set: happy birthday! *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">obj</span> <span class="o">=</span> <span class="k">new</span> <span class="n">person</span> <span class="k">in</span>
  <span class="n">ignore</span> <span class="o">(</span><span class="n">obj</span><span class="o">#</span><span class="n">age</span> <span class="o">~</span><span class="n">set</span><span class="o">:(</span><span class="n">obj</span><span class="o">#</span><span class="n">age</span> <span class="bp">()</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="bp">()</span><span class="o">)</span>

<span class="c">(* This class converts input when the name is set. *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>
<span class="k">class</span> <span class="n">person</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">funny_chars</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;.*[^</span><span class="se">\n\r\t</span><span class="s2"> A-Za-z0-9&#39;-]&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">numbers</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;.*[0-9]&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">not_blank</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;.*[^</span><span class="se">\n\r\t</span><span class="s2"> ]&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">multiword</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;.*[^</span><span class="se">\n\r\t</span><span class="s2"> ]+[</span><span class="se">\n\r\t</span><span class="s2"> ]+[^</span><span class="se">\n\r\t</span><span class="s2"> ]&quot;</span> <span class="k">in</span>
<span class="k">object</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
  <span class="k">method</span> <span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
  <span class="k">method</span> <span class="n">set_name</span> <span class="n">name&#39;</span> <span class="o">=</span>
    <span class="k">if</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">funny_chars</span> <span class="n">name&#39;</span> <span class="mi">0</span>
    <span class="k">then</span> <span class="n">failwith</span> <span class="s2">&quot;funny characters in name&quot;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">numbers</span> <span class="n">name&#39;</span> <span class="mi">0</span>
    <span class="k">then</span> <span class="n">failwith</span> <span class="s2">&quot;numbers in name&quot;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">not_blank</span> <span class="n">name&#39;</span> <span class="mi">0</span><span class="o">)</span>
    <span class="k">then</span> <span class="n">failwith</span> <span class="s2">&quot;name is blank&quot;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">multiword</span> <span class="n">name&#39;</span> <span class="mi">0</span><span class="o">)</span>
    <span class="k">then</span> <span class="n">failwith</span> <span class="s2">&quot;prefer multiword name&quot;</span>
    <span class="k">else</span> <span class="n">name</span> <span class="o">&lt;-</span> <span class="nn">String</span><span class="p">.</span><span class="n">capitalize</span> <span class="n">name&#39;</span>
<span class="k">end</span>

<span class="c">(* A typical class with attributes and methods. *)</span>
<span class="k">class</span> <span class="n">person</span> <span class="o">=</span> <span class="k">object</span>
  <span class="c">(* Instance variables *)</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">age</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">peers</span> <span class="o">=</span> <span class="bp">[]</span>

  <span class="c">(* Accessors *)</span>
  <span class="k">method</span> <span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
  <span class="k">method</span> <span class="n">set_name</span> <span class="n">name&#39;</span> <span class="o">=</span> <span class="n">name</span> <span class="o">&lt;-</span> <span class="n">name&#39;</span>
  <span class="k">method</span> <span class="n">age</span> <span class="o">=</span> <span class="n">age</span>
  <span class="k">method</span> <span class="n">set_age</span> <span class="n">age&#39;</span> <span class="o">=</span> <span class="n">age</span> <span class="o">&lt;-</span> <span class="n">age&#39;</span>
  <span class="k">method</span> <span class="n">peers</span> <span class="o">=</span> <span class="n">peers</span>
  <span class="k">method</span> <span class="n">set_peers</span> <span class="n">peers&#39;</span> <span class="o">=</span> <span class="n">peers</span> <span class="o">&lt;-</span> <span class="n">peers&#39;</span>

  <span class="c">(* Behavioral methods *)</span>
  <span class="k">method</span> <span class="n">exclaim</span> <span class="bp">()</span> <span class="o">=</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;Hi, I&#39;m %s age %d, working with %s&quot;</span>
      <span class="n">name</span> <span class="n">age</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;, &quot;</span> <span class="n">peers</span><span class="o">)</span>
  <span class="k">method</span> <span class="n">happy_birthday</span> <span class="bp">()</span> <span class="o">=</span>
    <span class="n">age</span> <span class="o">&lt;-</span> <span class="n">age</span> <span class="o">+</span> <span class="mi">1</span>
<span class="k">end</span>

<span class="c">(* @@PLEAC@@_13.4 *)</span>
<span class="c">(* There are no class methods in OCaml. Use a module instead. *)</span>
<span class="k">module</span> <span class="nc">Person</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">let</span> <span class="o">_</span><span class="n">body_count</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>
  <span class="k">let</span> <span class="n">population</span> <span class="bp">()</span> <span class="o">=</span> <span class="o">!_</span><span class="n">body_count</span>
  <span class="k">let</span> <span class="n">destroy</span> <span class="n">person</span> <span class="o">=</span> <span class="n">decr</span> <span class="o">_</span><span class="n">body_count</span>
  <span class="k">class</span> <span class="n">person</span> <span class="o">=</span> <span class="k">object</span> <span class="o">(</span><span class="n">self</span><span class="o">)</span>
    <span class="k">initializer</span>
      <span class="n">incr</span> <span class="o">_</span><span class="n">body_count</span><span class="o">;</span>
      <span class="nn">Gc</span><span class="p">.</span><span class="n">finalise</span> <span class="n">destroy</span> <span class="n">self</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c">(* Later, the user can say this: *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">people</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">to</span> <span class="mi">10</span> <span class="k">do</span> <span class="n">people</span> <span class="o">:=</span> <span class="k">new</span> <span class="nn">Person</span><span class="p">.</span><span class="n">person</span> <span class="o">::</span> <span class="o">!</span><span class="n">people</span> <span class="k">done</span><span class="o">;</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;There are %d people alive.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">Person</span><span class="p">.</span><span class="n">population</span> <span class="bp">()</span><span class="o">)</span>
  <span class="c">(* There are 10 people alive. *)</span>

<span class="c">(* A class with an attribute that changes all instances when set. *)</span>
<span class="k">module</span> <span class="nc">FixedArray</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">let</span> <span class="o">_</span><span class="n">bounds</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">7</span>  <span class="c">(* default *)</span>
  <span class="k">let</span> <span class="n">max_bounds</span> <span class="bp">()</span> <span class="o">=</span> <span class="o">!_</span><span class="n">bounds</span>
  <span class="k">let</span> <span class="n">set_max_bounds</span> <span class="n">max</span> <span class="o">=</span> <span class="o">_</span><span class="n">bounds</span> <span class="o">:=</span> <span class="n">max</span>
  <span class="k">class</span> <span class="n">fixed_array</span> <span class="o">=</span> <span class="k">object</span>
    <span class="k">method</span> <span class="n">max_bounds</span> <span class="o">=</span> <span class="o">!_</span><span class="n">bounds</span>
    <span class="k">method</span> <span class="n">set_max_bounds</span> <span class="n">bounds&#39;</span> <span class="o">=</span> <span class="o">_</span><span class="n">bounds</span> <span class="o">:=</span> <span class="n">bounds&#39;</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* Set for whole class *)</span>
  <span class="nn">FixedArray</span><span class="p">.</span><span class="n">set_max_bounds</span> <span class="mi">100</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">alpha</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">FixedArray</span><span class="p">.</span><span class="n">fixed_array</span> <span class="k">in</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Bound on alpha is %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">alpha</span><span class="o">#</span><span class="n">max_bounds</span><span class="o">;</span>
  <span class="c">(* 100 *)</span>
  <span class="k">let</span> <span class="n">beta</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">FixedArray</span><span class="p">.</span><span class="n">fixed_array</span> <span class="k">in</span>
  <span class="n">beta</span><span class="o">#</span><span class="n">set_max_bounds</span> <span class="mi">50</span><span class="o">;</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Bound on alpha is %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">alpha</span><span class="o">#</span><span class="n">max_bounds</span><span class="o">;</span>
  <span class="c">(* 50 *)</span>

<span class="c">(* To make the bounds read only, just remove the set method. *)</span>

<span class="c">(* @@PLEAC@@_13.5 *)</span>
<span class="c">(* Immediate objects can be used like records, and their types are</span>
<span class="c">   inferred automatically. Unlike with records, object fields names</span>
<span class="c">   do not have to be unique to a module, which can be convenient. *)</span>
<span class="k">let</span> <span class="n">p</span> <span class="o">=</span> <span class="k">object</span>
  <span class="k">method</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Jason Smythe&quot;</span>
  <span class="k">method</span> <span class="n">age</span> <span class="o">=</span> <span class="mi">13</span>
  <span class="k">method</span> <span class="n">peers</span> <span class="o">=</span> <span class="o">[|</span> <span class="s2">&quot;Wilbur&quot;</span><span class="o">;</span> <span class="s2">&quot;Ralph&quot;</span><span class="o">;</span> <span class="s2">&quot;Fred&quot;</span> <span class="o">|]</span>
<span class="k">end</span>
<span class="c">(* val p : &lt; age : int; name : string; peers : string array &gt; = &lt;obj&gt; *)</span>

<span class="c">(* Fetch various values, including the zeroth friend. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;At age %d, %s&#39;s first friend is %s.</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">p</span><span class="o">#</span><span class="n">age</span> <span class="n">p</span><span class="o">#</span><span class="n">name</span> <span class="n">p</span><span class="o">#</span><span class="n">peers</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span>
<span class="c">(* At age 13, Jason Smythe&#39;s first friend is Wilbur. *)</span>

<span class="c">(*---------------------------*)</span>

<span class="c">(* Immediate objects can be nested. *)</span>
<span class="k">let</span> <span class="n">folks</span> <span class="o">=</span> <span class="k">object</span>
  <span class="k">method</span> <span class="n">head</span> <span class="o">=</span> <span class="k">object</span>
    <span class="k">method</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;John&quot;</span>
    <span class="k">method</span> <span class="n">age</span> <span class="o">=</span> <span class="mi">34</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="c">(* val folks : &lt; head : &lt; age : int; name : string &gt; &gt; = &lt;obj&gt; *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s&#39;s age is %d</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">folks</span><span class="o">#</span><span class="n">head</span><span class="o">#</span><span class="n">name</span> <span class="n">folks</span><span class="o">#</span><span class="n">head</span><span class="o">#</span><span class="n">age</span>
<span class="c">(* John&#39;s age is 34 *)</span>

<span class="c">(*---------------------------*)</span>

<span class="c">(* If you want to maintain an invariant, it&#39;s better to use a class. *)</span>
<span class="k">exception</span> <span class="nc">Unreasonable_age</span> <span class="k">of</span> <span class="kt">int</span>
<span class="k">class</span> <span class="n">person</span> <span class="n">init_name</span> <span class="n">init_age</span> <span class="o">=</span> <span class="k">object</span> <span class="o">(</span><span class="n">self</span><span class="o">)</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">age</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">method</span> <span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
  <span class="k">method</span> <span class="n">age</span> <span class="o">=</span> <span class="n">age</span>
  <span class="k">method</span> <span class="n">set_name</span> <span class="n">name&#39;</span> <span class="o">=</span> <span class="n">name</span> <span class="o">&lt;-</span> <span class="n">name&#39;</span>
  <span class="k">method</span> <span class="n">set_age</span> <span class="n">age&#39;</span> <span class="o">=</span>
    <span class="k">if</span> <span class="n">age&#39;</span> <span class="o">&gt;</span> <span class="mi">150</span> <span class="k">then</span> <span class="k">raise</span> <span class="o">(</span><span class="nc">Unreasonable_age</span> <span class="n">age&#39;</span><span class="o">)</span> <span class="k">else</span> <span class="n">age</span> <span class="o">&lt;-</span> <span class="n">age&#39;</span>
  <span class="k">initializer</span>
    <span class="n">self</span><span class="o">#</span><span class="n">set_name</span> <span class="n">init_name</span><span class="o">;</span>
    <span class="n">self</span><span class="o">#</span><span class="n">set_age</span> <span class="n">init_age</span>
<span class="k">end</span>

<span class="c">(* @@PLEAC@@_13.6 *)</span>
<span class="c">(* Objects can be cloned with Oo.copy. *)</span>
<span class="k">let</span> <span class="n">ob1</span> <span class="o">=</span> <span class="k">new</span> <span class="n">some_class</span>
<span class="c">(* later on *)</span>
<span class="k">let</span> <span class="n">ob2</span> <span class="o">=</span> <span class="nn">Oo</span><span class="p">.</span><span class="n">copy</span> <span class="n">ob1</span>

<span class="c">(* Objects can also be cloned using the functional update syntax. *)</span>
<span class="k">class</span> <span class="n">person</span> <span class="o">(</span><span class="n">name</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">(</span><span class="n">age</span> <span class="o">:</span> <span class="kt">int</span><span class="o">)</span> <span class="o">=</span> <span class="k">object</span>
  <span class="k">val</span> <span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
  <span class="k">val</span> <span class="n">age</span> <span class="o">=</span> <span class="n">age</span>
  <span class="k">method</span> <span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
  <span class="k">method</span> <span class="n">age</span> <span class="o">=</span> <span class="n">age</span>
  <span class="k">method</span> <span class="n">with_name</span> <span class="n">name&#39;</span> <span class="o">=</span> <span class="o">{&lt;</span> <span class="n">name</span> <span class="o">=</span> <span class="n">name&#39;</span> <span class="o">&gt;}</span>
  <span class="k">method</span> <span class="n">with_age</span> <span class="n">age&#39;</span> <span class="o">=</span> <span class="o">{&lt;</span> <span class="n">age</span> <span class="o">=</span> <span class="n">age&#39;</span> <span class="o">&gt;}</span>
  <span class="k">method</span> <span class="n">copy</span> <span class="bp">()</span> <span class="o">=</span> <span class="o">{&lt;</span> <span class="o">&gt;}</span>
<span class="k">end</span>

<span class="c">(* @@PLEAC@@_13.7 *)</span>
<span class="c">(* Create a hashtable mapping method names to method calls. *)</span>
<span class="k">let</span> <span class="n">methods</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">3</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">methods</span> <span class="s2">&quot;run&quot;</span>   <span class="o">(</span><span class="k">fun</span> <span class="n">obj</span> <span class="o">-&gt;</span> <span class="n">obj</span><span class="o">#</span><span class="n">run</span> <span class="bp">()</span><span class="o">);</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">methods</span> <span class="s2">&quot;start&quot;</span> <span class="o">(</span><span class="k">fun</span> <span class="n">obj</span> <span class="o">-&gt;</span> <span class="n">obj</span><span class="o">#</span><span class="n">start</span> <span class="bp">()</span><span class="o">);</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">methods</span> <span class="s2">&quot;stop&quot;</span>  <span class="o">(</span><span class="k">fun</span> <span class="n">obj</span> <span class="o">-&gt;</span> <span class="n">obj</span><span class="o">#</span><span class="n">stop</span> <span class="bp">()</span><span class="o">)</span>

<span class="c">(* Call the three methods on the object by name. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">m</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">methods</span> <span class="n">m</span><span class="o">)</span> <span class="n">obj</span><span class="o">)</span>
    <span class="o">[</span><span class="s2">&quot;start&quot;</span><span class="o">;</span> <span class="s2">&quot;run&quot;</span><span class="o">;</span> <span class="s2">&quot;stop&quot;</span><span class="o">]</span>

<span class="c">(* You can alias a method as long as it takes at least one argument. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">meth</span> <span class="o">=</span> <span class="n">obj</span><span class="o">#</span><span class="n">run</span> <span class="k">in</span>
  <span class="c">(* ... *)</span>
  <span class="n">meth</span> <span class="bp">()</span>

<span class="c">(* @@PLEAC@@_13.8 *)</span>
<span class="c">(* OCaml has no runtime type information and therefore no &quot;instanceof&quot;</span>
<span class="c">   operator. One alternative would be to provide methods to query for</span>
<span class="c">   an object&#39;s class. *)</span>
<span class="k">class</span> <span class="n">widget</span> <span class="o">(</span><span class="n">name</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span> <span class="k">object</span>
  <span class="k">method</span> <span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
  <span class="k">method</span> <span class="n">is_widget</span> <span class="o">=</span> <span class="bp">true</span>
  <span class="k">method</span> <span class="n">is_gadget</span> <span class="o">=</span> <span class="bp">false</span>
<span class="k">end</span>
<span class="k">class</span> <span class="n">gadget</span> <span class="n">name</span> <span class="o">=</span> <span class="k">object</span>
  <span class="k">inherit</span> <span class="n">widget</span> <span class="n">name</span>
  <span class="k">method</span> <span class="n">is_gadget</span> <span class="o">=</span> <span class="bp">true</span>
<span class="k">end</span>

<span class="c">(* Another solution would be to use the visitor pattern. *)</span>
<span class="k">class</span> <span class="n">widget</span> <span class="o">(</span><span class="n">name</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">=</span> <span class="k">object</span> <span class="o">(</span><span class="n">self</span><span class="o">)</span>
  <span class="k">method</span> <span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
  <span class="k">method</span> <span class="n">accept</span> <span class="o">(</span><span class="n">v</span> <span class="o">:</span> <span class="n">visitor</span><span class="o">)</span> <span class="o">=</span> <span class="n">v</span><span class="o">#</span><span class="n">visit_widget</span> <span class="o">(</span><span class="n">self</span> <span class="o">:&gt;</span> <span class="n">widget</span><span class="o">)</span>
<span class="k">end</span>
<span class="ow">and</span> <span class="n">gadget</span> <span class="n">name</span> <span class="o">=</span> <span class="k">object</span> <span class="o">(</span><span class="n">self</span><span class="o">)</span>
  <span class="k">inherit</span> <span class="n">widget</span> <span class="n">name</span>
  <span class="k">method</span> <span class="n">accept</span> <span class="o">(</span><span class="n">v</span> <span class="o">:</span> <span class="n">visitor</span><span class="o">)</span> <span class="o">=</span> <span class="n">v</span><span class="o">#</span><span class="n">visit_gadget</span> <span class="o">(</span><span class="n">self</span> <span class="o">:&gt;</span> <span class="n">gadget</span><span class="o">)</span>
<span class="k">end</span>
<span class="ow">and</span> <span class="n">visitor</span> <span class="o">~</span><span class="n">visit_widget</span> <span class="o">~</span><span class="n">visit_gadget</span> <span class="o">=</span> <span class="k">object</span>
  <span class="k">method</span> <span class="n">visit_widget</span> <span class="o">=</span> <span class="o">(</span><span class="n">visit_widget</span> <span class="o">:</span> <span class="n">widget</span> <span class="o">-&gt;</span> <span class="kt">unit</span><span class="o">)</span>
  <span class="k">method</span> <span class="n">visit_gadget</span> <span class="o">=</span> <span class="o">(</span><span class="n">visit_gadget</span> <span class="o">:</span> <span class="n">gadget</span> <span class="o">-&gt;</span> <span class="kt">unit</span><span class="o">)</span>
<span class="k">end</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">visitor</span> <span class="o">=</span> <span class="k">new</span> <span class="n">visitor</span>
    <span class="o">~</span><span class="n">visit_gadget</span><span class="o">:</span> <span class="o">(</span><span class="k">fun</span> <span class="n">gadget</span> <span class="o">-&gt;</span>
                      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Found gadget: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">gadget</span><span class="o">#</span><span class="n">name</span><span class="o">)</span>
    <span class="o">~</span><span class="n">visit_widget</span><span class="o">:</span> <span class="o">(</span><span class="k">fun</span> <span class="n">widget</span> <span class="o">-&gt;</span>
                      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Found widget: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">widget</span><span class="o">#</span><span class="n">name</span><span class="o">)</span> <span class="k">in</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">obj</span> <span class="o">-&gt;</span> <span class="n">obj</span><span class="o">#</span><span class="n">accept</span> <span class="n">visitor</span><span class="o">)</span>
    <span class="o">[</span><span class="k">new</span> <span class="n">widget</span> <span class="s2">&quot;a&quot;</span><span class="o">;</span> <span class="k">new</span> <span class="n">gadget</span> <span class="s2">&quot;b&quot;</span><span class="o">;</span> <span class="k">new</span> <span class="n">widget</span> <span class="s2">&quot;c&quot;</span><span class="o">]</span>

<span class="c">(* Yet another solution would be to rethink your design in terms of</span>
<span class="c">   variants and pattern matching. *)</span>

<span class="c">(* @@PLEAC@@_13.9 *)</span>
<span class="k">class</span> <span class="n">person</span> <span class="o">=</span> <span class="k">object</span> <span class="o">(</span><span class="n">self</span><span class="o">)</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">age</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">method</span> <span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
  <span class="k">method</span> <span class="n">age</span> <span class="o">=</span> <span class="n">age</span>
  <span class="k">method</span> <span class="n">set_name</span> <span class="n">name&#39;</span> <span class="o">=</span> <span class="n">name</span> <span class="o">&lt;-</span> <span class="n">name&#39;</span>
  <span class="k">method</span> <span class="n">set_age</span> <span class="n">age&#39;</span> <span class="o">=</span> <span class="n">age</span> <span class="o">&lt;-</span> <span class="n">age&#39;</span>
<span class="k">end</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">dude</span> <span class="o">=</span> <span class="k">new</span> <span class="n">person</span> <span class="k">in</span>
  <span class="n">dude</span><span class="o">#</span><span class="n">set_name</span> <span class="s2">&quot;Jason&quot;</span><span class="o">;</span>
  <span class="n">dude</span><span class="o">#</span><span class="n">set_age</span> <span class="mi">23</span><span class="o">;</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s is age %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">dude</span><span class="o">#</span><span class="n">name</span> <span class="n">dude</span><span class="o">#</span><span class="n">age</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">class</span> <span class="n">employee</span> <span class="o">=</span> <span class="k">object</span> <span class="o">(</span><span class="n">self</span><span class="o">)</span>
  <span class="k">inherit</span> <span class="n">person</span>
<span class="k">end</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">empl</span> <span class="o">=</span> <span class="k">new</span> <span class="n">employee</span> <span class="k">in</span>
  <span class="n">empl</span><span class="o">#</span><span class="n">set_name</span> <span class="s2">&quot;Jason&quot;</span><span class="o">;</span>
  <span class="n">empl</span><span class="o">#</span><span class="n">set_age</span> <span class="mi">23</span><span class="o">;</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s is age %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">empl</span><span class="o">#</span><span class="n">name</span> <span class="n">empl</span><span class="o">#</span><span class="n">age</span>

<span class="c">(* @@PLEAC@@_13.10 *)</span>
<span class="k">class</span> <span class="n">person</span> <span class="o">(</span><span class="n">name</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span> <span class="o">(</span><span class="n">age</span> <span class="o">:</span> <span class="kt">int</span><span class="o">)</span> <span class="o">=</span> <span class="k">object</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">age</span> <span class="o">=</span> <span class="n">age</span>
  <span class="k">method</span> <span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
  <span class="k">method</span> <span class="n">age</span> <span class="o">=</span> <span class="n">age</span>
  <span class="k">method</span> <span class="n">set_name</span> <span class="n">name&#39;</span> <span class="o">=</span> <span class="n">name</span> <span class="o">&lt;-</span> <span class="n">name&#39;</span>
  <span class="k">method</span> <span class="n">set_age</span> <span class="n">age&#39;</span> <span class="o">=</span> <span class="n">age</span> <span class="o">&lt;-</span> <span class="n">age&#39;</span>
<span class="k">end</span>

<span class="k">class</span> <span class="n">liar</span> <span class="n">name</span> <span class="n">age</span> <span class="o">=</span> <span class="k">object</span>
  <span class="c">(* Call superclass constructor and alias superclass as &quot;super&quot;. *)</span>
  <span class="k">inherit</span> <span class="n">person</span> <span class="n">name</span> <span class="n">age</span> <span class="k">as</span> <span class="n">super</span>
  <span class="c">(* Call overridden &quot;age&quot; method. *)</span>
  <span class="k">method</span> <span class="n">age</span> <span class="o">=</span> <span class="n">super</span><span class="o">#</span><span class="n">age</span> <span class="o">-</span> <span class="mi">10</span>
<span class="k">end</span>

<span class="c">(* @@PLEAC@@_13.11 *)</span>
<span class="c">(* Use Jacques Garrigue&#39;s pa_oo syntax extension, available at:</span>
<span class="c">   http://www.math.nagoya-u.ac.jp/~garrigue/code/ocaml.html *)</span>

<span class="c">(*pp camlp4o pa_oo.cmo *)</span>
<span class="k">class</span> <span class="n">person</span> <span class="bp">()</span> <span class="o">=</span> <span class="k">object</span> <span class="o">(</span><span class="n">self</span><span class="o">)</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">with</span> <span class="n">accessor</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">age</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">with</span> <span class="n">accessor</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">parent</span> <span class="o">=</span> <span class="nc">None</span> <span class="k">with</span> <span class="n">reader</span>
  <span class="k">method</span> <span class="n">spawn</span> <span class="bp">()</span> <span class="o">=</span> <span class="o">{&lt;</span> <span class="n">parent</span> <span class="o">=</span> <span class="nc">Some</span> <span class="n">self</span> <span class="o">&gt;}</span>
<span class="k">end</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">dad</span> <span class="o">=</span> <span class="k">new</span> <span class="n">person</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="n">dad</span><span class="o">#</span><span class="n">name</span> <span class="o">&lt;-</span> <span class="s2">&quot;Jason&quot;</span><span class="o">;</span>
  <span class="n">dad</span><span class="o">#</span><span class="n">age</span> <span class="o">&lt;-</span> <span class="mi">23</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">kid</span> <span class="o">=</span> <span class="n">dad</span><span class="o">#</span><span class="n">spawn</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="n">kid</span><span class="o">#</span><span class="n">name</span> <span class="o">&lt;-</span> <span class="s2">&quot;Rachel&quot;</span><span class="o">;</span>
  <span class="n">kid</span><span class="o">#</span><span class="n">age</span> <span class="o">&lt;-</span> <span class="mi">2</span><span class="o">;</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Kid&#39;s parent is %s</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="o">(</span><span class="k">match</span> <span class="n">kid</span><span class="o">#</span><span class="n">parent</span> <span class="k">with</span>
       <span class="o">|</span> <span class="nc">Some</span> <span class="n">parent</span> <span class="o">-&gt;</span> <span class="n">parent</span><span class="o">#</span><span class="n">name</span>
       <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="s2">&quot;unknown&quot;</span><span class="o">)</span>

<span class="c">(* @@PLEAC@@_13.12 *)</span>
<span class="c">(* Use prefixes in instance variable names so we can tell them apart. *)</span>
<span class="k">class</span> <span class="n">person</span> <span class="bp">()</span> <span class="o">=</span> <span class="k">object</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">person_age</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">method</span> <span class="n">age</span> <span class="o">=</span> <span class="n">person_age</span>
  <span class="k">method</span> <span class="n">set_age</span> <span class="n">age&#39;</span> <span class="o">=</span> <span class="n">person_age</span> <span class="o">&lt;-</span> <span class="n">age&#39;</span>
<span class="k">end</span>

<span class="c">(* Now we can access both instance variables as needed. *)</span>
<span class="k">class</span> <span class="n">employee</span> <span class="bp">()</span> <span class="o">=</span> <span class="k">object</span>
  <span class="k">inherit</span> <span class="n">person</span> <span class="bp">()</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">employee_age</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">method</span> <span class="n">age</span> <span class="o">=</span> <span class="n">employee_age</span>
  <span class="k">method</span> <span class="n">set_age</span> <span class="n">age&#39;</span> <span class="o">=</span> <span class="n">employee_age</span> <span class="o">&lt;-</span> <span class="n">age&#39;</span>
  <span class="k">method</span> <span class="n">person_age</span> <span class="o">=</span> <span class="n">person_age</span>
  <span class="k">method</span> <span class="n">set_person_age</span> <span class="n">age&#39;</span> <span class="o">=</span> <span class="n">person_age</span> <span class="o">&lt;-</span> <span class="n">age&#39;</span>
<span class="k">end</span>

<span class="c">(* @@PLEAC@@_13.13 *)</span>
<span class="c">(* OCaml features a generational garbage collector that can handle</span>
<span class="c">   circular references, so you do not need to do anything special to</span>
<span class="c">   safely dispose of circular data structures. The &quot;DESTROY&quot; method</span>
<span class="c">   has been omitted from this translation since it is unnecessary.</span>

<span class="c">   Option types are used heavily due to the imperative style of the</span>
<span class="c">   original recipe, which makes this code somewhat verbose. *)</span>

<span class="c">(* A polymorphic, circular data structure. *)</span>
<span class="k">class</span> <span class="o">[</span><span class="k">&#39;</span><span class="n">a</span><span class="o">]</span> <span class="n">ring</span> <span class="bp">()</span> <span class="o">=</span> <span class="k">object</span> <span class="o">(</span><span class="n">self</span><span class="o">)</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">dummy</span> <span class="o">=</span> <span class="o">(</span><span class="nc">None</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">ring_node</span> <span class="n">option</span><span class="o">)</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

  <span class="c">(* Initialize dummy now that a reference to self is available. *)</span>
  <span class="k">initializer</span>
    <span class="o">(</span><span class="k">let</span> <span class="n">node</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ring_node</span> <span class="bp">()</span> <span class="k">in</span>
     <span class="n">node</span><span class="o">#</span><span class="n">set_prev</span> <span class="o">(</span><span class="nc">Some</span> <span class="n">node</span><span class="o">);</span>
     <span class="n">node</span><span class="o">#</span><span class="n">set_next</span> <span class="o">(</span><span class="nc">Some</span> <span class="n">node</span><span class="o">);</span>
     <span class="n">dummy</span> <span class="o">&lt;-</span> <span class="nc">Some</span> <span class="n">node</span><span class="o">)</span>

  <span class="c">(* Return the number of values in the ring. *)</span>
  <span class="k">method</span> <span class="n">count</span> <span class="o">=</span> <span class="n">count</span>

  <span class="c">(* Insert a value into the ring structure. *)</span>
  <span class="k">method</span> <span class="n">insert</span> <span class="k">value</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">node</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ring_node</span> <span class="bp">()</span> <span class="k">in</span>
    <span class="n">node</span><span class="o">#</span><span class="n">set_value</span> <span class="o">(</span><span class="nc">Some</span> <span class="k">value</span><span class="o">);</span>
    <span class="o">(</span><span class="k">match</span> <span class="n">dummy</span> <span class="k">with</span>
       <span class="o">|</span> <span class="nc">Some</span> <span class="n">ring_dummy</span> <span class="o">-&gt;</span>
           <span class="n">node</span><span class="o">#</span><span class="n">set_next</span> <span class="n">ring_dummy</span><span class="o">#</span><span class="n">next</span><span class="o">;</span>
           <span class="o">(</span><span class="k">match</span> <span class="n">ring_dummy</span><span class="o">#</span><span class="n">next</span> <span class="k">with</span>
              <span class="o">|</span> <span class="nc">Some</span> <span class="n">ring_dummy_next</span> <span class="o">-&gt;</span>
                  <span class="n">ring_dummy_next</span><span class="o">#</span><span class="n">set_prev</span> <span class="o">(</span><span class="nc">Some</span> <span class="n">node</span><span class="o">)</span>
              <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="k">assert</span> <span class="bp">false</span><span class="o">);</span>
           <span class="n">ring_dummy</span><span class="o">#</span><span class="n">set_next</span> <span class="o">(</span><span class="nc">Some</span> <span class="n">node</span><span class="o">);</span>
           <span class="n">node</span><span class="o">#</span><span class="n">set_prev</span> <span class="o">(</span><span class="nc">Some</span> <span class="n">ring_dummy</span><span class="o">);</span>
           <span class="n">count</span> <span class="o">&lt;-</span> <span class="n">count</span> <span class="o">+</span> <span class="mi">1</span>
       <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="k">assert</span> <span class="bp">false</span><span class="o">)</span>

  <span class="c">(* Find a value in the ring. *)</span>
  <span class="k">method</span> <span class="n">search</span> <span class="k">value</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">dummy</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">ring_dummy</span> <span class="o">-&gt;</span>
          <span class="o">(</span><span class="k">match</span> <span class="n">ring_dummy</span><span class="o">#</span><span class="n">next</span> <span class="k">with</span>
             <span class="o">|</span> <span class="nc">Some</span> <span class="n">ring_dummy_next</span> <span class="o">-&gt;</span>
                 <span class="k">let</span> <span class="n">node</span> <span class="o">=</span> <span class="n">ref</span> <span class="n">ring_dummy_next</span> <span class="k">in</span>
                 <span class="k">while</span> <span class="o">!</span><span class="n">node</span> <span class="o">!=</span> <span class="n">ring_dummy</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">node</span><span class="o">#</span><span class="k">value</span> <span class="o">&lt;&gt;</span> <span class="o">(</span><span class="nc">Some</span> <span class="k">value</span><span class="o">)</span>
                 <span class="k">do</span> <span class="n">node</span> <span class="o">:=</span>
                   <span class="k">match</span> <span class="o">!</span><span class="n">node</span><span class="o">#</span><span class="n">next</span> <span class="k">with</span>
                     <span class="o">|</span> <span class="nc">Some</span> <span class="n">n</span> <span class="o">-&gt;</span> <span class="n">n</span>
                     <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="k">assert</span> <span class="bp">false</span>
                 <span class="k">done</span><span class="o">;</span>
                 <span class="o">!</span><span class="n">node</span>
             <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="k">assert</span> <span class="bp">false</span><span class="o">)</span>
      <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="k">assert</span> <span class="bp">false</span>

  <span class="c">(* Delete a node from the ring structure. *)</span>
  <span class="k">method</span> <span class="n">delete_node</span> <span class="n">node</span> <span class="o">=</span>
    <span class="o">(</span><span class="k">match</span> <span class="n">node</span><span class="o">#</span><span class="n">prev</span> <span class="k">with</span>
       <span class="o">|</span> <span class="nc">Some</span> <span class="n">node_prev</span> <span class="o">-&gt;</span> <span class="n">node_prev</span><span class="o">#</span><span class="n">set_next</span> <span class="n">node</span><span class="o">#</span><span class="n">next</span>
       <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="k">assert</span> <span class="bp">false</span><span class="o">);</span>
    <span class="o">(</span><span class="k">match</span> <span class="n">node</span><span class="o">#</span><span class="n">next</span> <span class="k">with</span>
       <span class="o">|</span> <span class="nc">Some</span> <span class="n">node_next</span> <span class="o">-&gt;</span> <span class="n">node_next</span><span class="o">#</span><span class="n">set_prev</span> <span class="n">node</span><span class="o">#</span><span class="n">prev</span>
       <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="k">assert</span> <span class="bp">false</span><span class="o">);</span>
    <span class="n">count</span> <span class="o">&lt;-</span> <span class="n">count</span> <span class="o">-</span> <span class="mi">1</span>

  <span class="c">(* Delete a node from the ring structure by value. *)</span>
  <span class="k">method</span> <span class="n">delete_value</span> <span class="k">value</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">node</span> <span class="o">=</span> <span class="n">self</span><span class="o">#</span><span class="n">search</span> <span class="k">value</span> <span class="k">in</span>
    <span class="k">match</span> <span class="n">dummy</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">ring_dummy</span> <span class="k">when</span> <span class="n">node</span> <span class="o">!=</span> <span class="n">ring_dummy</span> <span class="o">-&gt;</span>
          <span class="n">self</span><span class="o">#</span><span class="n">delete_node</span> <span class="n">node</span>
      <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span>
<span class="k">end</span>

<span class="c">(* A node in the ring structure which contains a polymorphic value. *)</span>
<span class="ow">and</span> <span class="o">[</span><span class="k">&#39;</span><span class="n">a</span><span class="o">]</span> <span class="n">ring_node</span> <span class="bp">()</span> <span class="o">=</span> <span class="k">object</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">prev</span> <span class="o">=</span> <span class="o">(</span><span class="nc">None</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">ring_node</span> <span class="n">option</span><span class="o">)</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">next</span> <span class="o">=</span> <span class="o">(</span><span class="nc">None</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">ring_node</span> <span class="n">option</span><span class="o">)</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="k">value</span> <span class="o">=</span> <span class="o">(</span><span class="nc">None</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="n">option</span><span class="o">)</span>
  <span class="k">method</span> <span class="n">prev</span> <span class="o">=</span> <span class="n">prev</span>
  <span class="k">method</span> <span class="n">next</span> <span class="o">=</span> <span class="n">next</span>
  <span class="k">method</span> <span class="k">value</span> <span class="o">=</span> <span class="k">value</span>
  <span class="k">method</span> <span class="n">set_prev</span> <span class="n">prev&#39;</span> <span class="o">=</span> <span class="n">prev</span> <span class="o">&lt;-</span> <span class="n">prev&#39;</span>
  <span class="k">method</span> <span class="n">set_next</span> <span class="n">next&#39;</span> <span class="o">=</span> <span class="n">next</span> <span class="o">&lt;-</span> <span class="n">next&#39;</span>
  <span class="k">method</span> <span class="n">set_value</span> <span class="k">value&#39;</span> <span class="o">=</span> <span class="k">value</span> <span class="o">&lt;-</span> <span class="k">value&#39;</span>
<span class="k">end</span>

<span class="c">(* @@PLEAC@@_13.14 *)</span>
<span class="c">(* Create a class with &quot;compare_to&quot; and &quot;to_string&quot; methods. *)</span>
<span class="k">class</span> <span class="n">klass</span> <span class="n">name</span> <span class="n">idnum</span> <span class="o">=</span> <span class="k">object</span> <span class="o">(</span><span class="n">self</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">name</span> <span class="o">=</span> <span class="o">(</span><span class="n">name</span> <span class="o">:</span> <span class="kt">string</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">idnum</span> <span class="o">=</span> <span class="o">(</span><span class="n">idnum</span> <span class="o">:</span> <span class="kt">int</span><span class="o">)</span>

  <span class="k">method</span> <span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
  <span class="k">method</span> <span class="n">idnum</span> <span class="o">=</span> <span class="n">idnum</span>

  <span class="k">method</span> <span class="n">compare_to</span> <span class="o">(</span><span class="n">other</span> <span class="o">:</span> <span class="n">klass</span><span class="o">)</span> <span class="o">=</span>
    <span class="n">compare</span>
      <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">uppercase</span> <span class="n">self</span><span class="o">#</span><span class="n">name</span><span class="o">)</span>
      <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">uppercase</span> <span class="n">other</span><span class="o">#</span><span class="n">name</span><span class="o">)</span>

  <span class="k">method</span> <span class="n">to_string</span> <span class="o">=</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;%s (%05d)&quot;</span>
      <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">capitalize</span> <span class="n">self</span><span class="o">#</span><span class="n">name</span><span class="o">)</span>
      <span class="n">self</span><span class="o">#</span><span class="n">idnum</span>
<span class="k">end</span>

<span class="c">(* Define a comparison operator that invokes a &quot;compare_to&quot; method. *)</span>
<span class="k">let</span> <span class="o">(</span> <span class="o">&lt;=&gt;</span> <span class="o">)</span> <span class="n">o1</span> <span class="n">o2</span> <span class="o">=</span> <span class="o">(</span><span class="n">o1</span> <span class="o">#</span><span class="n">compare_to</span> <span class="n">o2</span> <span class="o">:</span> <span class="kt">int</span><span class="o">)</span>

<span class="c">(* Demonstrate these two methods. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">a</span> <span class="o">=</span> <span class="k">new</span> <span class="n">klass</span> <span class="s2">&quot;test1&quot;</span> <span class="mi">5</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="n">klass</span> <span class="s2">&quot;TEST2&quot;</span> <span class="mi">10</span> <span class="k">in</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">a</span> <span class="o">&lt;=&gt;</span> <span class="n">b</span><span class="o">);</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s</span><span class="se">\n</span><span class="s2">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">a</span><span class="o">#</span><span class="n">to_string</span> <span class="n">b</span><span class="o">#</span><span class="n">to_string</span>

<span class="c">(* Define a module to contain our time type. *)</span>
<span class="k">module</span> <span class="nc">TimeNumber</span> <span class="o">=</span> <span class="k">struct</span>

  <span class="c">(* TimeNumber.t contains the time values. *)</span>
  <span class="k">class</span> <span class="n">t</span> <span class="n">hours</span> <span class="n">minutes</span> <span class="n">seconds</span> <span class="o">=</span> <span class="k">object</span> <span class="o">(</span><span class="n">self</span><span class="o">)</span>
    <span class="k">val</span> <span class="k">mutable</span> <span class="n">hours</span> <span class="o">=</span> <span class="o">(</span><span class="n">hours</span> <span class="o">:</span> <span class="kt">int</span><span class="o">)</span>
    <span class="k">val</span> <span class="k">mutable</span> <span class="n">minutes</span> <span class="o">=</span> <span class="o">(</span><span class="n">minutes</span> <span class="o">:</span> <span class="kt">int</span><span class="o">)</span>
    <span class="k">val</span> <span class="k">mutable</span> <span class="n">seconds</span> <span class="o">=</span> <span class="o">(</span><span class="n">seconds</span> <span class="o">:</span> <span class="kt">int</span><span class="o">)</span>

    <span class="k">method</span> <span class="n">hours</span> <span class="o">=</span> <span class="n">hours</span>
    <span class="k">method</span> <span class="n">minutes</span> <span class="o">=</span> <span class="n">minutes</span>
    <span class="k">method</span> <span class="n">seconds</span> <span class="o">=</span> <span class="n">seconds</span>

    <span class="k">method</span> <span class="n">set_hours</span> <span class="n">hours&#39;</span> <span class="o">=</span> <span class="n">hours</span> <span class="o">&lt;-</span> <span class="n">hours&#39;</span>
    <span class="k">method</span> <span class="n">set_minutes</span> <span class="n">minutes&#39;</span> <span class="o">=</span> <span class="n">minutes</span> <span class="o">&lt;-</span> <span class="n">minutes&#39;</span>
    <span class="k">method</span> <span class="n">set_seconds</span> <span class="n">seconds&#39;</span> <span class="o">=</span> <span class="n">seconds</span> <span class="o">&lt;-</span> <span class="n">seconds&#39;</span>

    <span class="c">(* TimeNumber.t#add adds two times together. *)</span>
    <span class="k">method</span> <span class="n">add</span> <span class="o">(</span><span class="n">other</span> <span class="o">:</span> <span class="n">t</span><span class="o">)</span> <span class="o">=</span>
      <span class="k">let</span> <span class="n">answer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">t</span>
        <span class="o">(</span><span class="n">self</span><span class="o">#</span><span class="n">hours</span> <span class="o">+</span> <span class="n">other</span><span class="o">#</span><span class="n">hours</span><span class="o">)</span>
        <span class="o">(</span><span class="n">self</span><span class="o">#</span><span class="n">minutes</span> <span class="o">+</span> <span class="n">other</span><span class="o">#</span><span class="n">minutes</span><span class="o">)</span>
        <span class="o">(</span><span class="n">self</span><span class="o">#</span><span class="n">seconds</span> <span class="o">+</span> <span class="n">other</span><span class="o">#</span><span class="n">seconds</span><span class="o">)</span> <span class="k">in</span>
      <span class="k">if</span> <span class="n">answer</span><span class="o">#</span><span class="n">seconds</span> <span class="o">&gt;=</span> <span class="mi">60</span>
      <span class="k">then</span> <span class="o">(</span><span class="n">answer</span><span class="o">#</span><span class="n">set_seconds</span> <span class="o">(</span><span class="n">answer</span><span class="o">#</span><span class="n">seconds</span> <span class="ow">mod</span> <span class="mi">60</span><span class="o">);</span>
            <span class="n">answer</span><span class="o">#</span><span class="n">set_minutes</span> <span class="o">(</span><span class="n">answer</span><span class="o">#</span><span class="n">minutes</span> <span class="o">+</span> <span class="mi">1</span><span class="o">));</span>
      <span class="k">if</span> <span class="n">answer</span><span class="o">#</span><span class="n">minutes</span> <span class="o">&gt;=</span> <span class="mi">60</span>
      <span class="k">then</span> <span class="o">(</span><span class="n">answer</span><span class="o">#</span><span class="n">set_minutes</span> <span class="o">(</span><span class="n">answer</span><span class="o">#</span><span class="n">minutes</span> <span class="ow">mod</span> <span class="mi">60</span><span class="o">);</span>
            <span class="n">answer</span><span class="o">#</span><span class="n">set_hours</span> <span class="o">(</span><span class="n">answer</span><span class="o">#</span><span class="n">hours</span> <span class="o">+</span> <span class="mi">1</span><span class="o">));</span>
      <span class="n">answer</span>
  <span class="k">end</span>

  <span class="c">(* TimeNumber.Operators is a submodule that is designed to be</span>
<span class="c">     imported using &quot;open&quot;. It redefines the built-in arithmetic</span>
<span class="c">     operators to work on TimeNumber.t values. *)</span>
  <span class="k">module</span> <span class="nc">Operators</span> <span class="o">=</span> <span class="k">struct</span>
    <span class="k">let</span> <span class="o">(</span> <span class="o">+</span> <span class="o">)</span> <span class="o">(</span><span class="n">t1</span> <span class="o">:</span> <span class="n">t</span><span class="o">)</span> <span class="o">(</span><span class="n">t2</span> <span class="o">:</span> <span class="n">t</span><span class="o">)</span> <span class="o">=</span> <span class="n">t1</span> <span class="o">#</span><span class="n">add</span> <span class="n">t2</span>
    <span class="c">(* let ( - ) (t1 : t) (t2 : t) = t1 #sub t2 *)</span>
    <span class="c">(* let ( * ) (t1 : t) (t2 : t) = t1 #mult t2 *)</span>
    <span class="c">(* let ( / ) (t1 : t) (t2 : t) = t1 #div t2 *)</span>
  <span class="k">end</span>

<span class="k">end</span>

<span class="c">(* Globally import the custom operators. This will make them work on</span>
<span class="c">   TimeNumber.t values *only* - to do regular integer addition, you</span>
<span class="c">   will now have to use Pervasives.( + ) and so on. *)</span>
<span class="k">open</span> <span class="nn">TimeNumber</span><span class="p">.</span><span class="nc">Operators</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">TimeNumber</span><span class="p">.</span><span class="n">t</span> <span class="mi">2</span> <span class="mi">59</span> <span class="mi">59</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">TimeNumber</span><span class="p">.</span><span class="n">t</span> <span class="mi">1</span> <span class="mi">5</span> <span class="mi">6</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">t3</span> <span class="o">=</span> <span class="n">t1</span> <span class="o">+</span> <span class="n">t2</span> <span class="k">in</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%02d:%02d:%02d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">t3</span><span class="o">#</span><span class="n">hours</span> <span class="n">t3</span><span class="o">#</span><span class="n">minutes</span> <span class="n">t3</span><span class="o">#</span><span class="n">seconds</span>

<span class="c">(* Locally import the custom operators using a &quot;let module&quot;. The</span>
<span class="c">   operators will only be redefined within the &quot;Local&quot; module. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">TimeNumber</span><span class="p">.</span><span class="n">t</span> <span class="mi">2</span> <span class="mi">59</span> <span class="mi">59</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">TimeNumber</span><span class="p">.</span><span class="n">t</span> <span class="mi">1</span> <span class="mi">5</span> <span class="mi">6</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">t3</span> <span class="o">=</span>
    <span class="k">let</span> <span class="k">module</span> <span class="nc">Local</span> <span class="o">=</span> <span class="k">struct</span>
      <span class="k">open</span> <span class="nn">TimeNumber</span><span class="p">.</span><span class="nc">Operators</span>
      <span class="k">let</span> <span class="n">result</span> <span class="o">=</span> <span class="n">t1</span> <span class="o">+</span> <span class="n">t2</span>
    <span class="k">end</span> <span class="k">in</span> <span class="nn">Local</span><span class="p">.</span><span class="n">result</span> <span class="k">in</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%02d:%02d:%02d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">t3</span><span class="o">#</span><span class="n">hours</span> <span class="n">t3</span><span class="o">#</span><span class="n">minutes</span> <span class="n">t3</span><span class="o">#</span><span class="n">seconds</span>

<span class="c">(* The openin syntax extension can simplify the above technique.</span>
<span class="c">   openin is available at http://alain.frisch.fr/soft.html#openin *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">t1</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">TimeNumber</span><span class="p">.</span><span class="n">t</span> <span class="mi">2</span> <span class="mi">59</span> <span class="mi">59</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">t2</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">TimeNumber</span><span class="p">.</span><span class="n">t</span> <span class="mi">1</span> <span class="mi">5</span> <span class="mi">6</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">t3</span> <span class="o">=</span> <span class="k">open</span> <span class="nn">TimeNumber</span><span class="p">.</span><span class="nc">Operators</span> <span class="k">in</span> <span class="n">t1</span> <span class="o">+</span> <span class="n">t2</span> <span class="k">in</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%02d:%02d:%02d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">t3</span><span class="o">#</span><span class="n">hours</span> <span class="n">t3</span><span class="o">#</span><span class="n">minutes</span> <span class="n">t3</span><span class="o">#</span><span class="n">seconds</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* show_strnum - demo operator overloading *)</span>

<span class="k">class</span> <span class="n">strnum</span> <span class="k">value</span> <span class="o">=</span> <span class="k">object</span>
  <span class="k">method</span> <span class="k">value</span> <span class="o">=</span> <span class="k">value</span>
  <span class="k">method</span> <span class="n">spaceship</span> <span class="o">(</span><span class="n">other</span> <span class="o">:</span> <span class="n">strnum</span><span class="o">)</span> <span class="o">=</span> <span class="n">compare</span> <span class="k">value</span> <span class="o">(</span><span class="n">other</span><span class="o">#</span><span class="k">value</span><span class="o">)</span>
  <span class="k">method</span> <span class="n">concat</span> <span class="o">(</span><span class="n">other</span> <span class="o">:</span> <span class="n">strnum</span><span class="o">)</span> <span class="o">=</span> <span class="k">new</span> <span class="n">strnum</span> <span class="o">(</span><span class="k">value</span> <span class="o">^</span> <span class="n">other</span><span class="o">#</span><span class="k">value</span><span class="o">)</span>
  <span class="k">method</span> <span class="n">repeat</span> <span class="n">n</span> <span class="o">=</span> <span class="k">new</span> <span class="n">strnum</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span>
                                  <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">make</span> <span class="n">n</span> <span class="k">value</span><span class="o">)))</span>
<span class="k">end</span>

<span class="k">let</span> <span class="o">(</span>  <span class="o">+</span>  <span class="o">)</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">#</span><span class="n">concat</span> <span class="n">b</span>
<span class="k">let</span> <span class="o">(</span>  <span class="o">*</span>  <span class="o">)</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">#</span><span class="n">repeat</span> <span class="n">b</span>
<span class="k">let</span> <span class="o">(</span> <span class="o">&lt;=&gt;</span> <span class="o">)</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">#</span><span class="n">spaceship</span> <span class="n">b</span>
<span class="k">let</span> <span class="o">(</span>  <span class="o">&lt;</span>  <span class="o">)</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">&lt;=&gt;</span> <span class="n">b</span> <span class="o">&lt;</span> <span class="mi">0</span>
<span class="k">let</span> <span class="o">(</span> <span class="o">&lt;=</span>  <span class="o">)</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">&lt;=&gt;</span> <span class="n">b</span> <span class="o">&lt;=</span> <span class="mi">0</span>
<span class="k">let</span> <span class="o">(</span>  <span class="o">=</span>  <span class="o">)</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">&lt;=&gt;</span> <span class="n">b</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">let</span> <span class="o">(</span> <span class="o">&gt;=</span>  <span class="o">)</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">&lt;=&gt;</span> <span class="n">b</span> <span class="o">&gt;=</span> <span class="mi">0</span>
<span class="k">let</span> <span class="o">(</span>  <span class="o">&gt;</span>  <span class="o">)</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span> <span class="n">a</span> <span class="o">&lt;=&gt;</span> <span class="n">b</span> <span class="o">&gt;</span> <span class="mi">0</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">x</span> <span class="o">=</span> <span class="k">new</span> <span class="n">strnum</span> <span class="s2">&quot;Red&quot;</span>
<span class="k">let</span> <span class="n">y</span> <span class="o">=</span> <span class="k">new</span> <span class="n">strnum</span> <span class="s2">&quot;Black&quot;</span>
<span class="k">let</span> <span class="n">z</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">y</span>
<span class="k">let</span> <span class="n">r</span> <span class="o">=</span> <span class="n">z</span> <span class="o">*</span> <span class="mi">3</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;values are %s, %s, %s, and %s</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">x</span><span class="o">#</span><span class="k">value</span> <span class="n">y</span><span class="o">#</span><span class="k">value</span> <span class="n">z</span><span class="o">#</span><span class="k">value</span> <span class="n">r</span><span class="o">#</span><span class="k">value</span><span class="o">;</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s is %s %s</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">x</span><span class="o">#</span><span class="k">value</span> <span class="o">(</span><span class="k">if</span> <span class="n">x</span> <span class="o">&lt;</span> <span class="n">y</span> <span class="k">then</span> <span class="s2">&quot;LT&quot;</span> <span class="k">else</span> <span class="s2">&quot;GE&quot;</span><span class="o">)</span> <span class="n">y</span><span class="o">#</span><span class="k">value</span>

<span class="c">(*</span>
<span class="c">  values are Red, Black, RedBlack, and RedBlackRedBlackRedBlack</span>
<span class="c">  Red is GE Black</span>
<span class="c">*)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* demo_fixnum - show operator overloading *)</span>

<span class="k">module</span> <span class="nc">FixNum</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">let</span> <span class="n">default_places</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>
  <span class="k">class</span> <span class="n">t</span> <span class="o">?</span><span class="n">places</span> <span class="o">(</span><span class="k">value</span> <span class="o">:</span> <span class="kt">float</span><span class="o">)</span> <span class="o">=</span> <span class="k">object</span>
    <span class="k">val</span> <span class="k">mutable</span> <span class="n">places</span> <span class="o">=</span>
      <span class="k">match</span> <span class="n">places</span> <span class="k">with</span>
        <span class="o">|</span> <span class="nc">Some</span> <span class="n">n</span> <span class="o">-&gt;</span> <span class="n">n</span>
        <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="o">!</span><span class="n">default_places</span>
    <span class="k">val</span> <span class="k">value</span> <span class="o">=</span> <span class="k">value</span>
    <span class="k">method</span> <span class="n">places</span> <span class="o">=</span> <span class="n">places</span>
    <span class="k">method</span> <span class="n">set_places</span> <span class="n">n</span> <span class="o">=</span> <span class="n">places</span> <span class="o">&lt;-</span> <span class="n">n</span>
    <span class="k">method</span> <span class="k">value</span> <span class="o">=</span> <span class="k">value</span>
    <span class="k">method</span> <span class="n">to_string</span> <span class="o">=</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;FixNum.t: %.*f&quot;</span> <span class="n">places</span> <span class="k">value</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">let</span> <span class="o">(</span> <span class="o">+</span> <span class="o">)</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span>
  <span class="k">new</span> <span class="nn">FixNum</span><span class="p">.</span><span class="n">t</span> <span class="o">~</span><span class="n">places</span><span class="o">:(</span><span class="n">max</span> <span class="n">a</span><span class="o">#</span><span class="n">places</span> <span class="n">b</span><span class="o">#</span><span class="n">places</span><span class="o">)</span> <span class="o">(</span><span class="n">a</span><span class="o">#</span><span class="k">value</span> <span class="o">+.</span> <span class="n">b</span><span class="o">#</span><span class="k">value</span><span class="o">)</span>
<span class="k">let</span> <span class="o">(</span> <span class="o">-</span> <span class="o">)</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span>
  <span class="k">new</span> <span class="nn">FixNum</span><span class="p">.</span><span class="n">t</span> <span class="o">~</span><span class="n">places</span><span class="o">:(</span><span class="n">max</span> <span class="n">a</span><span class="o">#</span><span class="n">places</span> <span class="n">b</span><span class="o">#</span><span class="n">places</span><span class="o">)</span> <span class="o">(</span><span class="n">a</span><span class="o">#</span><span class="k">value</span> <span class="o">-.</span> <span class="n">b</span><span class="o">#</span><span class="k">value</span><span class="o">)</span>
<span class="k">let</span> <span class="o">(</span> <span class="o">*</span> <span class="o">)</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span>
  <span class="k">new</span> <span class="nn">FixNum</span><span class="p">.</span><span class="n">t</span> <span class="o">~</span><span class="n">places</span><span class="o">:(</span><span class="n">max</span> <span class="n">a</span><span class="o">#</span><span class="n">places</span> <span class="n">b</span><span class="o">#</span><span class="n">places</span><span class="o">)</span> <span class="o">(</span><span class="n">a</span><span class="o">#</span><span class="k">value</span> <span class="o">*.</span> <span class="n">b</span><span class="o">#</span><span class="k">value</span><span class="o">)</span>
<span class="k">let</span> <span class="o">(</span> <span class="o">/</span> <span class="o">)</span> <span class="n">a</span> <span class="n">b</span> <span class="o">=</span>
  <span class="k">new</span> <span class="nn">FixNum</span><span class="p">.</span><span class="n">t</span> <span class="o">~</span><span class="n">places</span><span class="o">:(</span><span class="n">max</span> <span class="n">a</span><span class="o">#</span><span class="n">places</span> <span class="n">b</span><span class="o">#</span><span class="n">places</span><span class="o">)</span> <span class="o">(</span><span class="n">a</span><span class="o">#</span><span class="k">value</span> <span class="o">/.</span> <span class="n">b</span><span class="o">#</span><span class="k">value</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* let () = FixNum.default_places := 5 *)</span>

<span class="k">let</span> <span class="n">x</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">FixNum</span><span class="p">.</span><span class="n">t</span> <span class="mi">40</span><span class="o">.</span>
<span class="k">let</span> <span class="n">y</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">FixNum</span><span class="p">.</span><span class="n">t</span> <span class="mi">12</span><span class="o">.</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;sum of %s and %s is %s</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">x</span><span class="o">#</span><span class="n">to_string</span> <span class="n">y</span><span class="o">#</span><span class="n">to_string</span> <span class="o">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="o">)#</span><span class="n">to_string</span><span class="o">;</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;product of %s and %s is %s</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">x</span><span class="o">#</span><span class="n">to_string</span> <span class="n">y</span><span class="o">#</span><span class="n">to_string</span> <span class="o">(</span><span class="n">x</span> <span class="o">*</span> <span class="n">y</span><span class="o">)#</span><span class="n">to_string</span>

<span class="k">let</span> <span class="n">z</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="n">y</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s has %d places</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">z</span><span class="o">#</span><span class="n">to_string</span> <span class="n">z</span><span class="o">#</span><span class="n">places</span><span class="o">;</span>
  <span class="k">if</span> <span class="n">z</span><span class="o">#</span><span class="n">places</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">then</span> <span class="n">z</span><span class="o">#</span><span class="n">set_places</span> <span class="mi">2</span><span class="o">;</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;div of %s by %s is %s</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">x</span><span class="o">#</span><span class="n">to_string</span> <span class="n">y</span><span class="o">#</span><span class="n">to_string</span> <span class="n">z</span><span class="o">#</span><span class="n">to_string</span><span class="o">;</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;square of that is %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">z</span> <span class="o">*</span> <span class="n">z</span><span class="o">)#</span><span class="n">to_string</span>

<span class="c">(*</span>
<span class="c">  sum of FixNum.t: 40 and FixNum.t: 12 is FixNum.t: 52</span>
<span class="c">  product of FixNum.t: 40 and FixNum.t: 12 is FixNum.t: 480</span>
<span class="c">  FixNum.t: 3 has 0 places</span>
<span class="c">  div of FixNum.t: 40 by FixNum.t: 12 is FixNum.t: 3.33</span>
<span class="c">  square of that is FixNum.t: 11.11</span>
<span class="c">*)</span>

<span class="c">(* @@PLEAC@@_13.15 *)</span>
<span class="c">(* OCaml does not have anything like Perl&#39;s &quot;tie&quot; feature; you can&#39;t</span>
<span class="c">   make an identifier evaluate to anything other than itself. Since</span>
<span class="c">   &quot;tie&quot; is just syntax sugar anyway, all of the examples can be done</span>
<span class="c">   with regular classes and objects. *)</span>

<span class="k">class</span> <span class="o">[</span><span class="k">&#39;</span><span class="n">a</span><span class="o">]</span> <span class="n">value_ring</span> <span class="n">values</span> <span class="o">=</span> <span class="k">object</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">values</span> <span class="o">=</span> <span class="o">(</span><span class="n">values</span> <span class="o">:</span> <span class="k">&#39;</span><span class="n">a</span> <span class="kt">list</span><span class="o">)</span>
  <span class="k">method</span> <span class="n">get</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">values</span> <span class="k">with</span>
      <span class="o">|</span> <span class="n">h</span> <span class="o">::</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="n">values</span> <span class="o">&lt;-</span> <span class="n">t</span> <span class="o">@</span> <span class="o">[</span><span class="n">h</span><span class="o">];</span> <span class="n">h</span>
      <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="k">raise</span> <span class="nc">Not_found</span>
  <span class="k">method</span> <span class="n">add</span> <span class="k">value</span> <span class="o">=</span>
    <span class="n">values</span> <span class="o">&lt;-</span> <span class="k">value</span> <span class="o">::</span> <span class="n">values</span>
<span class="k">end</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">colors</span> <span class="o">=</span> <span class="k">new</span> <span class="n">value_ring</span> <span class="o">[</span><span class="s2">&quot;red&quot;</span><span class="o">;</span> <span class="s2">&quot;blue&quot;</span><span class="o">]</span> <span class="k">in</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s %s %s %s %s %s</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">colors</span><span class="o">#</span><span class="n">get</span> <span class="n">colors</span><span class="o">#</span><span class="n">get</span> <span class="n">colors</span><span class="o">#</span><span class="n">get</span>
    <span class="n">colors</span><span class="o">#</span><span class="n">get</span> <span class="n">colors</span><span class="o">#</span><span class="n">get</span> <span class="n">colors</span><span class="o">#</span><span class="n">get</span><span class="o">;</span>
  <span class="c">(* blue red blue red blue red *)</span>

  <span class="n">colors</span><span class="o">#</span><span class="n">add</span> <span class="s2">&quot;green&quot;</span><span class="o">;</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s %s %s %s %s %s</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">colors</span><span class="o">#</span><span class="n">get</span> <span class="n">colors</span><span class="o">#</span><span class="n">get</span> <span class="n">colors</span><span class="o">#</span><span class="n">get</span>
    <span class="n">colors</span><span class="o">#</span><span class="n">get</span> <span class="n">colors</span><span class="o">#</span><span class="n">get</span> <span class="n">colors</span><span class="o">#</span><span class="n">get</span>
  <span class="c">(* blue red green blue red green *)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Magic hash that autoappends. *)</span>

<span class="k">class</span> <span class="o">[</span><span class="k">&#39;</span><span class="n">a</span><span class="o">,</span> <span class="k">&#39;</span><span class="n">b</span><span class="o">]</span> <span class="n">append_hash</span> <span class="n">size</span> <span class="o">=</span> <span class="k">object</span>
  <span class="k">val</span> <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="n">size</span> <span class="o">:</span> <span class="o">(</span><span class="k">&#39;</span><span class="n">a</span><span class="o">,</span> <span class="k">&#39;</span><span class="n">b</span><span class="o">)</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">t</span><span class="o">)</span>
  <span class="k">method</span> <span class="n">get</span> <span class="n">k</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">hash</span> <span class="n">k</span>
  <span class="k">method</span> <span class="n">set</span> <span class="n">k</span> <span class="n">v</span> <span class="o">=</span>
    <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">hash</span> <span class="n">k</span>
      <span class="o">(</span><span class="k">try</span> <span class="n">v</span> <span class="o">::</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">hash</span> <span class="n">k</span> <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="o">[</span><span class="n">v</span><span class="o">])</span>
  <span class="k">method</span> <span class="n">each</span> <span class="n">f</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span> <span class="n">f</span> <span class="n">hash</span>
<span class="k">end</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">tab</span> <span class="o">=</span> <span class="k">new</span> <span class="n">append_hash</span> <span class="mi">3</span> <span class="k">in</span>
  <span class="n">tab</span><span class="o">#</span><span class="n">set</span> <span class="s2">&quot;beer&quot;</span> <span class="s2">&quot;guinness&quot;</span><span class="o">;</span>
  <span class="n">tab</span><span class="o">#</span><span class="n">set</span> <span class="s2">&quot;food&quot;</span> <span class="s2">&quot;potatoes&quot;</span><span class="o">;</span>
  <span class="n">tab</span><span class="o">#</span><span class="n">set</span> <span class="s2">&quot;food&quot;</span> <span class="s2">&quot;peas&quot;</span><span class="o">;</span>
  <span class="n">tab</span><span class="o">#</span><span class="n">each</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">k</span> <span class="n">vs</span> <span class="o">-&gt;</span>
       <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s =&gt; [%s]</span><span class="se">\n</span><span class="s2">&quot;</span>
         <span class="n">k</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot; &quot;</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="n">vs</span><span class="o">)))</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(*</span>
<span class="c">  beer =&gt; [guinness]</span>
<span class="c">  food =&gt; [potatoes peas]</span>
<span class="c">*)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* For a more lightweight syntax, you can override the .{}</span>
<span class="c">   operator--which normally works with Bigarrays--to work on</span>
<span class="c">   any object with &quot;get&quot; and &quot;set&quot; methods. *)</span>

<span class="k">module</span> <span class="nc">Bigarray</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">module</span> <span class="nc">Array1</span> <span class="o">=</span> <span class="k">struct</span>
    <span class="k">let</span> <span class="n">get</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="o">#</span><span class="n">get</span>
    <span class="k">let</span> <span class="n">set</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="o">#</span><span class="n">set</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">tab</span> <span class="o">=</span> <span class="k">new</span> <span class="n">append_hash</span> <span class="mi">3</span> <span class="k">in</span>
  <span class="n">tab</span><span class="o">.{</span><span class="s2">&quot;beer&quot;</span><span class="o">}</span> <span class="o">&lt;-</span> <span class="s2">&quot;guinness&quot;</span><span class="o">;</span>
  <span class="n">tab</span><span class="o">.{</span><span class="s2">&quot;food&quot;</span><span class="o">}</span> <span class="o">&lt;-</span> <span class="s2">&quot;potatoes&quot;</span><span class="o">;</span>
  <span class="n">tab</span><span class="o">.{</span><span class="s2">&quot;food&quot;</span><span class="o">}</span> <span class="o">&lt;-</span> <span class="s2">&quot;peas&quot;</span><span class="o">;</span>
  <span class="n">tab</span><span class="o">#</span><span class="n">each</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">k</span> <span class="n">vs</span> <span class="o">-&gt;</span>
       <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s =&gt; [%s]</span><span class="se">\n</span><span class="s2">&quot;</span>
         <span class="n">k</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot; &quot;</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="n">vs</span><span class="o">)));</span>
  <span class="n">print_endline</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">hd</span> <span class="n">tab</span><span class="o">.{</span><span class="s2">&quot;beer&quot;</span><span class="o">})</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Hash that magically folds case. *)</span>

<span class="k">class</span> <span class="o">[</span><span class="k">&#39;</span><span class="n">a</span><span class="o">]</span> <span class="n">folded_hash</span> <span class="n">size</span> <span class="o">=</span> <span class="k">object</span>
  <span class="k">val</span> <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="n">size</span> <span class="o">:</span> <span class="o">(</span><span class="kt">string</span><span class="o">,</span> <span class="k">&#39;</span><span class="n">a</span><span class="o">)</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">t</span><span class="o">)</span>
  <span class="k">method</span> <span class="n">get</span> <span class="n">k</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">hash</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">lowercase</span> <span class="n">k</span><span class="o">)</span>
  <span class="k">method</span> <span class="n">set</span> <span class="n">k</span> <span class="n">v</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">hash</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">lowercase</span> <span class="n">k</span><span class="o">)</span> <span class="n">v</span>
  <span class="k">method</span> <span class="n">each</span> <span class="n">f</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span> <span class="n">f</span> <span class="n">hash</span>
<span class="k">end</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">tab</span> <span class="o">=</span> <span class="k">new</span> <span class="n">folded_hash</span> <span class="mi">2</span> <span class="k">in</span>
  <span class="n">tab</span><span class="o">.{</span><span class="s2">&quot;VILLAIN&quot;</span><span class="o">}</span> <span class="o">&lt;-</span> <span class="s2">&quot;big &quot;</span><span class="o">;</span>
  <span class="n">tab</span><span class="o">.{</span><span class="s2">&quot;herOine&quot;</span><span class="o">}</span> <span class="o">&lt;-</span> <span class="s2">&quot;red riding hood&quot;</span><span class="o">;</span>
  <span class="n">tab</span><span class="o">.{</span><span class="s2">&quot;villain&quot;</span><span class="o">}</span> <span class="o">&lt;-</span> <span class="n">tab</span><span class="o">.{</span><span class="s2">&quot;villain&quot;</span><span class="o">}</span> <span class="o">^</span> <span class="s2">&quot;bad wolf&quot;</span><span class="o">;</span>
  <span class="n">tab</span><span class="o">#</span><span class="n">each</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s is %s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span>

<span class="c">(*</span>
<span class="c">  heroine is red riding hood</span>
<span class="c">  villain is big bad wolf</span>
<span class="c">*)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Hash that permits key *or* value lookups. *)</span>
<span class="k">class</span> <span class="o">[</span><span class="k">&#39;</span><span class="n">a</span><span class="o">]</span> <span class="n">rev_hash</span> <span class="n">size</span> <span class="o">=</span> <span class="k">object</span>
  <span class="k">val</span> <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="n">size</span> <span class="o">:</span> <span class="o">(</span><span class="k">&#39;</span><span class="n">a</span><span class="o">,</span> <span class="k">&#39;</span><span class="n">a</span><span class="o">)</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">t</span><span class="o">)</span>
  <span class="k">method</span> <span class="n">get</span> <span class="n">k</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">hash</span> <span class="n">k</span>
  <span class="k">method</span> <span class="n">set</span> <span class="n">k</span> <span class="n">v</span> <span class="o">=</span>
    <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">hash</span> <span class="n">k</span> <span class="n">v</span><span class="o">;</span>
    <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">hash</span> <span class="n">v</span> <span class="n">k</span>
  <span class="k">method</span> <span class="n">each</span> <span class="n">f</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span> <span class="n">f</span> <span class="n">hash</span>
<span class="k">end</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">tab</span> <span class="o">=</span> <span class="k">new</span> <span class="n">rev_hash</span> <span class="mi">8</span> <span class="k">in</span>
  <span class="n">tab</span><span class="o">.{`</span><span class="nc">Str</span> <span class="s2">&quot;Red&quot;</span><span class="o">}</span> <span class="o">&lt;-</span> <span class="o">`</span><span class="nc">Str</span> <span class="s2">&quot;Rojo&quot;</span><span class="o">;</span>
  <span class="n">tab</span><span class="o">.{`</span><span class="nc">Str</span> <span class="s2">&quot;Blue&quot;</span><span class="o">}</span> <span class="o">&lt;-</span> <span class="o">`</span><span class="nc">Str</span> <span class="s2">&quot;Azul&quot;</span><span class="o">;</span>
  <span class="n">tab</span><span class="o">.{`</span><span class="nc">Str</span> <span class="s2">&quot;Green&quot;</span><span class="o">}</span> <span class="o">&lt;-</span> <span class="o">`</span><span class="nc">Str</span> <span class="s2">&quot;Verde&quot;</span><span class="o">;</span>
  <span class="n">tab</span><span class="o">.{`</span><span class="nc">Str</span> <span class="s2">&quot;EVIL&quot;</span><span class="o">}</span> <span class="o">&lt;-</span> <span class="o">`</span><span class="nc">StrList</span> <span class="o">[</span> <span class="s2">&quot;No way!&quot;</span><span class="o">;</span> <span class="s2">&quot;Way!!&quot;</span> <span class="o">];</span>
  <span class="k">let</span> <span class="n">to_string</span> <span class="o">=</span> <span class="k">function</span>
    <span class="o">|</span> <span class="o">`</span><span class="nc">Str</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">s</span>
    <span class="o">|</span> <span class="o">`</span><span class="nc">StrList</span> <span class="n">ss</span> <span class="o">-&gt;</span> <span class="s2">&quot;[&quot;</span> <span class="o">^</span> <span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot; &quot;</span> <span class="n">ss</span> <span class="o">^</span> <span class="s2">&quot;]&quot;</span> <span class="k">in</span>
  <span class="n">tab</span><span class="o">#</span><span class="n">each</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">k</span> <span class="n">v</span> <span class="o">-&gt;</span>
       <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s =&gt; %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">to_string</span> <span class="n">k</span><span class="o">)</span> <span class="o">(</span><span class="n">to_string</span> <span class="n">v</span><span class="o">))</span>

<span class="c">(*</span>
<span class="c">  Verde =&gt; Green</span>
<span class="c">  Azul =&gt; Blue</span>
<span class="c">  Green =&gt; Verde</span>
<span class="c">  Blue =&gt; Azul</span>
<span class="c">  Red =&gt; Rojo</span>
<span class="c">  [No way! Way!!] =&gt; EVIL</span>
<span class="c">  EVIL =&gt; [No way! Way!!]</span>
<span class="c">  Rojo =&gt; Red</span>
<span class="c">*)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Simple counter. *)</span>

<span class="k">class</span> <span class="n">counter</span> <span class="n">start</span> <span class="o">=</span> <span class="k">object</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="k">value</span> <span class="o">=</span> <span class="o">(</span><span class="n">start</span> <span class="o">:</span> <span class="kt">int</span><span class="o">)</span>
  <span class="k">method</span> <span class="n">next</span> <span class="o">=</span> <span class="k">value</span> <span class="o">&lt;-</span> <span class="k">value</span> <span class="o">+</span> <span class="mi">1</span><span class="o">;</span> <span class="k">value</span>
<span class="k">end</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">c</span> <span class="o">=</span> <span class="k">new</span> <span class="n">counter</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Got %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">c</span><span class="o">#</span><span class="n">next</span>
  <span class="k">done</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Tee-like class that outputs to multiple channels at once. *)</span>

<span class="k">class</span> <span class="n">tee</span> <span class="n">channels</span> <span class="o">=</span> <span class="k">object</span>
  <span class="k">method</span> <span class="n">print</span> <span class="n">s</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">ch</span> <span class="o">-&gt;</span> <span class="n">output_string</span> <span class="n">ch</span> <span class="n">s</span><span class="o">)</span> <span class="n">channels</span>
<span class="k">end</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">tee</span> <span class="o">=</span> <span class="k">new</span> <span class="n">tee</span> <span class="o">[</span><span class="n">stdout</span><span class="o">;</span> <span class="n">stderr</span><span class="o">]</span> <span class="k">in</span>
  <span class="n">tee</span><span class="o">#</span><span class="n">print</span> <span class="s2">&quot;This line goes to both places.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
  <span class="n">flush_all</span> <span class="bp">()</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">tee</span> <span class="o">=</span> <span class="k">new</span> <span class="n">tee</span>
    <span class="o">(</span><span class="n">stdout</span> <span class="o">::</span>
       <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span>
          <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">init</span> <span class="mi">10</span>
             <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span>
                <span class="n">snd</span> <span class="o">(</span><span class="nn">Filename</span><span class="p">.</span><span class="n">open_temp_file</span> <span class="s2">&quot;teetest.&quot;</span> <span class="s2">&quot;&quot;</span><span class="o">)))))</span> <span class="k">in</span>
  <span class="n">tee</span><span class="o">#</span><span class="n">print</span> <span class="s2">&quot;This lines goes many places.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
  <span class="n">flush_all</span> <span class="bp">()</span>


<span class="c">(* @@PLEAC@@_14.0 *)</span>
<span class="c">(* OCaml&#39;s standard library includes bindings to the NDBM database.</span>
<span class="c">   Bindings to other database systems can be found on the web. *)</span>

<span class="nc">MySQL</span><span class="o">:</span>
<span class="n">http</span><span class="o">://</span><span class="n">raevnos</span><span class="o">.</span><span class="n">pennmush</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">code</span><span class="o">/</span><span class="n">ocaml</span><span class="o">-</span><span class="n">mysql</span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">html</span>

<span class="nc">PostgreSQL</span><span class="o">:</span>
<span class="n">http</span><span class="o">://</span><span class="n">www</span><span class="o">.</span><span class="n">ocaml</span><span class="o">.</span><span class="n">info</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">ocaml_sources</span><span class="o">.</span><span class="n">html</span><span class="o">#</span><span class="n">postgresql</span><span class="o">-</span><span class="n">ocaml</span>

<span class="nc">SQLite</span><span class="o">:</span>
<span class="n">http</span><span class="o">://</span><span class="n">www</span><span class="o">.</span><span class="n">ocaml</span><span class="o">.</span><span class="n">info</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">ocaml_sources</span><span class="o">.</span><span class="n">html</span><span class="o">#</span><span class="n">ocaml</span><span class="o">-</span><span class="n">sqlite3</span>

<span class="c">(* @@PLEAC@@_14.1 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;dbm.cma&quot;</span><span class="o">;;</span>

<span class="c">(* open database *)</span>
<span class="k">let</span> <span class="n">db</span> <span class="o">=</span> <span class="nn">Dbm</span><span class="p">.</span><span class="n">opendbm</span> <span class="n">filename</span> <span class="o">[</span><span class="nn">Dbm</span><span class="p">.</span><span class="nc">Dbm_rdwr</span><span class="o">;</span> <span class="nn">Dbm</span><span class="p">.</span><span class="nc">Dbm_create</span><span class="o">]</span> <span class="mo">0o666</span>

<span class="c">(* retrieve from database *)</span>
<span class="k">let</span> <span class="n">v</span> <span class="o">=</span> <span class="nn">Dbm</span><span class="p">.</span><span class="n">find</span> <span class="n">db</span> <span class="n">key</span>

<span class="c">(* put value into database *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Dbm</span><span class="p">.</span><span class="n">replace</span> <span class="n">db</span> <span class="n">key</span> <span class="k">value</span>

<span class="c">(* check whether in database *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="n">ignore</span> <span class="o">(</span><span class="nn">Dbm</span><span class="p">.</span><span class="n">find</span> <span class="n">db</span> <span class="n">key</span><span class="o">);</span>
    <span class="c">(* ... *)</span>
    <span class="bp">()</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
    <span class="c">(* ... *)</span>
    <span class="bp">()</span>

<span class="c">(* delete from database *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Dbm</span><span class="p">.</span><span class="n">remove</span> <span class="n">db</span> <span class="n">key</span>

<span class="c">(* close the database *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Dbm</span><span class="p">.</span><span class="n">close</span> <span class="n">db</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* userstats - generates statistics on who is logged in. *)</span>
<span class="c">(* call with an argument to display totals *)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;dbm.cma&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">db_file</span> <span class="o">=</span> <span class="s2">&quot;/tmp/userstats.db&quot;</span>  <span class="c">(* where data is kept between runs *)</span>
<span class="k">let</span> <span class="n">db</span> <span class="o">=</span> <span class="nn">Dbm</span><span class="p">.</span><span class="n">opendbm</span> <span class="n">db_file</span> <span class="o">[</span><span class="nn">Dbm</span><span class="p">.</span><span class="nc">Dbm_rdwr</span><span class="o">;</span> <span class="nn">Dbm</span><span class="p">.</span><span class="nc">Dbm_create</span><span class="o">]</span> <span class="mo">0o666</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="o">&gt;</span> <span class="mi">1</span>
  <span class="k">then</span>
    <span class="k">begin</span>
      <span class="k">let</span> <span class="n">sort</span> <span class="n">a</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">sort</span> <span class="n">compare</span> <span class="n">a</span><span class="o">;</span> <span class="n">a</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">keys</span> <span class="n">db</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">of_list</span>
        <span class="o">(</span><span class="k">let</span> <span class="n">accu</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
         <span class="nn">Dbm</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">key</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">accu</span> <span class="o">:=</span> <span class="n">key</span> <span class="o">::</span> <span class="o">!</span><span class="n">accu</span><span class="o">)</span> <span class="n">db</span><span class="o">;</span>
         <span class="o">!</span><span class="n">accu</span><span class="o">)</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">users</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">sub</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="mi">1</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">users</span> <span class="o">=</span> <span class="k">if</span> <span class="n">users</span> <span class="o">=</span> <span class="o">[|</span><span class="s2">&quot;ALL&quot;</span><span class="o">|]</span> <span class="k">then</span> <span class="n">sort</span> <span class="o">(</span><span class="n">keys</span> <span class="n">db</span><span class="o">)</span> <span class="k">else</span> <span class="n">users</span> <span class="k">in</span>
      <span class="nn">Array</span><span class="p">.</span><span class="n">iter</span>
        <span class="o">(</span><span class="k">fun</span> <span class="n">user</span> <span class="o">-&gt;</span>
           <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s</span><span class="se">\t</span><span class="s2">%s</span><span class="se">\n</span><span class="s2">&quot;</span>
             <span class="n">user</span> <span class="o">(</span><span class="k">try</span> <span class="nn">Dbm</span><span class="p">.</span><span class="n">find</span> <span class="n">db</span> <span class="n">user</span> <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="s2">&quot;&quot;</span><span class="o">))</span>
        <span class="n">users</span>
    <span class="k">end</span>
  <span class="k">else</span>
    <span class="k">begin</span>
      <span class="k">let</span> <span class="n">who</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_in</span> <span class="s2">&quot;who&quot;</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[ </span><span class="se">\t</span><span class="s2">]+&quot;</span> <span class="k">in</span>
      <span class="k">try</span>
        <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
          <span class="c">(* extract username (first thing on the line) and update *)</span>
          <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">who</span> <span class="k">in</span>
          <span class="k">let</span> <span class="n">user</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">hd</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">split_delim</span> <span class="n">regexp</span> <span class="n">line</span><span class="o">)</span> <span class="k">in</span>
          <span class="k">let</span> <span class="n">count</span> <span class="o">=</span>
            <span class="k">try</span> <span class="n">int_of_string</span> <span class="o">(</span><span class="nn">Dbm</span><span class="p">.</span><span class="n">find</span> <span class="n">db</span> <span class="n">user</span><span class="o">)</span>
            <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="mi">0</span> <span class="k">in</span>
          <span class="nn">Dbm</span><span class="p">.</span><span class="n">replace</span> <span class="n">db</span> <span class="n">user</span> <span class="o">(</span><span class="n">string_of_int</span> <span class="o">(</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="o">))</span>
        <span class="k">done</span>
      <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
        <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_in</span> <span class="n">who</span><span class="o">)</span>
    <span class="k">end</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Dbm</span><span class="p">.</span><span class="n">close</span> <span class="n">db</span>

<span class="c">(* @@PLEAC@@_14.2 *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">db</span> <span class="o">=</span> <span class="nn">Dbm</span><span class="p">.</span><span class="n">opendbm</span> <span class="n">filename</span> <span class="o">[</span><span class="nn">Dbm</span><span class="p">.</span><span class="nc">Dbm_rdwr</span><span class="o">;</span> <span class="nn">Dbm</span><span class="p">.</span><span class="nc">Dbm_create</span><span class="o">]</span> <span class="mo">0o666</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">keys</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
    <span class="nn">Dbm</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">key</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">keys</span> <span class="o">:=</span> <span class="n">key</span> <span class="o">::</span> <span class="o">!</span><span class="n">keys</span><span class="o">)</span> <span class="n">db</span><span class="o">;</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="nn">Dbm</span><span class="p">.</span><span class="n">remove</span> <span class="n">db</span><span class="o">)</span> <span class="o">!</span><span class="n">keys</span><span class="o">;</span>
    <span class="nn">Dbm</span><span class="p">.</span><span class="n">close</span> <span class="n">db</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Sys</span><span class="p">.</span><span class="n">remove</span> <span class="n">filename</span><span class="o">;</span>
  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Dbm</span><span class="p">.</span><span class="n">opendbm</span> <span class="n">filename</span> <span class="o">[</span><span class="nn">Dbm</span><span class="p">.</span><span class="nc">Dbm_rdwr</span><span class="o">;</span> <span class="nn">Dbm</span><span class="p">.</span><span class="nc">Dbm_create</span><span class="o">]</span> <span class="mo">0o666</span><span class="o">)</span>

<span class="c">(* @@PLEAC@@_14.3 *)</span>
<span class="c">(* OCaml does not come with support for any DBM-style databases other</span>
<span class="c">   than NDBM, and no third-party libraries appear to be available. *)</span>

<span class="c">(* @@PLEAC@@_14.4 *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Dbm</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="nn">Dbm</span><span class="p">.</span><span class="n">replace</span> <span class="n">output</span><span class="o">)</span> <span class="n">input</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Dbm</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">key</span> <span class="k">value</span> <span class="o">-&gt;</span>
       <span class="k">try</span>
         <span class="k">let</span> <span class="n">existing</span> <span class="o">=</span> <span class="nn">Dbm</span><span class="p">.</span><span class="n">find</span> <span class="n">output</span> <span class="n">key</span> <span class="k">value</span> <span class="k">in</span>
         <span class="c">(* decide which value to use and replace if necessary *)</span>
         <span class="bp">()</span>
       <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
         <span class="nn">Dbm</span><span class="p">.</span><span class="n">replace</span> <span class="n">output</span> <span class="n">key</span> <span class="k">value</span><span class="o">)</span>
    <span class="n">input</span>

<span class="c">(* @@PLEAC@@_14.5 *)</span>
<span class="c">(* dblockdemo - demo locking dbm databases *)</span>
<span class="c">(* Thanks to Janne Hellsten for posting sample code on caml-list! *)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;dbm.cma&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">db_file</span> <span class="o">=</span> <span class="s2">&quot;/tmp/foo.db&quot;</span>
<span class="k">let</span> <span class="n">lock_file</span> <span class="o">=</span> <span class="s2">&quot;/tmp/foo.lock&quot;</span>

<span class="k">let</span> <span class="n">key</span> <span class="o">=</span> <span class="k">try</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span> <span class="k">with</span> <span class="nc">Invalid_argument</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="s2">&quot;default&quot;</span>
<span class="k">let</span> <span class="k">value</span> <span class="o">=</span> <span class="k">try</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">2</span><span class="o">)</span> <span class="k">with</span> <span class="nc">Invalid_argument</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="s2">&quot;magic&quot;</span>
<span class="k">let</span> <span class="k">value</span> <span class="o">=</span> <span class="k">value</span> <span class="o">^</span> <span class="s2">&quot; &quot;</span> <span class="o">^</span> <span class="o">(</span><span class="n">string_of_int</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">getpid</span> <span class="bp">()</span><span class="o">))</span>

<span class="k">let</span> <span class="n">finally</span> <span class="n">handler</span> <span class="n">f</span> <span class="n">x</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">result</span> <span class="o">=</span> <span class="k">try</span> <span class="n">f</span> <span class="n">x</span> <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">handler</span> <span class="bp">()</span><span class="o">;</span> <span class="k">raise</span> <span class="n">e</span> <span class="k">in</span> <span class="n">handler</span> <span class="bp">()</span><span class="o">;</span> <span class="n">result</span>

<span class="k">let</span> <span class="n">create_lock</span> <span class="n">name</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="n">file_exists</span> <span class="n">name</span><span class="o">)</span> <span class="k">then</span>
    <span class="k">let</span> <span class="n">out_channel</span> <span class="o">=</span> <span class="n">open_out</span> <span class="n">name</span> <span class="k">in</span> <span class="n">close_out</span> <span class="n">out_channel</span>

<span class="k">let</span> <span class="n">with_lock</span> <span class="n">name</span> <span class="n">command</span> <span class="n">f</span> <span class="o">=</span>
  <span class="n">create_lock</span> <span class="n">name</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">fd</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">openfile</span> <span class="n">name</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">O_RDWR</span><span class="o">]</span> <span class="mo">0o660</span> <span class="k">in</span>
  <span class="n">finally</span>
    <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="n">fd</span><span class="o">)</span>
    <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">lockf</span> <span class="n">fd</span> <span class="n">command</span> <span class="mi">0</span><span class="o">;</span> <span class="n">f</span> <span class="bp">()</span><span class="o">)</span> <span class="bp">()</span>

<span class="k">let</span> <span class="n">create_db</span> <span class="n">name</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="n">file_exists</span> <span class="o">(</span><span class="n">name</span> <span class="o">^</span> <span class="s2">&quot;.dir&quot;</span><span class="o">))</span> <span class="k">then</span>
    <span class="k">let</span> <span class="n">db</span> <span class="o">=</span> <span class="nn">Dbm</span><span class="p">.</span><span class="n">opendbm</span> <span class="n">name</span> <span class="o">[</span><span class="nn">Dbm</span><span class="p">.</span><span class="nc">Dbm_rdwr</span><span class="o">;</span> <span class="nn">Dbm</span><span class="p">.</span><span class="nc">Dbm_create</span><span class="o">]</span> <span class="mo">0o660</span> <span class="k">in</span>
    <span class="nn">Dbm</span><span class="p">.</span><span class="n">close</span> <span class="n">db</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">create_db</span> <span class="n">db_file</span><span class="o">;</span>

  <span class="k">let</span> <span class="n">do_read</span> <span class="bp">()</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">db</span> <span class="o">=</span> <span class="nn">Dbm</span><span class="p">.</span><span class="n">opendbm</span> <span class="n">db_file</span> <span class="o">[</span><span class="nn">Dbm</span><span class="p">.</span><span class="nc">Dbm_rdonly</span><span class="o">]</span> <span class="mo">0o660</span> <span class="k">in</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%d: Read lock granted</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">getpid</span> <span class="bp">()</span><span class="o">);</span>
    <span class="n">flush</span> <span class="n">stdout</span><span class="o">;</span>
    <span class="k">let</span> <span class="n">oldval</span> <span class="o">=</span> <span class="k">try</span> <span class="nn">Dbm</span><span class="p">.</span><span class="n">find</span> <span class="n">db</span> <span class="n">key</span> <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="s2">&quot;&quot;</span> <span class="k">in</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%d: Old value was %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">getpid</span> <span class="bp">()</span><span class="o">)</span> <span class="n">oldval</span><span class="o">;</span>
    <span class="n">flush</span> <span class="n">stdout</span><span class="o">;</span>
    <span class="nn">Dbm</span><span class="p">.</span><span class="n">close</span> <span class="n">db</span> <span class="k">in</span>

  <span class="k">let</span> <span class="n">do_write</span> <span class="bp">()</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">db</span> <span class="o">=</span> <span class="nn">Dbm</span><span class="p">.</span><span class="n">opendbm</span> <span class="n">db_file</span> <span class="o">[</span><span class="nn">Dbm</span><span class="p">.</span><span class="nc">Dbm_rdwr</span><span class="o">]</span> <span class="mo">0o660</span> <span class="k">in</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%d: Write lock granted</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">getpid</span> <span class="bp">()</span><span class="o">);</span>
    <span class="n">flush</span> <span class="n">stdout</span><span class="o">;</span>
    <span class="nn">Dbm</span><span class="p">.</span><span class="n">replace</span> <span class="n">db</span> <span class="n">key</span> <span class="k">value</span><span class="o">;</span>
    <span class="nn">Unix</span><span class="p">.</span><span class="n">sleep</span> <span class="mi">10</span><span class="o">;</span>
    <span class="nn">Dbm</span><span class="p">.</span><span class="n">close</span> <span class="n">db</span> <span class="k">in</span>

  <span class="k">begin</span>
    <span class="k">try</span>
      <span class="n">with_lock</span> <span class="n">lock_file</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">F_TRLOCK</span> <span class="n">do_read</span><span class="o">;</span>
    <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="n">error</span><span class="o">,</span> <span class="s2">&quot;lockf&quot;</span><span class="o">,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%d: CONTENTION; can&#39;t read during write update! \</span>
<span class="s2">                         Waiting for read lock (%s) ...</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">getpid</span> <span class="bp">()</span><span class="o">)</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">error_message</span> <span class="n">error</span><span class="o">);</span>
      <span class="n">flush</span> <span class="n">stdout</span><span class="o">;</span>
      <span class="n">with_lock</span> <span class="n">lock_file</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">F_RLOCK</span> <span class="n">do_read</span>
  <span class="k">end</span><span class="o">;</span>

  <span class="k">begin</span>
    <span class="k">try</span>
      <span class="n">with_lock</span> <span class="n">lock_file</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">F_TLOCK</span> <span class="n">do_write</span><span class="o">;</span>
    <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="n">error</span><span class="o">,</span> <span class="s2">&quot;lockf&quot;</span><span class="o">,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%d: CONTENTION; must have exclusive lock! \</span>
<span class="s2">                         Waiting for write lock (%s) ...</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">getpid</span> <span class="bp">()</span><span class="o">)</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">error_message</span> <span class="n">error</span><span class="o">);</span>
      <span class="n">flush</span> <span class="n">stdout</span><span class="o">;</span>
      <span class="n">with_lock</span> <span class="n">lock_file</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">F_LOCK</span> <span class="n">do_write</span>
  <span class="k">end</span><span class="o">;</span>

  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%d: Updated db to %s=%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">getpid</span> <span class="bp">()</span><span class="o">)</span> <span class="n">key</span> <span class="k">value</span>

<span class="c">(* @@PLEAC@@_14.6 *)</span>
<span class="c">(* OCaml&#39;s Dbm module does not provide any mechanism for a custom</span>
<span class="c">   comparison function. If you need the keys in a particular order</span>
<span class="c">   you can load them into memory and use List.sort, Array.sort, or</span>
<span class="c">   a Set. This may not be practical for very large data sets. *)</span>

<span class="c">(* @@PLEAC@@_14.7 *)</span>
<span class="k">let</span> <span class="n">with_lines_in_file</span> <span class="n">name</span> <span class="n">f</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="n">file_exists</span> <span class="n">name</span><span class="o">)</span>
  <span class="k">then</span> <span class="o">(</span><span class="k">let</span> <span class="n">out_channel</span> <span class="o">=</span> <span class="n">open_out</span> <span class="n">name</span> <span class="k">in</span> <span class="n">close_out</span> <span class="n">out_channel</span><span class="o">);</span>

  <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span> <span class="n">open_in</span> <span class="n">name</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">in_lines</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="k">begin</span>
    <span class="k">try</span>
      <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
        <span class="n">in_lines</span> <span class="o">:=</span> <span class="n">input_line</span> <span class="n">in_channel</span> <span class="o">::</span> <span class="o">!</span><span class="n">in_lines</span>
      <span class="k">done</span>
    <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
      <span class="n">close_in</span> <span class="n">in_channel</span>
  <span class="k">end</span><span class="o">;</span>

  <span class="k">let</span> <span class="n">out_lines</span> <span class="o">=</span> <span class="n">f</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="o">!</span><span class="n">in_lines</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">out_channel</span> <span class="o">=</span> <span class="n">open_out</span> <span class="n">name</span> <span class="k">in</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span>
       <span class="n">output_string</span> <span class="n">out_channel</span> <span class="n">line</span><span class="o">;</span>
       <span class="n">output_string</span> <span class="n">out_channel</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span>
    <span class="n">out_lines</span><span class="o">;</span>
  <span class="n">flush</span> <span class="n">out_channel</span><span class="o">;</span>
  <span class="n">close_out</span> <span class="n">out_channel</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* first create a text file to play with *)</span>
  <span class="n">with_lines_in_file</span> <span class="s2">&quot;/tmp/textfile&quot;</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">lines</span> <span class="o">-&gt;</span>
       <span class="o">[</span><span class="s2">&quot;zero&quot;</span><span class="o">;</span> <span class="s2">&quot;one&quot;</span><span class="o">;</span> <span class="s2">&quot;two&quot;</span><span class="o">;</span> <span class="s2">&quot;three&quot;</span><span class="o">;</span> <span class="s2">&quot;four&quot;</span><span class="o">]);</span>

  <span class="n">with_lines_in_file</span> <span class="s2">&quot;/tmp/textfile&quot;</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">lines</span> <span class="o">-&gt;</span>
       <span class="c">(* print the records in order. *)</span>
       <span class="n">print_endline</span> <span class="s2">&quot;ORIGINAL</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
       <span class="nn">Array</span><span class="p">.</span><span class="n">iteri</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%d: %s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">of_list</span> <span class="n">lines</span><span class="o">);</span>

       <span class="c">(* operate on the end of the list *)</span>
       <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="n">lines</span> <span class="k">in</span>
       <span class="k">let</span> <span class="n">a</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">hd</span> <span class="n">lines</span> <span class="k">in</span>
       <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="o">(</span><span class="s2">&quot;last&quot;</span> <span class="o">::</span> <span class="n">lines</span><span class="o">)</span> <span class="k">in</span>
       <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The last record was [%s]</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">a</span><span class="o">;</span>

       <span class="c">(* and the beginning of the list *)</span>
       <span class="k">let</span> <span class="n">a</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">hd</span> <span class="n">lines</span> <span class="k">in</span>
       <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="s2">&quot;first&quot;</span> <span class="o">::</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">tl</span> <span class="n">lines</span><span class="o">)</span> <span class="k">in</span>
       <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">The first record was [%s]</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">a</span><span class="o">;</span>

       <span class="c">(* remove the record &quot;four&quot; *)</span>
       <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span>
         <span class="nn">List</span><span class="p">.</span><span class="n">filter</span> <span class="o">(</span><span class="k">function</span> <span class="s2">&quot;four&quot;</span> <span class="o">-&gt;</span> <span class="bp">false</span> <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">true</span><span class="o">)</span> <span class="n">lines</span> <span class="k">in</span>

       <span class="c">(* replace the record &quot;two&quot; with &quot;Newbie&quot; *)</span>
       <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span>
         <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">function</span> <span class="s2">&quot;two&quot;</span> <span class="o">-&gt;</span> <span class="s2">&quot;Newbie&quot;</span> <span class="o">|</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span><span class="o">)</span> <span class="n">lines</span> <span class="k">in</span>

       <span class="c">(* add a new record after &quot;first&quot; *)</span>
       <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span>
         <span class="nn">List</span><span class="p">.</span><span class="n">fold_right</span>
           <span class="o">(</span><span class="k">fun</span> <span class="n">x</span> <span class="n">a</span> <span class="o">-&gt;</span>
              <span class="k">if</span> <span class="n">x</span> <span class="o">=</span> <span class="s2">&quot;first&quot;</span>
              <span class="k">then</span> <span class="n">x</span> <span class="o">::</span> <span class="s2">&quot;New One&quot;</span> <span class="o">::</span> <span class="n">a</span>
              <span class="k">else</span> <span class="n">x</span> <span class="o">::</span> <span class="n">a</span><span class="o">)</span>
           <span class="n">lines</span> <span class="bp">[]</span> <span class="k">in</span>

       <span class="c">(* now print the records in reverse order *)</span>
       <span class="n">print_endline</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">REVERSE</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
       <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="n">print_string</span>
         <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span>
            <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span>
               <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">mapi</span>
                  <span class="o">(</span><span class="k">fun</span> <span class="n">i</span> <span class="n">line</span> <span class="o">-&gt;</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;%d: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">i</span> <span class="n">line</span><span class="o">)</span>
                  <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">of_list</span> <span class="n">lines</span><span class="o">))));</span>

       <span class="c">(* return the new list, which will be written back to the file *)</span>
       <span class="n">lines</span><span class="o">)</span>

<span class="c">(*-----------------------------</span>
<span class="c">ORIGINAL</span>

<span class="c">0: zero</span>
<span class="c">1: one</span>
<span class="c">2: two</span>
<span class="c">3: three</span>
<span class="c">4: four</span>

<span class="c">The last record was [four]</span>

<span class="c">The first record was [zero]</span>

<span class="c">REVERSE</span>

<span class="c">5: last</span>
<span class="c">4: three</span>
<span class="c">3: Newbie</span>
<span class="c">2: one</span>
<span class="c">1: New One</span>
<span class="c">0: first</span>
<span class="c">-----------------------------*)</span>

<span class="c">(* @@PLEAC@@_14.8 *)</span>
<span class="c">(* OCaml includes a Marshal module which does binary serialization and</span>
<span class="c">   deserialization of arbitrary data structures. However, it is not</span>
<span class="c">   type-safe, so coding errors can result in segmentation faults.</span>

<span class="c">   One way to eliminate this risk is to use functors. The following</span>
<span class="c">   example builds a functor called &quot;MakeSerializedDbm&quot; which extends</span>
<span class="c">   the Dbm module to provide type-safe serialization of values using</span>
<span class="c">   a user-defined method such as (but not limited to) Marshal. *)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;dbm.cma&quot;</span><span class="o">;;</span>

<span class="c">(* This module type defines a serialization method. It contains a type</span>
<span class="c">   and functions to convert values of that type to and from strings. *)</span>
<span class="k">module</span> <span class="k">type</span> <span class="nc">SerializedDbmMethod</span> <span class="o">=</span>
<span class="k">sig</span>
  <span class="k">type</span> <span class="k">value</span>
  <span class="k">val</span> <span class="n">serialize</span> <span class="o">:</span> <span class="k">value</span> <span class="o">-&gt;</span> <span class="kt">string</span>
  <span class="k">val</span> <span class="n">deserialize</span> <span class="o">:</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="k">value</span>
<span class="k">end</span>

<span class="c">(* This module type defines an enhanced Dbm interface that includes a</span>
<span class="c">   type for values to be used instead of strings. *)</span>
<span class="k">module</span> <span class="k">type</span> <span class="nc">SerializedDbm</span> <span class="o">=</span>
<span class="k">sig</span>
  <span class="k">type</span> <span class="n">t</span>
  <span class="k">type</span> <span class="k">value</span>
  <span class="k">val</span> <span class="n">opendbm</span> <span class="o">:</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="nn">Dbm</span><span class="p">.</span><span class="n">open_flag</span> <span class="kt">list</span> <span class="o">-&gt;</span> <span class="kt">int</span> <span class="o">-&gt;</span> <span class="n">t</span>
  <span class="k">val</span> <span class="n">close</span> <span class="o">:</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="kt">unit</span>
  <span class="k">val</span> <span class="n">find</span> <span class="o">:</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="k">value</span>
  <span class="k">val</span> <span class="n">add</span> <span class="o">:</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="k">value</span> <span class="o">-&gt;</span> <span class="kt">unit</span>
  <span class="k">val</span> <span class="n">replace</span> <span class="o">:</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="k">value</span> <span class="o">-&gt;</span> <span class="kt">unit</span>
  <span class="k">val</span> <span class="n">remove</span> <span class="o">:</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="kt">string</span> <span class="o">-&gt;</span> <span class="kt">unit</span>
  <span class="k">val</span> <span class="n">firstkey</span> <span class="o">:</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="kt">string</span>
  <span class="k">val</span> <span class="n">nextkey</span> <span class="o">:</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="kt">string</span>
  <span class="k">val</span> <span class="n">iter</span> <span class="o">:</span> <span class="o">(</span><span class="kt">string</span> <span class="o">-&gt;</span> <span class="k">value</span> <span class="o">-&gt;</span> <span class="k">&#39;</span><span class="n">a</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">t</span> <span class="o">-&gt;</span> <span class="kt">unit</span>
<span class="k">end</span>

<span class="c">(* Here is the functor itself. It takes a SerializedDbmMethod as an</span>
<span class="c">   argument and returns a SerializedDbm module instance as a result.</span>
<span class="c">   It is defined mainly in terms of Dbm, with a few overridden</span>
<span class="c">   definitions where the value type is needed. *)</span>
<span class="k">module</span> <span class="nc">MakeSerializedDbm</span> <span class="o">(</span><span class="nc">Method</span> <span class="o">:</span> <span class="nc">SerializedDbmMethod</span><span class="o">)</span>
  <span class="o">:</span> <span class="nc">SerializedDbm</span> <span class="k">with</span> <span class="k">type</span> <span class="k">value</span> <span class="o">=</span> <span class="nn">Method</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span>
<span class="k">struct</span>
  <span class="k">include</span> <span class="nc">Dbm</span>
  <span class="k">type</span> <span class="k">value</span> <span class="o">=</span> <span class="nn">Method</span><span class="p">.</span><span class="n">value</span>
  <span class="k">let</span> <span class="n">find</span> <span class="n">db</span> <span class="n">key</span> <span class="o">=</span> <span class="nn">Method</span><span class="p">.</span><span class="n">deserialize</span> <span class="o">(</span><span class="n">find</span> <span class="n">db</span> <span class="n">key</span><span class="o">)</span>
  <span class="k">let</span> <span class="n">add</span> <span class="n">db</span> <span class="n">key</span> <span class="k">value</span> <span class="o">=</span> <span class="n">add</span> <span class="n">db</span> <span class="n">key</span> <span class="o">(</span><span class="nn">Method</span><span class="p">.</span><span class="n">serialize</span> <span class="k">value</span><span class="o">)</span>
  <span class="k">let</span> <span class="n">replace</span> <span class="n">db</span> <span class="n">key</span> <span class="k">value</span> <span class="o">=</span> <span class="n">replace</span> <span class="n">db</span> <span class="n">key</span> <span class="o">(</span><span class="nn">Method</span><span class="p">.</span><span class="n">serialize</span> <span class="k">value</span><span class="o">)</span>
  <span class="k">let</span> <span class="n">iter</span> <span class="n">f</span> <span class="n">db</span> <span class="o">=</span> <span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">key</span> <span class="k">value</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">key</span> <span class="o">(</span><span class="nn">Method</span><span class="p">.</span><span class="n">deserialize</span> <span class="k">value</span><span class="o">))</span> <span class="n">db</span>
<span class="k">end</span>

<span class="c">(* Now, we can easily build typed Dbm interfaces by providing the type</span>
<span class="c">   and conversion functions. In this case, we use Marshal, but we could</span>
<span class="c">   also use other string-based serialization formats like JSON or XML. *)</span>
<span class="k">module</span> <span class="nc">StringListDbm</span> <span class="o">=</span>
  <span class="nc">MakeSerializedDbm</span><span class="o">(</span><span class="k">struct</span>
                      <span class="k">type</span> <span class="k">value</span> <span class="o">=</span> <span class="kt">string</span> <span class="kt">list</span>
                      <span class="k">let</span> <span class="n">serialize</span> <span class="n">x</span> <span class="o">=</span> <span class="nn">Marshal</span><span class="p">.</span><span class="n">to_string</span> <span class="n">x</span> <span class="bp">[]</span>
                      <span class="k">let</span> <span class="n">deserialize</span> <span class="n">x</span> <span class="o">=</span> <span class="nn">Marshal</span><span class="p">.</span><span class="n">from_string</span> <span class="n">x</span> <span class="mi">0</span>
                    <span class="k">end</span><span class="o">)</span>

<span class="k">let</span> <span class="n">db</span> <span class="o">=</span> <span class="nn">StringListDbm</span><span class="p">.</span><span class="n">opendbm</span> <span class="s2">&quot;data.db&quot;</span> <span class="o">[</span><span class="nn">Dbm</span><span class="p">.</span><span class="nc">Dbm_rdwr</span><span class="o">;</span> <span class="nn">Dbm</span><span class="p">.</span><span class="nc">Dbm_create</span><span class="o">]</span> <span class="mo">0o666</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">StringListDbm</span><span class="p">.</span><span class="n">replace</span> <span class="n">db</span> <span class="s2">&quot;Tom Christiansen&quot;</span>
    <span class="o">[</span> <span class="s2">&quot;book author&quot;</span><span class="o">;</span> <span class="s2">&quot;tchrist@perl.com&quot;</span> <span class="o">];</span>
  <span class="nn">StringListDbm</span><span class="p">.</span><span class="n">replace</span> <span class="n">db</span> <span class="s2">&quot;Tom Boutell&quot;</span>
    <span class="o">[</span> <span class="s2">&quot;shareware author&quot;</span><span class="o">;</span> <span class="s2">&quot;boutell@boutell.com&quot;</span> <span class="o">];</span>

  <span class="c">(* names to compare *)</span>
  <span class="k">let</span> <span class="n">name1</span> <span class="o">=</span> <span class="s2">&quot;Tom Christiansen&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">name2</span> <span class="o">=</span> <span class="s2">&quot;Tom Boutell&quot;</span> <span class="k">in</span>

  <span class="k">let</span> <span class="n">tom1</span> <span class="o">=</span> <span class="nn">StringListDbm</span><span class="p">.</span><span class="n">find</span> <span class="n">db</span> <span class="n">name1</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">tom2</span> <span class="o">=</span> <span class="nn">StringListDbm</span><span class="p">.</span><span class="n">find</span> <span class="n">db</span> <span class="n">name2</span> <span class="k">in</span>

  <span class="k">let</span> <span class="n">show</span> <span class="n">strings</span> <span class="o">=</span>
    <span class="s2">&quot;[&quot;</span> <span class="o">^</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;; &quot;</span>
             <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="o">^</span> <span class="n">s</span> <span class="o">^</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="o">)</span> <span class="n">strings</span><span class="o">))</span> <span class="o">^</span> <span class="s2">&quot;]&quot;</span> <span class="k">in</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Two Toming: %s %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">show</span> <span class="n">tom1</span><span class="o">)</span> <span class="o">(</span><span class="n">show</span> <span class="n">tom2</span><span class="o">)</span>

<span class="c">(* @@PLEAC@@_14.9 *)</span>
<span class="k">type</span> <span class="n">data</span> <span class="o">=</span> <span class="o">{</span><span class="k">mutable</span> <span class="n">variable1</span><span class="o">:</span> <span class="kt">string</span><span class="o">;</span> <span class="k">mutable</span> <span class="n">variable2</span><span class="o">:</span> <span class="kt">string</span><span class="o">}</span>

<span class="k">module</span> <span class="nc">PersistentStore</span> <span class="o">=</span>
  <span class="nc">MakeSerializedDbm</span><span class="o">(</span><span class="k">struct</span>
                      <span class="k">type</span> <span class="k">value</span> <span class="o">=</span> <span class="n">data</span>
                      <span class="k">let</span> <span class="n">serialize</span> <span class="n">x</span> <span class="o">=</span> <span class="nn">Marshal</span><span class="p">.</span><span class="n">to_string</span> <span class="n">x</span> <span class="bp">[]</span>
                      <span class="k">let</span> <span class="n">deserialize</span> <span class="n">x</span> <span class="o">=</span> <span class="nn">Marshal</span><span class="p">.</span><span class="n">from_string</span> <span class="n">x</span> <span class="mi">0</span>
                    <span class="k">end</span><span class="o">)</span>

<span class="k">let</span> <span class="n">with_persistent_data</span> <span class="n">f</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">db</span> <span class="o">=</span>
    <span class="nn">PersistentStore</span><span class="p">.</span><span class="n">opendbm</span> <span class="s2">&quot;data.db&quot;</span> <span class="o">[</span><span class="nn">Dbm</span><span class="p">.</span><span class="nc">Dbm_rdwr</span><span class="o">;</span> <span class="nn">Dbm</span><span class="p">.</span><span class="nc">Dbm_create</span><span class="o">]</span> <span class="mo">0o666</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">data</span> <span class="o">=</span>
    <span class="k">try</span> <span class="nn">PersistentStore</span><span class="p">.</span><span class="n">find</span> <span class="n">db</span> <span class="s2">&quot;data&quot;</span>
    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="o">{</span><span class="n">variable1</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">;</span> <span class="n">variable2</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">}</span> <span class="k">in</span>
  <span class="n">f</span> <span class="n">data</span><span class="o">;</span>
  <span class="nn">PersistentStore</span><span class="p">.</span><span class="n">replace</span> <span class="n">db</span> <span class="s2">&quot;data&quot;</span> <span class="n">data</span>
  <span class="nn">PersistentStore</span><span class="p">.</span><span class="n">close</span> <span class="n">db</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">with_persistent_data</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">data</span> <span class="o">-&gt;</span>
       <span class="k">begin</span>
         <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;variable1 = %s</span><span class="se">\n</span><span class="s2">variable2 = %s</span><span class="se">\n</span><span class="s2">&quot;</span>
           <span class="n">data</span><span class="o">.</span><span class="n">variable1</span> <span class="n">data</span><span class="o">.</span><span class="n">variable2</span><span class="o">;</span>
         <span class="n">data</span><span class="o">.</span><span class="n">variable1</span> <span class="o">&lt;-</span> <span class="s2">&quot;foo&quot;</span><span class="o">;</span>
         <span class="n">data</span><span class="o">.</span><span class="n">variable2</span> <span class="o">&lt;-</span> <span class="s2">&quot;bar&quot;</span><span class="o">;</span>
       <span class="k">end</span><span class="o">)</span>

<span class="c">(* @@PLEAC@@_14.10 *)</span>
<span class="c">(* This example uses OCaml DBI, a component of the mod_caml web development</span>
<span class="c">   library that provides a database abstraction API very similar to that of</span>
<span class="c">   Perl DBI. It is available for download here:</span>

<span class="c">   http://merjis.com/developers/mod_caml</span>

<span class="c">   Drivers for particular databases are listed in the introduction. *)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;nums.cma&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+num-top&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;num_top.cma&quot;</span><span class="o">;;</span>

<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+mysql&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;mysql.cma&quot;</span><span class="o">;;</span>

<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+dbi&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;dbi.cma&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;dbi_mysql.cmo&quot;</span><span class="o">;;</span>

<span class="c">(* With dbi installed via findlib, the above can be shortened to:</span>

<span class="c">   #use &quot;topfind&quot;;;</span>
<span class="c">   #require &quot;dbi.mysql&quot;;;</span>
<span class="c">*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">dbh</span> <span class="o">=</span>
    <span class="nn">Dbi_mysql</span><span class="p">.</span><span class="n">connect</span>
      <span class="o">~</span><span class="n">user</span><span class="o">:</span><span class="s2">&quot;user&quot;</span>
      <span class="o">~</span><span class="n">password</span><span class="o">:</span><span class="s2">&quot;auth&quot;</span>
      <span class="s2">&quot;database&quot;</span> <span class="k">in</span>

  <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">dbh</span><span class="o">#</span><span class="n">ex</span> <span class="n">sql</span> <span class="bp">[]</span> <span class="k">in</span>

  <span class="k">let</span> <span class="n">sth</span> <span class="o">=</span> <span class="n">dbh</span><span class="o">#</span><span class="n">prepare</span> <span class="n">sql</span> <span class="k">in</span>
  <span class="n">sth</span><span class="o">#</span><span class="n">execute</span> <span class="bp">[]</span><span class="o">;</span>
  <span class="n">sth</span><span class="o">#</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">row</span> <span class="o">-&gt;</span>
       <span class="n">print_endline</span> <span class="o">(</span><span class="nn">Dbi</span><span class="p">.</span><span class="n">sdebug</span> <span class="n">row</span><span class="o">);</span>
       <span class="c">(* ... *)</span>
       <span class="bp">()</span><span class="o">);</span>

  <span class="n">sth</span><span class="o">#</span><span class="n">finish</span> <span class="bp">()</span><span class="o">;</span>
  <span class="n">dbh</span><span class="o">#</span><span class="n">close</span> <span class="bp">()</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* dbusers - manage MySQL user table *)</span>

<span class="c">(* This example uses the Mysql module directly rather than going through</span>
<span class="c">   OCaml DBI. See the introduction for a link to the Mysql library. *)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+mysql&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;mysql.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">db</span> <span class="o">=</span>
    <span class="nn">Mysql</span><span class="p">.</span><span class="n">quick_connect</span>
      <span class="o">~</span><span class="n">user</span><span class="o">:</span><span class="s2">&quot;user&quot;</span>
      <span class="o">~</span><span class="n">password</span><span class="o">:</span><span class="s2">&quot;password&quot;</span>
      <span class="o">~</span><span class="n">database</span><span class="o">:</span><span class="s2">&quot;dbname&quot;</span> <span class="bp">()</span> <span class="k">in</span>

  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Mysql</span><span class="p">.</span><span class="n">exec</span> <span class="n">db</span> <span class="s2">&quot;CREATE TABLE users (uid INT, login CHAR(8))&quot;</span><span class="o">);</span>

  <span class="k">let</span> <span class="n">passwd</span> <span class="o">=</span> <span class="n">open_in</span> <span class="s2">&quot;/etc/passwd&quot;</span> <span class="k">in</span>
  <span class="k">begin</span>
    <span class="k">try</span>
      <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
        <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">passwd</span> <span class="k">in</span>
        <span class="k">let</span> <span class="n">user</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">line</span> <span class="mi">0</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">index</span> <span class="n">line</span> <span class="sc">&#39;:&#39;</span><span class="o">)</span> <span class="k">in</span>
        <span class="k">let</span> <span class="o">{</span><span class="nn">Unix</span><span class="p">.</span><span class="n">pw_uid</span><span class="o">=</span><span class="n">uid</span><span class="o">;</span> <span class="n">pw_name</span><span class="o">=</span><span class="n">name</span><span class="o">}</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">getpwnam</span> <span class="n">user</span> <span class="k">in</span>
        <span class="k">let</span> <span class="n">sql</span> <span class="o">=</span>
          <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;INSERT INTO users VALUES( %s, %s )&quot;</span>
            <span class="o">(</span><span class="nn">Mysql</span><span class="p">.</span><span class="n">ml2int</span> <span class="n">uid</span><span class="o">)</span>
            <span class="o">(</span><span class="nn">Mysql</span><span class="p">.</span><span class="n">ml2str</span> <span class="n">name</span><span class="o">)</span> <span class="k">in</span>
        <span class="n">ignore</span> <span class="o">(</span><span class="nn">Mysql</span><span class="p">.</span><span class="n">exec</span> <span class="n">db</span> <span class="n">sql</span><span class="o">)</span>
      <span class="k">done</span>
    <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
      <span class="n">close_in</span> <span class="n">passwd</span>
  <span class="k">end</span><span class="o">;</span>

  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Mysql</span><span class="p">.</span><span class="n">exec</span> <span class="n">db</span> <span class="s2">&quot;DROP TABLE users&quot;</span><span class="o">);</span>

  <span class="nn">Mysql</span><span class="p">.</span><span class="n">disconnect</span> <span class="n">db</span>

<span class="c">(* @@PLEAC@@_14.11 *)</span>
<span class="c">(* Search the history using the Places SQLite database, new in Firefox 3.</span>
<span class="c">   Pattern-matching uses simple substrings, but it could be expanded to use</span>
<span class="c">   Str or Pcre by installing a user-defined function. *)</span>

<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+sqlite3&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;sqlite3.cma&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">type</span> <span class="n">history</span> <span class="o">=</span> <span class="o">{</span> <span class="n">visit_date</span> <span class="o">:</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">tm</span><span class="o">;</span>
                 <span class="n">url</span>        <span class="o">:</span> <span class="kt">string</span><span class="o">;</span>
                 <span class="n">title</span>      <span class="o">:</span> <span class="kt">string</span><span class="o">;</span> <span class="o">}</span>

<span class="k">let</span> <span class="n">days</span> <span class="o">=</span> <span class="o">[|</span> <span class="s2">&quot;Sun&quot;</span><span class="o">;</span> <span class="s2">&quot;Mon&quot;</span><span class="o">;</span> <span class="s2">&quot;Tue&quot;</span><span class="o">;</span> <span class="s2">&quot;Wed&quot;</span><span class="o">;</span> <span class="s2">&quot;Thu&quot;</span><span class="o">;</span> <span class="s2">&quot;Fri&quot;</span><span class="o">;</span> <span class="s2">&quot;Sat&quot;</span> <span class="o">|]</span>
<span class="k">let</span> <span class="n">months</span> <span class="o">=</span> <span class="o">[|</span> <span class="s2">&quot;Jan&quot;</span><span class="o">;</span> <span class="s2">&quot;Feb&quot;</span><span class="o">;</span> <span class="s2">&quot;Mar&quot;</span><span class="o">;</span> <span class="s2">&quot;Apr&quot;</span><span class="o">;</span> <span class="s2">&quot;May&quot;</span><span class="o">;</span> <span class="s2">&quot;Jun&quot;</span><span class="o">;</span>
                <span class="s2">&quot;Jul&quot;</span><span class="o">;</span> <span class="s2">&quot;Aug&quot;</span><span class="o">;</span> <span class="s2">&quot;Sep&quot;</span><span class="o">;</span> <span class="s2">&quot;Oct&quot;</span><span class="o">;</span> <span class="s2">&quot;Nov&quot;</span><span class="o">;</span> <span class="s2">&quot;Dec&quot;</span> <span class="o">|]</span>

<span class="k">let</span> <span class="n">string_of_tm</span> <span class="n">tm</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;%s %s %2d %02d:%02d:%02d %04d&quot;</span>
    <span class="n">days</span><span class="o">.(</span><span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_wday</span><span class="o">)</span>
    <span class="n">months</span><span class="o">.(</span><span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_mon</span><span class="o">)</span>
    <span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_mday</span>
    <span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_hour</span>
    <span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_min</span>
    <span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_sec</span>
    <span class="o">(</span><span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_year</span> <span class="o">+</span> <span class="mi">1900</span><span class="o">)</span>

<span class="k">let</span> <span class="n">tm_of_micros</span> <span class="n">micros</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">time</span> <span class="o">=</span> <span class="n">float_of_string</span> <span class="n">micros</span> <span class="o">/.</span> <span class="mi">1000000</span><span class="o">.</span> <span class="k">in</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">localtime</span> <span class="n">time</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="k">then</span>
    <span class="k">begin</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Usage: %s path/to/places.sqlite [pattern]</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">);</span>
      <span class="n">exit</span> <span class="mi">0</span>
    <span class="k">end</span>

<span class="k">let</span> <span class="n">file</span> <span class="o">=</span>
  <span class="k">if</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="k">then</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span> <span class="k">else</span> <span class="s2">&quot;places.sqlite&quot;</span>

<span class="k">let</span> <span class="n">pattern</span> <span class="o">=</span>
  <span class="k">if</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="k">then</span> <span class="nc">Some</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">2</span><span class="o">)</span> <span class="k">else</span> <span class="nc">None</span>

<span class="k">let</span> <span class="n">db</span> <span class="o">=</span> <span class="nn">Sqlite3</span><span class="p">.</span><span class="n">db_open</span> <span class="n">file</span>

<span class="k">let</span> <span class="n">sql</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span>
    <span class="s2">&quot;SELECT   visit_date, url, title</span>
<span class="s2">     FROM     moz_places p</span>
<span class="s2">     JOIN     moz_historyvisits v</span>
<span class="s2">     ON       p.id = v.place_id</span>
<span class="s2">     %s</span>
<span class="s2">     ORDER BY visit_date DESC&quot;</span>
    <span class="o">(</span><span class="k">match</span> <span class="n">pattern</span> <span class="k">with</span>
       <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="s2">&quot;&quot;</span>
       <span class="o">|</span> <span class="nc">Some</span> <span class="n">s</span> <span class="o">-&gt;</span>
           <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;WHERE url LIKE &#39;%%%s%%&#39; OR title LIKE &#39;%%%s%%&#39;&quot;</span>
              <span class="n">s</span> <span class="n">s</span><span class="o">))</span>

<span class="k">let</span> <span class="n">data</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span>

<span class="k">let</span> <span class="n">res</span> <span class="o">=</span>
  <span class="nn">Sqlite3</span><span class="p">.</span><span class="n">exec_not_null_no_headers</span> <span class="n">db</span>
    <span class="o">~</span><span class="n">cb</span><span class="o">:(</span><span class="k">fun</span> <span class="n">row</span> <span class="o">-&gt;</span>
           <span class="n">data</span> <span class="o">:=</span> <span class="o">{</span><span class="n">visit_date</span> <span class="o">=</span> <span class="n">tm_of_micros</span> <span class="n">row</span><span class="o">.(</span><span class="mi">0</span><span class="o">);</span>
                    <span class="n">url</span> <span class="o">=</span> <span class="n">row</span><span class="o">.(</span><span class="mi">1</span><span class="o">);</span>
                    <span class="n">title</span> <span class="o">=</span> <span class="n">row</span><span class="o">.(</span><span class="mi">2</span><span class="o">)}</span> <span class="o">::</span> <span class="o">!</span><span class="n">data</span><span class="o">)</span> <span class="n">sql</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">res</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nn">Sqlite3</span><span class="p">.</span><span class="nn">Rc</span><span class="p">.</span><span class="nc">OK</span> <span class="o">-&gt;</span>
        <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
          <span class="o">(</span><span class="k">fun</span> <span class="n">history</span> <span class="o">-&gt;</span>
             <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;[%s] %s </span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;\n</span><span class="s2">&quot;</span>
               <span class="o">(</span><span class="n">string_of_tm</span> <span class="n">history</span><span class="o">.</span><span class="n">visit_date</span><span class="o">)</span>
               <span class="n">history</span><span class="o">.</span><span class="n">url</span>
               <span class="n">history</span><span class="o">.</span><span class="n">title</span><span class="o">)</span>
          <span class="o">!</span><span class="n">data</span>
    <span class="o">|</span> <span class="n">r</span> <span class="o">-&gt;</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s: %s</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="o">(</span><span class="nn">Sqlite3</span><span class="p">.</span><span class="nn">Rc</span><span class="p">.</span><span class="n">to_string</span> <span class="n">r</span><span class="o">)</span>
          <span class="o">(</span><span class="nn">Sqlite3</span><span class="p">.</span><span class="n">errmsg</span> <span class="n">db</span><span class="o">)</span>


<span class="c">(* @@PLEAC@@_15.1 *)</span>
<span class="k">let</span> <span class="n">verbose</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span>
<span class="k">let</span> <span class="n">debug</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span>
<span class="k">let</span> <span class="n">output</span> <span class="o">=</span> <span class="n">ref</span> <span class="s2">&quot;&quot;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Arg</span><span class="p">.</span><span class="n">parse</span>
    <span class="o">[</span>
      <span class="s2">&quot;-v&quot;</span><span class="o">,</span> <span class="nn">Arg</span><span class="p">.</span><span class="nc">Set</span> <span class="n">verbose</span><span class="o">,</span> <span class="s2">&quot;Verbose mode&quot;</span><span class="o">;</span>
      <span class="s2">&quot;-D&quot;</span><span class="o">,</span> <span class="nn">Arg</span><span class="p">.</span><span class="nc">Set</span> <span class="n">debug</span><span class="o">,</span> <span class="s2">&quot;Debug mode&quot;</span><span class="o">;</span>
      <span class="s2">&quot;-o&quot;</span><span class="o">,</span> <span class="nn">Arg</span><span class="p">.</span><span class="nc">Set_string</span> <span class="n">output</span><span class="o">,</span> <span class="s2">&quot;Specify output file&quot;</span><span class="o">;</span>
    <span class="o">]</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">s</span> <span class="o">-&gt;</span>
       <span class="k">raise</span> <span class="o">(</span><span class="nn">Arg</span><span class="p">.</span><span class="nc">Bad</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;unexpected argument `%s&#39;&quot;</span> <span class="n">s</span><span class="o">)))</span>
    <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;Usage: %s [-v] [-d] [-o file]&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">))</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">verbose</span> <span class="k">then</span> <span class="n">print_endline</span> <span class="s2">&quot;Verbose mode&quot;</span><span class="o">;</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">debug</span> <span class="k">then</span> <span class="n">print_endline</span> <span class="s2">&quot;Debug mode&quot;</span><span class="o">;</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">output</span> <span class="o">&lt;&gt;</span> <span class="s2">&quot;&quot;</span> <span class="k">then</span> <span class="n">print_endline</span> <span class="o">(</span><span class="s2">&quot;Writing output to &quot;</span> <span class="o">^</span> <span class="o">!</span><span class="n">output</span><span class="o">);</span>

<span class="c">(* @@PLEAC@@_15.2 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">i_am_interactive</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">isatty</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span> <span class="o">&amp;&amp;</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">isatty</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdout</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="k">if</span> <span class="n">i_am_interactive</span> <span class="bp">()</span>
      <span class="k">then</span> <span class="n">print_string</span> <span class="s2">&quot;Prompt: &quot;</span><span class="o">;</span>
      <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">read_line</span> <span class="bp">()</span> <span class="k">in</span>
      <span class="k">if</span> <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">then</span> <span class="k">raise</span> <span class="nc">End_of_file</span><span class="o">;</span>
      <span class="c">(* do something with the line *)</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span>

<span class="c">(* @@PLEAC@@_15.3 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="c">(* Run the clear command to clear the screen. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">ignore</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="n">command</span> <span class="s2">&quot;clear&quot;</span><span class="o">)</span>

<span class="c">(* Save the output to a string to avoid running a process each time. *)</span>
<span class="k">let</span> <span class="n">clear</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">let</span> <span class="n">proc</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_in</span> <span class="s2">&quot;clear&quot;</span> <span class="k">in</span>
    <span class="k">try</span>
      <span class="k">let</span> <span class="n">chars</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">proc</span> <span class="k">in</span>
      <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_in</span> <span class="n">proc</span><span class="o">);</span>
      <span class="n">chars</span>
    <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_in</span> <span class="n">proc</span><span class="o">);</span> <span class="s2">&quot;&quot;</span>
  <span class="k">with</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="s2">&quot;&quot;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">print_string</span> <span class="n">clear</span>

<span class="c">(* @@PLEAC@@_15.4 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="c">(* UNIX only, due to &quot;stty&quot;. *)</span>
<span class="k">let</span> <span class="n">get_terminal_size</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_in</span> <span class="s2">&quot;stty size&quot;</span> <span class="k">in</span>
  <span class="k">try</span>
    <span class="k">begin</span>
      <span class="k">try</span>
        <span class="nn">Scanf</span><span class="p">.</span><span class="n">fscanf</span> <span class="n">in_channel</span> <span class="s2">&quot;%d %d&quot;</span>
          <span class="o">(</span><span class="k">fun</span> <span class="n">rows</span> <span class="n">cols</span> <span class="o">-&gt;</span>
             <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_in</span> <span class="n">in_channel</span><span class="o">);</span>
             <span class="o">(</span><span class="n">rows</span><span class="o">,</span> <span class="n">cols</span><span class="o">))</span>
      <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
        <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_in</span> <span class="n">in_channel</span><span class="o">);</span>
        <span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span>
    <span class="k">end</span>
  <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span>
    <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_in</span> <span class="n">in_channel</span><span class="o">);</span>
    <span class="k">raise</span> <span class="n">e</span>

<span class="c">(* Display a textual bar chart as wide as the console. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="o">(</span><span class="n">height</span><span class="o">,</span> <span class="n">width</span><span class="o">)</span> <span class="o">=</span> <span class="n">get_terminal_size</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="k">if</span> <span class="n">width</span> <span class="o">&lt;</span> <span class="mi">10</span>
  <span class="k">then</span> <span class="o">(</span><span class="n">prerr_endline</span> <span class="s2">&quot;You must have at least 10 characters&quot;</span><span class="o">;</span>
        <span class="n">exit</span> <span class="mi">255</span><span class="o">);</span>
  <span class="k">let</span> <span class="n">max_value</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">fold_left</span> <span class="n">max</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span> <span class="n">values</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">ratio</span> <span class="o">=</span> <span class="o">(</span><span class="kt">float</span> <span class="n">width</span> <span class="o">-.</span> <span class="mi">10</span><span class="o">.</span><span class="mi">0</span><span class="o">)</span> <span class="o">/.</span> <span class="n">max_value</span> <span class="k">in</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="k">value</span> <span class="o">-&gt;</span>
       <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%8.1f %s</span><span class="se">\n</span><span class="s2">&quot;</span>
         <span class="k">value</span>
         <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="o">(</span><span class="n">int_of_float</span> <span class="o">(</span><span class="n">ratio</span> <span class="o">*.</span> <span class="k">value</span><span class="o">))</span> <span class="sc">&#39;*&#39;</span><span class="o">))</span>
    <span class="n">values</span>

<span class="c">(* @@PLEAC@@_15.5 *)</span>
<span class="c">(* Requires the ANSITerminal library by Christophe Troestler,</span>
<span class="c">   available at http://math.umh.ac.be/an/software.php#x4-80007 *)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;ANSITerminal.cma&quot;</span><span class="o">;;</span>
<span class="k">open</span> <span class="nc">ANSITerminal</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">print_string</span> <span class="o">[</span><span class="n">red</span><span class="o">]</span> <span class="s2">&quot;Danger Will Robinson!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
  <span class="n">print_string</span> <span class="bp">[]</span> <span class="s2">&quot;This is just normal text.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
  <span class="n">print_string</span> <span class="o">[</span><span class="nc">Blink</span><span class="o">]</span> <span class="s2">&quot;&lt;BLINK&gt;Do you hurt yet?&lt;/BLINK&gt;</span><span class="se">\n</span><span class="s2">&quot;</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">set_autoreset</span> <span class="bp">false</span><span class="o">;</span>
  <span class="c">(* rhyme for the deadly coral snake *)</span>
  <span class="n">print_string</span> <span class="o">[</span><span class="n">red</span><span class="o">;</span> <span class="n">on_black</span><span class="o">]</span> <span class="s2">&quot;venom lack</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
  <span class="n">print_string</span> <span class="o">[</span><span class="n">red</span><span class="o">;</span> <span class="n">on_yellow</span><span class="o">]</span> <span class="s2">&quot;kill that fellow</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
  <span class="n">print_string</span> <span class="o">[</span><span class="n">green</span><span class="o">;</span> <span class="n">on_cyan</span><span class="o">;</span> <span class="nc">Blink</span><span class="o">]</span> <span class="s2">&quot;garish!</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
  <span class="n">print_string</span> <span class="o">[</span><span class="nc">Reset</span><span class="o">]</span> <span class="s2">&quot;&quot;</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">set_autoreset</span> <span class="bp">true</span><span class="o">;</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="n">print_string</span> <span class="o">[</span><span class="n">red</span><span class="o">;</span> <span class="n">on_white</span><span class="o">;</span> <span class="nc">Bold</span><span class="o">;</span> <span class="nc">Blink</span><span class="o">])</span>
    <span class="o">[</span><span class="s2">&quot;This way</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
     <span class="s2">&quot;each line</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
     <span class="s2">&quot;has its own</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
     <span class="s2">&quot;attribute set.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">]</span>

<span class="c">(* @@PLEAC@@_15.6 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">with_cbreak</span> <span class="n">f</span> <span class="n">x</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">term_init</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">tcgetattr</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">term_cbreak</span> <span class="o">=</span> <span class="o">{</span> <span class="n">term_init</span> <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">c_icanon</span> <span class="o">=</span> <span class="bp">false</span> <span class="o">}</span> <span class="k">in</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">tcsetattr</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">TCSANOW</span> <span class="n">term_cbreak</span><span class="o">;</span>
  <span class="k">try</span>
    <span class="k">let</span> <span class="n">result</span> <span class="o">=</span> <span class="n">f</span> <span class="n">x</span> <span class="k">in</span>
    <span class="nn">Unix</span><span class="p">.</span><span class="n">tcsetattr</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">TCSADRAIN</span> <span class="n">term_init</span><span class="o">;</span>
    <span class="n">result</span>
  <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span>
    <span class="nn">Unix</span><span class="p">.</span><span class="n">tcsetattr</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">TCSADRAIN</span> <span class="n">term_init</span><span class="o">;</span>
    <span class="k">raise</span> <span class="n">e</span>

<span class="k">let</span> <span class="n">key</span> <span class="o">=</span> <span class="n">with_cbreak</span> <span class="n">input_char</span> <span class="n">stdin</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* sascii - Show ASCII values for keypresses *)</span>
<span class="k">let</span> <span class="n">sascii</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
    <span class="k">let</span> <span class="kt">char</span> <span class="o">=</span> <span class="nn">Char</span><span class="p">.</span><span class="n">code</span> <span class="o">(</span><span class="n">input_char</span> <span class="n">stdin</span><span class="o">)</span> <span class="k">in</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot; Decimal: %d</span><span class="se">\t</span><span class="s2">Hex: %x</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="kt">char</span> <span class="kt">char</span><span class="o">;</span>
    <span class="n">flush</span> <span class="n">stdout</span>
  <span class="k">done</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">print_endline</span>
    <span class="s2">&quot;Press keys to see their ASCII values.  Use Ctrl-C to quit.&quot;</span><span class="o">;</span>
  <span class="n">with_cbreak</span> <span class="n">sascii</span> <span class="bp">()</span>

<span class="c">(* @@PLEAC@@_15.7 *)</span>
<span class="c">(* OCaml doesn&#39;t recognize &#39;\a&#39;; instead use &#39;\007&#39;. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">print_endline</span> <span class="s2">&quot;</span><span class="se">\007</span><span class="s2">Wake up!&quot;</span>

<span class="c">(* Use the &quot;tput&quot; command to produce a visual bell. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">ignore</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="n">command</span> <span class="s2">&quot;tput flash&quot;</span><span class="o">)</span>

<span class="c">(* @@PLEAC@@_15.8 *)</span>
<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* demo POSIX termios *)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">uncontrol</span> <span class="n">c</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">c</span> <span class="o">&gt;=</span> <span class="sc">&#39;\128&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;=</span> <span class="sc">&#39;\255&#39;</span>
  <span class="k">then</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;M-%c&quot;</span> <span class="o">(</span><span class="nn">Char</span><span class="p">.</span><span class="n">chr</span> <span class="o">(</span><span class="nn">Char</span><span class="p">.</span><span class="n">code</span> <span class="n">c</span> <span class="ow">land</span> <span class="mi">127</span><span class="o">))</span>
  <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">c</span> <span class="o">&gt;=</span> <span class="sc">&#39;\000&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="sc">&#39;\031&#39;</span><span class="o">)</span> <span class="o">||</span> <span class="n">c</span> <span class="o">=</span> <span class="sc">&#39;\127&#39;</span>
  <span class="k">then</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;^%c&quot;</span> <span class="o">(</span><span class="nn">Char</span><span class="p">.</span><span class="n">chr</span> <span class="o">(</span><span class="nn">Char</span><span class="p">.</span><span class="n">code</span> <span class="n">c</span> <span class="ow">lxor</span> <span class="mi">64</span><span class="o">))</span>
  <span class="k">else</span> <span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="mi">1</span> <span class="n">c</span>

<span class="k">let</span> <span class="n">term</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">tcgetattr</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span>
<span class="k">let</span> <span class="n">erase</span> <span class="o">=</span> <span class="n">term</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">c_verase</span>
<span class="k">let</span> <span class="n">kill</span> <span class="o">=</span> <span class="n">term</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">c_vkill</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Erase is character %d, %s</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="o">(</span><span class="nn">Char</span><span class="p">.</span><span class="n">code</span> <span class="n">erase</span><span class="o">)</span>
    <span class="o">(</span><span class="n">uncontrol</span> <span class="n">erase</span><span class="o">);</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Kill is character %d, %s</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="o">(</span><span class="nn">Char</span><span class="p">.</span><span class="n">code</span> <span class="n">kill</span><span class="o">)</span>
    <span class="o">(</span><span class="n">uncontrol</span> <span class="n">kill</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">term</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">c_verase</span> <span class="o">&lt;-</span> <span class="sc">&#39;#&#39;</span><span class="o">;</span>
  <span class="n">term</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">c_vkill</span> <span class="o">&lt;-</span> <span class="sc">&#39;@&#39;</span><span class="o">;</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">tcsetattr</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">TCSANOW</span> <span class="n">term</span><span class="o">;</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;erase is #, kill is @; type something: %!&quot;</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">stdin</span> <span class="k">in</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;You typed: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">line</span><span class="o">;</span>
  <span class="n">term</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">c_verase</span> <span class="o">&lt;-</span> <span class="n">erase</span><span class="o">;</span>
  <span class="n">term</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">c_vkill</span> <span class="o">&lt;-</span> <span class="n">kill</span><span class="o">;</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">tcsetattr</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">TCSANOW</span> <span class="n">term</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">module</span> <span class="nc">HotKey</span> <span class="o">:</span>
<span class="k">sig</span>
  <span class="k">val</span> <span class="n">cbreak</span> <span class="o">:</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">unit</span>
  <span class="k">val</span> <span class="n">cooked</span> <span class="o">:</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">unit</span>
  <span class="k">val</span> <span class="n">readkey</span> <span class="o">:</span> <span class="kt">unit</span> <span class="o">-&gt;</span> <span class="kt">char</span>
<span class="k">end</span> <span class="o">=</span>
<span class="k">struct</span>
  <span class="k">open</span> <span class="nc">Unix</span>

  <span class="k">let</span> <span class="n">oterm</span> <span class="o">=</span> <span class="o">{(</span><span class="n">tcgetattr</span> <span class="n">stdin</span><span class="o">)</span> <span class="k">with</span> <span class="n">c_vtime</span> <span class="o">=</span> <span class="mi">0</span><span class="o">}</span>
  <span class="k">let</span> <span class="n">noecho</span> <span class="o">=</span> <span class="o">{</span><span class="n">oterm</span> <span class="k">with</span>
                  <span class="n">c_vtime</span> <span class="o">=</span> <span class="mi">1</span><span class="o">;</span>
                  <span class="n">c_echo</span> <span class="o">=</span> <span class="bp">false</span><span class="o">;</span>
                  <span class="n">c_echok</span> <span class="o">=</span> <span class="bp">false</span><span class="o">;</span>
                  <span class="n">c_icanon</span> <span class="o">=</span> <span class="bp">false</span><span class="o">}</span>

  <span class="k">let</span> <span class="n">cbreak</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">tcsetattr</span> <span class="n">stdin</span> <span class="nc">TCSANOW</span> <span class="n">noecho</span>
  <span class="k">let</span> <span class="n">cooked</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">tcsetattr</span> <span class="n">stdin</span> <span class="nc">TCSANOW</span> <span class="n">oterm</span>

  <span class="k">let</span> <span class="n">readkey</span> <span class="bp">()</span> <span class="o">=</span>
    <span class="n">cbreak</span> <span class="bp">()</span><span class="o">;</span>
    <span class="k">let</span> <span class="n">key</span> <span class="o">=</span> <span class="n">input_char</span> <span class="o">(</span><span class="nn">Pervasives</span><span class="p">.</span><span class="n">stdin</span><span class="o">)</span> <span class="k">in</span>
    <span class="n">cooked</span> <span class="bp">()</span><span class="o">;</span>
    <span class="n">key</span>

  <span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">cooked</span> <span class="bp">()</span>
<span class="k">end</span>

<span class="c">(* @@PLEAC@@_15.9 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">set_nonblock</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span><span class="o">;</span>
  <span class="k">try</span>
    <span class="k">let</span> <span class="kt">char</span> <span class="o">=</span> <span class="n">with_cbreak</span> <span class="n">input_char</span> <span class="n">stdin</span> <span class="k">in</span>
    <span class="c">(* input was waiting and it was char *)</span>
    <span class="bp">()</span>
  <span class="k">with</span> <span class="nc">Sys_blocked_io</span> <span class="o">-&gt;</span>
    <span class="c">(* no input was waiting *)</span>
    <span class="bp">()</span>

<span class="c">(* @@PLEAC@@_15.10 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="c">(* Thanks to David Mentre, Remi Vanicat, and David Brown&#39;s posts on</span>
<span class="c">   caml-list. Works on Unix only, unfortunately, due to tcsetattr. *)</span>
<span class="k">let</span> <span class="n">read_password</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">term_init</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">tcgetattr</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">term_no_echo</span> <span class="o">=</span> <span class="o">{</span> <span class="n">term_init</span> <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">c_echo</span> <span class="o">=</span> <span class="bp">false</span> <span class="o">}</span> <span class="k">in</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">tcsetattr</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">TCSANOW</span> <span class="n">term_no_echo</span><span class="o">;</span>
  <span class="k">try</span>
    <span class="k">let</span> <span class="n">password</span> <span class="o">=</span> <span class="n">read_line</span> <span class="bp">()</span> <span class="k">in</span>
    <span class="n">print_newline</span> <span class="bp">()</span><span class="o">;</span>
    <span class="nn">Unix</span><span class="p">.</span><span class="n">tcsetattr</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">TCSAFLUSH</span> <span class="n">term_init</span><span class="o">;</span>
    <span class="n">password</span>
  <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span>
    <span class="nn">Unix</span><span class="p">.</span><span class="n">tcsetattr</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">TCSAFLUSH</span> <span class="n">term_init</span><span class="o">;</span>
    <span class="k">raise</span> <span class="n">e</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">print_string</span> <span class="s2">&quot;Enter your password: &quot;</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">password</span> <span class="o">=</span> <span class="n">read_password</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;You said: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">password</span>

<span class="c">(* @@PLEAC@@_15.11 *)</span>
<span class="c">(* ledit is a pure-OCaml readline clone by Daniel de Rauglaudre.</span>
<span class="c">   Source is available here: http://pauillac.inria.fr/~ddr/ledit/</span>

<span class="c">   It is designed to be used as a command-line wrapper, but it</span>
<span class="c">   can also be embedded in another program by building it normally</span>
<span class="c">   and copying cursor.cmo, ledit.cmi, ledit.cmo, and ledit.mli into</span>
<span class="c">   your project.</span>

<span class="c">   A guide to compiling and embedding ledit can be found on the</span>
<span class="c">   OCaml Tutorial Wiki: http://www.ocaml-tutorial.org/ledit</span>
<span class="c">   At present, this guide applies to ledit 1.11. This recipe uses</span>
<span class="c">   ledit 1.15, which is slightly different due to the addition of</span>
<span class="c">   Unicode support (Ledit.input_char now returns a string instead</span>
<span class="c">   of a char). *)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;cursor.cmo&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;ledit.cmo&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">readline</span> <span class="n">prompt</span> <span class="o">=</span>
  <span class="nn">Ledit</span><span class="p">.</span><span class="n">set_prompt</span> <span class="n">prompt</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">create</span> <span class="mi">256</span> <span class="k">in</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span> <span class="o">=</span> <span class="k">function</span>
    <span class="o">|</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">-&gt;</span>
        <span class="nn">Buffer</span><span class="p">.</span><span class="n">contents</span> <span class="n">buffer</span>
    <span class="o">|</span> <span class="kt">string</span> <span class="o">-&gt;</span>
        <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_string</span> <span class="n">buffer</span> <span class="kt">string</span><span class="o">;</span>
        <span class="n">loop</span> <span class="o">(</span><span class="nn">Ledit</span><span class="p">.</span><span class="n">input_char</span> <span class="n">stdin</span><span class="o">)</span> <span class="k">in</span>
  <span class="n">loop</span> <span class="o">(</span><span class="nn">Ledit</span><span class="p">.</span><span class="n">input_char</span> <span class="n">stdin</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">prompt</span> <span class="o">=</span> <span class="s2">&quot;Prompt: &quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">readline</span> <span class="n">prompt</span> <span class="k">in</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;You said: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">line</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* If you would prefer to use the real GNU Readline library, you can use</span>
<span class="c">  camlidl to generate an interface to it. Here&#39;s a basic readline.idl: *)</span>

<span class="n">quote</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="s2">&quot;#include &lt;stdio.h&gt;&quot;</span><span class="o">);</span>
<span class="n">quote</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="s2">&quot;#include &lt;readline/readline.h&gt;&quot;</span><span class="o">);</span>
<span class="n">quote</span><span class="o">(</span><span class="n">c</span><span class="o">,</span> <span class="s2">&quot;#include &lt;readline/history.h&gt;&quot;</span><span class="o">);</span>

<span class="o">[</span><span class="kt">string</span><span class="o">,</span> <span class="n">unique</span><span class="o">]</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">readline</span> <span class="o">([</span><span class="kt">string</span><span class="o">,</span> <span class="n">unique</span><span class="o">]</span> <span class="n">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prompt</span><span class="o">)</span>
    <span class="n">quote</span><span class="o">(</span><span class="n">dealloc</span><span class="o">,</span> <span class="s2">&quot;free(_res);&quot;</span><span class="o">);</span>

<span class="n">void</span> <span class="n">add_history</span> <span class="o">([</span><span class="kt">string</span><span class="o">]</span> <span class="n">const</span> <span class="kt">char</span> <span class="o">*</span><span class="kt">string</span><span class="o">);</span>

<span class="c">(* And here is a test program: *)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;You said: %s</span><span class="se">\n</span><span class="s2">%!&quot;</span>
      <span class="o">(</span><span class="k">match</span> <span class="nn">Readline</span><span class="p">.</span><span class="n">readline</span> <span class="o">(</span><span class="nc">Some</span> <span class="s2">&quot;Prompt: &quot;</span><span class="o">)</span> <span class="k">with</span>
         <span class="o">|</span> <span class="nc">Some</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="nn">Readline</span><span class="p">.</span><span class="n">add_history</span> <span class="n">s</span><span class="o">;</span> <span class="n">s</span>
         <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="n">exit</span> <span class="mi">0</span><span class="o">)</span>
  <span class="k">done</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* vbsh - very bad shell *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="k">let</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">readline</span> <span class="s2">&quot;$ &quot;</span> <span class="k">in</span>
      <span class="k">begin</span>
        <span class="k">match</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">system</span> <span class="n">cmd</span> <span class="k">with</span>
          <span class="o">|</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">WEXITED</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span>
          <span class="o">|</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">WSIGNALED</span> <span class="n">signal_num</span> <span class="o">-&gt;</span>
              <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Program killed by signal %d</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">signal_num</span>
          <span class="o">|</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">WSTOPPED</span> <span class="n">signal_num</span> <span class="o">-&gt;</span>
              <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Program stopped by signal %d</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">signal_num</span>
      <span class="k">end</span><span class="o">;</span>
      <span class="n">flush</span> <span class="n">stdout</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span>

<span class="c">(* @@PLEAC@@_15.12 *)</span>
<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* rep - screen repeat command *)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="c">(* http://www.nongnu.org/ocaml-tmk/ *)</span>
<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+curses&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;curses.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">10</span><span class="o">.</span><span class="mi">0</span>

<span class="k">let</span> <span class="o">(</span><span class="n">timeout</span><span class="o">,</span> <span class="n">command</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">match</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="k">with</span>
    <span class="o">|</span> <span class="mi">0</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="n">timeout</span><span class="o">,</span> <span class="o">[|</span> <span class="o">|])</span>
    <span class="o">|</span> <span class="n">len</span> <span class="o">-&gt;</span>
        <span class="k">if</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span> <span class="o">&lt;&gt;</span> <span class="s2">&quot;&quot;</span> <span class="o">&amp;&amp;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">).[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="sc">&#39;-&#39;</span>
        <span class="k">then</span> <span class="o">(</span><span class="n">float_of_string</span>
                <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span>
                   <span class="mi">1</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)),</span>
              <span class="nn">Array</span><span class="p">.</span><span class="n">sub</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="mi">2</span> <span class="o">(</span><span class="n">len</span> <span class="o">-</span> <span class="mi">2</span><span class="o">))</span>
        <span class="k">else</span> <span class="o">(</span><span class="n">timeout</span><span class="o">,</span> <span class="nn">Array</span><span class="p">.</span><span class="n">sub</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="mi">1</span> <span class="o">(</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="o">))</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="n">command</span> <span class="o">=</span> <span class="mi">0</span>
  <span class="k">then</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;usage: %s [ -timeout ] cmd args</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">);</span>
        <span class="n">exit</span> <span class="mi">255</span><span class="o">)</span>

<span class="k">let</span> <span class="n">window</span> <span class="o">=</span> <span class="nn">Curses</span><span class="p">.</span><span class="n">initscr</span> <span class="bp">()</span>          <span class="c">(* start screen *)</span>
<span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="nn">Curses</span><span class="p">.</span><span class="n">noecho</span> <span class="bp">()</span>
<span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="nn">Curses</span><span class="p">.</span><span class="n">cbreak</span> <span class="bp">()</span>
<span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="nn">Curses</span><span class="p">.</span><span class="n">nodelay</span> <span class="n">window</span> <span class="bp">true</span>      <span class="c">(* so getch() is non-blocking *)</span>

<span class="k">let</span> <span class="k">done&#39;</span> <span class="n">s</span> <span class="o">_</span> <span class="o">=</span> <span class="nn">Curses</span><span class="p">.</span><span class="n">endwin</span> <span class="bp">()</span><span class="o">;</span> <span class="n">print_endline</span> <span class="n">s</span><span class="o">;</span> <span class="n">exit</span> <span class="mi">0</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">set_signal</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigint</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="nc">Signal_handle</span> <span class="o">(</span><span class="k">done&#39;</span> <span class="s2">&quot;Ouch!&quot;</span><span class="o">))</span>

<span class="k">let</span> <span class="n">cols</span><span class="o">,</span> <span class="n">lines</span> <span class="o">=</span> <span class="nn">Curses</span><span class="p">.</span><span class="n">getmaxyx</span> <span class="n">window</span>

<span class="k">let</span> <span class="n">days</span> <span class="o">=</span> <span class="o">[|</span> <span class="s2">&quot;Sun&quot;</span><span class="o">;</span> <span class="s2">&quot;Mon&quot;</span><span class="o">;</span> <span class="s2">&quot;Tue&quot;</span><span class="o">;</span> <span class="s2">&quot;Wed&quot;</span><span class="o">;</span> <span class="s2">&quot;Thu&quot;</span><span class="o">;</span> <span class="s2">&quot;Fri&quot;</span><span class="o">;</span> <span class="s2">&quot;Sat&quot;</span> <span class="o">|]</span>
<span class="k">let</span> <span class="n">months</span> <span class="o">=</span> <span class="o">[|</span> <span class="s2">&quot;Jan&quot;</span><span class="o">;</span> <span class="s2">&quot;Feb&quot;</span><span class="o">;</span> <span class="s2">&quot;Mar&quot;</span><span class="o">;</span> <span class="s2">&quot;Apr&quot;</span><span class="o">;</span> <span class="s2">&quot;May&quot;</span><span class="o">;</span> <span class="s2">&quot;Jun&quot;</span><span class="o">;</span>
                <span class="s2">&quot;Jul&quot;</span><span class="o">;</span> <span class="s2">&quot;Aug&quot;</span><span class="o">;</span> <span class="s2">&quot;Sep&quot;</span><span class="o">;</span> <span class="s2">&quot;Oct&quot;</span><span class="o">;</span> <span class="s2">&quot;Nov&quot;</span><span class="o">;</span> <span class="s2">&quot;Dec&quot;</span> <span class="o">|]</span>

<span class="k">let</span> <span class="n">format_time</span> <span class="n">time</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">tm</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">localtime</span> <span class="n">time</span> <span class="k">in</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;%s %s %2d %02d:%02d:%02d %04d&quot;</span>
    <span class="n">days</span><span class="o">.(</span><span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_wday</span><span class="o">)</span>
    <span class="n">months</span><span class="o">.(</span><span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_mon</span><span class="o">)</span>
    <span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_mday</span>
    <span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_hour</span>
    <span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_min</span>
    <span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_sec</span>
    <span class="o">(</span><span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_year</span> <span class="o">+</span> <span class="mi">1900</span><span class="o">)</span>

<span class="k">let</span> <span class="n">time</span> <span class="o">=</span> <span class="n">fst</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">mktime</span> <span class="o">{</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_sec</span><span class="o">=</span><span class="mi">50</span><span class="o">;</span> <span class="n">tm_min</span><span class="o">=</span><span class="mi">45</span><span class="o">;</span> <span class="n">tm_hour</span><span class="o">=</span><span class="mi">3</span><span class="o">;</span>
                             <span class="n">tm_mday</span><span class="o">=</span><span class="mi">18</span><span class="o">;</span> <span class="n">tm_mon</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">tm_year</span><span class="o">=</span><span class="mi">73</span><span class="o">;</span>
                             <span class="n">tm_wday</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">tm_yday</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">tm_isdst</span><span class="o">=</span><span class="bp">false</span><span class="o">})</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">key</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(-</span><span class="mi">1</span><span class="o">)</span> <span class="k">in</span>
    <span class="k">while</span> <span class="n">key</span> <span class="o">:=</span> <span class="nn">Curses</span><span class="p">.</span><span class="n">getch</span> <span class="bp">()</span><span class="o">;</span> <span class="o">!</span><span class="n">key</span> <span class="o">&lt;&gt;</span> <span class="o">-</span><span class="mi">1</span> <span class="k">do</span>
      <span class="k">if</span> <span class="o">!</span><span class="n">key</span> <span class="o">=</span> <span class="nn">Char</span><span class="p">.</span><span class="n">code</span> <span class="sc">&#39;q&#39;</span> <span class="k">then</span> <span class="k">done&#39;</span> <span class="s2">&quot;See ya&quot;</span> <span class="bp">()</span>
    <span class="k">done</span><span class="o">;</span>

    <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span>
      <span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_in</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot; &quot;</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="n">command</span><span class="o">))</span> <span class="k">in</span>
    <span class="k">begin</span>
      <span class="k">try</span>
        <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">to</span> <span class="n">lines</span> <span class="o">-</span> <span class="mi">1</span> <span class="k">do</span>
          <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">in_channel</span> <span class="k">in</span>
          <span class="n">ignore</span> <span class="o">(</span><span class="nn">Curses</span><span class="p">.</span><span class="n">mvaddstr</span> <span class="n">i</span> <span class="mi">0</span> <span class="n">line</span><span class="o">);</span>

          <span class="nn">Curses</span><span class="p">.</span><span class="n">standout</span> <span class="bp">()</span><span class="o">;</span>
          <span class="n">ignore</span> <span class="o">(</span><span class="nn">Curses</span><span class="p">.</span><span class="n">mvaddstr</span> <span class="o">(</span><span class="n">lines</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="o">(</span><span class="n">cols</span> <span class="o">-</span> <span class="mi">24</span><span class="o">)</span>
                    <span class="o">(</span><span class="n">format_time</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">time</span> <span class="bp">()</span><span class="o">)));</span>
          <span class="nn">Curses</span><span class="p">.</span><span class="n">standend</span> <span class="bp">()</span><span class="o">;</span>

          <span class="n">ignore</span> <span class="o">(</span><span class="nn">Curses</span><span class="p">.</span><span class="n">move</span> <span class="mi">0</span> <span class="mi">0</span><span class="o">);</span>
          <span class="n">ignore</span> <span class="o">(</span><span class="nn">Curses</span><span class="p">.</span><span class="n">refresh</span> <span class="bp">()</span><span class="o">);</span>
        <span class="k">done</span><span class="o">;</span>
        <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_in</span> <span class="n">in_channel</span><span class="o">)</span>
      <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
        <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_in</span> <span class="n">in_channel</span><span class="o">)</span>
    <span class="k">end</span><span class="o">;</span>

    <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">select</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span><span class="o">]</span> <span class="bp">[]</span> <span class="bp">[]</span> <span class="n">timeout</span><span class="o">)</span>
  <span class="k">done</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">err</span> <span class="o">=</span> <span class="nn">Curses</span><span class="p">.</span><span class="n">keypad</span> <span class="n">window</span> <span class="bp">true</span>     <span class="c">(* enable keypad mode *)</span>
<span class="k">let</span> <span class="n">key</span> <span class="o">=</span> <span class="nn">Curses</span><span class="p">.</span><span class="n">getch</span> <span class="bp">()</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="o">(</span><span class="n">key</span> <span class="o">=</span> <span class="o">(</span><span class="nn">Char</span><span class="p">.</span><span class="n">code</span> <span class="sc">&#39;k&#39;</span><span class="o">)</span> <span class="o">||</span>          <span class="c">(* vi mode *)</span>
      <span class="n">key</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">||</span>                       <span class="c">(* emacs mode *)</span>
      <span class="n">key</span> <span class="o">=</span> <span class="nn">Curses</span><span class="p">.</span><span class="nn">Key</span><span class="p">.</span><span class="n">up</span><span class="o">)</span>              <span class="c">(* arrow mode *)</span>
  <span class="k">then</span>
    <span class="k">begin</span>
      <span class="c">(* do something *)</span>
    <span class="k">end</span>

<span class="c">(* @@PLEAC@@_15.13 *)</span>
<span class="c">(* Use perl4caml to integrate OCaml with Perl:</span>
<span class="c">   http://merjis.com/developers/perl4caml *)</span>
<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+perl&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;perl4caml.cma&quot;</span><span class="o">;;</span>

<span class="c">(* Wrap the needed functionality from CPAN&#39;s Expect module: *)</span>
<span class="k">module</span> <span class="nc">Expect</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">open</span> <span class="nc">Perl</span>
  <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">eval</span> <span class="s2">&quot;use Expect&quot;</span>

  <span class="k">exception</span> <span class="nc">Error</span> <span class="k">of</span> <span class="kt">string</span>

  <span class="k">type</span> <span class="n">match_pattern</span> <span class="o">=</span> <span class="nc">Ex</span> <span class="k">of</span> <span class="kt">string</span> <span class="o">|</span> <span class="nc">Re</span> <span class="k">of</span> <span class="kt">string</span>

  <span class="k">class</span> <span class="n">expect</span> <span class="bp">()</span> <span class="o">=</span> <span class="k">object</span> <span class="o">(</span><span class="n">self</span><span class="o">)</span>
    <span class="k">val</span> <span class="n">sv</span> <span class="o">=</span> <span class="n">call_class_method</span> <span class="s2">&quot;Expect&quot;</span> <span class="s2">&quot;new&quot;</span> <span class="bp">[]</span>

    <span class="k">method</span> <span class="n">log_stdout</span> <span class="o">=</span>
      <span class="n">bool_of_sv</span> <span class="o">(</span><span class="n">call_method</span> <span class="n">sv</span> <span class="s2">&quot;log_stdout&quot;</span> <span class="bp">[]</span><span class="o">)</span>

    <span class="k">method</span> <span class="n">set_log_stdout</span> <span class="kt">bool</span> <span class="o">=</span>
      <span class="n">ignore</span> <span class="o">(</span><span class="n">call_method</span> <span class="n">sv</span> <span class="s2">&quot;log_stdout&quot;</span> <span class="o">[</span><span class="n">sv_of_bool</span> <span class="kt">bool</span><span class="o">])</span>

    <span class="k">method</span> <span class="n">spawn</span> <span class="n">command</span> <span class="n">parameters</span> <span class="o">=</span>
      <span class="k">let</span> <span class="n">result</span> <span class="o">=</span>
        <span class="n">call_method</span> <span class="n">sv</span> <span class="s2">&quot;spawn&quot;</span>
          <span class="o">(</span><span class="n">sv_of_string</span> <span class="n">command</span> <span class="o">::</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">sv_of_string</span> <span class="n">parameters</span><span class="o">)</span> <span class="k">in</span>
      <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="n">bool_of_sv</span> <span class="n">result</span><span class="o">)</span>
      <span class="k">then</span> <span class="k">raise</span> <span class="o">(</span><span class="nc">Error</span> <span class="o">(</span><span class="n">string_of_sv</span> <span class="o">(</span><span class="n">eval</span> <span class="s2">&quot;$!&quot;</span><span class="o">)))</span>

    <span class="k">method</span> <span class="n">expect</span> <span class="n">timeout</span> <span class="n">match_patterns</span> <span class="o">=</span>
      <span class="k">let</span> <span class="n">svs_of_pattern</span> <span class="o">=</span> <span class="k">function</span>
        <span class="o">|</span> <span class="nc">Ex</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="o">[</span><span class="n">sv_of_string</span> <span class="s2">&quot;-ex&quot;</span><span class="o">;</span> <span class="n">sv_of_string</span> <span class="n">s</span><span class="o">]</span>
        <span class="o">|</span> <span class="nc">Re</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="o">[</span><span class="n">sv_of_string</span> <span class="s2">&quot;-re&quot;</span><span class="o">;</span> <span class="n">sv_of_string</span> <span class="n">s</span><span class="o">]</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">timeout</span> <span class="o">=</span>
        <span class="k">match</span> <span class="n">timeout</span> <span class="k">with</span>
          <span class="o">|</span> <span class="nc">Some</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">sv_of_int</span> <span class="n">i</span>
          <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="n">sv_undef</span> <span class="bp">()</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">result</span> <span class="o">=</span>
        <span class="n">call_method</span> <span class="n">sv</span> <span class="s2">&quot;expect&quot;</span>
          <span class="o">(</span><span class="n">timeout</span> <span class="o">::</span>
             <span class="nn">List</span><span class="p">.</span><span class="n">flatten</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">svs_of_pattern</span> <span class="n">match_patterns</span><span class="o">))</span> <span class="k">in</span>
      <span class="k">if</span> <span class="n">sv_is_undef</span> <span class="n">result</span>
      <span class="k">then</span> <span class="nc">None</span>
      <span class="k">else</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">int_of_sv</span> <span class="n">result</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span>

    <span class="k">method</span> <span class="n">send</span> <span class="kt">string</span> <span class="o">=</span>
      <span class="n">ignore</span> <span class="o">(</span><span class="n">call_method</span> <span class="n">sv</span> <span class="s2">&quot;send&quot;</span> <span class="o">[</span><span class="n">sv_of_string</span> <span class="kt">string</span><span class="o">])</span>

    <span class="k">method</span> <span class="n">soft_close</span> <span class="bp">()</span> <span class="o">=</span>
      <span class="n">ignore</span> <span class="o">(</span><span class="n">call_method</span> <span class="n">sv</span> <span class="s2">&quot;soft_close&quot;</span> <span class="bp">[]</span><span class="o">)</span>

    <span class="k">method</span> <span class="n">hard_close</span> <span class="bp">()</span> <span class="o">=</span>
      <span class="n">ignore</span> <span class="o">(</span><span class="n">call_method</span> <span class="n">sv</span> <span class="s2">&quot;hard_close&quot;</span> <span class="bp">[]</span><span class="o">)</span>
  <span class="k">end</span>

  <span class="k">let</span> <span class="n">spawn</span> <span class="n">command</span> <span class="n">parameters</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">exp</span> <span class="o">=</span> <span class="k">new</span> <span class="n">expect</span> <span class="bp">()</span> <span class="k">in</span>
    <span class="n">exp</span><span class="o">#</span><span class="n">spawn</span> <span class="n">command</span> <span class="n">parameters</span><span class="o">;</span>
    <span class="n">exp</span>
<span class="k">end</span>

<span class="c">(* start the program *)</span>
<span class="k">let</span> <span class="n">command</span> <span class="o">=</span>
  <span class="k">try</span> <span class="nn">Expect</span><span class="p">.</span><span class="n">spawn</span> <span class="s2">&quot;program to run&quot;</span> <span class="o">[</span><span class="s2">&quot;arg 1&quot;</span><span class="o">;</span> <span class="s2">&quot;arg 2&quot;</span><span class="o">]</span>
  <span class="k">with</span> <span class="nn">Expect</span><span class="p">.</span><span class="nc">Error</span> <span class="n">e</span> <span class="o">-&gt;</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Couldn&#39;t start program: %s</span><span class="se">\n</span><span class="s2">%!&quot;</span> <span class="n">e</span><span class="o">;</span>
    <span class="n">exit</span> <span class="mi">1</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* prevent the program&#39;s output from being shown on our stdout *)</span>
  <span class="n">command</span><span class="o">#</span><span class="n">set_log_stdout</span> <span class="bp">false</span><span class="o">;</span>

  <span class="c">(* wait 10 seconds for &quot;login:&quot; to appear *)</span>
  <span class="k">if</span> <span class="n">command</span><span class="o">#</span><span class="n">expect</span> <span class="o">(</span><span class="nc">Some</span> <span class="mi">10</span><span class="o">)</span> <span class="o">[</span><span class="nn">Expect</span><span class="p">.</span><span class="nc">Ex</span> <span class="s2">&quot;login&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="nc">None</span>
  <span class="k">then</span> <span class="n">failwith</span> <span class="s2">&quot;timed out&quot;</span><span class="o">;</span>

  <span class="c">(* wait 20 seconds for something that matches /[Pp]assword: ?/ *)</span>
  <span class="k">if</span> <span class="n">command</span><span class="o">#</span><span class="n">expect</span> <span class="o">(</span><span class="nc">Some</span> <span class="mi">20</span><span class="o">)</span> <span class="o">[</span><span class="nn">Expect</span><span class="p">.</span><span class="nc">Re</span> <span class="s2">&quot;[Pp]assword: ?&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="nc">None</span>
  <span class="k">then</span> <span class="n">failwith</span> <span class="s2">&quot;timed out&quot;</span><span class="o">;</span>

  <span class="c">(* wait forever for &quot;invalid&quot; to appear *)</span>
  <span class="k">if</span> <span class="n">command</span><span class="o">#</span><span class="n">expect</span> <span class="nc">None</span> <span class="o">[</span><span class="nn">Expect</span><span class="p">.</span><span class="nc">Ex</span> <span class="s2">&quot;invalid&quot;</span><span class="o">]</span> <span class="o">=</span> <span class="nc">None</span>
  <span class="k">then</span> <span class="n">failwith</span> <span class="s2">&quot;error occurred; the program probably went away&quot;</span><span class="o">;</span>

  <span class="c">(* send &quot;Hello, world&quot; and a carriage return to the program *)</span>
  <span class="n">command</span><span class="o">#</span><span class="n">send</span> <span class="s2">&quot;Hello, world</span><span class="se">\r</span><span class="s2">&quot;</span><span class="o">;</span>

  <span class="c">(* if the program will terminate by itself, finish up with *)</span>
  <span class="n">command</span><span class="o">#</span><span class="n">soft_close</span> <span class="bp">()</span><span class="o">;</span>

  <span class="c">(* if the program must be explicitly killed, finish up with *)</span>
  <span class="n">command</span><span class="o">#</span><span class="n">hard_close</span> <span class="bp">()</span>

<span class="c">(* wait for multiple strings *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">command</span><span class="o">#</span><span class="n">expect</span> <span class="o">(</span><span class="nc">Some</span> <span class="mi">30</span><span class="o">)</span>
    <span class="o">[</span><span class="nn">Expect</span><span class="p">.</span><span class="nc">Ex</span> <span class="s2">&quot;invalid&quot;</span><span class="o">;</span> <span class="nn">Expect</span><span class="p">.</span><span class="nc">Ex</span> <span class="s2">&quot;succes&quot;</span><span class="o">;</span>
     <span class="nn">Expect</span><span class="p">.</span><span class="nc">Ex</span> <span class="s2">&quot;error&quot;</span><span class="o">;</span> <span class="nn">Expect</span><span class="p">.</span><span class="nc">Ex</span> <span class="s2">&quot;boom&quot;</span><span class="o">]</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">which</span> <span class="o">-&gt;</span>
          <span class="c">(* found one of those strings *)</span>
          <span class="bp">()</span>
      <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span>
          <span class="bp">()</span>

<span class="c">(* @@PLEAC@@_15.14 *)</span>
<span class="c">(* LablTk is included in the OCaml standard library. *)</span>
<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+labltk&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;labltk.cma&quot;</span><span class="o">;;</span>

<span class="k">open</span> <span class="nc">Tk</span>

<span class="k">let</span> <span class="n">main</span> <span class="o">=</span> <span class="n">openTk</span> <span class="bp">()</span>

<span class="c">(* Create a horizontal space at the top of the window for the</span>
<span class="c">   menu to live in. *)</span>
<span class="k">let</span> <span class="n">menubar</span> <span class="o">=</span> <span class="nn">Frame</span><span class="p">.</span><span class="n">create</span> <span class="o">~</span><span class="n">relief</span><span class="o">:`</span><span class="nc">Raised</span> <span class="o">~</span><span class="n">borderwidth</span><span class="o">:</span><span class="mi">2</span> <span class="n">main</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">pack</span> <span class="o">~</span><span class="n">anchor</span><span class="o">:`</span><span class="nc">Nw</span> <span class="o">~</span><span class="n">fill</span><span class="o">:`</span><span class="nc">X</span> <span class="o">[</span><span class="n">menubar</span><span class="o">]</span>

<span class="c">(* Create a button labeled &quot;File&quot; that brings up a menu *)</span>
<span class="k">let</span> <span class="n">file_menubutton</span> <span class="o">=</span> <span class="nn">Menubutton</span><span class="p">.</span><span class="n">create</span> <span class="o">~</span><span class="n">text</span><span class="o">:</span><span class="s2">&quot;File&quot;</span> <span class="o">~</span><span class="n">underline</span><span class="o">:</span><span class="mi">1</span> <span class="n">menubar</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">pack</span> <span class="o">~</span><span class="n">side</span><span class="o">:`</span><span class="nc">Left</span> <span class="o">[</span><span class="n">file_menubutton</span><span class="o">]</span>

<span class="c">(* Create entries in the &quot;File&quot; menu *)</span>
<span class="k">let</span> <span class="n">file_menu</span> <span class="o">=</span> <span class="nn">Menu</span><span class="p">.</span><span class="n">create</span> <span class="n">file_menubutton</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Menubutton</span><span class="p">.</span><span class="n">configure</span> <span class="o">~</span><span class="n">menu</span><span class="o">:</span><span class="n">file_menu</span> <span class="n">file_menubutton</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Menu</span><span class="p">.</span><span class="n">add_command</span> <span class="o">~</span><span class="n">label</span><span class="o">:</span><span class="s2">&quot;Print&quot;</span> <span class="o">~</span><span class="n">command</span><span class="o">:</span><span class="n">print</span> <span class="n">file_menu</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Menu</span><span class="p">.</span><span class="n">add_command</span> <span class="o">~</span><span class="n">label</span><span class="o">:</span><span class="s2">&quot;Save&quot;</span> <span class="o">~</span><span class="n">command</span><span class="o">:</span><span class="n">save</span> <span class="n">file_menu</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Create a menu item using an anonymous callback *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Menu</span><span class="p">.</span><span class="n">add_command</span>
    <span class="o">~</span><span class="n">label</span><span class="o">:</span><span class="s2">&quot;Quit Immediately&quot;</span>
    <span class="o">~</span><span class="n">command</span><span class="o">:(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="n">exit</span> <span class="mi">0</span><span class="o">)</span>
    <span class="n">file_menu</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Add a separator (a horizontal line) to the menu *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Menu</span><span class="p">.</span><span class="n">add_separator</span> <span class="n">file_menu</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Create a checkbutton menu item *)</span>
<span class="k">let</span> <span class="n">debug</span> <span class="o">=</span> <span class="nn">Textvariable</span><span class="p">.</span><span class="n">create</span> <span class="o">~</span><span class="n">on</span><span class="o">:</span><span class="n">options_menu</span> <span class="bp">()</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Menu</span><span class="p">.</span><span class="n">add_checkbutton</span>
    <span class="o">~</span><span class="n">label</span><span class="o">:</span><span class="s2">&quot;Create Debugging File&quot;</span>
    <span class="o">~</span><span class="n">variable</span><span class="o">:</span><span class="n">debug</span>
    <span class="o">~</span><span class="n">onvalue</span><span class="o">:</span><span class="s2">&quot;1&quot;</span>
    <span class="o">~</span><span class="n">offvalue</span><span class="o">:</span><span class="s2">&quot;0&quot;</span>
    <span class="n">options_menu</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Create radiobutton menu items *)</span>
<span class="k">let</span> <span class="n">log_level</span> <span class="o">=</span> <span class="nn">Textvariable</span><span class="p">.</span><span class="n">create</span> <span class="o">~</span><span class="n">on</span><span class="o">:</span><span class="n">options_menu</span> <span class="bp">()</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Menu</span><span class="p">.</span><span class="n">add_radiobutton</span>
    <span class="o">~</span><span class="n">label</span><span class="o">:</span><span class="s2">&quot;Level 1&quot;</span>
    <span class="o">~</span><span class="n">variable</span><span class="o">:</span><span class="n">log_level</span>
    <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="s2">&quot;1&quot;</span>
    <span class="n">debug_menu</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Menu</span><span class="p">.</span><span class="n">add_radiobutton</span>
    <span class="o">~</span><span class="n">label</span><span class="o">:</span><span class="s2">&quot;Level 2&quot;</span>
    <span class="o">~</span><span class="n">variable</span><span class="o">:</span><span class="n">log_level</span>
    <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="s2">&quot;2&quot;</span>
    <span class="n">debug_menu</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Menu</span><span class="p">.</span><span class="n">add_radiobutton</span>
    <span class="o">~</span><span class="n">label</span><span class="o">:</span><span class="s2">&quot;Level 3&quot;</span>
    <span class="o">~</span><span class="n">variable</span><span class="o">:</span><span class="n">log_level</span>
    <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="s2">&quot;3&quot;</span>
    <span class="n">debug_menu</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Create a nested menu *)</span>
<span class="k">let</span> <span class="n">font_menu</span> <span class="o">=</span> <span class="nn">Menu</span><span class="p">.</span><span class="n">create</span> <span class="n">format_menubutton</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Menu</span><span class="p">.</span><span class="n">add_cascade</span> <span class="o">~</span><span class="n">label</span><span class="o">:</span><span class="s2">&quot;Font&quot;</span> <span class="o">~</span><span class="n">menu</span><span class="o">:</span><span class="n">font_menu</span> <span class="n">format_menu</span>
<span class="k">let</span> <span class="n">font_name</span> <span class="o">=</span> <span class="nn">Textvariable</span><span class="p">.</span><span class="n">create</span> <span class="o">~</span><span class="n">on</span><span class="o">:</span><span class="n">font_menu</span> <span class="bp">()</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Menu</span><span class="p">.</span><span class="n">add_radiobutton</span>
    <span class="o">~</span><span class="n">label</span><span class="o">:</span><span class="s2">&quot;Courier&quot;</span>
    <span class="o">~</span><span class="n">variable</span><span class="o">:</span><span class="n">font_name</span>
    <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="s2">&quot;courier&quot;</span>
    <span class="n">font_menu</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Menu</span><span class="p">.</span><span class="n">add_radiobutton</span>
    <span class="o">~</span><span class="n">label</span><span class="o">:</span><span class="s2">&quot;Times Roman&quot;</span>
    <span class="o">~</span><span class="n">variable</span><span class="o">:</span><span class="n">font_name</span>
    <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="s2">&quot;times&quot;</span>
    <span class="n">font_menu</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* To disable tearoffs, use ~tearoff:false when calling Menu.create *)</span>
<span class="k">let</span> <span class="n">font_menu</span> <span class="o">=</span> <span class="nn">Menu</span><span class="p">.</span><span class="n">create</span> <span class="o">~</span><span class="n">tearoff</span><span class="o">:</span><span class="bp">false</span> <span class="n">format_menubutton</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Start the Tk event loop and display the interface *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Printexc</span><span class="p">.</span><span class="n">print</span> <span class="n">mainLoop</span> <span class="bp">()</span>

<span class="c">(* @@PLEAC@@_15.15 *)</span>
<span class="c">(* Tk::DialogBox is a CPAN module that replaces Tk&#39;s standard Dialog</span>
<span class="c">   widget with one that can be customized with additional inputs. To</span>
<span class="c">   get this effect in OCaml would require translating the whole CPAN</span>
<span class="c">   module; instead, for this simple example, we will use the built-in</span>
<span class="c">   Dialog. *)</span>

<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+labltk&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;labltk.cma&quot;</span><span class="o">;;</span>

<span class="k">open</span> <span class="nc">Tk</span>

<span class="k">let</span> <span class="n">main</span> <span class="o">=</span> <span class="n">openTk</span> <span class="bp">()</span>

<span class="k">let</span> <span class="n">dialog</span> <span class="o">=</span>
  <span class="nn">Dialog</span><span class="p">.</span><span class="n">create</span>
    <span class="o">~</span><span class="n">title</span><span class="o">:</span><span class="s2">&quot;Register This Program&quot;</span>
    <span class="o">~</span><span class="n">buttons</span><span class="o">:[</span><span class="s2">&quot;Register&quot;</span><span class="o">;</span> <span class="s2">&quot;Cancel&quot;</span><span class="o">]</span>
    <span class="o">~</span><span class="n">parent</span><span class="o">:</span><span class="n">main</span>
    <span class="o">~</span><span class="n">message</span><span class="o">:</span><span class="s2">&quot;...&quot;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">dialog</span> <span class="bp">()</span> <span class="k">with</span>
    <span class="o">|</span> <span class="mi">0</span> <span class="o">-&gt;</span> <span class="n">print_endline</span> <span class="s2">&quot;Register&quot;</span>
    <span class="o">|</span> <span class="mi">1</span> <span class="o">-&gt;</span> <span class="n">print_endline</span> <span class="s2">&quot;Cancel&quot;</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">&quot;this shouldn&#39;t happen&quot;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Printexc</span><span class="p">.</span><span class="n">print</span> <span class="n">mainLoop</span> <span class="bp">()</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Normally, uncaught exceptions are printed to standard error. However,</span>
<span class="c">   by overriding the &quot;camlcb&quot; callback, a custom error handler can be</span>
<span class="c">   installed which creates dialogs instead. *)</span>

<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+labltk&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;labltk.cma&quot;</span><span class="o">;;</span>

<span class="k">open</span> <span class="nc">Tk</span>

<span class="k">let</span> <span class="n">main</span> <span class="o">=</span> <span class="n">openTk</span> <span class="bp">()</span>

<span class="k">let</span> <span class="n">show_error</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">dialog</span> <span class="o">=</span>
    <span class="nn">Dialog</span><span class="p">.</span><span class="n">create</span>
      <span class="o">~</span><span class="n">title</span><span class="o">:</span><span class="s2">&quot;Error&quot;</span>
      <span class="o">~</span><span class="n">buttons</span><span class="o">:[</span><span class="s2">&quot;Acknowledge&quot;</span><span class="o">]</span>
      <span class="o">~</span><span class="n">parent</span><span class="o">:</span><span class="n">main</span> <span class="k">in</span>
  <span class="k">fun</span> <span class="n">message</span> <span class="o">-&gt;</span> <span class="n">ignore</span> <span class="o">(</span><span class="n">dialog</span> <span class="o">~</span><span class="n">message</span> <span class="bp">()</span><span class="o">)</span>

<span class="c">(* Override the &quot;camlcb&quot; callback. Note that this is an undocumented</span>
<span class="c">   feature that relies on some internals of Labltk. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Callback</span><span class="p">.</span><span class="n">register</span> <span class="s2">&quot;camlcb&quot;</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">id</span> <span class="n">args</span> <span class="o">-&gt;</span>
       <span class="k">try</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="nn">Protocol</span><span class="p">.</span><span class="n">callback_naming_table</span> <span class="n">id</span><span class="o">)</span> <span class="n">args</span>
       <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">show_error</span> <span class="o">(</span><span class="nn">Printexc</span><span class="p">.</span><span class="n">to_string</span> <span class="n">e</span><span class="o">))</span>

<span class="k">let</span> <span class="n">make_error</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">failwith</span> <span class="s2">&quot;This is an error&quot;</span>

<span class="k">let</span> <span class="n">button1</span> <span class="o">=</span>
  <span class="nn">Button</span><span class="p">.</span><span class="n">create</span> <span class="o">~</span><span class="n">text</span><span class="o">:</span><span class="s2">&quot;Make An Error&quot;</span> <span class="o">~</span><span class="n">command</span><span class="o">:</span><span class="n">make_error</span> <span class="n">main</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">pack</span> <span class="o">~</span><span class="n">side</span><span class="o">:`</span><span class="nc">Left</span> <span class="o">[</span><span class="n">button1</span><span class="o">]</span>

<span class="k">let</span> <span class="n">button2</span> <span class="o">=</span>
  <span class="nn">Button</span><span class="p">.</span><span class="n">create</span> <span class="o">~</span><span class="n">text</span><span class="o">:</span><span class="s2">&quot;Quit&quot;</span> <span class="o">~</span><span class="n">command</span><span class="o">:(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="n">exit</span> <span class="mi">0</span><span class="o">)</span> <span class="n">main</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">pack</span> <span class="o">~</span><span class="n">side</span><span class="o">:`</span><span class="nc">Left</span> <span class="o">[</span><span class="n">button2</span><span class="o">]</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Printexc</span><span class="p">.</span><span class="n">print</span> <span class="n">mainLoop</span> <span class="bp">()</span>

<span class="c">(* @@PLEAC@@_15.16 *)</span>
<span class="k">open</span> <span class="nc">Tk</span>

<span class="k">let</span> <span class="n">main</span> <span class="o">=</span> <span class="n">openTk</span> <span class="bp">()</span>

<span class="c">(* Prevent the user from resizing the window. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">bind</span> <span class="n">main</span>
    <span class="o">~</span><span class="n">events</span><span class="o">:[`</span><span class="nc">Configure</span><span class="o">]</span>
    <span class="o">~</span><span class="n">action</span><span class="o">:(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span>
               <span class="k">let</span> <span class="n">width</span> <span class="o">=</span> <span class="nn">Winfo</span><span class="p">.</span><span class="n">width</span> <span class="n">main</span> <span class="k">in</span>
               <span class="k">let</span> <span class="n">height</span> <span class="o">=</span> <span class="nn">Winfo</span><span class="p">.</span><span class="n">height</span> <span class="n">main</span> <span class="k">in</span>
               <span class="nn">Wm</span><span class="p">.</span><span class="n">minsize_set</span> <span class="n">main</span> <span class="n">width</span> <span class="n">height</span><span class="o">;</span>
               <span class="nn">Wm</span><span class="p">.</span><span class="n">maxsize_set</span> <span class="n">main</span> <span class="n">width</span> <span class="n">height</span><span class="o">)</span>

<span class="c">(* Or, use pack to control how widgets are resized. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">pack</span> <span class="o">~</span><span class="n">fill</span><span class="o">:`</span><span class="nc">Both</span> <span class="o">~</span><span class="n">expand</span><span class="o">:</span><span class="bp">true</span> <span class="o">[</span><span class="n">widget</span><span class="o">]</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">pack</span> <span class="o">~</span><span class="n">fill</span><span class="o">:`</span><span class="nc">X</span> <span class="o">~</span><span class="n">expand</span><span class="o">:</span><span class="bp">true</span> <span class="o">[</span><span class="n">widget</span><span class="o">]</span>

<span class="c">(* Make the main area expand horizontally and vertically. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">pack</span> <span class="o">~</span><span class="n">fill</span><span class="o">:`</span><span class="nc">Both</span> <span class="o">~</span><span class="n">expand</span><span class="o">:</span><span class="bp">true</span> <span class="o">[</span><span class="n">mainarea</span><span class="o">]</span>

<span class="c">(* Make the menu bar only expand horizontally. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">pack</span> <span class="o">~</span><span class="n">fill</span><span class="o">:`</span><span class="nc">X</span> <span class="o">~</span><span class="n">expand</span><span class="o">:</span><span class="bp">true</span> <span class="o">[</span><span class="n">menubar</span><span class="o">]</span>

<span class="c">(* Anchor the menu bar to the top-left corner. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">pack</span> <span class="o">~</span><span class="n">fill</span><span class="o">:`</span><span class="nc">X</span> <span class="o">~</span><span class="n">expand</span><span class="o">:</span><span class="bp">true</span> <span class="o">~</span><span class="n">anchor</span><span class="o">:`</span><span class="nc">Nw</span> <span class="o">[</span><span class="n">menubar</span><span class="o">]</span>

<span class="c">(* @@PLEAC@@_15.17 *)</span>
<span class="c">(* Use Harry Chomsky&#39;s mkwinapp.ml from the OCaml-Win32 project:</span>

<span class="c">   http://ocaml-win32.sourceforge.net/</span>

<span class="c">   Compile your program using the native compiler and run mkwinapp.exe</span>
<span class="c">   on the result. *)</span>

<span class="nc">C</span><span class="o">:</span><span class="err">\</span><span class="nc">MyProg</span><span class="o">&gt;</span> <span class="n">ocamlopt</span> <span class="n">myprog</span><span class="o">.</span><span class="n">ml</span> <span class="o">-</span><span class="n">o</span> <span class="n">myprog</span><span class="o">.</span><span class="n">exe</span>
<span class="nc">C</span><span class="o">:</span><span class="err">\</span><span class="nc">MyProg</span><span class="o">&gt;</span> <span class="n">ocamlopt</span> <span class="n">unix</span><span class="o">.</span><span class="n">cmxa</span> <span class="n">mkwinapp</span><span class="o">.</span><span class="n">ml</span> <span class="o">-</span><span class="n">o</span> <span class="n">mkwinapp</span><span class="o">.</span><span class="n">exe</span>
<span class="nc">C</span><span class="o">:</span><span class="err">\</span><span class="nc">MyProg</span><span class="o">&gt;</span> <span class="n">mkwinapp</span> <span class="n">myprog</span><span class="o">.</span><span class="n">exe</span>

<span class="c">(* Now you can run &quot;myprog&quot; and you won&#39;t get a console window. *)</span>

<span class="c">(* @@PLEAC@@_15.18 *)</span>
<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>

<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+curses&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;curses.cma&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">delay</span> <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="mi">005</span>

<span class="c">(* Bounce lines around the screen until the user interrupts with</span>
<span class="c">   Ctrl-C. *)</span>
<span class="k">let</span> <span class="n">zip</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Curses</span><span class="p">.</span><span class="n">clear</span> <span class="bp">()</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">maxcol</span><span class="o">,</span> <span class="n">maxrow</span> <span class="o">=</span> <span class="nn">Curses</span><span class="p">.</span><span class="n">get_size</span> <span class="bp">()</span> <span class="k">in</span>

  <span class="k">let</span> <span class="n">chars</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">[</span><span class="sc">&#39;*&#39;</span><span class="o">;</span> <span class="sc">&#39;-&#39;</span><span class="o">;</span> <span class="sc">&#39;/&#39;</span><span class="o">;</span> <span class="sc">&#39;|&#39;</span><span class="o">;</span> <span class="sc">&#39;\\&#39;</span><span class="o">;</span> <span class="sc">&#39;_&#39;</span><span class="o">]</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">circle</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">chars</span> <span class="o">:=</span> <span class="nn">List</span><span class="p">.</span><span class="n">tl</span> <span class="o">!</span><span class="n">chars</span> <span class="o">@</span> <span class="o">[</span><span class="nn">List</span><span class="p">.</span><span class="n">hd</span> <span class="o">!</span><span class="n">chars</span><span class="o">]</span> <span class="k">in</span>

  <span class="k">let</span> <span class="n">row</span><span class="o">,</span> <span class="n">col</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span><span class="o">,</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">row_sign</span><span class="o">,</span> <span class="n">col_sign</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">1</span><span class="o">,</span> <span class="n">ref</span> <span class="mi">1</span> <span class="k">in</span>

  <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
    <span class="n">ignore</span> <span class="o">(</span><span class="nn">Curses</span><span class="p">.</span><span class="n">mvaddch</span> <span class="o">!</span><span class="n">col</span> <span class="o">!</span><span class="n">row</span> <span class="o">(</span><span class="nn">Char</span><span class="p">.</span><span class="n">code</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">hd</span> <span class="o">!</span><span class="n">chars</span><span class="o">)));</span>
    <span class="n">ignore</span> <span class="o">(</span><span class="nn">Curses</span><span class="p">.</span><span class="n">refresh</span> <span class="bp">()</span><span class="o">);</span>
    <span class="o">(</span><span class="k">try</span> <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">select</span> <span class="bp">[]</span> <span class="bp">[]</span> <span class="bp">[]</span> <span class="n">delay</span><span class="o">)</span> <span class="k">with</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">);</span>
    <span class="n">row</span> <span class="o">:=</span> <span class="o">!</span><span class="n">row</span> <span class="o">+</span> <span class="o">!</span><span class="n">row_sign</span><span class="o">;</span>
    <span class="n">col</span> <span class="o">:=</span> <span class="o">!</span><span class="n">col</span> <span class="o">+</span> <span class="o">!</span><span class="n">col_sign</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">!</span><span class="n">row</span> <span class="o">=</span> <span class="n">maxrow</span> <span class="k">then</span> <span class="o">(</span><span class="n">row_sign</span> <span class="o">:=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span> <span class="n">circle</span> <span class="bp">()</span><span class="o">)</span>
    <span class="k">else</span> <span class="k">if</span> <span class="o">!</span><span class="n">row</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">then</span> <span class="o">(</span><span class="n">row_sign</span> <span class="o">:=</span>  <span class="mi">1</span><span class="o">;</span> <span class="n">circle</span> <span class="bp">()</span><span class="o">);</span>
    <span class="k">if</span> <span class="o">!</span><span class="n">col</span> <span class="o">=</span> <span class="n">maxcol</span> <span class="k">then</span> <span class="o">(</span><span class="n">col_sign</span> <span class="o">:=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span> <span class="n">circle</span> <span class="bp">()</span><span class="o">)</span>
    <span class="k">else</span> <span class="k">if</span> <span class="o">!</span><span class="n">col</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">then</span> <span class="o">(</span><span class="n">col_sign</span> <span class="o">:=</span>  <span class="mi">1</span><span class="o">;</span> <span class="n">circle</span> <span class="bp">()</span><span class="o">)</span>
  <span class="k">done</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Curses</span><span class="p">.</span><span class="n">initscr</span> <span class="bp">()</span><span class="o">);</span>
  <span class="n">at_exit</span> <span class="nn">Curses</span><span class="p">.</span><span class="n">endwin</span><span class="o">;</span>
  <span class="n">zip</span> <span class="bp">()</span>

<span class="c">(* @@PLEAC@@_15.19 *)</span>
<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* tkshufflepod - reorder =head1 sections in a pod file *)</span>
<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+labltk&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;labltk.cma&quot;</span><span class="o">;;</span>

<span class="k">open</span> <span class="nc">Tk</span>

<span class="c">(* Custom text viewer widget. *)</span>

<span class="k">class</span> <span class="n">viewer</span> <span class="n">parent</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">toplevel</span> <span class="o">=</span> <span class="nn">Toplevel</span><span class="p">.</span><span class="n">create</span> <span class="n">parent</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">frame</span> <span class="o">=</span> <span class="nn">Frame</span><span class="p">.</span><span class="n">create</span> <span class="n">toplevel</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">text</span> <span class="o">=</span> <span class="nn">Text</span><span class="p">.</span><span class="n">create</span> <span class="o">~</span><span class="n">width</span><span class="o">:</span><span class="mi">80</span> <span class="o">~</span><span class="n">height</span><span class="o">:</span><span class="mi">30</span> <span class="o">~</span><span class="n">state</span><span class="o">:`</span><span class="nc">Disabled</span> <span class="n">frame</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">vscroll</span> <span class="o">=</span> <span class="nn">Scrollbar</span><span class="p">.</span><span class="n">create</span> <span class="o">~</span><span class="n">orient</span><span class="o">:`</span><span class="nc">Vertical</span> <span class="n">frame</span> <span class="k">in</span>

<span class="k">object</span> <span class="o">(</span><span class="n">self</span><span class="o">)</span>
  <span class="k">initializer</span>
    <span class="n">self</span><span class="o">#</span><span class="n">hide</span> <span class="bp">()</span><span class="o">;</span>
    <span class="nn">Text</span><span class="p">.</span><span class="n">configure</span> <span class="o">~</span><span class="n">yscrollcommand</span><span class="o">:(</span><span class="nn">Scrollbar</span><span class="p">.</span><span class="n">set</span> <span class="n">vscroll</span><span class="o">)</span> <span class="n">text</span><span class="o">;</span>
    <span class="nn">Scrollbar</span><span class="p">.</span><span class="n">configure</span> <span class="o">~</span><span class="n">command</span><span class="o">:(</span><span class="nn">Text</span><span class="p">.</span><span class="n">yview</span> <span class="n">text</span><span class="o">)</span> <span class="n">vscroll</span><span class="o">;</span>
    <span class="n">pack</span> <span class="o">~</span><span class="n">side</span><span class="o">:`</span><span class="nc">Right</span> <span class="o">~</span><span class="n">fill</span><span class="o">:`</span><span class="nc">Y</span> <span class="o">[</span><span class="n">vscroll</span><span class="o">];</span>
    <span class="n">pack</span> <span class="o">~</span><span class="n">side</span><span class="o">:`</span><span class="nc">Left</span> <span class="o">~</span><span class="n">fill</span><span class="o">:`</span><span class="nc">Both</span> <span class="o">~</span><span class="n">expand</span><span class="o">:</span><span class="bp">true</span> <span class="o">[</span><span class="n">text</span><span class="o">];</span>
    <span class="n">pack</span> <span class="o">~</span><span class="n">side</span><span class="o">:`</span><span class="nc">Right</span> <span class="o">~</span><span class="n">fill</span><span class="o">:`</span><span class="nc">Both</span> <span class="o">~</span><span class="n">expand</span><span class="o">:</span><span class="bp">true</span> <span class="o">[</span><span class="n">frame</span><span class="o">];</span>
    <span class="nn">Wm</span><span class="p">.</span><span class="n">protocol_set</span> <span class="n">toplevel</span> <span class="s2">&quot;WM_DELETE_WINDOW&quot;</span> <span class="n">self</span><span class="o">#</span><span class="n">hide</span>

  <span class="k">method</span> <span class="n">show</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Wm</span><span class="p">.</span><span class="n">deiconify</span> <span class="n">toplevel</span><span class="o">;</span> <span class="n">raise_window</span> <span class="n">toplevel</span>
  <span class="k">method</span> <span class="n">hide</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Wm</span><span class="p">.</span><span class="n">withdraw</span> <span class="n">toplevel</span>

  <span class="k">method</span> <span class="n">set_title</span> <span class="o">=</span> <span class="nn">Wm</span><span class="p">.</span><span class="n">title_set</span> <span class="n">toplevel</span>
  <span class="k">method</span> <span class="n">set_body</span> <span class="n">body</span> <span class="o">=</span>
    <span class="nn">Text</span><span class="p">.</span><span class="n">configure</span> <span class="o">~</span><span class="n">state</span><span class="o">:`</span><span class="nc">Normal</span> <span class="n">text</span><span class="o">;</span>
    <span class="nn">Text</span><span class="p">.</span><span class="n">delete</span> <span class="o">~</span><span class="n">start</span><span class="o">:(`</span><span class="nc">Atxy</span> <span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">0</span><span class="o">),</span> <span class="bp">[]</span><span class="o">)</span> <span class="o">~</span><span class="n">stop</span><span class="o">:(`</span><span class="nc">End</span><span class="o">,</span> <span class="bp">[]</span><span class="o">)</span> <span class="n">text</span><span class="o">;</span>
    <span class="nn">Text</span><span class="p">.</span><span class="n">insert</span> <span class="o">~</span><span class="n">index</span><span class="o">:(`</span><span class="nc">End</span><span class="o">,</span> <span class="bp">[]</span><span class="o">)</span> <span class="o">~</span><span class="n">text</span><span class="o">:</span><span class="n">body</span> <span class="n">text</span><span class="o">;</span>
    <span class="nn">Text</span><span class="p">.</span><span class="n">configure</span> <span class="o">~</span><span class="n">state</span><span class="o">:`</span><span class="nc">Disabled</span> <span class="n">text</span>
<span class="k">end</span>

<span class="c">(* Give list references a similar interface to Tk</span>
<span class="c">   listbox widgets so we can keep the two in sync. *)</span>

<span class="k">let</span> <span class="n">listref_get</span> <span class="n">listref</span> <span class="n">index</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">index</span> <span class="k">with</span>
    <span class="o">|</span> <span class="o">`</span><span class="nc">Num</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">nth</span> <span class="o">!</span><span class="n">listref</span> <span class="n">i</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">&quot;listref_get&quot;</span>

<span class="k">let</span> <span class="n">listref_delete</span> <span class="n">listref</span> <span class="n">index</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">index</span> <span class="k">with</span>
    <span class="o">|</span> <span class="o">`</span><span class="nc">Num</span> <span class="n">i</span> <span class="o">-&gt;</span>
        <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span> <span class="n">current</span> <span class="kt">list</span> <span class="o">=</span>
          <span class="k">match</span> <span class="kt">list</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">head</span> <span class="o">::</span> <span class="n">tail</span> <span class="k">when</span> <span class="n">current</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="o">(</span><span class="n">current</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">tail</span>
            <span class="o">|</span> <span class="n">head</span> <span class="o">::</span> <span class="n">tail</span> <span class="o">-&gt;</span> <span class="n">head</span> <span class="o">::</span> <span class="n">loop</span> <span class="o">(</span><span class="n">current</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">tail</span>
            <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="bp">[]</span> <span class="k">in</span>
        <span class="n">listref</span> <span class="o">:=</span> <span class="n">loop</span> <span class="mi">0</span> <span class="o">!</span><span class="n">listref</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">&quot;listref_delete&quot;</span>

<span class="k">let</span> <span class="n">listref_insert</span> <span class="n">listref</span> <span class="n">index</span> <span class="n">elt</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">index</span> <span class="k">with</span>
    <span class="o">|</span> <span class="o">`</span><span class="nc">Num</span> <span class="n">i</span> <span class="o">-&gt;</span>
        <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span> <span class="n">current</span> <span class="kt">list</span> <span class="o">=</span>
          <span class="k">match</span> <span class="kt">list</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">head</span> <span class="o">::</span> <span class="n">tail</span> <span class="k">when</span> <span class="n">current</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-&gt;</span>
                <span class="n">elt</span> <span class="o">::</span> <span class="n">head</span> <span class="o">::</span> <span class="n">loop</span> <span class="o">(</span><span class="n">current</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">tail</span>
            <span class="o">|</span> <span class="n">head</span> <span class="o">::</span> <span class="bp">[]</span> <span class="k">when</span> <span class="n">current</span> <span class="o">=</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-&gt;</span> <span class="n">head</span> <span class="o">::</span> <span class="o">[</span><span class="n">elt</span><span class="o">]</span>
            <span class="o">|</span> <span class="n">head</span> <span class="o">::</span> <span class="n">tail</span> <span class="o">-&gt;</span> <span class="n">head</span> <span class="o">::</span> <span class="n">loop</span> <span class="o">(</span><span class="n">current</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="n">tail</span>
            <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="bp">[]</span> <span class="k">in</span>
        <span class="n">listref</span> <span class="o">:=</span> <span class="n">loop</span> <span class="mi">0</span> <span class="o">!</span><span class="n">listref</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">&quot;listref_insert&quot;</span>

<span class="c">(* Use a line stream to produce a stream of POD chunks. *)</span>

<span class="k">let</span> <span class="n">line_stream_of_channel</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">channel</span><span class="o">)</span> <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="nc">None</span><span class="o">)</span>

<span class="k">let</span> <span class="n">pod_stream_of_channel</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">line_stream_of_channel</span> <span class="n">channel</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">is_head</span> <span class="n">s</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span> <span class="o">&gt;=</span> <span class="mi">6</span> <span class="o">&amp;&amp;</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">s</span> <span class="mi">0</span> <span class="mi">6</span> <span class="o">=</span> <span class="s2">&quot;=head1&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">next</span> <span class="n">pod_head</span> <span class="n">pod_lines</span> <span class="n">i</span> <span class="o">=</span>
    <span class="k">match</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">peek</span> <span class="n">lines</span><span class="o">,</span> <span class="n">pod_head</span><span class="o">,</span> <span class="n">pod_lines</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">None</span><span class="o">,</span> <span class="s2">&quot;&quot;</span><span class="o">,</span> <span class="o">_</span> <span class="o">-&gt;</span>
          <span class="c">(* EOF, no POD found, return EOF *)</span>
          <span class="nc">None</span>
      <span class="o">|</span> <span class="nc">None</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_</span> <span class="o">-&gt;</span>
          <span class="c">(* EOF, POD found, return POD *)</span>
          <span class="nc">Some</span> <span class="o">(</span><span class="n">pod_head</span><span class="o">,</span> <span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="n">pod_lines</span><span class="o">)</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">head</span><span class="o">,</span> <span class="s2">&quot;&quot;</span><span class="o">,</span> <span class="o">_</span> <span class="k">when</span> <span class="n">is_head</span> <span class="n">head</span> <span class="o">-&gt;</span>
          <span class="c">(* Head found *)</span>
          <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">lines</span><span class="o">;</span>
          <span class="n">next</span> <span class="n">head</span> <span class="bp">[]</span> <span class="n">i</span>
      <span class="o">|</span> <span class="o">_,</span> <span class="s2">&quot;&quot;</span><span class="o">,</span> <span class="o">_</span> <span class="o">-&gt;</span>
          <span class="c">(* No head found, keep looking *)</span>
          <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">lines</span><span class="o">;</span>
          <span class="n">next</span> <span class="s2">&quot;&quot;</span> <span class="bp">[]</span> <span class="n">i</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">head</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_</span> <span class="k">when</span> <span class="n">is_head</span> <span class="n">head</span> <span class="o">-&gt;</span>
          <span class="c">(* Next head found, return POD *)</span>
          <span class="nc">Some</span> <span class="o">(</span><span class="n">pod_head</span><span class="o">,</span> <span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="n">pod_lines</span><span class="o">)</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">line</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_</span> <span class="o">-&gt;</span>
          <span class="c">(* Line found, buffer and continue reading *)</span>
          <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">lines</span><span class="o">;</span>
          <span class="n">next</span> <span class="n">pod_head</span> <span class="o">(</span><span class="n">line</span> <span class="o">::</span> <span class="n">pod_lines</span><span class="o">)</span> <span class="n">i</span> <span class="k">in</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span> <span class="o">(</span><span class="n">next</span> <span class="s2">&quot;&quot;</span> <span class="bp">[]</span><span class="o">)</span>

<span class="c">(* Read the POD file into memory, and split it into sections. *)</span>

<span class="k">let</span> <span class="n">podfile</span> <span class="o">=</span>
  <span class="k">if</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="o">&lt;</span> <span class="mi">2</span>
  <span class="k">then</span> <span class="s2">&quot;-&quot;</span>
  <span class="k">else</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span>

<span class="k">let</span> <span class="n">sections</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span>

<span class="c">(* Turn !sections into a list of (text, head) pairs. *)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">channel</span> <span class="o">=</span> <span class="k">if</span> <span class="n">podfile</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span> <span class="k">then</span> <span class="n">stdin</span> <span class="k">else</span> <span class="n">open_in</span> <span class="n">podfile</span> <span class="k">in</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">head</span><span class="o">,</span> <span class="n">lines</span><span class="o">)</span> <span class="o">-&gt;</span>
       <span class="n">sections</span> <span class="o">:=</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">lines</span><span class="o">,</span> <span class="n">head</span><span class="o">)</span> <span class="o">::</span> <span class="o">!</span><span class="n">sections</span><span class="o">)</span>
    <span class="o">(</span><span class="n">pod_stream_of_channel</span> <span class="n">channel</span><span class="o">);</span>
  <span class="n">sections</span> <span class="o">:=</span> <span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="o">!</span><span class="n">sections</span><span class="o">;</span>
  <span class="n">close_in</span> <span class="n">channel</span>

<span class="c">(* Fire up Tk and display the list of sections. *)</span>
<span class="k">let</span> <span class="n">main</span> <span class="o">=</span> <span class="n">openTk</span> <span class="bp">()</span>
<span class="k">let</span> <span class="n">listbox</span> <span class="o">=</span> <span class="nn">Listbox</span><span class="p">.</span><span class="n">create</span> <span class="o">~</span><span class="n">width</span><span class="o">:</span><span class="mi">60</span> <span class="n">main</span>
<span class="k">let</span> <span class="n">dragging</span> <span class="o">=</span> <span class="n">ref</span> <span class="nc">None</span>

<span class="c">(* Singleton viewer instance. *)</span>
<span class="k">let</span> <span class="n">viewer</span> <span class="o">=</span> <span class="k">new</span> <span class="n">viewer</span> <span class="n">main</span>

<span class="c">(* Called when the user clicks on an item in the Listbox. *)</span>
<span class="k">let</span> <span class="n">down</span> <span class="n">event</span> <span class="o">=</span>
  <span class="n">dragging</span> <span class="o">:=</span> <span class="nc">Some</span> <span class="o">(</span><span class="nn">Listbox</span><span class="p">.</span><span class="n">nearest</span> <span class="n">listbox</span> <span class="n">event</span><span class="o">.</span><span class="n">ev_MouseY</span><span class="o">)</span>

<span class="c">(* Called when the user releases the mouse button in the Listbox. *)</span>
<span class="k">let</span> <span class="n">up</span> <span class="n">event</span> <span class="o">=</span>
  <span class="n">dragging</span> <span class="o">:=</span> <span class="nc">None</span>

<span class="c">(* Called when the user moves the mouse in the Listbox. *)</span>
<span class="k">let</span> <span class="n">move</span> <span class="n">event</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">dest</span> <span class="o">=</span> <span class="nn">Listbox</span><span class="p">.</span><span class="n">nearest</span> <span class="n">listbox</span> <span class="n">event</span><span class="o">.</span><span class="n">ev_MouseY</span> <span class="k">in</span>
  <span class="k">match</span> <span class="o">!</span><span class="n">dragging</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">Some</span> <span class="n">src</span> <span class="k">when</span> <span class="n">src</span> <span class="o">&lt;&gt;</span> <span class="n">dest</span> <span class="o">-&gt;</span>
        <span class="k">let</span> <span class="n">elt</span> <span class="o">=</span> <span class="n">listref_get</span> <span class="n">sections</span> <span class="n">src</span> <span class="k">in</span>
        <span class="n">listref_delete</span> <span class="n">sections</span> <span class="n">src</span><span class="o">;</span>
        <span class="n">listref_insert</span> <span class="n">sections</span> <span class="n">dest</span> <span class="n">elt</span><span class="o">;</span>
        <span class="k">let</span> <span class="n">elt</span> <span class="o">=</span> <span class="nn">Listbox</span><span class="p">.</span><span class="n">get</span> <span class="n">listbox</span> <span class="n">src</span> <span class="k">in</span>
        <span class="nn">Listbox</span><span class="p">.</span><span class="n">delete</span> <span class="n">listbox</span> <span class="o">~</span><span class="n">first</span><span class="o">:</span><span class="n">src</span> <span class="o">~</span><span class="n">last</span><span class="o">:</span><span class="n">src</span><span class="o">;</span>
        <span class="nn">Listbox</span><span class="p">.</span><span class="n">insert</span> <span class="n">listbox</span> <span class="o">~</span><span class="n">index</span><span class="o">:</span><span class="n">dest</span> <span class="o">~</span><span class="n">texts</span><span class="o">:[</span><span class="n">elt</span><span class="o">];</span>
        <span class="n">dragging</span> <span class="o">:=</span> <span class="nc">Some</span> <span class="n">dest</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span>

<span class="c">(* Called to save the list of sections. *)</span>
<span class="k">let</span> <span class="n">save</span> <span class="n">event</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">channel</span> <span class="o">=</span> <span class="k">if</span> <span class="n">podfile</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span> <span class="k">then</span> <span class="n">stdout</span> <span class="k">else</span> <span class="n">open_out</span> <span class="n">podfile</span> <span class="k">in</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">text</span><span class="o">,</span> <span class="n">head</span><span class="o">)</span> <span class="o">-&gt;</span>
       <span class="n">output_string</span> <span class="n">channel</span> <span class="n">head</span><span class="o">;</span>
       <span class="n">output_string</span> <span class="n">channel</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
       <span class="n">output_string</span> <span class="n">channel</span> <span class="n">text</span><span class="o">;</span>
       <span class="n">output_string</span> <span class="n">channel</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
       <span class="n">flush</span> <span class="n">channel</span><span class="o">)</span>
    <span class="o">!</span><span class="n">sections</span><span class="o">;</span>
  <span class="k">if</span> <span class="n">podfile</span> <span class="o">&lt;&gt;</span> <span class="s2">&quot;-&quot;</span> <span class="k">then</span> <span class="n">close_out</span> <span class="n">channel</span>

<span class="c">(* Called to display the widget.  Uses the viewer widget. *)</span>
<span class="k">let</span> <span class="n">view</span> <span class="n">event</span> <span class="o">=</span>
  <span class="n">dragging</span> <span class="o">:=</span> <span class="nc">None</span><span class="o">;</span> <span class="c">(* cancel drag *)</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">(`</span><span class="nc">Num</span> <span class="n">i</span><span class="o">)</span> <span class="o">-&gt;</span>
       <span class="k">let</span> <span class="o">(</span><span class="n">text</span><span class="o">,</span> <span class="n">head</span><span class="o">)</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">nth</span> <span class="o">!</span><span class="n">sections</span> <span class="n">i</span> <span class="k">in</span>
       <span class="n">viewer</span><span class="o">#</span><span class="n">set_title</span> <span class="n">head</span><span class="o">;</span>
       <span class="n">viewer</span><span class="o">#</span><span class="n">set_body</span> <span class="o">(</span><span class="n">head</span> <span class="o">^</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">^</span> <span class="n">text</span><span class="o">);</span>
       <span class="n">viewer</span><span class="o">#</span><span class="n">show</span> <span class="bp">()</span><span class="o">)</span>
    <span class="o">(</span><span class="nn">Listbox</span><span class="p">.</span><span class="n">curselection</span> <span class="n">listbox</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">pack</span> <span class="o">~</span><span class="n">expand</span><span class="o">:</span><span class="bp">true</span> <span class="o">~</span><span class="n">fill</span><span class="o">:`</span><span class="nc">Both</span> <span class="o">[</span><span class="n">listbox</span><span class="o">];</span>

  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">text</span><span class="o">,</span> <span class="n">title</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nn">Listbox</span><span class="p">.</span><span class="n">insert</span> <span class="n">listbox</span> <span class="o">`</span><span class="nc">End</span> <span class="o">[</span><span class="n">title</span><span class="o">])</span>
    <span class="o">!</span><span class="n">sections</span><span class="o">;</span>

  <span class="c">(* Permit dragging by binding to the Listbox widget. *)</span>
  <span class="n">bind</span> <span class="o">~</span><span class="n">events</span><span class="o">:[`</span><span class="nc">ButtonPress</span><span class="o">]</span> <span class="o">~</span><span class="n">fields</span><span class="o">:[`</span><span class="nc">MouseY</span><span class="o">]</span> <span class="o">~</span><span class="n">action</span><span class="o">:</span><span class="n">down</span> <span class="n">listbox</span><span class="o">;</span>
  <span class="n">bind</span> <span class="o">~</span><span class="n">events</span><span class="o">:[`</span><span class="nc">ButtonRelease</span><span class="o">]</span> <span class="o">~</span><span class="n">action</span><span class="o">:</span><span class="n">up</span> <span class="n">listbox</span><span class="o">;</span>
  <span class="n">bind</span> <span class="o">~</span><span class="n">events</span><span class="o">:[`</span><span class="nc">Motion</span><span class="o">]</span> <span class="o">~</span><span class="n">fields</span><span class="o">:[`</span><span class="nc">MouseY</span><span class="o">]</span> <span class="o">~</span><span class="n">action</span><span class="o">:</span><span class="n">move</span> <span class="n">listbox</span><span class="o">;</span>

  <span class="c">(* Permit viewing by binding double-click. *)</span>
  <span class="n">bind</span> <span class="o">~</span><span class="n">events</span><span class="o">:[`</span><span class="nc">Modified</span> <span class="o">([`</span><span class="nc">Double</span><span class="o">],</span> <span class="o">`</span><span class="nc">ButtonRelease</span><span class="o">)]</span> <span class="o">~</span><span class="n">action</span><span class="o">:</span><span class="n">view</span> <span class="n">listbox</span><span class="o">;</span>

  <span class="c">(* &#39;q&#39; quits and &#39;s&#39; saves *)</span>
  <span class="n">bind</span> <span class="o">~</span><span class="n">events</span><span class="o">:[`</span><span class="nc">KeyPressDetail</span> <span class="s2">&quot;s&quot;</span><span class="o">]</span> <span class="o">~</span><span class="n">action</span><span class="o">:</span><span class="n">save</span> <span class="n">main</span><span class="o">;</span>
  <span class="n">bind</span> <span class="o">~</span><span class="n">events</span><span class="o">:[`</span><span class="nc">KeyPressDetail</span> <span class="s2">&quot;q&quot;</span><span class="o">]</span> <span class="o">~</span><span class="n">action</span><span class="o">:(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">exit</span> <span class="mi">0</span><span class="o">)</span> <span class="n">main</span><span class="o">;</span>

  <span class="nn">Printexc</span><span class="p">.</span><span class="n">print</span> <span class="n">mainLoop</span> <span class="bp">()</span>


<span class="c">(* @@PLEAC@@_16.1 *)</span>
<span class="c">(* Process support is mostly in the &quot;unix&quot; library. *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="c">(* Run a command and return its results as a string. *)</span>
<span class="k">let</span> <span class="n">read_process</span> <span class="n">command</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">buffer_size</span> <span class="o">=</span> <span class="mi">2048</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">create</span> <span class="n">buffer_size</span> <span class="k">in</span>
  <span class="k">let</span> <span class="kt">string</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">create</span> <span class="n">buffer_size</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_in</span> <span class="n">command</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">chars_read</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">1</span> <span class="k">in</span>
  <span class="k">while</span> <span class="o">!</span><span class="n">chars_read</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="k">do</span>
    <span class="n">chars_read</span> <span class="o">:=</span> <span class="n">input</span> <span class="n">in_channel</span> <span class="kt">string</span> <span class="mi">0</span> <span class="n">buffer_size</span><span class="o">;</span>
    <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_substring</span> <span class="n">buffer</span> <span class="kt">string</span> <span class="mi">0</span> <span class="o">!</span><span class="n">chars_read</span>
  <span class="k">done</span><span class="o">;</span>
  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_in</span> <span class="n">in_channel</span><span class="o">);</span>
  <span class="nn">Buffer</span><span class="p">.</span><span class="n">contents</span> <span class="n">buffer</span>

<span class="c">(* Run a command and return its results as a list of strings,</span>
<span class="c">   one per line. *)</span>
<span class="k">let</span> <span class="n">read_process_lines</span> <span class="n">command</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_in</span> <span class="n">command</span> <span class="k">in</span>
  <span class="k">begin</span>
    <span class="k">try</span>
      <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
        <span class="n">lines</span> <span class="o">:=</span> <span class="n">input_line</span> <span class="n">in_channel</span> <span class="o">::</span> <span class="o">!</span><span class="n">lines</span>
      <span class="k">done</span><span class="o">;</span>
    <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
      <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_in</span> <span class="n">in_channel</span><span class="o">)</span>
  <span class="k">end</span><span class="o">;</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="o">!</span><span class="n">lines</span>

<span class="c">(* Example: *)</span>
<span class="k">let</span> <span class="n">output_string</span> <span class="o">=</span> <span class="n">read_process</span> <span class="s2">&quot;program args&quot;</span>
<span class="k">let</span> <span class="n">output_lines</span> <span class="o">=</span> <span class="n">read_process_lines</span> <span class="s2">&quot;program args&quot;</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Create a pipe for the subprocess output. *)</span>
<span class="k">let</span> <span class="n">readme</span><span class="o">,</span> <span class="n">writeme</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">pipe</span> <span class="bp">()</span>

<span class="c">(* Launch the program, redirecting its stdout to the pipe.</span>
<span class="c">   By calling Unix.create_process, we can avoid running the</span>
<span class="c">   command through the shell. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">pid</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">create_process</span>
    <span class="n">program</span> <span class="o">[|</span> <span class="n">program</span><span class="o">;</span> <span class="n">arg1</span><span class="o">;</span> <span class="n">arg2</span> <span class="o">|]</span>
    <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span> <span class="n">writeme</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stderr</span> <span class="k">in</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="n">writeme</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">in_channel_of_descr</span> <span class="n">readme</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="k">begin</span>
    <span class="k">try</span>
      <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
        <span class="n">lines</span> <span class="o">:=</span> <span class="n">input_line</span> <span class="n">in_channel</span> <span class="o">::</span> <span class="o">!</span><span class="n">lines</span>
      <span class="k">done</span>
    <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span>
  <span class="k">end</span><span class="o">;</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="n">readme</span><span class="o">;</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="n">print_endline</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="o">!</span><span class="n">lines</span><span class="o">)</span>

<span class="c">(* @@PLEAC@@_16.2 *)</span>
<span class="c">(* Run a simple command and retrieve its result code. *)</span>
<span class="k">let</span> <span class="n">status</span> <span class="o">=</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">command</span> <span class="o">(</span><span class="s2">&quot;vi &quot;</span> <span class="o">^</span> <span class="n">myfile</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Use the shell to perform redirection. *)</span>
<span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">command</span> <span class="s2">&quot;cmd1 args | cmd2 | cmd3 &gt;outfile&quot;</span>
<span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">command</span> <span class="s2">&quot;cmd args &lt;infile &gt;outfile 2&gt;errfile&quot;</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Run a command, handling its result code or signal. *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">match</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">system</span> <span class="n">command</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">WEXITED</span> <span class="n">status</span> <span class="o">-&gt;</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;program exited with status %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">status</span>
    <span class="o">|</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">WSIGNALED</span> <span class="n">signal</span> <span class="o">-&gt;</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;program killed by signal %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">signal</span>
    <span class="o">|</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">WSTOPPED</span> <span class="n">signal</span> <span class="o">-&gt;</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;program stopped by signal %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">signal</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Run a command while blocking interrupt signals. *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">match</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">fork</span> <span class="bp">()</span> <span class="k">with</span>
    <span class="o">|</span> <span class="mi">0</span> <span class="o">-&gt;</span>
        <span class="c">(* child ignores INT and does its thing *)</span>
        <span class="nn">Sys</span><span class="p">.</span><span class="n">set_signal</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigint</span> <span class="nn">Sys</span><span class="p">.</span><span class="nc">Signal_ignore</span><span class="o">;</span>
        <span class="nn">Unix</span><span class="p">.</span><span class="n">execv</span> <span class="s2">&quot;/bin/sleep&quot;</span> <span class="o">[|</span> <span class="s2">&quot;/bin/sleep&quot;</span><span class="o">;</span> <span class="s2">&quot;10&quot;</span> <span class="o">|]</span>
    <span class="o">|</span> <span class="n">pid</span> <span class="o">-&gt;</span>
        <span class="c">(* parent catches INT and berates user *)</span>
        <span class="nn">Sys</span><span class="p">.</span><span class="n">set_signal</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigint</span>
          <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="nc">Signal_handle</span>
            <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">print_endline</span> <span class="s2">&quot;Tsk tsk, no process interruptus&quot;</span><span class="o">));</span>
        <span class="k">let</span> <span class="n">running</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">true</span> <span class="k">in</span>
        <span class="k">while</span> <span class="o">!</span><span class="n">running</span> <span class="k">do</span>
          <span class="k">try</span> <span class="o">(</span><span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">waitpid</span> <span class="bp">[]</span> <span class="n">pid</span><span class="o">);</span> <span class="n">running</span> <span class="o">:=</span> <span class="bp">false</span><span class="o">)</span>
          <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span>
        <span class="k">done</span><span class="o">;</span>
        <span class="nn">Sys</span><span class="p">.</span><span class="n">set_signal</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigint</span> <span class="nn">Sys</span><span class="p">.</span><span class="nc">Signal_default</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Run a command with a different name in the process table. *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">shell</span> <span class="o">=</span> <span class="s2">&quot;/bin/tcsh&quot;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">match</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">fork</span> <span class="bp">()</span> <span class="k">with</span>
    <span class="o">|</span> <span class="mi">0</span> <span class="o">-&gt;</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">execv</span> <span class="n">shell</span> <span class="o">[|</span> <span class="s2">&quot;-csh&quot;</span> <span class="o">|]</span> <span class="c">(* pretend it&#39;s a login shell *)</span>
    <span class="o">|</span> <span class="n">pid</span> <span class="o">-&gt;</span> <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">waitpid</span> <span class="bp">[]</span> <span class="n">pid</span><span class="o">)</span>

<span class="c">(* @@PLEAC@@_16.3 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>
<span class="c">(* Transfer control to the shell to run another program. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">execv</span> <span class="s2">&quot;/bin/sh&quot;</span> <span class="o">[|</span> <span class="s2">&quot;/bin/sh&quot;</span><span class="o">;</span> <span class="s2">&quot;-c&quot;</span><span class="o">;</span> <span class="s2">&quot;archive *.data&quot;</span> <span class="o">|]</span>
<span class="c">(* Transfer control directly to another program in the path. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">execvp</span> <span class="s2">&quot;archive&quot;</span> <span class="o">[|</span> <span class="s2">&quot;archive&quot;</span><span class="o">;</span> <span class="s2">&quot;accounting.data&quot;</span> <span class="o">|]</span>

<span class="c">(* @@PLEAC@@_16.4 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Handle each line in the output of a process. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">readme</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_in</span> <span class="s2">&quot;program arguments&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span> <span class="n">line</span> <span class="o">=</span>
    <span class="c">(* ... *)</span>
    <span class="n">loop</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">readme</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">try</span> <span class="n">loop</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">readme</span><span class="o">)</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_in</span> <span class="n">readme</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Write to the input of a process. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">writeme</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_out</span> <span class="s2">&quot;program arguments&quot;</span> <span class="k">in</span>
  <span class="n">output_string</span> <span class="n">writeme</span> <span class="s2">&quot;data</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_out</span> <span class="n">writeme</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Wait for a process to complete. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* child goes to sleep *)</span>
  <span class="k">let</span> <span class="n">f</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_in</span> <span class="s2">&quot;sleep 100000&quot;</span> <span class="k">in</span>
  <span class="c">(* and parent goes to lala land *)</span>
  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_in</span> <span class="n">f</span><span class="o">);</span>
  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">wait</span> <span class="bp">()</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">writeme</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_out</span> <span class="s2">&quot;program args&quot;</span> <span class="k">in</span>
  <span class="c">(* program will get hello\n on STDIN *)</span>
  <span class="n">output_string</span> <span class="n">writeme</span> <span class="s2">&quot;hello</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
  <span class="c">(* program will get EOF on STDIN *)</span>
  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_out</span> <span class="n">writeme</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Redirect standard output to the pager. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">pager</span> <span class="o">=</span>
    <span class="k">try</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">getenv</span> <span class="s2">&quot;PAGER&quot;</span> <span class="c">(* XXX: might not exist *)</span>
    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="s2">&quot;/usr/bin/less&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">reader</span><span class="o">,</span> <span class="n">writer</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">pipe</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="k">match</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">fork</span> <span class="bp">()</span> <span class="k">with</span>
    <span class="o">|</span> <span class="mi">0</span> <span class="o">-&gt;</span>
        <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="n">writer</span><span class="o">;</span>
        <span class="nn">Unix</span><span class="p">.</span><span class="n">dup2</span> <span class="n">reader</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span><span class="o">;</span>
        <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="n">reader</span><span class="o">;</span>
        <span class="nn">Unix</span><span class="p">.</span><span class="n">execvp</span> <span class="n">pager</span> <span class="o">[|</span> <span class="n">pager</span> <span class="o">|]</span>
    <span class="o">|</span> <span class="n">pid</span> <span class="o">-&gt;</span>
        <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="n">reader</span><span class="o">;</span>
        <span class="nn">Unix</span><span class="p">.</span><span class="n">dup2</span> <span class="n">writer</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdout</span><span class="o">;</span>
        <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="n">writer</span>

<span class="c">(* Do something useful that writes to standard output, then</span>
<span class="c">   close the stream and wait for the pager to finish. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* ... *)</span>
  <span class="n">close_out</span> <span class="n">stdout</span><span class="o">;</span>
  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">wait</span> <span class="bp">()</span><span class="o">)</span>

<span class="c">(* @@PLEAC@@_16.5 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="c">(* Fork a process that calls f to post-process standard output. *)</span>
<span class="k">let</span> <span class="n">push_output_filter</span> <span class="n">f</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">reader</span><span class="o">,</span> <span class="n">writer</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">pipe</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="k">match</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">fork</span> <span class="bp">()</span> <span class="k">with</span>
    <span class="o">|</span> <span class="mi">0</span> <span class="o">-&gt;</span>
        <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="n">writer</span><span class="o">;</span>
        <span class="nn">Unix</span><span class="p">.</span><span class="n">dup2</span> <span class="n">reader</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span><span class="o">;</span>
        <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="n">reader</span><span class="o">;</span>
        <span class="n">f</span> <span class="bp">()</span><span class="o">;</span>
        <span class="n">exit</span> <span class="mi">0</span>
    <span class="o">|</span> <span class="n">pid</span> <span class="o">-&gt;</span>
        <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="n">reader</span><span class="o">;</span>
        <span class="nn">Unix</span><span class="p">.</span><span class="n">dup2</span> <span class="n">writer</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdout</span><span class="o">;</span>
        <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="n">writer</span>

<span class="c">(* Only display a certain number of lines of output. *)</span>
<span class="k">let</span> <span class="n">head</span> <span class="o">?(</span><span class="n">lines</span><span class="o">=</span><span class="mi">20</span><span class="o">)</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">push_output_filter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span>
       <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">ref</span> <span class="n">lines</span> <span class="k">in</span>
       <span class="k">try</span>
         <span class="k">while</span> <span class="o">!</span><span class="n">lines</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">do</span>
           <span class="n">print_endline</span> <span class="o">(</span><span class="n">read_line</span> <span class="bp">()</span><span class="o">);</span>
           <span class="n">decr</span> <span class="n">lines</span>
         <span class="k">done</span>
       <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">)</span>

<span class="c">(* Prepend line numbers to each line of output. *)</span>
<span class="k">let</span> <span class="n">number</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">push_output_filter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span>
       <span class="k">let</span> <span class="n">line_number</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
       <span class="k">try</span>
         <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
           <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">read_line</span> <span class="bp">()</span> <span class="k">in</span>
           <span class="n">incr</span> <span class="n">line_number</span><span class="o">;</span>
           <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%d: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">!</span><span class="n">line_number</span> <span class="n">line</span>
         <span class="k">done</span>
       <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">)</span>

<span class="c">(* Prepend &quot;&gt; &quot; to each line of output. *)</span>
<span class="k">let</span> <span class="n">quote</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">push_output_filter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span>
       <span class="k">try</span>
         <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
           <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">read_line</span> <span class="bp">()</span> <span class="k">in</span>
           <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;&gt; %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">line</span>
         <span class="k">done</span>
       <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">head</span> <span class="o">~</span><span class="n">lines</span><span class="o">:</span><span class="mi">100</span> <span class="bp">()</span><span class="o">;</span>  <span class="c">(* push head filter on STDOUT *)</span>
  <span class="n">number</span> <span class="bp">()</span><span class="o">;</span>           <span class="c">(* push number filter on STDOUT *)</span>
  <span class="n">quote</span> <span class="bp">()</span><span class="o">;</span>            <span class="c">(* push quote filter on STDOUT *)</span>

  <span class="c">(* act like /bin/cat *)</span>
  <span class="k">begin</span>
    <span class="k">try</span>
      <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
        <span class="n">print_endline</span> <span class="o">(</span><span class="n">read_line</span> <span class="bp">()</span><span class="o">)</span>
      <span class="k">done</span>
    <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span>
  <span class="k">end</span><span class="o">;</span>

  <span class="c">(* tell kids we&#39;re done--politely *)</span>
  <span class="n">close_out</span> <span class="n">stdout</span><span class="o">;</span>
  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">waitpid</span> <span class="bp">[]</span> <span class="o">(-</span><span class="mi">1</span><span class="o">));</span>
  <span class="n">exit</span> <span class="mi">0</span>

<span class="c">(* @@PLEAC@@_16.6 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="c">(* Tagged filename or URL type. *)</span>
<span class="k">type</span> <span class="n">filename</span> <span class="o">=</span>
  <span class="o">|</span> <span class="nc">Uncompressed</span> <span class="k">of</span> <span class="kt">string</span>
  <span class="o">|</span> <span class="nc">Compressed</span> <span class="k">of</span> <span class="kt">string</span>
  <span class="o">|</span> <span class="nc">URL</span> <span class="k">of</span> <span class="kt">string</span>

<span class="c">(* try/finally-like construct to ensure we dispose of resources properly. *)</span>
<span class="k">let</span> <span class="n">finally</span> <span class="n">handler</span> <span class="n">f</span> <span class="n">x</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">result</span> <span class="o">=</span> <span class="k">try</span> <span class="n">f</span> <span class="n">x</span> <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">handler</span> <span class="bp">()</span><span class="o">;</span> <span class="k">raise</span> <span class="n">e</span> <span class="k">in</span> <span class="n">handler</span> <span class="bp">()</span><span class="o">;</span> <span class="n">result</span>

<span class="c">(* Call f with an in_channel given a tagged filename. If the filename is</span>
<span class="c">   tagged Uncompressed, open it normally. If it is tagged Compressed then</span>
<span class="c">   pipe it through gzip. If it is tagged URL, pipe it through &quot;lynx -dump&quot;.</span>
<span class="c">   Ensure that the channel is closed and any created processes have</span>
<span class="c">   terminated before returning. As a special case, a filename of</span>
<span class="c">   Uncompressed &quot;-&quot; will result in stdin being passed, and no channel</span>
<span class="c">   will be closed. *)</span>
<span class="k">let</span> <span class="n">with_in_channel</span> <span class="n">filename</span> <span class="n">f</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">pipe_input</span> <span class="n">args</span> <span class="n">f</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">reader</span><span class="o">,</span> <span class="n">writer</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">pipe</span> <span class="bp">()</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">pid</span> <span class="o">=</span>
      <span class="nn">Unix</span><span class="p">.</span><span class="n">create_process</span> <span class="n">args</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span> <span class="n">args</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span> <span class="n">writer</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stderr</span> <span class="k">in</span>
    <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="n">writer</span><span class="o">;</span>
    <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">in_channel_of_descr</span> <span class="n">reader</span> <span class="k">in</span>
    <span class="n">finally</span>
      <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="n">close_in</span> <span class="n">in_channel</span><span class="o">;</span> <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">waitpid</span> <span class="bp">[]</span> <span class="n">pid</span><span class="o">))</span>
      <span class="n">f</span> <span class="n">in_channel</span> <span class="k">in</span>
  <span class="k">match</span> <span class="n">filename</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">Uncompressed</span> <span class="s2">&quot;-&quot;</span> <span class="o">-&gt;</span>
        <span class="n">f</span> <span class="n">stdin</span>
    <span class="o">|</span> <span class="nc">Uncompressed</span> <span class="n">filename</span> <span class="o">-&gt;</span>
        <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span> <span class="n">open_in</span> <span class="n">filename</span> <span class="k">in</span>
        <span class="n">finally</span>
          <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="n">close_in</span> <span class="n">in_channel</span><span class="o">)</span>
          <span class="n">f</span> <span class="n">in_channel</span>
    <span class="o">|</span> <span class="nc">Compressed</span> <span class="n">filename</span> <span class="o">-&gt;</span>
        <span class="n">pipe_input</span> <span class="o">[|</span> <span class="s2">&quot;gzip&quot;</span><span class="o">;</span> <span class="s2">&quot;-dc&quot;</span><span class="o">;</span> <span class="n">filename</span> <span class="o">|]</span> <span class="n">f</span>
    <span class="o">|</span> <span class="nc">URL</span> <span class="n">url</span> <span class="o">-&gt;</span>
        <span class="n">pipe_input</span> <span class="o">[|</span> <span class="s2">&quot;lynx&quot;</span><span class="o">;</span> <span class="s2">&quot;-dump&quot;</span><span class="o">;</span> <span class="n">url</span> <span class="o">|]</span> <span class="n">f</span>

<span class="c">(* Return true if the string s starts with the given prefix. *)</span>
<span class="k">let</span> <span class="n">starts_with</span> <span class="n">s</span> <span class="n">prefix</span> <span class="o">=</span>
  <span class="k">try</span> <span class="nn">Str</span><span class="p">.</span><span class="n">first_chars</span> <span class="n">s</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">prefix</span><span class="o">)</span> <span class="o">=</span> <span class="n">prefix</span>
  <span class="k">with</span> <span class="nc">Invalid_argument</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>

<span class="c">(* Return true if the string s ends with the given suffix. *)</span>
<span class="k">let</span> <span class="n">ends_with</span> <span class="n">s</span> <span class="n">suffix</span> <span class="o">=</span>
  <span class="k">try</span> <span class="nn">Str</span><span class="p">.</span><span class="n">last_chars</span> <span class="n">s</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">suffix</span><span class="o">)</span> <span class="o">=</span> <span class="n">suffix</span>
  <span class="k">with</span> <span class="nc">Invalid_argument</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>

<span class="c">(* Return true if the string s contains the given substring. *)</span>
<span class="k">let</span> <span class="n">contains</span> <span class="n">s</span> <span class="n">substring</span> <span class="o">=</span>
  <span class="k">try</span> <span class="n">ignore</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp_string</span> <span class="n">substring</span><span class="o">)</span> <span class="n">s</span> <span class="mi">0</span><span class="o">);</span> <span class="bp">true</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">false</span>

<span class="c">(* Tag the filename depending on its contents or extension. *)</span>
<span class="k">let</span> <span class="n">tag_filename</span> <span class="n">filename</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">contains</span> <span class="n">filename</span> <span class="s2">&quot;://&quot;</span>
  <span class="k">then</span> <span class="nc">URL</span> <span class="n">filename</span>
  <span class="k">else</span> <span class="k">if</span> <span class="nn">List</span><span class="p">.</span><span class="n">exists</span> <span class="o">(</span><span class="n">ends_with</span> <span class="n">filename</span><span class="o">)</span> <span class="o">[</span><span class="s2">&quot;.gz&quot;</span><span class="o">;</span> <span class="s2">&quot;.Z&quot;</span><span class="o">]</span>
  <span class="k">then</span> <span class="nc">Compressed</span> <span class="n">filename</span>
  <span class="k">else</span> <span class="nc">Uncompressed</span> <span class="n">filename</span>

<span class="c">(* Process a tagged filename. *)</span>
<span class="k">let</span> <span class="n">process</span> <span class="n">filename</span> <span class="o">=</span>
  <span class="n">with_in_channel</span>
    <span class="n">filename</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">in_channel</span> <span class="o">-&gt;</span>
       <span class="k">try</span>
         <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
           <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">in_channel</span> <span class="k">in</span>
           <span class="c">(* ... *)</span>
           <span class="bp">()</span>
         <span class="k">done</span>
       <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">)</span>

<span class="c">(* Parse the command-line arguments and process each file or URL. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">args</span> <span class="o">=</span>
    <span class="k">if</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="o">&gt;</span> <span class="mi">1</span>
    <span class="k">then</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">))</span>
    <span class="k">else</span> <span class="o">[</span><span class="s2">&quot;-&quot;</span><span class="o">]</span> <span class="k">in</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="n">process</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">tag_filename</span> <span class="n">args</span><span class="o">)</span>

<span class="c">(* @@PLEAC@@_16.7 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="c">(* Read STDERR and STDOUT at the same time. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">ph</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_in</span> <span class="s2">&quot;cmd 2&gt;&amp;1&quot;</span> <span class="k">in</span>
  <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">ph</span> <span class="k">in</span>
    <span class="c">(* ... *)</span>
    <span class="bp">()</span>
  <span class="k">done</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Read STDOUT and discard STDERR. *)</span>
<span class="k">let</span> <span class="n">output</span> <span class="o">=</span> <span class="n">read_process</span> <span class="s2">&quot;cmd 2&gt;/dev/null&quot;</span>
<span class="c">(* or *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">ph</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_in</span> <span class="s2">&quot;cmd 2&gt;/dev/null&quot;</span> <span class="k">in</span>
  <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">ph</span> <span class="k">in</span>
    <span class="c">(* ... *)</span>
    <span class="bp">()</span>
  <span class="k">done</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Read STDERR and discard STDOUT. *)</span>
<span class="k">let</span> <span class="n">output</span> <span class="o">=</span> <span class="n">read_process</span> <span class="s2">&quot;cmd 2&gt;&amp;1 1&gt;/dev/null&quot;</span>
<span class="c">(* or *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">ph</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_in</span> <span class="s2">&quot;cmd 2&gt;&amp;1 1&gt;/dev/null&quot;</span> <span class="k">in</span>
  <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">ph</span> <span class="k">in</span>
    <span class="c">(* ... *)</span>
    <span class="bp">()</span>
  <span class="k">done</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Swap STDOUT with STDERR and read original STDERR. *)</span>
<span class="k">let</span> <span class="n">output</span> <span class="o">=</span> <span class="n">read_process</span> <span class="s2">&quot;cmd 3&gt;&amp;1 1&gt;&amp;2 2&gt;&amp;3 3&gt;&amp;-&quot;</span>
<span class="c">(* or *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">ph</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_in</span> <span class="s2">&quot;cmd 3&gt;&amp;1 1&gt;&amp;2 2&gt;&amp;3 3&gt;&amp;-&quot;</span> <span class="k">in</span>
  <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">ph</span> <span class="k">in</span>
    <span class="c">(* ... *)</span>
    <span class="bp">()</span>
  <span class="k">done</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Redirect STDOUT and STDERR to temporary files. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">ignore</span>
    <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="n">command</span>
       <span class="s2">&quot;program args 1&gt;/tmp/program.stdout 2&gt;/tmp/program.stderr&quot;</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* If the following redirections were done in OCaml... *)</span>
<span class="k">let</span> <span class="n">output</span> <span class="o">=</span> <span class="n">read_process</span> <span class="s2">&quot;cmd 3&gt;&amp;1 1&gt;&amp;2 2&gt;&amp;3 3&gt;&amp;-&quot;</span>

<span class="c">(* ...they would look something like this: *)</span>
<span class="k">let</span> <span class="n">fd3</span> <span class="o">=</span> <span class="n">fd1</span>
<span class="k">let</span> <span class="n">fd1</span> <span class="o">=</span> <span class="n">fd2</span>
<span class="k">let</span> <span class="n">fd2</span> <span class="o">=</span> <span class="n">fd3</span>
<span class="k">let</span> <span class="n">fd3</span> <span class="o">=</span> <span class="n">undef</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Send STDOUT and STDERR to a temporary file. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">ignore</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="n">command</span> <span class="s2">&quot;prog args 1&gt;tmpfile 2&gt;&amp;1&quot;</span><span class="o">)</span>

<span class="c">(* Send STDOUT to a temporary file and redirect STDERR to STDOUT. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">ignore</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="n">command</span> <span class="s2">&quot;prog args 2&gt;&amp;1 1&gt;tmpfile&quot;</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* If the following redirections were done in OCaml... *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">ignore</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="n">command</span> <span class="s2">&quot;prog args 1&gt;tmpfile 2&gt;&amp;1&quot;</span><span class="o">)</span>

<span class="c">(* ...they would look something like this: *)</span>
<span class="k">let</span> <span class="n">fd1</span> <span class="o">=</span> <span class="s2">&quot;tmpfile&quot;</span>       <span class="c">(* change stdout destination first *)</span>
<span class="k">let</span> <span class="n">fd2</span> <span class="o">=</span> <span class="n">fd1</span>             <span class="c">(* now point stderr there, too *)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* If the following redirections were done in OCaml... *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">ignore</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="n">command</span> <span class="s2">&quot;prog args 2&gt;&amp;1 1&gt;tmpfile&quot;</span><span class="o">)</span>

<span class="c">(* ...they would look something like this: *)</span>
<span class="k">let</span> <span class="n">fd2</span> <span class="o">=</span> <span class="n">fd1</span>             <span class="c">(* stderr same destination as stdout *)</span>
<span class="k">let</span> <span class="n">fd1</span> <span class="o">=</span> <span class="s2">&quot;tmpfile&quot;</span>       <span class="c">(* but change stdout destination  *)</span>

<span class="c">(* @@PLEAC@@_16.8 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="o">(</span><span class="n">readme</span><span class="o">,</span> <span class="n">writeme</span><span class="o">)</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">open_process</span> <span class="n">program</span> <span class="k">in</span>
  <span class="n">output_string</span> <span class="n">writeme</span> <span class="s2">&quot;here&#39;s your input</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
  <span class="n">close_out</span> <span class="n">writeme</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">output</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">readme</span> <span class="k">in</span>
  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process</span> <span class="o">(</span><span class="n">readme</span><span class="o">,</span> <span class="n">writeme</span><span class="o">))</span>

<span class="c">(* @@PLEAC@@_16.9 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">proc</span> <span class="o">=</span>
    <span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_in</span>
      <span class="o">(</span><span class="s2">&quot;(&quot;</span> <span class="o">^</span> <span class="n">cmd</span> <span class="o">^</span> <span class="s2">&quot; | sed -e &#39;s/^/stdout: /&#39; ) 2&gt;&amp;1&quot;</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">proc</span> <span class="k">in</span>
      <span class="k">if</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">line</span> <span class="o">&gt;=</span> <span class="mi">8</span>
        <span class="o">&amp;&amp;</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">line</span> <span class="mi">0</span> <span class="mi">8</span> <span class="o">=</span> <span class="s2">&quot;stdout: &quot;</span>
      <span class="k">then</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;STDOUT: %s</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">line</span> <span class="mi">8</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">line</span> <span class="o">-</span> <span class="mi">8</span><span class="o">))</span>
      <span class="k">else</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;STDERR: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">line</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
    <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_in</span> <span class="n">proc</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* cmd3sel - control all three of kids in, out, and error. *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">cmd</span> <span class="o">=</span> <span class="s2">&quot;grep vt33 /none/such - /etc/termcap&quot;</span>
<span class="k">let</span> <span class="n">cmd_out</span><span class="o">,</span> <span class="n">cmd_in</span><span class="o">,</span> <span class="n">cmd_err</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_full</span> <span class="n">cmd</span> <span class="o">[|</span> <span class="o">|]</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">output_string</span> <span class="n">cmd_in</span> <span class="s2">&quot;This line has a vt33 lurking in it</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
  <span class="n">close_out</span> <span class="n">cmd_in</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">cmd_out_descr</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">descr_of_in_channel</span> <span class="n">cmd_out</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">cmd_err_descr</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">descr_of_in_channel</span> <span class="n">cmd_err</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">selector</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">[</span><span class="n">cmd_err_descr</span><span class="o">;</span> <span class="n">cmd_out_descr</span><span class="o">]</span> <span class="k">in</span>
  <span class="k">while</span> <span class="o">!</span><span class="n">selector</span> <span class="o">&lt;&gt;</span> <span class="bp">[]</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">can_read</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">select</span> <span class="o">!</span><span class="n">selector</span> <span class="bp">[]</span> <span class="bp">[]</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span> <span class="k">in</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
      <span class="o">(</span><span class="k">fun</span> <span class="n">fh</span> <span class="o">-&gt;</span>
         <span class="k">try</span>
           <span class="k">if</span> <span class="n">fh</span> <span class="o">=</span> <span class="n">cmd_err_descr</span>
           <span class="k">then</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;STDERR: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">cmd_err</span><span class="o">)</span>
           <span class="k">else</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;STDOUT: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">cmd_out</span><span class="o">)</span>
         <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
           <span class="n">selector</span> <span class="o">:=</span> <span class="nn">List</span><span class="p">.</span><span class="n">filter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">fh&#39;</span> <span class="o">-&gt;</span> <span class="n">fh</span> <span class="o">&lt;&gt;</span> <span class="n">fh&#39;</span><span class="o">)</span> <span class="o">!</span><span class="n">selector</span><span class="o">)</span>
      <span class="n">can_read</span>
  <span class="k">done</span><span class="o">;</span>
  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_full</span> <span class="o">(</span><span class="n">cmd_out</span><span class="o">,</span> <span class="n">cmd_in</span><span class="o">,</span> <span class="n">cmd_err</span><span class="o">))</span>

<span class="c">(* @@PLEAC@@_16.10 *)</span>
<span class="c">(* pipe1 - use pipe and fork so parent can send to child *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span>
<span class="k">open</span> <span class="nc">Unix</span>

<span class="k">let</span> <span class="n">reader</span><span class="o">,</span> <span class="n">writer</span> <span class="o">=</span> <span class="n">pipe</span> <span class="bp">()</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">fork</span> <span class="bp">()</span> <span class="k">with</span>
    <span class="o">|</span> <span class="mi">0</span> <span class="o">-&gt;</span>
        <span class="n">close</span> <span class="n">writer</span><span class="o">;</span>
        <span class="k">let</span> <span class="n">input</span> <span class="o">=</span> <span class="n">in_channel_of_descr</span> <span class="n">reader</span> <span class="k">in</span>
        <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">input</span> <span class="k">in</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Child Pid %d just read this: `%s&#39;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">getpid</span> <span class="bp">()</span><span class="o">)</span> <span class="n">line</span><span class="o">;</span>
        <span class="n">close</span> <span class="n">reader</span><span class="o">;</span>  <span class="c">(* this will happen anyway *)</span>
        <span class="n">exit</span> <span class="mi">0</span>
    <span class="o">|</span> <span class="n">pid</span> <span class="o">-&gt;</span>
        <span class="n">close</span> <span class="n">reader</span><span class="o">;</span>
        <span class="k">let</span> <span class="n">output</span> <span class="o">=</span> <span class="n">out_channel_of_descr</span> <span class="n">writer</span> <span class="k">in</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">fprintf</span> <span class="n">output</span> <span class="s2">&quot;Parent Pid %d is sending this</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">getpid</span> <span class="bp">()</span><span class="o">);</span>
        <span class="n">flush</span> <span class="n">output</span><span class="o">;</span>
        <span class="n">close</span> <span class="n">writer</span><span class="o">;</span>
        <span class="n">ignore</span> <span class="o">(</span><span class="n">waitpid</span> <span class="bp">[]</span> <span class="n">pid</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* pipe2 - use pipe and fork so child can send to parent *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span>
<span class="k">open</span> <span class="nc">Unix</span>

<span class="k">let</span> <span class="n">reader</span><span class="o">,</span> <span class="n">writer</span> <span class="o">=</span> <span class="n">pipe</span> <span class="bp">()</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">fork</span> <span class="bp">()</span> <span class="k">with</span>
    <span class="o">|</span> <span class="mi">0</span> <span class="o">-&gt;</span>
        <span class="n">close</span> <span class="n">reader</span><span class="o">;</span>
        <span class="k">let</span> <span class="n">output</span> <span class="o">=</span> <span class="n">out_channel_of_descr</span> <span class="n">writer</span> <span class="k">in</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">fprintf</span> <span class="n">output</span> <span class="s2">&quot;Child Pid %d is sending this</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">getpid</span> <span class="bp">()</span><span class="o">);</span>
        <span class="n">flush</span> <span class="n">output</span><span class="o">;</span>
        <span class="n">close</span> <span class="n">writer</span><span class="o">;</span>  <span class="c">(* this will happen anyway *)</span>
        <span class="n">exit</span> <span class="mi">0</span>
    <span class="o">|</span> <span class="n">pid</span> <span class="o">-&gt;</span>
        <span class="n">close</span> <span class="n">writer</span><span class="o">;</span>
        <span class="k">let</span> <span class="n">input</span> <span class="o">=</span> <span class="n">in_channel_of_descr</span> <span class="n">reader</span> <span class="k">in</span>
        <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">input</span> <span class="k">in</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Parent Pid %d just read this: `%s&#39;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">getpid</span> <span class="bp">()</span><span class="o">)</span> <span class="n">line</span><span class="o">;</span>
        <span class="n">close</span> <span class="n">reader</span><span class="o">;</span>
        <span class="n">ignore</span> <span class="o">(</span><span class="n">waitpid</span> <span class="bp">[]</span> <span class="n">pid</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* pipe3 and pipe4 demonstrate the use of perl&#39;s &quot;forking open&quot; feature to</span>
<span class="c"> * reimplement pipe1 and pipe2. Since OCaml does not support such a feature,</span>
<span class="c"> * these are skipped here. *)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* pipe5 - bidirectional communication using two pipe pairs</span>
<span class="c">           designed for the socketpair-challenged *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span>
<span class="k">open</span> <span class="nc">Unix</span>

<span class="k">let</span> <span class="n">parent_rdr</span><span class="o">,</span> <span class="n">child_wtr</span> <span class="o">=</span> <span class="n">pipe</span> <span class="bp">()</span>
<span class="k">let</span> <span class="n">child_rdr</span><span class="o">,</span> <span class="n">parent_wtr</span> <span class="o">=</span> <span class="n">pipe</span> <span class="bp">()</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">fork</span> <span class="bp">()</span> <span class="k">with</span>
    <span class="o">|</span> <span class="mi">0</span> <span class="o">-&gt;</span>
        <span class="n">close</span> <span class="n">child_rdr</span><span class="o">;</span>
        <span class="n">close</span> <span class="n">child_wtr</span><span class="o">;</span>
        <span class="k">let</span> <span class="n">input</span> <span class="o">=</span> <span class="n">in_channel_of_descr</span> <span class="n">parent_rdr</span> <span class="k">in</span>
        <span class="k">let</span> <span class="n">output</span> <span class="o">=</span> <span class="n">out_channel_of_descr</span> <span class="n">parent_wtr</span> <span class="k">in</span>
        <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">input</span> <span class="k">in</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Child Pid %d just read this: `%s&#39;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">getpid</span> <span class="bp">()</span><span class="o">)</span> <span class="n">line</span><span class="o">;</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">fprintf</span> <span class="n">output</span> <span class="s2">&quot;Child Pid %d is sending this</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">getpid</span> <span class="bp">()</span><span class="o">);</span>
        <span class="n">flush</span> <span class="n">output</span><span class="o">;</span>
        <span class="n">close</span> <span class="n">parent_rdr</span><span class="o">;</span>
        <span class="n">close</span> <span class="n">parent_wtr</span><span class="o">;</span>
        <span class="n">exit</span> <span class="mi">0</span>
    <span class="o">|</span> <span class="n">pid</span> <span class="o">-&gt;</span>
        <span class="n">close</span> <span class="n">parent_rdr</span><span class="o">;</span>
        <span class="n">close</span> <span class="n">parent_wtr</span><span class="o">;</span>
        <span class="k">let</span> <span class="n">input</span> <span class="o">=</span> <span class="n">in_channel_of_descr</span> <span class="n">child_rdr</span> <span class="k">in</span>
        <span class="k">let</span> <span class="n">output</span> <span class="o">=</span> <span class="n">out_channel_of_descr</span> <span class="n">child_wtr</span> <span class="k">in</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">fprintf</span> <span class="n">output</span> <span class="s2">&quot;Parent Pid %d is sending this</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">getpid</span><span class="bp">()</span><span class="o">);</span>
        <span class="n">flush</span> <span class="n">output</span><span class="o">;</span>
        <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">input</span> <span class="k">in</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Parent Pid %d just read this: `%s&#39;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">getpid</span> <span class="bp">()</span><span class="o">)</span> <span class="n">line</span><span class="o">;</span>
        <span class="n">close</span> <span class="n">child_rdr</span><span class="o">;</span>
        <span class="n">close</span> <span class="n">child_wtr</span><span class="o">;</span>
        <span class="n">ignore</span> <span class="o">(</span><span class="n">waitpid</span> <span class="bp">[]</span> <span class="n">pid</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* pipe6 - bidirectional communication using socketpair</span>
<span class="c">           &quot;the best ones always go both ways&quot; *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span>
<span class="k">open</span> <span class="nc">Unix</span>

<span class="k">let</span> <span class="n">child</span><span class="o">,</span> <span class="n">parent</span> <span class="o">=</span> <span class="n">socketpair</span> <span class="nc">PF_UNIX</span> <span class="nc">SOCK_STREAM</span> <span class="mi">0</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">fork</span> <span class="bp">()</span> <span class="k">with</span>
    <span class="o">|</span> <span class="mi">0</span> <span class="o">-&gt;</span>
        <span class="n">close</span> <span class="n">child</span><span class="o">;</span>
        <span class="k">let</span> <span class="n">input</span> <span class="o">=</span> <span class="n">in_channel_of_descr</span> <span class="n">parent</span> <span class="k">in</span>
        <span class="k">let</span> <span class="n">output</span> <span class="o">=</span> <span class="n">out_channel_of_descr</span> <span class="n">parent</span> <span class="k">in</span>
        <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">input</span> <span class="k">in</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Child Pid %d just read this: `%s&#39;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">getpid</span> <span class="bp">()</span><span class="o">)</span> <span class="n">line</span><span class="o">;</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">fprintf</span> <span class="n">output</span> <span class="s2">&quot;Child Pid %d is sending this</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">getpid</span> <span class="bp">()</span><span class="o">);</span>
        <span class="n">flush</span> <span class="n">output</span><span class="o">;</span>
        <span class="n">close</span> <span class="n">parent</span><span class="o">;</span>
        <span class="n">exit</span> <span class="mi">0</span>
    <span class="o">|</span> <span class="n">pid</span> <span class="o">-&gt;</span>
        <span class="n">close</span> <span class="n">parent</span><span class="o">;</span>
        <span class="k">let</span> <span class="n">input</span> <span class="o">=</span> <span class="n">in_channel_of_descr</span> <span class="n">child</span> <span class="k">in</span>
        <span class="k">let</span> <span class="n">output</span> <span class="o">=</span> <span class="n">out_channel_of_descr</span> <span class="n">child</span> <span class="k">in</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">fprintf</span> <span class="n">output</span> <span class="s2">&quot;Parent Pid %d is sending this</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">getpid</span> <span class="bp">()</span><span class="o">);</span>
        <span class="n">flush</span> <span class="n">output</span><span class="o">;</span>
        <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">input</span> <span class="k">in</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Parent Pid %d just read this: `%s&#39;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">getpid</span> <span class="bp">()</span><span class="o">)</span> <span class="n">line</span><span class="o">;</span>
        <span class="n">close</span> <span class="n">child</span><span class="o">;</span>
        <span class="n">ignore</span> <span class="o">(</span><span class="n">waitpid</span> <span class="bp">[]</span> <span class="n">pid</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Simulating a pipe using a socketpair. *)</span>
<span class="k">let</span> <span class="n">reader</span><span class="o">,</span> <span class="n">writer</span> <span class="o">=</span> <span class="n">socketpair</span> <span class="nc">PF_UNIX</span> <span class="nc">SOCK_STREAM</span> <span class="mi">0</span> <span class="k">in</span>
<span class="n">shutdown</span> <span class="n">reader</span> <span class="nc">SHUTDOWN_SEND</span><span class="o">;</span>      <span class="c">(* no more writing for reader *)</span>
<span class="n">shutdown</span> <span class="n">writer</span> <span class="nc">SHUTDOWN_RECEIVE</span><span class="o">;</span>   <span class="c">(* no more reading for writer *)</span>

<span class="c">(* @@PLEAC@@_16.11 *)</span>
<span class="o">%</span> <span class="n">mkfifo</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="k">to</span><span class="o">/</span><span class="n">named</span><span class="o">.</span><span class="n">pipe</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">fifo</span> <span class="o">=</span> <span class="n">open_in</span> <span class="s2">&quot;/path/to/named.pipe&quot;</span> <span class="k">in</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">fifo</span> <span class="k">in</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Got: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">line</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
    <span class="n">close_in</span> <span class="n">fifo</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">fifo</span> <span class="o">=</span> <span class="n">open_out</span> <span class="s2">&quot;/path/to/named.pipe&quot;</span> <span class="k">in</span>
  <span class="n">output_string</span> <span class="n">fifo</span> <span class="s2">&quot;Smoke this.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
  <span class="n">close_out</span> <span class="n">fifo</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">%</span> <span class="n">mkfifo</span> <span class="o">~/.</span><span class="n">plan</span>                    <span class="o">#</span> <span class="n">isn&#39;t</span> <span class="n">this</span> <span class="n">everywhere</span> <span class="n">yet</span><span class="o">?</span>
<span class="o">%</span> <span class="n">mknod</span>  <span class="o">~/.</span><span class="n">plan</span> <span class="n">p</span>                  <span class="o">#</span> <span class="k">in</span> <span class="n">case</span> <span class="n">you</span> <span class="n">don&#39;t</span> <span class="n">have</span> <span class="n">mkfifo</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* dateplan - place current date and time in .plan file *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">home</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">getenv</span> <span class="s2">&quot;HOME&quot;</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">fifo</span> <span class="o">=</span> <span class="n">open_out</span> <span class="o">(</span><span class="n">home</span> <span class="o">^</span> <span class="s2">&quot;/.plan&quot;</span><span class="o">)</span> <span class="k">in</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">fprintf</span> <span class="n">fifo</span> <span class="s2">&quot;The current time is %s</span><span class="se">\n</span><span class="s2">&quot;</span>
      <span class="o">(</span><span class="n">format_time</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">time</span> <span class="bp">()</span><span class="o">));</span>
    <span class="n">close_out</span> <span class="n">fifo</span><span class="o">;</span>
    <span class="nn">Unix</span><span class="p">.</span><span class="n">sleep</span> <span class="mi">1</span>
  <span class="k">done</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* fifolog - read and record log msgs from fifo *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">fifo</span> <span class="o">=</span> <span class="n">ref</span> <span class="nc">None</span>

<span class="k">let</span> <span class="n">handle_alarm</span> <span class="n">signal</span> <span class="o">=</span>
  <span class="k">match</span> <span class="o">!</span><span class="n">fifo</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">Some</span> <span class="n">channel</span> <span class="o">-&gt;</span>
        <span class="c">(* move on to the next queued process *)</span>
        <span class="n">close_in</span> <span class="n">channel</span><span class="o">;</span>
        <span class="n">fifo</span> <span class="o">:=</span> <span class="nc">None</span>
    <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="bp">()</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Sys</span><span class="p">.</span><span class="n">set_signal</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigalrm</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="nc">Signal_handle</span> <span class="n">handle_alarm</span><span class="o">)</span>

<span class="k">let</span> <span class="n">read_fifo</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">match</span> <span class="o">!</span><span class="n">fifo</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">channel</span> <span class="o">-&gt;</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">channel</span><span class="o">)</span>
      <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="nc">None</span>
  <span class="k">with</span>
    <span class="o">|</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
        <span class="nc">None</span>
    <span class="o">|</span> <span class="nc">Sys_error</span> <span class="n">e</span> <span class="o">-&gt;</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Error reading fifo: %s</span><span class="se">\n</span><span class="s2">%!&quot;</span> <span class="n">e</span><span class="o">;</span>
        <span class="n">fifo</span> <span class="o">:=</span> <span class="nc">None</span><span class="o">;</span>
        <span class="nc">None</span>

<span class="k">let</span> <span class="n">days</span> <span class="o">=</span> <span class="o">[|</span> <span class="s2">&quot;Sun&quot;</span><span class="o">;</span> <span class="s2">&quot;Mon&quot;</span><span class="o">;</span> <span class="s2">&quot;Tue&quot;</span><span class="o">;</span> <span class="s2">&quot;Wed&quot;</span><span class="o">;</span> <span class="s2">&quot;Thu&quot;</span><span class="o">;</span> <span class="s2">&quot;Fri&quot;</span><span class="o">;</span> <span class="s2">&quot;Sat&quot;</span> <span class="o">|]</span>
<span class="k">let</span> <span class="n">months</span> <span class="o">=</span> <span class="o">[|</span> <span class="s2">&quot;Jan&quot;</span><span class="o">;</span> <span class="s2">&quot;Feb&quot;</span><span class="o">;</span> <span class="s2">&quot;Mar&quot;</span><span class="o">;</span> <span class="s2">&quot;Apr&quot;</span><span class="o">;</span> <span class="s2">&quot;May&quot;</span><span class="o">;</span> <span class="s2">&quot;Jun&quot;</span><span class="o">;</span>
                <span class="s2">&quot;Jul&quot;</span><span class="o">;</span> <span class="s2">&quot;Aug&quot;</span><span class="o">;</span> <span class="s2">&quot;Sep&quot;</span><span class="o">;</span> <span class="s2">&quot;Oct&quot;</span><span class="o">;</span> <span class="s2">&quot;Nov&quot;</span><span class="o">;</span> <span class="s2">&quot;Dec&quot;</span> <span class="o">|]</span>

<span class="k">let</span> <span class="n">format_time</span> <span class="n">time</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">tm</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">localtime</span> <span class="n">time</span> <span class="k">in</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;%s %s %2d %02d:%02d:%02d %04d&quot;</span>
    <span class="n">days</span><span class="o">.(</span><span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_wday</span><span class="o">)</span>
    <span class="n">months</span><span class="o">.(</span><span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_mon</span><span class="o">)</span>
    <span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_mday</span>
    <span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_hour</span>
    <span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_min</span>
    <span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_sec</span>
    <span class="o">(</span><span class="n">tm</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">tm_year</span> <span class="o">+</span> <span class="mi">1900</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
    <span class="c">(* turn off alarm for blocking open *)</span>
    <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">alarm</span> <span class="mi">0</span><span class="o">);</span>
    <span class="k">begin</span>
      <span class="k">try</span> <span class="n">fifo</span> <span class="o">:=</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">open_in</span> <span class="s2">&quot;/tmp/log&quot;</span><span class="o">)</span>
      <span class="k">with</span> <span class="nc">Sys_error</span> <span class="n">e</span> <span class="o">-&gt;</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Can&#39;t open /tmp/log: %s</span><span class="se">\n</span><span class="s2">%!&quot;</span> <span class="n">e</span><span class="o">;</span>
        <span class="n">exit</span> <span class="mi">1</span>
    <span class="k">end</span><span class="o">;</span>

    <span class="c">(* you have 1 second to log *)</span>
    <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">alarm</span> <span class="mi">1</span><span class="o">);</span>

    <span class="k">let</span> <span class="n">service</span> <span class="o">=</span> <span class="n">read_fifo</span> <span class="bp">()</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">message</span> <span class="o">=</span> <span class="n">read_fifo</span> <span class="bp">()</span> <span class="k">in</span>

    <span class="c">(* turn off alarms for message processing *)</span>
    <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">alarm</span> <span class="mi">0</span><span class="o">);</span>

    <span class="k">begin</span>
      <span class="k">match</span> <span class="n">service</span><span class="o">,</span> <span class="n">message</span> <span class="k">with</span>
        <span class="o">|</span> <span class="nc">None</span><span class="o">,</span> <span class="o">_</span> <span class="o">|</span> <span class="o">_,</span> <span class="nc">None</span> <span class="o">-&gt;</span>
            <span class="c">(* interrupted or nothing logged *)</span>
            <span class="bp">()</span>
        <span class="o">|</span> <span class="nc">Some</span> <span class="n">service</span><span class="o">,</span> <span class="nc">Some</span> <span class="n">message</span> <span class="o">-&gt;</span>
            <span class="k">if</span> <span class="n">service</span> <span class="o">=</span> <span class="s2">&quot;http&quot;</span>
            <span class="k">then</span> <span class="bp">()</span> <span class="c">(* ignoring *)</span>
            <span class="k">else</span> <span class="k">if</span> <span class="n">service</span> <span class="o">=</span> <span class="s2">&quot;login&quot;</span>
            <span class="k">then</span>
              <span class="k">begin</span>
                <span class="c">(* log to /tmp/login *)</span>
                <span class="k">try</span>
                  <span class="k">let</span> <span class="n">log</span> <span class="o">=</span>
                    <span class="n">open_out_gen</span>
                      <span class="o">[</span><span class="nc">Open_wronly</span><span class="o">;</span> <span class="nc">Open_creat</span><span class="o">;</span> <span class="nc">Open_append</span><span class="o">]</span>
                      <span class="mo">0o666</span>
                      <span class="s2">&quot;/tmp/login&quot;</span> <span class="k">in</span>
                  <span class="nn">Printf</span><span class="p">.</span><span class="n">fprintf</span> <span class="n">log</span> <span class="s2">&quot;%s %s %s</span><span class="se">\n</span><span class="s2">%!&quot;</span>
                    <span class="o">(</span><span class="n">format_time</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">time</span> <span class="bp">()</span><span class="o">))</span> <span class="n">service</span> <span class="n">message</span><span class="o">;</span>
                  <span class="n">close_out</span> <span class="n">log</span>
                <span class="k">with</span> <span class="nc">Sys_error</span> <span class="n">e</span> <span class="o">-&gt;</span>
                  <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Couldn&#39;t log %s %s to /tmp/login: %s</span><span class="se">\n</span><span class="s2">%!&quot;</span>
                    <span class="n">service</span> <span class="n">message</span> <span class="n">e</span>
              <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">done</span>

<span class="c">(* @@PLEAC@@_16.12 *)</span>
<span class="c">(* OCaml does not currently support SysV IPC. *)</span>

<span class="c">(* @@PLEAC@@_16.13 *)</span>
<span class="o">%</span> <span class="n">echo</span> <span class="k">&#39;module</span> <span class="nc">M</span> <span class="o">=</span> <span class="nc">Sys</span><span class="o">;;</span><span class="k">&#39;</span> <span class="o">|</span> <span class="n">ocaml</span> <span class="o">|</span> <span class="n">grep</span> <span class="k">&#39;val</span> <span class="k">sig&#39;</span>
    <span class="k">val</span> <span class="n">sigabrt</span> <span class="o">:</span> <span class="kt">int</span>
    <span class="k">val</span> <span class="n">sigalrm</span> <span class="o">:</span> <span class="kt">int</span>
    <span class="k">val</span> <span class="n">sigfpe</span> <span class="o">:</span> <span class="kt">int</span>
    <span class="k">val</span> <span class="n">sighup</span> <span class="o">:</span> <span class="kt">int</span>
    <span class="k">val</span> <span class="n">sigill</span> <span class="o">:</span> <span class="kt">int</span>
    <span class="k">val</span> <span class="n">sigint</span> <span class="o">:</span> <span class="kt">int</span>
    <span class="k">val</span> <span class="n">sigkill</span> <span class="o">:</span> <span class="kt">int</span>
    <span class="k">val</span> <span class="n">sigpipe</span> <span class="o">:</span> <span class="kt">int</span>
    <span class="k">val</span> <span class="n">sigquit</span> <span class="o">:</span> <span class="kt">int</span>
    <span class="k">val</span> <span class="n">sigsegv</span> <span class="o">:</span> <span class="kt">int</span>
    <span class="k">val</span> <span class="n">sigterm</span> <span class="o">:</span> <span class="kt">int</span>
    <span class="k">val</span> <span class="n">sigusr1</span> <span class="o">:</span> <span class="kt">int</span>
    <span class="k">val</span> <span class="n">sigusr2</span> <span class="o">:</span> <span class="kt">int</span>
    <span class="k">val</span> <span class="n">sigchld</span> <span class="o">:</span> <span class="kt">int</span>
    <span class="k">val</span> <span class="n">sigcont</span> <span class="o">:</span> <span class="kt">int</span>
    <span class="k">val</span> <span class="n">sigstop</span> <span class="o">:</span> <span class="kt">int</span>
    <span class="k">val</span> <span class="n">sigtstp</span> <span class="o">:</span> <span class="kt">int</span>
    <span class="k">val</span> <span class="n">sigttin</span> <span class="o">:</span> <span class="kt">int</span>
    <span class="k">val</span> <span class="n">sigttou</span> <span class="o">:</span> <span class="kt">int</span>
    <span class="k">val</span> <span class="n">sigvtalrm</span> <span class="o">:</span> <span class="kt">int</span>
    <span class="k">val</span> <span class="n">sigprof</span> <span class="o">:</span> <span class="kt">int</span>

<span class="o">%</span> <span class="n">grep</span> <span class="o">-</span><span class="nc">A1</span> <span class="k">&#39;val</span> <span class="k">sig&#39;</span> <span class="n">sys</span><span class="o">.</span><span class="n">mli</span>
<span class="k">val</span> <span class="n">sigabrt</span> <span class="o">:</span> <span class="kt">int</span>
<span class="c">(** Abnormal termination *)</span>
<span class="o">--</span>
<span class="k">val</span> <span class="n">sigalrm</span> <span class="o">:</span> <span class="kt">int</span>
<span class="c">(** Timeout *)</span>
<span class="o">--</span>
<span class="k">val</span> <span class="n">sigfpe</span> <span class="o">:</span> <span class="kt">int</span>
<span class="c">(** Arithmetic exception *)</span>
<span class="o">--</span>
<span class="k">val</span> <span class="n">sighup</span> <span class="o">:</span> <span class="kt">int</span>
<span class="c">(** Hangup on controlling terminal *)</span>
<span class="o">--</span>
<span class="k">val</span> <span class="n">sigill</span> <span class="o">:</span> <span class="kt">int</span>
<span class="c">(** Invalid hardware instruction *)</span>
<span class="o">--</span>
<span class="k">val</span> <span class="n">sigint</span> <span class="o">:</span> <span class="kt">int</span>
<span class="c">(** Interactive interrupt (ctrl-C) *)</span>
<span class="o">--</span>
<span class="k">val</span> <span class="n">sigkill</span> <span class="o">:</span> <span class="kt">int</span>
<span class="c">(** Termination (cannot be ignored) *)</span>
<span class="o">--</span>
<span class="k">val</span> <span class="n">sigpipe</span> <span class="o">:</span> <span class="kt">int</span>
<span class="c">(** Broken pipe *)</span>
<span class="o">--</span>
<span class="k">val</span> <span class="n">sigquit</span> <span class="o">:</span> <span class="kt">int</span>
<span class="c">(** Interactive termination *)</span>
<span class="o">--</span>
<span class="k">val</span> <span class="n">sigsegv</span> <span class="o">:</span> <span class="kt">int</span>
<span class="c">(** Invalid memory reference *)</span>
<span class="o">--</span>
<span class="k">val</span> <span class="n">sigterm</span> <span class="o">:</span> <span class="kt">int</span>
<span class="c">(** Termination *)</span>
<span class="o">--</span>
<span class="k">val</span> <span class="n">sigusr1</span> <span class="o">:</span> <span class="kt">int</span>
<span class="c">(** Application-defined signal 1 *)</span>
<span class="o">--</span>
<span class="k">val</span> <span class="n">sigusr2</span> <span class="o">:</span> <span class="kt">int</span>
<span class="c">(** Application-defined signal 2 *)</span>
<span class="o">--</span>
<span class="k">val</span> <span class="n">sigchld</span> <span class="o">:</span> <span class="kt">int</span>
<span class="c">(** Child process terminated *)</span>
<span class="o">--</span>
<span class="k">val</span> <span class="n">sigcont</span> <span class="o">:</span> <span class="kt">int</span>
<span class="c">(** Continue *)</span>
<span class="o">--</span>
<span class="k">val</span> <span class="n">sigstop</span> <span class="o">:</span> <span class="kt">int</span>
<span class="c">(** Stop *)</span>
<span class="o">--</span>
<span class="k">val</span> <span class="n">sigtstp</span> <span class="o">:</span> <span class="kt">int</span>
<span class="c">(** Interactive stop *)</span>
<span class="o">--</span>
<span class="k">val</span> <span class="n">sigttin</span> <span class="o">:</span> <span class="kt">int</span>
<span class="c">(** Terminal read from background process *)</span>
<span class="o">--</span>
<span class="k">val</span> <span class="n">sigttou</span> <span class="o">:</span> <span class="kt">int</span>
<span class="c">(** Terminal write from background process *)</span>
<span class="o">--</span>
<span class="k">val</span> <span class="n">sigvtalrm</span> <span class="o">:</span> <span class="kt">int</span>
<span class="c">(** Timeout in virtual time *)</span>
<span class="o">--</span>
<span class="k">val</span> <span class="n">sigprof</span> <span class="o">:</span> <span class="kt">int</span>
<span class="c">(** Profiling interrupt *)</span>

<span class="c">(* @@PLEAC@@_16.14 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* send pid a signal 9 *)</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">kill</span> <span class="n">pid</span> <span class="mi">9</span><span class="o">;</span>
  <span class="c">(* send whole job a signal 1 *)</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">kill</span> <span class="n">pgrp</span> <span class="o">(-</span><span class="mi">1</span><span class="o">);</span>
  <span class="c">(* send myself a SIGUSR1 *)</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">kill</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">getpid</span> <span class="bp">()</span><span class="o">)</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigusr1</span><span class="o">;</span>
  <span class="c">(* send a SIGHUP to processes in pids *)</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="n">pid</span> <span class="o">-&gt;</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">kill</span> <span class="n">pid</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sighup</span><span class="o">)</span> <span class="n">pids</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Use kill with pseudo-signal 0 to see if process is alive. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="nn">Unix</span><span class="p">.</span><span class="n">kill</span> <span class="n">minion</span> <span class="mi">0</span><span class="o">;</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%d is alive!</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">minion</span>
  <span class="k">with</span>
    <span class="o">|</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">EPERM</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="o">-&gt;</span> <span class="c">(* changed uid *)</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%d has escaped my control!</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">minion</span>
    <span class="o">|</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">ESRCH</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%d is deceased.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="c">(* or zombied *)</span> <span class="n">minion</span>
    <span class="o">|</span> <span class="n">e</span> <span class="o">-&gt;</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Odd; I couldn&#39;t check on the status of %d: %s</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="n">minion</span>
          <span class="o">(</span><span class="nn">Printexc</span><span class="p">.</span><span class="n">to_string</span> <span class="n">e</span><span class="o">)</span>

<span class="c">(* @@PLEAC@@_16.15 *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* call got_sig_quit for every SIGQUIT *)</span>
  <span class="nn">Sys</span><span class="p">.</span><span class="n">set_signal</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigquit</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="nc">Signal_handle</span> <span class="n">got_sig_quit</span><span class="o">);</span>
  <span class="c">(* call got_sig_pipe for every SIGPIPE *)</span>
  <span class="nn">Sys</span><span class="p">.</span><span class="n">set_signal</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigpipe</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="nc">Signal_handle</span> <span class="n">got_sig_pipe</span><span class="o">);</span>
  <span class="c">(* increment ouch for every SIGINT *)</span>
  <span class="nn">Sys</span><span class="p">.</span><span class="n">set_signal</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigint</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="nc">Signal_handle</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">incr</span> <span class="n">ouch</span><span class="o">));</span>
  <span class="c">(* ignore the signal INT *)</span>
  <span class="nn">Sys</span><span class="p">.</span><span class="n">set_signal</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigint</span> <span class="nn">Sys</span><span class="p">.</span><span class="nc">Signal_ignore</span><span class="o">;</span>
  <span class="c">(* restore default STOP signal handling *)</span>
  <span class="nn">Sys</span><span class="p">.</span><span class="n">set_signal</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigstop</span> <span class="nn">Sys</span><span class="p">.</span><span class="nc">Signal_default</span>

<span class="c">(* @@PLEAC@@_16.16 *)</span>
<span class="k">let</span> <span class="n">finally</span> <span class="n">handler</span> <span class="n">f</span> <span class="n">x</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">result</span> <span class="o">=</span> <span class="k">try</span> <span class="n">f</span> <span class="n">x</span> <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">handler</span> <span class="bp">()</span><span class="o">;</span> <span class="k">raise</span> <span class="n">e</span> <span class="k">in</span> <span class="n">handler</span> <span class="bp">()</span><span class="o">;</span> <span class="n">result</span>

<span class="c">(* call f with signal behavior temporarily set *)</span>
<span class="k">let</span> <span class="n">local_set_signal</span> <span class="n">signal</span> <span class="n">behavior</span> <span class="n">f</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">old_behavior</span> <span class="o">=</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">signal</span> <span class="n">signal</span> <span class="n">behavior</span> <span class="k">in</span>
  <span class="n">finally</span> <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">set_signal</span> <span class="n">signal</span> <span class="n">old_behavior</span><span class="o">)</span> <span class="n">f</span> <span class="bp">()</span>

<span class="c">(* the signal handler *)</span>
<span class="k">let</span> <span class="k">rec</span> <span class="n">ding</span> <span class="o">_</span> <span class="o">=</span>
  <span class="nn">Sys</span><span class="p">.</span><span class="n">set_signal</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigint</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="nc">Signal_handle</span> <span class="n">ding</span><span class="o">);</span>
  <span class="n">prerr_endline</span> <span class="s2">&quot;</span><span class="se">\x07</span><span class="s2">Enter your name!&quot;</span>

<span class="c">(* prompt for name, overriding SIGINT *)</span>
<span class="k">let</span> <span class="n">get_name</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">local_set_signal</span>
    <span class="nn">Sys</span><span class="p">.</span><span class="n">sigint</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="nc">Signal_handle</span> <span class="n">ding</span><span class="o">)</span>
    <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span>
       <span class="n">print_string</span> <span class="s2">&quot;Kindly Stranger, please enter your name: &quot;</span><span class="o">;</span>
       <span class="n">read_line</span> <span class="bp">()</span><span class="o">)</span>

<span class="c">(* @@PLEAC@@_16.17 *)</span>
<span class="k">let</span> <span class="k">rec</span> <span class="n">got_int</span> <span class="o">_</span> <span class="o">=</span>
  <span class="nn">Sys</span><span class="p">.</span><span class="n">set_signal</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigint</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="nc">Signal_handle</span> <span class="n">got_int</span><span class="o">);</span>
  <span class="c">(* but not for SIGCHLD! *)</span>
  <span class="c">(* ... *)</span>
  <span class="bp">()</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="k">rec</span> <span class="n">got_int</span> <span class="o">_</span> <span class="o">=</span>
  <span class="nn">Sys</span><span class="p">.</span><span class="n">set_signal</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigint</span> <span class="nn">Sys</span><span class="p">.</span><span class="nc">Signal_default</span><span class="o">;</span> <span class="c">(* or Signal_ignore *)</span>
  <span class="n">failwith</span> <span class="s2">&quot;interrupted&quot;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Sys</span><span class="p">.</span><span class="n">set_signal</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigint</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="nc">Signal_handle</span> <span class="n">got_int</span><span class="o">);</span>
  <span class="k">try</span>
    <span class="c">(* ... long-running code that you don&#39;t want to restart *)</span>
    <span class="bp">()</span>
  <span class="k">with</span> <span class="nc">Failure</span> <span class="s2">&quot;interrupted&quot;</span> <span class="o">-&gt;</span>
    <span class="c">(* deal with the signal *)</span>
    <span class="bp">()</span>

<span class="c">(* @@PLEAC@@_16.18 *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* ignore signal INT *)</span>
  <span class="nn">Sys</span><span class="p">.</span><span class="n">set_signal</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigint</span> <span class="nn">Sys</span><span class="p">.</span><span class="nc">Signal_ignore</span><span class="o">;</span>

  <span class="c">(* install signal handler *)</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">tsktsk</span> <span class="n">signal</span> <span class="o">=</span>
    <span class="nn">Sys</span><span class="p">.</span><span class="n">set_signal</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigint</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="nc">Signal_handle</span> <span class="n">tsktsk</span><span class="o">);</span>
    <span class="n">print_endline</span> <span class="s2">&quot;</span><span class="se">\x07</span><span class="s2">The long habit of living indisposeth us for dying.&quot;</span> <span class="k">in</span>
  <span class="nn">Sys</span><span class="p">.</span><span class="n">set_signal</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigint</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="nc">Signal_handle</span> <span class="n">tsktsk</span><span class="o">)</span>

<span class="c">(* @@PLEAC@@_16.19 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Sys</span><span class="p">.</span><span class="n">set_signal</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigchld</span> <span class="nn">Sys</span><span class="p">.</span><span class="nc">Signal_ignore</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="k">rec</span> <span class="n">reaper</span> <span class="n">signal</span> <span class="o">=</span>
  <span class="k">try</span> <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span> <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">waitpid</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">WNOHANG</span><span class="o">]</span> <span class="o">(-</span><span class="mi">1</span><span class="o">))</span> <span class="k">done</span>
  <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">ECHILD</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">;</span>
  <span class="nn">Sys</span><span class="p">.</span><span class="n">set_signal</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigchld</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="nc">Signal_handle</span> <span class="n">reaper</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Sys</span><span class="p">.</span><span class="n">set_signal</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigchld</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="nc">Signal_handle</span> <span class="n">reaper</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="k">rec</span> <span class="n">reaper</span> <span class="n">signal</span> <span class="o">=</span>
  <span class="k">begin</span> <span class="k">try</span>
    <span class="k">let</span> <span class="n">pid</span><span class="o">,</span> <span class="n">status</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">waitpid</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">WNOHANG</span><span class="o">]</span> <span class="o">(-</span><span class="mi">1</span><span class="o">)</span> <span class="k">in</span> <span class="k">begin</span>
      <span class="k">match</span> <span class="n">status</span> <span class="k">with</span>
        <span class="o">|</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">WEXITED</span> <span class="o">_</span> <span class="o">-&gt;</span>
            <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Process %d exited.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">pid</span>
        <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span>
            <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;False alarm on %d.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">pid</span><span class="o">;</span>
    <span class="k">end</span><span class="o">;</span>
    <span class="n">reaper</span> <span class="n">signal</span>
  <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">ECHILD</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
    <span class="bp">()</span> <span class="c">(* No child waiting. Ignore it. *)</span>
  <span class="k">end</span><span class="o">;</span>
  <span class="nn">Sys</span><span class="p">.</span><span class="n">set_signal</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigchld</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="nc">Signal_handle</span> <span class="n">reaper</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Sys</span><span class="p">.</span><span class="n">set_signal</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigchld</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="nc">Signal_handle</span> <span class="n">reaper</span><span class="o">)</span>

<span class="c">(* @@PLEAC@@_16.20 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="c">(* define the signals to block *)</span>
<span class="k">let</span> <span class="n">sigset</span> <span class="o">=</span> <span class="o">[</span><span class="nn">Sys</span><span class="p">.</span><span class="n">sigint</span><span class="o">;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigkill</span><span class="o">]</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* block signals *)</span>
  <span class="k">let</span> <span class="n">old_sigset</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">sigprocmask</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">SIG_BLOCK</span> <span class="n">sigset</span> <span class="k">in</span>

  <span class="c">(* ... *)</span>

  <span class="c">(* unblock signals *)</span>
  <span class="c">(* the original recipe uses SIG_UNBLOCK, but that doesn&#39;t seem right... *)</span>
  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">sigprocmask</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">SIG_SETMASK</span> <span class="n">old_sigset</span><span class="o">)</span>

<span class="c">(* @@PLEAC@@_16.21 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Sys</span><span class="p">.</span><span class="n">set_signal</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigalrm</span>
    <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="nc">Signal_handle</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="s2">&quot;timeout&quot;</span><span class="o">));</span>

  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">alarm</span> <span class="mi">3600</span><span class="o">);</span>
  <span class="k">try</span>
    <span class="c">(* long-time operations here *)</span>
    <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">alarm</span> <span class="mi">0</span><span class="o">)</span>
  <span class="k">with</span>
    <span class="o">|</span> <span class="nc">Failure</span> <span class="s2">&quot;timeout&quot;</span> <span class="o">-&gt;</span>
        <span class="c">(* timed out; do what you will here *)</span>
        <span class="bp">()</span>
    <span class="o">|</span> <span class="n">e</span> <span class="o">-&gt;</span>
        <span class="c">(* clear the still-pending alarm *)</span>
        <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">alarm</span> <span class="mi">0</span><span class="o">);</span>
        <span class="c">(* propagate unexpected exception *)</span>
        <span class="k">raise</span> <span class="n">e</span>

<span class="c">(* @@PLEAC@@_16.22 *)</span>
<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* sigrand - supply random fortunes for .signature file *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="c">(* globals *)</span>

<span class="k">let</span> <span class="n">pwd</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">getpwuid</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">getuid</span> <span class="bp">()</span><span class="o">)</span>

<span class="k">let</span> <span class="n">home</span> <span class="o">=</span>
  <span class="k">try</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">getenv</span> <span class="s2">&quot;HOME&quot;</span> <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
    <span class="k">try</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">getenv</span> <span class="s2">&quot;LOGDIR&quot;</span> <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
      <span class="n">pwd</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">pw_dir</span>

<span class="k">let</span> <span class="n">fortune_path</span> <span class="o">=</span> <span class="n">ref</span> <span class="s2">&quot;&quot;</span>

<span class="c">(**************************************************************)</span>
<span class="c">(* begin configuration section *)</span>

<span class="c">(* for rec/humor/funny instead of rec.humor.funny *)</span>
<span class="k">let</span> <span class="n">ng_is_dir</span>      <span class="o">=</span> <span class="bp">true</span>

<span class="k">let</span> <span class="n">fullname</span>       <span class="o">=</span> <span class="n">home</span> <span class="o">^</span> <span class="s2">&quot;/.fullname&quot;</span>
<span class="k">let</span> <span class="n">fifo</span>           <span class="o">=</span> <span class="n">home</span> <span class="o">^</span> <span class="s2">&quot;/.signature&quot;</span>
<span class="k">let</span> <span class="n">art</span>            <span class="o">=</span> <span class="n">home</span> <span class="o">^</span> <span class="s2">&quot;/.article&quot;</span>
<span class="k">let</span> <span class="n">news</span>           <span class="o">=</span> <span class="n">home</span> <span class="o">^</span> <span class="s2">&quot;/News&quot;</span>
<span class="k">let</span> <span class="n">sigs</span>           <span class="o">=</span> <span class="n">news</span> <span class="o">^</span> <span class="s2">&quot;/SIGNATURES&quot;</span>
<span class="k">let</span> <span class="n">sema</span>           <span class="o">=</span> <span class="n">home</span> <span class="o">^</span> <span class="s2">&quot;/.sigrandpid&quot;</span>
<span class="k">let</span> <span class="n">globrand</span>       <span class="o">=</span> <span class="mi">0</span><span class="o">.</span><span class="mi">25</span>  <span class="c">(* chance to use global sigs anyway *)</span>

<span class="c">(* name should be (1) left None to have program guess</span>
<span class="c">   read address for signature maybe looking in ~/.fullname,</span>
<span class="c">   (2) set to an exact address, or (3) set to empty string</span>
<span class="c">   to be omitted entirely. *)</span>

<span class="c">(* let name        = ref None *)</span>
<span class="c">(* let name        = ref (Some (&quot;me@home.org&quot;)) *)</span>
<span class="k">let</span> <span class="n">name</span>           <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="nc">Some</span> <span class="s2">&quot;&quot;</span><span class="o">)</span>

<span class="c">(* end configuration section *)</span>
<span class="c">(**************************************************************)</span>

<span class="k">let</span> <span class="n">read_process_lines</span> <span class="n">command</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_in</span> <span class="n">command</span> <span class="k">in</span>
  <span class="k">begin</span>
    <span class="k">try</span>
      <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
        <span class="n">lines</span> <span class="o">:=</span> <span class="n">input_line</span> <span class="n">in_channel</span> <span class="o">::</span> <span class="o">!</span><span class="n">lines</span>
      <span class="k">done</span><span class="o">;</span>
    <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
      <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_in</span> <span class="n">in_channel</span><span class="o">)</span>
  <span class="k">end</span><span class="o">;</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="o">!</span><span class="n">lines</span>

<span class="k">let</span> <span class="n">line_stream_of_channel</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">channel</span><span class="o">)</span> <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="nc">None</span><span class="o">)</span>

<span class="k">let</span> <span class="n">delimited_stream_of_channel</span> <span class="n">delim</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">line_stream_of_channel</span> <span class="n">channel</span> <span class="k">in</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">next</span> <span class="n">para_lines</span> <span class="n">i</span> <span class="o">=</span>
    <span class="k">match</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">peek</span> <span class="n">lines</span><span class="o">,</span> <span class="n">para_lines</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">None</span><span class="o">,</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="nc">None</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">delim&#39;</span><span class="o">,</span> <span class="bp">[]</span> <span class="k">when</span> <span class="n">delim&#39;</span> <span class="o">=</span> <span class="n">delim</span> <span class="o">-&gt;</span>
          <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">lines</span><span class="o">;</span> <span class="n">next</span> <span class="n">para_lines</span> <span class="n">i</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">delim&#39;</span><span class="o">,</span> <span class="o">_</span> <span class="k">when</span> <span class="n">delim&#39;</span> <span class="o">=</span> <span class="n">delim</span> <span class="o">-&gt;</span>
          <span class="nc">Some</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="n">para_lines</span><span class="o">))</span>
      <span class="o">|</span> <span class="nc">None</span><span class="o">,</span> <span class="o">_</span> <span class="o">-&gt;</span>
          <span class="nc">Some</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="n">para_lines</span><span class="o">))</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">line</span><span class="o">,</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">lines</span><span class="o">;</span> <span class="n">next</span> <span class="o">(</span><span class="n">line</span> <span class="o">::</span> <span class="n">para_lines</span><span class="o">)</span> <span class="n">i</span> <span class="k">in</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span> <span class="o">(</span><span class="n">next</span> <span class="bp">[]</span><span class="o">)</span>

<span class="c">(* Make sure there&#39;s a fortune program.  Search</span>
<span class="c">   for its full path and set global to that. *)</span>
<span class="k">let</span> <span class="n">check_fortunes</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">fortune_path</span> <span class="o">&lt;&gt;</span> <span class="s2">&quot;&quot;</span>
  <span class="k">then</span> <span class="bp">()</span>  <span class="c">(* already set *)</span>
  <span class="k">else</span>
    <span class="k">let</span> <span class="n">path</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">split</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;:&quot;</span><span class="o">)</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">getenv</span> <span class="s2">&quot;PATH&quot;</span><span class="o">)</span> <span class="k">in</span>
    <span class="k">let</span> <span class="k">rec</span> <span class="n">check</span> <span class="o">=</span> <span class="k">function</span>
      <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span>
          <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span>
            <span class="s2">&quot;Need either %s or a fortune program, bailing out</span><span class="se">\n</span><span class="s2">&quot;</span>
            <span class="n">sigs</span><span class="o">;</span>
          <span class="n">exit</span> <span class="mi">1</span>
      <span class="o">|</span> <span class="n">dir</span> <span class="o">::</span> <span class="n">dirs</span> <span class="o">-&gt;</span>
          <span class="k">let</span> <span class="n">p</span> <span class="o">=</span> <span class="nn">Filename</span><span class="p">.</span><span class="n">concat</span> <span class="n">dir</span> <span class="s2">&quot;fortune&quot;</span> <span class="k">in</span>
          <span class="k">if</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">file_exists</span> <span class="n">p</span> <span class="k">then</span> <span class="n">p</span> <span class="k">else</span> <span class="n">check</span> <span class="n">dirs</span> <span class="k">in</span>
    <span class="n">fortune_path</span> <span class="o">:=</span> <span class="n">check</span> <span class="o">(</span><span class="n">path</span> <span class="o">@</span> <span class="o">[</span><span class="s2">&quot;/usr/games&quot;</span><span class="o">])</span>

<span class="c">(* Call the fortune program with -s for short flag until</span>
<span class="c">   we get a small enough fortune or ask too much. *)</span>
<span class="k">let</span> <span class="n">fortune</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">cmd</span> <span class="o">=</span> <span class="o">!</span><span class="n">fortune_path</span> <span class="o">^</span> <span class="s2">&quot; -s&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span> <span class="n">tries</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">read_process_lines</span> <span class="n">cmd</span> <span class="k">in</span>
    <span class="k">if</span> <span class="nn">List</span><span class="p">.</span><span class="n">length</span> <span class="n">lines</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="k">then</span> <span class="n">lines</span>
    <span class="k">else</span> <span class="k">if</span> <span class="n">tries</span> <span class="o">&lt;</span> <span class="mi">20</span> <span class="k">then</span> <span class="n">loop</span> <span class="o">(</span><span class="n">tries</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span>
    <span class="k">else</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="k">match</span> <span class="n">loop</span> <span class="mi">0</span> <span class="k">with</span>
    <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span>
        <span class="o">[</span><span class="s2">&quot; SIGRAND: deliver random signals to all processes.&quot;</span><span class="o">]</span>
    <span class="o">|</span> <span class="n">lines</span> <span class="o">-&gt;</span>
        <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">((</span> <span class="o">^</span> <span class="o">)</span> <span class="s2">&quot; &quot;</span><span class="o">)</span> <span class="n">lines</span>

<span class="c">(* See whether ~/.article contains a Newsgroups line. if so, see the</span>
<span class="c">   first group posted to and find out whether it has a dedicated set of</span>
<span class="c">   fortunes. otherwise return the global one. Also, return the global</span>
<span class="c">   one randomly now and then to spice up the sigs. *)</span>
<span class="k">let</span> <span class="n">signame</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="nn">Random</span><span class="p">.</span><span class="n">float</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="n">globrand</span>
  <span class="k">then</span>
    <span class="k">begin</span>
      <span class="k">try</span>
        <span class="k">let</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">open_in</span> <span class="n">art</span> <span class="k">in</span>
        <span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;Newsgroups:[ </span><span class="se">\t</span><span class="s2">]*</span><span class="se">\\</span><span class="s2">([^, </span><span class="se">\r\n\t</span><span class="s2">]*</span><span class="se">\\</span><span class="s2">)&quot;</span> <span class="k">in</span>
        <span class="k">let</span> <span class="n">ng</span> <span class="o">=</span> <span class="n">ref</span> <span class="s2">&quot;&quot;</span> <span class="k">in</span>
        <span class="k">begin</span>
          <span class="k">try</span>
            <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
              <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">channel</span> <span class="k">in</span>
              <span class="k">if</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">regexp</span> <span class="n">line</span> <span class="mi">0</span>
              <span class="k">then</span> <span class="n">ng</span> <span class="o">:=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">1</span> <span class="n">line</span>
            <span class="k">done</span>
          <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
            <span class="n">close_in</span> <span class="n">channel</span>
        <span class="k">end</span><span class="o">;</span>
        <span class="k">if</span> <span class="n">ng_is_dir</span>
        <span class="k">then</span> <span class="n">ng</span> <span class="o">:=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">global_replace</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">.&quot;</span><span class="o">)</span> <span class="s2">&quot;/&quot;</span> <span class="o">!</span><span class="n">ng</span><span class="o">;</span>
        <span class="n">ng</span> <span class="o">:=</span> <span class="n">news</span> <span class="o">^</span> <span class="s2">&quot;/&quot;</span> <span class="o">^</span> <span class="o">!</span><span class="n">ng</span> <span class="o">^</span> <span class="s2">&quot;/&quot;</span> <span class="o">^</span> <span class="s2">&quot;SIGNATURES&quot;</span><span class="o">;</span>
        <span class="k">if</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">file_exists</span> <span class="o">!</span><span class="n">ng</span> <span class="k">then</span> <span class="o">!</span><span class="n">ng</span> <span class="k">else</span> <span class="n">sigs</span>
      <span class="k">with</span> <span class="nc">Sys_error</span> <span class="n">e</span> <span class="o">-&gt;</span>
        <span class="n">sigs</span>
    <span class="k">end</span>
  <span class="k">else</span> <span class="n">sigs</span>

<span class="c">(* choose a random signature *)</span>
<span class="k">let</span> <span class="n">pick_quote</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">sigfile</span> <span class="o">=</span> <span class="n">signame</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="n">file_exists</span> <span class="n">sigfile</span><span class="o">)</span>
  <span class="k">then</span> <span class="n">fortune</span> <span class="bp">()</span>
  <span class="k">else</span>
    <span class="k">begin</span>
      <span class="k">let</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">open_in</span> <span class="n">sigfile</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">stream</span> <span class="o">=</span> <span class="n">delimited_stream_of_channel</span> <span class="s2">&quot;%%&quot;</span> <span class="n">channel</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">quip</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">num</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">1</span> <span class="k">in</span>
      <span class="nn">Stream</span><span class="p">.</span><span class="n">iter</span>
        <span class="o">(</span><span class="k">fun</span> <span class="n">chunk</span> <span class="o">-&gt;</span>
           <span class="k">if</span> <span class="nn">Random</span><span class="p">.</span><span class="n">int</span> <span class="o">!</span><span class="n">num</span> <span class="o">=</span> <span class="mi">0</span>
           <span class="k">then</span> <span class="n">quip</span> <span class="o">:=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">split</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span> <span class="n">chunk</span><span class="o">;</span>
           <span class="n">incr</span> <span class="n">num</span><span class="o">)</span>
        <span class="n">stream</span><span class="o">;</span>
      <span class="n">close_in</span> <span class="n">channel</span><span class="o">;</span>
      <span class="k">if</span> <span class="o">!</span><span class="n">quip</span> <span class="o">&lt;&gt;</span> <span class="bp">[]</span>
      <span class="k">then</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">((</span> <span class="o">^</span> <span class="o">)</span> <span class="s2">&quot; &quot;</span><span class="o">)</span> <span class="o">!</span><span class="n">quip</span>
      <span class="k">else</span> <span class="o">[</span><span class="s2">&quot; ENOSIG: This signature file is empty.&quot;</span><span class="o">]</span>
    <span class="k">end</span>

<span class="c">(* Ignore SIGPIPE in case someone opens us up and then closes the fifo</span>
<span class="c">   without reading it; look in a .fullname file for their login name.</span>
<span class="c">   Try to determine the fully qualified hostname. Make sure we have</span>
<span class="c">   signatures or fortunes. Build a fifo if we need to. *)</span>

<span class="k">let</span> <span class="n">setup</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Sys</span><span class="p">.</span><span class="n">set_signal</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigpipe</span> <span class="nn">Sys</span><span class="p">.</span><span class="nc">Signal_ignore</span><span class="o">;</span>

  <span class="k">if</span> <span class="o">!</span><span class="n">name</span> <span class="o">=</span> <span class="nc">Some</span> <span class="s2">&quot;&quot;</span> <span class="k">then</span>
    <span class="k">begin</span>
      <span class="k">try</span>
        <span class="k">let</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">open_in</span> <span class="n">fullname</span> <span class="k">in</span>
        <span class="n">name</span> <span class="o">:=</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">channel</span><span class="o">);</span>
        <span class="n">close_in</span> <span class="n">channel</span>
      <span class="k">with</span> <span class="nc">Sys_error</span> <span class="o">_</span> <span class="o">-&gt;</span>
        <span class="n">name</span> <span class="o">:=</span> <span class="nc">Some</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">global_replace</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;,.*&quot;</span><span class="o">)</span> <span class="s2">&quot;&quot;</span>
                        <span class="n">pwd</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">pw_gecos</span><span class="o">)</span>
    <span class="k">end</span><span class="o">;</span>

  <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="n">file_exists</span> <span class="n">sigs</span><span class="o">)</span> <span class="k">then</span> <span class="n">check_fortunes</span> <span class="bp">()</span><span class="o">;</span>

  <span class="k">if</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">file_exists</span> <span class="n">fifo</span>
  <span class="k">then</span> <span class="o">(</span><span class="k">if</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">stat</span> <span class="n">fifo</span><span class="o">).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">st_kind</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">S_FIFO</span>
        <span class="k">then</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s: using existing named pipe %s</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span> <span class="n">fifo</span><span class="o">)</span>
        <span class="k">else</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s: won&#39;t overwrite file %s</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span> <span class="n">fifo</span><span class="o">;</span>
              <span class="n">exit</span> <span class="mi">1</span><span class="o">))</span>
  <span class="k">else</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">mkfifo</span> <span class="n">fifo</span> <span class="mo">0o666</span><span class="o">;</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s: created %s as a named pipe</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span> <span class="n">fifo</span><span class="o">);</span>

  <span class="nn">Random</span><span class="p">.</span><span class="n">self_init</span> <span class="bp">()</span>

<span class="c">(* &quot;There can be only one.&quot;  --the Highlander *)</span>
<span class="k">let</span> <span class="n">justme</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">channel</span> <span class="o">=</span>
    <span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">open_in</span> <span class="n">sema</span><span class="o">)</span>
    <span class="k">with</span> <span class="nc">Sys_error</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nc">None</span> <span class="k">in</span>
  <span class="k">match</span> <span class="n">channel</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nc">Some</span> <span class="n">channel</span> <span class="o">-&gt;</span>
        <span class="k">begin</span>
          <span class="k">let</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">int_of_string</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">channel</span><span class="o">)</span> <span class="k">in</span>
          <span class="k">try</span>
            <span class="nn">Unix</span><span class="p">.</span><span class="n">kill</span> <span class="n">pid</span> <span class="mi">0</span><span class="o">;</span>
            <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s already running (pid %d), bailing out</span><span class="se">\n</span><span class="s2">&quot;</span>
              <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span> <span class="n">pid</span><span class="o">;</span>
            <span class="n">exit</span> <span class="mi">1</span>
          <span class="k">with</span> <span class="o">_</span> <span class="o">-&gt;</span>
            <span class="n">close_in</span> <span class="n">channel</span>
        <span class="k">end</span>
    <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="bp">()</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">setup</span> <span class="bp">()</span><span class="o">;</span>                <span class="c">(* pull in inits *)</span>
  <span class="n">justme</span> <span class="bp">()</span><span class="o">;</span>               <span class="c">(* make sure program not already running *)</span>
  <span class="k">match</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">fork</span> <span class="bp">()</span> <span class="k">with</span>  <span class="c">(* background ourself and go away *)</span>
    <span class="o">|</span> <span class="mi">0</span> <span class="o">-&gt;</span>
        <span class="k">let</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">open_out</span> <span class="n">sema</span> <span class="k">in</span>
        <span class="n">output_string</span> <span class="n">channel</span> <span class="o">(</span><span class="n">string_of_int</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">getpid</span> <span class="bp">()</span><span class="o">));</span>
        <span class="n">output_string</span> <span class="n">channel</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
        <span class="n">close_out</span> <span class="n">channel</span><span class="o">;</span>

        <span class="c">(* now loop forever, writing a signature into the</span>
<span class="c">           fifo file.  if you don&#39;t have real fifos, change</span>
<span class="c">           sleep time at bottom of loop to like 10 to update</span>
<span class="c">           only every 10 seconds. *)</span>

        <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
          <span class="k">let</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">open_out</span> <span class="n">fifo</span> <span class="k">in</span>
          <span class="k">let</span> <span class="k">sig&#39;</span> <span class="o">=</span> <span class="n">pick_quote</span> <span class="bp">()</span> <span class="k">in</span>
          <span class="k">let</span> <span class="k">sig&#39;</span> <span class="o">=</span> <span class="nn">Array</span><span class="p">.</span><span class="n">of_list</span> <span class="k">sig&#39;</span> <span class="k">in</span>

          <span class="c">(* trunc to 4 lines *)</span>
          <span class="k">let</span> <span class="k">sig&#39;</span> <span class="o">=</span>
            <span class="k">if</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="k">sig&#39;</span> <span class="o">&gt;</span> <span class="mi">4</span>
            <span class="k">then</span> <span class="nn">Array</span><span class="p">.</span><span class="n">sub</span> <span class="k">sig&#39;</span> <span class="mi">0</span> <span class="mi">4</span>
            <span class="k">else</span> <span class="k">sig&#39;</span> <span class="k">in</span>

          <span class="c">(* trunc long lines *)</span>
          <span class="k">let</span> <span class="k">sig&#39;</span> <span class="o">=</span>
            <span class="nn">Array</span><span class="p">.</span><span class="n">map</span>
              <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span>
                 <span class="k">if</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">line</span> <span class="o">&gt;</span> <span class="mi">80</span>
                 <span class="k">then</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">line</span> <span class="mi">0</span> <span class="mi">80</span>
                 <span class="k">else</span> <span class="n">line</span><span class="o">)</span>
              <span class="k">sig&#39;</span> <span class="k">in</span>

          <span class="c">(* print sig, with name if present, padded to four lines *)</span>
          <span class="k">begin</span>
            <span class="k">match</span> <span class="o">!</span><span class="n">name</span> <span class="k">with</span>
              <span class="o">|</span> <span class="nc">None</span> <span class="o">|</span> <span class="nc">Some</span> <span class="s2">&quot;&quot;</span> <span class="o">-&gt;</span>
                  <span class="nn">Array</span><span class="p">.</span><span class="n">iter</span>
                    <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span>
                       <span class="n">output_string</span> <span class="n">channel</span> <span class="n">line</span><span class="o">;</span>
                       <span class="n">output_string</span> <span class="n">channel</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span>
                    <span class="k">sig&#39;</span>
              <span class="o">|</span> <span class="nc">Some</span> <span class="n">name</span> <span class="o">-&gt;</span>
                  <span class="n">output_string</span> <span class="n">channel</span> <span class="n">name</span><span class="o">;</span>
                  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">4</span> <span class="k">downto</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="k">sig&#39;</span> <span class="k">do</span>
                    <span class="n">output_string</span> <span class="n">channel</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
                  <span class="k">done</span><span class="o">;</span>
                  <span class="nn">Array</span><span class="p">.</span><span class="n">iter</span>
                    <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span>
                       <span class="n">output_string</span> <span class="n">channel</span> <span class="n">line</span><span class="o">;</span>
                       <span class="n">output_string</span> <span class="n">channel</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span>
                    <span class="k">sig&#39;</span>
          <span class="k">end</span><span class="o">;</span>
          <span class="n">close_out</span> <span class="n">channel</span><span class="o">;</span>

          <span class="c">(* Without a microsleep, the reading process doesn&#39;t finish</span>
<span class="c">             before the writer tries to open it again, which since the</span>
<span class="c">             reader exists, succeeds. They end up with multiple</span>
<span class="c">             signatures. Sleep a tiny bit between opens to give readers</span>
<span class="c">             a chance to finish reading and close our pipe so we can</span>
<span class="c">             block when opening it the next time. *)</span>

          <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">select</span> <span class="bp">[]</span> <span class="bp">[]</span> <span class="bp">[]</span> <span class="mi">0</span><span class="o">.</span><span class="mi">2</span><span class="o">)</span>  <span class="c">(* sleep 1/5 second *)</span>
        <span class="k">done</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span>
        <span class="n">exit</span> <span class="mi">0</span>


<span class="c">(* @@PLEAC@@_17.0 *)</span>
<span class="k">open</span> <span class="nc">Unix</span>

<span class="c">(* Convert human readable form to 32 bit value *)</span>
<span class="k">let</span> <span class="n">packed_ip</span> <span class="o">=</span> <span class="n">inet_addr_of_string</span> <span class="s2">&quot;208.146.240.1&quot;</span> <span class="k">in</span>

<span class="k">let</span> <span class="n">host</span> <span class="o">=</span> <span class="n">gethostbyname</span> <span class="s2">&quot;www.oreilly.com&quot;</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">packed_ip</span> <span class="o">=</span> <span class="n">host</span><span class="o">.</span><span class="n">h_addr_list</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span> <span class="k">in</span>

<span class="c">(* Convert 32 bit value to ip adress *)</span>
<span class="k">let</span> <span class="n">ip_address</span> <span class="o">=</span> <span class="n">string_of_inet_addr</span> <span class="o">(</span><span class="n">packed_ip</span><span class="o">)</span> <span class="k">in</span>

<span class="c">(* Create socket object *)</span>
<span class="k">let</span> <span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span> <span class="nc">PF_INET</span> <span class="nc">SOCK_STREAM</span> <span class="mi">0</span> <span class="k">in</span>

<span class="c">(* Get socketname *)</span>
<span class="k">let</span> <span class="n">saddr</span> <span class="o">=</span> <span class="n">getsockname</span> <span class="n">sock</span> <span class="o">;;</span>


<span class="c">(* @@PLEAC@@_17.1 *)</span>

<span class="c">(* For real applications you should the SMTP module in Ocamlnet. *)</span>
<span class="k">open</span> <span class="nc">Unix</span>

<span class="k">let</span> <span class="n">sock_send</span> <span class="n">sock</span> <span class="n">str</span> <span class="o">=</span>
	    <span class="k">let</span> <span class="n">len</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">str</span> <span class="k">in</span>
    <span class="n">send</span> <span class="n">sock</span> <span class="n">str</span> <span class="mi">0</span> <span class="n">len</span> <span class="bp">[]</span>

<span class="k">let</span> <span class="n">sock_recv</span> <span class="n">sock</span> <span class="n">maxlen</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">str</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">create</span> <span class="n">maxlen</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">recvlen</span> <span class="o">=</span> <span class="n">recv</span> <span class="n">sock</span> <span class="n">str</span> <span class="mi">0</span> <span class="n">maxlen</span> <span class="bp">[]</span> <span class="k">in</span>
    <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">str</span> <span class="mi">0</span> <span class="n">recvlen</span>

<span class="k">let</span> <span class="n">client_sock</span> <span class="o">=</span> <span class="n">socket</span> <span class="nc">PF_INET</span> <span class="nc">SOCK_STREAM</span> <span class="mi">0</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">hentry</span> <span class="o">=</span> <span class="n">gethostbyname</span> <span class="s2">&quot;coltrane&quot;</span> <span class="k">in</span>
<span class="n">connect</span> <span class="n">client_sock</span> <span class="o">(</span><span class="nc">ADDR_INET</span> <span class="o">(</span><span class="n">hentry</span><span class="o">.</span><span class="n">h_addr_list</span><span class="o">.(</span><span class="mi">0</span><span class="o">),</span> <span class="mi">25</span><span class="o">))</span> <span class="o">;</span> <span class="c">(* SMTP *)</span>

<span class="n">sock_recv</span> <span class="n">client_sock</span> <span class="mi">1024</span> <span class="o">;</span>

<span class="n">sock_send</span> <span class="n">client_sock</span> <span class="s2">&quot;mail from: &lt;pleac@localhost&gt;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">;</span>
<span class="n">sock_recv</span> <span class="n">client_sock</span> <span class="mi">1024</span> <span class="o">;</span>

<span class="n">sock_send</span> <span class="n">client_sock</span> <span class="s2">&quot;rcpt to: &lt;erikd@localhost&gt;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">;</span>
<span class="n">sock_recv</span> <span class="n">client_sock</span> <span class="mi">1024</span><span class="o">;</span>

<span class="n">sock_send</span> <span class="n">client_sock</span> <span class="s2">&quot;data</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">;</span>
<span class="n">sock_recv</span> <span class="n">client_sock</span> <span class="mi">1024</span> <span class="o">;</span>

<span class="n">sock_send</span> <span class="n">client_sock</span> <span class="s2">&quot;From: Ocaml whiz</span><span class="se">\n</span><span class="s2">Subject: Ocaml rulez!</span><span class="se">\n\n</span><span class="s2">YES!</span><span class="se">\n</span><span class="s2">.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">;</span>
<span class="n">sock_recv</span> <span class="n">client_sock</span> <span class="mi">1024</span> <span class="o">;</span>

<span class="n">close</span> <span class="n">client_sock</span> <span class="o">;;</span>


<span class="c">(* @@PLEAC@@_17.2 *)</span>

<span class="c">(* Writing a TCP Server *)</span>
<span class="c">(* Run this and then telnet &lt;machinename&gt; 1027 *)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span> <span class="o">;;</span>
<span class="k">open</span> <span class="nc">Unix</span> <span class="o">;;</span>

<span class="k">let</span> <span class="n">server_sock</span> <span class="o">=</span> <span class="n">socket</span> <span class="nc">PF_INET</span> <span class="nc">SOCK_STREAM</span> <span class="mi">0</span> <span class="k">in</span>

<span class="c">(* so we can restart our server quickly *)</span>
<span class="n">setsockopt</span> <span class="n">server_sock</span> <span class="nc">SO_REUSEADDR</span> <span class="bp">true</span> <span class="o">;</span>

<span class="c">(* build up my socket address *)</span>
<span class="k">let</span> <span class="n">address</span> <span class="o">=</span> <span class="o">(</span><span class="n">gethostbyname</span><span class="o">(</span><span class="n">gethostname</span><span class="bp">()</span><span class="o">)).</span><span class="n">h_addr_list</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span> <span class="k">in</span>
<span class="n">bind</span> <span class="n">server_sock</span> <span class="o">(</span><span class="nc">ADDR_INET</span> <span class="o">(</span><span class="n">address</span><span class="o">,</span> <span class="mi">1029</span><span class="o">))</span> <span class="o">;</span>

<span class="c">(* Listen on the socket. Max of 10 incoming connections. *)</span>
<span class="n">listen</span> <span class="n">server_sock</span> <span class="mi">10</span> <span class="o">;</span>

<span class="c">(* accept and process connections *)</span>
<span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
	<span class="k">let</span> <span class="o">(</span><span class="n">client_sock</span><span class="o">,</span> <span class="n">client_addr</span><span class="o">)</span> <span class="o">=</span> <span class="n">accept</span> <span class="n">server_sock</span> <span class="k">in</span>
	<span class="k">let</span> <span class="n">str</span> <span class="o">=</span> <span class="s2">&quot;Hello</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">in</span>
	<span class="k">let</span> <span class="n">len</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">str</span> <span class="k">in</span>
	<span class="k">let</span> <span class="n">x</span> <span class="o">=</span> <span class="n">send</span> <span class="n">client_sock</span> <span class="n">str</span> <span class="mi">0</span> <span class="n">len</span> <span class="bp">[]</span> <span class="k">in</span>
	<span class="n">shutdown</span> <span class="n">client_sock</span> <span class="nc">SHUTDOWN_ALL</span>
	<span class="k">done</span> <span class="o">;;</span>

<span class="c">(* @@PLEAC@@_17.3 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">server_in</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">in_channel_of_descr</span> <span class="n">server</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">server_out</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">out_channel_of_descr</span> <span class="n">server</span> <span class="k">in</span>
  <span class="n">output_string</span> <span class="n">server_out</span> <span class="s2">&quot;What is your name?</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
  <span class="n">flush</span> <span class="n">server_out</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">response</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">server_in</span> <span class="k">in</span>
  <span class="n">print_endline</span> <span class="n">response</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="n">ignore</span>
      <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">send</span> <span class="n">server</span> <span class="n">data_to_send</span> <span class="mi">0</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">data_to_send</span><span class="o">)</span> <span class="n">flags</span><span class="o">)</span>
  <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Can&#39;t send: %s</span><span class="se">\n</span><span class="s2">%!&quot;</span>
      <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">error_message</span> <span class="n">e</span><span class="o">);</span>
    <span class="n">exit</span> <span class="mi">1</span>

<span class="k">let</span> <span class="n">data_read</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">data_read</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">create</span> <span class="n">maxlen</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">data_length</span> <span class="o">=</span>
    <span class="k">try</span>
      <span class="nn">Unix</span><span class="p">.</span><span class="n">recv</span> <span class="n">server</span> <span class="n">data_read</span> <span class="mi">0</span> <span class="n">maxlen</span> <span class="n">flags</span>
    <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Can&#39;t receive: %s</span><span class="se">\n</span><span class="s2">%!&quot;</span>
        <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">error_message</span> <span class="n">e</span><span class="o">);</span>
      <span class="n">exit</span> <span class="mi">1</span> <span class="k">in</span>
  <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">data_read</span> <span class="mi">0</span> <span class="n">data_length</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">read_from</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_</span> <span class="o">=</span>
    <span class="nn">Unix</span><span class="p">.</span><span class="n">select</span> <span class="o">[</span><span class="n">from_server</span><span class="o">;</span> <span class="n">to_client</span><span class="o">]</span> <span class="bp">[]</span> <span class="bp">[]</span> <span class="n">timeout</span> <span class="k">in</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">socket</span> <span class="o">-&gt;</span>
       <span class="c">(* read the pending data from socket *)</span>
       <span class="bp">()</span><span class="o">)</span>
    <span class="n">read_from</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Requires OCaml 3.11 or newer. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">setsockopt</span> <span class="n">server</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">TCP_NODELAY</span> <span class="bp">true</span>
  <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Couldn&#39;t disable Nagle&#39;s algorithm: %s</span><span class="se">\n</span><span class="s2">%!&quot;</span>
      <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">error_message</span> <span class="n">e</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Requires OCaml 3.11 or newer. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">setsockopt</span> <span class="n">server</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">TCP_NODELAY</span> <span class="bp">false</span>
  <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Couldn&#39;t enable Nagle&#39;s algorithm: %s</span><span class="se">\n</span><span class="s2">%!&quot;</span>
      <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">error_message</span> <span class="n">e</span><span class="o">)</span>

<span class="c">(* @@PLEAC@@_17.4 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="c">(* Create a UDP socket. *)</span>
<span class="k">let</span> <span class="n">socket</span> <span class="o">=</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">socket</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">PF_INET</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">SOCK_DGRAM</span>
    <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">getprotobyname</span> <span class="s2">&quot;udp&quot;</span><span class="o">).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">p_proto</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Send a UDP message. *)</span>
<span class="k">let</span> <span class="n">ipaddr</span> <span class="o">=</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">gethostbyname</span> <span class="n">hostname</span><span class="o">).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">h_addr_list</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span>
<span class="k">let</span> <span class="n">portaddr</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">ADDR_INET</span> <span class="o">(</span><span class="n">ipaddr</span><span class="o">,</span> <span class="n">portno</span><span class="o">)</span>
<span class="k">let</span> <span class="n">len</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">sendto</span> <span class="n">socket</span> <span class="n">msg</span> <span class="mi">0</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">msg</span><span class="o">)</span> <span class="bp">[]</span> <span class="n">portaddr</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Receive a UDP message. *)</span>
<span class="k">let</span> <span class="n">msg</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">create</span> <span class="n">maxlen</span>
<span class="k">let</span> <span class="n">len</span><span class="o">,</span> <span class="n">portaddr</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">recvfrom</span> <span class="n">socket</span> <span class="n">msg</span> <span class="mi">0</span> <span class="n">maxlen</span> <span class="bp">[]</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* clockdrift - compare another system&#39;s clock with this one *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">secs_of_70_years</span> <span class="o">=</span> <span class="mi">2_208_988_800</span><span class="n">L</span>

<span class="k">let</span> <span class="n">msgbox</span> <span class="o">=</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">socket</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">PF_INET</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">SOCK_DGRAM</span>
    <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">getprotobyname</span> <span class="s2">&quot;udp&quot;</span><span class="o">).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">p_proto</span>

<span class="k">let</span> <span class="n">him</span> <span class="o">=</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="nc">ADDR_INET</span> <span class="o">((</span><span class="nn">Unix</span><span class="p">.</span><span class="n">gethostbyname</span>
                     <span class="o">(</span><span class="k">if</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="o">&gt;</span> <span class="mi">1</span>
                      <span class="k">then</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span>
                      <span class="k">else</span> <span class="s2">&quot;127.1&quot;</span><span class="o">)).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">h_addr_list</span><span class="o">.(</span><span class="mi">0</span><span class="o">),</span>
                  <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">getservbyname</span> <span class="s2">&quot;time&quot;</span> <span class="s2">&quot;udp&quot;</span><span class="o">).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">s_port</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">sendto</span> <span class="n">msgbox</span> <span class="s2">&quot;&quot;</span> <span class="mi">0</span> <span class="mi">0</span> <span class="bp">[]</span> <span class="n">him</span><span class="o">)</span>

<span class="k">let</span> <span class="n">ptime</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">create</span> <span class="mi">4</span>

<span class="k">let</span> <span class="n">host</span> <span class="o">=</span>
  <span class="k">match</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">recvfrom</span> <span class="n">msgbox</span> <span class="n">ptime</span> <span class="mi">0</span> <span class="mi">4</span> <span class="bp">[]</span> <span class="k">with</span>
    <span class="o">|</span> <span class="o">_,</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">ADDR_INET</span> <span class="o">(</span><span class="n">addr</span><span class="o">,</span> <span class="n">port</span><span class="o">)</span> <span class="o">-&gt;</span>
        <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">gethostbyaddr</span> <span class="n">addr</span><span class="o">).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">h_name</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">assert</span> <span class="bp">false</span>

<span class="k">let</span> <span class="n">delta</span> <span class="o">=</span>
  <span class="nn">Int64</span><span class="p">.</span><span class="n">to_float</span>
    <span class="o">(</span><span class="nn">Int64</span><span class="p">.</span><span class="n">sub</span>
       <span class="o">(</span><span class="nn">Int64</span><span class="p">.</span><span class="n">of_string</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;0x%02x%02x%02x%02x&quot;</span>
                           <span class="o">(</span><span class="n">int_of_char</span> <span class="n">ptime</span><span class="o">.[</span><span class="mi">0</span><span class="o">])</span>
                           <span class="o">(</span><span class="n">int_of_char</span> <span class="n">ptime</span><span class="o">.[</span><span class="mi">1</span><span class="o">])</span>
                           <span class="o">(</span><span class="n">int_of_char</span> <span class="n">ptime</span><span class="o">.[</span><span class="mi">2</span><span class="o">])</span>
                           <span class="o">(</span><span class="n">int_of_char</span> <span class="n">ptime</span><span class="o">.[</span><span class="mi">3</span><span class="o">])))</span>
       <span class="n">secs_of_70_years</span><span class="o">)</span>
    <span class="o">-.</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">time</span> <span class="bp">()</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Clock on %s is %d seconds ahead of this one.</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">host</span> <span class="o">(</span><span class="n">int_of_float</span> <span class="n">delta</span><span class="o">)</span>

<span class="c">(* @@PLEAC@@_17.5 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">begin</span>
    <span class="k">try</span>
      <span class="nn">Unix</span><span class="p">.</span><span class="n">bind</span> <span class="n">socket</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">ADDR_INET</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">inet_addr_any</span><span class="o">,</span> <span class="n">server_port</span><span class="o">));</span>
    <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Couldn&#39;t be a udp server on port %d: %s</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">server_port</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">error_message</span> <span class="n">e</span><span class="o">);</span>
      <span class="n">exit</span> <span class="mi">1</span>
  <span class="k">end</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">him</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">create</span> <span class="n">max_to_read</span> <span class="k">in</span>
  <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
    <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">recvfrom</span> <span class="n">socket</span> <span class="n">him</span> <span class="mi">0</span> <span class="n">max_to_read</span> <span class="bp">[]</span><span class="o">);</span>
    <span class="c">(* do something *)</span>
  <span class="k">done</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* udpqotd - UDP message server *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">maxlen</span> <span class="o">=</span> <span class="mi">1024</span>
<span class="k">let</span> <span class="n">portno</span> <span class="o">=</span> <span class="mi">5151</span>

<span class="k">let</span> <span class="n">sock</span> <span class="o">=</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">socket</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">PF_INET</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">SOCK_DGRAM</span>
    <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">getprotobyname</span> <span class="s2">&quot;udp&quot;</span><span class="o">).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">p_proto</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">bind</span> <span class="n">sock</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">ADDR_INET</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">inet_addr_any</span><span class="o">,</span> <span class="n">portno</span><span class="o">));</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Awaiting UDP messages on port %d</span><span class="se">\n</span><span class="s2">%!&quot;</span> <span class="n">portno</span>

<span class="k">let</span> <span class="n">oldmsg</span> <span class="o">=</span> <span class="n">ref</span> <span class="s2">&quot;This is the starting message.&quot;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">newmsg</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">create</span> <span class="n">maxlen</span> <span class="k">in</span>
  <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">newmsg</span><span class="o">,</span> <span class="n">hishost</span><span class="o">,</span> <span class="n">sockaddr</span> <span class="o">=</span>
      <span class="k">match</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">recvfrom</span> <span class="n">sock</span> <span class="n">newmsg</span> <span class="mi">0</span> <span class="n">maxlen</span> <span class="bp">[]</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">len</span><span class="o">,</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">ADDR_INET</span> <span class="o">(</span><span class="n">addr</span><span class="o">,</span> <span class="n">port</span><span class="o">)</span> <span class="k">as</span> <span class="n">sockaddr</span><span class="o">)</span> <span class="o">-&gt;</span>
            <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">newmsg</span> <span class="mi">0</span> <span class="n">len</span><span class="o">,</span>
            <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">gethostbyaddr</span> <span class="n">addr</span><span class="o">).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">h_name</span><span class="o">,</span>
            <span class="n">sockaddr</span>
        <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">assert</span> <span class="bp">false</span> <span class="k">in</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Client %s said ``%s&#39;&#39;</span><span class="se">\n</span><span class="s2">%!&quot;</span> <span class="n">hishost</span> <span class="n">newmsg</span><span class="o">;</span>
    <span class="n">ignore</span>
      <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">sendto</span> <span class="n">sock</span> <span class="o">!</span><span class="n">oldmsg</span> <span class="mi">0</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="o">!</span><span class="n">oldmsg</span><span class="o">)</span> <span class="bp">[]</span> <span class="n">sockaddr</span><span class="o">);</span>
    <span class="n">oldmsg</span> <span class="o">:=</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;[%s] %s&quot;</span> <span class="n">hishost</span> <span class="n">newmsg</span>
  <span class="k">done</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* udpmsg - send a message to the udpqotd server *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">maxlen</span>  <span class="o">=</span> <span class="mi">1024</span>
<span class="k">let</span> <span class="n">portno</span>  <span class="o">=</span> <span class="mi">5151</span>
<span class="k">let</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">5</span>

<span class="k">let</span> <span class="n">server_host</span><span class="o">,</span> <span class="n">msg</span> <span class="o">=</span>
  <span class="k">match</span> <span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="k">with</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">::</span> <span class="n">head</span> <span class="o">::</span> <span class="n">tail</span> <span class="o">-&gt;</span> <span class="n">head</span><span class="o">,</span> <span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot; &quot;</span> <span class="n">tail</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Usage: %s server_host msg ...</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">);</span>
        <span class="n">exit</span> <span class="mi">1</span>

<span class="k">let</span> <span class="n">sock</span> <span class="o">=</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">socket</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">PF_INET</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">SOCK_DGRAM</span>
    <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">getprotobyname</span> <span class="s2">&quot;udp&quot;</span><span class="o">).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">p_proto</span>

<span class="k">let</span> <span class="n">sockaddr</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">addr</span> <span class="o">=</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">gethostbyname</span> <span class="n">server_host</span><span class="o">).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">h_addr_list</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span> <span class="k">in</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="nc">ADDR_INET</span> <span class="o">(</span><span class="n">addr</span><span class="o">,</span> <span class="n">portno</span><span class="o">)</span>

<span class="k">let</span> <span class="n">handle_alarm</span> <span class="n">signal</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;recv from %s timed out after %d seconds.</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">server_host</span> <span class="n">timeout</span><span class="o">;</span>
  <span class="n">exit</span> <span class="mi">1</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">sendto</span> <span class="n">sock</span> <span class="n">msg</span> <span class="mi">0</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">msg</span><span class="o">)</span> <span class="bp">[]</span> <span class="n">sockaddr</span><span class="o">);</span>
  <span class="nn">Sys</span><span class="p">.</span><span class="n">set_signal</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigalrm</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="nc">Signal_handle</span> <span class="n">handle_alarm</span><span class="o">);</span>
  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">alarm</span> <span class="n">timeout</span><span class="o">);</span>
  <span class="k">let</span> <span class="n">msg</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">create</span> <span class="n">maxlen</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">msg</span><span class="o">,</span> <span class="n">hishost</span> <span class="o">=</span>
    <span class="k">match</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">recvfrom</span> <span class="n">sock</span> <span class="n">msg</span> <span class="mi">0</span> <span class="n">maxlen</span> <span class="bp">[]</span> <span class="k">with</span>
      <span class="o">|</span> <span class="n">len</span><span class="o">,</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">ADDR_INET</span> <span class="o">(</span><span class="n">addr</span><span class="o">,</span> <span class="n">port</span><span class="o">)</span> <span class="o">-&gt;</span>
          <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">msg</span> <span class="mi">0</span> <span class="n">len</span><span class="o">,</span>
          <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">gethostbyaddr</span> <span class="n">addr</span><span class="o">).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">h_name</span>
      <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">assert</span> <span class="bp">false</span> <span class="k">in</span>
  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">alarm</span> <span class="mi">0</span><span class="o">);</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Server %s responded ``%s&#39;&#39;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">hishost</span> <span class="n">msg</span>

<span class="c">(* @@PLEAC@@_17.6 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="c">(* Create a Unix domain socket server - you can also use SOCK_STREAM. *)</span>
<span class="k">let</span> <span class="n">server</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">socket</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">PF_UNIX</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">SOCK_DGRAM</span> <span class="mi">0</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="k">try</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">unlink</span> <span class="s2">&quot;/tmp/mysock&quot;</span> <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">bind</span> <span class="n">server</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">ADDR_UNIX</span> <span class="s2">&quot;/tmp/mysock&quot;</span><span class="o">)</span>

<span class="c">(* Create a Unix domain socket client - you can also use SOCK_STREAM. *)</span>
<span class="k">let</span> <span class="n">client</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">socket</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">PF_UNIX</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">SOCK_DGRAM</span> <span class="mi">0</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">connect</span> <span class="n">client</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">ADDR_UNIX</span> <span class="s2">&quot;/tmp/mysock&quot;</span><span class="o">)</span>

<span class="c">(* @@PLEAC@@_17.7 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="c">(* Get the remote IP address. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">other_end</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">getpeername</span> <span class="n">socket</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">name_info</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">getnameinfo</span> <span class="n">other_end</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">NI_NUMERICHOST</span><span class="o">]</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">ip_address</span> <span class="o">=</span> <span class="n">name_info</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">ni_hostname</span> <span class="k">in</span>
  <span class="c">(* ... *)</span>
  <span class="bp">()</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Attempt to determine the remote host name, with forward and reverse</span>
<span class="c">   DNS lookups to detect spoofing. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">other_end</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">getpeername</span> <span class="n">socket</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">name_info</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">getnameinfo</span> <span class="n">other_end</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">NI_NUMERICHOST</span><span class="o">]</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">actual_ip</span> <span class="o">=</span> <span class="n">name_info</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">ni_hostname</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">claimed_hostname</span> <span class="o">=</span>
    <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">gethostbyaddr</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">inet_addr_of_string</span> <span class="n">actual_ip</span><span class="o">))</span>
      <span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">h_name</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">name_lookup</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">gethostbyname</span> <span class="n">claimed_hostname</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">resolved_ips</span> <span class="o">=</span>
    <span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">map</span>
                     <span class="nn">Unix</span><span class="p">.</span><span class="n">string_of_inet_addr</span>
                     <span class="n">name_lookup</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">h_addr_list</span><span class="o">)</span> <span class="k">in</span>
  <span class="c">(* ... *)</span>
  <span class="bp">()</span>

<span class="c">(* @@PLEAC@@_17.8 *)</span>
<span class="c">(*-----------------------------*)</span>

<span class="c">(*</span>
<span class="c">** Finding Your Own Name and Address.</span>
<span class="c">** The Unix module to the rescue again.</span>
<span class="c">*)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span> <span class="o">;;</span>
<span class="k">open</span> <span class="nc">Unix</span> <span class="o">;;</span>

<span class="k">let</span> <span class="n">hostname</span> <span class="o">=</span> <span class="n">gethostname</span> <span class="bp">()</span> <span class="k">in</span>
<span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;hostname : %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">hostname</span> <span class="o">;;</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(*</span>
<span class="c">** Unfortunately there is no easy way of retreiving the</span>
<span class="c">** uname without using Unix.open_process_in.</span>
<span class="c">*)</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">hentry</span> <span class="o">=</span> <span class="n">gethostbyname</span> <span class="n">hostname</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">address</span> <span class="o">=</span> <span class="n">hentry</span><span class="o">.</span><span class="n">h_addr_list</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span> <span class="k">in</span>
<span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;address : %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="n">string_of_inet_addr</span> <span class="n">address</span><span class="o">)</span> <span class="o">;;</span>

<span class="k">let</span> <span class="n">hentry</span> <span class="o">=</span> <span class="n">gethostbyaddr</span> <span class="n">address</span> <span class="k">in</span>
<span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;hostname : %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">hentry</span><span class="o">.</span><span class="n">h_name</span> <span class="o">;;</span>


<span class="c">(* @@PLEAC@@_17.9 *)</span>

<span class="c">(* Closing a Socket After Forking *)</span>

<span class="c">(*-----------------------------*)</span>
<span class="n">shutdown</span> <span class="n">sock</span> <span class="nc">SHUTDOWN_RECEIVE</span> <span class="o">;</span>    <span class="c">(* I/we have stopped reading data *)</span>
<span class="n">shutdown</span> <span class="n">sock</span> <span class="nc">SHUTDOWN_SEND</span> <span class="o">;</span>       <span class="c">(* I/we have stopped writing data *)</span>
<span class="n">shutdown</span> <span class="n">sock</span> <span class="nc">SHUTDOWN_ALL</span> <span class="o">;;</span>       <span class="c">(* I/we have stopped using this socket *)</span>

<span class="c">(*-----------------------------*)</span>
<span class="c">(* Using the sock_send and sock_recv functions from above. *)</span>

<span class="n">sock_send</span> <span class="n">sock</span> <span class="s2">&quot;my request</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">;</span>    <span class="c">(* send some data *)</span>
<span class="n">shutdown</span> <span class="n">sock</span> <span class="nc">SHUTDOWN_SEND</span> <span class="o">;</span>      <span class="c">(* send eof; no more writing *)</span>
<span class="k">let</span> <span class="n">answer</span> <span class="o">=</span> <span class="n">sock_recv</span> <span class="n">sock</span> <span class="mi">4096</span> <span class="o">;;</span> <span class="c">(* but you can still read *)</span>

<span class="c">(* @@PLEAC@@_17.10 *)</span>
<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* biclient - bidirectional forking client *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">host</span><span class="o">,</span> <span class="n">port</span> <span class="o">=</span>
  <span class="k">match</span> <span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="k">with</span>
    <span class="o">|</span> <span class="o">[_;</span> <span class="n">host</span><span class="o">;</span> <span class="n">port</span><span class="o">]</span> <span class="o">-&gt;</span> <span class="n">host</span><span class="o">,</span> <span class="n">int_of_string</span> <span class="n">port</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;usage: %s host port</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">);</span> <span class="n">exit</span> <span class="mi">1</span>

<span class="k">let</span> <span class="n">sockaddr</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">addr</span> <span class="o">=</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">gethostbyname</span> <span class="n">host</span><span class="o">).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">h_addr_list</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span> <span class="k">in</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="nc">ADDR_INET</span> <span class="o">(</span><span class="n">addr</span><span class="o">,</span> <span class="n">port</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">socket</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">socket</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">PF_INET</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">SOCK_STREAM</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">connect</span> <span class="n">socket</span> <span class="n">sockaddr</span><span class="o">;</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;[Connected to %s:%d]</span><span class="se">\n</span><span class="s2">%!&quot;</span> <span class="n">host</span> <span class="n">port</span><span class="o">;</span>

  <span class="c">(* split the program into two processes, identical twins *)</span>
  <span class="k">match</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">fork</span> <span class="bp">()</span> <span class="k">with</span>
    <span class="o">|</span> <span class="mi">0</span> <span class="o">-&gt;</span>
        <span class="c">(* child copies standard input to the socket *)</span>
        <span class="k">let</span> <span class="n">output</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">out_channel_of_descr</span> <span class="n">socket</span> <span class="k">in</span>
        <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
          <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">stdin</span> <span class="k">in</span>
          <span class="n">output_string</span> <span class="n">output</span> <span class="n">line</span><span class="o">;</span>
          <span class="n">output_string</span> <span class="n">output</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
          <span class="n">flush</span> <span class="n">output</span>
        <span class="k">done</span>
    <span class="o">|</span> <span class="n">kidpid</span> <span class="o">-&gt;</span>
        <span class="c">(* parent copies the socket to standard output *)</span>
        <span class="k">let</span> <span class="n">input</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">in_channel_of_descr</span> <span class="n">socket</span> <span class="k">in</span>
        <span class="k">try</span>
          <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
            <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">input</span> <span class="k">in</span>
            <span class="n">output_string</span> <span class="n">stdout</span> <span class="n">line</span><span class="o">;</span>
            <span class="n">output_string</span> <span class="n">stdout</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
            <span class="n">flush</span> <span class="n">stdout</span>
          <span class="k">done</span>
        <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
          <span class="nn">Unix</span><span class="p">.</span><span class="n">kill</span> <span class="n">kidpid</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigterm</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">exit</span> <span class="mi">0</span>

<span class="c">(* @@PLEAC@@_17.11 *)</span>
<span class="c">(* set up the socket SERVER, bind and listen ... *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="k">rec</span> <span class="n">reaper</span> <span class="n">signal</span> <span class="o">=</span>
  <span class="k">try</span> <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span> <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">waitpid</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">WNOHANG</span><span class="o">]</span> <span class="o">(-</span><span class="mi">1</span><span class="o">))</span> <span class="k">done</span>
  <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">ECHILD</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">;</span>
  <span class="nn">Sys</span><span class="p">.</span><span class="n">set_signal</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigchld</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="nc">Signal_handle</span> <span class="n">reaper</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Sys</span><span class="p">.</span><span class="n">set_signal</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigchld</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="nc">Signal_handle</span> <span class="n">reaper</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
    <span class="k">try</span>
      <span class="k">let</span> <span class="o">(</span><span class="n">client</span><span class="o">,</span> <span class="n">addr</span><span class="o">)</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">accept</span> <span class="n">server</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">pid</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">fork</span> <span class="bp">()</span> <span class="k">in</span>
      <span class="k">if</span> <span class="n">pid</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">then</span>                   <span class="c">(* parent *)</span>
        <span class="k">begin</span>
          <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="n">server</span><span class="o">;</span>            <span class="c">(* no use to child *)</span>
          <span class="c">(* ... do something *)</span>
          <span class="n">exit</span> <span class="mi">0</span>                        <span class="c">(* child leaves *)</span>
        <span class="k">end</span>
      <span class="k">else</span>
        <span class="k">begin</span>
          <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="n">client</span>             <span class="c">(* no use to parent *)</span>
        <span class="k">end</span>
    <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">EINTR</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="o">-&gt;</span> <span class="bp">()</span>
  <span class="k">done</span>

<span class="c">(* @@PLEAC@@_17.12 *)</span>
<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* preforker - server who forks first *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="c">(* global variables *)</span>
<span class="k">let</span> <span class="n">prefork</span> <span class="o">=</span> <span class="mi">5</span>
<span class="k">let</span> <span class="n">max_clients_per_child</span> <span class="o">=</span> <span class="mi">5</span>
<span class="k">module</span> <span class="nc">PidSet</span> <span class="o">=</span> <span class="nn">Set</span><span class="p">.</span><span class="nc">Make</span><span class="o">(</span><span class="k">struct</span> <span class="k">type</span> <span class="n">t</span> <span class="o">=</span> <span class="kt">int</span> <span class="k">let</span> <span class="n">compare</span> <span class="o">=</span> <span class="n">compare</span> <span class="k">end</span><span class="o">)</span>
<span class="k">let</span> <span class="n">children</span> <span class="o">=</span> <span class="n">ref</span> <span class="nn">PidSet</span><span class="p">.</span><span class="n">empty</span>

<span class="c">(* takes care of dead children *)</span>
<span class="k">let</span> <span class="k">rec</span> <span class="n">reaper</span> <span class="o">_</span> <span class="o">=</span>
  <span class="nn">Sys</span><span class="p">.</span><span class="n">set_signal</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigchld</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="nc">Signal_handle</span> <span class="n">reaper</span><span class="o">);</span>
  <span class="k">match</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">wait</span> <span class="bp">()</span>
  <span class="k">with</span> <span class="o">(</span><span class="n">pid</span><span class="o">,</span> <span class="o">_)</span> <span class="o">-&gt;</span> <span class="n">children</span> <span class="o">:=</span> <span class="nn">PidSet</span><span class="p">.</span><span class="n">remove</span> <span class="n">pid</span> <span class="o">!</span><span class="n">children</span>

<span class="c">(* signal handler for SIGINT *)</span>
<span class="k">let</span> <span class="k">rec</span> <span class="n">huntsman</span> <span class="o">_</span> <span class="o">=</span>
  <span class="c">(* we&#39;re going to kill our children *)</span>
  <span class="nn">Sys</span><span class="p">.</span><span class="n">set_signal</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigchld</span> <span class="nn">Sys</span><span class="p">.</span><span class="nc">Signal_ignore</span><span class="o">;</span>
  <span class="nn">PidSet</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">pid</span> <span class="o">-&gt;</span>
       <span class="k">try</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">kill</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigint</span> <span class="n">pid</span> <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">)</span>
    <span class="o">!</span><span class="n">children</span><span class="o">;</span>
  <span class="c">(* clean up with dignity *)</span>
  <span class="n">exit</span> <span class="mi">0</span>

<span class="k">let</span> <span class="n">make_new_child</span> <span class="n">server</span> <span class="o">=</span>
  <span class="c">(* block signal for fork *)</span>
  <span class="k">let</span> <span class="n">sigset</span> <span class="o">=</span> <span class="o">[</span><span class="nn">Sys</span><span class="p">.</span><span class="n">sigint</span><span class="o">]</span> <span class="k">in</span>
  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">sigprocmask</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">SIG_BLOCK</span> <span class="n">sigset</span><span class="o">);</span>

  <span class="k">match</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">fork</span> <span class="bp">()</span> <span class="k">with</span>
    <span class="o">|</span> <span class="mi">0</span> <span class="o">-&gt;</span>
        <span class="c">(* Child can *not* return from this subroutine. *)</span>
        <span class="c">(* make SIGINT kill us as it did before *)</span>
        <span class="nn">Sys</span><span class="p">.</span><span class="n">set_signal</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigint</span> <span class="nn">Sys</span><span class="p">.</span><span class="nc">Signal_default</span><span class="o">;</span>

        <span class="c">(* unblock signals *)</span>
        <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">sigprocmask</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">SIG_UNBLOCK</span> <span class="n">sigset</span><span class="o">);</span>

        <span class="c">(* handle connections until we&#39;ve reached max_clients_per_child *)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">to</span> <span class="n">max_clients_per_child</span> <span class="k">do</span>
          <span class="k">let</span> <span class="o">(</span><span class="n">client</span><span class="o">,</span> <span class="o">_)</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">accept</span> <span class="n">server</span> <span class="k">in</span>
          <span class="c">(* do something with the connection *)</span>
          <span class="bp">()</span>
        <span class="k">done</span><span class="o">;</span>

        <span class="c">(* tidy up gracefully and finish *)</span>

        <span class="c">(* this exit is VERY important, otherwise the child will become</span>
<span class="c">           a producer of more and more children, forking yourself into</span>
<span class="c">           process death. *)</span>
        <span class="n">exit</span> <span class="mi">0</span>
    <span class="o">|</span> <span class="n">pid</span> <span class="o">-&gt;</span>
        <span class="c">(* Parent records the child&#39;s birth and returns. *)</span>
        <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">sigprocmask</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">SIG_UNBLOCK</span> <span class="n">sigset</span><span class="o">);</span>
        <span class="n">children</span> <span class="o">:=</span> <span class="nn">PidSet</span><span class="p">.</span><span class="n">add</span> <span class="n">pid</span> <span class="o">!</span><span class="n">children</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* establish SERVER socket, bind and listen. *)</span>
  <span class="k">let</span> <span class="n">server</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">socket</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">PF_INET</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">SOCK_STREAM</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">setsockopt</span> <span class="n">server</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">SO_REUSEADDR</span> <span class="bp">true</span><span class="o">;</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">bind</span> <span class="n">server</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">ADDR_INET</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">inet_addr_any</span><span class="o">,</span> <span class="mi">6969</span><span class="o">));</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">listen</span> <span class="n">server</span> <span class="mi">10</span><span class="o">;</span>

  <span class="c">(* Fork off our children. *)</span>
  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">to</span> <span class="n">prefork</span> <span class="k">do</span>
    <span class="n">make_new_child</span> <span class="n">server</span>
  <span class="k">done</span><span class="o">;</span>

  <span class="c">(* Install signal handlers. *)</span>
  <span class="nn">Sys</span><span class="p">.</span><span class="n">set_signal</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigchld</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="nc">Signal_handle</span> <span class="n">reaper</span><span class="o">);</span>
  <span class="nn">Sys</span><span class="p">.</span><span class="n">set_signal</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigint</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="nc">Signal_handle</span> <span class="n">huntsman</span><span class="o">);</span>

  <span class="c">(* And maintain the population. *)</span>
  <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
    <span class="c">(* wait for a signal (i.e., child&#39;s death) *)</span>
    <span class="nn">Unix</span><span class="p">.</span><span class="n">pause</span> <span class="bp">()</span><span class="o">;</span>
    <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="o">(</span><span class="nn">PidSet</span><span class="p">.</span><span class="n">cardinal</span> <span class="o">!</span><span class="n">children</span><span class="o">)</span> <span class="k">to</span> <span class="o">(</span><span class="n">prefork</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)</span> <span class="k">do</span>
      <span class="c">(* top up the child pool *)</span>
      <span class="n">make_new_child</span> <span class="n">server</span>
    <span class="k">done</span>
  <span class="k">done</span>

<span class="c">(* @@PLEAC@@_17.13 *)</span>
<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* nonforker - server who multiplexes without forking *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">1685</span>                         <span class="c">(* change this at will *)</span>

<span class="c">(* Listen to port. *)</span>
<span class="k">let</span> <span class="n">server</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">socket</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">PF_INET</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">SOCK_STREAM</span> <span class="mi">0</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">setsockopt</span> <span class="n">server</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">SO_REUSEADDR</span> <span class="bp">true</span><span class="o">;</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">bind</span> <span class="n">server</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">ADDR_INET</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">inet_addr_any</span><span class="o">,</span> <span class="n">port</span><span class="o">));</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">listen</span> <span class="n">server</span> <span class="mi">10</span><span class="o">;</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">set_nonblock</span> <span class="n">server</span>

<span class="k">module</span> <span class="nc">FDSet</span> <span class="o">=</span>
  <span class="nn">Set</span><span class="p">.</span><span class="nc">Make</span><span class="o">(</span><span class="k">struct</span> <span class="k">type</span> <span class="n">t</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">file_descr</span> <span class="k">let</span> <span class="n">compare</span> <span class="o">=</span> <span class="n">compare</span> <span class="k">end</span><span class="o">)</span>
<span class="k">let</span> <span class="n">clients</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="nn">FDSet</span><span class="p">.</span><span class="n">singleton</span> <span class="n">server</span><span class="o">)</span>

<span class="c">(* begin with empty buffers *)</span>
<span class="k">let</span> <span class="n">inbuffer</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span>
<span class="k">let</span> <span class="n">outbuffer</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span>
<span class="k">let</span> <span class="n">ready</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span>

<span class="k">let</span> <span class="n">buffer_size</span> <span class="o">=</span> <span class="mi">8192</span>
<span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="n">buffer_size</span> <span class="sc">&#39;\000&#39;</span>

<span class="c">(* handle deals with all pending requests for client *)</span>
<span class="k">let</span> <span class="n">handle</span> <span class="n">client</span> <span class="n">requests</span> <span class="o">=</span>
  <span class="c">(* requests are in ready[client] *)</span>
  <span class="c">(* send output to outbuffer[client] *)</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">request</span> <span class="o">-&gt;</span>
       <span class="c">(* request is the text of the request *)</span>
       <span class="k">let</span> <span class="n">data</span> <span class="o">=</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;You said: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">request</span> <span class="k">in</span>
       <span class="c">(* put text of reply into outbuffer[client] *)</span>
       <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">outbuffer</span> <span class="n">client</span>
         <span class="o">(</span><span class="k">try</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">outbuffer</span> <span class="n">client</span> <span class="o">^</span> <span class="n">data</span>
          <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="n">data</span><span class="o">))</span>
    <span class="n">requests</span>

<span class="c">(* Main loop: check reads/accepts, check writes, check ready to process *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
    <span class="c">(* check for new information on the connections we have *)</span>

    <span class="k">let</span> <span class="o">(</span><span class="n">can_read</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="o">=</span>
      <span class="nn">Unix</span><span class="p">.</span><span class="n">select</span> <span class="o">(</span><span class="nn">FDSet</span><span class="p">.</span><span class="n">elements</span> <span class="o">!</span><span class="n">clients</span><span class="o">)</span> <span class="bp">[]</span> <span class="bp">[]</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span> <span class="k">in</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
      <span class="o">(</span><span class="k">fun</span> <span class="n">client</span> <span class="o">-&gt;</span>
         <span class="k">if</span> <span class="n">client</span> <span class="o">=</span> <span class="n">server</span>
         <span class="k">then</span>
           <span class="k">begin</span>
             <span class="c">(* accept a new connection *)</span>
             <span class="k">let</span> <span class="o">(</span><span class="n">client</span><span class="o">,</span> <span class="n">addr</span><span class="o">)</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">accept</span> <span class="n">server</span> <span class="k">in</span>
             <span class="n">clients</span> <span class="o">:=</span> <span class="nn">FDSet</span><span class="p">.</span><span class="n">add</span> <span class="n">client</span> <span class="o">!</span><span class="n">clients</span><span class="o">;</span>
             <span class="nn">Unix</span><span class="p">.</span><span class="n">set_nonblock</span> <span class="n">client</span>
           <span class="k">end</span>
         <span class="k">else</span>
           <span class="k">begin</span>
             <span class="c">(* read data *)</span>
             <span class="k">let</span> <span class="n">chars_read</span> <span class="o">=</span>
               <span class="k">try</span>
                 <span class="nc">Some</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">read</span> <span class="n">client</span> <span class="n">buffer</span> <span class="mi">0</span> <span class="n">buffer_size</span><span class="o">)</span>
               <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="n">error</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
                 <span class="n">prerr_endline</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">error_message</span> <span class="n">error</span><span class="o">);</span>
                 <span class="nc">None</span> <span class="k">in</span>

             <span class="k">match</span> <span class="n">chars_read</span> <span class="k">with</span>
               <span class="o">|</span> <span class="nc">None</span> <span class="o">|</span> <span class="nc">Some</span> <span class="mi">0</span> <span class="o">-&gt;</span>
                   <span class="c">(* This would be the end of file, so close the client *)</span>
                   <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">remove</span> <span class="n">inbuffer</span> <span class="n">client</span><span class="o">;</span>
                   <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">remove</span> <span class="n">outbuffer</span> <span class="n">client</span><span class="o">;</span>
                   <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">remove</span> <span class="n">ready</span> <span class="n">client</span><span class="o">;</span>

                   <span class="n">clients</span> <span class="o">:=</span> <span class="nn">FDSet</span><span class="p">.</span><span class="n">remove</span> <span class="n">client</span> <span class="o">!</span><span class="n">clients</span><span class="o">;</span>
                   <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="n">client</span>

               <span class="o">|</span> <span class="nc">Some</span> <span class="n">chars_read</span> <span class="o">-&gt;</span>
                   <span class="k">let</span> <span class="n">data</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">buffer</span> <span class="mi">0</span> <span class="n">chars_read</span> <span class="k">in</span>
                   <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">inbuffer</span> <span class="n">client</span>
                     <span class="o">(</span><span class="k">try</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">inbuffer</span> <span class="n">client</span> <span class="o">^</span> <span class="n">data</span>
                      <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="n">data</span><span class="o">);</span>

                   <span class="c">(* test whether the data in the buffer or the data we *)</span>
                   <span class="c">(* just read means there is a complete request waiting *)</span>
                   <span class="c">(* to be fulfilled.  If there is, set ready[client] *)</span>
                   <span class="c">(* to the requests waiting to be fulfilled. *)</span>
                   <span class="k">try</span>
                     <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
                       <span class="k">let</span> <span class="n">data</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">inbuffer</span> <span class="n">client</span> <span class="k">in</span>
                       <span class="k">let</span> <span class="n">index</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">index</span> <span class="n">data</span> <span class="sc">&#39;\n&#39;</span> <span class="k">in</span>
                       <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">inbuffer</span> <span class="n">client</span>
                         <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">data</span>
                            <span class="o">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span>
                            <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">data</span> <span class="o">-</span> <span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="o">));</span>
                       <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">ready</span> <span class="n">client</span>
                         <span class="o">((</span><span class="k">try</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">ready</span> <span class="n">client</span>
                           <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">[]</span><span class="o">)</span>
                          <span class="o">@</span> <span class="o">[</span><span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">data</span> <span class="mi">0</span> <span class="n">index</span><span class="o">])</span>
                     <span class="k">done</span>
                   <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">()</span>
           <span class="k">end</span><span class="o">)</span>
      <span class="n">can_read</span><span class="o">;</span>

    <span class="c">(* Any complete requests to process? *)</span>
    <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span> <span class="n">handle</span> <span class="n">ready</span><span class="o">;</span>
    <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">clear</span> <span class="n">ready</span><span class="o">;</span>

    <span class="c">(* Buffers to flush? *)</span>
    <span class="k">let</span> <span class="o">(_,</span> <span class="n">can_write</span><span class="o">,</span> <span class="o">_)</span> <span class="o">=</span>
      <span class="nn">Unix</span><span class="p">.</span><span class="n">select</span> <span class="bp">[]</span> <span class="o">(</span><span class="nn">FDSet</span><span class="p">.</span><span class="n">elements</span> <span class="o">!</span><span class="n">clients</span><span class="o">)</span> <span class="bp">[]</span> <span class="mi">1</span><span class="o">.</span><span class="mi">0</span> <span class="k">in</span>
    <span class="c">(* Skip client if we have nothing to say *)</span>
    <span class="k">let</span> <span class="n">can_write</span> <span class="o">=</span>
      <span class="nn">List</span><span class="p">.</span><span class="n">filter</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">mem</span> <span class="n">outbuffer</span><span class="o">)</span> <span class="n">can_write</span> <span class="k">in</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
      <span class="o">(</span><span class="k">fun</span> <span class="n">client</span> <span class="o">-&gt;</span>
         <span class="k">let</span> <span class="n">data</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">outbuffer</span> <span class="n">client</span> <span class="k">in</span>
         <span class="k">let</span> <span class="n">chars_written</span> <span class="o">=</span>
           <span class="k">try</span>
             <span class="nc">Some</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">single_write</span> <span class="n">client</span> <span class="n">data</span> <span class="mi">0</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">data</span><span class="o">))</span>
           <span class="k">with</span>
             <span class="o">|</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">EAGAIN</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span>
             <span class="o">|</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">EWOULDBLOCK</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
                 <span class="n">prerr_endline</span> <span class="s2">&quot;I was told I could write, but I can&#39;t.&quot;</span><span class="o">;</span>
                 <span class="nc">Some</span> <span class="mi">0</span>
             <span class="o">|</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="n">error</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
                 <span class="n">prerr_endline</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">error_message</span> <span class="n">error</span><span class="o">);</span>
                 <span class="nc">None</span> <span class="k">in</span>

         <span class="k">match</span> <span class="n">chars_written</span> <span class="k">with</span>
           <span class="o">|</span> <span class="nc">Some</span> <span class="n">chars_written</span> <span class="o">-&gt;</span>
               <span class="k">if</span> <span class="n">chars_written</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">data</span>
               <span class="k">then</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">remove</span> <span class="n">outbuffer</span> <span class="n">client</span>
               <span class="k">else</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">outbuffer</span> <span class="n">client</span>
                 <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">data</span> <span class="n">chars_written</span>
                    <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">data</span> <span class="o">-</span> <span class="n">chars_written</span><span class="o">))</span>
           <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span>
               <span class="c">(* Couldn&#39;t write all the data, and it wasn&#39;t because *)</span>
               <span class="c">(* it would have blocked.  Shutdown and move on. *)</span>
               <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">remove</span> <span class="n">inbuffer</span> <span class="n">client</span><span class="o">;</span>
               <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">remove</span> <span class="n">outbuffer</span> <span class="n">client</span><span class="o">;</span>
               <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">remove</span> <span class="n">ready</span> <span class="n">client</span><span class="o">;</span>

               <span class="n">clients</span> <span class="o">:=</span> <span class="nn">FDSet</span><span class="p">.</span><span class="n">remove</span> <span class="n">client</span> <span class="o">!</span><span class="n">clients</span><span class="o">;</span>
               <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="n">client</span><span class="o">)</span>
      <span class="n">can_write</span><span class="o">;</span>

    <span class="k">let</span> <span class="o">(_,</span> <span class="o">_,</span> <span class="n">has_exception</span><span class="o">)</span> <span class="o">=</span>
      <span class="nn">Unix</span><span class="p">.</span><span class="n">select</span> <span class="bp">[]</span> <span class="bp">[]</span> <span class="o">(</span><span class="nn">FDSet</span><span class="p">.</span><span class="n">elements</span> <span class="o">!</span><span class="n">clients</span><span class="o">)</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span> <span class="k">in</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
      <span class="o">(</span><span class="k">fun</span> <span class="n">client</span> <span class="o">-&gt;</span>
         <span class="c">(* Deal with out-of-band data here, if you want to. *)</span>
         <span class="bp">()</span><span class="o">)</span>
      <span class="n">has_exception</span><span class="o">;</span>
  <span class="k">done</span>

<span class="c">(* @@PLEAC@@_17.14 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">server</span> <span class="o">=</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">socket</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">PF_INET</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">SOCK_STREAM</span>
    <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">getprotobyname</span> <span class="s2">&quot;tcp&quot;</span><span class="o">).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">p_proto</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">setsockopt</span> <span class="n">server</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">SO_REUSEADDR</span> <span class="bp">true</span><span class="o">;</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">bind</span> <span class="n">server</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">ADDR_INET</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">inet_addr_any</span><span class="o">,</span> <span class="n">server_port</span><span class="o">));</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">listen</span> <span class="n">server</span> <span class="mi">10</span><span class="o">;</span>

  <span class="c">(* accept loop *)</span>
  <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">client</span><span class="o">,</span> <span class="n">sockaddr</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">accept</span> <span class="n">server</span> <span class="k">in</span>
    <span class="k">match</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">getsockname</span> <span class="n">client</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">ADDR_INET</span> <span class="o">(</span><span class="n">addr</span><span class="o">,</span> <span class="n">port</span><span class="o">)</span> <span class="o">-&gt;</span>
          <span class="n">print_endline</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">string_of_inet_addr</span> <span class="n">addr</span><span class="o">)</span>
      <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">assert</span> <span class="bp">false</span>
  <span class="k">done</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">4269</span>                 <span class="c">(* port to bind to *)</span>
<span class="k">let</span> <span class="n">host</span> <span class="o">=</span> <span class="s2">&quot;specific.host.com&quot;</span>  <span class="c">(* virtual host to listen on *)</span>

<span class="k">let</span> <span class="n">server</span> <span class="o">=</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">socket</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">PF_INET</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">SOCK_STREAM</span>
    <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">getprotobyname</span> <span class="s2">&quot;tcp&quot;</span><span class="o">).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">p_proto</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">addr</span> <span class="o">=</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">gethostbyname</span> <span class="n">host</span><span class="o">).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">h_addr_list</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span> <span class="k">in</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">bind</span> <span class="n">server</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">ADDR_INET</span> <span class="o">(</span><span class="n">addr</span><span class="o">,</span> <span class="n">port</span><span class="o">));</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">listen</span> <span class="n">server</span> <span class="mi">10</span><span class="o">;</span>
  <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">client</span><span class="o">,</span> <span class="n">sockaddr</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">accept</span> <span class="n">server</span> <span class="k">in</span>
    <span class="c">(* ... *)</span>
    <span class="bp">()</span>
  <span class="k">done</span>

<span class="c">(* @@PLEAC@@_17.15 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* for the paranoid *)</span>
  <span class="c">(* Unix.handle_unix_error Unix.chroot &quot;/var/daemon&quot;; *)</span>

  <span class="c">(* fork and let parent exit *)</span>
  <span class="k">let</span> <span class="n">pid</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">fork</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="k">if</span> <span class="n">pid</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="n">exit</span> <span class="mi">0</span><span class="o">;</span>

  <span class="c">(* create a new session and abandon the controlling process *)</span>
  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">setsid</span> <span class="bp">()</span><span class="o">)</span>

<span class="c">(* flag indicating it is time to exit *)</span>
<span class="k">let</span> <span class="n">time_to_die</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span>

<span class="c">(* trap fatal signals *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">signal_handler</span> <span class="o">_</span> <span class="o">=</span> <span class="n">time_to_die</span> <span class="o">:=</span> <span class="bp">true</span> <span class="k">in</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">signal</span> <span class="o">-&gt;</span>
       <span class="nn">Sys</span><span class="p">.</span><span class="n">set_signal</span> <span class="n">signal</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="nc">Signal_handle</span> <span class="n">signal_handler</span><span class="o">))</span>
    <span class="o">[</span><span class="nn">Sys</span><span class="p">.</span><span class="n">sigint</span><span class="o">;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigterm</span><span class="o">;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sighup</span><span class="o">]</span>
  <span class="c">(* trap or ignore Sys.sigpipe *)</span>

<span class="c">(* server loop *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">while</span> <span class="n">not</span> <span class="o">!</span><span class="n">time_to_die</span> <span class="k">do</span>
    <span class="c">(* ... *)</span>
    <span class="bp">()</span>
  <span class="k">done</span>

<span class="c">(* @@PLEAC@@_17.16 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">self</span> <span class="o">=</span> <span class="s2">&quot;/usr/bin/ocaml&quot;</span>
<span class="k">let</span> <span class="n">args</span> <span class="o">=</span> <span class="n">self</span> <span class="o">::</span> <span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span>

<span class="k">let</span> <span class="n">phoenix</span> <span class="o">_</span> <span class="o">=</span>
  <span class="c">(* close all your connections, kill your children, and *)</span>
  <span class="c">(* generally prepare to be reincarnated with dignity. *)</span>
  <span class="k">try</span>
    <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">sigprocmask</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">SIG_UNBLOCK</span> <span class="o">[</span><span class="nn">Sys</span><span class="p">.</span><span class="n">sighup</span><span class="o">]);</span>
    <span class="nn">Unix</span><span class="p">.</span><span class="n">execv</span> <span class="n">self</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">of_list</span> <span class="n">args</span><span class="o">)</span>
  <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Couldn&#39;t restart: %s</span><span class="se">\n</span><span class="s2">%!&quot;</span>
      <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">error_message</span> <span class="n">e</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Sys</span><span class="p">.</span><span class="n">set_signal</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sighup</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="nc">Signal_handle</span> <span class="n">phoenix</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* This recipe uses the Ocaml-Syck YAML parser available at:</span>
<span class="c">   http://ocaml-syck.sourceforge.net/ *)</span>

<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+yaml&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;yaml.cma&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">yaml_parser</span> <span class="o">=</span> <span class="nn">YamlParser</span><span class="p">.</span><span class="n">make</span> <span class="bp">()</span>

<span class="k">let</span> <span class="n">config_file</span> <span class="o">=</span> <span class="s2">&quot;/usr/local/etc/myprog/server_conf.yaml&quot;</span>
<span class="k">let</span> <span class="n">config</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="nn">YamlNode</span><span class="p">.</span><span class="nc">SCALAR</span> <span class="o">(</span><span class="s2">&quot;&quot;</span><span class="o">,</span> <span class="s2">&quot;&quot;</span><span class="o">))</span>

<span class="k">let</span> <span class="n">read_config</span> <span class="o">_</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span> <span class="n">open_in</span> <span class="n">config_file</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">in_channel</span> <span class="k">in</span>
      <span class="n">lines</span> <span class="o">:=</span> <span class="n">line</span> <span class="o">::</span> <span class="o">!</span><span class="n">lines</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
    <span class="n">close_in</span> <span class="n">in_channel</span><span class="o">;</span>
    <span class="n">config</span> <span class="o">:=</span>
      <span class="nn">YamlParser</span><span class="p">.</span><span class="n">parse_string</span> <span class="n">yaml_parser</span>
        <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="o">!</span><span class="n">lines</span><span class="o">))</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">read_config</span> <span class="bp">()</span><span class="o">;</span>
  <span class="nn">Sys</span><span class="p">.</span><span class="n">set_signal</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sighup</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="nc">Signal_handle</span> <span class="n">read_config</span><span class="o">)</span>

<span class="c">(* @@PLEAC@@_17.17 *)</span>
<span class="nc">Oct</span>  <span class="mi">4</span> <span class="mi">11</span><span class="o">:</span><span class="mi">01</span><span class="o">:</span><span class="mi">16</span> <span class="n">pedro</span> <span class="n">sniffer</span><span class="o">:</span> <span class="nc">Connection</span> <span class="n">from</span> <span class="mi">10</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">4</span> <span class="k">to</span> <span class="mi">10</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">0</span><span class="o">.</span><span class="mi">1</span><span class="o">:</span><span class="n">echo</span>

<span class="c">(*-----------------------------*)</span>

<span class="n">echo</span> <span class="n">stream</span> <span class="n">tcp</span> <span class="n">nowait</span> <span class="n">nobody</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span> <span class="n">ocaml</span> <span class="o">/</span><span class="n">path</span><span class="o">/</span><span class="k">to</span><span class="o">/</span><span class="n">backsniff</span><span class="o">.</span><span class="n">ml</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* backsniff - log attempts to connect to particular ports *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="c">(* This recipe uses syslog-ocaml, which is available at:</span>
<span class="c">   http://www.cs.cmu.edu/~ecc/software.html *)</span>
<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+syslog&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;syslog.cma&quot;</span><span class="o">;;</span>

<span class="c">(* identify my port and address *)</span>
<span class="k">let</span> <span class="n">sockname</span> <span class="o">=</span>
  <span class="k">try</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">getsockname</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span>
  <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Couldn&#39;t identify myself: %s</span><span class="se">\n</span><span class="s2">%!&quot;</span>
      <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">error_message</span> <span class="n">e</span><span class="o">);</span>
    <span class="n">exit</span> <span class="mi">1</span>
<span class="k">let</span> <span class="n">iaddr</span><span class="o">,</span> <span class="n">port</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">sockname</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">ADDR_INET</span> <span class="o">(</span><span class="n">iaddr</span><span class="o">,</span> <span class="n">port</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">iaddr</span><span class="o">,</span> <span class="n">port</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">assert</span> <span class="bp">false</span>
<span class="k">let</span> <span class="n">my_address</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">string_of_inet_addr</span> <span class="n">iaddr</span>

<span class="c">(* get a name for the service *)</span>
<span class="k">let</span> <span class="n">service</span> <span class="o">=</span>
  <span class="k">try</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">getservbyport</span> <span class="n">port</span> <span class="s2">&quot;tcp&quot;</span><span class="o">).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">s_name</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="n">string_of_int</span> <span class="n">port</span>

<span class="c">(* now identify remote address *)</span>
<span class="k">let</span> <span class="n">sockname</span> <span class="o">=</span>
  <span class="k">try</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">getpeername</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span>
  <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Couldn&#39;t identify other end: %s</span><span class="se">\n</span><span class="s2">%!&quot;</span>
      <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">error_message</span> <span class="n">e</span><span class="o">);</span>
    <span class="n">exit</span> <span class="mi">1</span>
<span class="k">let</span> <span class="n">iaddr</span><span class="o">,</span> <span class="n">port</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">sockname</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">ADDR_INET</span> <span class="o">(</span><span class="n">iaddr</span><span class="o">,</span> <span class="n">port</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">iaddr</span><span class="o">,</span> <span class="n">port</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">assert</span> <span class="bp">false</span>
<span class="k">let</span> <span class="n">ex_address</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">string_of_inet_addr</span> <span class="n">iaddr</span>

<span class="c">(* and log the information *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">log</span> <span class="o">=</span> <span class="nn">Syslog</span><span class="p">.</span><span class="n">openlog</span> <span class="o">~</span><span class="n">flags</span><span class="o">:</span><span class="bp">[]</span> <span class="o">~</span><span class="n">facility</span><span class="o">:`</span><span class="nc">LOG_DAEMON</span> <span class="s2">&quot;sniffer&quot;</span> <span class="k">in</span>
  <span class="nn">Syslog</span><span class="p">.</span><span class="n">syslog</span> <span class="n">log</span> <span class="o">`</span><span class="nc">LOG_NOTICE</span>
    <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;Connection from %s to %s:%s</span><span class="se">\n</span><span class="s2">&quot;</span>
       <span class="n">ex_address</span> <span class="n">my_address</span> <span class="n">service</span><span class="o">);</span>
  <span class="nn">Syslog</span><span class="p">.</span><span class="n">closelog</span> <span class="n">log</span><span class="o">;</span>
  <span class="n">exit</span> <span class="mi">0</span>

<span class="c">(* @@PLEAC@@_17.18 *)</span>
<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* fwdport -- act as proxy forwarder for dedicated services *)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">children</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span>    <span class="c">(* hash of outstanding child processes *)</span>
<span class="k">let</span> <span class="n">remote</span> <span class="o">=</span> <span class="n">ref</span> <span class="s2">&quot;&quot;</span>                <span class="c">(* whom we connect to on the outside *)</span>
<span class="k">let</span> <span class="n">local</span> <span class="o">=</span> <span class="n">ref</span> <span class="s2">&quot;&quot;</span>                 <span class="c">(* where we listen to on the inside *)</span>
<span class="k">let</span> <span class="n">service</span> <span class="o">=</span> <span class="n">ref</span> <span class="s2">&quot;&quot;</span>               <span class="c">(* our service name or port number *)</span>
<span class="k">let</span> <span class="n">proxy_server</span> <span class="o">=</span> <span class="n">ref</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span>  <span class="c">(* the socket we accept() from *)</span>

<span class="c">(* process command line switches *)</span>
<span class="k">let</span> <span class="n">check_args</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Arg</span><span class="p">.</span><span class="n">parse</span>
    <span class="o">[</span>
      <span class="s2">&quot;-r&quot;</span><span class="o">,</span>       <span class="nn">Arg</span><span class="p">.</span><span class="nc">Set_string</span> <span class="n">remote</span><span class="o">,</span>  <span class="s2">&quot;Remote host&quot;</span><span class="o">;</span>
      <span class="s2">&quot;-remote&quot;</span><span class="o">,</span>  <span class="nn">Arg</span><span class="p">.</span><span class="nc">Set_string</span> <span class="n">remote</span><span class="o">,</span>  <span class="s2">&quot;Remote host&quot;</span><span class="o">;</span>
      <span class="s2">&quot;-l&quot;</span><span class="o">,</span>       <span class="nn">Arg</span><span class="p">.</span><span class="nc">Set_string</span> <span class="n">local</span><span class="o">,</span>   <span class="s2">&quot;Local interface&quot;</span><span class="o">;</span>
      <span class="s2">&quot;-local&quot;</span><span class="o">,</span>   <span class="nn">Arg</span><span class="p">.</span><span class="nc">Set_string</span> <span class="n">local</span><span class="o">,</span>   <span class="s2">&quot;Local interface&quot;</span><span class="o">;</span>
      <span class="s2">&quot;-s&quot;</span><span class="o">,</span>       <span class="nn">Arg</span><span class="p">.</span><span class="nc">Set_string</span> <span class="n">service</span><span class="o">,</span> <span class="s2">&quot;Service&quot;</span><span class="o">;</span>
      <span class="s2">&quot;-service&quot;</span><span class="o">,</span> <span class="nn">Arg</span><span class="p">.</span><span class="nc">Set_string</span> <span class="n">service</span><span class="o">,</span> <span class="s2">&quot;Service&quot;</span><span class="o">;</span>
    <span class="o">]</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">s</span> <span class="o">-&gt;</span>
       <span class="k">raise</span> <span class="o">(</span><span class="nn">Arg</span><span class="p">.</span><span class="nc">Bad</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;unexpected argument `%s&#39;&quot;</span> <span class="n">s</span><span class="o">)))</span>
    <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;usage: %s [ -remote host ] [ -local interface ] [ -service service ]&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">));</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">remote</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
  <span class="k">then</span> <span class="o">(</span><span class="n">prerr_endline</span> <span class="s2">&quot;Need remote&quot;</span><span class="o">;</span> <span class="n">exit</span> <span class="mi">1</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">local</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">service</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
  <span class="k">then</span> <span class="o">(</span><span class="n">prerr_endline</span> <span class="s2">&quot;Need local or service&quot;</span><span class="o">;</span> <span class="n">exit</span> <span class="mi">1</span><span class="o">);</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">local</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
  <span class="k">then</span> <span class="n">local</span> <span class="o">:=</span> <span class="s2">&quot;localhost&quot;</span>

<span class="k">let</span> <span class="n">parse_host</span> <span class="n">host</span> <span class="o">=</span>
  <span class="k">match</span> <span class="nn">Str</span><span class="p">.</span><span class="n">split</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;:&quot;</span><span class="o">)</span> <span class="n">host</span> <span class="k">with</span>
    <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="s2">&quot;&quot;</span><span class="o">,</span> <span class="s2">&quot;&quot;</span>
    <span class="o">|</span> <span class="n">host</span> <span class="o">::</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="n">host</span><span class="o">,</span> <span class="s2">&quot;&quot;</span>
    <span class="o">|</span> <span class="n">host</span> <span class="o">::</span> <span class="n">service</span> <span class="o">::</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">host</span><span class="o">,</span> <span class="n">service</span>

<span class="k">let</span> <span class="n">resolve_host</span> <span class="n">host</span> <span class="o">=</span>
  <span class="k">try</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">gethostbyname</span> <span class="n">host</span><span class="o">).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">h_addr_list</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Host not found: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">host</span><span class="o">;</span>
    <span class="n">exit</span> <span class="mi">1</span>

<span class="k">let</span> <span class="n">resolve_service</span> <span class="n">service</span> <span class="o">=</span>
  <span class="k">try</span> <span class="n">int_of_string</span> <span class="n">service</span>
  <span class="k">with</span> <span class="nc">Failure</span> <span class="o">_</span> <span class="o">-&gt;</span>
    <span class="k">try</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">getservbyname</span> <span class="n">service</span> <span class="s2">&quot;tcp&quot;</span><span class="o">).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">s_port</span>
    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Service not found: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">service</span><span class="o">;</span>
      <span class="n">exit</span> <span class="mi">1</span>

<span class="c">(* begin our server *)</span>
<span class="k">let</span> <span class="n">start_proxy</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">let</span> <span class="n">proto</span> <span class="o">=</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">getprotobyname</span> <span class="s2">&quot;tcp&quot;</span><span class="o">).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">p_proto</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">addr</span><span class="o">,</span> <span class="n">port</span> <span class="o">=</span>
      <span class="k">match</span> <span class="n">parse_host</span> <span class="o">(!</span><span class="n">local</span> <span class="o">^</span> <span class="s2">&quot;:&quot;</span> <span class="o">^</span> <span class="o">!</span><span class="n">service</span><span class="o">)</span> <span class="k">with</span>
        <span class="o">|</span> <span class="n">host</span><span class="o">,</span> <span class="n">service</span> <span class="o">-&gt;</span>
            <span class="o">(</span><span class="n">resolve_host</span> <span class="n">host</span><span class="o">,</span>
             <span class="n">resolve_service</span> <span class="n">service</span><span class="o">)</span> <span class="k">in</span>
    <span class="n">proxy_server</span> <span class="o">:=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">socket</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">PF_INET</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">SOCK_STREAM</span> <span class="n">proto</span><span class="o">;</span>
    <span class="nn">Unix</span><span class="p">.</span><span class="n">setsockopt</span> <span class="o">!</span><span class="n">proxy_server</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">SO_REUSEADDR</span> <span class="bp">true</span><span class="o">;</span>
    <span class="nn">Unix</span><span class="p">.</span><span class="n">bind</span> <span class="o">!</span><span class="n">proxy_server</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">ADDR_INET</span> <span class="o">(</span><span class="n">addr</span><span class="o">,</span> <span class="n">port</span><span class="o">));</span>
    <span class="nn">Unix</span><span class="p">.</span><span class="n">listen</span> <span class="o">!</span><span class="n">proxy_server</span> <span class="mi">128</span><span class="o">;</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;[Proxy server on %s initialized.]</span><span class="se">\n</span><span class="s2">%!&quot;</span>
      <span class="o">(</span><span class="k">if</span> <span class="o">!</span><span class="n">local</span> <span class="o">&lt;&gt;</span> <span class="s2">&quot;&quot;</span> <span class="k">then</span> <span class="o">!</span><span class="n">local</span> <span class="k">else</span> <span class="o">!</span><span class="n">service</span><span class="o">)</span>
  <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Can&#39;t create proxy server: %s</span><span class="se">\n</span><span class="s2">%!&quot;</span>
      <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">error_message</span> <span class="n">e</span><span class="o">);</span>
    <span class="n">exit</span> <span class="mi">1</span>

<span class="c">(* helper function to produce a nice string in the form HOST:PORT *)</span>
<span class="k">let</span> <span class="n">peerinfo</span> <span class="n">sock</span> <span class="o">=</span>
  <span class="k">match</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">getpeername</span> <span class="n">sock</span> <span class="k">with</span>
    <span class="o">|</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">ADDR_INET</span> <span class="o">(</span><span class="n">addr</span><span class="o">,</span> <span class="n">port</span><span class="o">)</span> <span class="o">-&gt;</span>
        <span class="k">let</span> <span class="n">hostinfo</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">gethostbyaddr</span> <span class="n">addr</span> <span class="k">in</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;%s:%d&quot;</span> <span class="n">hostinfo</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">h_name</span> <span class="n">port</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">assert</span> <span class="bp">false</span>

<span class="c">(* somebody just died.  keep harvesting the dead until  *)</span>
<span class="c">(* we run out of them.  check how long they ran. *)</span>
<span class="k">let</span> <span class="k">rec</span> <span class="n">reaper</span> <span class="n">signal</span> <span class="o">=</span>
  <span class="k">begin</span>
    <span class="k">let</span> <span class="n">result</span> <span class="o">=</span>
      <span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">waitpid</span> <span class="o">[</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">WNOHANG</span><span class="o">]</span> <span class="o">(-</span><span class="mi">1</span><span class="o">))</span>
      <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">ECHILD</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="o">-&gt;</span> <span class="nc">None</span> <span class="k">in</span>
    <span class="k">match</span> <span class="n">result</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">child</span><span class="o">,</span> <span class="n">status</span><span class="o">)</span> <span class="k">when</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">mem</span> <span class="n">children</span> <span class="n">child</span> <span class="o">-&gt;</span>
          <span class="k">let</span> <span class="n">start</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">children</span> <span class="n">child</span> <span class="k">in</span>
          <span class="k">let</span> <span class="n">runtime</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">time</span> <span class="bp">()</span> <span class="o">-.</span> <span class="n">start</span> <span class="k">in</span>
          <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Child %d ran %dm%fs</span><span class="se">\n</span><span class="s2">%!&quot;</span>
            <span class="n">child</span>
            <span class="o">(</span><span class="n">int_of_float</span> <span class="o">(</span><span class="n">runtime</span> <span class="o">/.</span> <span class="mi">60</span><span class="o">.))</span>
            <span class="o">(</span><span class="n">mod_float</span> <span class="n">runtime</span> <span class="mi">60</span><span class="o">.);</span>
          <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">remove</span> <span class="n">children</span> <span class="n">child</span><span class="o">;</span>
          <span class="n">reaper</span> <span class="n">signal</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">child</span><span class="o">,</span> <span class="n">status</span><span class="o">)</span> <span class="o">-&gt;</span>
          <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Bizarre kid %d exited with %s</span><span class="se">\n</span><span class="s2">%!&quot;</span>
            <span class="n">child</span>
            <span class="o">(</span><span class="k">match</span> <span class="n">status</span> <span class="k">with</span>
               <span class="o">|</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">WEXITED</span> <span class="n">code</span> <span class="o">-&gt;</span>
                   <span class="s2">&quot;code &quot;</span> <span class="o">^</span> <span class="n">string_of_int</span> <span class="n">code</span>
               <span class="o">|</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">WSTOPPED</span> <span class="n">signal</span>
               <span class="o">|</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">WSIGNALED</span> <span class="n">signal</span> <span class="o">-&gt;</span>
                   <span class="s2">&quot;signal &quot;</span> <span class="o">^</span> <span class="n">string_of_int</span> <span class="n">signal</span><span class="o">);</span>
          <span class="n">reaper</span> <span class="n">signal</span>
      <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="bp">()</span>
  <span class="k">end</span><span class="o">;</span>
  <span class="c">(* If I had to choose between System V and 4.2, I&#39;d resign. *)</span>
  <span class="c">(* --Peter Honeyman *)</span>
  <span class="nn">Sys</span><span class="p">.</span><span class="n">set_signal</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigchld</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="nc">Signal_handle</span> <span class="n">reaper</span><span class="o">)</span>

<span class="k">let</span> <span class="n">service_clients</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* harvest the moribund *)</span>
  <span class="nn">Sys</span><span class="p">.</span><span class="n">set_signal</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigchld</span> <span class="o">(</span><span class="nn">Sys</span><span class="p">.</span><span class="nc">Signal_handle</span> <span class="n">reaper</span><span class="o">);</span>

  <span class="c">(* an accepted connection here means someone inside wants out *)</span>
  <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
    <span class="k">try</span>
      <span class="k">begin</span>
        <span class="k">let</span> <span class="n">local_client</span> <span class="o">=</span> <span class="n">fst</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">accept</span> <span class="o">!</span><span class="n">proxy_server</span><span class="o">)</span> <span class="k">in</span>
        <span class="k">let</span> <span class="n">lc_info</span> <span class="o">=</span> <span class="n">peerinfo</span> <span class="n">local_client</span> <span class="k">in</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;[Connect from %s]</span><span class="se">\n</span><span class="s2">%!&quot;</span> <span class="n">lc_info</span><span class="o">;</span>

        <span class="k">let</span> <span class="n">proto</span> <span class="o">=</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">getprotobyname</span> <span class="s2">&quot;tcp&quot;</span><span class="o">).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">p_proto</span> <span class="k">in</span>
        <span class="k">let</span> <span class="n">addr</span><span class="o">,</span> <span class="n">port</span> <span class="o">=</span>
          <span class="k">match</span> <span class="n">parse_host</span> <span class="o">(!</span><span class="n">remote</span> <span class="o">^</span> <span class="s2">&quot;:&quot;</span> <span class="o">^</span> <span class="o">!</span><span class="n">service</span><span class="o">)</span> <span class="k">with</span>
            <span class="o">|</span> <span class="n">host</span><span class="o">,</span> <span class="n">service</span> <span class="o">-&gt;</span>
                <span class="o">(</span><span class="n">resolve_host</span> <span class="n">host</span><span class="o">,</span>
                 <span class="n">resolve_service</span> <span class="n">service</span><span class="o">)</span> <span class="k">in</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;[Connecting to %s...%!&quot;</span> <span class="o">!</span><span class="n">remote</span><span class="o">;</span>
        <span class="k">let</span> <span class="n">remote_server</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">socket</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">PF_INET</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">SOCK_STREAM</span> <span class="n">proto</span> <span class="k">in</span>
        <span class="nn">Unix</span><span class="p">.</span><span class="n">connect</span> <span class="n">remote_server</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">ADDR_INET</span> <span class="o">(</span><span class="n">addr</span><span class="o">,</span> <span class="n">port</span><span class="o">));</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;done]</span><span class="se">\n</span><span class="s2">%!&quot;</span><span class="o">;</span>

        <span class="k">let</span> <span class="n">local_in</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">in_channel_of_descr</span> <span class="n">local_client</span> <span class="k">in</span>
        <span class="k">let</span> <span class="n">local_out</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">out_channel_of_descr</span> <span class="n">local_client</span> <span class="k">in</span>
        <span class="k">let</span> <span class="n">remote_in</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">in_channel_of_descr</span> <span class="n">remote_server</span> <span class="k">in</span>
        <span class="k">let</span> <span class="n">remote_out</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">out_channel_of_descr</span> <span class="n">remote_server</span> <span class="k">in</span>

        <span class="k">match</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">fork</span> <span class="bp">()</span> <span class="k">with</span>
          <span class="o">|</span> <span class="mi">0</span> <span class="o">-&gt;</span>
              <span class="c">(* at this point, we are the forked child process dedicated *)</span>
              <span class="c">(* to the incoming client.  but we want a twin to make i/o *)</span>
              <span class="c">(* easier. *)</span>

              <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="o">!</span><span class="n">proxy_server</span><span class="o">;</span>  <span class="c">(* no use to slave *)</span>

              <span class="c">(* now each twin sits around and ferries lines of data. *)</span>
              <span class="c">(* see how simple the algorithm is when you can have *)</span>
              <span class="c">(* multiple threads of control? *)</span>

              <span class="o">(</span><span class="k">match</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">fork</span> <span class="bp">()</span> <span class="k">with</span>
                 <span class="o">|</span> <span class="mi">0</span> <span class="o">-&gt;</span>
                     <span class="c">(* this is the fork&#39;s child, the master&#39;s grandchild *)</span>
                     <span class="o">(</span><span class="k">try</span>
                          <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
                            <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">local_in</span> <span class="k">in</span>
                            <span class="nn">Printf</span><span class="p">.</span><span class="n">fprintf</span> <span class="n">remote_out</span> <span class="s2">&quot;%s</span><span class="se">\n</span><span class="s2">%!&quot;</span> <span class="n">line</span>
                          <span class="k">done</span>
                      <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
                        <span class="c">(* kill my twin cause we&#39;re done *)</span>
                        <span class="nn">Unix</span><span class="p">.</span><span class="n">kill</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">getppid</span> <span class="bp">()</span><span class="o">)</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigterm</span><span class="o">)</span>
                 <span class="o">|</span> <span class="n">kidpid</span> <span class="o">-&gt;</span>
                     <span class="c">(* this is the fork&#39;s parent, the master&#39;s child *)</span>
                     <span class="o">(</span><span class="k">try</span>
                          <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
                            <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">remote_in</span> <span class="k">in</span>
                            <span class="nn">Printf</span><span class="p">.</span><span class="n">fprintf</span> <span class="n">local_out</span> <span class="s2">&quot;%s</span><span class="se">\n</span><span class="s2">%!&quot;</span> <span class="n">line</span>
                          <span class="k">done</span>
                      <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
                        <span class="c">(* kill my twin cause we&#39;re done *)</span>
                        <span class="nn">Unix</span><span class="p">.</span><span class="n">kill</span> <span class="n">kidpid</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">sigterm</span><span class="o">));</span>

              <span class="n">exit</span> <span class="mi">0</span>  <span class="c">(* whoever&#39;s still alive bites it *)</span>

          <span class="o">|</span> <span class="n">kidpid</span> <span class="o">-&gt;</span>
              <span class="c">(* remember his start time *)</span>
              <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">children</span> <span class="n">kidpid</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">time</span> <span class="bp">()</span><span class="o">);</span>
              <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="n">remote_server</span><span class="o">;</span>  <span class="c">(* no use to master *)</span>
              <span class="nn">Unix</span><span class="p">.</span><span class="n">close</span> <span class="n">local_client</span><span class="o">;</span>   <span class="c">(* likewise *)</span>
      <span class="k">end</span>
    <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">EINTR</span><span class="o">,</span> <span class="s2">&quot;accept&quot;</span><span class="o">,</span> <span class="o">_)</span> <span class="o">-&gt;</span> <span class="bp">()</span>
  <span class="k">done</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">check_args</span> <span class="bp">()</span><span class="o">;</span>                <span class="c">(* processing switches *)</span>
  <span class="n">start_proxy</span> <span class="bp">()</span><span class="o">;</span>               <span class="c">(* launch our own server *)</span>
  <span class="n">service_clients</span> <span class="bp">()</span><span class="o">;</span>           <span class="c">(* wait for incoming *)</span>
  <span class="n">prerr_endline</span> <span class="s2">&quot;NOT REACHED&quot;</span><span class="o">;</span>  <span class="c">(* you can&#39;t get here from there *)</span>
  <span class="n">exit</span> <span class="mi">1</span>


<span class="c">(* @@PLEAC@@_18.1 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">let</span> <span class="n">addresses</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">gethostbyname</span> <span class="n">name</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">addresses</span> <span class="o">=</span>
      <span class="nn">Array</span><span class="p">.</span><span class="n">map</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">string_of_inet_addr</span> <span class="n">addresses</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">h_addr_list</span> <span class="k">in</span>
    <span class="c">(* addresses is an array of IP addresses *)</span>
    <span class="nn">Array</span><span class="p">.</span><span class="n">iter</span> <span class="n">print_endline</span> <span class="n">addresses</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Can&#39;t resolve %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">name</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">let</span> <span class="n">host</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">gethostbyaddr</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">inet_addr_of_string</span> <span class="n">address</span><span class="o">)</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">name</span> <span class="o">=</span> <span class="n">host</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">h_name</span> <span class="k">in</span>
    <span class="c">(* name is the hostname (&quot;www.perl.com&quot;) *)</span>
    <span class="n">print_endline</span> <span class="n">name</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Can&#39;t resolve %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">address</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">let</span> <span class="n">host</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">gethostbyaddr</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">inet_addr_of_string</span> <span class="n">address</span><span class="o">)</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">name</span> <span class="o">=</span> <span class="n">host</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">h_name</span> <span class="k">in</span>
    <span class="k">try</span>
      <span class="k">let</span> <span class="n">addresses</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">gethostbyname</span> <span class="n">name</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">addresses</span> <span class="o">=</span>
        <span class="nn">Array</span><span class="p">.</span><span class="n">map</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">string_of_inet_addr</span> <span class="n">addresses</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">h_addr_list</span> <span class="k">in</span>
      <span class="nn">Array</span><span class="p">.</span><span class="n">iter</span> <span class="n">print_endline</span> <span class="n">addresses</span><span class="o">;</span>
      <span class="k">let</span> <span class="n">found</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">mem</span> <span class="n">address</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="n">addresses</span><span class="o">)</span> <span class="k">in</span>
      <span class="n">print_endline</span> <span class="o">(</span><span class="k">if</span> <span class="n">found</span> <span class="k">then</span> <span class="s2">&quot;found&quot;</span> <span class="k">else</span> <span class="s2">&quot;not found&quot;</span><span class="o">)</span>
    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Can&#39;t look up %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">name</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Can&#39;t look up %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">address</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* mxhost - find mx exchangers for a host *)</span>

<span class="c">(* Though there is an experimental new DNS resolver for OCaml called</span>
<span class="c">   Netdns, it does not yet support resolving MX records. For now, we&#39;ll</span>
<span class="c">   use Net::DNS through perl4caml until a better solution is available.</span>
<span class="c">*)</span>
<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+perl&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;perl4caml.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="nn">Perl</span><span class="p">.</span><span class="n">eval</span> <span class="s2">&quot;use Net::DNS&quot;</span>

<span class="k">let</span> <span class="n">host</span> <span class="o">=</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span>
<span class="k">let</span> <span class="n">res</span> <span class="o">=</span> <span class="nn">Perl</span><span class="p">.</span><span class="n">call_class_method</span> <span class="s2">&quot;Net::DNS::Resolver&quot;</span> <span class="s2">&quot;new&quot;</span> <span class="bp">[]</span>
<span class="k">let</span> <span class="n">mx</span> <span class="o">=</span> <span class="nn">Perl</span><span class="p">.</span><span class="n">call_array</span> <span class="o">~</span><span class="n">fn</span><span class="o">:</span><span class="s2">&quot;mx&quot;</span> <span class="o">[</span><span class="n">res</span><span class="o">;</span> <span class="nn">Perl</span><span class="p">.</span><span class="n">sv_of_string</span> <span class="n">host</span><span class="o">]</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">mx</span> <span class="o">=</span> <span class="bp">[]</span> <span class="k">then</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Can&#39;t find MX records for %s (%s)</span><span class="se">\n</span><span class="s2">&quot;</span>
      <span class="n">host</span> <span class="o">(</span><span class="nn">Perl</span><span class="p">.</span><span class="n">string_of_sv</span> <span class="o">(</span><span class="nn">Perl</span><span class="p">.</span><span class="n">call_method</span> <span class="n">res</span> <span class="s2">&quot;errorstring&quot;</span> <span class="bp">[]</span><span class="o">))</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">record</span> <span class="o">-&gt;</span>
       <span class="k">let</span> <span class="n">preference</span> <span class="o">=</span> <span class="nn">Perl</span><span class="p">.</span><span class="n">call_method</span> <span class="n">record</span> <span class="s2">&quot;preference&quot;</span> <span class="bp">[]</span> <span class="k">in</span>
       <span class="k">let</span> <span class="n">exchange</span> <span class="o">=</span> <span class="nn">Perl</span><span class="p">.</span><span class="n">call_method</span> <span class="n">record</span> <span class="s2">&quot;exchange&quot;</span> <span class="bp">[]</span> <span class="k">in</span>
       <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s %s</span><span class="se">\n</span><span class="s2">&quot;</span>
         <span class="o">(</span><span class="nn">Perl</span><span class="p">.</span><span class="n">string_of_sv</span> <span class="n">preference</span><span class="o">)</span>
         <span class="o">(</span><span class="nn">Perl</span><span class="p">.</span><span class="n">string_of_sv</span> <span class="n">exchange</span><span class="o">))</span>
    <span class="n">mx</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* hostaddrs - canonize name and show addresses *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>
<span class="k">let</span> <span class="n">name</span> <span class="o">=</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span>
<span class="k">let</span> <span class="n">hent</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">gethostbyname</span> <span class="n">name</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s =&gt; %s</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="n">hent</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">h_name</span>    <span class="c">(* in case different *)</span>
    <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot; &quot;</span>
       <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span>
          <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">map</span>
             <span class="nn">Unix</span><span class="p">.</span><span class="n">string_of_inet_addr</span>
             <span class="n">hent</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">h_addr_list</span><span class="o">)))</span>

<span class="c">(* @@PLEAC@@_18.2 *)</span>
<span class="c">(* The Netclient package from Ocamlnet provides an event-driven</span>
<span class="c">   FTP client. This client does not currently support uploading.</span>

<span class="c">   Ocamlnet is available here:</span>
<span class="c">   http://projects.camlcity.org/projects/ocamlnet.html</span>

<span class="c">   This recipe assumes it has been installed with findlib. *)</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netclient&quot;</span><span class="o">;;</span>

<span class="c">(* Create an FTP client instance. *)</span>
<span class="k">let</span> <span class="n">ftp</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Ftp_client</span><span class="p">.</span><span class="n">ftp_client</span> <span class="bp">()</span>

<span class="c">(* Build and execute a chain of FTP methods. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">ftp</span><span class="o">#</span><span class="n">add</span> <span class="o">(</span><span class="k">new</span> <span class="nn">Ftp_client</span><span class="p">.</span><span class="n">connect_method</span> <span class="o">~</span><span class="n">host</span><span class="o">:</span><span class="s2">&quot;127.0.0.1&quot;</span> <span class="bp">()</span><span class="o">);</span>
  <span class="n">ftp</span><span class="o">#</span><span class="n">add</span> <span class="o">(</span><span class="k">new</span> <span class="nn">Ftp_client</span><span class="p">.</span><span class="n">login_method</span>
             <span class="o">~</span><span class="n">user</span><span class="o">:</span><span class="s2">&quot;anonymous&quot;</span>
             <span class="o">~</span><span class="n">get_password</span><span class="o">:(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="s2">&quot;user@example.com&quot;</span><span class="o">)</span>
             <span class="o">~</span><span class="n">get_account</span><span class="o">:(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="s2">&quot;anonymous&quot;</span><span class="o">)</span> <span class="bp">()</span><span class="o">);</span>
  <span class="n">ftp</span><span class="o">#</span><span class="n">add</span> <span class="o">(</span><span class="k">new</span> <span class="nn">Ftp_client</span><span class="p">.</span><span class="n">walk_method</span> <span class="o">(`</span><span class="nc">Dir</span> <span class="s2">&quot;/pub&quot;</span><span class="o">));</span>
  <span class="k">let</span> <span class="n">ch</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">output_channel</span> <span class="o">(</span><span class="n">open_out</span> <span class="s2">&quot;output.txt&quot;</span><span class="o">)</span> <span class="k">in</span>
  <span class="n">ftp</span><span class="o">#</span><span class="n">add</span> <span class="o">(</span><span class="k">new</span> <span class="nn">Ftp_client</span><span class="p">.</span><span class="n">get_method</span>
             <span class="o">~</span><span class="n">file</span><span class="o">:(`</span><span class="nc">Verbatim</span> <span class="s2">&quot;index.txt&quot;</span><span class="o">)</span>
             <span class="o">~</span><span class="n">representation</span><span class="o">:`</span><span class="nc">Image</span>
             <span class="o">~</span><span class="n">store</span><span class="o">:(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="o">`</span><span class="nc">File_structure</span> <span class="n">ch</span><span class="o">)</span> <span class="bp">()</span><span class="o">);</span>
  <span class="n">ftp</span><span class="o">#</span><span class="n">run</span> <span class="bp">()</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* If an error occurs, it will be exposed by the &quot;state&quot; property. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">match</span> <span class="n">ftp</span><span class="o">#</span><span class="n">state</span> <span class="k">with</span>
    <span class="o">|</span> <span class="o">`</span><span class="nc">Error</span> <span class="o">(</span><span class="nn">Ftp_client</span><span class="p">.</span><span class="nc">FTP_error</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="n">e</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)))</span> <span class="o">-&gt;</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Error: %s</span><span class="se">\n</span><span class="s2">%!&quot;</span>
          <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">error_message</span> <span class="n">e</span><span class="o">)</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* To determine the current working directory, send invoke the `PWD</span>
<span class="c">   command and inspect the result in a callback. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">ftp</span><span class="o">#</span><span class="n">add</span> <span class="o">(</span><span class="k">new</span> <span class="nn">Ftp_client</span><span class="p">.</span><span class="n">invoke_method</span>
             <span class="o">~</span><span class="n">command</span><span class="o">:`</span><span class="nc">PWD</span>
             <span class="o">~</span><span class="n">process_result</span><span class="o">:(</span><span class="k">fun</span> <span class="n">state</span> <span class="o">(</span><span class="n">code</span><span class="o">,</span> <span class="n">message</span><span class="o">)</span> <span class="o">-&gt;</span>
                                <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span>
                                  <span class="s2">&quot;I&#39;m in the directory %s</span><span class="se">\n</span><span class="s2">%!&quot;</span>
                                  <span class="n">message</span><span class="o">)</span> <span class="bp">()</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Use mkdir_method and rmdir_method to make and remove directories from</span>
<span class="c">   the remote server. Use the optional ~onerror argument to specify an</span>
<span class="c">   error handler. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">ftp</span><span class="o">#</span><span class="n">add</span>
    <span class="o">~</span><span class="n">onerror</span><span class="o">:(</span><span class="k">fun</span> <span class="n">e</span> <span class="o">-&gt;</span>
                <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Can&#39;t create /ocaml: %s</span><span class="se">\n</span><span class="s2">%!&quot;</span>
                  <span class="o">(</span><span class="nn">Printexc</span><span class="p">.</span><span class="n">to_string</span> <span class="n">e</span><span class="o">))</span>
    <span class="o">(</span><span class="k">new</span> <span class="nn">Ftp_client</span><span class="p">.</span><span class="n">mkdir_method</span> <span class="o">(`</span><span class="nc">Verbatim</span> <span class="s2">&quot;/pub/ocaml&quot;</span><span class="o">))</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Use a list_method to get a list of files in a remote directory. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">create</span> <span class="mi">256</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">ch</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">output_buffer</span> <span class="n">buffer</span> <span class="k">in</span>
  <span class="n">ftp</span><span class="o">#</span><span class="n">add</span>
    <span class="o">~</span><span class="n">onsuccess</span><span class="o">:(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="n">print_endline</span> <span class="o">(</span><span class="nn">Buffer</span><span class="p">.</span><span class="n">contents</span> <span class="n">buffer</span><span class="o">))</span>
    <span class="o">~</span><span class="n">onerror</span><span class="o">:(</span><span class="k">fun</span> <span class="n">e</span> <span class="o">-&gt;</span>
                <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Can&#39;t get a list of files in /pub: %s</span><span class="se">\n</span><span class="s2">%!&quot;</span>
                  <span class="o">(</span><span class="nn">Printexc</span><span class="p">.</span><span class="n">to_string</span> <span class="n">e</span><span class="o">))</span>
    <span class="o">(</span><span class="k">new</span> <span class="nn">Ftp_client</span><span class="p">.</span><span class="n">list_method</span>
       <span class="o">~</span><span class="n">dir</span><span class="o">:(`</span><span class="nc">Verbatim</span> <span class="s2">&quot;/pub&quot;</span><span class="o">)</span>
       <span class="o">~</span><span class="n">representation</span><span class="o">:`</span><span class="nc">Image</span>
       <span class="o">~</span><span class="n">store</span><span class="o">:(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="o">`</span><span class="nc">File_structure</span> <span class="n">ch</span><span class="o">)</span> <span class="bp">()</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Use `QUIT followed by ftp#abort to close the connection and exit</span>
<span class="c">   the event loop. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">ftp</span><span class="o">#</span><span class="n">add</span> <span class="o">(</span><span class="k">new</span> <span class="nn">Ftp_client</span><span class="p">.</span><span class="n">invoke_method</span>
             <span class="o">~</span><span class="n">command</span><span class="o">:`</span><span class="nc">QUIT</span>
             <span class="o">~</span><span class="n">process_result</span><span class="o">:(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">ftp</span><span class="o">#</span><span class="n">abort</span> <span class="bp">()</span><span class="o">)</span> <span class="bp">()</span><span class="o">)</span>

<span class="c">(* @@PLEAC@@_18.3 *)</span>
<span class="c">(* Use Netsendmail, part of the Netstring package that comes with</span>
<span class="c">   Ocamlnet, to send mail through a command-line mailer program. *)</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netstring&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Netsendmail</span><span class="p">.</span><span class="n">sendmail</span>
    <span class="o">~</span><span class="n">mailer</span><span class="o">:</span><span class="s2">&quot;/usr/sbin/sendmail&quot;</span>  <span class="c">(* defaults to &quot;/usr/lib/sendmail&quot; *)</span>
    <span class="o">(</span><span class="nn">Netsendmail</span><span class="p">.</span><span class="n">compose</span>
       <span class="o">~</span><span class="n">from_addr</span><span class="o">:(</span><span class="n">from_name</span><span class="o">,</span> <span class="n">from_address</span><span class="o">)</span>
       <span class="o">~</span><span class="n">to_addrs</span><span class="o">:[(</span><span class="n">to_name</span><span class="o">,</span> <span class="n">to_address</span><span class="o">)]</span>
       <span class="o">~</span><span class="n">subject</span><span class="o">:</span><span class="n">subject</span>
       <span class="n">body</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* You can also open a pipe directly to sendmail. *)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">sendmail</span> <span class="o">=</span>
    <span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_out</span> <span class="s2">&quot;/usr/lib/sendmail -oi -t -odq&quot;</span> <span class="k">in</span>
  <span class="n">output_string</span> <span class="n">sendmail</span> <span class="s2">&quot;\</span>
<span class="s2">From: User Originating Mail &lt;me@host&gt;</span>
<span class="s2">To: Final Destination &lt;you@otherhost&gt;</span>
<span class="s2">Subject: A relevant subject line</span>

<span class="s2">Body of the message goes here, in as many lines as you like.</span>
<span class="s2">&quot;</span><span class="o">;</span>
  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_out</span> <span class="n">sendmail</span><span class="o">)</span>

<span class="c">(* @@PLEAC@@_18.4 *)</span>
<span class="c">(* There is no NNTP library available for OCaml. With a little</span>
<span class="c">   preparation, we can easily use the one that comes with Perl</span>
<span class="c">   using perl4caml (http://merjis.com/developers/perl4caml) *)</span>

<span class="o">#</span><span class="n">directory</span> <span class="s2">&quot;+perl&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;perl4caml.cma&quot;</span><span class="o">;;</span>

<span class="k">module</span> <span class="nc">NNTP</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">open</span> <span class="nc">Perl</span>
  <span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="n">eval</span> <span class="s2">&quot;use Net::NNTP&quot;</span>

  <span class="c">(* Returned by &quot;list&quot; method so that newsgroups stay sorted. *)</span>
  <span class="k">module</span> <span class="nc">GroupMap</span> <span class="o">=</span> <span class="nn">Map</span><span class="p">.</span><span class="nc">Make</span><span class="o">(</span><span class="nc">String</span><span class="o">)</span>

  <span class="c">(* Wrapper for Net::NNTP class. *)</span>
  <span class="k">class</span> <span class="n">nntp</span> <span class="n">host</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">nntp</span> <span class="o">=</span>
      <span class="n">call_class_method</span> <span class="s2">&quot;Net::NNTP&quot;</span> <span class="s2">&quot;new&quot;</span> <span class="o">[</span><span class="n">sv_of_string</span> <span class="n">host</span><span class="o">]</span> <span class="k">in</span>

    <span class="c">(* Raise a Failure exception if we couldn&#39;t connect. *)</span>
    <span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
      <span class="k">if</span> <span class="n">sv_is_undef</span> <span class="n">nntp</span>
      <span class="k">then</span> <span class="n">failwith</span> <span class="o">(</span><span class="n">string_of_sv</span> <span class="o">(</span><span class="n">eval</span> <span class="s2">&quot;$!&quot;</span><span class="o">))</span> <span class="k">in</span>

    <span class="c">(* Helper function to transform nullable string arrays to OCaml. *)</span>
    <span class="k">let</span> <span class="n">maybe_string_list</span> <span class="n">sv</span> <span class="o">=</span>
      <span class="k">if</span> <span class="n">sv_is_undef</span> <span class="n">sv</span>
      <span class="k">then</span> <span class="k">raise</span> <span class="nc">Not_found</span>
      <span class="k">else</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">string_of_sv</span> <span class="o">(</span><span class="n">list_of_av</span> <span class="o">(</span><span class="n">deref_array</span> <span class="n">sv</span><span class="o">))</span> <span class="k">in</span>

  <span class="k">object</span> <span class="o">(</span><span class="n">self</span><span class="o">)</span>
    <span class="k">val</span> <span class="n">nntp</span> <span class="o">=</span> <span class="n">nntp</span>

    <span class="k">method</span> <span class="n">group</span> <span class="n">name</span> <span class="o">=</span>
      <span class="k">match</span> <span class="n">call_method_array</span> <span class="n">nntp</span> <span class="s2">&quot;group&quot;</span> <span class="o">[</span><span class="n">sv_of_string</span> <span class="n">name</span><span class="o">]</span> <span class="k">with</span>
        <span class="o">|</span> <span class="o">[</span><span class="n">narticles</span><span class="o">;</span> <span class="n">first</span><span class="o">;</span> <span class="n">last</span><span class="o">;</span> <span class="n">name</span><span class="o">]</span> <span class="o">-&gt;</span>
            <span class="o">(</span><span class="n">int_of_sv</span> <span class="n">narticles</span><span class="o">,</span> <span class="n">int_of_sv</span> <span class="n">first</span><span class="o">,</span>
             <span class="n">int_of_sv</span> <span class="n">last</span><span class="o">,</span> <span class="n">string_of_sv</span> <span class="n">name</span><span class="o">)</span>
        <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">raise</span> <span class="nc">Not_found</span>

    <span class="k">method</span> <span class="n">head</span> <span class="n">msgid</span> <span class="o">=</span>
      <span class="n">maybe_string_list</span> <span class="o">(</span><span class="n">call_method</span> <span class="n">nntp</span> <span class="s2">&quot;head&quot;</span> <span class="o">[</span><span class="n">sv_of_int</span> <span class="n">msgid</span><span class="o">])</span>

    <span class="k">method</span> <span class="n">body</span> <span class="n">msgid</span> <span class="o">=</span>
      <span class="n">maybe_string_list</span> <span class="o">(</span><span class="n">call_method</span> <span class="n">nntp</span> <span class="s2">&quot;body&quot;</span> <span class="o">[</span><span class="n">sv_of_int</span> <span class="n">msgid</span><span class="o">])</span>

    <span class="k">method</span> <span class="n">article</span> <span class="n">msgid</span> <span class="o">=</span>
      <span class="n">maybe_string_list</span> <span class="o">(</span><span class="n">call_method</span> <span class="n">nntp</span> <span class="s2">&quot;article&quot;</span> <span class="o">[</span><span class="n">sv_of_int</span> <span class="n">msgid</span><span class="o">])</span>

    <span class="k">method</span> <span class="n">postok</span> <span class="bp">()</span> <span class="o">=</span>
      <span class="n">bool_of_sv</span> <span class="o">(</span><span class="n">call_method</span> <span class="n">nntp</span> <span class="s2">&quot;postok&quot;</span> <span class="bp">[]</span><span class="o">)</span>

    <span class="k">method</span> <span class="n">post</span> <span class="n">lines</span> <span class="o">=</span>
      <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">sv_of_string</span> <span class="n">lines</span> <span class="k">in</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">sv_is_undef</span> <span class="o">(</span><span class="n">call_method</span> <span class="n">nntp</span> <span class="s2">&quot;post&quot;</span> <span class="n">lines</span><span class="o">))</span>
      <span class="k">then</span> <span class="n">failwith</span> <span class="o">(</span><span class="n">string_of_sv</span> <span class="o">(</span><span class="n">eval</span> <span class="s2">&quot;$!&quot;</span><span class="o">))</span>

    <span class="k">method</span> <span class="kt">list</span> <span class="bp">()</span> <span class="o">=</span>
      <span class="k">let</span> <span class="n">hv</span> <span class="o">=</span> <span class="n">deref_hash</span> <span class="o">(</span><span class="n">call_method</span> <span class="n">nntp</span> <span class="s2">&quot;list&quot;</span> <span class="bp">[]</span><span class="o">)</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">map</span> <span class="o">=</span> <span class="n">ref</span> <span class="nn">GroupMap</span><span class="p">.</span><span class="n">empty</span> <span class="k">in</span>
      <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
        <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">info</span><span class="o">)</span> <span class="o">-&gt;</span>
           <span class="n">map</span> <span class="o">:=</span>
             <span class="nn">GroupMap</span><span class="p">.</span><span class="n">add</span>
               <span class="n">name</span>
               <span class="o">(</span><span class="k">match</span> <span class="n">list_of_av</span> <span class="o">(</span><span class="n">deref_array</span> <span class="n">info</span><span class="o">)</span> <span class="k">with</span>
                  <span class="o">|</span> <span class="o">[</span><span class="n">last</span><span class="o">;</span> <span class="n">first</span><span class="o">;</span> <span class="n">flags</span><span class="o">]</span> <span class="o">-&gt;</span>
                      <span class="o">(</span><span class="n">int_of_sv</span> <span class="n">last</span><span class="o">,</span> <span class="n">int_of_sv</span> <span class="n">first</span><span class="o">,</span>
                       <span class="n">string_of_sv</span> <span class="n">flags</span><span class="o">)</span>
                  <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">assert</span> <span class="bp">false</span><span class="o">)</span>
               <span class="o">!</span><span class="n">map</span><span class="o">)</span>
        <span class="o">(</span><span class="n">assoc_of_hv</span> <span class="n">hv</span><span class="o">);</span>
      <span class="o">!</span><span class="n">map</span>

    <span class="k">method</span> <span class="n">quit</span> <span class="bp">()</span> <span class="o">=</span>
      <span class="n">ignore</span> <span class="o">(</span><span class="n">call_method</span> <span class="n">nntp</span> <span class="s2">&quot;quit&quot;</span> <span class="bp">[]</span><span class="o">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Connect to an NNTP server by creating an &quot;nntp&quot; object. *)</span>
<span class="k">let</span> <span class="n">server</span> <span class="o">=</span>
  <span class="k">try</span> <span class="k">new</span> <span class="nn">NNTP</span><span class="p">.</span><span class="n">nntp</span> <span class="s2">&quot;news.west.cox.net&quot;</span>
  <span class="k">with</span> <span class="nc">Failure</span> <span class="n">s</span> <span class="o">-&gt;</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Can&#39;t connect to news server: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">s</span><span class="o">;</span>
    <span class="n">exit</span> <span class="mi">1</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Select a newsgroup and retrieve its stats. *)</span>
<span class="k">let</span> <span class="o">(</span><span class="n">narticles</span><span class="o">,</span> <span class="n">first</span><span class="o">,</span> <span class="n">last</span><span class="o">,</span> <span class="n">name</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">try</span> <span class="n">server</span><span class="o">#</span><span class="n">group</span> <span class="s2">&quot;misc.test&quot;</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Can&#39;t select misc.test</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
    <span class="n">exit</span> <span class="mi">1</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Get the headers from the last article. *)</span>
<span class="k">let</span> <span class="n">headers</span> <span class="o">=</span>
  <span class="k">try</span> <span class="n">server</span><span class="o">#</span><span class="n">head</span> <span class="n">last</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Can&#39;t get headers from article %d in %s</span><span class="se">\n</span><span class="s2">&quot;</span>
      <span class="n">last</span> <span class="n">name</span><span class="o">;</span>
    <span class="n">exit</span> <span class="mi">1</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Get the body from the last article. *)</span>
<span class="k">let</span> <span class="n">body</span> <span class="o">=</span>
  <span class="k">try</span> <span class="n">server</span><span class="o">#</span><span class="n">head</span> <span class="n">last</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Can&#39;t get body from article %d in %s</span><span class="se">\n</span><span class="s2">&quot;</span>
      <span class="n">last</span> <span class="n">name</span><span class="o">;</span>
    <span class="n">exit</span> <span class="mi">1</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Get the headers and body from the last article. *)</span>
<span class="k">let</span> <span class="n">article</span> <span class="o">=</span>
  <span class="k">try</span> <span class="n">server</span><span class="o">#</span><span class="n">head</span> <span class="n">last</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Can&#39;t get article from article %d in %s</span><span class="se">\n</span><span class="s2">&quot;</span>
      <span class="n">last</span> <span class="n">name</span><span class="o">;</span>
    <span class="n">exit</span> <span class="mi">1</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Determine if posting is allowed with this server. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="n">server</span><span class="o">#</span><span class="n">postok</span> <span class="bp">()</span><span class="o">)</span>
  <span class="k">then</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Server didn&#39;t tell me I could post.</span><span class="se">\n</span><span class="s2">&quot;</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Post a message. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">begin</span>
    <span class="k">try</span> <span class="n">server</span><span class="o">#</span><span class="n">post</span> <span class="n">lines</span>
    <span class="k">with</span> <span class="nc">Failure</span> <span class="n">s</span> <span class="o">-&gt;</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Can&#39;t post: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">s</span><span class="o">;</span>
      <span class="n">exit</span> <span class="mi">1</span>
  <span class="k">end</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Get the complete list of newsgroups. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">groupmap</span> <span class="o">=</span> <span class="n">server</span><span class="o">#</span><span class="kt">list</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="nn">NNTP</span><span class="p">.</span><span class="nn">GroupMap</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">group</span> <span class="o">(</span><span class="n">last</span><span class="o">,</span> <span class="n">first</span><span class="o">,</span> <span class="n">flags</span><span class="o">)</span> <span class="o">-&gt;</span>
       <span class="k">if</span> <span class="n">flags</span> <span class="o">=</span> <span class="s2">&quot;y&quot;</span>
       <span class="k">then</span> <span class="c">(* I can post to [group] *)</span> <span class="bp">()</span><span class="o">)</span>
    <span class="n">groupmap</span>

<span class="c">(* @@PLEAC@@_18.5 *)</span>
<span class="c">(* Use Netpop, which is part of Ocamlnet. *)</span>
<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;pop&quot;</span><span class="o">;;</span>

<span class="c">(* To create a Netpop client, you need to look up the server address</span>
<span class="c">   and build a network connection first. Netpop uses wrappers called</span>
<span class="c">   Netchannels to abstract the input and output channels. *)</span>
<span class="k">let</span> <span class="n">inet_addr</span> <span class="o">=</span>
  <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">gethostbyname</span> <span class="n">mail_server</span><span class="o">).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">h_addr_list</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span>
<span class="k">let</span> <span class="n">addr</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">ADDR_INET</span> <span class="o">(</span><span class="n">inet_addr</span><span class="o">,</span> <span class="nn">Netpop</span><span class="p">.</span><span class="n">tcp_port</span><span class="o">)</span>
<span class="k">let</span> <span class="n">ic</span><span class="o">,</span> <span class="n">oc</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">open_connection</span> <span class="n">addr</span>
<span class="k">let</span> <span class="n">pop</span> <span class="o">=</span>
  <span class="k">new</span> <span class="nn">Netpop</span><span class="p">.</span><span class="n">client</span>
    <span class="o">(</span><span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">input_channel</span> <span class="n">ic</span><span class="o">)</span>
    <span class="o">(</span><span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">output_channel</span> <span class="n">oc</span><span class="o">)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">pop</span><span class="o">#</span><span class="n">user</span> <span class="n">username</span><span class="o">;</span>
  <span class="n">pop</span><span class="o">#</span><span class="n">pass</span> <span class="n">password</span>

<span class="c">(* Messages are retreived as a hashtable from message IDs to tuples,</span>
<span class="c">   each tuple containing the message size in bytes and a string of</span>
<span class="c">   server-specific extension data. *)</span>
<span class="k">let</span> <span class="n">messages</span> <span class="o">=</span> <span class="n">pop</span><span class="o">#</span><span class="kt">list</span> <span class="bp">()</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">msgid</span> <span class="o">(</span><span class="n">size</span><span class="o">,</span> <span class="n">ext</span><span class="o">)</span> <span class="o">-&gt;</span>
       <span class="k">let</span> <span class="n">message</span> <span class="o">=</span> <span class="n">pop</span><span class="o">#</span><span class="n">retr</span> <span class="n">msgid</span> <span class="k">in</span>
       <span class="c">(* message is a Netchannels.in_obj_channel *)</span>
       <span class="n">pop</span><span class="o">#</span><span class="n">dele</span> <span class="n">msgid</span><span class="o">)</span>
    <span class="n">messages</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Use pop#apop instead of pop#user/pop#pass to avoid sending passwords</span>
<span class="c">   in plaintext across the network. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">pop</span><span class="o">#</span><span class="n">apop</span> <span class="n">username</span> <span class="n">password</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Get a message by number and print it to the console. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Retrieving %d : %!&quot;</span> <span class="n">msgnum</span><span class="o">;</span>
  <span class="k">try</span>
    <span class="k">let</span> <span class="n">message</span> <span class="o">=</span> <span class="n">pop</span><span class="o">#</span><span class="n">retr</span> <span class="n">msgnum</span> <span class="k">in</span>
    <span class="n">print_newline</span> <span class="bp">()</span><span class="o">;</span>
    <span class="n">print_endline</span>
      <span class="o">(</span><span class="nn">Netchannels</span><span class="p">.</span><span class="n">string_of_in_obj_channel</span> <span class="n">message</span><span class="o">)</span>
  <span class="k">with</span> <span class="nn">Netpop</span><span class="p">.</span><span class="nc">Err_status</span> <span class="n">e</span> <span class="o">-&gt;</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;failed (%s)</span><span class="se">\n</span><span class="s2">%!&quot;</span> <span class="n">e</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Gracefully tear down the connection. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">pop</span><span class="o">#</span><span class="n">quit</span> <span class="bp">()</span><span class="o">;</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">shutdown_connection</span> <span class="n">ic</span><span class="o">;</span>
  <span class="n">close_out</span> <span class="n">oc</span>

<span class="c">(* @@PLEAC@@_18.6 *)</span>
<span class="c">(* To simulate a Telnet client with OCaml, you can use the</span>
<span class="c">   Telnet_client module from Ocamlnet&#39;s &quot;netclient&quot; package.</span>

<span class="c">   This module is written in an asynchronous style, so you</span>
<span class="c">   will need to create event handlers to process the Telnet</span>
<span class="c">   events that occur: data, end of file, timeout, and the</span>
<span class="c">   sending and receiving of options (also known as &quot;do&quot;,</span>
<span class="c">   &quot;don&#39;t&quot;, &quot;will&quot;, and &quot;won&#39;t&quot;. *)</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netclient&quot;</span><span class="o">;;</span>

<span class="k">open</span> <span class="nc">Telnet_client</span>

<span class="c">(* This class wraps the Telnet session for convenience in</span>
<span class="c">   defining event handlers and chaining them together. *)</span>
<span class="k">class</span> <span class="n">session</span> <span class="o">~</span><span class="n">host</span> <span class="o">~</span><span class="n">port</span> <span class="o">~</span><span class="n">username</span> <span class="o">~</span><span class="n">password</span> <span class="o">~</span><span class="n">prompt</span> <span class="o">~</span><span class="n">timeout</span> <span class="o">=</span>
<span class="k">object</span> <span class="o">(</span><span class="n">self</span><span class="o">)</span>
  <span class="c">(* Telnet_client.telnet_session instance to wrap. *)</span>
  <span class="k">val</span> <span class="n">telnet</span> <span class="o">=</span> <span class="k">new</span> <span class="n">telnet_session</span>

  <span class="c">(* Initial on-data handler, which will be redefined later. *)</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">process</span> <span class="o">=</span> <span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span>

  <span class="c">(* Initialize the Telnet session. *)</span>
  <span class="k">initializer</span>
    <span class="n">telnet</span><span class="o">#</span><span class="n">set_connection</span> <span class="o">(</span><span class="nc">Telnet_connect</span> <span class="o">(</span><span class="n">host</span><span class="o">,</span> <span class="n">port</span><span class="o">));</span>
    <span class="n">telnet</span><span class="o">#</span><span class="n">set_options</span> <span class="o">{</span><span class="n">connection_timeout</span><span class="o">=</span><span class="n">timeout</span><span class="o">;</span>
                        <span class="n">verbose_connection</span><span class="o">=</span><span class="bp">false</span><span class="o">;</span>
                        <span class="n">verbose_input</span><span class="o">=</span><span class="bp">false</span><span class="o">;</span>
                        <span class="n">verbose_output</span><span class="o">=</span><span class="bp">false</span><span class="o">};</span>
    <span class="n">telnet</span><span class="o">#</span><span class="n">set_callback</span> <span class="n">self</span><span class="o">#</span><span class="n">on_input</span><span class="o">;</span>
    <span class="n">telnet</span><span class="o">#</span><span class="n">set_exception_handler</span> <span class="n">self</span><span class="o">#</span><span class="n">on_exception</span><span class="o">;</span>
    <span class="n">telnet</span><span class="o">#</span><span class="n">attach</span> <span class="bp">()</span><span class="o">;</span>
    <span class="n">process</span> <span class="o">&lt;-</span> <span class="n">self</span><span class="o">#</span><span class="n">start</span>

  <span class="c">(* Build an input callback that checks for a regular</span>
<span class="c">     expression match in the input and calls a callback</span>
<span class="c">     function if the match is positive. *)</span>
  <span class="k">method</span> <span class="n">waitfor</span> <span class="n">pat</span> <span class="n">cb</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">rex</span> <span class="o">=</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">regexp</span> <span class="n">pat</span> <span class="k">in</span>
    <span class="k">fun</span> <span class="n">data</span> <span class="o">-&gt;</span> <span class="k">if</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span> <span class="o">~</span><span class="n">rex</span> <span class="n">data</span> <span class="k">then</span> <span class="n">cb</span> <span class="n">data</span>

  <span class="c">(* Enqueue a line of data and flush the output queue. *)</span>
  <span class="k">method</span> <span class="n">write</span> <span class="n">data</span> <span class="o">=</span>
    <span class="nn">Queue</span><span class="p">.</span><span class="n">add</span> <span class="o">(</span><span class="nc">Telnet_data</span> <span class="n">data</span><span class="o">)</span> <span class="n">telnet</span><span class="o">#</span><span class="n">output_queue</span><span class="o">;</span>
    <span class="nn">Queue</span><span class="p">.</span><span class="n">add</span> <span class="o">(</span><span class="nc">Telnet_data</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span> <span class="n">telnet</span><span class="o">#</span><span class="n">output_queue</span><span class="o">;</span>
    <span class="n">telnet</span><span class="o">#</span><span class="n">update</span> <span class="bp">()</span>

  <span class="c">(* Handle first input: wait for a login prompt and then</span>
<span class="c">     invoke self#send_username to send the username. *)</span>
  <span class="k">method</span> <span class="n">start</span> <span class="o">=</span>
    <span class="n">self</span><span class="o">#</span><span class="n">waitfor</span> <span class="s2">&quot;ogin:&quot;</span> <span class="n">self</span><span class="o">#</span><span class="n">send_username</span>

  <span class="c">(* Send the username and wait for the password prompt. *)</span>
  <span class="k">method</span> <span class="n">send_username</span> <span class="n">data</span> <span class="o">=</span>
    <span class="n">self</span><span class="o">#</span><span class="n">write</span> <span class="n">username</span><span class="o">;</span>
    <span class="n">process</span> <span class="o">&lt;-</span> <span class="n">self</span><span class="o">#</span><span class="n">waitfor</span> <span class="s2">&quot;assword:&quot;</span> <span class="n">self</span><span class="o">#</span><span class="n">send_password</span>

  <span class="c">(* Send the password and wait to see if we succeeded. *)</span>
  <span class="k">method</span> <span class="n">send_password</span> <span class="n">data</span> <span class="o">=</span>
    <span class="n">self</span><span class="o">#</span><span class="n">write</span> <span class="n">password</span><span class="o">;</span>
    <span class="n">process</span> <span class="o">&lt;-</span> <span class="n">self</span><span class="o">#</span><span class="n">verify_login</span>

  <span class="c">(* Determine if the login was a success or a failure.</span>
<span class="c">     Abort with an exception on failure; call self#logged_in</span>
<span class="c">     on success. *)</span>
  <span class="k">method</span> <span class="n">verify_login</span> <span class="n">data</span> <span class="o">=</span>
    <span class="k">if</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;incorrect&quot;</span> <span class="n">data</span>
    <span class="k">then</span> <span class="n">failwith</span> <span class="s2">&quot;Login failed&quot;</span>
    <span class="k">else</span> <span class="k">if</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;^</span><span class="se">\\</span><span class="s2">s*$&quot;</span> <span class="n">data</span>
    <span class="k">then</span> <span class="bp">()</span> <span class="c">(* ignore blank lines *)</span>
    <span class="k">else</span> <span class="n">self</span><span class="o">#</span><span class="n">logged_in</span> <span class="n">data</span>

  <span class="c">(* Logged in successfully. Wait for a prompt if necessary</span>
<span class="c">     and call self#run_ls to send the first command. *)</span>
  <span class="k">method</span> <span class="n">logged_in</span> <span class="n">data</span> <span class="o">=</span>
    <span class="n">process</span> <span class="o">&lt;-</span> <span class="n">self</span><span class="o">#</span><span class="n">waitfor</span> <span class="n">prompt</span> <span class="n">self</span><span class="o">#</span><span class="n">run_ls</span><span class="o">;</span>
    <span class="n">self</span><span class="o">#</span><span class="n">waitfor</span> <span class="n">prompt</span> <span class="n">self</span><span class="o">#</span><span class="n">run_ls</span> <span class="n">data</span>

  <span class="c">(* Do a directory listing and wait for results. *)</span>
  <span class="k">method</span> <span class="n">run_ls</span> <span class="n">data</span> <span class="o">=</span>
    <span class="n">self</span><span class="o">#</span><span class="n">write</span> <span class="s2">&quot;/bin/ls -1&quot;</span><span class="o">;</span>
    <span class="n">process</span> <span class="o">&lt;-</span> <span class="n">self</span><span class="o">#</span><span class="n">gather_files</span>

  <span class="c">(* This variable will buffer the results of the &quot;ls&quot; command. *)</span>
  <span class="k">val</span> <span class="k">mutable</span> <span class="n">files</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

  <span class="c">(* Buffer the filenames printed out from the &quot;ls&quot; command and</span>
<span class="c">     print them out once we get a prompt. *)</span>
  <span class="k">method</span> <span class="n">gather_files</span> <span class="n">data</span> <span class="o">=</span>
    <span class="k">if</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">pmatch</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="n">prompt</span> <span class="n">data</span>
    <span class="k">then</span>
      <span class="k">begin</span>
        <span class="n">files</span> <span class="o">&lt;-</span> <span class="nn">Pcre</span><span class="p">.</span><span class="n">replace</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;^/bin/ls -1</span><span class="se">\\</span><span class="s2">s*&quot;</span> <span class="n">files</span><span class="o">;</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span>
          <span class="s2">&quot;Files: %s</span><span class="se">\n</span><span class="s2">%!&quot;</span>
          <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;, &quot;</span>
             <span class="o">(</span><span class="nn">Pcre</span><span class="p">.</span><span class="n">split</span> <span class="o">~</span><span class="n">pat</span><span class="o">:</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">s+&quot;</span> <span class="n">files</span><span class="o">));</span>
        <span class="n">self</span><span class="o">#</span><span class="n">run_top</span> <span class="n">data</span>
      <span class="k">end</span>
    <span class="k">else</span> <span class="n">files</span> <span class="o">&lt;-</span> <span class="n">files</span> <span class="o">^</span> <span class="n">data</span>

  <span class="c">(* Run another command until we get a prompt and then call</span>
<span class="c">     self#close to close the connection. *)</span>
  <span class="k">method</span> <span class="n">run_top</span> <span class="n">data</span> <span class="o">=</span>
    <span class="n">self</span><span class="o">#</span><span class="n">write</span> <span class="s2">&quot;top -n1 -b&quot;</span><span class="o">;</span>
    <span class="n">process</span> <span class="o">&lt;-</span> <span class="n">self</span><span class="o">#</span><span class="n">waitfor</span> <span class="n">prompt</span> <span class="n">self</span><span class="o">#</span><span class="n">close</span>

  <span class="c">(* Close the connection by sending an EOF. *)</span>
  <span class="k">method</span> <span class="n">close</span> <span class="n">data</span> <span class="o">=</span>
    <span class="nn">Queue</span><span class="p">.</span><span class="n">add</span> <span class="nc">Telnet_eof</span> <span class="n">telnet</span><span class="o">#</span><span class="n">output_queue</span>

  <span class="c">(* When we receive an EOF, exit the program. *)</span>
  <span class="k">method</span> <span class="n">on_eof</span> <span class="bp">()</span> <span class="o">=</span>
    <span class="n">prerr_endline</span> <span class="s2">&quot;EOF&quot;</span><span class="o">;</span>
    <span class="n">exit</span> <span class="mi">0</span>

  <span class="c">(* If a timeout event is received, exit with an error code. *)</span>
  <span class="k">method</span> <span class="n">on_timeout</span> <span class="bp">()</span> <span class="o">=</span>
    <span class="n">prerr_endline</span> <span class="s2">&quot;Timeout&quot;</span><span class="o">;</span>
    <span class="n">exit</span> <span class="mi">1</span>

  <span class="c">(* Print any thrown exceptions to standard error. *)</span>
  <span class="k">method</span> <span class="n">on_exception</span> <span class="n">exn</span> <span class="o">=</span>
    <span class="n">prerr_endline</span> <span class="o">(</span><span class="nn">Printexc</span><span class="p">.</span><span class="n">to_string</span> <span class="n">exn</span><span class="o">)</span>

  <span class="c">(* This is the main error handler, which dispatches on</span>
<span class="c">     Telnet_client events. *)</span>
  <span class="k">method</span> <span class="n">on_input</span> <span class="n">got_synch</span> <span class="o">=</span>
    <span class="k">while</span> <span class="n">not</span> <span class="o">(</span><span class="nn">Queue</span><span class="p">.</span><span class="n">is_empty</span> <span class="n">telnet</span><span class="o">#</span><span class="n">input_queue</span><span class="o">)</span> <span class="k">do</span>
      <span class="k">let</span> <span class="n">tc</span> <span class="o">=</span> <span class="nn">Queue</span><span class="p">.</span><span class="n">take</span> <span class="n">telnet</span><span class="o">#</span><span class="n">input_queue</span> <span class="k">in</span>
      <span class="k">match</span> <span class="n">tc</span> <span class="k">with</span>
        <span class="o">|</span> <span class="nc">Telnet_data</span> <span class="n">data</span> <span class="o">-&gt;</span> <span class="n">process</span> <span class="n">data</span>
	    <span class="o">|</span> <span class="nc">Telnet_eof</span> <span class="o">-&gt;</span> <span class="n">self</span><span class="o">#</span><span class="n">on_eof</span> <span class="bp">()</span>
	    <span class="o">|</span> <span class="nc">Telnet_timeout</span> <span class="o">-&gt;</span> <span class="n">self</span><span class="o">#</span><span class="n">on_timeout</span> <span class="bp">()</span>
        <span class="o">|</span> <span class="nc">Telnet_will</span> <span class="o">_</span>
        <span class="o">|</span> <span class="nc">Telnet_wont</span> <span class="o">_</span>
        <span class="o">|</span> <span class="nc">Telnet_do</span> <span class="o">_</span>
        <span class="o">|</span> <span class="nc">Telnet_dont</span> <span class="o">_</span> <span class="o">-&gt;</span>
            <span class="c">(* The telnet_session handles these events.</span>
<span class="c">               Calling this method is necessary. *)</span>
            <span class="n">telnet</span><span class="o">#</span><span class="n">process_option_command</span> <span class="n">tc</span>
	    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span>
    <span class="k">done</span>

  <span class="c">(* Run the Telnet session by calling the &quot;run&quot; method on</span>
<span class="c">     the underling telnet_session instance. *)</span>
  <span class="k">method</span> <span class="n">run</span> <span class="o">=</span> <span class="n">telnet</span><span class="o">#</span><span class="n">run</span>
<span class="k">end</span>

<span class="c">(* Create an instance of our custom session class. *)</span>
<span class="k">let</span> <span class="n">session</span> <span class="o">=</span>
  <span class="k">new</span> <span class="n">session</span>
    <span class="o">~</span><span class="n">host</span><span class="o">:</span><span class="s2">&quot;localhost&quot;</span>
    <span class="o">~</span><span class="n">port</span><span class="o">:</span><span class="mi">23</span>
    <span class="o">~</span><span class="n">username</span><span class="o">:</span><span class="s2">&quot;test&quot;</span>
    <span class="o">~</span><span class="n">password</span><span class="o">:</span><span class="s2">&quot;pleac&quot;</span>
    <span class="o">~</span><span class="n">prompt</span><span class="o">:</span><span class="s2">&quot;</span><span class="se">\\</span><span class="s2">$ $&quot;</span>
    <span class="o">~</span><span class="n">timeout</span><span class="o">:</span><span class="mi">10</span><span class="o">.</span>

<span class="c">(* Start the session. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">session</span><span class="o">#</span><span class="n">run</span> <span class="bp">()</span>

<span class="c">(* @@PLEAC@@_18.7 *)</span>
<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* ping - send and receive ICMP echo packets *)</span>

<span class="c">(* There do not appear to be any libraries available for pinging</span>
<span class="c">   servers from OCaml, ICMP or otherwise. In this recipe, we will</span>
<span class="c">   make a diversion from the Perl recipe, which simply determines</span>
<span class="c">   if a host is up, and instead write a lookalike for the &quot;ping&quot;</span>
<span class="c">   shell command. We might as well, if we&#39;re going to all the</span>
<span class="c">   trouble of building ICMP packets directly. *)</span>

<span class="c">(* Import Unix and enable threads using findlib for convenience. *)</span>
<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;unix&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">thread</span><span class="o">;;</span>

<span class="c">(* The Packet module defines a data type and operations for building,</span>
<span class="c">   parsing, and checking the integrity of ICMP packets. *)</span>
<span class="k">module</span> <span class="nc">Packet</span> <span class="o">=</span> <span class="k">struct</span>
  <span class="k">exception</span> <span class="nc">Invalid_length</span> <span class="k">of</span> <span class="kt">int</span>
  <span class="k">exception</span> <span class="nc">Invalid_checksum</span> <span class="k">of</span> <span class="kt">int</span> <span class="o">*</span> <span class="kt">int</span>

  <span class="c">(* type&#39; and code define the ICMP message type. An echo message</span>
<span class="c">     has type&#39;=8, code=0, and an echo reply has type&#39;=0, code=0.</span>
<span class="c">     The id is a unique identifier for the current process to help</span>
<span class="c">     distinguish between replies for other processes. seq is the</span>
<span class="c">     sequence number, which is usually incremented with each message.</span>
<span class="c">     data is the message body whose contents depend on the type of</span>
<span class="c">     message. *)</span>
  <span class="k">type</span> <span class="n">t</span> <span class="o">=</span> <span class="o">{</span> <span class="k">type&#39;</span> <span class="o">:</span> <span class="kt">int</span><span class="o">;</span>
             <span class="n">code</span> <span class="o">:</span> <span class="kt">int</span><span class="o">;</span>
             <span class="n">id</span> <span class="o">:</span> <span class="kt">int</span><span class="o">;</span>
             <span class="n">seq</span> <span class="o">:</span> <span class="kt">int</span><span class="o">;</span>
             <span class="n">data</span> <span class="o">:</span> <span class="kt">string</span> <span class="o">}</span>

  <span class="c">(* Define a convenience function for constructing packets. *)</span>
  <span class="k">let</span> <span class="n">make</span> <span class="o">?(</span><span class="k">type&#39;</span><span class="o">=</span><span class="mi">8</span><span class="o">)</span> <span class="o">?(</span><span class="n">code</span><span class="o">=</span><span class="mi">0</span><span class="o">)</span> <span class="o">~</span><span class="n">id</span> <span class="o">~</span><span class="n">seq</span> <span class="n">data</span> <span class="o">=</span>
    <span class="o">{</span><span class="k">type&#39;</span><span class="o">=</span><span class="k">type&#39;</span><span class="o">;</span> <span class="n">code</span><span class="o">=</span><span class="n">code</span><span class="o">;</span> <span class="n">id</span><span class="o">=</span><span class="n">id</span><span class="o">;</span> <span class="n">seq</span><span class="o">=</span><span class="n">seq</span><span class="o">;</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="o">}</span>

  <span class="c">(* Calculate a checksum for a message by adding its contents, two</span>
<span class="c">     bytes at a time, folding the high order bits into the low order</span>
<span class="c">     bits, and taking the logical complement. The result will be an</span>
<span class="c">     int with 16-bit precision. *)</span>
  <span class="k">let</span> <span class="n">checksum</span> <span class="n">s</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">num_bytes</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">num_shorts</span> <span class="o">=</span> <span class="n">num_bytes</span> <span class="o">/</span> <span class="mi">2</span> <span class="k">in</span>
    <span class="k">let</span> <span class="k">rec</span> <span class="n">sum_shorts</span> <span class="n">i</span> <span class="n">sum</span> <span class="o">=</span>
      <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_shorts</span> <span class="k">then</span>
        <span class="k">let</span> <span class="n">short</span> <span class="o">=</span> <span class="nn">Int32</span><span class="p">.</span><span class="n">of_int</span> <span class="o">(</span><span class="n">int_of_char</span> <span class="n">s</span><span class="o">.[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="o">]</span> <span class="ow">lsl</span> <span class="mi">8</span>
                                  <span class="o">+</span> <span class="n">int_of_char</span> <span class="n">s</span><span class="o">.[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="o">])</span> <span class="k">in</span>
        <span class="n">sum_shorts</span> <span class="o">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">(</span><span class="nn">Int32</span><span class="p">.</span><span class="n">add</span> <span class="n">sum</span> <span class="n">short</span><span class="o">)</span>
      <span class="k">else</span> <span class="n">sum</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">sum_shorts</span> <span class="mi">0</span> <span class="mi">0</span><span class="n">l</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">sum</span> <span class="o">=</span>
      <span class="k">if</span> <span class="n">num_bytes</span> <span class="ow">mod</span> <span class="mi">2</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">then</span>
        <span class="nn">Int32</span><span class="p">.</span><span class="n">add</span> <span class="n">sum</span>
          <span class="o">(</span><span class="nn">Int32</span><span class="p">.</span><span class="n">of_int</span> <span class="o">(</span><span class="n">int_of_char</span> <span class="n">s</span><span class="o">.[</span><span class="n">num_bytes</span> <span class="o">-</span> <span class="mi">1</span><span class="o">]</span> <span class="ow">lsl</span> <span class="mi">8</span><span class="o">))</span>
      <span class="k">else</span> <span class="n">sum</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">sum</span> <span class="o">=</span>
      <span class="nn">Int32</span><span class="p">.</span><span class="n">add</span>
        <span class="o">(</span><span class="nn">Int32</span><span class="p">.</span><span class="n">shift_right</span> <span class="n">sum</span> <span class="mi">16</span><span class="o">)</span>
        <span class="o">(</span><span class="nn">Int32</span><span class="p">.</span><span class="n">logand</span> <span class="n">sum</span> <span class="mh">0xffff</span><span class="n">l</span><span class="o">)</span> <span class="k">in</span>
    <span class="nn">Int32</span><span class="p">.</span><span class="n">to_int</span>
      <span class="o">(</span><span class="nn">Int32</span><span class="p">.</span><span class="n">logand</span>
         <span class="o">(</span><span class="nn">Int32</span><span class="p">.</span><span class="n">lognot</span> <span class="o">(</span><span class="nn">Int32</span><span class="p">.</span><span class="n">add</span> <span class="o">(</span><span class="nn">Int32</span><span class="p">.</span><span class="n">shift_right</span> <span class="n">sum</span> <span class="mi">16</span><span class="o">)</span> <span class="n">sum</span><span class="o">))</span>
         <span class="mh">0xffff</span><span class="n">l</span><span class="o">)</span>

  <span class="c">(* Convert a packet to a string that can be sent over a socket. *)</span>
  <span class="k">let</span> <span class="n">to_string</span> <span class="o">{</span><span class="k">type&#39;</span><span class="o">=</span><span class="k">type&#39;</span><span class="o">;</span> <span class="n">code</span><span class="o">=</span><span class="n">code</span><span class="o">;</span> <span class="n">id</span><span class="o">=</span><span class="n">id</span><span class="o">;</span> <span class="n">seq</span><span class="o">=</span><span class="n">seq</span><span class="o">;</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="o">}</span> <span class="o">=</span>
    <span class="k">let</span> <span class="n">b</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">create</span> <span class="mi">20</span> <span class="k">in</span>
    <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_char</span> <span class="n">b</span> <span class="o">(</span><span class="n">char_of_int</span> <span class="k">type&#39;</span><span class="o">);</span>
    <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_char</span> <span class="n">b</span> <span class="o">(</span><span class="n">char_of_int</span> <span class="n">code</span><span class="o">);</span>
    <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_char</span> <span class="n">b</span> <span class="sc">&#39;\000&#39;</span><span class="o">;</span>  <span class="c">(* checksum hi *)</span>
    <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_char</span> <span class="n">b</span> <span class="sc">&#39;\000&#39;</span><span class="o">;</span>  <span class="c">(* checksum lo *)</span>
    <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_char</span> <span class="n">b</span> <span class="o">(</span><span class="n">char_of_int</span> <span class="o">(</span><span class="n">id</span> <span class="n">lsr</span> <span class="mi">8</span> <span class="ow">land</span> <span class="mh">0xff</span><span class="o">));</span>
    <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_char</span> <span class="n">b</span> <span class="o">(</span><span class="n">char_of_int</span> <span class="o">(</span><span class="n">id</span> <span class="ow">land</span> <span class="mh">0xff</span><span class="o">));</span>
    <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_char</span> <span class="n">b</span> <span class="o">(</span><span class="n">char_of_int</span> <span class="o">(</span><span class="n">seq</span> <span class="n">lsr</span> <span class="mi">8</span> <span class="ow">land</span> <span class="mh">0xff</span><span class="o">));</span>
    <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_char</span> <span class="n">b</span> <span class="o">(</span><span class="n">char_of_int</span> <span class="o">(</span><span class="n">seq</span> <span class="ow">land</span> <span class="mh">0xff</span><span class="o">));</span>
    <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_string</span> <span class="n">b</span> <span class="n">data</span><span class="o">;</span>
    <span class="k">let</span> <span class="n">packet</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">contents</span> <span class="n">b</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">checksum</span> <span class="n">packet</span> <span class="k">in</span>
    <span class="n">packet</span><span class="o">.[</span><span class="mi">2</span><span class="o">]</span> <span class="o">&lt;-</span> <span class="n">char_of_int</span> <span class="o">(</span><span class="n">sum</span> <span class="n">lsr</span> <span class="mi">8</span> <span class="ow">land</span> <span class="mh">0xff</span><span class="o">);</span>
    <span class="n">packet</span><span class="o">.[</span><span class="mi">3</span><span class="o">]</span> <span class="o">&lt;-</span> <span class="n">char_of_int</span> <span class="o">(</span><span class="n">sum</span> <span class="ow">land</span> <span class="mh">0xff</span><span class="o">);</span>
    <span class="n">packet</span>

  <span class="c">(* Parse a string into a packet structure. If the string is less than</span>
<span class="c">     8 bytes long, an Invalid_length exception will be raised. If the</span>
<span class="c">     checksum does not match the contents, an Invalid_checksum</span>
<span class="c">     exception will be raised. *)</span>
  <span class="k">let</span> <span class="n">of_string</span> <span class="n">s</span> <span class="o">=</span>
    <span class="k">if</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="k">then</span> <span class="k">raise</span> <span class="o">(</span><span class="nc">Invalid_length</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span><span class="o">));</span>
    <span class="k">let</span> <span class="n">s&#39;</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">copy</span> <span class="n">s</span> <span class="k">in</span>
    <span class="n">s&#39;</span><span class="o">.[</span><span class="mi">2</span><span class="o">]</span> <span class="o">&lt;-</span> <span class="sc">&#39;\000&#39;</span><span class="o">;</span>
    <span class="n">s&#39;</span><span class="o">.[</span><span class="mi">3</span><span class="o">]</span> <span class="o">&lt;-</span> <span class="sc">&#39;\000&#39;</span><span class="o">;</span>
    <span class="k">let</span> <span class="n">sum</span> <span class="o">=</span> <span class="n">int_of_char</span> <span class="n">s</span><span class="o">.[</span><span class="mi">2</span><span class="o">]</span> <span class="ow">lsl</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">int_of_char</span> <span class="n">s</span><span class="o">.[</span><span class="mi">3</span><span class="o">]</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">sum&#39;</span> <span class="o">=</span> <span class="n">checksum</span> <span class="n">s&#39;</span> <span class="k">in</span>
    <span class="k">if</span> <span class="n">sum</span> <span class="o">&lt;&gt;</span> <span class="n">sum&#39;</span> <span class="k">then</span> <span class="k">raise</span> <span class="o">(</span><span class="nc">Invalid_checksum</span> <span class="o">(</span><span class="n">sum</span><span class="o">,</span> <span class="n">sum&#39;</span><span class="o">));</span>
    <span class="o">{</span><span class="k">type&#39;</span><span class="o">=</span><span class="n">int_of_char</span> <span class="n">s</span><span class="o">.[</span><span class="mi">0</span><span class="o">];</span>
     <span class="n">code</span><span class="o">=</span><span class="n">int_of_char</span> <span class="n">s</span><span class="o">.[</span><span class="mi">1</span><span class="o">];</span>
     <span class="n">id</span><span class="o">=</span><span class="n">int_of_char</span> <span class="n">s</span><span class="o">.[</span><span class="mi">4</span><span class="o">]</span> <span class="ow">lsl</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">int_of_char</span> <span class="n">s</span><span class="o">.[</span><span class="mi">5</span><span class="o">];</span>
     <span class="n">seq</span><span class="o">=</span><span class="n">int_of_char</span> <span class="n">s</span><span class="o">.[</span><span class="mi">6</span><span class="o">]</span> <span class="ow">lsl</span> <span class="mi">8</span> <span class="o">+</span> <span class="n">int_of_char</span> <span class="n">s</span><span class="o">.[</span><span class="mi">7</span><span class="o">];</span>
     <span class="n">data</span><span class="o">=</span><span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">s</span> <span class="mi">8</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span> <span class="o">-</span> <span class="mi">8</span><span class="o">)}</span>
<span class="k">end</span>

<span class="c">(* Define a data structure for the message body of our echo requests. *)</span>
<span class="k">type</span> <span class="n">payload</span> <span class="o">=</span> <span class="o">{</span> <span class="n">timestamp</span> <span class="o">:</span> <span class="kt">float</span><span class="o">;</span> <span class="n">data</span> <span class="o">:</span> <span class="kt">string</span> <span class="o">}</span>

<span class="c">(* Send a single ICMP echo request to the given socket and address. *)</span>
<span class="k">let</span> <span class="n">ping</span> <span class="n">socket</span> <span class="n">sockaddr</span> <span class="n">id</span> <span class="n">seq</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">payload</span> <span class="o">=</span>
    <span class="nn">Marshal</span><span class="p">.</span><span class="n">to_string</span> <span class="o">{</span><span class="n">timestamp</span><span class="o">=</span><span class="nn">Unix</span><span class="p">.</span><span class="n">gettimeofday</span> <span class="bp">()</span><span class="o">;</span>
                       <span class="n">data</span><span class="o">=</span><span class="s2">&quot;abcdefghijklmnopqrstuvwxyz0123456&quot;</span><span class="o">}</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">message</span> <span class="o">=</span> <span class="nn">Packet</span><span class="p">.</span><span class="n">to_string</span> <span class="o">(</span><span class="nn">Packet</span><span class="p">.</span><span class="n">make</span> <span class="o">~</span><span class="n">id</span> <span class="o">~</span><span class="n">seq</span> <span class="n">payload</span><span class="o">)</span> <span class="k">in</span>
  <span class="n">ignore</span>
    <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">sendto</span> <span class="n">socket</span> <span class="n">message</span> <span class="mi">0</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">message</span><span class="o">)</span> <span class="bp">[]</span> <span class="n">sockaddr</span><span class="o">)</span>

<span class="c">(* Loop forever waiting for echo replies, printing them to the</span>
<span class="c">   console along with their hostname, IP, and round-trip time. *)</span>
<span class="k">let</span> <span class="n">pong</span> <span class="n">socket</span> <span class="n">id</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="mi">256</span> <span class="sc">&#39;\000&#39;</span> <span class="k">in</span>
  <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
    <span class="k">let</span> <span class="n">length</span><span class="o">,</span> <span class="n">sockaddr</span> <span class="o">=</span>
      <span class="nn">Unix</span><span class="p">.</span><span class="n">recvfrom</span> <span class="n">socket</span> <span class="n">buffer</span> <span class="mi">0</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">buffer</span><span class="o">)</span> <span class="bp">[]</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">response</span> <span class="o">=</span>
      <span class="nn">Packet</span><span class="p">.</span><span class="n">of_string</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">buffer</span> <span class="mi">20</span> <span class="o">(</span><span class="n">length</span> <span class="o">-</span> <span class="mi">20</span><span class="o">))</span> <span class="k">in</span>
    <span class="k">match</span> <span class="n">sockaddr</span><span class="o">,</span> <span class="n">response</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">ADDR_INET</span> <span class="o">(</span><span class="n">addr</span><span class="o">,</span> <span class="n">port</span><span class="o">),</span>
        <span class="o">{</span><span class="nn">Packet</span><span class="p">.</span><span class="n">type&#39;</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">code</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span> <span class="n">id</span><span class="o">=</span><span class="n">id&#39;</span><span class="o">;</span> <span class="n">seq</span><span class="o">=</span><span class="n">seq</span><span class="o">;</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="o">}</span>
          <span class="k">when</span> <span class="n">id</span> <span class="o">=</span> <span class="n">id&#39;</span> <span class="o">-&gt;</span>
          <span class="k">let</span> <span class="n">host_entry</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">gethostbyaddr</span> <span class="n">addr</span> <span class="k">in</span>
          <span class="k">let</span> <span class="n">payload</span> <span class="o">=</span> <span class="nn">Marshal</span><span class="p">.</span><span class="n">from_string</span> <span class="n">data</span> <span class="mi">0</span> <span class="k">in</span>
          <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span>
            <span class="s2">&quot;%d bytes from %s (%s): icmp_seq=%d time=%.3f ms</span><span class="se">\n</span><span class="s2">%!&quot;</span>
            <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">data</span><span class="o">)</span>
            <span class="n">host_entry</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">h_name</span>
            <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">string_of_inet_addr</span> <span class="n">addr</span><span class="o">)</span>
            <span class="n">seq</span>
            <span class="o">((</span><span class="nn">Unix</span><span class="p">.</span><span class="n">gettimeofday</span> <span class="bp">()</span> <span class="o">-.</span> <span class="n">payload</span><span class="o">.</span><span class="n">timestamp</span><span class="o">)</span> <span class="o">*.</span> <span class="mi">1000</span><span class="o">.)</span>
      <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span>
  <span class="k">done</span>

<span class="c">(* Read hostname from command line. *)</span>
<span class="k">let</span> <span class="n">host</span> <span class="o">=</span>
  <span class="k">if</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="o">&lt;&gt;</span> <span class="mi">2</span>
  <span class="k">then</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Usage: %s host</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">);</span> <span class="n">exit</span> <span class="mi">1</span><span class="o">)</span>
  <span class="k">else</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span>

<span class="c">(* Use DNS to find the IP address and canonical name. *)</span>
<span class="k">let</span> <span class="n">name</span><span class="o">,</span> <span class="n">addr</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">let</span> <span class="n">h</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">gethostbyname</span> <span class="n">host</span> <span class="k">in</span>
    <span class="n">h</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">h_name</span><span class="o">,</span> <span class="n">h</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">h_addr_list</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span>
  <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s: unknown host %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span> <span class="n">host</span><span class="o">;</span>
    <span class="n">exit</span> <span class="mi">2</span>

<span class="c">(* Make sure we are running as root, since this is required to</span>
<span class="c">   open a socket with SOCK_RAW and send ICMP packets. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">getuid</span> <span class="bp">()</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span>
  <span class="k">then</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s: icmp ping requires root privilege</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">);</span>
        <span class="n">exit</span> <span class="mi">3</span><span class="o">)</span>

<span class="c">(* Start the ping loop. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;PING %s (%s)</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">name</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">string_of_inet_addr</span> <span class="n">addr</span><span class="o">);</span>

  <span class="c">(* Build a socket and destination address. *)</span>
  <span class="k">let</span> <span class="n">proto</span> <span class="o">=</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">getprotobyname</span> <span class="s2">&quot;icmp&quot;</span><span class="o">).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">p_proto</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">socket</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">socket</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">PF_INET</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">SOCK_RAW</span> <span class="n">proto</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">sockaddr</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">ADDR_INET</span> <span class="o">(</span><span class="n">addr</span><span class="o">,</span> <span class="mi">0</span><span class="o">)</span> <span class="k">in</span>

  <span class="c">(* Use the PID as the ID for packets, and create a counter for</span>
<span class="c">     the sequence number. *)</span>
  <span class="k">let</span> <span class="n">id</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">getpid</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">seq</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>

  <span class="c">(* Start a background thread to print the echo replies. *)</span>
  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Thread</span><span class="p">.</span><span class="n">create</span> <span class="o">(</span><span class="n">pong</span> <span class="n">socket</span><span class="o">)</span> <span class="n">id</span><span class="o">);</span>

  <span class="c">(* Loop forever sending echo requests and sleeping. *)</span>
  <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
    <span class="n">incr</span> <span class="n">seq</span><span class="o">;</span>
    <span class="n">ping</span> <span class="n">socket</span> <span class="n">sockaddr</span> <span class="n">id</span> <span class="o">!</span><span class="n">seq</span><span class="o">;</span>
    <span class="nn">Unix</span><span class="p">.</span><span class="n">sleep</span> <span class="mi">1</span>
  <span class="k">done</span>

<span class="c">(* @@PLEAC@@_18.8 *)</span>
<span class="c">(* WHOIS servers depend on the TLD, and their output formats are</span>
<span class="c">   informal, inconsistent, and completely different from server</span>
<span class="c">   to server. This makes a general solution very large and ad-hoc.</span>
<span class="c">   The Net::Whois package, on which the original Perl recipe was</span>
<span class="c">   based, no longer works since WHOIS servers started redirecting</span>
<span class="c">   to other servers for most of the information.</span>

<span class="c">   Since no libraries are available for this task, we will do a</span>
<span class="c">   WHOIS lookup manually using sockets. This example shows how to</span>
<span class="c">   perform a WHOIS lookup for the &quot;sourceforge.net&quot; domain, and</span>
<span class="c">   probably will not work without modification for domains under</span>
<span class="c">   any other TLD. *)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">domain_name</span> <span class="o">=</span> <span class="s2">&quot;sourceforge.net&quot;</span>
<span class="k">let</span> <span class="n">whois_server</span> <span class="o">=</span> <span class="s2">&quot;whois.internic.net&quot;</span>
<span class="k">let</span> <span class="n">service</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">getservbyname</span> <span class="s2">&quot;whois&quot;</span> <span class="s2">&quot;tcp&quot;</span>

<span class="k">let</span> <span class="n">ltrim</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">re</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;^[ </span><span class="se">\r\n\t\x00\x0B</span><span class="s2">]*&quot;</span> <span class="k">in</span>
  <span class="nn">Str</span><span class="p">.</span><span class="n">global_replace</span> <span class="n">re</span> <span class="s2">&quot;&quot;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="c">(* Connect to the parent server to find the redirect. *)</span>

  <span class="k">let</span> <span class="n">host</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">gethostbyname</span> <span class="n">whois_server</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">socket_in</span><span class="o">,</span> <span class="n">socket_out</span> <span class="o">=</span>
    <span class="nn">Unix</span><span class="p">.</span><span class="n">open_connection</span>
      <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">ADDR_INET</span> <span class="o">(</span><span class="n">host</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">h_addr_list</span><span class="o">.(</span><span class="mi">0</span><span class="o">),</span>
                       <span class="n">service</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">s_port</span><span class="o">))</span> <span class="k">in</span>

  <span class="n">output_string</span> <span class="n">socket_out</span> <span class="n">domain_name</span><span class="o">;</span>
  <span class="n">output_string</span> <span class="n">socket_out</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
  <span class="n">flush</span> <span class="n">socket_out</span><span class="o">;</span>

  <span class="k">let</span> <span class="n">whois_redirect_regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;Whois Server: </span><span class="se">\\</span><span class="s2">(.*</span><span class="se">\\</span><span class="s2">)&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">whois_redirect</span> <span class="o">=</span> <span class="n">ref</span> <span class="s2">&quot;&quot;</span> <span class="k">in</span>

  <span class="k">begin</span>
    <span class="k">try</span>
      <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
        <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">ltrim</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">socket_in</span><span class="o">)</span> <span class="k">in</span>
        <span class="k">if</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">whois_redirect_regexp</span> <span class="n">line</span> <span class="mi">0</span>
        <span class="k">then</span> <span class="n">whois_redirect</span> <span class="o">:=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">1</span> <span class="n">line</span>
      <span class="k">done</span>
    <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
      <span class="nn">Unix</span><span class="p">.</span><span class="n">shutdown_connection</span> <span class="n">socket_in</span>
  <span class="k">end</span><span class="o">;</span>

  <span class="k">if</span> <span class="o">!</span><span class="n">whois_redirect</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
  <span class="k">then</span> <span class="n">failwith</span> <span class="s2">&quot;Couldn&#39;t find WHOIS redirect&quot;</span><span class="o">;</span>

  <span class="c">(* Connect to the real server and get the WHOIS data. *)</span>

  <span class="k">let</span> <span class="n">host</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">gethostbyname</span> <span class="o">!</span><span class="n">whois_redirect</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">socket_in</span><span class="o">,</span> <span class="n">socket_out</span> <span class="o">=</span>
    <span class="nn">Unix</span><span class="p">.</span><span class="n">open_connection</span>
      <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">ADDR_INET</span> <span class="o">(</span><span class="n">host</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">h_addr_list</span><span class="o">.(</span><span class="mi">0</span><span class="o">),</span>
                       <span class="n">service</span><span class="o">.</span><span class="nn">Unix</span><span class="p">.</span><span class="n">s_port</span><span class="o">))</span> <span class="k">in</span>

  <span class="n">output_string</span> <span class="n">socket_out</span> <span class="n">domain_name</span><span class="o">;</span>
  <span class="n">output_string</span> <span class="n">socket_out</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
  <span class="n">flush</span> <span class="n">socket_out</span><span class="o">;</span>

  <span class="k">let</span> <span class="n">domain_name_regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;Domain name: </span><span class="se">\\</span><span class="s2">(.*</span><span class="se">\\</span><span class="s2">)&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">domain_name</span> <span class="o">=</span> <span class="n">ref</span> <span class="s2">&quot;&quot;</span> <span class="k">in</span>

  <span class="k">let</span> <span class="n">registrant_regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;Registrant:&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">registrant_name</span> <span class="o">=</span> <span class="n">ref</span> <span class="s2">&quot;&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">registrant_address</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">registrant_country</span> <span class="o">=</span> <span class="n">ref</span> <span class="s2">&quot;&quot;</span> <span class="k">in</span>

  <span class="k">let</span> <span class="n">contact_regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">(.*</span><span class="se">\\</span><span class="s2">) Contact:&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">contacts</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>

  <span class="k">begin</span>
    <span class="k">try</span>
      <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
        <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">ltrim</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">socket_in</span><span class="o">)</span> <span class="k">in</span>
        <span class="k">if</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">domain_name_regexp</span> <span class="n">line</span> <span class="mi">0</span>
        <span class="k">then</span> <span class="n">domain_name</span> <span class="o">:=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">1</span> <span class="n">line</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">registrant_regexp</span> <span class="n">line</span> <span class="mi">0</span>
        <span class="k">then</span>
          <span class="k">begin</span>
            <span class="c">(* Read registrant data. *)</span>
            <span class="n">registrant_name</span> <span class="o">:=</span> <span class="n">ltrim</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">socket_in</span><span class="o">);</span>
            <span class="k">let</span> <span class="n">finished</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span> <span class="k">in</span>
            <span class="k">while</span> <span class="n">not</span> <span class="o">!</span><span class="n">finished</span> <span class="k">do</span>
              <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">ltrim</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">socket_in</span><span class="o">)</span> <span class="k">in</span>
              <span class="k">if</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">line</span> <span class="o">&gt;</span> <span class="mi">2</span>
              <span class="k">then</span> <span class="n">registrant_address</span> <span class="o">:=</span> <span class="o">!</span><span class="n">registrant_address</span> <span class="o">@</span> <span class="o">[</span><span class="n">line</span><span class="o">]</span>
              <span class="k">else</span> <span class="k">if</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">line</span> <span class="o">=</span> <span class="mi">2</span>
              <span class="k">then</span> <span class="n">registrant_country</span> <span class="o">:=</span> <span class="n">line</span>
              <span class="k">else</span> <span class="n">finished</span> <span class="o">:=</span> <span class="bp">true</span>
            <span class="k">done</span>
          <span class="k">end</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">contact_regexp</span> <span class="n">line</span> <span class="mi">0</span>
        <span class="k">then</span>
          <span class="k">begin</span>
            <span class="c">(* Read contact data. *)</span>
            <span class="k">let</span> <span class="n">contact_type</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">1</span> <span class="n">line</span> <span class="k">in</span>
            <span class="k">let</span> <span class="n">contact_info</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
            <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">to</span> <span class="mi">6</span> <span class="k">do</span>
              <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">ltrim</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">socket_in</span><span class="o">)</span> <span class="k">in</span>
              <span class="n">contact_info</span> <span class="o">:=</span> <span class="o">!</span><span class="n">contact_info</span> <span class="o">@</span> <span class="o">[</span><span class="n">line</span><span class="o">]</span>
            <span class="k">done</span><span class="o">;</span>
            <span class="n">contacts</span> <span class="o">:=</span> <span class="o">(</span><span class="n">contact_type</span><span class="o">,</span> <span class="o">!</span><span class="n">contact_info</span><span class="o">)</span> <span class="o">::</span> <span class="o">!</span><span class="n">contacts</span>
          <span class="k">end</span>
      <span class="k">done</span>
    <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
      <span class="nn">Unix</span><span class="p">.</span><span class="n">shutdown_connection</span> <span class="n">socket_in</span>
  <span class="k">end</span><span class="o">;</span>

  <span class="c">(* Display the results. *)</span>

  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;The domain is called %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">!</span><span class="n">domain_name</span><span class="o">;</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Mail for %s should be sent to:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">!</span><span class="n">registrant_name</span><span class="o">;</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">%s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span> <span class="o">!</span><span class="n">registrant_address</span><span class="o">;</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">%s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">!</span><span class="n">registrant_country</span><span class="o">;</span>

  <span class="k">if</span> <span class="o">!</span><span class="n">contacts</span> <span class="o">=</span> <span class="bp">[]</span>
  <span class="k">then</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;No contact information.</span><span class="se">\n</span><span class="s2">&quot;</span>
  <span class="k">else</span>
    <span class="k">begin</span>
      <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Contacts:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
      <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
        <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">contact_type</span><span class="o">,</span> <span class="n">contact_info</span><span class="o">)</span> <span class="o">-&gt;</span>
           <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;  %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">contact_type</span><span class="o">;</span>
           <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;    %s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span> <span class="n">contact_info</span><span class="o">)</span>
        <span class="o">!</span><span class="n">contacts</span>
    <span class="k">end</span>

<span class="c">(* @@PLEAC@@_18.9 *)</span>
<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* expn -- convince smtp to divulge an alias expansion *)</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>                        <span class="c">(* Findlib *)</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;str&quot;</span><span class="o">;;</span>                        <span class="c">(* Stdlib *)</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;unix&quot;</span><span class="o">;;</span>                       <span class="c">(* Stdlib *)</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;perl&quot;</span><span class="o">;;</span>                       <span class="c">(* Perl4caml *)</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;smtp&quot;</span><span class="o">;;</span>                       <span class="c">(* Ocamlnet *)</span>
<span class="k">let</span> <span class="o">_</span> <span class="o">=</span> <span class="nn">Perl</span><span class="p">.</span><span class="n">eval</span> <span class="s2">&quot;use Net::DNS&quot;</span>        <span class="c">(* Net::DNS *)</span>

<span class="k">let</span> <span class="n">selfname</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">gethostname</span> <span class="bp">()</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="o">&lt;</span> <span class="mi">2</span>
  <span class="k">then</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;usage: %s address@host ...</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">);</span>
        <span class="n">exit</span> <span class="mi">1</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">combo</span> <span class="o">-&gt;</span>
       <span class="k">let</span> <span class="n">name</span><span class="o">,</span> <span class="n">host</span> <span class="o">=</span>
         <span class="k">match</span> <span class="nn">Str</span><span class="p">.</span><span class="n">bounded_split</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;@&quot;</span><span class="o">)</span> <span class="n">combo</span> <span class="mi">2</span> <span class="k">with</span>
           <span class="o">|</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="s2">&quot;&quot;</span><span class="o">,</span> <span class="s2">&quot;&quot;</span>
           <span class="o">|</span> <span class="o">[</span><span class="n">name</span><span class="o">]</span> <span class="o">-&gt;</span> <span class="n">name</span><span class="o">,</span> <span class="s2">&quot;localhost&quot;</span>
           <span class="o">|</span> <span class="o">[</span><span class="n">name</span><span class="o">;</span> <span class="n">host</span><span class="o">]</span> <span class="o">-&gt;</span> <span class="n">name</span><span class="o">,</span> <span class="n">host</span>
           <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">assert</span> <span class="bp">false</span> <span class="k">in</span>
       <span class="k">let</span> <span class="n">hosts</span> <span class="o">=</span>
         <span class="nn">Perl</span><span class="p">.</span><span class="n">call_array</span> <span class="o">~</span><span class="n">fn</span><span class="o">:</span><span class="s2">&quot;mx&quot;</span> <span class="o">[</span><span class="nn">Perl</span><span class="p">.</span><span class="n">sv_of_string</span> <span class="n">host</span><span class="o">]</span> <span class="k">in</span>
       <span class="k">let</span> <span class="n">hosts</span> <span class="o">=</span>
         <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="k">fun</span> <span class="n">mx</span> <span class="o">-&gt;</span> <span class="nn">Perl</span><span class="p">.</span><span class="n">call_method</span> <span class="n">mx</span> <span class="s2">&quot;exchange&quot;</span> <span class="bp">[]</span><span class="o">)</span> <span class="n">hosts</span> <span class="k">in</span>
       <span class="k">let</span> <span class="n">hosts</span> <span class="o">=</span>
         <span class="k">if</span> <span class="n">hosts</span> <span class="o">=</span> <span class="bp">[]</span> <span class="k">then</span> <span class="o">[</span><span class="nn">Perl</span><span class="p">.</span><span class="n">sv_of_string</span> <span class="n">host</span><span class="o">]</span> <span class="k">else</span> <span class="n">hosts</span> <span class="k">in</span>
       <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
         <span class="o">(</span><span class="k">fun</span> <span class="n">host</span> <span class="o">-&gt;</span>
            <span class="k">let</span> <span class="n">host</span> <span class="o">=</span> <span class="nn">Perl</span><span class="p">.</span><span class="n">string_of_sv</span> <span class="n">host</span> <span class="k">in</span>
            <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Expanding %s at %s (%s): %!&quot;</span>
              <span class="n">name</span> <span class="n">host</span> <span class="n">combo</span><span class="o">;</span>
            <span class="k">let</span> <span class="n">inet_addr</span> <span class="o">=</span>
              <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">gethostbyname</span> <span class="n">host</span><span class="o">).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">h_addr_list</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span> <span class="k">in</span>
            <span class="k">let</span> <span class="n">addr</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">ADDR_INET</span> <span class="o">(</span><span class="n">inet_addr</span><span class="o">,</span> <span class="nn">Netsmtp</span><span class="p">.</span><span class="n">tcp_port</span><span class="o">)</span> <span class="k">in</span>
            <span class="k">try</span>
              <span class="k">let</span> <span class="n">ic</span><span class="o">,</span> <span class="n">oc</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">open_connection</span> <span class="n">addr</span> <span class="k">in</span>
              <span class="k">let</span> <span class="n">smtp</span> <span class="o">=</span>
                <span class="k">new</span> <span class="nn">Netsmtp</span><span class="p">.</span><span class="n">client</span>
                  <span class="o">(</span><span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">input_channel</span> <span class="n">ic</span><span class="o">)</span>
                  <span class="o">(</span><span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">output_channel</span> <span class="n">oc</span><span class="o">)</span> <span class="k">in</span>
              <span class="n">ignore</span> <span class="o">(</span><span class="n">smtp</span><span class="o">#</span><span class="n">helo</span> <span class="o">~</span><span class="n">host</span><span class="o">:</span><span class="n">selfname</span> <span class="bp">()</span><span class="o">);</span>
              <span class="n">print_endline</span>
                <span class="o">(</span><span class="k">match</span> <span class="n">smtp</span><span class="o">#</span><span class="n">expn</span> <span class="n">name</span> <span class="k">with</span>
                   <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="s2">&quot;None&quot;</span>
                   <span class="o">|</span> <span class="nc">Some</span> <span class="n">results</span> <span class="o">-&gt;</span> <span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;, &quot;</span> <span class="n">results</span><span class="o">);</span>
              <span class="n">smtp</span><span class="o">#</span><span class="n">quit</span> <span class="bp">()</span><span class="o">;</span>
              <span class="nn">Unix</span><span class="p">.</span><span class="n">shutdown_connection</span> <span class="n">ic</span><span class="o">;</span>
              <span class="n">close_out</span> <span class="n">oc</span>
            <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">ECONNREFUSED</span><span class="o">,</span> <span class="o">_,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
              <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;cannot connect to %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">host</span><span class="o">)</span>
         <span class="n">hosts</span><span class="o">)</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">))</span>


<span class="c">(* @@PLEAC@@_19.0 *)</span>
<span class="c">(* If you&#39;ve never seen a URL before, here are a few examples. *)</span>
<span class="n">http</span><span class="o">://</span><span class="n">caml</span><span class="o">.</span><span class="n">inria</span><span class="o">.</span><span class="n">fr</span><span class="o">/</span>
<span class="n">http</span><span class="o">://</span><span class="n">www</span><span class="o">.</span><span class="n">ocaml</span><span class="o">-</span><span class="n">tutorial</span><span class="o">.</span><span class="n">org</span><span class="o">/</span>
<span class="n">http</span><span class="o">://</span><span class="n">en</span><span class="o">.</span><span class="n">wikipedia</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">wiki</span><span class="o">/</span><span class="nc">Ocaml</span>
<span class="n">http</span><span class="o">://</span><span class="n">pleac</span><span class="o">.</span><span class="n">sourceforge</span><span class="o">.</span><span class="n">net</span><span class="o">/</span><span class="n">pleac_ocaml</span><span class="o">/</span><span class="n">index</span><span class="o">.</span><span class="n">html</span>

<span class="c">(* The URL for a form submission using the GET method will contain a</span>
<span class="c">   query string (the sequence of characters after the &#39;?&#39;) with named</span>
<span class="c">   parameters of the form: key1=value1&amp;key2=value2&amp;... *)</span>
<span class="n">http</span><span class="o">://</span><span class="n">caml</span><span class="o">.</span><span class="n">inria</span><span class="o">.</span><span class="n">fr</span><span class="o">/</span><span class="n">cgi</span><span class="o">-</span><span class="n">bin</span><span class="o">/</span><span class="n">search</span><span class="o">.</span><span class="n">en</span><span class="o">.</span><span class="n">cgi</span><span class="o">?</span><span class="n">corpus</span><span class="o">=</span><span class="n">hump</span><span class="o">&amp;</span><span class="n">words</span><span class="o">=</span><span class="n">cgi</span>

<span class="c">(* The URL for a form submission using POST will not usually contain</span>
<span class="c">   a query string, so it will appear cleaner. *)</span>
<span class="n">http</span><span class="o">://</span><span class="n">caml</span><span class="o">.</span><span class="n">inria</span><span class="o">.</span><span class="n">fr</span><span class="o">/</span><span class="n">cgi</span><span class="o">-</span><span class="n">bin</span><span class="o">/</span><span class="n">hump</span><span class="o">.</span><span class="n">cgi</span>

<span class="c">(* GET requests are assumed to be &quot;idempotent&quot;, meaning they can be</span>
<span class="c">   requested many times without any different effect than if they were</span>
<span class="c">   only requested once. This has the practical difference of making</span>
<span class="c">   GET requests easy to cache, and POST requests nearly impossible</span>
<span class="c">   (since there is no guarantee that a POST is non-destructive). It</span>
<span class="c">   is considered best practice to use POST, not GET, for side-effecting</span>
<span class="c">   operations such as deleting or modifying a record. *)</span>

<span class="c">(* @@PLEAC@@_19.1 *)</span>
<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">env</span> <span class="n">ocaml</span>
<span class="c">(* hiweb - load CGI module to decode information given by web server *)</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>                        <span class="c">(* Findlib *)</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netcgi2&quot;</span><span class="o">;;</span>                    <span class="c">(* Ocamlnet *)</span>

<span class="c">(* Create an HTML escaping function for the UTF-8 encoding. *)</span>
<span class="k">let</span> <span class="n">escape_html</span> <span class="o">=</span> <span class="nn">Netencoding</span><span class="p">.</span><span class="nn">Html</span><span class="p">.</span><span class="n">encode</span> <span class="o">~</span><span class="n">in_enc</span><span class="o">:`</span><span class="nc">Enc_utf8</span> <span class="bp">()</span>

<span class="c">(* Construct the beginning of an (X)HTML document. *)</span>
<span class="k">let</span> <span class="n">start_html</span> <span class="n">title</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;\</span>
<span class="s2">&lt;!DOCTYPE html PUBLIC </span><span class="se">\&quot;</span><span class="s2">-//W3C//DTD XHTML 1.0 Transitional//EN</span><span class="se">\&quot;</span><span class="s2"> </span><span class="se">\&quot;</span><span class="s2">http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd</span><span class="se">\&quot;</span><span class="s2">&gt;</span>
<span class="s2">&lt;html xmlns=</span><span class="se">\&quot;</span><span class="s2">http://www.w3.org/1999/xhtml</span><span class="se">\&quot;</span><span class="s2">&gt;</span>
<span class="s2">    &lt;head&gt;</span>
<span class="s2">        &lt;title&gt;%s&lt;/title&gt;</span>
<span class="s2">        &lt;meta http-equiv=</span><span class="se">\&quot;</span><span class="s2">Content-Type</span><span class="se">\&quot;</span><span class="s2"> content=</span><span class="se">\&quot;</span><span class="s2">text/html; charset=UTF-8</span><span class="se">\&quot;</span><span class="s2"> /&gt;</span>
<span class="s2">    &lt;/head&gt;</span>
<span class="s2">    &lt;body&gt;</span>

<span class="s2">&quot;</span> <span class="o">(</span><span class="n">escape_html</span> <span class="n">title</span><span class="o">)</span>

<span class="c">(* Construct the end of an (X)HTML document. *)</span>
<span class="k">let</span> <span class="n">end_html</span> <span class="o">=</span> <span class="s2">&quot;</span>

<span class="s2">    &lt;/body&gt;</span>
<span class="s2">&lt;/html&gt;</span>
<span class="s2">&quot;</span>

<span class="c">(* Construct a few common elements. *)</span>
<span class="k">let</span> <span class="n">p</span> <span class="n">contents</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;&lt;p&gt;%s&lt;/p&gt;&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="n">contents</span><span class="o">)</span>
<span class="k">let</span> <span class="n">tt</span> <span class="n">contents</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;&lt;tt&gt;%s&lt;/tt&gt;&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="n">contents</span><span class="o">)</span>

<span class="c">(* Process a page request. *)</span>
<span class="k">let</span> <span class="n">process</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="o">=</span>
  <span class="c">(* Get a parameter from a form. *)</span>
  <span class="k">let</span> <span class="k">value</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;PARAM_NAME&quot;</span> <span class="k">in</span>

  <span class="c">(* Output a document. *)</span>
  <span class="k">let</span> <span class="n">out</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">output_string</span> <span class="k">in</span>
  <span class="n">out</span> <span class="o">(</span><span class="n">start_html</span> <span class="s2">&quot;Howdy there!&quot;</span><span class="o">);</span>
  <span class="n">out</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;You typed: &quot;</span><span class="o">;</span> <span class="n">tt</span> <span class="o">[</span><span class="n">escape_html</span> <span class="k">value</span><span class="o">]]);</span>
  <span class="n">out</span> <span class="n">end_html</span><span class="o">;</span>

  <span class="c">(* Flush the output buffer. *)</span>
  <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">commit_work</span> <span class="bp">()</span>

<span class="c">(* Initialize and run the Netcgi process. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">config</span> <span class="o">=</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">default_config</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">buffered</span> <span class="o">_</span> <span class="n">ch</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">buffered_trans_channel</span> <span class="n">ch</span> <span class="k">in</span>
  <span class="nn">Netcgi_cgi</span><span class="p">.</span><span class="n">run</span> <span class="o">~</span><span class="n">config</span> <span class="o">~</span><span class="n">output_type</span><span class="o">:(`</span><span class="nc">Transactional</span> <span class="n">buffered</span><span class="o">)</span> <span class="n">process</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Set the output mime-type and expiration time. *)</span>
<span class="n">cgi</span><span class="o">#</span><span class="n">set_header</span> <span class="o">~</span><span class="n">content_type</span><span class="o">:</span><span class="s2">&quot;text/html&quot;</span> <span class="o">~</span><span class="n">cache</span><span class="o">:(`</span><span class="nc">Max_age</span> <span class="mi">3600</span><span class="o">)</span> <span class="bp">()</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Read multiple form fields, one containing multiple values. *)</span>
<span class="k">let</span> <span class="n">who</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;Name&quot;</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">phone</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;Number&quot;</span> <span class="k">in</span>
<span class="k">let</span> <span class="n">picks</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">map</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">arg</span> <span class="o">-&gt;</span> <span class="n">arg</span><span class="o">#</span><span class="k">value</span><span class="o">)</span>
    <span class="o">(</span><span class="n">cgi</span><span class="o">#</span><span class="n">multiple_argument</span> <span class="s2">&quot;Choices&quot;</span><span class="o">)</span> <span class="k">in</span>
<span class="c">(* ... *)</span>

<span class="c">(* @@PLEAC@@_19.2 *)</span>
<span class="c">(* The default Netcgi configuration sends all exceptions to the browser</span>
<span class="c">   in nicely formatted error pages. This is helpful during development</span>
<span class="c">   but may be inappropriate for production. The exception pages can be</span>
<span class="c">   disabled by setting the &quot;default_exn_handler&quot; configuration field: *)</span>
<span class="k">let</span> <span class="n">config</span> <span class="o">=</span> <span class="o">{</span><span class="nn">Netcgi</span><span class="p">.</span><span class="n">default_config</span> <span class="k">with</span>
                <span class="nn">Netcgi</span><span class="p">.</span><span class="n">default_exn_handler</span><span class="o">=</span><span class="bp">false</span><span class="o">}</span>

<span class="c">(* Most web servers send standard error to the error log, which is</span>
<span class="c">   typically /var/log/apache2/error.log for a default Apache 2</span>
<span class="c">   configuration. You can define a &quot;warn&quot; function to include the</span>
<span class="c">   script name in warning messages: *)</span>
<span class="k">let</span> <span class="n">warn</span> <span class="o">=</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">Filename</span><span class="p">.</span><span class="n">basename</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">))</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">warn</span> <span class="s2">&quot;This goes to the error log.&quot;</span>

<span class="c">(* You can also use Printf.kprintf to define a fancier warning function</span>
<span class="c">   that supports Printf formatting. *)</span>
<span class="k">let</span> <span class="n">warn</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">kprintf</span>
    <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;%s: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">Filename</span><span class="p">.</span><span class="n">basename</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">)))</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">warn</span> <span class="s2">&quot;So does %s.&quot;</span> <span class="s2">&quot;this&quot;</span>

<span class="c">(* @@PLEAC@@_19.3 *)</span>
<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">env</span> <span class="n">ocaml</span>
<span class="c">(* webwhoami - show web users id *)</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netcgi2&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;unix&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">process</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="o">=</span>
  <span class="n">cgi</span><span class="o">#</span><span class="n">set_header</span> <span class="o">~</span><span class="n">content_type</span><span class="o">:</span><span class="s2">&quot;text/plain&quot;</span> <span class="bp">()</span><span class="o">;</span>
  <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">output_string</span>
    <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;Running as %s</span><span class="se">\n</span><span class="s2">&quot;</span>
       <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">getpwuid</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">geteuid</span> <span class="bp">()</span><span class="o">)).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">pw_name</span><span class="o">);</span>
  <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">commit_work</span> <span class="bp">()</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">config</span> <span class="o">=</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">default_config</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">buffered</span> <span class="o">_</span> <span class="n">ch</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">buffered_trans_channel</span> <span class="n">ch</span> <span class="k">in</span>
  <span class="nn">Netcgi_cgi</span><span class="p">.</span><span class="n">run</span> <span class="o">~</span><span class="n">config</span> <span class="o">~</span><span class="n">output_type</span><span class="o">:(`</span><span class="nc">Transactional</span> <span class="n">buffered</span><span class="o">)</span> <span class="n">process</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* By using Netcgi_test.run instead of Netcgi_run, you can enable a</span>
<span class="c">   command-line testing mechanism. *)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">config</span> <span class="o">=</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">default_config</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">buffered</span> <span class="o">_</span> <span class="n">ch</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">buffered_trans_channel</span> <span class="n">ch</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">output_type</span> <span class="o">=</span> <span class="o">`</span><span class="nc">Transactional</span> <span class="n">buffered</span> <span class="k">in</span>
  <span class="k">if</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">isatty</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span>
  <span class="k">then</span> <span class="nn">Netcgi_test</span><span class="p">.</span><span class="n">run</span> <span class="o">~</span><span class="n">config</span> <span class="o">~</span><span class="n">output_type</span> <span class="n">process</span>
  <span class="k">else</span> <span class="nn">Netcgi_cgi</span><span class="p">.</span><span class="n">run</span> <span class="o">~</span><span class="n">config</span> <span class="o">~</span><span class="n">output_type</span> <span class="n">process</span>

<span class="c">(* Now, you can run the CGI script from the command line to test for</span>
<span class="c">   compilation and runtime errors. *)</span>
<span class="o">$</span> <span class="o">./</span><span class="n">webwhoami</span> <span class="o">-</span><span class="n">help</span>
<span class="n">ocaml</span> <span class="o">[</span><span class="n">options</span><span class="o">]</span> <span class="n">name1</span><span class="o">=</span><span class="n">value1</span> <span class="o">...</span> <span class="n">nameN</span><span class="o">=</span><span class="n">valueN</span>
  <span class="o">-</span><span class="n">get</span>               <span class="nc">Set</span> <span class="n">the</span> <span class="k">method</span> <span class="k">to</span> <span class="nc">GET</span> <span class="o">(</span><span class="n">the</span> <span class="n">default</span><span class="o">)</span>
  <span class="o">-</span><span class="n">head</span>              <span class="nc">Set</span> <span class="n">the</span> <span class="k">method</span> <span class="k">to</span> <span class="nc">HEAD</span>
  <span class="o">-</span><span class="n">post</span>              <span class="nc">Set</span> <span class="n">the</span> <span class="k">method</span> <span class="k">to</span> <span class="nc">POST</span>
  <span class="o">-</span><span class="n">put</span> <span class="n">file</span>          <span class="nc">Set</span> <span class="n">the</span> <span class="k">method</span> <span class="k">to</span> <span class="nc">PUT</span> <span class="k">with</span> <span class="n">the</span> <span class="n">file</span> <span class="k">as</span> <span class="n">argument</span>
  <span class="o">-</span><span class="n">delete</span>            <span class="nc">Set</span> <span class="n">the</span> <span class="k">method</span> <span class="k">to</span> <span class="nc">DELETE</span>
  <span class="o">-</span><span class="n">mimetype</span> <span class="k">type</span>     <span class="nc">Set</span> <span class="n">the</span> <span class="nc">MIME</span> <span class="k">type</span> <span class="k">for</span> <span class="n">the</span> <span class="n">next</span> <span class="n">file</span> <span class="n">argument</span><span class="o">(</span><span class="n">s</span><span class="o">)</span> <span class="o">(</span><span class="n">default</span><span class="o">:</span> <span class="n">text</span><span class="o">/</span><span class="n">plain</span><span class="o">)</span>
  <span class="o">-</span><span class="n">filename</span> <span class="n">path</span>     <span class="nc">Set</span> <span class="n">the</span> <span class="n">filename</span> <span class="n">property</span> <span class="k">for</span> <span class="n">the</span> <span class="n">next</span> <span class="n">file</span> <span class="n">argument</span><span class="o">(</span><span class="n">s</span><span class="o">)</span>
  <span class="o">-</span><span class="n">filearg</span> <span class="n">name</span><span class="o">=</span><span class="n">file</span> <span class="nc">Specify</span> <span class="n">a</span> <span class="n">file</span> <span class="n">argument</span> <span class="n">whose</span> <span class="n">contents</span> <span class="n">are</span> <span class="k">in</span> <span class="n">the</span> <span class="n">file</span>
  <span class="o">-</span><span class="n">user</span> <span class="n">name</span>         <span class="nc">Set</span> <span class="nc">REMOTE_USER</span> <span class="k">to</span> <span class="n">this</span> <span class="n">name</span>
  <span class="o">-</span><span class="n">prop</span> <span class="n">name</span><span class="o">=</span><span class="k">value</span>   <span class="nc">Set</span> <span class="n">the</span> <span class="n">environment</span> <span class="n">property</span>
  <span class="o">-</span><span class="n">header</span> <span class="n">name</span><span class="o">=</span><span class="k">value</span> <span class="nc">Set</span> <span class="n">the</span> <span class="n">request</span> <span class="n">header</span> <span class="n">field</span>
  <span class="o">-</span><span class="n">o</span> <span class="n">file</span>            <span class="nc">Set</span> <span class="n">the</span> <span class="n">output</span> <span class="n">file</span> <span class="o">(</span><span class="n">default</span><span class="o">:</span> <span class="n">stdout</span><span class="o">)</span>
  <span class="o">-</span><span class="n">help</span>              <span class="nc">Display</span> <span class="n">this</span> <span class="kt">list</span> <span class="k">of</span> <span class="n">options</span>
  <span class="o">--</span><span class="n">help</span>             <span class="nc">Display</span> <span class="n">this</span> <span class="kt">list</span> <span class="k">of</span> <span class="n">options</span>

<span class="c">(* @@PLEAC@@_19.4 *)</span>
<span class="c">(* There is no feature in OCaml resembling Perl&#39;s &quot;taint mode&quot;. *)</span>

<span class="c">(* @@PLEAC@@_19.5 *)</span>
<span class="c">(* Ocamlnet provides an Apache 2 module called netcgi_apache that allows</span>
<span class="c">   Netcgi scripts to run inside the Apache process. To load the module,</span>
<span class="c">   put something like the following in your Apache configuration file: *)</span>

<span class="nc">LoadModule</span> <span class="n">netcgi_module</span> <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">apache2</span><span class="o">/</span><span class="n">modules</span><span class="o">/</span><span class="n">mod_netcgi_apache</span><span class="o">.</span><span class="n">so</span>
<span class="nc">NetcgiLoad</span> <span class="n">pcre</span><span class="o">/</span><span class="n">pcre</span><span class="o">.</span><span class="n">cma</span>
<span class="nc">NetcgiLoad</span> <span class="n">netsys</span><span class="o">/</span><span class="n">netsys</span><span class="o">.</span><span class="n">cma</span>
<span class="nc">NetcgiLoad</span> <span class="n">netstring</span><span class="o">/</span><span class="n">netstring</span><span class="o">.</span><span class="n">cma</span>
<span class="nc">NetcgiLoad</span> <span class="n">str</span><span class="o">.</span><span class="n">cma</span>
<span class="nc">NetcgiLoad</span> <span class="n">netcgi2</span><span class="o">/</span><span class="n">netcgi</span><span class="o">.</span><span class="n">cma</span>
<span class="nc">NetcgiLoad</span> <span class="n">netcgi_apache</span><span class="o">/</span><span class="n">netcgi_apache</span><span class="o">.</span><span class="n">cma</span>

<span class="c">(* Extra libraries can be added with additional &quot;NetcgiLoad&quot; directives.</span>
<span class="c">   The following will enable netcgi_apache for *.cma files: *)</span>

<span class="nc">NetcgiHandler</span> <span class="nn">Netcgi_apache</span><span class="p">.</span><span class="n">bytecode</span>
<span class="nc">AddHandler</span> <span class="n">ocaml</span><span class="o">-</span><span class="n">bytecode</span> <span class="o">.</span><span class="n">cma</span>

<span class="c">(* Or, if you prefer, you can enable netcgi_apache for a directory: *)</span>

<span class="o">&lt;</span><span class="nc">Location</span> <span class="o">/</span><span class="n">caml</span><span class="o">-</span><span class="n">bin</span><span class="o">&gt;</span>
  <span class="nc">SetHandler</span> <span class="n">ocaml</span><span class="o">-</span><span class="n">bytecode</span>
  <span class="nc">NetcgiHandler</span> <span class="nn">Netcgi_apache</span><span class="p">.</span><span class="n">bytecode</span>
  <span class="nc">Options</span> <span class="nc">ExecCGI</span>
  <span class="nc">Allow</span> <span class="n">from</span> <span class="n">all</span>
<span class="o">&lt;/</span><span class="nc">Location</span><span class="o">&gt;</span>

<span class="c">(* Each script contains code similar to other Netcgi examples but uses</span>
<span class="c">   Netcgi_apache.run to run the process. *)</span>

<span class="k">let</span> <span class="n">process</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi_apache</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="o">=</span>
  <span class="n">cgi</span><span class="o">#</span><span class="n">set_header</span> <span class="o">~</span><span class="n">content_type</span><span class="o">:</span><span class="s2">&quot;text/html&quot;</span> <span class="bp">()</span><span class="o">;</span>
  <span class="c">(* ... *)</span>
  <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">commit_work</span> <span class="bp">()</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">config</span> <span class="o">=</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">default_config</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">buffered</span> <span class="o">_</span> <span class="n">ch</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">buffered_trans_channel</span> <span class="n">ch</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">output_type</span> <span class="o">=</span> <span class="o">`</span><span class="nc">Transactional</span> <span class="n">buffered</span> <span class="k">in</span>
  <span class="nn">Netcgi_apache</span><span class="p">.</span><span class="n">run</span> <span class="o">~</span><span class="n">config</span> <span class="o">~</span><span class="n">output_type</span> <span class="n">process</span>

<span class="c">(* Scripts need to be compiled into bytecode libraries before Apache can</span>
<span class="c">   execute them. If you have findlib installed, you can compile them as</span>
<span class="c">   follows: *)</span>

<span class="n">ocamlfind</span> <span class="n">ocamlc</span> <span class="o">-</span><span class="n">package</span> <span class="n">netcgi_apache</span> <span class="o">-</span><span class="n">c</span> <span class="n">myscript</span><span class="o">.</span><span class="n">ml</span>
<span class="n">ocamlfind</span> <span class="n">ocamlc</span> <span class="o">-</span><span class="n">a</span> <span class="o">-</span><span class="n">o</span> <span class="n">myscript</span><span class="o">.</span><span class="n">cma</span> <span class="n">myscript</span><span class="o">.</span><span class="n">cmo</span>

<span class="c">(* Here is a Makefile to automate the build process. *)</span>

<span class="nc">RESULTS</span> <span class="o">=</span> <span class="n">myscript</span><span class="o">.</span><span class="n">cma</span> <span class="n">another</span><span class="o">.</span><span class="n">cma</span>
<span class="nc">PACKS</span> <span class="o">=</span> <span class="n">netcgi_apache</span><span class="o">,</span><span class="n">anotherlib</span>

<span class="o">%.</span><span class="n">cmo</span> <span class="o">:</span> <span class="o">%.</span><span class="n">ml</span>
	<span class="n">ocamlfind</span> <span class="n">ocamlc</span> <span class="o">-</span><span class="n">package</span> <span class="o">$(</span><span class="nc">PACKS</span><span class="o">)</span> <span class="o">-</span><span class="n">c</span> <span class="o">$&lt;</span>

<span class="o">%.</span><span class="n">cma</span> <span class="o">:</span> <span class="o">%.</span><span class="n">cmo</span>
	<span class="n">ocamlfind</span> <span class="n">ocamlc</span> <span class="o">-</span><span class="n">a</span> <span class="o">-</span><span class="n">o</span> <span class="o">$@</span> <span class="o">$&lt;</span>

<span class="n">all</span><span class="o">:</span> <span class="o">$(</span><span class="nc">RESULTS</span><span class="o">)</span>

<span class="n">clean</span><span class="o">:</span>
	<span class="n">rm</span> <span class="o">-</span><span class="n">f</span> <span class="o">*.</span><span class="n">cma</span> <span class="o">*.</span><span class="n">cmi</span> <span class="o">*.</span><span class="n">cmo</span> <span class="o">$(</span><span class="nc">RESULTS</span><span class="o">)</span>

<span class="c">(* @@PLEAC@@_19.6 *)</span>
<span class="c">(* UNSAFE *)</span>
<span class="k">let</span> <span class="n">status</span> <span class="o">=</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">system</span>
    <span class="o">(</span><span class="n">command</span> <span class="o">^</span> <span class="s2">&quot; &quot;</span> <span class="o">^</span> <span class="n">input</span> <span class="o">^</span> <span class="s2">&quot; &quot;</span> <span class="o">^</span> <span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot; &quot;</span> <span class="n">files</span><span class="o">)</span>

<span class="c">(* safer *)</span>
<span class="k">let</span> <span class="n">pid</span> <span class="o">=</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">create_process</span> <span class="n">command</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">of_list</span> <span class="o">([</span><span class="n">command</span><span class="o">;</span> <span class="n">input</span><span class="o">]</span> <span class="o">@</span> <span class="n">files</span><span class="o">))</span>
    <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdout</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stderr</span>
<span class="k">let</span> <span class="o">_,</span> <span class="n">status</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">waitpid</span> <span class="bp">[]</span> <span class="n">pid</span>

<span class="c">(* @@PLEAC@@_19.7 *)</span>
<span class="k">open</span> <span class="nc">Printf</span>

<span class="c">(* Define some HTML helper functions. *)</span>
<span class="k">let</span> <span class="n">ol</span> <span class="n">contents</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;ol&gt;%s&lt;/ol&gt;&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="n">contents</span><span class="o">)</span>
<span class="k">let</span> <span class="n">ul</span> <span class="n">contents</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;ul&gt;%s&lt;/ul&gt;&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="n">contents</span><span class="o">)</span>
<span class="k">let</span> <span class="n">li</span> <span class="o">?(</span><span class="n">typ</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="n">content</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">typ</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
  <span class="k">then</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;li&gt;%s&lt;/li&gt;&quot;</span> <span class="n">content</span>
  <span class="k">else</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;li type=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2">&gt;%s&lt;/li&gt;&quot;</span> <span class="n">typ</span> <span class="n">content</span>
<span class="k">let</span> <span class="n">tr</span> <span class="n">contents</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;tr&gt;%s&lt;/tr&gt;&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="n">contents</span><span class="o">)</span>
<span class="k">let</span> <span class="n">th</span> <span class="n">content</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;th&gt;%s&lt;/th&gt;&quot;</span> <span class="n">content</span>
<span class="k">let</span> <span class="n">td</span> <span class="n">content</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;td&gt;%s&lt;/td&gt;&quot;</span> <span class="n">content</span>

<span class="c">(* Main CGI process. *)</span>
<span class="k">let</span> <span class="n">process</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="o">=</span>

  <span class="c">(* Define a print function for convenience. *)</span>
  <span class="k">let</span> <span class="n">print</span> <span class="n">s</span> <span class="o">=</span>
    <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">output_string</span> <span class="n">s</span><span class="o">;</span>
    <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">output_string</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">in</span>

  <span class="c">(* Print a numbered list. *)</span>
  <span class="n">print</span> <span class="o">(</span><span class="n">ol</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">li</span> <span class="o">[</span><span class="s2">&quot;red&quot;</span><span class="o">;</span> <span class="s2">&quot;blue&quot;</span><span class="o">;</span> <span class="s2">&quot;green&quot;</span><span class="o">]));</span>

  <span class="c">(* Print a bulleted list. *)</span>
  <span class="k">let</span> <span class="n">names</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;Larry&quot;</span><span class="o">;</span> <span class="s2">&quot;Moe&quot;</span><span class="o">;</span> <span class="s2">&quot;Curly&quot;</span><span class="o">]</span> <span class="k">in</span>
  <span class="n">print</span> <span class="o">(</span><span class="n">ul</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="n">li</span> <span class="o">~</span><span class="n">typ</span><span class="o">:</span><span class="s2">&quot;disc&quot;</span><span class="o">)</span> <span class="n">names</span><span class="o">));</span>

  <span class="c">(* The &quot;li&quot; function gets applied to a single item. *)</span>
  <span class="n">print</span> <span class="o">(</span><span class="n">li</span> <span class="s2">&quot;alpha&quot;</span><span class="o">);</span>

  <span class="c">(* If there are multiple items, use List.map. *)</span>
  <span class="n">print</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot; &quot;</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">li</span> <span class="o">[</span><span class="s2">&quot;alpha&quot;</span><span class="o">;</span> <span class="s2">&quot;omega&quot;</span><span class="o">]));</span>

  <span class="c">(* Build a table of states and their cities. *)</span>
  <span class="k">let</span> <span class="o">(</span> <span class="o">=&gt;</span> <span class="o">)</span> <span class="n">k</span> <span class="n">v</span> <span class="o">=</span> <span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">state_cities</span> <span class="o">=</span>
    <span class="o">[</span>
      <span class="s2">&quot;Wisconsin&quot;</span>  <span class="o">=&gt;</span> <span class="o">[</span> <span class="s2">&quot;Superior&quot;</span><span class="o">;</span> <span class="s2">&quot;Lake Geneva&quot;</span><span class="o">;</span> <span class="s2">&quot;Madison&quot;</span> <span class="o">];</span>
      <span class="s2">&quot;Colorado&quot;</span>   <span class="o">=&gt;</span> <span class="o">[</span> <span class="s2">&quot;Denver&quot;</span><span class="o">;</span> <span class="s2">&quot;Fort Collins&quot;</span><span class="o">;</span> <span class="s2">&quot;Boulder&quot;</span> <span class="o">];</span>
      <span class="s2">&quot;Texas&quot;</span>      <span class="o">=&gt;</span> <span class="o">[</span> <span class="s2">&quot;Plano&quot;</span><span class="o">;</span> <span class="s2">&quot;Austin&quot;</span><span class="o">;</span> <span class="s2">&quot;Fort Stockton&quot;</span> <span class="o">];</span>
      <span class="s2">&quot;California&quot;</span> <span class="o">=&gt;</span> <span class="o">[</span> <span class="s2">&quot;Sebastopol&quot;</span><span class="o">;</span> <span class="s2">&quot;Santa Rosa&quot;</span><span class="o">;</span> <span class="s2">&quot;Berkeley&quot;</span> <span class="o">];</span>
    <span class="o">]</span> <span class="k">in</span>

  <span class="c">(* Print the table in sorted order. *)</span>
  <span class="n">print</span> <span class="s2">&quot;&lt;TABLE&gt; &lt;CAPTION&gt;Cities I Have Known&lt;/CAPTION&gt;&quot;</span><span class="o">;</span>
  <span class="n">print</span> <span class="o">(</span><span class="n">tr</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">th</span> <span class="o">[</span><span class="s2">&quot;State&quot;</span><span class="o">;</span> <span class="s2">&quot;Cities&quot;</span><span class="o">]));</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">state</span><span class="o">,</span> <span class="n">cities</span><span class="o">)</span> <span class="o">-&gt;</span>
       <span class="n">print</span> <span class="o">(</span><span class="n">tr</span> <span class="o">(</span><span class="n">th</span> <span class="n">state</span> <span class="o">::</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="n">td</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">sort</span> <span class="n">compare</span> <span class="n">cities</span><span class="o">))))</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">sort</span> <span class="n">compare</span> <span class="n">state_cities</span><span class="o">);</span>
  <span class="n">print</span> <span class="s2">&quot;&lt;/TABLE&gt;&quot;</span><span class="o">;</span>

  <span class="c">(* Flush the output buffer. *)</span>
  <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">commit_work</span> <span class="bp">()</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* salcheck - check for salaries *)</span>

<span class="c">(* Requires ocaml-mysql, available here:</span>
<span class="c">   http://raevnos.pennmush.org/code/ocaml-mysql/</span>

<span class="c">   For netcgi_apache, the following configuration directive is needed:</span>
<span class="c">   NetcgiLoad mysql/mysql.cma *)</span>

<span class="k">open</span> <span class="nc">Printf</span>

<span class="k">let</span> <span class="n">escape_html</span> <span class="o">=</span> <span class="nn">Netencoding</span><span class="p">.</span><span class="nn">Html</span><span class="p">.</span><span class="n">encode</span> <span class="o">~</span><span class="n">in_enc</span><span class="o">:`</span><span class="nc">Enc_utf8</span> <span class="bp">()</span>

<span class="k">let</span> <span class="n">start_html</span> <span class="n">title</span> <span class="o">=</span>
  <span class="n">sprintf</span> <span class="s2">&quot;\</span>
<span class="s2">&lt;!DOCTYPE html PUBLIC </span><span class="se">\&quot;</span><span class="s2">-//W3C//DTD XHTML 1.0 Transitional//EN</span><span class="se">\&quot;</span><span class="s2"> </span><span class="se">\&quot;</span><span class="s2">http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd</span><span class="se">\&quot;</span><span class="s2">&gt;</span>
<span class="s2">&lt;html xmlns=</span><span class="se">\&quot;</span><span class="s2">http://www.w3.org/1999/xhtml</span><span class="se">\&quot;</span><span class="s2">&gt;</span>
<span class="s2">    &lt;head&gt;</span>
<span class="s2">        &lt;title&gt;%s&lt;/title&gt;</span>
<span class="s2">        &lt;meta http-equiv=</span><span class="se">\&quot;</span><span class="s2">Content-Type</span><span class="se">\&quot;</span><span class="s2"> content=</span><span class="se">\&quot;</span><span class="s2">text/html; charset=UTF-8</span><span class="se">\&quot;</span><span class="s2"> /&gt;</span>
<span class="s2">    &lt;/head&gt;</span>
<span class="s2">    &lt;body&gt;</span>

<span class="s2">&quot;</span> <span class="o">(</span><span class="n">escape_html</span> <span class="n">title</span><span class="o">)</span>

<span class="k">let</span> <span class="n">end_html</span> <span class="o">=</span> <span class="s2">&quot;</span>

<span class="s2">    &lt;/body&gt;</span>
<span class="s2">&lt;/html&gt;</span>
<span class="s2">&quot;</span>

<span class="k">let</span> <span class="n">start_form</span> <span class="o">?(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="o">?(</span><span class="k">method&#39;</span><span class="o">=</span><span class="s2">&quot;get&quot;</span><span class="o">)</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">sprintf</span> <span class="s2">&quot;&lt;form action=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> method=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2">&gt;&quot;</span>
    <span class="o">(</span><span class="n">escape_html</span> <span class="n">action</span><span class="o">)</span> <span class="o">(</span><span class="n">escape_html</span> <span class="k">method&#39;</span><span class="o">)</span>
<span class="k">let</span> <span class="n">end_form</span> <span class="o">=</span> <span class="s2">&quot;&lt;/form&gt;&quot;</span>

<span class="k">let</span> <span class="n">p</span> <span class="n">contents</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;p&gt;%s&lt;/p&gt;&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="n">contents</span><span class="o">)</span>
<span class="k">let</span> <span class="n">h1</span> <span class="n">contents</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;h1&gt;%s&lt;/h1&gt;&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="n">contents</span><span class="o">)</span>

<span class="k">let</span> <span class="n">textfield</span> <span class="o">?(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="o">?(</span><span class="k">value</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">sprintf</span> <span class="s2">&quot;&lt;input type=</span><span class="se">\&quot;</span><span class="s2">text</span><span class="se">\&quot;</span><span class="s2"> name=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> value=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> /&gt;&quot;</span>
    <span class="o">(</span><span class="n">escape_html</span> <span class="n">name</span><span class="o">)</span> <span class="o">(</span><span class="n">escape_html</span> <span class="k">value</span><span class="o">)</span>

<span class="k">let</span> <span class="n">submit</span> <span class="o">?(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="o">?(</span><span class="k">value</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">sprintf</span> <span class="s2">&quot;&lt;input type=</span><span class="se">\&quot;</span><span class="s2">submit</span><span class="se">\&quot;</span><span class="s2"> name=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> value=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> /&gt;&quot;</span>
    <span class="o">(</span><span class="n">escape_html</span> <span class="n">name</span><span class="o">)</span> <span class="o">(</span><span class="n">escape_html</span> <span class="k">value</span><span class="o">)</span>

<span class="k">let</span> <span class="n">tr</span> <span class="n">contents</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;tr&gt;%s&lt;/tr&gt;&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="n">contents</span><span class="o">)</span>
<span class="k">let</span> <span class="n">td</span> <span class="n">content</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;td&gt;%s&lt;/td&gt;&quot;</span> <span class="n">content</span>

<span class="k">let</span> <span class="n">process</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">limit</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;LIMIT&quot;</span> <span class="k">in</span>

  <span class="n">cgi</span><span class="o">#</span><span class="n">set_header</span> <span class="o">~</span><span class="n">content_type</span><span class="o">:</span><span class="s2">&quot;text/html&quot;</span> <span class="bp">()</span><span class="o">;</span>

  <span class="k">let</span> <span class="n">print</span> <span class="n">s</span> <span class="o">=</span>
    <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">output_string</span> <span class="n">s</span><span class="o">;</span>
    <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">output_string</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">in</span>

  <span class="n">print</span> <span class="o">(</span><span class="n">start_html</span> <span class="s2">&quot;Salary Query&quot;</span><span class="o">);</span>
  <span class="n">print</span> <span class="o">(</span><span class="n">h1</span> <span class="o">[</span><span class="s2">&quot;Search&quot;</span><span class="o">]);</span>
  <span class="n">print</span> <span class="o">(</span><span class="n">start_form</span> <span class="bp">()</span><span class="o">);</span>
  <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;Enter minimum salary &quot;</span><span class="o">;</span>
            <span class="n">textfield</span> <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;LIMIT&quot;</span> <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="n">limit</span> <span class="bp">()</span><span class="o">]);</span>
  <span class="n">print</span> <span class="o">(</span><span class="n">submit</span> <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="s2">&quot;Submit&quot;</span> <span class="bp">()</span><span class="o">);</span>
  <span class="n">print</span> <span class="n">end_form</span><span class="o">;</span>

  <span class="k">if</span> <span class="n">limit</span> <span class="o">&lt;&gt;</span> <span class="s2">&quot;&quot;</span> <span class="k">then</span>
    <span class="k">begin</span>
      <span class="k">let</span> <span class="n">db</span> <span class="o">=</span>
        <span class="nn">Mysql</span><span class="p">.</span><span class="n">quick_connect</span>
          <span class="o">~</span><span class="n">user</span><span class="o">:</span><span class="s2">&quot;username&quot;</span>
          <span class="o">~</span><span class="n">password</span><span class="o">:</span><span class="s2">&quot;password&quot;</span>
          <span class="o">~</span><span class="n">database</span><span class="o">:</span><span class="s2">&quot;somedb&quot;</span>
          <span class="o">~</span><span class="n">host</span><span class="o">:</span><span class="s2">&quot;localhost&quot;</span>
          <span class="o">~</span><span class="n">port</span><span class="o">:</span><span class="mi">3306</span> <span class="bp">()</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">sql</span> <span class="o">=</span>
        <span class="n">sprintf</span> <span class="s2">&quot;</span>
<span class="s2">            SELECT name, salary</span>
<span class="s2">            FROM   employees</span>
<span class="s2">            WHERE  salary &gt; %s</span>
<span class="s2">        &quot;</span> <span class="o">(</span><span class="nn">Mysql</span><span class="p">.</span><span class="n">ml2float</span> <span class="o">(</span><span class="n">float_of_string</span> <span class="n">limit</span><span class="o">))</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">result</span> <span class="o">=</span> <span class="nn">Mysql</span><span class="p">.</span><span class="n">exec</span> <span class="n">db</span> <span class="n">sql</span> <span class="k">in</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">h1</span> <span class="o">[</span><span class="s2">&quot;Results&quot;</span><span class="o">]);</span>
      <span class="n">print</span> <span class="s2">&quot;&lt;table border=</span><span class="se">\&quot;</span><span class="s2">1</span><span class="se">\&quot;</span><span class="s2">&gt;&quot;</span><span class="o">;</span>
      <span class="n">print</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
               <span class="o">(</span><span class="nn">Mysql</span><span class="p">.</span><span class="n">map</span> <span class="n">result</span>
                  <span class="o">(</span><span class="k">fun</span> <span class="n">values</span> <span class="o">-&gt;</span>
                     <span class="n">tr</span> <span class="o">[</span><span class="n">td</span> <span class="o">(</span><span class="n">escape_html</span>
                               <span class="o">(</span><span class="nn">Mysql</span><span class="p">.</span><span class="n">not_null</span>
                                  <span class="nn">Mysql</span><span class="p">.</span><span class="n">str2ml</span> <span class="n">values</span><span class="o">.(</span><span class="mi">0</span><span class="o">)));</span>
                         <span class="n">td</span> <span class="o">(</span><span class="n">sprintf</span> <span class="s2">&quot;%.2f&quot;</span>
                               <span class="o">(</span><span class="nn">Mysql</span><span class="p">.</span><span class="n">not_null</span>
                                  <span class="nn">Mysql</span><span class="p">.</span><span class="n">float2ml</span> <span class="n">values</span><span class="o">.(</span><span class="mi">1</span><span class="o">)))])));</span>
      <span class="n">print</span> <span class="s2">&quot;&lt;/table&gt;&quot;</span><span class="o">;</span>
      <span class="nn">Mysql</span><span class="p">.</span><span class="n">disconnect</span> <span class="n">db</span><span class="o">;</span>
    <span class="k">end</span><span class="o">;</span>

  <span class="n">print</span> <span class="n">end_html</span><span class="o">;</span>
  <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">commit_work</span> <span class="bp">()</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">buffered</span> <span class="o">_</span> <span class="n">ch</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">buffered_trans_channel</span> <span class="n">ch</span> <span class="k">in</span>
  <span class="nn">Netcgi_apache</span><span class="p">.</span><span class="n">run</span>
    <span class="o">~</span><span class="n">output_type</span><span class="o">:(`</span><span class="nc">Transactional</span> <span class="n">buffered</span><span class="o">)</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">cgi</span> <span class="o">-&gt;</span> <span class="n">process</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:&gt;</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">))</span>

<span class="c">(* @@PLEAC@@_19.8 *)</span>
<span class="k">let</span> <span class="n">process</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://caml.inria.fr/cgi-bin/hump.cgi&quot;</span> <span class="k">in</span>
  <span class="n">cgi</span><span class="o">#</span><span class="n">set_redirection_header</span> <span class="n">url</span><span class="o">;</span>
  <span class="c">(* By default, the above will send a 302 Found. To instead send</span>
<span class="c">     a 301 Moved Permanently, use the following command. *)</span>
  <span class="n">cgi</span><span class="o">#</span><span class="n">set_header</span> <span class="o">~</span><span class="n">status</span><span class="o">:`</span><span class="nc">Moved_permanently</span> <span class="bp">()</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* oreobounce - set a cookie and redirect the browser *)</span>

<span class="k">let</span> <span class="n">process</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">oreo</span> <span class="o">=</span>
    <span class="nn">Netcgi_common</span><span class="p">.</span><span class="nn">Cookie</span><span class="p">.</span><span class="n">make</span>
      <span class="o">~</span><span class="n">max_age</span><span class="o">:(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">30</span> <span class="o">*</span> <span class="mi">3</span><span class="o">)</span>  <span class="c">(* 3 months *)</span>
      <span class="o">~</span><span class="n">domain</span><span class="o">:</span><span class="s2">&quot;.sourceforge.nett&quot;</span>
      <span class="s2">&quot;filling&quot;</span> <span class="s2">&quot;vanilla crčme&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">whither</span> <span class="o">=</span> <span class="s2">&quot;http://somewhere.sourceforge.net/nonesuch.html&quot;</span> <span class="k">in</span>
  <span class="n">cgi</span><span class="o">#</span><span class="n">set_redirection_header</span> <span class="o">~</span><span class="n">set_cookies</span><span class="o">:[</span><span class="n">oreo</span><span class="o">]</span> <span class="n">whither</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">buffered</span> <span class="o">_</span> <span class="n">ch</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">buffered_trans_channel</span> <span class="n">ch</span> <span class="k">in</span>
  <span class="nn">Netcgi_apache</span><span class="p">.</span><span class="n">run</span>
    <span class="o">~</span><span class="n">output_type</span><span class="o">:(`</span><span class="nc">Transactional</span> <span class="n">buffered</span><span class="o">)</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">cgi</span> <span class="o">-&gt;</span> <span class="n">process</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:&gt;</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">))</span>

<span class="c">(*</span>
<span class="c">HTTP/1.1 302 Found</span>
<span class="c">Date: Thu, 06 Nov 2008 04:39:53 GMT</span>
<span class="c">Server: Apache/2.2.9 (Debian) Netcgi_apache/2.2.9 PHP/5.2.6-5 with Suhosin-Patch</span>
<span class="c">Set-Cookie: filling=vanilla%20cr%E8me;Version=1;Domain=.sourceforge.nt;Max-Age=7776000;Expires=Wed, 04 Feb 2009 04:39:55 +0000</span>
<span class="c">Location: http://somewhere.sourceforge.net/nonesuch.html</span>
<span class="c">Status: 302</span>
<span class="c">Transfer-Encoding: chunked</span>
<span class="c">Content-Type: text/html</span>
<span class="c">*)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* os_snipe - redirect to a Jargon File entry about current OS *)</span>

<span class="k">let</span> <span class="n">process</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">dir</span> <span class="o">=</span> <span class="s2">&quot;http://www.wins.uva.nl/%7Emes/jargon&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">page</span> <span class="o">=</span>
    <span class="k">match</span> <span class="n">cgi</span><span class="o">#</span><span class="n">environment</span><span class="o">#</span><span class="n">user_agent</span> <span class="k">with</span>
      <span class="o">|</span> <span class="n">s</span> <span class="k">when</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span>
            <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;.*Mac&quot;</span><span class="o">)</span> <span class="n">s</span> <span class="mi">0</span> <span class="o">-&gt;</span>
          <span class="s2">&quot;m/Macintrash.html&quot;</span>
      <span class="o">|</span> <span class="n">s</span> <span class="k">when</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span>
            <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;.*Win</span><span class="se">\\</span><span class="s2">(dows </span><span class="se">\\</span><span class="s2">)?NT&quot;</span><span class="o">)</span> <span class="n">s</span> <span class="mi">0</span> <span class="o">-&gt;</span>
          <span class="s2">&quot;e/evilandrude.html&quot;</span>
      <span class="o">|</span> <span class="n">s</span> <span class="k">when</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span>
            <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;.*</span><span class="se">\\</span><span class="s2">(Win</span><span class="se">\\</span><span class="s2">|MSIE</span><span class="se">\\</span><span class="s2">|WebTV</span><span class="se">\\</span><span class="s2">)&quot;</span><span class="o">)</span> <span class="n">s</span> <span class="mi">0</span> <span class="o">-&gt;</span>
          <span class="s2">&quot;m/MicroslothWindows.html&quot;</span>
      <span class="o">|</span> <span class="n">s</span> <span class="k">when</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span>
            <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;.*Linux&quot;</span><span class="o">)</span> <span class="n">s</span> <span class="mi">0</span> <span class="o">-&gt;</span>
          <span class="s2">&quot;l/Linux.html&quot;</span>
      <span class="o">|</span> <span class="n">s</span> <span class="k">when</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span>
            <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;.*HP-UX&quot;</span><span class="o">)</span> <span class="n">s</span> <span class="mi">0</span> <span class="o">-&gt;</span>
          <span class="s2">&quot;h/HP-SUX.html&quot;</span>
      <span class="o">|</span> <span class="n">s</span> <span class="k">when</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span>
            <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;.*SunOS&quot;</span><span class="o">)</span> <span class="n">s</span> <span class="mi">0</span> <span class="o">-&gt;</span>
          <span class="s2">&quot;s/ScumOS.html&quot;</span>
      <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span>
          <span class="s2">&quot;a/AppendixB.html&quot;</span> <span class="k">in</span>
  <span class="n">cgi</span><span class="o">#</span><span class="n">set_redirection_header</span> <span class="o">(</span><span class="n">dir</span> <span class="o">^</span> <span class="s2">&quot;/&quot;</span> <span class="o">^</span> <span class="n">page</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">buffered</span> <span class="o">_</span> <span class="n">ch</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">buffered_trans_channel</span> <span class="n">ch</span> <span class="k">in</span>
  <span class="nn">Netcgi_apache</span><span class="p">.</span><span class="n">run</span>
    <span class="o">~</span><span class="n">output_type</span><span class="o">:(`</span><span class="nc">Transactional</span> <span class="n">buffered</span><span class="o">)</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">cgi</span> <span class="o">-&gt;</span> <span class="n">process</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:&gt;</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">))</span>

<span class="c">(*-----------------------------*)</span>

<span class="k">let</span> <span class="n">process</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="o">=</span>
  <span class="n">cgi</span><span class="o">#</span><span class="n">environment</span><span class="o">#</span><span class="n">set_status</span> <span class="o">`</span><span class="nc">No_content</span>

<span class="c">(*</span>
<span class="c">HTTP/1.1 204 No Content</span>
<span class="c">Date: Thu, 06 Nov 2008 05:25:46 GMT</span>
<span class="c">Server: Apache/2.2.9 (Debian) Netcgi_apache/2.2.9 PHP/5.2.6-5 with Suhosin-Patch</span>
<span class="c">Status: 204</span>
<span class="c">Content-Type: text/html</span>
<span class="c">*)</span>

<span class="c">(* @@PLEAC@@_19.9 *)</span>
<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* dummyhttpd - start an HTTP daemon and print what the client sends *)</span>

<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">host</span> <span class="o">=</span> <span class="s2">&quot;localhost&quot;</span>
<span class="k">let</span> <span class="n">port</span> <span class="o">=</span> <span class="mi">8989</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Please contact me at: http://%s:%d/</span><span class="se">\n</span><span class="s2">%!&quot;</span> <span class="n">host</span> <span class="n">port</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">addr</span> <span class="o">=</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">gethostbyname</span> <span class="n">host</span><span class="o">).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">h_addr_list</span><span class="o">.(</span><span class="mi">0</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">server</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">socket</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">PF_INET</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">SOCK_STREAM</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">setsockopt</span> <span class="n">server</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">SO_REUSEADDR</span> <span class="bp">true</span><span class="o">;</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">bind</span> <span class="n">server</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="nc">ADDR_INET</span> <span class="o">(</span><span class="n">addr</span><span class="o">,</span> <span class="n">port</span><span class="o">));</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">listen</span> <span class="n">server</span> <span class="mi">10</span><span class="o">;</span>
  <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
    <span class="k">begin</span>
      <span class="k">let</span> <span class="n">client</span><span class="o">,</span> <span class="n">sockaddr</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">accept</span> <span class="n">server</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">in_channel_of_descr</span> <span class="n">client</span> <span class="k">in</span>
      <span class="k">try</span>
        <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
          <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">in_channel</span> <span class="k">in</span>
          <span class="n">print_endline</span> <span class="n">line</span>
        <span class="k">done</span>
      <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
        <span class="n">print_endline</span> <span class="s2">&quot;EOF&quot;</span><span class="o">;</span>
        <span class="n">close_in</span> <span class="n">in_channel</span>
    <span class="k">end</span>
  <span class="k">done</span>

<span class="c">(* @@PLEAC@@_19.10 *)</span>
<span class="c">(* Read a cookie: *)</span>
<span class="nn">Netcgi_common</span><span class="p">.</span><span class="nn">Cookie</span><span class="p">.</span><span class="n">value</span> <span class="o">(</span><span class="n">cgi</span><span class="o">#</span><span class="n">environment</span><span class="o">#</span><span class="n">cookie</span> <span class="s2">&quot;preference name&quot;</span><span class="o">)</span>

<span class="c">(* Make a cookie: *)</span>
<span class="k">let</span> <span class="n">cookie</span> <span class="o">=</span>
  <span class="nn">Netcgi_common</span><span class="p">.</span><span class="nn">Cookie</span><span class="p">.</span><span class="n">make</span>
    <span class="o">~</span><span class="n">max_age</span><span class="o">:(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">365</span> <span class="o">*</span> <span class="mi">2</span><span class="o">)</span>  <span class="c">(* 2 years *)</span>
    <span class="s2">&quot;preference name&quot;</span>                  <span class="c">(* name *)</span>
    <span class="s2">&quot;whatever you&#39;d like&quot;</span>              <span class="c">(* value*)</span>

<span class="c">(* Write a cookie: *)</span>
<span class="n">cgi</span><span class="o">#</span><span class="n">set_header</span> <span class="o">~</span><span class="n">set_cookies</span><span class="o">:[</span><span class="n">cookie</span><span class="o">]</span> <span class="bp">()</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">env</span> <span class="n">ocaml</span>
<span class="c">(* ic_cookies - sample CGI script that uses a cookie *)</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netcgi2&quot;</span><span class="o">;;</span>

<span class="k">open</span> <span class="nc">Printf</span>

<span class="k">let</span> <span class="n">escape_html</span> <span class="o">=</span> <span class="nn">Netencoding</span><span class="p">.</span><span class="nn">Html</span><span class="p">.</span><span class="n">encode</span> <span class="o">~</span><span class="n">in_enc</span><span class="o">:`</span><span class="nc">Enc_utf8</span> <span class="bp">()</span>

<span class="k">let</span> <span class="n">start_html</span> <span class="n">title</span> <span class="o">=</span>
  <span class="n">sprintf</span> <span class="s2">&quot;\</span>
<span class="s2">&lt;!DOCTYPE html PUBLIC </span><span class="se">\&quot;</span><span class="s2">-//W3C//DTD XHTML 1.0 Transitional//EN</span><span class="se">\&quot;</span><span class="s2"> </span><span class="se">\&quot;</span><span class="s2">http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd</span><span class="se">\&quot;</span><span class="s2">&gt;</span>
<span class="s2">&lt;html xmlns=</span><span class="se">\&quot;</span><span class="s2">http://www.w3.org/1999/xhtml</span><span class="se">\&quot;</span><span class="s2">&gt;</span>
<span class="s2">    &lt;head&gt;</span>
<span class="s2">        &lt;title&gt;%s&lt;/title&gt;</span>
<span class="s2">        &lt;meta http-equiv=</span><span class="se">\&quot;</span><span class="s2">Content-Type</span><span class="se">\&quot;</span><span class="s2"> content=</span><span class="se">\&quot;</span><span class="s2">text/html; charset=UTF-8</span><span class="se">\&quot;</span><span class="s2"> /&gt;</span>
<span class="s2">    &lt;/head&gt;</span>
<span class="s2">    &lt;body&gt;</span>
<span class="s2">&quot;</span> <span class="o">(</span><span class="n">escape_html</span> <span class="n">title</span><span class="o">)</span>

<span class="k">let</span> <span class="n">end_html</span> <span class="o">=</span> <span class="s2">&quot;</span>
<span class="s2">    &lt;/body&gt;</span>
<span class="s2">&lt;/html&gt;</span>
<span class="s2">&quot;</span>

<span class="k">let</span> <span class="n">h1</span> <span class="n">contents</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;h1&gt;%s&lt;/h1&gt;&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="n">contents</span><span class="o">)</span>
<span class="k">let</span> <span class="n">hr</span> <span class="o">=</span> <span class="s2">&quot;&lt;hr /&gt;&quot;</span>
<span class="k">let</span> <span class="n">p</span> <span class="n">contents</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;p&gt;%s&lt;/p&gt;&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="n">contents</span><span class="o">)</span>

<span class="k">let</span> <span class="n">start_form</span> <span class="o">?(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="o">?(</span><span class="k">method&#39;</span><span class="o">=</span><span class="s2">&quot;get&quot;</span><span class="o">)</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">sprintf</span> <span class="s2">&quot;&lt;form action=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> method=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2">&gt;&quot;</span>
    <span class="o">(</span><span class="n">escape_html</span> <span class="n">action</span><span class="o">)</span> <span class="o">(</span><span class="n">escape_html</span> <span class="k">method&#39;</span><span class="o">)</span>
<span class="k">let</span> <span class="n">end_form</span> <span class="o">=</span> <span class="s2">&quot;&lt;/form&gt;&quot;</span>

<span class="k">let</span> <span class="n">textfield</span> <span class="o">?(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="o">?(</span><span class="k">value</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">sprintf</span> <span class="s2">&quot;&lt;input type=</span><span class="se">\&quot;</span><span class="s2">text</span><span class="se">\&quot;</span><span class="s2"> name=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> value=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> /&gt;&quot;</span>
    <span class="o">(</span><span class="n">escape_html</span> <span class="n">name</span><span class="o">)</span> <span class="o">(</span><span class="n">escape_html</span> <span class="k">value</span><span class="o">)</span>

<span class="k">let</span> <span class="n">process</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">cookname</span> <span class="o">=</span> <span class="s2">&quot;favorite ice cream&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">favorite</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;flavor&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">tasty</span> <span class="o">=</span>
    <span class="k">try</span> <span class="nn">Netcgi_common</span><span class="p">.</span><span class="nn">Cookie</span><span class="p">.</span><span class="n">value</span> <span class="o">(</span><span class="n">cgi</span><span class="o">#</span><span class="n">environment</span><span class="o">#</span><span class="n">cookie</span> <span class="n">cookname</span><span class="o">)</span>
    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="s2">&quot;mint&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">print</span> <span class="n">s</span> <span class="o">=</span>
    <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">output_string</span> <span class="n">s</span><span class="o">;</span>
    <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">output_string</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">in</span>

  <span class="n">cgi</span><span class="o">#</span><span class="n">set_header</span> <span class="o">~</span><span class="n">content_type</span><span class="o">:</span><span class="s2">&quot;text/html&quot;</span> <span class="bp">()</span><span class="o">;</span>
  <span class="k">if</span> <span class="n">favorite</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
  <span class="k">then</span>
    <span class="k">begin</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">start_html</span> <span class="s2">&quot;Ice Cookies&quot;</span><span class="o">);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">h1</span> <span class="o">[</span><span class="s2">&quot;Hello Ice Cream&quot;</span><span class="o">]);</span>
      <span class="n">print</span> <span class="n">hr</span><span class="o">;</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">start_form</span> <span class="o">~</span><span class="k">method&#39;</span><span class="o">:</span><span class="s2">&quot;post&quot;</span> <span class="bp">()</span><span class="o">);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;Please select a flavor: &quot;</span><span class="o">;</span>
                <span class="n">textfield</span> <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;flavor&quot;</span> <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="n">tasty</span> <span class="bp">()</span><span class="o">]);</span>
      <span class="n">print</span> <span class="n">end_form</span><span class="o">;</span>
      <span class="n">print</span> <span class="n">hr</span><span class="o">;</span>
      <span class="n">print</span> <span class="n">end_html</span><span class="o">;</span>
    <span class="k">end</span>
  <span class="k">else</span>
    <span class="k">begin</span>
      <span class="k">let</span> <span class="n">cookie</span> <span class="o">=</span>
        <span class="nn">Netcgi_common</span><span class="p">.</span><span class="nn">Cookie</span><span class="p">.</span><span class="n">make</span>
          <span class="o">~</span><span class="n">max_age</span><span class="o">:(</span><span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">365</span> <span class="o">*</span> <span class="mi">2</span><span class="o">)</span>  <span class="c">(* 2 years *)</span>
          <span class="n">cookname</span> <span class="n">favorite</span> <span class="k">in</span>
      <span class="n">cgi</span><span class="o">#</span><span class="n">set_header</span> <span class="o">~</span><span class="n">set_cookies</span><span class="o">:[</span><span class="n">cookie</span><span class="o">]</span> <span class="bp">()</span><span class="o">;</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">start_html</span> <span class="s2">&quot;Ice Cookies, #2&quot;</span><span class="o">);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">h1</span> <span class="o">[</span><span class="s2">&quot;Hello Ice Cream&quot;</span><span class="o">]);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;You chose as your favorite flavor `&quot;</span><span class="o">;</span>
                <span class="n">escape_html</span> <span class="n">favorite</span><span class="o">;</span> <span class="s2">&quot;&#39;.&quot;</span><span class="o">]);</span>
      <span class="n">print</span> <span class="n">end_html</span><span class="o">;</span>
    <span class="k">end</span><span class="o">;</span>
  <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">commit_work</span> <span class="bp">()</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">config</span> <span class="o">=</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">default_config</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">buffered</span> <span class="o">_</span> <span class="n">ch</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">buffered_trans_channel</span> <span class="n">ch</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">output_type</span> <span class="o">=</span> <span class="o">`</span><span class="nc">Transactional</span> <span class="n">buffered</span> <span class="k">in</span>
  <span class="k">if</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">isatty</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span>
  <span class="k">then</span> <span class="nn">Netcgi_test</span><span class="p">.</span><span class="n">run</span> <span class="o">~</span><span class="n">config</span> <span class="o">~</span><span class="n">output_type</span> <span class="n">process</span>
  <span class="k">else</span> <span class="nn">Netcgi_cgi</span><span class="p">.</span><span class="n">run</span> <span class="o">~</span><span class="n">config</span> <span class="o">~</span><span class="n">output_type</span> <span class="n">process</span>

<span class="c">(* @@PLEAC@@_19.11 *)</span>
<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">env</span> <span class="n">ocaml</span>
<span class="c">(* who.cgi - run who(1) on a user and format the results nicely *)</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netcgi2&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;str&quot;</span><span class="o">;;</span>

<span class="k">open</span> <span class="nc">Printf</span>

<span class="k">let</span> <span class="n">escape_html</span> <span class="o">=</span> <span class="nn">Netencoding</span><span class="p">.</span><span class="nn">Html</span><span class="p">.</span><span class="n">encode</span> <span class="o">~</span><span class="n">in_enc</span><span class="o">:`</span><span class="nc">Enc_utf8</span> <span class="bp">()</span>

<span class="k">let</span> <span class="n">start_html</span> <span class="n">title</span> <span class="o">=</span>
  <span class="n">sprintf</span> <span class="s2">&quot;\</span>
<span class="s2">&lt;!DOCTYPE html PUBLIC </span><span class="se">\&quot;</span><span class="s2">-//W3C//DTD XHTML 1.0 Transitional//EN</span><span class="se">\&quot;</span><span class="s2"> </span><span class="se">\&quot;</span><span class="s2">http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd</span><span class="se">\&quot;</span><span class="s2">&gt;</span>
<span class="s2">&lt;html xmlns=</span><span class="se">\&quot;</span><span class="s2">http://www.w3.org/1999/xhtml</span><span class="se">\&quot;</span><span class="s2">&gt;</span>
<span class="s2">    &lt;head&gt;</span>
<span class="s2">        &lt;title&gt;%s&lt;/title&gt;</span>
<span class="s2">        &lt;meta http-equiv=</span><span class="se">\&quot;</span><span class="s2">Content-Type</span><span class="se">\&quot;</span><span class="s2"> content=</span><span class="se">\&quot;</span><span class="s2">text/html; charset=UTF-8</span><span class="se">\&quot;</span><span class="s2"> /&gt;</span>
<span class="s2">    &lt;/head&gt;</span>
<span class="s2">    &lt;body&gt;</span>
<span class="s2">&quot;</span> <span class="o">(</span><span class="n">escape_html</span> <span class="n">title</span><span class="o">)</span>

<span class="k">let</span> <span class="n">end_html</span> <span class="o">=</span> <span class="s2">&quot;</span>
<span class="s2">    &lt;/body&gt;</span>
<span class="s2">&lt;/html&gt;</span>
<span class="s2">&quot;</span>

<span class="k">let</span> <span class="n">h1</span> <span class="n">contents</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;h1&gt;%s&lt;/h1&gt;&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="n">contents</span><span class="o">)</span>
<span class="k">let</span> <span class="n">p</span> <span class="n">contents</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;p&gt;%s&lt;/p&gt;&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="n">contents</span><span class="o">)</span>
<span class="k">let</span> <span class="n">pre</span> <span class="n">contents</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;pre&gt;%s&lt;/pre&gt;&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="n">contents</span><span class="o">)</span>

<span class="k">let</span> <span class="n">start_form</span> <span class="o">?(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="o">?(</span><span class="k">method&#39;</span><span class="o">=</span><span class="s2">&quot;get&quot;</span><span class="o">)</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">sprintf</span> <span class="s2">&quot;&lt;form action=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> method=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2">&gt;&quot;</span>
    <span class="o">(</span><span class="n">escape_html</span> <span class="n">action</span><span class="o">)</span> <span class="o">(</span><span class="n">escape_html</span> <span class="k">method&#39;</span><span class="o">)</span>
<span class="k">let</span> <span class="n">end_form</span> <span class="o">=</span> <span class="s2">&quot;&lt;/form&gt;&quot;</span>

<span class="k">let</span> <span class="n">textfield</span> <span class="o">?(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="o">?(</span><span class="k">value</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">sprintf</span> <span class="s2">&quot;&lt;input type=</span><span class="se">\&quot;</span><span class="s2">text</span><span class="se">\&quot;</span><span class="s2"> name=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> value=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> /&gt;&quot;</span>
    <span class="o">(</span><span class="n">escape_html</span> <span class="n">name</span><span class="o">)</span> <span class="o">(</span><span class="n">escape_html</span> <span class="k">value</span><span class="o">)</span>

<span class="k">let</span> <span class="n">submit</span> <span class="o">?(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="o">?(</span><span class="k">value</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">sprintf</span> <span class="s2">&quot;&lt;input type=</span><span class="se">\&quot;</span><span class="s2">submit</span><span class="se">\&quot;</span><span class="s2"> name=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> value=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> /&gt;&quot;</span>
    <span class="o">(</span><span class="n">escape_html</span> <span class="n">name</span><span class="o">)</span> <span class="o">(</span><span class="n">escape_html</span> <span class="k">value</span><span class="o">)</span>

<span class="k">let</span> <span class="n">process</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">print</span> <span class="n">s</span> <span class="o">=</span>
    <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">output_string</span> <span class="n">s</span><span class="o">;</span>
    <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">output_string</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">in</span>

  <span class="k">let</span> <span class="n">name</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;WHO&quot;</span> <span class="k">in</span>

  <span class="c">(* print search form *)</span>
  <span class="n">cgi</span><span class="o">#</span><span class="n">set_header</span> <span class="o">~</span><span class="n">content_type</span><span class="o">:</span><span class="s2">&quot;text/html&quot;</span> <span class="bp">()</span><span class="o">;</span>
  <span class="n">print</span> <span class="o">(</span><span class="n">start_html</span> <span class="s2">&quot;Query Users&quot;</span><span class="o">);</span>
  <span class="n">print</span> <span class="o">(</span><span class="n">h1</span> <span class="o">[</span><span class="s2">&quot;Search&quot;</span><span class="o">]);</span>
  <span class="n">print</span> <span class="o">(</span><span class="n">start_form</span> <span class="o">~</span><span class="k">method&#39;</span><span class="o">:</span><span class="s2">&quot;post&quot;</span> <span class="bp">()</span><span class="o">);</span>
  <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;Which user? &quot;</span><span class="o">;</span>
            <span class="n">textfield</span> <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;WHO&quot;</span> <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="n">name</span> <span class="bp">()</span><span class="o">]);</span>
  <span class="n">print</span> <span class="o">(</span><span class="n">submit</span> <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="s2">&quot;Query&quot;</span> <span class="bp">()</span><span class="o">);</span>
  <span class="n">print</span> <span class="n">end_form</span><span class="o">;</span>

  <span class="c">(* print results of the query if we have someone to look for *)</span>
  <span class="k">if</span> <span class="n">name</span> <span class="o">&lt;&gt;</span> <span class="s2">&quot;&quot;</span> <span class="k">then</span>
    <span class="k">begin</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">h1</span> <span class="o">[</span><span class="s2">&quot;Results&quot;</span><span class="o">]);</span>
      <span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="n">name</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">proc</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_in</span> <span class="s2">&quot;who&quot;</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">found</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">false</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">html</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span> <span class="k">in</span>
      <span class="k">begin</span>
        <span class="c">(* call who and build up text of response *)</span>
        <span class="k">try</span>
          <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
            <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">proc</span> <span class="k">in</span>
            <span class="c">(* only lines matching [name] *)</span>
            <span class="k">if</span> <span class="nn">Str</span><span class="p">.</span><span class="n">string_match</span> <span class="n">regexp</span> <span class="n">line</span> <span class="mi">0</span> <span class="k">then</span>
              <span class="k">begin</span>
                <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_string</span> <span class="n">html</span> <span class="o">(</span><span class="n">escape_html</span> <span class="n">line</span> <span class="o">^</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">);</span>
                <span class="n">found</span> <span class="o">:=</span> <span class="bp">true</span><span class="o">;</span>
              <span class="k">end</span>
          <span class="k">done</span>
        <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
          <span class="n">close_in</span> <span class="n">proc</span><span class="o">;</span>
          <span class="c">(* nice message if we didn&#39;t find anyone by that name *)</span>
          <span class="k">if</span> <span class="n">not</span> <span class="o">!</span><span class="n">found</span>
          <span class="k">then</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_string</span> <span class="n">html</span>
            <span class="o">(</span><span class="n">escape_html</span> <span class="n">name</span> <span class="o">^</span> <span class="s2">&quot; is not logged in&quot;</span><span class="o">);</span>
      <span class="k">end</span><span class="o">;</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">pre</span> <span class="o">[</span><span class="nn">Buffer</span><span class="p">.</span><span class="n">contents</span> <span class="n">html</span><span class="o">]);</span>
    <span class="k">end</span><span class="o">;</span>

  <span class="n">print</span> <span class="n">end_html</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">config</span> <span class="o">=</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">default_config</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">buffered</span> <span class="o">_</span> <span class="n">ch</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">buffered_trans_channel</span> <span class="n">ch</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">output_type</span> <span class="o">=</span> <span class="o">`</span><span class="nc">Transactional</span> <span class="n">buffered</span> <span class="k">in</span>
  <span class="k">if</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">isatty</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span>
  <span class="k">then</span> <span class="nn">Netcgi_test</span><span class="p">.</span><span class="n">run</span> <span class="o">~</span><span class="n">config</span> <span class="o">~</span><span class="n">output_type</span> <span class="n">process</span>
  <span class="k">else</span> <span class="nn">Netcgi_cgi</span><span class="p">.</span><span class="n">run</span> <span class="o">~</span><span class="n">config</span> <span class="o">~</span><span class="n">output_type</span> <span class="n">process</span>

<span class="c">(* @@PLEAC@@_19.12 *)</span>
<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">env</span> <span class="n">ocaml</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netcgi2&quot;</span><span class="o">;;</span>

<span class="k">open</span> <span class="nc">Printf</span>

<span class="k">let</span> <span class="o">(</span> <span class="o">=&gt;</span> <span class="o">)</span> <span class="n">k</span> <span class="n">v</span> <span class="o">=</span> <span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">)</span>

<span class="k">let</span> <span class="n">escape_html</span> <span class="o">=</span> <span class="nn">Netencoding</span><span class="p">.</span><span class="nn">Html</span><span class="p">.</span><span class="n">encode</span> <span class="o">~</span><span class="n">in_enc</span><span class="o">:`</span><span class="nc">Enc_utf8</span> <span class="bp">()</span>

<span class="k">let</span> <span class="n">start_html</span> <span class="n">title</span> <span class="o">=</span>
  <span class="n">sprintf</span> <span class="s2">&quot;\</span>
<span class="s2">&lt;!DOCTYPE html PUBLIC </span><span class="se">\&quot;</span><span class="s2">-//W3C//DTD XHTML 1.0 Transitional//EN</span><span class="se">\&quot;</span><span class="s2"> </span><span class="se">\&quot;</span><span class="s2">http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd</span><span class="se">\&quot;</span><span class="s2">&gt;</span>
<span class="s2">&lt;html xmlns=</span><span class="se">\&quot;</span><span class="s2">http://www.w3.org/1999/xhtml</span><span class="se">\&quot;</span><span class="s2">&gt;</span>
<span class="s2">    &lt;head&gt;</span>
<span class="s2">        &lt;title&gt;%s&lt;/title&gt;</span>
<span class="s2">        &lt;meta http-equiv=</span><span class="se">\&quot;</span><span class="s2">Content-Type</span><span class="se">\&quot;</span><span class="s2"> content=</span><span class="se">\&quot;</span><span class="s2">text/html; charset=UTF-8</span><span class="se">\&quot;</span><span class="s2"> /&gt;</span>
<span class="s2">    &lt;/head&gt;</span>
<span class="s2">    &lt;body&gt;</span>
<span class="s2">&quot;</span> <span class="o">(</span><span class="n">escape_html</span> <span class="n">title</span><span class="o">)</span>

<span class="k">let</span> <span class="n">end_html</span> <span class="o">=</span> <span class="s2">&quot;</span>
<span class="s2">    &lt;/body&gt;</span>
<span class="s2">&lt;/html&gt;</span>
<span class="s2">&quot;</span>

<span class="k">let</span> <span class="n">h1</span> <span class="n">contents</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;h1&gt;%s&lt;/h1&gt;&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="n">contents</span><span class="o">)</span>
<span class="k">let</span> <span class="n">p</span> <span class="n">contents</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;p&gt;%s&lt;/p&gt;&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="n">contents</span><span class="o">)</span>
<span class="k">let</span> <span class="n">pre</span> <span class="n">contents</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;pre&gt;%s&lt;/pre&gt;&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="n">contents</span><span class="o">)</span>

<span class="k">let</span> <span class="n">start_form</span> <span class="o">?(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="o">?(</span><span class="k">method&#39;</span><span class="o">=</span><span class="s2">&quot;get&quot;</span><span class="o">)</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">sprintf</span> <span class="s2">&quot;&lt;form action=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> method=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2">&gt;&quot;</span>
    <span class="o">(</span><span class="n">escape_html</span> <span class="n">action</span><span class="o">)</span> <span class="o">(</span><span class="n">escape_html</span> <span class="k">method&#39;</span><span class="o">)</span>
<span class="k">let</span> <span class="n">end_form</span> <span class="o">=</span> <span class="s2">&quot;&lt;/form&gt;&quot;</span>

<span class="k">let</span> <span class="n">hidden</span> <span class="o">?(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="o">?(</span><span class="k">value</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">sprintf</span> <span class="s2">&quot;&lt;input type=</span><span class="se">\&quot;</span><span class="s2">hidden</span><span class="se">\&quot;</span><span class="s2"> name=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> value=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> /&gt;&quot;</span>
    <span class="o">(</span><span class="n">escape_html</span> <span class="n">name</span><span class="o">)</span> <span class="o">(</span><span class="n">escape_html</span> <span class="k">value</span><span class="o">)</span>

<span class="k">let</span> <span class="n">submit</span> <span class="o">?(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="o">?(</span><span class="k">value</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">sprintf</span> <span class="s2">&quot;&lt;input type=</span><span class="se">\&quot;</span><span class="s2">submit</span><span class="se">\&quot;</span><span class="s2"> name=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> value=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> /&gt;&quot;</span>
    <span class="o">(</span><span class="n">escape_html</span> <span class="n">name</span><span class="o">)</span> <span class="o">(</span><span class="n">escape_html</span> <span class="k">value</span><span class="o">)</span>

<span class="k">let</span> <span class="n">popup_menu</span> <span class="o">?(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="o">?(</span><span class="k">value</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="n">values</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">options</span> <span class="o">=</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">map</span>
      <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="k">value&#39;</span><span class="o">,</span> <span class="n">label</span><span class="o">)</span> <span class="o">-&gt;</span>
         <span class="n">sprintf</span> <span class="s2">&quot;&lt;option %s value=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2">&gt;%s&lt;/option&gt;&quot;</span>
           <span class="o">(</span><span class="k">if</span> <span class="k">value</span> <span class="o">=</span> <span class="k">value&#39;</span> <span class="k">then</span> <span class="s2">&quot;selected=</span><span class="se">\&quot;</span><span class="s2">selected</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="o">)</span>
           <span class="o">(</span><span class="n">escape_html</span> <span class="k">value&#39;</span><span class="o">)</span>
           <span class="o">(</span><span class="n">escape_html</span> <span class="n">label</span><span class="o">))</span>
      <span class="n">values</span> <span class="k">in</span>
  <span class="n">sprintf</span> <span class="s2">&quot;&lt;select name=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2">&gt;</span><span class="se">\n</span><span class="s2">%s</span><span class="se">\n</span><span class="s2">&lt;/select&gt;&quot;</span>
    <span class="o">(</span><span class="n">escape_html</span> <span class="n">name</span><span class="o">)</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">options</span><span class="o">)</span>

<span class="k">let</span> <span class="n">standard_header</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">h1</span> <span class="o">[</span><span class="s2">&quot;Program Title&quot;</span><span class="o">]</span>
<span class="k">let</span> <span class="n">standard_footer</span> <span class="bp">()</span> <span class="o">=</span> <span class="s2">&quot;&lt;hr /&gt;&quot;</span>

<span class="k">let</span> <span class="n">to_page</span> <span class="k">value</span> <span class="o">=</span> <span class="n">submit</span> <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;.State&quot;</span> <span class="o">~</span><span class="k">value</span> <span class="bp">()</span>

<span class="c">(* when we get a .State that doesn&#39;t exist *)</span>
<span class="k">let</span> <span class="n">no_such_page</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="n">print</span> <span class="o">=</span> <span class="bp">()</span>

<span class="k">let</span> <span class="n">front_page</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="n">print</span> <span class="n">active</span> <span class="o">=</span> <span class="bp">()</span>
<span class="k">let</span> <span class="n">sweater</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="n">print</span> <span class="n">active</span> <span class="o">=</span> <span class="bp">()</span>
<span class="k">let</span> <span class="n">checkout</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="n">print</span> <span class="n">active</span> <span class="o">=</span> <span class="bp">()</span>
<span class="k">let</span> <span class="n">credit_card</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="n">print</span> <span class="n">active</span> <span class="o">=</span> <span class="bp">()</span>
<span class="k">let</span> <span class="n">order</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="n">print</span> <span class="n">active</span> <span class="o">=</span> <span class="bp">()</span>

<span class="k">let</span> <span class="n">t_shirt</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="n">print</span> <span class="n">active</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">size</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;size&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">color</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;color&quot;</span> <span class="k">in</span>
  <span class="k">if</span> <span class="n">active</span> <span class="k">then</span>
    <span class="k">begin</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;You want to buy a t-shirt?&quot;</span><span class="o">]);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;Size: &quot;</span><span class="o">;</span>
                <span class="n">popup_menu</span> <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;size&quot;</span> <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="n">size</span>
                  <span class="o">[</span><span class="s2">&quot;XL&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;X-Large&quot;</span><span class="o">;</span>
                   <span class="s2">&quot;L&quot;</span>  <span class="o">=&gt;</span> <span class="s2">&quot;Large&quot;</span><span class="o">;</span>
                   <span class="s2">&quot;M&quot;</span>  <span class="o">=&gt;</span> <span class="s2">&quot;Medium&quot;</span><span class="o">;</span>
                   <span class="s2">&quot;S&quot;</span>  <span class="o">=&gt;</span> <span class="s2">&quot;Small&quot;</span><span class="o">;</span>
                   <span class="s2">&quot;XS&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;X-Small&quot;</span><span class="o">]]);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;Color: &quot;</span><span class="o">;</span>
                <span class="n">popup_menu</span> <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;color&quot;</span> <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="n">color</span>
                  <span class="o">[</span><span class="s2">&quot;Black&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Black&quot;</span><span class="o">;</span> <span class="s2">&quot;White&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;White&quot;</span><span class="o">]]);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="n">to_page</span> <span class="s2">&quot;Shoes&quot;</span><span class="o">;</span> <span class="n">to_page</span> <span class="s2">&quot;Checkout&quot;</span><span class="o">]);</span>
    <span class="k">end</span>
  <span class="k">else</span>
    <span class="k">begin</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">hidden</span> <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;size&quot;</span> <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="n">size</span> <span class="bp">()</span><span class="o">);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">hidden</span> <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;color&quot;</span> <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="n">color</span> <span class="bp">()</span><span class="o">);</span>
    <span class="k">end</span>

<span class="k">let</span> <span class="n">states</span> <span class="o">=</span>
  <span class="o">[</span>
    <span class="s2">&quot;Default&quot;</span>  <span class="o">=&gt;</span> <span class="n">front_page</span><span class="o">;</span>
    <span class="s2">&quot;Shirt&quot;</span>    <span class="o">=&gt;</span> <span class="n">t_shirt</span><span class="o">;</span>
    <span class="s2">&quot;Sweater&quot;</span>  <span class="o">=&gt;</span> <span class="n">sweater</span><span class="o">;</span>
    <span class="s2">&quot;Checkout&quot;</span> <span class="o">=&gt;</span> <span class="n">checkout</span><span class="o">;</span>
    <span class="s2">&quot;Card&quot;</span>     <span class="o">=&gt;</span> <span class="n">credit_card</span><span class="o">;</span>
    <span class="s2">&quot;Order&quot;</span>    <span class="o">=&gt;</span> <span class="n">order</span><span class="o">;</span>
    <span class="s2">&quot;Cancel&quot;</span>   <span class="o">=&gt;</span> <span class="n">front_page</span><span class="o">;</span>
  <span class="o">]</span>

<span class="k">let</span> <span class="n">process</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">page</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="o">~</span><span class="n">default</span><span class="o">:</span><span class="s2">&quot;Default&quot;</span> <span class="s2">&quot;.State&quot;</span> <span class="k">in</span>
  <span class="n">cgi</span><span class="o">#</span><span class="n">set_header</span> <span class="o">~</span><span class="n">content_type</span><span class="o">:</span><span class="s2">&quot;text/html&quot;</span> <span class="bp">()</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">print</span> <span class="n">s</span> <span class="o">=</span>
    <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">output_string</span> <span class="n">s</span><span class="o">;</span>
    <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">output_string</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">in</span>
  <span class="n">print</span> <span class="o">(</span><span class="n">start_html</span> <span class="s2">&quot;Program Title&quot;</span><span class="o">);</span>
  <span class="n">print</span> <span class="o">(</span><span class="n">standard_header</span> <span class="bp">()</span><span class="o">);</span>
  <span class="n">print</span> <span class="o">(</span><span class="n">start_form</span> <span class="bp">()</span><span class="o">);</span>
  <span class="k">if</span> <span class="nn">List</span><span class="p">.</span><span class="n">mem_assoc</span> <span class="n">page</span> <span class="n">states</span>
  <span class="k">then</span> <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">state</span><span class="o">,</span> <span class="n">sub</span><span class="o">)</span> <span class="o">-&gt;</span>
                    <span class="n">sub</span> <span class="n">cgi</span> <span class="n">print</span> <span class="o">(</span><span class="n">page</span> <span class="o">=</span> <span class="n">state</span><span class="o">))</span> <span class="n">states</span>
  <span class="k">else</span> <span class="n">no_such_page</span> <span class="n">cgi</span> <span class="n">print</span><span class="o">;</span>
  <span class="n">print</span> <span class="o">(</span><span class="n">standard_footer</span> <span class="bp">()</span><span class="o">);</span>
  <span class="n">print</span> <span class="n">end_form</span><span class="o">;</span>
  <span class="n">print</span> <span class="n">end_html</span><span class="o">;</span>
  <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">commit_work</span> <span class="bp">()</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">config</span> <span class="o">=</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">default_config</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">buffered</span> <span class="o">_</span> <span class="n">ch</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">buffered_trans_channel</span> <span class="n">ch</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">output_type</span> <span class="o">=</span> <span class="o">`</span><span class="nc">Transactional</span> <span class="n">buffered</span> <span class="k">in</span>
  <span class="k">if</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">isatty</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span>
  <span class="k">then</span> <span class="nn">Netcgi_test</span><span class="p">.</span><span class="n">run</span> <span class="o">~</span><span class="n">config</span> <span class="o">~</span><span class="n">output_type</span> <span class="n">process</span>
  <span class="k">else</span> <span class="nn">Netcgi_cgi</span><span class="p">.</span><span class="n">run</span> <span class="o">~</span><span class="n">config</span> <span class="o">~</span><span class="n">output_type</span> <span class="n">process</span>

<span class="c">(* @@PLEAC@@_19.13 *)</span>
<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">env</span> <span class="n">ocaml</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netcgi2&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">escape</span>   <span class="o">=</span> <span class="nn">Netencoding</span><span class="p">.</span><span class="nn">Url</span><span class="p">.</span><span class="n">encode</span> <span class="o">~</span><span class="n">plus</span><span class="o">:</span><span class="bp">false</span>
<span class="k">let</span> <span class="n">unescape</span> <span class="o">=</span> <span class="nn">Netencoding</span><span class="p">.</span><span class="nn">Url</span><span class="p">.</span><span class="n">decode</span> <span class="o">~</span><span class="n">plus</span><span class="o">:</span><span class="bp">false</span>

<span class="k">let</span> <span class="n">save_arguments</span> <span class="o">(</span><span class="n">ch</span> <span class="o">:</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">out_obj_channel</span><span class="o">)</span> <span class="n">args</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">arg</span> <span class="o">-&gt;</span>
       <span class="n">ch</span><span class="o">#</span><span class="n">output_string</span> <span class="o">(</span><span class="n">escape</span> <span class="n">arg</span><span class="o">#</span><span class="n">name</span><span class="o">);</span>
       <span class="n">ch</span><span class="o">#</span><span class="n">output_char</span> <span class="sc">&#39;=&#39;</span><span class="o">;</span>
       <span class="n">ch</span><span class="o">#</span><span class="n">output_string</span> <span class="o">(</span><span class="n">escape</span> <span class="n">arg</span><span class="o">#</span><span class="k">value</span><span class="o">);</span>
       <span class="n">ch</span><span class="o">#</span><span class="n">output_char</span> <span class="sc">&#39;\n&#39;</span><span class="o">)</span>
    <span class="n">args</span><span class="o">;</span>
  <span class="n">ch</span><span class="o">#</span><span class="n">output_string</span> <span class="s2">&quot;=</span><span class="se">\n</span><span class="s2">&quot;</span>

<span class="k">let</span> <span class="n">process</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="o">=</span>
  <span class="c">(* first open and exclusively lock the file *)</span>
  <span class="k">let</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">open_out_gen</span> <span class="o">[</span><span class="nc">Open_append</span><span class="o">;</span> <span class="nc">Open_creat</span><span class="o">]</span> <span class="mo">0o666</span> <span class="s2">&quot;/tmp/formlog&quot;</span> <span class="k">in</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">lockf</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">descr_of_out_channel</span> <span class="n">ch</span><span class="o">)</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">F_LOCK</span> <span class="mi">0</span><span class="o">;</span>

  <span class="c">(* locally set some additional arguments *)</span>
  <span class="k">let</span> <span class="n">arguments</span> <span class="o">=</span>
    <span class="nn">Netcgi</span><span class="p">.</span><span class="nn">Argument</span><span class="p">.</span><span class="n">set</span>
      <span class="o">[</span>
        <span class="nn">Netcgi</span><span class="p">.</span><span class="nn">Argument</span><span class="p">.</span><span class="n">simple</span> <span class="s2">&quot;_timestamp&quot;</span>
          <span class="o">(</span><span class="n">string_of_float</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">time</span> <span class="bp">()</span><span class="o">));</span>
        <span class="nn">Netcgi</span><span class="p">.</span><span class="nn">Argument</span><span class="p">.</span><span class="n">simple</span> <span class="s2">&quot;_environs&quot;</span>
          <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">environment</span> <span class="bp">()</span><span class="o">)));</span>
      <span class="o">]</span>
      <span class="n">cgi</span><span class="o">#</span><span class="n">arguments</span> <span class="k">in</span>

  <span class="c">(* wrap output in a Netchannel and save *)</span>
  <span class="k">let</span> <span class="n">ch</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">output_channel</span> <span class="n">ch</span> <span class="k">in</span>
  <span class="n">save_arguments</span> <span class="n">ch</span> <span class="n">arguments</span><span class="o">;</span>
  <span class="n">ch</span><span class="o">#</span><span class="n">close_out</span> <span class="bp">()</span><span class="o">;</span>

  <span class="c">(* send in an email *)</span>
  <span class="k">let</span> <span class="n">body</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">create</span> <span class="mi">256</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">ch</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">output_buffer</span> <span class="n">body</span> <span class="k">in</span>
  <span class="n">save_arguments</span> <span class="n">ch</span> <span class="n">arguments</span><span class="o">;</span>
  <span class="nn">Netsendmail</span><span class="p">.</span><span class="n">sendmail</span>
    <span class="o">(</span><span class="nn">Netsendmail</span><span class="p">.</span><span class="n">compose</span>
       <span class="o">~</span><span class="n">from_addr</span><span class="o">:(</span><span class="s2">&quot;your cgi script&quot;</span><span class="o">,</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">))</span>
       <span class="o">~</span><span class="n">to_addrs</span><span class="o">:[(</span><span class="s2">&quot;hisname&quot;</span><span class="o">,</span> <span class="s2">&quot;hisname@hishost.com&quot;</span><span class="o">)]</span>
       <span class="o">~</span><span class="n">subject</span><span class="o">:</span><span class="s2">&quot;mailed form submission&quot;</span>
       <span class="o">(</span><span class="nn">Buffer</span><span class="p">.</span><span class="n">contents</span> <span class="n">body</span><span class="o">))</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">config</span> <span class="o">=</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">default_config</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">buffered</span> <span class="o">_</span> <span class="n">ch</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">buffered_trans_channel</span> <span class="n">ch</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">output_type</span> <span class="o">=</span> <span class="o">`</span><span class="nc">Transactional</span> <span class="n">buffered</span> <span class="k">in</span>
  <span class="k">if</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">isatty</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span>
  <span class="k">then</span> <span class="nn">Netcgi_test</span><span class="p">.</span><span class="n">run</span> <span class="o">~</span><span class="n">config</span> <span class="o">~</span><span class="n">output_type</span> <span class="n">process</span>
  <span class="k">else</span> <span class="nn">Netcgi_cgi</span><span class="p">.</span><span class="n">run</span> <span class="o">~</span><span class="n">config</span> <span class="o">~</span><span class="n">output_type</span> <span class="n">process</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;str&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;unix&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netstring&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">escape</span>   <span class="o">=</span> <span class="nn">Netencoding</span><span class="p">.</span><span class="nn">Url</span><span class="p">.</span><span class="n">encode</span> <span class="o">~</span><span class="n">plus</span><span class="o">:</span><span class="bp">false</span>
<span class="k">let</span> <span class="n">unescape</span> <span class="o">=</span> <span class="nn">Netencoding</span><span class="p">.</span><span class="nn">Url</span><span class="p">.</span><span class="n">decode</span> <span class="o">~</span><span class="n">plus</span><span class="o">:</span><span class="bp">false</span>

<span class="k">let</span> <span class="n">parse_env</span> <span class="n">data</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">result</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">16</span> <span class="k">in</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span>
       <span class="k">try</span>
         <span class="k">let</span> <span class="n">index</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">index</span> <span class="n">line</span> <span class="sc">&#39;=&#39;</span> <span class="k">in</span>
         <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">add</span> <span class="n">result</span>
           <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">line</span> <span class="mi">0</span> <span class="n">index</span><span class="o">)</span>
           <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">line</span> <span class="o">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">line</span> <span class="o">-</span> <span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="o">))</span>
       <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">)</span>
    <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">split</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span> <span class="n">data</span><span class="o">);</span>
  <span class="n">result</span>

<span class="k">let</span> <span class="n">ends_with</span> <span class="n">suffix</span> <span class="n">s</span> <span class="o">=</span>
  <span class="k">try</span> <span class="nn">Str</span><span class="p">.</span><span class="n">last_chars</span> <span class="n">s</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">suffix</span><span class="o">)</span> <span class="o">=</span> <span class="n">suffix</span>
  <span class="k">with</span> <span class="nc">Invalid_argument</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">false</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">forms</span> <span class="o">=</span> <span class="n">open_in</span> <span class="s2">&quot;/tmp/formlog&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">args</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">8</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="nn">Unix</span><span class="p">.</span><span class="n">lockf</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">descr_of_in_channel</span> <span class="n">forms</span><span class="o">)</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">F_RLOCK</span> <span class="mi">0</span><span class="o">;</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="k">let</span> <span class="n">line</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">forms</span> <span class="k">in</span>
      <span class="k">if</span> <span class="n">line</span> <span class="o">=</span> <span class="s2">&quot;=&quot;</span> <span class="k">then</span>
        <span class="k">begin</span>
          <span class="k">let</span> <span class="n">his_env</span> <span class="o">=</span> <span class="n">parse_env</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">args</span> <span class="s2">&quot;_environs&quot;</span><span class="o">)</span> <span class="k">in</span>
          <span class="k">let</span> <span class="n">host</span> <span class="o">=</span>
            <span class="k">try</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">his_env</span> <span class="s2">&quot;REMOTE_HOST&quot;</span>
            <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="s2">&quot;&quot;</span> <span class="k">in</span>
          <span class="k">if</span> <span class="n">host</span> <span class="o">&lt;&gt;</span> <span class="s2">&quot;perl.com&quot;</span> <span class="o">&amp;&amp;</span> <span class="n">not</span> <span class="o">(</span><span class="n">ends_with</span> <span class="s2">&quot;.perl.com&quot;</span> <span class="n">host</span><span class="o">)</span>
          <span class="k">then</span> <span class="o">(</span><span class="n">count</span> <span class="o">:=</span>
                  <span class="o">(!</span><span class="n">count</span> <span class="o">+</span>
                     <span class="n">int_of_string</span>
                     <span class="o">(</span><span class="k">try</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">args</span> <span class="s2">&quot;items requested&quot;</span>
                      <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="s2">&quot;0&quot;</span><span class="o">)));</span>
          <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">clear</span> <span class="n">args</span>
        <span class="k">end</span>
      <span class="k">else</span>
        <span class="k">begin</span>
          <span class="k">let</span> <span class="n">index</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">index</span> <span class="n">line</span> <span class="sc">&#39;=&#39;</span> <span class="k">in</span>
          <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">add</span> <span class="n">args</span>
            <span class="o">(</span><span class="n">unescape</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">line</span> <span class="mi">0</span> <span class="n">index</span><span class="o">))</span>
            <span class="o">(</span><span class="n">unescape</span>
               <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">sub</span>
                  <span class="n">line</span>
                  <span class="o">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="o">)</span>
                  <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">line</span> <span class="o">-</span> <span class="n">index</span> <span class="o">-</span> <span class="mi">1</span><span class="o">)))</span>
        <span class="k">end</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span>
    <span class="n">close_in</span> <span class="n">forms</span><span class="o">;</span>
    <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;Total orders: %d</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">!</span><span class="n">count</span>

<span class="c">(* @@PLEAC@@_19.14 *)</span>
<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">env</span> <span class="n">ocaml</span>
<span class="c">(* chemiserie - simple CGI shopping for shirts and sweaters *)</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netcgi2&quot;</span><span class="o">;;</span>

<span class="k">open</span> <span class="nc">Printf</span>

<span class="k">let</span> <span class="o">(</span> <span class="o">=&gt;</span> <span class="o">)</span> <span class="n">k</span> <span class="n">v</span> <span class="o">=</span> <span class="o">(</span><span class="n">k</span><span class="o">,</span> <span class="n">v</span><span class="o">)</span>

<span class="k">let</span> <span class="n">escape_html</span> <span class="o">=</span> <span class="nn">Netencoding</span><span class="p">.</span><span class="nn">Html</span><span class="p">.</span><span class="n">encode</span> <span class="o">~</span><span class="n">in_enc</span><span class="o">:`</span><span class="nc">Enc_utf8</span> <span class="bp">()</span>

<span class="k">let</span> <span class="n">start_html</span> <span class="n">title</span> <span class="o">=</span>
  <span class="n">sprintf</span> <span class="s2">&quot;\</span>
<span class="s2">&lt;!DOCTYPE html PUBLIC </span><span class="se">\&quot;</span><span class="s2">-//W3C//DTD XHTML 1.0 Transitional//EN</span><span class="se">\&quot;</span><span class="s2"> </span><span class="se">\&quot;</span><span class="s2">http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd</span><span class="se">\&quot;</span><span class="s2">&gt;</span>
<span class="s2">&lt;html xmlns=</span><span class="se">\&quot;</span><span class="s2">http://www.w3.org/1999/xhtml</span><span class="se">\&quot;</span><span class="s2">&gt;</span>
<span class="s2">    &lt;head&gt;</span>
<span class="s2">        &lt;title&gt;%s&lt;/title&gt;</span>
<span class="s2">        &lt;meta http-equiv=</span><span class="se">\&quot;</span><span class="s2">Content-Type</span><span class="se">\&quot;</span><span class="s2"> content=</span><span class="se">\&quot;</span><span class="s2">text/html; charset=UTF-8</span><span class="se">\&quot;</span><span class="s2"> /&gt;</span>
<span class="s2">    &lt;/head&gt;</span>
<span class="s2">    &lt;body&gt;</span>
<span class="s2">&quot;</span> <span class="o">(</span><span class="n">escape_html</span> <span class="n">title</span><span class="o">)</span>

<span class="k">let</span> <span class="n">end_html</span> <span class="o">=</span> <span class="s2">&quot;</span>
<span class="s2">    &lt;/body&gt;</span>
<span class="s2">&lt;/html&gt;</span>
<span class="s2">&quot;</span>

<span class="k">let</span> <span class="n">h1</span> <span class="n">contents</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;h1&gt;%s&lt;/h1&gt;&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="n">contents</span><span class="o">)</span>
<span class="k">let</span> <span class="n">h2</span> <span class="n">contents</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;h2&gt;%s&lt;/h2&gt;&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="n">contents</span><span class="o">)</span>
<span class="k">let</span> <span class="n">p</span> <span class="n">contents</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;p&gt;%s&lt;/p&gt;&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="n">contents</span><span class="o">)</span>
<span class="k">let</span> <span class="n">pre</span> <span class="n">contents</span> <span class="o">=</span> <span class="n">sprintf</span> <span class="s2">&quot;&lt;pre&gt;%s&lt;/pre&gt;&quot;</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="n">contents</span><span class="o">)</span>

<span class="k">let</span> <span class="n">start_form</span> <span class="o">?(</span><span class="n">action</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="o">?(</span><span class="k">method&#39;</span><span class="o">=</span><span class="s2">&quot;get&quot;</span><span class="o">)</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">sprintf</span> <span class="s2">&quot;&lt;form action=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> method=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2">&gt;&quot;</span>
    <span class="o">(</span><span class="n">escape_html</span> <span class="n">action</span><span class="o">)</span> <span class="o">(</span><span class="n">escape_html</span> <span class="k">method&#39;</span><span class="o">)</span>
<span class="k">let</span> <span class="n">end_form</span> <span class="o">=</span> <span class="s2">&quot;&lt;/form&gt;&quot;</span>

<span class="k">let</span> <span class="n">hidden</span> <span class="o">?(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="o">?(</span><span class="k">value</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">sprintf</span> <span class="s2">&quot;&lt;input type=</span><span class="se">\&quot;</span><span class="s2">hidden</span><span class="se">\&quot;</span><span class="s2"> name=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> value=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> /&gt;&quot;</span>
    <span class="o">(</span><span class="n">escape_html</span> <span class="n">name</span><span class="o">)</span> <span class="o">(</span><span class="n">escape_html</span> <span class="k">value</span><span class="o">)</span>

<span class="k">let</span> <span class="n">submit</span> <span class="o">?(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="o">?(</span><span class="k">value</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">sprintf</span> <span class="s2">&quot;&lt;input type=</span><span class="se">\&quot;</span><span class="s2">submit</span><span class="se">\&quot;</span><span class="s2"> name=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> value=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> /&gt;&quot;</span>
    <span class="o">(</span><span class="n">escape_html</span> <span class="n">name</span><span class="o">)</span> <span class="o">(</span><span class="n">escape_html</span> <span class="k">value</span><span class="o">)</span>

<span class="k">let</span> <span class="n">textfield</span> <span class="o">?(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="o">?(</span><span class="k">value</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">sprintf</span> <span class="s2">&quot;&lt;input type=</span><span class="se">\&quot;</span><span class="s2">text</span><span class="se">\&quot;</span><span class="s2"> name=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> value=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> /&gt;&quot;</span>
    <span class="o">(</span><span class="n">escape_html</span> <span class="n">name</span><span class="o">)</span> <span class="o">(</span><span class="n">escape_html</span> <span class="k">value</span><span class="o">)</span>

<span class="k">let</span> <span class="n">popup_menu</span> <span class="o">?(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="o">?(</span><span class="k">value</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">)</span> <span class="n">values</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">options</span> <span class="o">=</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">map</span>
      <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="k">value&#39;</span><span class="o">,</span> <span class="n">label</span><span class="o">)</span> <span class="o">-&gt;</span>
         <span class="n">sprintf</span> <span class="s2">&quot;&lt;option %s value=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2">&gt;%s&lt;/option&gt;&quot;</span>
           <span class="o">(</span><span class="k">if</span> <span class="k">value</span> <span class="o">=</span> <span class="k">value&#39;</span> <span class="k">then</span> <span class="s2">&quot;selected=</span><span class="se">\&quot;</span><span class="s2">selected</span><span class="se">\&quot;</span><span class="s2">&quot;</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="o">)</span>
           <span class="o">(</span><span class="n">escape_html</span> <span class="k">value&#39;</span><span class="o">)</span>
           <span class="o">(</span><span class="n">escape_html</span> <span class="n">label</span><span class="o">))</span>
      <span class="n">values</span> <span class="k">in</span>
  <span class="n">sprintf</span> <span class="s2">&quot;&lt;select name=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2">&gt;</span><span class="se">\n</span><span class="s2">%s</span><span class="se">\n</span><span class="s2">&lt;/select&gt;&quot;</span>
    <span class="o">(</span><span class="n">escape_html</span> <span class="n">name</span><span class="o">)</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">options</span><span class="o">)</span>

<span class="k">let</span> <span class="n">defaults</span> <span class="n">label</span> <span class="o">=</span>
  <span class="n">sprintf</span> <span class="s2">&quot;&lt;input type=</span><span class="se">\&quot;</span><span class="s2">button</span><span class="se">\&quot;</span><span class="s2"> value=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> onclick=</span><span class="se">\&quot;</span><span class="s2">%s</span><span class="se">\&quot;</span><span class="s2"> /&gt;&quot;</span>
    <span class="o">(</span><span class="n">escape_html</span> <span class="n">label</span><span class="o">)</span> <span class="s2">&quot;javascript:location.href=&#39;?&#39;&quot;</span>

<span class="k">let</span> <span class="n">to_page</span> <span class="k">value</span> <span class="o">=</span> <span class="n">submit</span> <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;.State&quot;</span> <span class="o">~</span><span class="k">value</span> <span class="bp">()</span>

<span class="c">(********************************</span>
<span class="c"> * header, footer, menu functions</span>
<span class="c"> ********************************)</span>

<span class="k">let</span> <span class="n">standard_header</span> <span class="n">print</span> <span class="o">=</span>
  <span class="n">print</span> <span class="o">(</span><span class="n">start_html</span> <span class="s2">&quot;Shirts&quot;</span><span class="o">);</span>
  <span class="n">print</span> <span class="o">(</span><span class="n">start_form</span> <span class="bp">()</span><span class="o">)</span>

<span class="k">let</span> <span class="n">standard_footer</span> <span class="n">print</span> <span class="o">=</span>
  <span class="n">print</span> <span class="n">end_form</span><span class="o">;</span>
  <span class="n">print</span> <span class="n">end_html</span>

<span class="k">let</span> <span class="n">shop_menu</span> <span class="n">print</span> <span class="o">=</span>
  <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="n">defaults</span> <span class="s2">&quot;Empty My Shopping Cart&quot;</span><span class="o">;</span>
            <span class="n">to_page</span> <span class="s2">&quot;Shirt&quot;</span><span class="o">;</span>
            <span class="n">to_page</span> <span class="s2">&quot;Sweater&quot;</span><span class="o">;</span>
            <span class="n">to_page</span> <span class="s2">&quot;Checkout&quot;</span><span class="o">])</span>

<span class="c">(*****************************</span>
<span class="c"> * subroutines for each screen</span>
<span class="c"> *****************************)</span>

<span class="c">(* The default page. *)</span>
<span class="k">let</span> <span class="n">front_page</span> <span class="n">cgi</span> <span class="n">print</span> <span class="n">active</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">active</span> <span class="k">then</span>
    <span class="k">begin</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">h1</span> <span class="o">[</span><span class="s2">&quot;Hi!&quot;</span><span class="o">]);</span>
      <span class="n">print</span> <span class="s2">&quot;Welcome to our Shirt Shop!  Please make your selection &quot;</span><span class="o">;</span>
      <span class="n">print</span> <span class="s2">&quot;from the menu below.&quot;</span><span class="o">;</span>
      <span class="n">shop_menu</span> <span class="n">print</span><span class="o">;</span>
    <span class="k">end</span>

<span class="c">(* Page to order a shirt from. *)</span>
<span class="k">let</span> <span class="n">shirt</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="n">print</span> <span class="n">active</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">sizes</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;XL&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;X-Large&quot;</span><span class="o">;</span>
               <span class="s2">&quot;L&quot;</span>  <span class="o">=&gt;</span> <span class="s2">&quot;Large&quot;</span><span class="o">;</span>
               <span class="s2">&quot;M&quot;</span>  <span class="o">=&gt;</span> <span class="s2">&quot;Medium&quot;</span><span class="o">;</span>
               <span class="s2">&quot;S&quot;</span>  <span class="o">=&gt;</span> <span class="s2">&quot;Small&quot;</span><span class="o">;</span>
               <span class="s2">&quot;XS&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;X-Small&quot;</span><span class="o">]</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">colors</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;Black&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Black&quot;</span><span class="o">;</span> <span class="s2">&quot;White&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;White&quot;</span><span class="o">]</span> <span class="k">in</span>

  <span class="k">let</span> <span class="n">size</span><span class="o">,</span> <span class="n">color</span><span class="o">,</span> <span class="n">count</span> <span class="o">=</span>
    <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;shirt_size&quot;</span><span class="o">,</span>
    <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;shirt_color&quot;</span><span class="o">,</span>
    <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;shirt_count&quot;</span> <span class="k">in</span>

  <span class="c">(* sanity check *)</span>
  <span class="k">let</span> <span class="n">size</span> <span class="o">=</span>
    <span class="k">if</span> <span class="nn">List</span><span class="p">.</span><span class="n">mem_assoc</span> <span class="n">size</span> <span class="n">sizes</span>
    <span class="k">then</span> <span class="n">size</span>
    <span class="k">else</span> <span class="n">fst</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">hd</span> <span class="n">sizes</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">color</span> <span class="o">=</span>
    <span class="k">if</span> <span class="nn">List</span><span class="p">.</span><span class="n">mem_assoc</span> <span class="n">color</span> <span class="n">colors</span>
    <span class="k">then</span> <span class="n">color</span>
    <span class="k">else</span> <span class="n">fst</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">hd</span> <span class="n">colors</span><span class="o">)</span> <span class="k">in</span>

  <span class="k">if</span> <span class="n">active</span> <span class="k">then</span>
    <span class="k">begin</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">h1</span> <span class="o">[</span><span class="s2">&quot;T-Shirt&quot;</span><span class="o">]);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;What a shirt!  This baby is decked out with all the &quot;</span><span class="o">;</span>
                <span class="s2">&quot;options. It comes with full luxury interior, cotton &quot;</span><span class="o">;</span>
                <span class="s2">&quot;trim, and a collar to make your eyes water! &quot;</span><span class="o">;</span>
                <span class="s2">&quot;Unit price: $33.00&quot;</span><span class="o">]);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">h2</span> <span class="o">[</span><span class="s2">&quot;Options&quot;</span><span class="o">]);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;How Many? &quot;</span><span class="o">;</span>
                <span class="n">textfield</span>
                  <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;shirt_count&quot;</span>
                  <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="n">count</span> <span class="bp">()</span><span class="o">]);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;Size? &quot;</span><span class="o">;</span>
                <span class="n">popup_menu</span> <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;shirt_size&quot;</span> <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="n">size</span> <span class="n">sizes</span><span class="o">]);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;Color? &quot;</span><span class="o">;</span>
                <span class="n">popup_menu</span> <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;shirt_color&quot;</span> <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="n">color</span> <span class="n">colors</span><span class="o">]);</span>
      <span class="n">shop_menu</span> <span class="n">print</span><span class="o">;</span>
    <span class="k">end</span>
  <span class="k">else</span>
    <span class="k">begin</span>
      <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;&gt;</span> <span class="s2">&quot;&quot;</span>
      <span class="k">then</span> <span class="n">print</span> <span class="o">(</span><span class="n">hidden</span> <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;shirt_size&quot;</span> <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="n">size</span> <span class="bp">()</span><span class="o">);</span>
      <span class="k">if</span> <span class="n">color</span> <span class="o">&lt;&gt;</span> <span class="s2">&quot;&quot;</span>
      <span class="k">then</span> <span class="n">print</span> <span class="o">(</span><span class="n">hidden</span> <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;shirt_color&quot;</span> <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="n">color</span> <span class="bp">()</span><span class="o">);</span>
      <span class="k">if</span> <span class="n">count</span> <span class="o">&lt;&gt;</span> <span class="s2">&quot;&quot;</span>
      <span class="k">then</span> <span class="n">print</span> <span class="o">(</span><span class="n">hidden</span> <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;shirt_count&quot;</span> <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="n">count</span> <span class="bp">()</span><span class="o">);</span>
    <span class="k">end</span>

<span class="c">(* Page to order a sweater from. *)</span>
<span class="k">let</span> <span class="n">sweater</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="n">print</span> <span class="n">active</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">sizes</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;XL&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;X-Large&quot;</span><span class="o">;</span>
               <span class="s2">&quot;L&quot;</span>  <span class="o">=&gt;</span> <span class="s2">&quot;Large&quot;</span><span class="o">;</span>
               <span class="s2">&quot;M&quot;</span>  <span class="o">=&gt;</span> <span class="s2">&quot;Medium&quot;</span><span class="o">]</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">colors</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;Chartreuse&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Chartreuse&quot;</span><span class="o">;</span>
                <span class="s2">&quot;Puce&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Puce&quot;</span><span class="o">;</span>
                <span class="s2">&quot;Lavender&quot;</span> <span class="o">=&gt;</span> <span class="s2">&quot;Lavender&quot;</span><span class="o">]</span> <span class="k">in</span>

  <span class="k">let</span> <span class="n">size</span><span class="o">,</span> <span class="n">color</span><span class="o">,</span> <span class="n">count</span> <span class="o">=</span>
    <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;sweater_size&quot;</span><span class="o">,</span>
    <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;sweater_color&quot;</span><span class="o">,</span>
    <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;sweater_count&quot;</span> <span class="k">in</span>

  <span class="c">(* sanity check *)</span>
  <span class="k">let</span> <span class="n">size</span> <span class="o">=</span>
    <span class="k">if</span> <span class="nn">List</span><span class="p">.</span><span class="n">mem_assoc</span> <span class="n">size</span> <span class="n">sizes</span>
    <span class="k">then</span> <span class="n">size</span>
    <span class="k">else</span> <span class="n">fst</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">hd</span> <span class="n">sizes</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">color</span> <span class="o">=</span>
    <span class="k">if</span> <span class="nn">List</span><span class="p">.</span><span class="n">mem_assoc</span> <span class="n">color</span> <span class="n">colors</span>
    <span class="k">then</span> <span class="n">color</span>
    <span class="k">else</span> <span class="n">fst</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">hd</span> <span class="n">colors</span><span class="o">)</span> <span class="k">in</span>

  <span class="k">if</span> <span class="n">active</span> <span class="k">then</span>
    <span class="k">begin</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">h1</span> <span class="o">[</span><span class="s2">&quot;Sweater&quot;</span><span class="o">]);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;Nothing implies preppy elegance more than this fine &quot;</span><span class="o">;</span>
                <span class="s2">&quot;sweater.  Made by peasant workers from black market &quot;</span><span class="o">;</span>
                <span class="s2">&quot;silk, it slides onto your lean form and cries out &quot;</span><span class="o">;</span>
                <span class="s2">&quot;``Take me, for I am a god!&#39;&#39;.  Unit price: $49.99.&quot;</span><span class="o">]);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">h2</span> <span class="o">[</span><span class="s2">&quot;Options&quot;</span><span class="o">]);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;How Many? &quot;</span><span class="o">;</span>
                <span class="n">textfield</span>
                  <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;sweater_count&quot;</span>
                  <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="n">count</span> <span class="bp">()</span><span class="o">]);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;Size? &quot;</span><span class="o">;</span>
                <span class="n">popup_menu</span> <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;sweater_size&quot;</span> <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="n">size</span> <span class="n">sizes</span><span class="o">]);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;Color? &quot;</span><span class="o">;</span>
                <span class="n">popup_menu</span> <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;sweater_color&quot;</span> <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="n">color</span> <span class="n">colors</span><span class="o">]);</span>
      <span class="n">shop_menu</span> <span class="n">print</span><span class="o">;</span>
    <span class="k">end</span>
  <span class="k">else</span>
    <span class="k">begin</span>
      <span class="k">if</span> <span class="n">size</span> <span class="o">&lt;&gt;</span> <span class="s2">&quot;&quot;</span>
      <span class="k">then</span> <span class="n">print</span> <span class="o">(</span><span class="n">hidden</span> <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;sweater_size&quot;</span> <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="n">size</span> <span class="bp">()</span><span class="o">);</span>
      <span class="k">if</span> <span class="n">color</span> <span class="o">&lt;&gt;</span> <span class="s2">&quot;&quot;</span>
      <span class="k">then</span> <span class="n">print</span> <span class="o">(</span><span class="n">hidden</span> <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;sweater_color&quot;</span> <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="n">color</span> <span class="bp">()</span><span class="o">);</span>
      <span class="k">if</span> <span class="n">count</span> <span class="o">&lt;&gt;</span> <span class="s2">&quot;&quot;</span>
      <span class="k">then</span> <span class="n">print</span> <span class="o">(</span><span class="n">hidden</span> <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;sweater_count&quot;</span> <span class="o">~</span><span class="k">value</span><span class="o">:</span><span class="n">count</span> <span class="bp">()</span><span class="o">);</span>
    <span class="k">end</span>

<span class="k">let</span> <span class="n">calculate_price</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">shirts</span> <span class="o">=</span>
    <span class="k">try</span> <span class="n">int_of_string</span> <span class="o">(</span><span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;shirt_count&quot;</span><span class="o">)</span>
    <span class="k">with</span> <span class="nc">Failure</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">sweaters</span> <span class="o">=</span>
    <span class="k">try</span> <span class="n">int_of_string</span> <span class="o">(</span><span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;shirt_count&quot;</span><span class="o">)</span>
    <span class="k">with</span> <span class="nc">Failure</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="n">sprintf</span> <span class="s2">&quot;$%.2f&quot;</span> <span class="o">(</span><span class="kt">float</span> <span class="n">shirts</span> <span class="o">*.</span> <span class="mi">33</span><span class="o">.</span><span class="mi">0</span> <span class="o">+.</span> <span class="kt">float</span> <span class="n">sweaters</span> <span class="o">*.</span> <span class="mi">49</span><span class="o">.</span><span class="mi">99</span><span class="o">)</span>

<span class="c">(* Returns HTML for the current order (&quot;You have ordered ...&quot;) *)</span>
<span class="k">let</span> <span class="n">order_text</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">shirt_count</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;shirt_count&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">shirt_size</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;shirt_size&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">shirt_color</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;shirt_color&quot;</span> <span class="k">in</span>

  <span class="k">let</span> <span class="n">sweater_count</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;sweater_count&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">sweater_size</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;sweater_size&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">sweater_color</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;sweater_color&quot;</span> <span class="k">in</span>

  <span class="k">let</span> <span class="n">html</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span> <span class="k">in</span>

  <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">mem</span> <span class="n">shirt_count</span> <span class="o">[</span><span class="s2">&quot;&quot;</span><span class="o">;</span> <span class="s2">&quot;0&quot;</span><span class="o">])</span> <span class="k">then</span>
    <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_string</span> <span class="n">html</span>
      <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;You have ordered &quot;</span><span class="o">;</span> <span class="n">escape_html</span> <span class="n">shirt_count</span><span class="o">;</span>
          <span class="s2">&quot; shirts of size &quot;</span><span class="o">;</span> <span class="n">escape_html</span> <span class="n">shirt_size</span><span class="o">;</span>
          <span class="s2">&quot; and color &quot;</span><span class="o">;</span> <span class="n">escape_html</span> <span class="n">shirt_color</span><span class="o">;</span> <span class="s2">&quot;.&quot;</span><span class="o">]);</span>

  <span class="k">if</span> <span class="n">not</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">mem</span> <span class="n">sweater_count</span> <span class="o">[</span><span class="s2">&quot;&quot;</span><span class="o">;</span> <span class="s2">&quot;0&quot;</span><span class="o">])</span> <span class="k">then</span>
    <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_string</span> <span class="n">html</span>
      <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;You have ordered &quot;</span><span class="o">;</span> <span class="n">escape_html</span> <span class="n">sweater_count</span><span class="o">;</span>
          <span class="s2">&quot; sweaters of size &quot;</span><span class="o">;</span> <span class="n">escape_html</span> <span class="n">sweater_size</span><span class="o">;</span>
          <span class="s2">&quot; and color &quot;</span><span class="o">;</span> <span class="n">escape_html</span> <span class="n">sweater_color</span><span class="o">;</span> <span class="s2">&quot;.&quot;</span><span class="o">]);</span>

  <span class="k">let</span> <span class="n">html</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">contents</span> <span class="n">html</span> <span class="k">in</span>
  <span class="k">match</span> <span class="n">html</span> <span class="k">with</span>
    <span class="o">|</span> <span class="s2">&quot;&quot;</span> <span class="o">-&gt;</span> <span class="n">p</span> <span class="o">[</span><span class="s2">&quot;Nothing!&quot;</span><span class="o">]</span>
    <span class="o">|</span> <span class="n">html</span> <span class="o">-&gt;</span> <span class="n">html</span> <span class="o">^</span> <span class="n">p</span> <span class="o">[</span><span class="s2">&quot;For a total cost of &quot;</span><span class="o">;</span> <span class="n">calculate_price</span> <span class="n">cgi</span><span class="o">]</span>

<span class="c">(* Page to display current order for confirmation. *)</span>
<span class="k">let</span> <span class="n">checkout</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="n">print</span> <span class="n">active</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">active</span> <span class="k">then</span>
    <span class="k">begin</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">h1</span> <span class="o">[</span><span class="s2">&quot;Order Confirmation&quot;</span><span class="o">]);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;You ordered the following:&quot;</span><span class="o">]);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">order_text</span> <span class="n">cgi</span><span class="o">);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;Is this right?  Select &#39;Card&#39; to pay for the items &quot;</span><span class="o">;</span>
                <span class="s2">&quot;or &#39;Shirt&#39; or &#39;Sweater&#39; to continue shopping.&quot;</span><span class="o">]);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="n">to_page</span> <span class="s2">&quot;Card&quot;</span><span class="o">;</span>
                <span class="n">to_page</span> <span class="s2">&quot;Shirt&quot;</span><span class="o">;</span>
                <span class="n">to_page</span> <span class="s2">&quot;Sweater&quot;</span><span class="o">]);</span>
    <span class="k">end</span>

<span class="c">(* Page to gather credit-card information. *)</span>
<span class="k">let</span> <span class="n">credit_card</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="n">print</span> <span class="n">active</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">widgets</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;Name&quot;</span><span class="o">;</span> <span class="s2">&quot;Address1&quot;</span><span class="o">;</span> <span class="s2">&quot;Address2&quot;</span><span class="o">;</span> <span class="s2">&quot;City&quot;</span><span class="o">;</span> <span class="s2">&quot;Zip&quot;</span><span class="o">;</span> <span class="s2">&quot;State&quot;</span><span class="o">;</span>
                 <span class="s2">&quot;Phone&quot;</span><span class="o">;</span> <span class="s2">&quot;Card&quot;</span><span class="o">;</span> <span class="s2">&quot;Expiry&quot;</span><span class="o">]</span> <span class="k">in</span>
  <span class="k">if</span> <span class="n">active</span> <span class="k">then</span>
    <span class="k">begin</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">pre</span> <span class="o">[</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;Name:          &quot;</span><span class="o">;</span>
                     <span class="n">textfield</span>
                       <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;Name&quot;</span>
                       <span class="o">~</span><span class="k">value</span><span class="o">:(</span><span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;Name&quot;</span><span class="o">)</span> <span class="bp">()</span><span class="o">];</span>
                  <span class="n">p</span> <span class="o">[</span><span class="s2">&quot;Address:       &quot;</span><span class="o">;</span>
                     <span class="n">textfield</span>
                       <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;Address1&quot;</span>
                       <span class="o">~</span><span class="k">value</span><span class="o">:(</span><span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;Address1&quot;</span><span class="o">)</span> <span class="bp">()</span><span class="o">];</span>
                  <span class="n">p</span> <span class="o">[</span><span class="s2">&quot;               &quot;</span><span class="o">;</span>
                     <span class="n">textfield</span>
                       <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;Address2&quot;</span>
                       <span class="o">~</span><span class="k">value</span><span class="o">:(</span><span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;Address2&quot;</span><span class="o">)</span> <span class="bp">()</span><span class="o">];</span>
                  <span class="n">p</span> <span class="o">[</span><span class="s2">&quot;City:          &quot;</span><span class="o">;</span>
                     <span class="n">textfield</span>
                       <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;City&quot;</span>
                       <span class="o">~</span><span class="k">value</span><span class="o">:(</span><span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;City&quot;</span><span class="o">)</span> <span class="bp">()</span><span class="o">];</span>
                  <span class="n">p</span> <span class="o">[</span><span class="s2">&quot;Zip:           &quot;</span><span class="o">;</span>
                     <span class="n">textfield</span>
                       <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;Zip&quot;</span>
                       <span class="o">~</span><span class="k">value</span><span class="o">:(</span><span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;Zip&quot;</span><span class="o">)</span> <span class="bp">()</span><span class="o">];</span>
                  <span class="n">p</span> <span class="o">[</span><span class="s2">&quot;State:         &quot;</span><span class="o">;</span>
                     <span class="n">textfield</span>
                       <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;State&quot;</span>
                       <span class="o">~</span><span class="k">value</span><span class="o">:(</span><span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;State&quot;</span><span class="o">)</span> <span class="bp">()</span><span class="o">];</span>
                  <span class="n">p</span> <span class="o">[</span><span class="s2">&quot;Phone:         &quot;</span><span class="o">;</span>
                     <span class="n">textfield</span>
                       <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;Phone&quot;</span>
                       <span class="o">~</span><span class="k">value</span><span class="o">:(</span><span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;Phone&quot;</span><span class="o">)</span> <span class="bp">()</span><span class="o">];</span>
                  <span class="n">p</span> <span class="o">[</span><span class="s2">&quot;Credit Card *: &quot;</span><span class="o">;</span>
                     <span class="n">textfield</span>
                       <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;Card&quot;</span>
                       <span class="o">~</span><span class="k">value</span><span class="o">:(</span><span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;Card&quot;</span><span class="o">)</span> <span class="bp">()</span><span class="o">];</span>
                  <span class="n">p</span> <span class="o">[</span><span class="s2">&quot;Expiry:        &quot;</span><span class="o">;</span>
                     <span class="n">textfield</span>
                       <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="s2">&quot;Expiry&quot;</span>
                       <span class="o">~</span><span class="k">value</span><span class="o">:(</span><span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;Expiry&quot;</span><span class="o">)</span> <span class="bp">()</span><span class="o">]]);</span>

      <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;Click on &#39;Order&#39; to order the items. &quot;</span><span class="o">;</span>
                <span class="s2">&quot;Click on &#39;Cancel&#39; to return shopping.&quot;</span><span class="o">]);</span>

      <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="n">to_page</span> <span class="s2">&quot;Order&quot;</span><span class="o">;</span> <span class="n">to_page</span> <span class="s2">&quot;Cancel&quot;</span><span class="o">]);</span>
    <span class="k">end</span>
  <span class="k">else</span>
    <span class="k">begin</span>
      <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
        <span class="o">(</span><span class="k">fun</span> <span class="n">widget</span> <span class="o">-&gt;</span>
           <span class="n">print</span> <span class="o">(</span><span class="n">hidden</span>
                    <span class="o">~</span><span class="n">name</span><span class="o">:</span><span class="n">widget</span>
                    <span class="o">~</span><span class="k">value</span><span class="o">:(</span><span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="n">widget</span><span class="o">)</span> <span class="bp">()</span><span class="o">))</span>
        <span class="n">widgets</span>
    <span class="k">end</span>

<span class="c">(* Page to complete an order. *)</span>
<span class="k">let</span> <span class="n">order</span> <span class="n">cgi</span> <span class="n">print</span> <span class="n">active</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">active</span> <span class="k">then</span>
    <span class="k">begin</span>
      <span class="c">(* you&#39;d check credit card values here *)</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">h1</span> <span class="o">[</span><span class="s2">&quot;Ordered!&quot;</span><span class="o">]);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="s2">&quot;You have ordered the following toppings:&quot;</span><span class="o">]);</span>
      <span class="n">print</span> <span class="o">(</span><span class="n">order_text</span> <span class="n">cgi</span><span class="o">);</span>

      <span class="n">print</span> <span class="o">(</span><span class="n">p</span> <span class="o">[</span><span class="n">defaults</span> <span class="s2">&quot;Begin Again&quot;</span><span class="o">]);</span>
    <span class="k">end</span>

<span class="c">(* state table mapping pages to functions *)</span>
<span class="k">type</span> <span class="n">page</span> <span class="o">=</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="kt">string</span> <span class="o">-&gt;</span> <span class="kt">unit</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="kt">bool</span> <span class="o">-&gt;</span> <span class="kt">unit</span>
<span class="k">let</span> <span class="o">(</span><span class="n">states</span> <span class="o">:</span> <span class="o">(</span><span class="kt">string</span> <span class="o">*</span> <span class="n">page</span><span class="o">)</span> <span class="kt">list</span><span class="o">)</span> <span class="o">=</span>
  <span class="o">[</span>
    <span class="s2">&quot;Default&quot;</span>  <span class="o">=&gt;</span> <span class="n">front_page</span><span class="o">;</span>
    <span class="s2">&quot;Shirt&quot;</span>    <span class="o">=&gt;</span> <span class="n">shirt</span><span class="o">;</span>
    <span class="s2">&quot;Sweater&quot;</span>  <span class="o">=&gt;</span> <span class="n">sweater</span><span class="o">;</span>
    <span class="s2">&quot;Checkout&quot;</span> <span class="o">=&gt;</span> <span class="n">checkout</span><span class="o">;</span>
    <span class="s2">&quot;Card&quot;</span>     <span class="o">=&gt;</span> <span class="n">credit_card</span><span class="o">;</span>
    <span class="s2">&quot;Order&quot;</span>    <span class="o">=&gt;</span> <span class="n">order</span><span class="o">;</span>
    <span class="s2">&quot;Cancel&quot;</span>   <span class="o">=&gt;</span> <span class="n">front_page</span><span class="o">;</span>
  <span class="o">]</span>

<span class="k">let</span> <span class="n">no_such_page</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="n">print</span> <span class="n">current_screen</span> <span class="o">=</span>
  <span class="n">print</span> <span class="o">(</span><span class="s2">&quot;No screen for &quot;</span> <span class="o">^</span> <span class="n">current_screen</span><span class="o">)</span>

<span class="k">let</span> <span class="n">process</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">current_screen</span> <span class="o">=</span> <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="o">~</span><span class="n">default</span><span class="o">:</span><span class="s2">&quot;Default&quot;</span> <span class="s2">&quot;.State&quot;</span> <span class="k">in</span>

  <span class="k">let</span> <span class="n">print</span> <span class="n">s</span> <span class="o">=</span>
    <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">output_string</span> <span class="n">s</span><span class="o">;</span>
    <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">output_string</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">in</span>

  <span class="c">(* Generate the current page. *)</span>
  <span class="n">cgi</span><span class="o">#</span><span class="n">set_header</span> <span class="o">~</span><span class="n">content_type</span><span class="o">:</span><span class="s2">&quot;text/html&quot;</span> <span class="bp">()</span><span class="o">;</span>
  <span class="n">standard_header</span> <span class="n">print</span><span class="o">;</span>
  <span class="k">if</span> <span class="nn">List</span><span class="p">.</span><span class="n">mem_assoc</span> <span class="n">current_screen</span> <span class="n">states</span>
  <span class="k">then</span> <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">state</span><span class="o">,</span> <span class="n">sub</span><span class="o">)</span> <span class="o">-&gt;</span>
                    <span class="n">sub</span> <span class="n">cgi</span> <span class="n">print</span> <span class="o">(</span><span class="n">current_screen</span> <span class="o">=</span> <span class="n">state</span><span class="o">))</span> <span class="n">states</span>
  <span class="k">else</span> <span class="n">no_such_page</span> <span class="n">cgi</span> <span class="n">print</span> <span class="n">current_screen</span><span class="o">;</span>
  <span class="n">standard_footer</span> <span class="n">print</span><span class="o">;</span>
  <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">commit_work</span> <span class="bp">()</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">config</span> <span class="o">=</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">default_config</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">buffered</span> <span class="o">_</span> <span class="n">ch</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">buffered_trans_channel</span> <span class="n">ch</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">output_type</span> <span class="o">=</span> <span class="o">`</span><span class="nc">Transactional</span> <span class="n">buffered</span> <span class="k">in</span>
  <span class="k">if</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">isatty</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">stdin</span>
  <span class="k">then</span> <span class="nn">Netcgi_test</span><span class="p">.</span><span class="n">run</span> <span class="o">~</span><span class="n">config</span> <span class="o">~</span><span class="n">output_type</span> <span class="n">process</span>
  <span class="k">else</span> <span class="nn">Netcgi_cgi</span><span class="p">.</span><span class="n">run</span> <span class="o">~</span><span class="n">config</span> <span class="o">~</span><span class="n">output_type</span> <span class="n">process</span>


<span class="c">(* @@PLEAC@@_20.0 *)</span>
<span class="c">(* Libraries for HTTP clients and servers are listed at The Caml Hump: *)</span>
<span class="n">http</span><span class="o">://</span><span class="n">caml</span><span class="o">.</span><span class="n">inria</span><span class="o">.</span><span class="n">fr</span><span class="o">/</span><span class="n">cgi</span><span class="o">-</span><span class="n">bin</span><span class="o">/</span><span class="n">hump</span><span class="o">.</span><span class="n">en</span><span class="o">.</span><span class="n">cgi</span><span class="o">?</span><span class="n">browse</span><span class="o">=</span><span class="mi">40</span>

<span class="c">(* @@PLEAC@@_20.1 *)</span>
<span class="c">(* If you just want to read a URL as a string, Ocamlnet&#39;s &quot;Convenience&quot;</span>
<span class="c">   interface to Http_client is as easy as it gets. For the more powerful</span>
<span class="c">   general interface to Http_client, see the next example. *)</span>
<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netclient&quot;</span><span class="o">;;</span>
<span class="k">open</span> <span class="nn">Http_client</span><span class="p">.</span><span class="nc">Convenience</span>
<span class="k">let</span> <span class="n">content</span> <span class="o">=</span> <span class="n">http_get</span> <span class="n">url</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* titlebytes - find the title and size of documents  *)</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;str&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netclient&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">raw_url</span> <span class="o">=</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span>
<span class="k">let</span> <span class="n">url</span> <span class="o">=</span> <span class="nn">Neturl</span><span class="p">.</span><span class="n">parse_url</span> <span class="n">raw_url</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s =&gt;</span><span class="se">\n\t</span><span class="s2">%!&quot;</span> <span class="o">(</span><span class="nn">Neturl</span><span class="p">.</span><span class="n">string_of_url</span> <span class="n">url</span><span class="o">);</span>
  <span class="k">let</span> <span class="n">call</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Http_client</span><span class="p">.</span><span class="n">get</span> <span class="o">(</span><span class="nn">Neturl</span><span class="p">.</span><span class="n">string_of_url</span> <span class="n">url</span><span class="o">)</span> <span class="k">in</span>
  <span class="n">call</span><span class="o">#</span><span class="n">set_req_header</span> <span class="s2">&quot;User-Agent&quot;</span> <span class="s2">&quot;Schmozilla/v9.14 Platinum&quot;</span><span class="o">;</span>
  <span class="n">call</span><span class="o">#</span><span class="n">set_req_header</span> <span class="s2">&quot;Referer&quot;</span> <span class="s2">&quot;http://wizard.yellowbrick.oz&quot;</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Http_client</span><span class="p">.</span><span class="n">pipeline</span> <span class="k">in</span>
  <span class="n">pipeline</span><span class="o">#</span><span class="n">add</span> <span class="n">call</span><span class="o">;</span>
  <span class="n">pipeline</span><span class="o">#</span><span class="n">run</span> <span class="bp">()</span><span class="o">;</span>
  <span class="k">match</span> <span class="n">call</span><span class="o">#</span><span class="n">status</span> <span class="k">with</span>
    <span class="o">|</span> <span class="o">`</span><span class="nc">Successful</span> <span class="o">-&gt;</span>
        <span class="k">let</span> <span class="n">content</span> <span class="o">=</span> <span class="n">call</span><span class="o">#</span><span class="n">get_resp_body</span> <span class="bp">()</span> <span class="k">in</span>
        <span class="k">let</span> <span class="n">bytes</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">content</span> <span class="k">in</span>
        <span class="k">let</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
        <span class="nn">String</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">function</span> <span class="sc">&#39;\n&#39;</span> <span class="o">-&gt;</span> <span class="n">incr</span> <span class="n">count</span> <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">)</span> <span class="n">content</span><span class="o">;</span>
        <span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span>
          <span class="nn">Str</span><span class="p">.</span><span class="n">regexp_case_fold</span> <span class="s2">&quot;.*&lt;title&gt;</span><span class="se">\\</span><span class="s2">([^&lt;]*</span><span class="se">\\</span><span class="s2">)&lt;/title&gt;.*&quot;</span> <span class="k">in</span>
        <span class="k">let</span> <span class="n">title</span> <span class="o">=</span>
          <span class="k">try</span> <span class="o">(</span><span class="n">ignore</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">search_forward</span> <span class="n">regexp</span> <span class="n">content</span> <span class="mi">0</span><span class="o">);</span>
               <span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">1</span> <span class="n">content</span><span class="o">)</span>
          <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="s2">&quot;(untitled)&quot;</span> <span class="k">in</span>
        <span class="k">let</span> <span class="n">title</span> <span class="o">=</span>
          <span class="nn">Str</span><span class="p">.</span><span class="n">global_replace</span>
            <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">(^[</span><span class="se">\n\r\t</span><span class="s2"> ]+</span><span class="se">\\</span><span class="s2">)</span><span class="se">\\</span><span class="s2">|</span><span class="se">\\</span><span class="s2">([</span><span class="se">\n\r\t</span><span class="s2"> ]+$</span><span class="se">\\</span><span class="s2">)&quot;</span><span class="o">)</span> <span class="s2">&quot;&quot;</span>
            <span class="n">title</span> <span class="k">in</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s (%d lines, %d bytes)</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">title</span> <span class="o">!</span><span class="n">count</span> <span class="n">bytes</span>
    <span class="o">|</span> <span class="o">`</span><span class="nc">Client_error</span> <span class="o">-&gt;</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Client error: %d %s</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="n">call</span><span class="o">#</span><span class="n">response_status_code</span>
          <span class="n">call</span><span class="o">#</span><span class="n">response_status_text</span>
    <span class="o">|</span> <span class="o">`</span><span class="nc">Http_protocol_error</span> <span class="n">e</span> <span class="o">-&gt;</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;HTTP protocol error: %s</span><span class="se">\n</span><span class="s2">&quot;</span>
          <span class="o">(</span><span class="nn">Printexc</span><span class="p">.</span><span class="n">to_string</span> <span class="n">e</span><span class="o">)</span>
    <span class="o">|</span> <span class="o">`</span><span class="nc">Redirection</span> <span class="o">-&gt;</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Redirection</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="o">|</span> <span class="o">`</span><span class="nc">Server_error</span> <span class="o">-&gt;</span>
        <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Server error</span><span class="se">\n</span><span class="s2">&quot;</span>
    <span class="o">|</span> <span class="o">`</span><span class="nc">Unserved</span> <span class="o">-&gt;</span>
        <span class="k">assert</span> <span class="bp">false</span>

<span class="c">(* @@PLEAC@@_20.2 *)</span>
<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netclient&quot;</span><span class="o">;;</span>
<span class="k">open</span> <span class="nn">Http_client</span><span class="p">.</span><span class="nc">Convenience</span>

<span class="c">(* Submit a form using GET. *)</span>
<span class="k">let</span> <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://www.perl.com/cgi-bin/cpan_mod?module=DB_File&amp;readme=1&quot;</span>
<span class="k">let</span> <span class="n">content</span> <span class="o">=</span> <span class="n">http_get</span> <span class="n">url</span>

<span class="c">(* Submit a form using POST. Since we need to follow a redirect here,</span>
<span class="c">   we can&#39;t use the &quot;Convenience&quot; methods. *)</span>
<span class="k">let</span> <span class="n">url</span> <span class="o">=</span> <span class="s2">&quot;http://www.perl.com/cgi-bin/cpan_mod&quot;</span>
<span class="k">let</span> <span class="n">params</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;module&quot;</span><span class="o">,</span> <span class="s2">&quot;DB_File&quot;</span><span class="o">;</span> <span class="s2">&quot;readme&quot;</span><span class="o">,</span> <span class="s2">&quot;1&quot;</span><span class="o">]</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">call</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Http_client</span><span class="p">.</span><span class="n">post</span> <span class="n">url</span> <span class="n">params</span> <span class="k">in</span>
  <span class="n">call</span><span class="o">#</span><span class="n">set_redirect_mode</span> <span class="nn">Http_client</span><span class="p">.</span><span class="nc">Redirect</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Http_client</span><span class="p">.</span><span class="n">pipeline</span> <span class="k">in</span>
  <span class="n">pipeline</span><span class="o">#</span><span class="n">add</span> <span class="n">call</span><span class="o">;</span>
  <span class="n">pipeline</span><span class="o">#</span><span class="n">run</span> <span class="bp">()</span>
<span class="k">let</span> <span class="n">content</span> <span class="o">=</span> <span class="n">call</span><span class="o">#</span><span class="n">response_body</span><span class="o">#</span><span class="k">value</span>

<span class="c">(* GET parameters can be URL encoded with Netencoding.Url.encode. *)</span>
<span class="k">let</span> <span class="n">arg</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\&quot;</span><span class="s2">this isn&#39;t &lt;EASY&gt; &amp; &lt;FUN&gt;</span><span class="se">\&quot;</span><span class="s2">&quot;</span>
<span class="nn">Netencoding</span><span class="p">.</span><span class="nn">Url</span><span class="p">.</span><span class="n">encode</span> <span class="n">arg</span>
<span class="c">(* - : string = &quot;%22this+isn%27t+%3CEASY%3E+%26+%3CFUN%3E%22&quot; *)</span>
<span class="nn">Netencoding</span><span class="p">.</span><span class="nn">Url</span><span class="p">.</span><span class="n">encode</span> <span class="o">~</span><span class="n">plus</span><span class="o">:</span><span class="bp">false</span> <span class="n">arg</span>
<span class="c">(* - : string = &quot;%22this%20isn%27t%20%3CEASY%3E%20%26%20%3CFUN%3E%22&quot; *)</span>

<span class="c">(* To use a proxy, either set the &quot;http_proxy&quot; environment variable and</span>
<span class="c">   call &quot;set_proxy_from_environment&quot; on the pipeline (done automatically</span>
<span class="c">   for the &quot;Convenience&quot; methods) or set the proxy host and port using</span>
<span class="c">   the &quot;set_proxy&quot; method: *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">#</span><span class="n">set_proxy</span> <span class="s2">&quot;localhost&quot;</span> <span class="mi">3128</span>

<span class="c">(* @@PLEAC@@_20.3 *)</span>
<span class="c">(* The Nethtml library, part of Ocamlnet, can parse arbitrary HTML from</span>
<span class="c">   files and web pages. *)</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netstring&quot;</span><span class="o">;;</span>

<span class="k">open</span> <span class="nc">Nethtml</span>

<span class="c">(* Define a function to walk through all the elements in a document and</span>
<span class="c">   accumulate the results of a user-supplied function for each element.</span>
<span class="c">   This is known as a &quot;fold&quot; in functional programming. *)</span>
<span class="k">let</span> <span class="k">rec</span> <span class="n">fold_elements</span> <span class="n">f</span> <span class="n">accu</span> <span class="o">=</span> <span class="k">function</span>
  <span class="o">|</span> <span class="nc">Element</span> <span class="o">(_,</span> <span class="o">_,</span> <span class="n">children</span><span class="o">)</span> <span class="k">as</span> <span class="n">element</span> <span class="o">-&gt;</span>
      <span class="k">let</span> <span class="n">accu</span> <span class="o">=</span>
        <span class="nn">List</span><span class="p">.</span><span class="n">fold_right</span>
          <span class="o">(</span><span class="k">fun</span> <span class="n">child</span> <span class="n">accu</span> <span class="o">-&gt;</span>
             <span class="n">fold_elements</span> <span class="n">f</span> <span class="n">accu</span> <span class="n">child</span><span class="o">)</span>
          <span class="n">children</span>
          <span class="n">accu</span> <span class="k">in</span>
      <span class="n">f</span> <span class="n">accu</span> <span class="n">element</span>
  <span class="o">|</span> <span class="n">other</span> <span class="o">-&gt;</span> <span class="n">accu</span>

<span class="c">(* Define a type for links so we can tell anchors and images apart. *)</span>
<span class="k">type</span> <span class="n">link</span> <span class="o">=</span> <span class="nc">A</span> <span class="k">of</span> <span class="kt">string</span> <span class="o">|</span> <span class="nc">IMG</span> <span class="k">of</span> <span class="kt">string</span>

<span class="c">(* Using fold_elements, define a function that collects the URLs from</span>
<span class="c">   all the &quot;a&quot; and &quot;img&quot; tags. *)</span>
<span class="k">let</span> <span class="n">find_links</span> <span class="n">elements</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">flatten</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span>
       <span class="o">(</span><span class="n">fold_elements</span>
          <span class="o">(</span><span class="k">fun</span> <span class="n">accu</span> <span class="n">element</span> <span class="o">-&gt;</span>
             <span class="k">match</span> <span class="n">element</span> <span class="k">with</span>
               <span class="o">|</span> <span class="nc">Element</span> <span class="o">(</span><span class="s2">&quot;a&quot;</span><span class="o">,</span> <span class="n">attribs</span><span class="o">,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
                   <span class="o">(</span><span class="k">try</span> <span class="nc">A</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">assoc</span> <span class="s2">&quot;href&quot;</span> <span class="n">attribs</span><span class="o">)</span> <span class="o">::</span> <span class="n">accu</span>
                    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="n">accu</span><span class="o">)</span>
               <span class="o">|</span> <span class="nc">Element</span> <span class="o">(</span><span class="s2">&quot;img&quot;</span><span class="o">,</span> <span class="n">attribs</span><span class="o">,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
                   <span class="o">(</span><span class="k">try</span> <span class="nc">IMG</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">assoc</span> <span class="s2">&quot;src&quot;</span> <span class="n">attribs</span><span class="o">)</span> <span class="o">::</span> <span class="n">accu</span>
                    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="n">accu</span><span class="o">)</span>
               <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">accu</span><span class="o">)</span>
          <span class="bp">[]</span><span class="o">)</span>
       <span class="n">elements</span><span class="o">)</span>

<span class="c">(* Parse an HTML file. *)</span>
<span class="k">let</span> <span class="n">elements</span> <span class="o">=</span> <span class="n">parse</span> <span class="o">(</span><span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">input_channel</span> <span class="o">(</span><span class="n">open_in</span> <span class="n">filename</span><span class="o">))</span>

<span class="c">(* Print the links we found. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">function</span>
       <span class="o">|</span> <span class="nc">A</span> <span class="n">href</span> <span class="o">-&gt;</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;ANCHOR: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">href</span>
       <span class="o">|</span> <span class="nc">IMG</span> <span class="n">src</span> <span class="o">-&gt;</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;IMAGE: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">src</span><span class="o">)</span>
    <span class="o">(</span><span class="n">find_links</span> <span class="n">elements</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* xurl - extract unique, sorted list of links from URL *)</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netclient&quot;</span><span class="o">;;</span>

<span class="k">open</span> <span class="nn">Http_client</span><span class="p">.</span><span class="nc">Convenience</span>
<span class="k">open</span> <span class="nc">Nethtml</span>

<span class="k">let</span> <span class="k">rec</span> <span class="n">fold_elements</span> <span class="n">f</span> <span class="n">accu</span> <span class="o">=</span> <span class="k">function</span>
  <span class="o">|</span> <span class="nc">Element</span> <span class="o">(_,</span> <span class="o">_,</span> <span class="n">children</span><span class="o">)</span> <span class="k">as</span> <span class="n">element</span> <span class="o">-&gt;</span>
      <span class="k">let</span> <span class="n">accu</span> <span class="o">=</span>
        <span class="nn">List</span><span class="p">.</span><span class="n">fold_right</span>
          <span class="o">(</span><span class="k">fun</span> <span class="n">child</span> <span class="n">accu</span> <span class="o">-&gt;</span>
             <span class="n">fold_elements</span> <span class="n">f</span> <span class="n">accu</span> <span class="n">child</span><span class="o">)</span>
          <span class="n">children</span>
          <span class="n">accu</span> <span class="k">in</span>
      <span class="n">f</span> <span class="n">accu</span> <span class="n">element</span>
  <span class="o">|</span> <span class="n">other</span> <span class="o">-&gt;</span> <span class="n">accu</span>

<span class="k">type</span> <span class="n">link</span> <span class="o">=</span> <span class="nc">A</span> <span class="k">of</span> <span class="kt">string</span> <span class="o">|</span> <span class="nc">IMG</span> <span class="k">of</span> <span class="kt">string</span>

<span class="k">let</span> <span class="n">find_links</span> <span class="n">elements</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">flatten</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span>
       <span class="o">(</span><span class="n">fold_elements</span>
          <span class="o">(</span><span class="k">fun</span> <span class="n">accu</span> <span class="n">element</span> <span class="o">-&gt;</span>
             <span class="k">match</span> <span class="n">element</span> <span class="k">with</span>
               <span class="o">|</span> <span class="nc">Element</span> <span class="o">(</span><span class="s2">&quot;a&quot;</span><span class="o">,</span> <span class="n">attribs</span><span class="o">,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
                   <span class="o">(</span><span class="k">try</span> <span class="nc">A</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">assoc</span> <span class="s2">&quot;href&quot;</span> <span class="n">attribs</span><span class="o">)</span> <span class="o">::</span> <span class="n">accu</span>
                    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="n">accu</span><span class="o">)</span>
               <span class="o">|</span> <span class="nc">Element</span> <span class="o">(</span><span class="s2">&quot;img&quot;</span><span class="o">,</span> <span class="n">attribs</span><span class="o">,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
                   <span class="o">(</span><span class="k">try</span> <span class="nc">IMG</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">assoc</span> <span class="s2">&quot;src&quot;</span> <span class="n">attribs</span><span class="o">)</span> <span class="o">::</span> <span class="n">accu</span>
                    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="n">accu</span><span class="o">)</span>
               <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">accu</span><span class="o">)</span>
          <span class="bp">[]</span><span class="o">)</span>
       <span class="n">elements</span><span class="o">)</span>

<span class="k">let</span> <span class="n">base_url</span> <span class="o">=</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span>
<span class="k">let</span> <span class="n">elements</span> <span class="o">=</span> <span class="n">parse</span> <span class="o">(</span><span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">input_string</span> <span class="o">(</span><span class="n">http_get</span> <span class="n">base_url</span><span class="o">))</span>
<span class="k">let</span> <span class="n">url_syntax</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="nn">Neturl</span><span class="p">.</span><span class="n">common_url_syntax</span> <span class="s2">&quot;http&quot;</span>
<span class="k">let</span> <span class="n">url_syntax</span> <span class="o">=</span>
  <span class="o">{</span><span class="n">url_syntax</span> <span class="k">with</span>
     <span class="nn">Neturl</span><span class="p">.</span><span class="n">url_enable_fragment</span> <span class="o">=</span> <span class="nn">Neturl</span><span class="p">.</span><span class="nc">Url_part_allowed</span><span class="o">}</span>
<span class="k">let</span> <span class="n">url_syntax</span> <span class="o">=</span> <span class="nn">Neturl</span><span class="p">.</span><span class="n">partial_url_syntax</span> <span class="n">url_syntax</span>

<span class="k">module</span> <span class="nc">StringSet</span> <span class="o">=</span> <span class="nn">Set</span><span class="p">.</span><span class="nc">Make</span><span class="o">(</span><span class="nc">String</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">StringSet</span><span class="p">.</span><span class="n">iter</span> <span class="n">print_endline</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">fold_left</span>
       <span class="o">(</span><span class="k">fun</span> <span class="n">accu</span> <span class="n">s</span> <span class="o">-&gt;</span>
          <span class="k">try</span>
            <span class="nn">StringSet</span><span class="p">.</span><span class="n">add</span>
              <span class="o">(</span><span class="nn">Neturl</span><span class="p">.</span><span class="n">string_of_url</span>
                 <span class="o">(</span><span class="nn">Neturl</span><span class="p">.</span><span class="n">apply_relative_url</span>
                    <span class="o">(</span><span class="nn">Neturl</span><span class="p">.</span><span class="n">url_of_string</span> <span class="n">url_syntax</span> <span class="n">base_url</span><span class="o">)</span>
                    <span class="o">(</span><span class="nn">Neturl</span><span class="p">.</span><span class="n">url_of_string</span> <span class="n">url_syntax</span> <span class="n">s</span><span class="o">)))</span>
              <span class="n">accu</span>
          <span class="k">with</span> <span class="nn">Neturl</span><span class="p">.</span><span class="nc">Malformed_URL</span> <span class="o">-&gt;</span>
            <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Malformed URL: %s</span><span class="se">\n</span><span class="s2">%!&quot;</span> <span class="n">s</span><span class="o">;</span>
            <span class="n">accu</span><span class="o">)</span>
       <span class="nn">StringSet</span><span class="p">.</span><span class="n">empty</span>
       <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span>
          <span class="o">(</span><span class="k">function</span>
             <span class="o">|</span> <span class="nc">A</span> <span class="n">href</span> <span class="o">-&gt;</span> <span class="n">href</span>
             <span class="o">|</span> <span class="nc">IMG</span> <span class="n">src</span> <span class="o">-&gt;</span> <span class="n">src</span><span class="o">)</span>
          <span class="o">(</span><span class="n">find_links</span> <span class="n">elements</span><span class="o">)))</span>

<span class="c">(* @@PLEAC@@_20.4 *)</span>
<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* text2html - trivial html encoding of normal text *)</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;str&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netstring&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">line_stream_of_channel</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">channel</span><span class="o">)</span> <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="nc">None</span><span class="o">)</span>

<span class="k">let</span> <span class="n">paragraph_stream_of_channel</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="n">line_stream_of_channel</span> <span class="n">channel</span> <span class="k">in</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">next</span> <span class="n">para_lines</span> <span class="n">i</span> <span class="o">=</span>
    <span class="k">match</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">peek</span> <span class="n">lines</span><span class="o">,</span> <span class="n">para_lines</span> <span class="k">with</span>
      <span class="o">|</span> <span class="nc">None</span><span class="o">,</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="nc">None</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="s2">&quot;&quot;</span><span class="o">,</span> <span class="bp">[]</span> <span class="o">-&gt;</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">lines</span><span class="o">;</span> <span class="n">next</span> <span class="n">para_lines</span> <span class="n">i</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="s2">&quot;&quot;</span><span class="o">,</span> <span class="o">_</span>
      <span class="o">|</span> <span class="nc">None</span><span class="o">,</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nc">Some</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="n">para_lines</span><span class="o">))</span>
      <span class="o">|</span> <span class="nc">Some</span> <span class="n">line</span><span class="o">,</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">lines</span><span class="o">;</span> <span class="n">next</span> <span class="o">(</span><span class="n">line</span> <span class="o">::</span> <span class="n">para_lines</span><span class="o">)</span> <span class="n">i</span> <span class="k">in</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span> <span class="o">(</span><span class="n">next</span> <span class="bp">[]</span><span class="o">)</span>

<span class="k">let</span> <span class="n">chop</span> <span class="n">s</span> <span class="o">=</span>
  <span class="k">if</span> <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">then</span> <span class="n">s</span> <span class="k">else</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">s</span> <span class="mi">0</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span> <span class="o">-</span> <span class="mi">1</span><span class="o">);;</span>

<span class="k">let</span> <span class="n">substitutions</span> <span class="o">=</span>
  <span class="o">[</span>
    <span class="c">(* embedded URL (good) or guessed URL (bad) *)</span>
    <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">(&lt;URL:[^&gt;]+&gt;</span><span class="se">\\</span><span class="s2">)</span><span class="se">\\</span><span class="s2">|</span><span class="se">\\</span><span class="s2">(http:[^ </span><span class="se">\n\r\t</span><span class="s2">]+</span><span class="se">\\</span><span class="s2">)&quot;</span><span class="o">,</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">s</span> <span class="o">-&gt;</span>
       <span class="k">let</span> <span class="n">s</span> <span class="o">=</span>
         <span class="k">if</span> <span class="n">s</span><span class="o">.[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="sc">&#39;&lt;&#39;</span>
         <span class="k">then</span> <span class="nn">String</span><span class="p">.</span><span class="n">sub</span> <span class="n">s</span> <span class="mi">5</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span> <span class="o">-</span> <span class="mi">6</span><span class="o">)</span>
         <span class="k">else</span> <span class="n">s</span> <span class="k">in</span>
       <span class="o">[</span><span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span> <span class="o">(</span><span class="s2">&quot;a&quot;</span><span class="o">,</span> <span class="o">[</span><span class="s2">&quot;href&quot;</span><span class="o">,</span> <span class="n">s</span><span class="o">],</span> <span class="o">[</span><span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="n">s</span><span class="o">])]);</span>

    <span class="c">(* this is *bold* here *)</span>
    <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;</span><span class="se">\\</span><span class="s2">*[^*]+</span><span class="se">\\</span><span class="s2">*&quot;</span><span class="o">,</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="o">[</span><span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span> <span class="o">(</span><span class="s2">&quot;strong&quot;</span><span class="o">,</span> <span class="bp">[]</span><span class="o">,</span> <span class="o">[</span><span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="n">s</span><span class="o">])]);</span>

    <span class="c">(* this is _italics_ here *)</span>
    <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;_[^ _]+_&quot;</span><span class="o">,</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="o">[</span><span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span> <span class="o">(</span><span class="s2">&quot;em&quot;</span><span class="o">,</span> <span class="bp">[]</span><span class="o">,</span> <span class="o">[</span><span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="n">s</span><span class="o">])]);</span>
  <span class="o">]</span>

<span class="k">let</span> <span class="n">substitute</span> <span class="n">regexp</span> <span class="n">func</span> <span class="n">data</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">flatten</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span>
       <span class="o">(</span><span class="k">function</span>
          <span class="o">|</span> <span class="nn">Str</span><span class="p">.</span><span class="nc">Text</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="o">[</span><span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="n">s</span><span class="o">]</span>
          <span class="o">|</span> <span class="nn">Str</span><span class="p">.</span><span class="nc">Delim</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">func</span> <span class="n">s</span><span class="o">)</span>
       <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">full_split</span> <span class="n">regexp</span> <span class="n">data</span><span class="o">))</span>

<span class="k">let</span> <span class="k">rec</span> <span class="n">map_data</span> <span class="n">f</span> <span class="kt">list</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">flatten</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span>
       <span class="o">(</span><span class="k">function</span>
          <span class="o">|</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="n">data</span> <span class="o">-&gt;</span> <span class="n">f</span> <span class="n">data</span>
          <span class="o">|</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span> <span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">attrs</span><span class="o">,</span> <span class="n">children</span><span class="o">)</span> <span class="o">-&gt;</span>
              <span class="o">[</span><span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span> <span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">attrs</span><span class="o">,</span> <span class="n">map_data</span> <span class="n">f</span> <span class="n">children</span><span class="o">)])</span>
       <span class="kt">list</span><span class="o">)</span>

<span class="k">let</span> <span class="n">text2html</span> <span class="n">text</span> <span class="o">=</span>
  <span class="c">(* Create the initial HTML tree. *)</span>
  <span class="k">let</span> <span class="n">html</span> <span class="o">=</span> <span class="o">[</span><span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="n">text</span><span class="o">]</span> <span class="k">in</span>

  <span class="c">(* Split text into lines. *)</span>
  <span class="k">let</span> <span class="n">html</span> <span class="o">=</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">flatten</span>
      <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span>
         <span class="o">(</span><span class="k">function</span>
            <span class="o">|</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="n">data</span> <span class="o">-&gt;</span>
                <span class="nn">List</span><span class="p">.</span><span class="n">map</span>
                  <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="o">(</span><span class="n">line</span> <span class="o">^</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">))</span>
                  <span class="o">(</span><span class="s2">&quot;&quot;</span> <span class="o">::</span> <span class="nn">Str</span><span class="p">.</span><span class="n">split</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span> <span class="n">data</span><span class="o">)</span>
            <span class="o">|</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span> <span class="o">_</span> <span class="k">as</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="o">[</span><span class="n">e</span><span class="o">])</span>
         <span class="n">html</span><span class="o">)</span> <span class="k">in</span>

  <span class="c">(* Perform inline substitutions. *)</span>
  <span class="k">let</span> <span class="n">html</span> <span class="o">=</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">fold_right</span>
      <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">regexp</span><span class="o">,</span> <span class="n">func</span><span class="o">)</span> <span class="o">-&gt;</span>
         <span class="n">map_data</span> <span class="o">(</span><span class="n">substitute</span> <span class="n">regexp</span> <span class="n">func</span><span class="o">))</span>
      <span class="n">substitutions</span>
      <span class="n">html</span> <span class="k">in</span>

  <span class="c">(* Add line breaks to quoted text. *)</span>
  <span class="k">let</span> <span class="n">html</span> <span class="o">=</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">flatten</span>
      <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span>
         <span class="o">(</span><span class="k">function</span>
            <span class="o">|</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="n">line</span> <span class="k">when</span> <span class="n">line</span><span class="o">.[</span><span class="mi">0</span><span class="o">]</span> <span class="o">=</span> <span class="sc">&#39;&gt;&#39;</span> <span class="o">-&gt;</span>
                <span class="o">[</span><span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="o">(</span><span class="n">chop</span> <span class="n">line</span><span class="o">);</span>
                 <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span> <span class="o">(</span><span class="s2">&quot;br&quot;</span><span class="o">,</span> <span class="bp">[]</span><span class="o">,</span> <span class="bp">[]</span><span class="o">);</span>
                 <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">]</span>
            <span class="o">|</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="n">line</span> <span class="o">-&gt;</span> <span class="o">[</span><span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="n">line</span><span class="o">]</span>
            <span class="o">|</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span> <span class="o">_</span> <span class="k">as</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="o">[</span><span class="n">e</span><span class="o">])</span>
         <span class="n">html</span><span class="o">)</span> <span class="k">in</span>

  <span class="c">(* Return the finished document. *)</span>
  <span class="n">html</span>

<span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span>
<span class="k">let</span> <span class="n">channel</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">output_buffer</span> <span class="n">buffer</span>
<span class="k">let</span> <span class="n">write</span> <span class="n">html</span> <span class="o">=</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="n">write</span> <span class="n">channel</span> <span class="o">(</span><span class="nn">Nethtml</span><span class="p">.</span><span class="n">encode</span> <span class="n">html</span><span class="o">)</span>
<span class="k">let</span> <span class="n">paragraphs</span> <span class="o">=</span> <span class="n">paragraph_stream_of_channel</span> <span class="n">stdin</span>

<span class="c">(* Main loop *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">first</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">true</span> <span class="k">in</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">para</span> <span class="o">-&gt;</span>
       <span class="k">if</span> <span class="o">!</span><span class="n">first</span> <span class="k">then</span> <span class="n">first</span> <span class="o">:=</span> <span class="bp">false</span>
       <span class="k">else</span> <span class="n">write</span> <span class="o">[</span><span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">];</span>
       <span class="c">(* Paragraphs beginning with whitespace are wrapped in &lt;pre&gt; *)</span>
       <span class="k">let</span> <span class="n">tag</span><span class="o">,</span> <span class="n">body</span> <span class="o">=</span>
         <span class="k">if</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">para</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nn">String</span><span class="p">.</span><span class="n">contains</span> <span class="s2">&quot; </span><span class="se">\t</span><span class="s2">&quot;</span> <span class="n">para</span><span class="o">.[</span><span class="mi">0</span><span class="o">]</span>
         <span class="k">then</span> <span class="s2">&quot;pre&quot;</span><span class="o">,</span> <span class="o">[</span><span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">;</span>
                      <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="n">para</span><span class="o">;</span>  <span class="c">(* indented verbatim *)</span>
                      <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">]</span>
         <span class="k">else</span> <span class="s2">&quot;p&quot;</span><span class="o">,</span> <span class="n">text2html</span> <span class="n">para</span> <span class="k">in</span>      <span class="c">(* add paragraph tag *)</span>
       <span class="n">write</span> <span class="o">[</span><span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span> <span class="o">(</span><span class="n">tag</span><span class="o">,</span> <span class="bp">[]</span><span class="o">,</span> <span class="n">body</span><span class="o">)])</span>
    <span class="n">paragraphs</span><span class="o">;</span>
  <span class="n">print_endline</span> <span class="o">(</span><span class="nn">Buffer</span><span class="p">.</span><span class="n">contents</span> <span class="n">buffer</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* To format mail headers as a table, add the following just before</span>
<span class="c">   the main loop. *)</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">colon_delim</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[ </span><span class="se">\t</span><span class="s2">]*:[ </span><span class="se">\t</span><span class="s2">]*&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">continuation</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">[ </span><span class="se">\t</span><span class="s2">]+&quot;</span> <span class="k">in</span>
  <span class="k">try</span>
    <span class="k">let</span> <span class="n">headers</span> <span class="o">=</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">next</span> <span class="n">paragraphs</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">headers</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">global_replace</span> <span class="n">continuation</span> <span class="s2">&quot; &quot;</span> <span class="n">headers</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">lines</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">split</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span> <span class="n">headers</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">rows</span> <span class="o">=</span>
      <span class="nn">List</span><span class="p">.</span><span class="n">flatten</span>
        <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span>
           <span class="o">(</span><span class="k">fun</span> <span class="n">line</span> <span class="o">-&gt;</span>
              <span class="c">(* parse heading *)</span>
              <span class="k">let</span> <span class="n">key</span><span class="o">,</span> <span class="k">value</span> <span class="o">=</span>
                <span class="k">match</span> <span class="nn">Str</span><span class="p">.</span><span class="n">bounded_split_delim</span> <span class="n">colon_delim</span> <span class="n">line</span> <span class="mi">2</span> <span class="k">with</span>
                  <span class="o">|</span> <span class="o">[</span><span class="n">key</span><span class="o">;</span> <span class="k">value</span><span class="o">]</span> <span class="o">-&gt;</span> <span class="n">key</span><span class="o">,</span> <span class="k">value</span>
                  <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="s2">&quot;&quot;</span><span class="o">,</span> <span class="n">line</span> <span class="k">in</span>
              <span class="o">[</span><span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span>
                 <span class="o">(</span><span class="s2">&quot;tr&quot;</span><span class="o">,</span> <span class="bp">[]</span><span class="o">,</span>
                  <span class="o">[</span><span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span>
                     <span class="o">(</span><span class="s2">&quot;th&quot;</span><span class="o">,</span> <span class="o">[</span><span class="s2">&quot;align&quot;</span><span class="o">,</span> <span class="s2">&quot;left&quot;</span><span class="o">],</span> <span class="o">[</span><span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="n">key</span><span class="o">]);</span>
                   <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span>
                     <span class="o">(</span><span class="s2">&quot;td&quot;</span><span class="o">,</span> <span class="bp">[]</span><span class="o">,</span> <span class="o">[</span><span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="k">value</span><span class="o">])]);</span>
               <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">])</span>
           <span class="n">lines</span><span class="o">)</span> <span class="k">in</span>
    <span class="n">write</span> <span class="o">[</span><span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span> <span class="o">(</span><span class="s2">&quot;table&quot;</span><span class="o">,</span> <span class="bp">[]</span><span class="o">,</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="n">encode</span> <span class="n">rows</span><span class="o">);</span>
           <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span> <span class="o">(</span><span class="s2">&quot;hr&quot;</span><span class="o">,</span> <span class="bp">[]</span><span class="o">,</span> <span class="bp">[]</span><span class="o">);</span>
           <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="o">]</span>
  <span class="k">with</span> <span class="nn">Stream</span><span class="p">.</span><span class="nc">Failure</span> <span class="o">-&gt;</span> <span class="bp">()</span>

<span class="c">(* @@PLEAC@@_20.5 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;unix.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">slurp_channel</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">buffer_size</span> <span class="o">=</span> <span class="mi">4096</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">create</span> <span class="n">buffer_size</span> <span class="k">in</span>
  <span class="k">let</span> <span class="kt">string</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">create</span> <span class="n">buffer_size</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">chars_read</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">1</span> <span class="k">in</span>
  <span class="k">while</span> <span class="o">!</span><span class="n">chars_read</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="k">do</span>
    <span class="n">chars_read</span> <span class="o">:=</span> <span class="n">input</span> <span class="n">channel</span> <span class="kt">string</span> <span class="mi">0</span> <span class="n">buffer_size</span><span class="o">;</span>
    <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_substring</span> <span class="n">buffer</span> <span class="kt">string</span> <span class="mi">0</span> <span class="o">!</span><span class="n">chars_read</span>
  <span class="k">done</span><span class="o">;</span>
  <span class="nn">Buffer</span><span class="p">.</span><span class="n">contents</span> <span class="n">buffer</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">process</span> <span class="o">=</span> <span class="nn">Unix</span><span class="p">.</span><span class="n">open_process_in</span> <span class="o">(</span><span class="s2">&quot;lynx -dump &quot;</span> <span class="o">^</span> <span class="n">filename</span><span class="o">)</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">ascii</span> <span class="o">=</span> <span class="n">slurp_channel</span> <span class="n">process</span> <span class="k">in</span>
  <span class="n">ignore</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">close_process_in</span> <span class="n">process</span><span class="o">);</span>
  <span class="c">(* ... *)</span>

<span class="c">(* @@PLEAC@@_20.6 *)</span>
<span class="c">(* Nethtml can be used to safely isolate and extract the text elements</span>
<span class="c">   from an HTML document. *)</span>
<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netstring&quot;</span><span class="o">;;</span>

<span class="c">(* Load the HTML document. *)</span>
<span class="k">let</span> <span class="n">channel</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">input_channel</span> <span class="o">(</span><span class="n">open_in</span> <span class="n">filename</span><span class="o">)</span>
<span class="k">let</span> <span class="n">html</span> <span class="o">=</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="n">parse</span> <span class="n">channel</span>
<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span> <span class="n">channel</span><span class="o">#</span><span class="n">close_in</span> <span class="bp">()</span>

<span class="c">(* Convert the document to plain text. *)</span>
<span class="k">let</span> <span class="n">plain_text</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">text</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span> <span class="n">html</span> <span class="o">=</span>
    <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
      <span class="o">(</span><span class="k">function</span>
         <span class="o">|</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">text</span> <span class="o">:=</span> <span class="n">s</span> <span class="o">::</span> <span class="o">!</span><span class="n">text</span>
         <span class="o">|</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span> <span class="o">(_,</span> <span class="o">_,</span> <span class="n">children</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="n">loop</span> <span class="n">children</span><span class="o">)</span>
      <span class="n">html</span> <span class="k">in</span>
  <span class="n">loop</span> <span class="o">(</span><span class="nn">Nethtml</span><span class="p">.</span><span class="n">decode</span> <span class="n">html</span><span class="o">);</span>
  <span class="nn">String</span><span class="p">.</span><span class="n">concat</span> <span class="s2">&quot;&quot;</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="o">!</span><span class="n">text</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* htitle - get html title from URL *)</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;str&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netclient&quot;</span><span class="o">;;</span>

<span class="k">open</span> <span class="nn">Http_client</span><span class="p">.</span><span class="nc">Convenience</span>

<span class="k">let</span> <span class="n">ltrim</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">global_replace</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;^[ </span><span class="se">\r\n\t\x00\x0B</span><span class="s2">]*&quot;</span><span class="o">)</span> <span class="s2">&quot;&quot;</span>
<span class="k">let</span> <span class="n">rtrim</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">global_replace</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[ </span><span class="se">\r\n\t\x00\x0B</span><span class="s2">]*$&quot;</span><span class="o">)</span> <span class="s2">&quot;&quot;</span>
<span class="k">let</span> <span class="n">trim</span> <span class="n">s</span> <span class="o">=</span> <span class="n">rtrim</span> <span class="o">(</span><span class="n">ltrim</span> <span class="n">s</span><span class="o">)</span>

<span class="k">let</span> <span class="n">find_title</span> <span class="n">html</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">title</span> <span class="o">=</span> <span class="n">ref</span> <span class="s2">&quot;&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="k">rec</span> <span class="n">loop</span> <span class="o">=</span> <span class="k">function</span>
    <span class="o">|</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span> <span class="o">(</span><span class="s2">&quot;title&quot;</span><span class="o">,</span> <span class="o">_,</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="n">data</span> <span class="o">::</span> <span class="o">_)</span> <span class="o">-&gt;</span>
        <span class="n">title</span> <span class="o">:=</span> <span class="n">trim</span> <span class="n">data</span><span class="o">;</span> <span class="k">raise</span> <span class="nc">Exit</span>
    <span class="o">|</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span> <span class="o">(_,</span> <span class="o">_,</span> <span class="n">children</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="n">loop</span> <span class="n">children</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span> <span class="k">in</span>
  <span class="o">(</span><span class="k">try</span> <span class="nn">List</span><span class="p">.</span><span class="n">iter</span> <span class="n">loop</span> <span class="n">html</span> <span class="k">with</span> <span class="nc">Exit</span> <span class="o">-&gt;</span> <span class="bp">()</span><span class="o">);</span>
  <span class="o">!</span><span class="n">title</span>

<span class="k">let</span> <span class="n">urls</span> <span class="o">=</span>
  <span class="k">if</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="o">&gt;</span> <span class="mi">1</span>
  <span class="k">then</span> <span class="nn">List</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">)</span>
  <span class="k">else</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;usage: %s url ...</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">);</span> <span class="n">exit</span> <span class="mi">1</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">url</span> <span class="o">-&gt;</span>
       <span class="n">print_string</span> <span class="o">(</span><span class="n">url</span> <span class="o">^</span> <span class="s2">&quot;: &quot;</span><span class="o">);</span>
       <span class="k">try</span>
         <span class="k">let</span> <span class="n">res</span> <span class="o">=</span> <span class="n">http_get</span> <span class="n">url</span> <span class="k">in</span>
         <span class="k">let</span> <span class="n">ch</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">input_string</span> <span class="n">res</span> <span class="k">in</span>
         <span class="k">let</span> <span class="n">html</span> <span class="o">=</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="n">parse</span> <span class="n">ch</span> <span class="k">in</span>
         <span class="n">print_endline</span> <span class="o">(</span><span class="n">find_title</span> <span class="n">html</span><span class="o">)</span>
       <span class="k">with</span>
         <span class="o">|</span> <span class="nn">Http_client</span><span class="p">.</span><span class="nc">Http_error</span> <span class="o">(</span><span class="n">status</span><span class="o">,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
             <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%d %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">status</span>
               <span class="o">(</span><span class="nn">Nethttp</span><span class="p">.</span><span class="n">string_of_http_status</span>
                  <span class="o">(</span><span class="nn">Nethttp</span><span class="p">.</span><span class="n">http_status_of_int</span> <span class="n">status</span><span class="o">))</span>
         <span class="o">|</span> <span class="nc">Failure</span> <span class="n">s</span> <span class="o">-&gt;</span> <span class="n">print_endline</span> <span class="n">s</span><span class="o">)</span>
    <span class="n">urls</span>

<span class="c">(* @@PLEAC@@_20.7 *)</span>
<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* churl - check urls *)</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netclient&quot;</span><span class="o">;;</span>

<span class="k">open</span> <span class="nn">Http_client</span><span class="p">.</span><span class="nc">Convenience</span>
<span class="k">open</span> <span class="nc">Nethtml</span>

<span class="k">let</span> <span class="k">rec</span> <span class="n">fold_elements</span> <span class="n">f</span> <span class="n">accu</span> <span class="o">=</span> <span class="k">function</span>
  <span class="o">|</span> <span class="nc">Element</span> <span class="o">(_,</span> <span class="o">_,</span> <span class="n">children</span><span class="o">)</span> <span class="k">as</span> <span class="n">element</span> <span class="o">-&gt;</span>
      <span class="k">let</span> <span class="n">accu</span> <span class="o">=</span>
        <span class="nn">List</span><span class="p">.</span><span class="n">fold_right</span>
          <span class="o">(</span><span class="k">fun</span> <span class="n">child</span> <span class="n">accu</span> <span class="o">-&gt;</span>
             <span class="n">fold_elements</span> <span class="n">f</span> <span class="n">accu</span> <span class="n">child</span><span class="o">)</span>
          <span class="n">children</span>
          <span class="n">accu</span> <span class="k">in</span>
      <span class="n">f</span> <span class="n">accu</span> <span class="n">element</span>
  <span class="o">|</span> <span class="n">other</span> <span class="o">-&gt;</span> <span class="n">accu</span>

<span class="k">type</span> <span class="n">link</span> <span class="o">=</span> <span class="nc">A</span> <span class="k">of</span> <span class="kt">string</span> <span class="o">|</span> <span class="nc">IMG</span> <span class="k">of</span> <span class="kt">string</span>

<span class="k">let</span> <span class="n">find_links</span> <span class="n">elements</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">flatten</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span>
       <span class="o">(</span><span class="n">fold_elements</span>
          <span class="o">(</span><span class="k">fun</span> <span class="n">accu</span> <span class="n">element</span> <span class="o">-&gt;</span>
             <span class="k">match</span> <span class="n">element</span> <span class="k">with</span>
               <span class="o">|</span> <span class="nc">Element</span> <span class="o">(</span><span class="s2">&quot;a&quot;</span><span class="o">,</span> <span class="n">attribs</span><span class="o">,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
                   <span class="o">(</span><span class="k">try</span> <span class="nc">A</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">assoc</span> <span class="s2">&quot;href&quot;</span> <span class="n">attribs</span><span class="o">)</span> <span class="o">::</span> <span class="n">accu</span>
                    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="n">accu</span><span class="o">)</span>
               <span class="o">|</span> <span class="nc">Element</span> <span class="o">(</span><span class="s2">&quot;img&quot;</span><span class="o">,</span> <span class="n">attribs</span><span class="o">,</span> <span class="o">_)</span> <span class="o">-&gt;</span>
                   <span class="o">(</span><span class="k">try</span> <span class="nc">IMG</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">assoc</span> <span class="s2">&quot;src&quot;</span> <span class="n">attribs</span><span class="o">)</span> <span class="o">::</span> <span class="n">accu</span>
                    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="n">accu</span><span class="o">)</span>
               <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">accu</span><span class="o">)</span>
          <span class="bp">[]</span><span class="o">)</span>
       <span class="n">elements</span><span class="o">)</span>

<span class="k">let</span> <span class="n">check_url</span> <span class="n">url</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;  %s: %s</span><span class="se">\n</span><span class="s2">%!&quot;</span> <span class="n">url</span>
    <span class="o">(</span><span class="k">match</span> <span class="o">(</span><span class="n">http_head_message</span> <span class="n">url</span><span class="o">)#</span><span class="n">status</span> <span class="k">with</span>
       <span class="o">|</span> <span class="o">`</span><span class="nc">Successful</span> <span class="o">-&gt;</span> <span class="s2">&quot;OK&quot;</span>
       <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="s2">&quot;BAD&quot;</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">if</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="o">&lt;&gt;</span> <span class="mi">2</span>
  <span class="k">then</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;usage: %s &lt;start_url&gt;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">);</span> <span class="n">exit</span> <span class="mi">1</span><span class="o">)</span>

<span class="k">let</span> <span class="n">base_url</span> <span class="o">=</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span>
<span class="k">let</span> <span class="n">elements</span> <span class="o">=</span> <span class="n">parse</span> <span class="o">(</span><span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">input_string</span> <span class="o">(</span><span class="n">http_get</span> <span class="n">base_url</span><span class="o">))</span>
<span class="k">let</span> <span class="n">url_syntax</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="nn">Neturl</span><span class="p">.</span><span class="n">common_url_syntax</span> <span class="s2">&quot;http&quot;</span>
<span class="k">let</span> <span class="n">url_syntax</span> <span class="o">=</span>
  <span class="o">{</span><span class="n">url_syntax</span> <span class="k">with</span>
     <span class="nn">Neturl</span><span class="p">.</span><span class="n">url_enable_fragment</span> <span class="o">=</span> <span class="nn">Neturl</span><span class="p">.</span><span class="nc">Url_part_allowed</span><span class="o">}</span>
<span class="k">let</span> <span class="n">url_syntax</span> <span class="o">=</span> <span class="nn">Neturl</span><span class="p">.</span><span class="n">partial_url_syntax</span> <span class="n">url_syntax</span>

<span class="k">module</span> <span class="nc">StringSet</span> <span class="o">=</span> <span class="nn">Set</span><span class="p">.</span><span class="nc">Make</span><span class="o">(</span><span class="nc">String</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">print_endline</span> <span class="o">(</span><span class="n">base_url</span> <span class="o">^</span> <span class="s2">&quot;:&quot;</span><span class="o">);</span>
  <span class="nn">StringSet</span><span class="p">.</span><span class="n">iter</span> <span class="n">check_url</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">fold_left</span>
       <span class="o">(</span><span class="k">fun</span> <span class="n">accu</span> <span class="n">s</span> <span class="o">-&gt;</span>
          <span class="k">try</span>
            <span class="nn">StringSet</span><span class="p">.</span><span class="n">add</span>
              <span class="o">(</span><span class="nn">Neturl</span><span class="p">.</span><span class="n">string_of_url</span>
                 <span class="o">(</span><span class="nn">Neturl</span><span class="p">.</span><span class="n">apply_relative_url</span>
                    <span class="o">(</span><span class="nn">Neturl</span><span class="p">.</span><span class="n">url_of_string</span> <span class="n">url_syntax</span> <span class="n">base_url</span><span class="o">)</span>
                    <span class="o">(</span><span class="nn">Neturl</span><span class="p">.</span><span class="n">url_of_string</span> <span class="n">url_syntax</span> <span class="n">s</span><span class="o">)))</span>
              <span class="n">accu</span>
          <span class="k">with</span> <span class="nn">Neturl</span><span class="p">.</span><span class="nc">Malformed_URL</span> <span class="o">-&gt;</span>
            <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Malformed URL: %s</span><span class="se">\n</span><span class="s2">%!&quot;</span> <span class="n">s</span><span class="o">;</span>
            <span class="n">accu</span><span class="o">)</span>
       <span class="nn">StringSet</span><span class="p">.</span><span class="n">empty</span>
       <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span>
          <span class="o">(</span><span class="k">function</span>
             <span class="o">|</span> <span class="nc">A</span> <span class="n">href</span> <span class="o">-&gt;</span> <span class="n">href</span>
             <span class="o">|</span> <span class="nc">IMG</span> <span class="n">src</span> <span class="o">-&gt;</span> <span class="n">src</span><span class="o">)</span>
          <span class="o">(</span><span class="n">find_links</span> <span class="n">elements</span><span class="o">)))</span>

<span class="c">(* @@PLEAC@@_20.8 *)</span>
<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* surl - sort URLs by their last modification date *)</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netclient&quot;</span><span class="o">;;</span>

<span class="k">open</span> <span class="nn">Http_client</span><span class="p">.</span><span class="nc">Convenience</span>

<span class="k">let</span> <span class="n">dates</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">try</span>
    <span class="k">while</span> <span class="bp">true</span> <span class="k">do</span>
      <span class="k">let</span> <span class="n">url</span> <span class="o">=</span> <span class="n">input_line</span> <span class="n">stdin</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">call</span> <span class="o">=</span> <span class="n">http_head_message</span> <span class="n">url</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">date</span> <span class="o">=</span>
        <span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="nn">Netdate</span><span class="p">.</span><span class="n">parse</span>
                    <span class="o">(</span><span class="n">call</span><span class="o">#</span><span class="n">response_header</span><span class="o">#</span><span class="n">field</span> <span class="s2">&quot;Last-Modified&quot;</span><span class="o">))</span>
        <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="nc">None</span> <span class="k">in</span>
      <span class="n">dates</span> <span class="o">:=</span> <span class="o">(</span><span class="n">date</span><span class="o">,</span> <span class="n">url</span><span class="o">)</span> <span class="o">::</span> <span class="o">!</span><span class="n">dates</span>
    <span class="k">done</span>
  <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="bp">()</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">date</span><span class="o">,</span> <span class="n">url</span><span class="o">)</span> <span class="o">-&gt;</span>
       <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%-25s %s</span><span class="se">\n</span><span class="s2">&quot;</span>
         <span class="o">(</span><span class="k">match</span> <span class="n">date</span> <span class="k">with</span>
            <span class="o">|</span> <span class="nc">Some</span> <span class="n">date</span> <span class="o">-&gt;</span> <span class="nn">Netdate</span><span class="p">.</span><span class="n">format</span> <span class="s2">&quot;%a %b %d %H:%M:%S %Y&quot;</span> <span class="n">date</span>
            <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="s2">&quot;&lt;NONE SPECIFIED&gt;&quot;</span><span class="o">)</span>
         <span class="n">url</span><span class="o">)</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">sort</span> <span class="n">compare</span> <span class="o">!</span><span class="n">dates</span><span class="o">))</span>

<span class="c">(* @@PLEAC@@_20.9 *)</span>
<span class="c">(* Template replacement using regular expressions from the Str module. *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">slurp_channel</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">buffer_size</span> <span class="o">=</span> <span class="mi">4096</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">create</span> <span class="n">buffer_size</span> <span class="k">in</span>
  <span class="k">let</span> <span class="kt">string</span> <span class="o">=</span> <span class="nn">String</span><span class="p">.</span><span class="n">create</span> <span class="n">buffer_size</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">chars_read</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">1</span> <span class="k">in</span>
  <span class="k">while</span> <span class="o">!</span><span class="n">chars_read</span> <span class="o">&lt;&gt;</span> <span class="mi">0</span> <span class="k">do</span>
    <span class="n">chars_read</span> <span class="o">:=</span> <span class="n">input</span> <span class="n">channel</span> <span class="kt">string</span> <span class="mi">0</span> <span class="n">buffer_size</span><span class="o">;</span>
    <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_substring</span> <span class="n">buffer</span> <span class="kt">string</span> <span class="mi">0</span> <span class="o">!</span><span class="n">chars_read</span>
  <span class="k">done</span><span class="o">;</span>
  <span class="nn">Buffer</span><span class="p">.</span><span class="n">contents</span> <span class="n">buffer</span>

<span class="k">let</span> <span class="n">slurp_file</span> <span class="n">filename</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">open_in_bin</span> <span class="n">filename</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">result</span> <span class="o">=</span>
    <span class="k">try</span> <span class="n">slurp_channel</span> <span class="n">channel</span>
    <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span> <span class="n">close_in</span> <span class="n">channel</span><span class="o">;</span> <span class="k">raise</span> <span class="n">e</span> <span class="k">in</span>
  <span class="n">close_in</span> <span class="n">channel</span><span class="o">;</span>
  <span class="n">result</span>

<span class="k">let</span> <span class="n">template_regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;%%</span><span class="se">\\</span><span class="s2">([^%]+</span><span class="se">\\</span><span class="s2">)%%&quot;</span>

<span class="k">let</span> <span class="n">template</span> <span class="n">filename</span> <span class="n">fillings</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">text</span> <span class="o">=</span> <span class="n">slurp_file</span> <span class="n">filename</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">eval</span> <span class="n">s</span> <span class="o">=</span>
    <span class="k">try</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">fillings</span> <span class="n">s</span>
    <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="s2">&quot;&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">replace</span> <span class="o">_</span> <span class="o">=</span>
    <span class="n">eval</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">matched_group</span> <span class="mi">1</span> <span class="n">text</span><span class="o">)</span> <span class="k">in</span>
  <span class="nn">Str</span><span class="p">.</span><span class="n">global_substitute</span> <span class="n">template_regexp</span> <span class="n">replace</span> <span class="n">text</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Alternative implementation: a hand-written stream parser. This version</span>
<span class="c">   avoids loading the whole template into memory, so it is efficient for</span>
<span class="c">   large files. *)</span>

<span class="k">let</span> <span class="n">template</span> <span class="n">filename</span> <span class="n">fillings</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">f</span> <span class="o">=</span> <span class="n">open_in</span> <span class="n">filename</span> <span class="k">in</span>
  <span class="k">try</span>
    <span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">create</span> <span class="o">(</span><span class="n">in_channel_length</span> <span class="n">f</span><span class="o">)</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">text</span> <span class="o">=</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">of_channel</span> <span class="n">f</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">eval</span> <span class="n">s</span> <span class="o">=</span>
      <span class="k">try</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">fillings</span> <span class="n">s</span>
      <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="s2">&quot;&quot;</span> <span class="k">in</span>
    <span class="k">let</span> <span class="k">rec</span> <span class="n">search</span> <span class="bp">()</span> <span class="o">=</span>
      <span class="k">match</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">peek</span> <span class="n">text</span> <span class="k">with</span>
        <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="bp">()</span>
        <span class="o">|</span> <span class="nc">Some</span> <span class="sc">&#39;%&#39;</span> <span class="o">-&gt;</span>
            <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">text</span><span class="o">;</span>
            <span class="o">(</span><span class="k">match</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">peek</span> <span class="n">text</span> <span class="k">with</span>
               <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span>
                   <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_char</span> <span class="n">buffer</span> <span class="sc">&#39;%&#39;</span><span class="o">;</span>
                   <span class="n">search</span> <span class="bp">()</span>
               <span class="o">|</span> <span class="nc">Some</span> <span class="sc">&#39;%&#39;</span> <span class="o">-&gt;</span>
                   <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">text</span><span class="o">;</span>
                   <span class="n">replace</span> <span class="s2">&quot;&quot;</span>
               <span class="o">|</span> <span class="nc">Some</span> <span class="n">c</span> <span class="o">-&gt;</span>
                   <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">text</span><span class="o">;</span>
                   <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_char</span> <span class="n">buffer</span> <span class="sc">&#39;%&#39;</span><span class="o">;</span>
                   <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_char</span> <span class="n">buffer</span> <span class="n">c</span><span class="o">;</span>
                   <span class="n">search</span> <span class="bp">()</span><span class="o">)</span>
        <span class="o">|</span> <span class="nc">Some</span> <span class="n">c</span> <span class="o">-&gt;</span>
            <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">text</span><span class="o">;</span>
            <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_char</span> <span class="n">buffer</span> <span class="n">c</span><span class="o">;</span>
            <span class="n">search</span> <span class="bp">()</span>
    <span class="ow">and</span> <span class="n">replace</span> <span class="n">acc</span> <span class="o">=</span>
      <span class="k">match</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">peek</span> <span class="n">text</span> <span class="k">with</span>
        <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span>
            <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_string</span> <span class="n">buffer</span> <span class="s2">&quot;%%&quot;</span><span class="o">;</span>
            <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_string</span> <span class="n">buffer</span> <span class="n">acc</span>
        <span class="o">|</span> <span class="nc">Some</span> <span class="sc">&#39;%&#39;</span> <span class="o">-&gt;</span>
            <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">text</span><span class="o">;</span>
            <span class="o">(</span><span class="k">match</span> <span class="nn">Stream</span><span class="p">.</span><span class="n">peek</span> <span class="n">text</span> <span class="k">with</span>
               <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span>
                   <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_string</span> <span class="n">buffer</span> <span class="s2">&quot;%%&quot;</span><span class="o">;</span>
                   <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_string</span> <span class="n">buffer</span> <span class="n">acc</span><span class="o">;</span>
                   <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_char</span> <span class="n">buffer</span> <span class="sc">&#39;%&#39;</span>
               <span class="o">|</span> <span class="nc">Some</span> <span class="sc">&#39;%&#39;</span> <span class="o">-&gt;</span>
                   <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">text</span><span class="o">;</span>
                   <span class="nn">Buffer</span><span class="p">.</span><span class="n">add_string</span> <span class="n">buffer</span> <span class="o">(</span><span class="n">eval</span> <span class="n">acc</span><span class="o">);</span>
                   <span class="n">search</span> <span class="bp">()</span>
               <span class="o">|</span> <span class="nc">Some</span> <span class="n">c</span> <span class="o">-&gt;</span>
                   <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">text</span><span class="o">;</span>
                   <span class="n">replace</span> <span class="o">(</span><span class="n">acc</span> <span class="o">^</span> <span class="s2">&quot;%&quot;</span> <span class="o">^</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="mi">1</span> <span class="n">c</span><span class="o">)))</span>
        <span class="o">|</span> <span class="nc">Some</span> <span class="n">c</span> <span class="o">-&gt;</span>
            <span class="nn">Stream</span><span class="p">.</span><span class="n">junk</span> <span class="n">text</span><span class="o">;</span>
            <span class="n">replace</span> <span class="o">(</span><span class="n">acc</span> <span class="o">^</span> <span class="o">(</span><span class="nn">String</span><span class="p">.</span><span class="n">make</span> <span class="mi">1</span> <span class="n">c</span><span class="o">))</span> <span class="k">in</span>
    <span class="n">search</span> <span class="bp">()</span><span class="o">;</span>
    <span class="n">close_in</span> <span class="n">f</span><span class="o">;</span>
    <span class="nn">Buffer</span><span class="p">.</span><span class="n">contents</span> <span class="n">buffer</span>
  <span class="k">with</span> <span class="n">e</span> <span class="o">-&gt;</span>
    <span class="n">close_in</span> <span class="n">f</span><span class="o">;</span>
    <span class="k">raise</span> <span class="n">e</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* simple.template contains the following:</span>

<span class="c">&lt;!-- simple.template for internal template() function --&gt;</span>
<span class="c">&lt;HTML&gt;&lt;HEAD&gt;&lt;TITLE&gt;Report for %%username%%&lt;/TITLE&gt;&lt;/HEAD&gt;</span>
<span class="c">&lt;BODY&gt;&lt;H1&gt;Report for %%username%%&lt;/H1&gt;</span>
<span class="c">%%username%% logged in %%count%% times, for a total of %%total%% minutes.</span>

<span class="c">*)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">fields</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">3</span> <span class="k">in</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">fields</span> <span class="s2">&quot;username&quot;</span> <span class="n">whats_his_name</span><span class="o">;</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">fields</span> <span class="s2">&quot;count&quot;</span> <span class="o">(</span><span class="n">string_of_int</span> <span class="n">login_count</span><span class="o">);</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">fields</span> <span class="s2">&quot;total&quot;</span> <span class="o">(</span><span class="n">string_of_int</span> <span class="n">minute_used</span><span class="o">);</span>
  <span class="n">print_endline</span> <span class="o">(</span><span class="n">template</span> <span class="s2">&quot;simple.template&quot;</span> <span class="n">fields</span><span class="o">)</span>

<span class="c">(* Output:</span>

<span class="c">&lt;!-- simple.template for internal template() function --&gt;</span>
<span class="c">&lt;HTML&gt;&lt;HEAD&gt;&lt;TITLE&gt;Report for ramen&lt;/TITLE&gt;&lt;/HEAD&gt;</span>
<span class="c">&lt;BODY&gt;&lt;H1&gt;Report for ramen&lt;/H1&gt;</span>
<span class="c">ramen logged in 42 times, for a total of 123 minutes.</span>

<span class="c">*)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* userrep - report duration of user logins using SQL database *)</span>

<span class="k">let</span> <span class="n">process</span> <span class="o">(</span><span class="n">cgi</span> <span class="o">:</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">cgi</span><span class="o">)</span> <span class="o">=</span>
  <span class="n">cgi</span><span class="o">#</span><span class="n">set_header</span> <span class="o">~</span><span class="n">content_type</span><span class="o">:</span><span class="s2">&quot;text/html&quot;</span> <span class="bp">()</span><span class="o">;</span>
  <span class="k">begin</span>
    <span class="k">match</span> <span class="n">cgi</span><span class="o">#</span><span class="n">argument_value</span> <span class="s2">&quot;username&quot;</span> <span class="k">with</span>
      <span class="o">|</span> <span class="s2">&quot;&quot;</span> <span class="o">-&gt;</span>
          <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">output_string</span> <span class="s2">&quot;No username&quot;</span>
      <span class="o">|</span> <span class="n">user</span> <span class="o">-&gt;</span>
          <span class="k">let</span> <span class="n">db</span> <span class="o">=</span>
            <span class="nn">Mysql</span><span class="p">.</span><span class="n">quick_connect</span>
              <span class="o">~</span><span class="n">user</span><span class="o">:</span><span class="s2">&quot;user&quot;</span>
              <span class="o">~</span><span class="n">password</span><span class="o">:</span><span class="s2">&quot;seekritpassword&quot;</span>
              <span class="o">~</span><span class="n">database</span><span class="o">:</span><span class="s2">&quot;connections&quot;</span> <span class="bp">()</span> <span class="k">in</span>
          <span class="k">let</span> <span class="n">sql</span> <span class="o">=</span> <span class="nn">Printf</span><span class="p">.</span><span class="n">sprintf</span> <span class="s2">&quot;</span>
<span class="s2">            SELECT COUNT(duration),SUM(duration)</span>
<span class="s2">            FROM logins WHERE username=&#39;%s&#39;</span>
<span class="s2">          &quot;</span> <span class="o">(</span><span class="nn">Mysql</span><span class="p">.</span><span class="n">escape</span> <span class="n">user</span><span class="o">)</span> <span class="k">in</span>
          <span class="k">let</span> <span class="n">result</span> <span class="o">=</span> <span class="nn">Mysql</span><span class="p">.</span><span class="n">exec</span> <span class="n">db</span> <span class="n">sql</span> <span class="k">in</span>
          <span class="k">let</span> <span class="n">default</span> <span class="n">d</span> <span class="o">=</span> <span class="k">function</span> <span class="nc">Some</span> <span class="n">x</span> <span class="o">-&gt;</span> <span class="n">x</span> <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="n">d</span> <span class="k">in</span>
          <span class="k">let</span> <span class="o">(</span><span class="n">count</span><span class="o">,</span> <span class="n">total</span><span class="o">)</span> <span class="o">=</span>
            <span class="k">match</span> <span class="nn">Mysql</span><span class="p">.</span><span class="n">fetch</span> <span class="n">result</span> <span class="k">with</span>
              <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="o">(</span><span class="s2">&quot;0&quot;</span><span class="o">,</span> <span class="s2">&quot;0&quot;</span><span class="o">)</span>
              <span class="o">|</span> <span class="nc">Some</span> <span class="n">row</span> <span class="o">-&gt;</span>
                  <span class="o">(</span><span class="n">default</span> <span class="s2">&quot;0&quot;</span> <span class="n">row</span><span class="o">.(</span><span class="mi">0</span><span class="o">),</span>
                   <span class="n">default</span> <span class="s2">&quot;0&quot;</span> <span class="n">row</span><span class="o">.(</span><span class="mi">1</span><span class="o">))</span> <span class="k">in</span>
          <span class="c">(* template defined in the solution above *)</span>
          <span class="k">let</span> <span class="n">tpl</span> <span class="o">=</span> <span class="n">template</span> <span class="s2">&quot;report.tpl&quot;</span> <span class="k">in</span>
          <span class="k">let</span> <span class="n">vars</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">3</span> <span class="k">in</span>
          <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">vars</span> <span class="s2">&quot;username&quot;</span> <span class="n">user</span><span class="o">;</span>
          <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">vars</span> <span class="s2">&quot;count&quot;</span> <span class="n">count</span><span class="o">;</span>
          <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">vars</span> <span class="s2">&quot;total&quot;</span> <span class="n">total</span><span class="o">;</span>
          <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">output_string</span> <span class="o">(</span><span class="n">tpl</span> <span class="n">vars</span><span class="o">)</span>
  <span class="k">end</span><span class="o">;</span>
  <span class="n">cgi</span><span class="o">#</span><span class="n">out_channel</span><span class="o">#</span><span class="n">commit_work</span> <span class="bp">()</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">config</span> <span class="o">=</span> <span class="nn">Netcgi</span><span class="p">.</span><span class="n">default_config</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">buffered</span> <span class="o">_</span> <span class="n">ch</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">buffered_trans_channel</span> <span class="n">ch</span> <span class="k">in</span>
  <span class="nn">Netcgi_cgi</span><span class="p">.</span><span class="n">run</span> <span class="o">~</span><span class="n">config</span> <span class="o">~</span><span class="n">output_type</span><span class="o">:(`</span><span class="nc">Transactional</span> <span class="n">buffered</span><span class="o">)</span> <span class="n">process</span>

<span class="c">(* @@PLEAC@@_20.10 *)</span>
<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;unix&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netclient&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">mirror</span> <span class="n">url</span> <span class="n">file</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">call</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Http_client</span><span class="p">.</span><span class="n">get</span> <span class="n">url</span> <span class="k">in</span>
  <span class="k">begin</span>
    <span class="k">try</span>
      <span class="k">let</span> <span class="n">mtime</span> <span class="o">=</span> <span class="o">(</span><span class="nn">Unix</span><span class="p">.</span><span class="n">stat</span> <span class="n">file</span><span class="o">).</span><span class="nn">Unix</span><span class="p">.</span><span class="n">st_mtime</span> <span class="k">in</span>
      <span class="k">let</span> <span class="n">date</span> <span class="o">=</span> <span class="nn">Netdate</span><span class="p">.</span><span class="n">mk_mail_date</span> <span class="n">mtime</span> <span class="k">in</span>
      <span class="n">call</span><span class="o">#</span><span class="n">set_req_header</span> <span class="s2">&quot;If-Modified-Since&quot;</span> <span class="n">date</span>
    <span class="k">with</span> <span class="nn">Unix</span><span class="p">.</span><span class="nc">Unix_error</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="bp">()</span>
  <span class="k">end</span><span class="o">;</span>
  <span class="n">call</span><span class="o">#</span><span class="n">set_response_body_storage</span> <span class="o">(`</span><span class="nc">File</span> <span class="o">(</span><span class="k">fun</span> <span class="bp">()</span> <span class="o">-&gt;</span> <span class="n">file</span><span class="o">));</span>
  <span class="k">let</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Http_client</span><span class="p">.</span><span class="n">pipeline</span> <span class="k">in</span>
  <span class="n">pipeline</span><span class="o">#</span><span class="n">add</span> <span class="n">call</span><span class="o">;</span>
  <span class="n">pipeline</span><span class="o">#</span><span class="n">run</span> <span class="bp">()</span><span class="o">;</span>
  <span class="k">if</span> <span class="n">call</span><span class="o">#</span><span class="n">response_status</span> <span class="o">=</span> <span class="o">`</span><span class="nc">Ok</span>
  <span class="k">then</span> <span class="o">(</span><span class="k">let</span> <span class="n">date</span> <span class="o">=</span>
          <span class="nn">Netdate</span><span class="p">.</span><span class="n">parse</span>
            <span class="o">(</span><span class="n">call</span><span class="o">#</span><span class="n">response_header</span><span class="o">#</span><span class="n">field</span> <span class="s2">&quot;Last-Modified&quot;</span><span class="o">)</span> <span class="k">in</span>
        <span class="nn">Unix</span><span class="p">.</span><span class="n">utimes</span> <span class="n">file</span> <span class="mi">0</span><span class="o">.</span><span class="mi">0</span> <span class="o">(</span><span class="nn">Netdate</span><span class="p">.</span><span class="n">since_epoch</span> <span class="n">date</span><span class="o">));</span>
  <span class="n">call</span><span class="o">#</span><span class="n">response_status</span>

<span class="c">(* @@PLEAC@@_20.11 *)</span>
<span class="o">#</span><span class="n">load</span> <span class="s2">&quot;str.cma&quot;</span><span class="o">;;</span>

<span class="c">(* Parse &quot;robots.txt&quot; content from a stream of lines and return a</span>
<span class="c">   list of user agents and a multi-valued hash table containing the</span>
<span class="c">   rules for each user agent. *)</span>
<span class="k">let</span> <span class="n">parse_robots</span> <span class="o">=</span>
  <span class="k">let</span> <span class="k">module</span> <span class="nc">S</span> <span class="o">=</span> <span class="nn">Set</span><span class="p">.</span><span class="nc">Make</span><span class="o">(</span><span class="k">struct</span>
                            <span class="k">type</span> <span class="n">t</span> <span class="o">=</span> <span class="kt">string</span>
                            <span class="k">let</span> <span class="n">compare</span> <span class="o">=</span> <span class="n">compare</span>
                          <span class="k">end</span><span class="o">)</span> <span class="k">in</span>

  <span class="c">(* Precompile regular expressions. *)</span>
  <span class="k">let</span> <span class="n">comments</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;#.*&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">leading_white</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;^[ </span><span class="se">\t</span><span class="s2">]+&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">trailing_white</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[ </span><span class="se">\t\r</span><span class="s2">]+$&quot;</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">colon_delim</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;[ </span><span class="se">\t</span><span class="s2">]*:[ </span><span class="se">\t</span><span class="s2">]*&quot;</span> <span class="k">in</span>

  <span class="k">fun</span> <span class="n">stream</span> <span class="o">-&gt;</span>
    <span class="k">let</span> <span class="n">user_agent</span> <span class="o">=</span> <span class="n">ref</span> <span class="s2">&quot;*&quot;</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">user_agents</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="nn">S</span><span class="p">.</span><span class="n">singleton</span> <span class="s2">&quot;*&quot;</span><span class="o">)</span> <span class="k">in</span>
    <span class="k">let</span> <span class="n">rules</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span> <span class="k">in</span>

    <span class="nn">Stream</span><span class="p">.</span><span class="n">iter</span>
      <span class="o">(</span><span class="k">fun</span> <span class="n">s</span> <span class="o">-&gt;</span>
         <span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span> <span class="n">comments</span> <span class="s2">&quot;&quot;</span> <span class="n">s</span> <span class="k">in</span>
         <span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span> <span class="n">leading_white</span> <span class="s2">&quot;&quot;</span> <span class="n">s</span> <span class="k">in</span>
         <span class="k">let</span> <span class="n">s</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">replace_first</span> <span class="n">trailing_white</span> <span class="s2">&quot;&quot;</span> <span class="n">s</span> <span class="k">in</span>
         <span class="k">if</span> <span class="nn">String</span><span class="p">.</span><span class="n">length</span> <span class="n">s</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">then</span>
           <span class="k">match</span> <span class="nn">Str</span><span class="p">.</span><span class="n">bounded_split_delim</span> <span class="n">colon_delim</span> <span class="n">s</span> <span class="mi">2</span> <span class="k">with</span>
             <span class="o">|</span> <span class="o">[</span><span class="s2">&quot;User-agent&quot;</span><span class="o">;</span> <span class="k">value</span><span class="o">]</span> <span class="o">-&gt;</span>
                 <span class="c">(* Found a new User-agent. *)</span>
                 <span class="n">user_agent</span> <span class="o">:=</span> <span class="k">value</span><span class="o">;</span>
                 <span class="n">user_agents</span> <span class="o">:=</span> <span class="nn">S</span><span class="p">.</span><span class="n">add</span> <span class="k">value</span> <span class="o">!</span><span class="n">user_agents</span>
             <span class="o">|</span> <span class="o">[</span><span class="s2">&quot;Sitemap&quot;</span><span class="o">;</span> <span class="k">value</span><span class="o">]</span> <span class="o">-&gt;</span>
                 <span class="c">(* Sitemaps are always global. *)</span>
                 <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">add</span> <span class="n">rules</span> <span class="s2">&quot;*&quot;</span> <span class="o">(</span><span class="s2">&quot;Sitemap&quot;</span><span class="o">,</span> <span class="k">value</span><span class="o">)</span>
             <span class="o">|</span> <span class="o">[</span><span class="n">key</span><span class="o">;</span> <span class="k">value</span><span class="o">]</span> <span class="o">-&gt;</span>
                 <span class="c">(* Found a rule for the current User-agent. *)</span>
                 <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">add</span> <span class="n">rules</span> <span class="o">!</span><span class="n">user_agent</span> <span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="k">value</span><span class="o">)</span>
             <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">failwith</span> <span class="n">s</span><span class="o">)</span>
      <span class="n">stream</span><span class="o">;</span>
    <span class="nn">S</span><span class="p">.</span><span class="n">elements</span> <span class="o">!</span><span class="n">user_agents</span><span class="o">,</span> <span class="n">rules</span>

<span class="c">(* Produce a stream of lines from an input channel. *)</span>
<span class="k">let</span> <span class="n">line_stream_of_channel</span> <span class="n">channel</span> <span class="o">=</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">from</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="k">try</span> <span class="nc">Some</span> <span class="o">(</span><span class="n">input_line</span> <span class="n">channel</span><span class="o">)</span> <span class="k">with</span> <span class="nc">End_of_file</span> <span class="o">-&gt;</span> <span class="nc">None</span><span class="o">)</span>

<span class="c">(* Produce a stream of lines from a string in memory. *)</span>
<span class="k">let</span> <span class="n">line_stream_of_string</span> <span class="kt">string</span> <span class="o">=</span>
  <span class="nn">Stream</span><span class="p">.</span><span class="n">of_list</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">split</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">regexp</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">)</span> <span class="kt">string</span><span class="o">)</span>

<span class="c">(*-----------------------------*)</span>

<span class="c">(* Use Ocamlnet to retrieve a &quot;robots.txt&quot; file and print its rules. *)</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netclient&quot;</span><span class="o">;;</span>
<span class="k">open</span> <span class="nn">Http_client</span><span class="p">.</span><span class="nc">Convenience</span>

<span class="k">let</span> <span class="n">agents</span><span class="o">,</span> <span class="n">rules</span> <span class="o">=</span>
  <span class="n">parse_robots</span>
    <span class="o">(</span><span class="n">line_stream_of_string</span>
       <span class="o">(</span><span class="n">http_get</span> <span class="s2">&quot;http://sourceforge.net/robots.txt&quot;</span><span class="o">))</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">agent</span> <span class="o">-&gt;</span>
       <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;User-agent: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">agent</span><span class="o">;</span>
       <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
         <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">key</span><span class="o">,</span> <span class="k">value</span><span class="o">)</span> <span class="o">-&gt;</span>
            <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">%s: %s</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="n">key</span> <span class="k">value</span><span class="o">)</span>
         <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find_all</span> <span class="n">rules</span> <span class="n">agent</span><span class="o">))</span>
    <span class="n">agents</span>

<span class="c">(* @@PLEAC@@_20.12 *)</span>
<span class="c">(* Use the Weblogs library by Richard Jones:</span>
<span class="c">   http://merjis.com/developers/weblogs</span>

<span class="c">   You will also need the HostIP library:</span>
<span class="c">   http://merjis.com/developers/hostip *)</span>

<span class="k">let</span> <span class="n">log</span> <span class="o">=</span> <span class="nn">Weblogs</span><span class="p">.</span><span class="n">import_file</span> <span class="s2">&quot;/var/log/apache2/access.log&quot;</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">{</span><span class="nn">Weblogs</span><span class="p">.</span><span class="n">src_ip</span><span class="o">=</span><span class="n">client</span><span class="o">;</span>
          <span class="n">remote_username</span><span class="o">=</span><span class="n">identuser</span><span class="o">;</span>
          <span class="n">username</span><span class="o">=</span><span class="n">authuser</span><span class="o">;</span>
          <span class="n">t</span><span class="o">=</span><span class="n">datetime</span><span class="o">;</span>
          <span class="n">http_method</span><span class="o">=</span><span class="k">method&#39;</span><span class="o">;</span>
          <span class="n">full_url</span><span class="o">=</span><span class="n">url</span><span class="o">;</span>
          <span class="n">http_version</span><span class="o">=</span><span class="n">protocol</span><span class="o">;</span>
          <span class="n">rcode</span><span class="o">=</span><span class="n">status</span><span class="o">;</span>
          <span class="n">size</span><span class="o">=</span><span class="n">bytes</span><span class="o">;</span>
          <span class="c">(* Many more fields are available.</span>
<span class="c">             See Weblogs API documentation for details. *)</span>
         <span class="o">}</span> <span class="o">-&gt;</span>
       <span class="c">(* ... *)</span>
       <span class="bp">()</span><span class="o">)</span>
    <span class="n">log</span>

<span class="c">(* @@PLEAC@@_20.13 *)</span>
<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* sumwww - summarize web server log activity *)</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;weblogs&quot;</span><span class="o">;;</span>

<span class="k">open</span> <span class="nc">Weblogs</span>

<span class="k">let</span> <span class="n">file</span> <span class="o">=</span>
  <span class="k">if</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="o">=</span> <span class="mi">2</span>
  <span class="k">then</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span>
  <span class="k">else</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;usage: %s &lt;logfile&gt;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">);</span>
        <span class="n">exit</span> <span class="mi">1</span><span class="o">)</span>

<span class="k">let</span> <span class="n">format_date</span> <span class="o">=</span> <span class="nn">CalendarLib</span><span class="p">.</span><span class="nn">Printer</span><span class="p">.</span><span class="nn">CalendarPrinter</span><span class="p">.</span><span class="n">sprint</span> <span class="s2">&quot;%d/%b/%Y&quot;</span>

<span class="k">let</span> <span class="n">incr_hash</span> <span class="n">hash</span> <span class="n">key</span> <span class="n">by</span> <span class="o">=</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">hash</span> <span class="n">key</span>
    <span class="o">(</span><span class="k">try</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">hash</span> <span class="n">key</span> <span class="o">+</span> <span class="n">by</span>
     <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="n">by</span><span class="o">)</span>

<span class="k">let</span> <span class="n">count_hash</span> <span class="n">hash</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="k">fun</span> <span class="o">_</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">incr</span> <span class="n">count</span><span class="o">)</span> <span class="n">hash</span><span class="o">;</span>
  <span class="o">!</span><span class="n">count</span>

<span class="k">let</span> <span class="n">add_hash</span> <span class="n">dest</span> <span class="n">src</span> <span class="o">=</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span> <span class="o">(</span><span class="n">incr_hash</span> <span class="n">dest</span><span class="o">)</span> <span class="n">src</span>

<span class="k">let</span> <span class="n">lastdate</span> <span class="o">=</span> <span class="n">ref</span> <span class="s2">&quot;&quot;</span>

<span class="k">let</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>
<span class="k">let</span> <span class="n">posts</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>
<span class="k">let</span> <span class="n">homes</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>
<span class="k">let</span> <span class="n">bytesum</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span><span class="n">l</span>
<span class="k">let</span> <span class="n">hosts</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span><span class="o">)</span>
<span class="k">let</span> <span class="n">whats</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span><span class="o">)</span>

<span class="k">let</span> <span class="n">sumcount</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>
<span class="k">let</span> <span class="n">allposts</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>
<span class="k">let</span> <span class="n">allhomes</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span>
<span class="k">let</span> <span class="n">bytesumsum</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span><span class="n">l</span>
<span class="k">let</span> <span class="n">allhosts</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span><span class="o">)</span>
<span class="k">let</span> <span class="n">allwhats</span> <span class="o">=</span> <span class="n">ref</span> <span class="o">(</span><span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span><span class="o">)</span>

<span class="c">(* display the tallies of hosts and URLs *)</span>
<span class="k">let</span> <span class="n">write_report</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%s %7d %8d %8d %7d %7d %14ld</span><span class="se">\n</span><span class="s2">%!&quot;</span>
    <span class="o">!</span><span class="n">lastdate</span> <span class="o">(</span><span class="n">count_hash</span> <span class="o">!</span><span class="n">hosts</span><span class="o">)</span> <span class="o">!</span><span class="n">count</span> <span class="o">(</span><span class="n">count_hash</span> <span class="o">!</span><span class="n">whats</span><span class="o">)</span>
    <span class="o">!</span><span class="n">posts</span> <span class="o">!</span><span class="n">homes</span> <span class="o">!</span><span class="n">bytesum</span><span class="o">;</span>

  <span class="c">(* add to summary data *)</span>
  <span class="n">sumcount</span> <span class="o">:=</span> <span class="o">!</span><span class="n">sumcount</span> <span class="o">+</span> <span class="o">!</span><span class="n">count</span><span class="o">;</span>
  <span class="n">bytesumsum</span> <span class="o">:=</span> <span class="nn">Int32</span><span class="p">.</span><span class="n">add</span> <span class="o">!</span><span class="n">bytesumsum</span> <span class="o">!</span><span class="n">bytesum</span><span class="o">;</span>
  <span class="n">allposts</span> <span class="o">:=</span> <span class="o">!</span><span class="n">allposts</span> <span class="o">+</span> <span class="o">!</span><span class="n">posts</span><span class="o">;</span>
  <span class="n">allhomes</span> <span class="o">:=</span> <span class="o">!</span><span class="n">allhomes</span> <span class="o">+</span> <span class="o">!</span><span class="n">homes</span><span class="o">;</span>

  <span class="c">(* reset daily data *)</span>
  <span class="n">count</span> <span class="o">:=</span> <span class="mi">0</span><span class="o">;</span>
  <span class="n">posts</span> <span class="o">:=</span> <span class="mi">0</span><span class="o">;</span>
  <span class="n">homes</span> <span class="o">:=</span> <span class="mi">0</span><span class="o">;</span>
  <span class="n">bytesum</span> <span class="o">:=</span> <span class="mi">0</span><span class="n">l</span><span class="o">;</span>
  <span class="n">add_hash</span> <span class="o">!</span><span class="n">allhosts</span> <span class="o">!</span><span class="n">hosts</span><span class="o">;</span>
  <span class="n">add_hash</span> <span class="o">!</span><span class="n">allwhats</span> <span class="o">!</span><span class="n">whats</span><span class="o">;</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">clear</span> <span class="o">!</span><span class="n">hosts</span><span class="o">;</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">clear</span> <span class="o">!</span><span class="n">whats</span>

<span class="c">(* read log file and tally hits from the host and to the URL *)</span>
<span class="k">let</span> <span class="n">daily_logs</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">log</span> <span class="o">=</span> <span class="n">import_file</span> <span class="n">file</span> <span class="k">in</span>
  <span class="n">print_endline</span>
    <span class="s2">&quot;    Date     Hosts  Accesses  Unidocs   POST    Home       Bytes&quot;</span><span class="o">;</span>
  <span class="n">print_endline</span>
    <span class="s2">&quot;----------- ------- -------- -------- ------- ------- --------------&quot;</span><span class="o">;</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">row</span> <span class="o">-&gt;</span>
       <span class="k">let</span> <span class="n">date</span> <span class="o">=</span> <span class="n">format_date</span> <span class="n">row</span><span class="o">.</span><span class="n">t</span> <span class="k">in</span>
       <span class="k">let</span> <span class="n">host</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">src_ip</span> <span class="k">in</span>
       <span class="k">let</span> <span class="n">what</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">url</span> <span class="k">in</span>
       <span class="k">let</span> <span class="n">post</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">http_method</span> <span class="o">=</span> <span class="nc">POST</span> <span class="k">in</span>
       <span class="k">let</span> <span class="n">home</span> <span class="o">=</span> <span class="n">what</span> <span class="o">=</span> <span class="s2">&quot;/&quot;</span> <span class="k">in</span>
       <span class="k">let</span> <span class="n">bytes</span> <span class="o">=</span> <span class="k">match</span> <span class="n">row</span><span class="o">.</span><span class="n">size</span> <span class="k">with</span> <span class="nc">Some</span> <span class="n">n</span> <span class="o">-&gt;</span> <span class="n">n</span> <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="mi">0</span> <span class="k">in</span>
       <span class="k">if</span> <span class="o">!</span><span class="n">lastdate</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="k">then</span> <span class="n">lastdate</span> <span class="o">:=</span> <span class="n">date</span><span class="o">;</span>
       <span class="k">if</span> <span class="o">!</span><span class="n">lastdate</span> <span class="o">&lt;&gt;</span> <span class="n">date</span> <span class="k">then</span> <span class="n">write_report</span> <span class="bp">()</span><span class="o">;</span>
       <span class="n">lastdate</span> <span class="o">:=</span> <span class="n">date</span><span class="o">;</span>
       <span class="n">incr</span> <span class="n">count</span><span class="o">;</span>
       <span class="k">if</span> <span class="n">post</span> <span class="k">then</span> <span class="n">incr</span> <span class="n">posts</span><span class="o">;</span>
       <span class="k">if</span> <span class="n">home</span> <span class="k">then</span> <span class="n">incr</span> <span class="n">homes</span><span class="o">;</span>
       <span class="n">incr_hash</span> <span class="o">!</span><span class="n">hosts</span> <span class="n">host</span> <span class="mi">1</span><span class="o">;</span>
       <span class="n">incr_hash</span> <span class="o">!</span><span class="n">whats</span> <span class="n">what</span> <span class="mi">1</span><span class="o">;</span>
       <span class="n">bytesum</span> <span class="o">:=</span> <span class="nn">Int32</span><span class="p">.</span><span class="n">add</span> <span class="o">!</span><span class="n">bytesum</span> <span class="o">(</span><span class="nn">Int32</span><span class="p">.</span><span class="n">of_int</span> <span class="n">bytes</span><span class="o">))</span>
    <span class="n">log</span><span class="o">;</span>
  <span class="k">if</span> <span class="o">!</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">then</span> <span class="n">write_report</span> <span class="bp">()</span>

<span class="k">let</span> <span class="n">summary</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">lastdate</span> <span class="o">:=</span> <span class="s2">&quot;Grand Total&quot;</span><span class="o">;</span>
  <span class="n">count</span> <span class="o">:=</span> <span class="o">!</span><span class="n">sumcount</span><span class="o">;</span>
  <span class="n">bytesum</span> <span class="o">:=</span> <span class="o">!</span><span class="n">bytesumsum</span><span class="o">;</span>
  <span class="n">hosts</span> <span class="o">:=</span> <span class="o">!</span><span class="n">allhosts</span><span class="o">;</span>
  <span class="n">posts</span> <span class="o">:=</span> <span class="o">!</span><span class="n">allposts</span><span class="o">;</span>
  <span class="n">whats</span> <span class="o">:=</span> <span class="o">!</span><span class="n">allwhats</span><span class="o">;</span>
  <span class="n">homes</span> <span class="o">:=</span> <span class="o">!</span><span class="n">allhomes</span><span class="o">;</span>
  <span class="n">write_report</span> <span class="bp">()</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">daily_logs</span> <span class="bp">()</span><span class="o">;</span>
  <span class="n">summary</span> <span class="bp">()</span><span class="o">;</span>
  <span class="n">exit</span> <span class="mi">0</span>

<span class="c">(*-----------------------------*)</span>

<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* aprept - report on Apache logs *)</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;weblogs&quot;</span><span class="o">;;</span>

<span class="k">open</span> <span class="nc">Weblogs</span>

<span class="k">let</span> <span class="n">file</span> <span class="o">=</span>
  <span class="k">if</span> <span class="nn">Array</span><span class="p">.</span><span class="n">length</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span> <span class="o">=</span> <span class="mi">2</span>
  <span class="k">then</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">1</span><span class="o">)</span>
  <span class="k">else</span> <span class="o">(</span><span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;usage: %s &lt;logfile&gt;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">);</span>
        <span class="n">exit</span> <span class="mi">1</span><span class="o">)</span>

<span class="k">let</span> <span class="n">log</span> <span class="o">=</span> <span class="n">import_file</span> <span class="n">file</span>
<span class="k">let</span> <span class="n">conn</span> <span class="o">=</span> <span class="nn">HostIP</span><span class="p">.</span><span class="n">connection</span> <span class="bp">()</span>

<span class="k">let</span> <span class="n">incr_hash</span> <span class="n">hash</span> <span class="n">key</span> <span class="n">by</span> <span class="o">=</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">replace</span> <span class="n">hash</span> <span class="n">key</span>
    <span class="o">(</span><span class="k">try</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">hash</span> <span class="n">key</span> <span class="o">+</span> <span class="n">by</span>
     <span class="k">with</span> <span class="nc">Not_found</span> <span class="o">-&gt;</span> <span class="n">by</span><span class="o">)</span>

<span class="k">let</span> <span class="n">report_countries</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">total</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">countries</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">row</span> <span class="o">-&gt;</span>
       <span class="k">let</span> <span class="n">country</span> <span class="o">=</span>
         <span class="k">match</span> <span class="nn">HostIP</span><span class="p">.</span><span class="n">get_country_name</span> <span class="n">conn</span> <span class="n">row</span><span class="o">.</span><span class="n">src_ip</span> <span class="k">with</span>
           <span class="o">|</span> <span class="nc">Some</span> <span class="n">country</span> <span class="o">-&gt;</span> <span class="n">country</span>
           <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="s2">&quot;UNKNOWN&quot;</span> <span class="k">in</span>
       <span class="n">incr_hash</span> <span class="n">countries</span> <span class="n">country</span> <span class="mi">1</span><span class="o">;</span>
       <span class="n">incr</span> <span class="n">total</span><span class="o">)</span>
    <span class="n">log</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">country_records</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">country</span> <span class="n">count</span> <span class="o">-&gt;</span>
       <span class="n">country_records</span> <span class="o">:=</span> <span class="o">(</span><span class="n">count</span><span class="o">,</span> <span class="n">country</span><span class="o">)</span> <span class="o">::</span> <span class="o">!</span><span class="n">country_records</span><span class="o">)</span>
    <span class="n">countries</span><span class="o">;</span>
  <span class="n">print_endline</span> <span class="s2">&quot;Domain                  Records&quot;</span><span class="o">;</span>
  <span class="n">print_endline</span> <span class="s2">&quot;===============================&quot;</span><span class="o">;</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">count</span><span class="o">,</span> <span class="n">country</span><span class="o">)</span> <span class="o">-&gt;</span>
       <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%18s %5d %5.2f%%</span><span class="se">\n</span><span class="s2">%!&quot;</span>
         <span class="n">country</span> <span class="n">count</span> <span class="o">(</span><span class="kt">float</span> <span class="n">count</span> <span class="o">*.</span> <span class="mi">100</span><span class="o">.</span> <span class="o">/.</span> <span class="kt">float</span> <span class="o">!</span><span class="n">total</span><span class="o">))</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">rev</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">sort</span> <span class="n">compare</span> <span class="o">!</span><span class="n">country_records</span><span class="o">))</span>

<span class="k">let</span> <span class="n">report_files</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="k">let</span> <span class="n">total</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">totalbytes</span> <span class="o">=</span> <span class="n">ref</span> <span class="mi">0</span><span class="n">l</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">bytes</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="k">let</span> <span class="n">records</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span> <span class="k">in</span>
  <span class="nn">Array</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">row</span> <span class="o">-&gt;</span>
       <span class="k">let</span> <span class="n">file</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">url</span> <span class="k">in</span>
       <span class="k">let</span> <span class="n">size</span> <span class="o">=</span> <span class="k">match</span> <span class="n">row</span><span class="o">.</span><span class="n">size</span> <span class="k">with</span> <span class="nc">Some</span> <span class="n">n</span> <span class="o">-&gt;</span> <span class="n">n</span> <span class="o">|</span> <span class="nc">None</span> <span class="o">-&gt;</span> <span class="mi">0</span> <span class="k">in</span>
       <span class="n">incr_hash</span> <span class="n">bytes</span> <span class="n">file</span> <span class="n">size</span><span class="o">;</span>
       <span class="n">incr_hash</span> <span class="n">records</span> <span class="n">file</span> <span class="mi">1</span><span class="o">;</span>
       <span class="n">totalbytes</span> <span class="o">:=</span> <span class="nn">Int32</span><span class="p">.</span><span class="n">add</span> <span class="o">!</span><span class="n">totalbytes</span> <span class="o">(</span><span class="nn">Int32</span><span class="p">.</span><span class="n">of_int</span> <span class="n">size</span><span class="o">);</span>
       <span class="n">incr</span> <span class="n">total</span><span class="o">)</span>
    <span class="n">log</span><span class="o">;</span>
  <span class="k">let</span> <span class="n">file_records</span> <span class="o">=</span> <span class="n">ref</span> <span class="bp">[]</span> <span class="k">in</span>
  <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">file</span> <span class="n">size</span> <span class="o">-&gt;</span>
       <span class="k">let</span> <span class="n">count</span> <span class="o">=</span> <span class="nn">Hashtbl</span><span class="p">.</span><span class="n">find</span> <span class="n">records</span> <span class="n">file</span> <span class="k">in</span>
       <span class="n">file_records</span> <span class="o">:=</span> <span class="o">(</span><span class="n">file</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="n">count</span><span class="o">)</span> <span class="o">::</span> <span class="o">!</span><span class="n">file_records</span><span class="o">)</span>
    <span class="n">bytes</span><span class="o">;</span>
  <span class="n">print_endline</span>
    <span class="s2">&quot;File                               Bytes          Records&quot;</span><span class="o">;</span>
  <span class="n">print_endline</span>
    <span class="s2">&quot;=========================================================&quot;</span><span class="o">;</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="o">(</span><span class="n">file</span><span class="o">,</span> <span class="n">size</span><span class="o">,</span> <span class="n">count</span><span class="o">)</span> <span class="o">-&gt;</span>
       <span class="nn">Printf</span><span class="p">.</span><span class="n">printf</span> <span class="s2">&quot;%-22s %10d %5.2f%% %9d %5.2f%%</span><span class="se">\n</span><span class="s2">%!&quot;</span>
         <span class="n">file</span> <span class="n">size</span>
         <span class="o">(</span><span class="kt">float</span> <span class="n">size</span> <span class="o">*.</span> <span class="mi">100</span><span class="o">.</span> <span class="o">/.</span> <span class="nn">Int32</span><span class="p">.</span><span class="n">to_float</span> <span class="o">!</span><span class="n">totalbytes</span><span class="o">)</span>
         <span class="n">count</span>
         <span class="o">(</span><span class="kt">float</span> <span class="n">count</span> <span class="o">*.</span> <span class="mi">100</span><span class="o">.</span> <span class="o">/.</span> <span class="kt">float</span> <span class="o">!</span><span class="n">total</span><span class="o">))</span>
    <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">sort</span> <span class="n">compare</span> <span class="o">!</span><span class="n">file_records</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="n">report_countries</span> <span class="bp">()</span><span class="o">;</span>
  <span class="n">print_newline</span> <span class="bp">()</span><span class="o">;</span>
  <span class="n">report_files</span> <span class="bp">()</span>

<span class="c">(* @@PLEAC@@_20.14 *)</span>
<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* htmlsub - make substitutions in normal text of HTML files *)</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;str&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netstring&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">usage</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Usage: %s &lt;from&gt; &lt;to&gt; &lt;file&gt;...</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">);</span>
  <span class="n">exit</span> <span class="mi">1</span>

<span class="k">let</span> <span class="n">from</span><span class="o">,</span> <span class="k">to&#39;</span><span class="o">,</span> <span class="n">files</span> <span class="o">=</span>
  <span class="k">match</span> <span class="nn">List</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">)</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">from</span> <span class="o">::</span> <span class="k">to&#39;</span> <span class="o">::</span> <span class="n">files</span> <span class="o">-&gt;</span> <span class="n">from</span><span class="o">,</span> <span class="k">to&#39;</span><span class="o">,</span> <span class="n">files</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">usage</span> <span class="bp">()</span>

<span class="k">let</span> <span class="k">rec</span> <span class="n">map_data</span> <span class="n">f</span> <span class="o">=</span> <span class="k">function</span>
  <span class="o">|</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="n">data</span> <span class="o">-&gt;</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="o">(</span><span class="n">f</span> <span class="n">data</span><span class="o">)</span>
  <span class="o">|</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span> <span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">attribs</span><span class="o">,</span> <span class="n">children</span><span class="o">)</span> <span class="o">-&gt;</span>
      <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span> <span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">attribs</span><span class="o">,</span> <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="n">map_data</span> <span class="n">f</span><span class="o">)</span> <span class="n">children</span><span class="o">)</span>

<span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp_string</span> <span class="n">from</span>
<span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span>
<span class="k">let</span> <span class="n">out_channel</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">output_buffer</span> <span class="n">buffer</span>
<span class="k">let</span> <span class="n">write</span> <span class="n">html</span> <span class="o">=</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="n">write</span> <span class="n">out_channel</span> <span class="o">(</span><span class="nn">Nethtml</span><span class="p">.</span><span class="n">encode</span> <span class="n">html</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">file</span> <span class="o">-&gt;</span>
       <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">input_channel</span> <span class="o">(</span><span class="n">open_in</span> <span class="n">file</span><span class="o">)</span> <span class="k">in</span>
       <span class="k">let</span> <span class="n">html</span> <span class="o">=</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="n">decode</span> <span class="o">(</span><span class="nn">Nethtml</span><span class="p">.</span><span class="n">parse</span> <span class="n">in_channel</span><span class="o">)</span> <span class="k">in</span>
       <span class="n">in_channel</span><span class="o">#</span><span class="n">close_in</span> <span class="bp">()</span><span class="o">;</span>
       <span class="n">write</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="n">map_data</span> <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">global_replace</span> <span class="n">regexp</span> <span class="k">to&#39;</span><span class="o">))</span> <span class="n">html</span><span class="o">))</span>
    <span class="n">files</span><span class="o">;</span>
  <span class="n">print_endline</span> <span class="o">(</span><span class="nn">Buffer</span><span class="p">.</span><span class="n">contents</span> <span class="n">buffer</span><span class="o">)</span>

<span class="c">(* @@PLEAC@@_20.15 *)</span>
<span class="o">#!/</span><span class="n">usr</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">ocaml</span>
<span class="c">(* hrefsub - make substitutions in &lt;A HREF=&quot;...&quot;&gt; fields of HTML files *)</span>

<span class="o">#</span><span class="n">use</span> <span class="s2">&quot;topfind&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;str&quot;</span><span class="o">;;</span>
<span class="o">#</span><span class="n">require</span> <span class="s2">&quot;netstring&quot;</span><span class="o">;;</span>

<span class="k">let</span> <span class="n">usage</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">Printf</span><span class="p">.</span><span class="n">eprintf</span> <span class="s2">&quot;Usage: %s &lt;from&gt; &lt;to&gt; &lt;file&gt;...</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">.(</span><span class="mi">0</span><span class="o">);</span>
  <span class="n">exit</span> <span class="mi">1</span>

<span class="k">let</span> <span class="n">from</span><span class="o">,</span> <span class="k">to&#39;</span><span class="o">,</span> <span class="n">files</span> <span class="o">=</span>
  <span class="k">match</span> <span class="nn">List</span><span class="p">.</span><span class="n">tl</span> <span class="o">(</span><span class="nn">Array</span><span class="p">.</span><span class="n">to_list</span> <span class="nn">Sys</span><span class="p">.</span><span class="n">argv</span><span class="o">)</span> <span class="k">with</span>
    <span class="o">|</span> <span class="n">from</span> <span class="o">::</span> <span class="k">to&#39;</span> <span class="o">::</span> <span class="n">files</span> <span class="o">-&gt;</span> <span class="n">from</span><span class="o">,</span> <span class="k">to&#39;</span><span class="o">,</span> <span class="n">files</span>
    <span class="o">|</span> <span class="o">_</span> <span class="o">-&gt;</span> <span class="n">usage</span> <span class="bp">()</span>

<span class="k">let</span> <span class="k">rec</span> <span class="n">map_attr</span> <span class="n">tag</span> <span class="n">attr</span> <span class="n">f</span> <span class="o">=</span> <span class="k">function</span>
  <span class="o">|</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Data</span> <span class="o">_</span> <span class="k">as</span> <span class="n">d</span> <span class="o">-&gt;</span> <span class="n">d</span>
  <span class="o">|</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span> <span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">attribs</span><span class="o">,</span> <span class="n">children</span><span class="o">)</span>
      <span class="k">when</span> <span class="n">tag</span> <span class="o">=</span> <span class="n">name</span> <span class="o">&amp;&amp;</span> <span class="nn">List</span><span class="p">.</span><span class="n">mem_assoc</span> <span class="n">attr</span> <span class="n">attribs</span> <span class="o">-&gt;</span>
      <span class="k">let</span> <span class="k">value</span> <span class="o">=</span> <span class="nn">List</span><span class="p">.</span><span class="n">assoc</span> <span class="n">attr</span> <span class="n">attribs</span> <span class="k">in</span>
      <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span> <span class="o">(</span><span class="n">name</span><span class="o">,</span>
                       <span class="o">(</span><span class="n">attr</span><span class="o">,</span> <span class="n">f</span> <span class="k">value</span><span class="o">)</span>
                       <span class="o">::</span> <span class="nn">List</span><span class="p">.</span><span class="n">remove_assoc</span> <span class="n">attr</span> <span class="n">attribs</span><span class="o">,</span>
                       <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="n">map_attr</span> <span class="n">tag</span> <span class="n">attr</span> <span class="n">f</span><span class="o">)</span> <span class="n">children</span><span class="o">)</span>
  <span class="o">|</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span> <span class="o">(</span><span class="n">name</span><span class="o">,</span> <span class="n">attribs</span><span class="o">,</span> <span class="n">children</span><span class="o">)</span> <span class="o">-&gt;</span>
      <span class="nn">Nethtml</span><span class="p">.</span><span class="nc">Element</span> <span class="o">(</span><span class="n">name</span><span class="o">,</span>
                       <span class="n">attribs</span><span class="o">,</span>
                       <span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="n">map_attr</span> <span class="n">tag</span> <span class="n">attr</span> <span class="n">f</span><span class="o">)</span> <span class="n">children</span><span class="o">)</span>

<span class="k">let</span> <span class="n">regexp</span> <span class="o">=</span> <span class="nn">Str</span><span class="p">.</span><span class="n">regexp_string</span> <span class="n">from</span>
<span class="k">let</span> <span class="n">buffer</span> <span class="o">=</span> <span class="nn">Buffer</span><span class="p">.</span><span class="n">create</span> <span class="mi">0</span>
<span class="k">let</span> <span class="n">out_channel</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">output_buffer</span> <span class="n">buffer</span>
<span class="k">let</span> <span class="n">write</span> <span class="n">html</span> <span class="o">=</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="n">write</span> <span class="n">out_channel</span> <span class="o">(</span><span class="nn">Nethtml</span><span class="p">.</span><span class="n">encode</span> <span class="n">html</span><span class="o">)</span>

<span class="k">let</span> <span class="bp">()</span> <span class="o">=</span>
  <span class="nn">List</span><span class="p">.</span><span class="n">iter</span>
    <span class="o">(</span><span class="k">fun</span> <span class="n">file</span> <span class="o">-&gt;</span>
       <span class="k">let</span> <span class="n">in_channel</span> <span class="o">=</span> <span class="k">new</span> <span class="nn">Netchannels</span><span class="p">.</span><span class="n">input_channel</span> <span class="o">(</span><span class="n">open_in</span> <span class="n">file</span><span class="o">)</span> <span class="k">in</span>
       <span class="k">let</span> <span class="n">html</span> <span class="o">=</span> <span class="nn">Nethtml</span><span class="p">.</span><span class="n">decode</span> <span class="o">(</span><span class="nn">Nethtml</span><span class="p">.</span><span class="n">parse</span> <span class="n">in_channel</span><span class="o">)</span> <span class="k">in</span>
       <span class="n">in_channel</span><span class="o">#</span><span class="n">close_in</span> <span class="bp">()</span><span class="o">;</span>
       <span class="n">write</span> <span class="o">(</span><span class="nn">List</span><span class="p">.</span><span class="n">map</span> <span class="o">(</span><span class="n">map_attr</span> <span class="s2">&quot;a&quot;</span> <span class="s2">&quot;href&quot;</span>
                          <span class="o">(</span><span class="nn">Str</span><span class="p">.</span><span class="n">global_replace</span> <span class="n">regexp</span> <span class="k">to&#39;</span><span class="o">))</span> <span class="n">html</span><span class="o">))</span>
    <span class="n">files</span><span class="o">;</span>
  <span class="n">print_endline</span> <span class="o">(</span><span class="nn">Buffer</span><span class="p">.</span><span class="n">contents</span> <span class="n">buffer</span><span class="o">)</span>
</pre></div>
</body>
</html>

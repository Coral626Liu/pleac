<!DOCTYPE html PUBLIC "-//IETF//DTD HTML 2.0//EN">
<HTML>
<HEAD>
<TITLE>Enscript Output</TITLE>
</HEAD>
<BODY BGCOLOR="#FFFFFF" TEXT="#000000" LINK="#1F00FF" ALINK="#FF0000" VLINK="#9900DD">
<A NAME="top">
<A NAME="file1">
<H1>tmp.data</H1>

<PRE>
<I><FONT COLOR="#B22222">; -*- asm -*-

</FONT></I><I><FONT COLOR="#B22222">; @@PLEAC@@_NAME
Nasm
</FONT></I>
<I><FONT COLOR="#B22222">; @@PLEAC@@_WEB
http://nasm.sourceforge.net/
</FONT></I>

<I><FONT COLOR="#B22222">; @@PLEAC@@_1.0
; strlen (C calling convention)
</FONT></I><I><FONT COLOR="#B22222">;   input:
;     s  : pointer to const ASCIIZ string (address at esp+4).
</FONT></I><I><FONT COLOR="#B22222">;   algo:
;     use formulae &quot;(x-1) &amp; ~x = 2^first_bit(x) - 1&quot; found in glibc code
</FONT></I><I><FONT COLOR="#B22222">;     but used differently. 0xfefefeff allow decrementing all byte of
;     a dword, the first null byte disable carry so the string must be
</FONT></I><I><FONT COLOR="#B22222">;     checked in little endian only.
strlen:
</FONT></I>	<B><FONT COLOR="#A020F0">mov</FONT></B> eax,[esp+4]		<I><FONT COLOR="#B22222">; get s value
.align:	cmp byte [eax],0	; realign pointer on dword boundaries
</FONT></I>	<B><FONT COLOR="#A020F0">jz</FONT></B> .end
	<B><FONT COLOR="#A020F0">inc</FONT></B> eax
	<B><FONT COLOR="#A020F0">test</FONT></B> al,3
	<B><FONT COLOR="#A020F0">jnz</FONT></B> .align
<B><FONT COLOR="#0000FF">.loop:</FONT></B>	mov edx,[eax]		<I><FONT COLOR="#B22222">; test 4 bytes at one time
	lea ecx,[edx+0xfefefeff]
</FONT></I>	<B><FONT COLOR="#A020F0">not</FONT></B> edx
	<B><FONT COLOR="#A020F0">and</FONT></B> edx,ecx
	<B><FONT COLOR="#A020F0">add</FONT></B> eax,byte 4
	<B><FONT COLOR="#A020F0">test</FONT></B> edx,0x80808080	<I><FONT COLOR="#B22222">; if one of the byte is null
	jz .loop
</FONT></I><B><FONT COLOR="#0000FF">.final:</FONT></B>	shr edx,8		<I><FONT COLOR="#B22222">; check first lo byte
	inc eax
</FONT></I>	<B><FONT COLOR="#A020F0">jnc</FONT></B> .final
	<B><FONT COLOR="#A020F0">sub</FONT></B> eax, byte 5		<I><FONT COLOR="#B22222">; realign pointer to null char
.end:	sub eax,[esp+4]
</FONT></I>	<B><FONT COLOR="#A020F0">ret
</FONT></B>

<I><FONT COLOR="#B22222">; strcpy (C calling convention)
;   input:
</FONT></I><I><FONT COLOR="#B22222">;     dest : pointer to destination ASCIIZ string (address at esp+4).
;     src  : pointer to source ASCIIZ string (address at esp+8).
</FONT></I><I><FONT COLOR="#B22222">;   algo:
;     see strlen above for algorithm.
</FONT></I><B><FONT COLOR="#0000FF">strcpy:</FONT></B>
	<B><FONT COLOR="#A020F0">mov</FONT></B> ecx,[esp+8]			<I><FONT COLOR="#B22222">; get src
	mov edx,[esp+4]			; get dest
</FONT></I><B><FONT COLOR="#0000FF">.align:</FONT></B>	mov al,[ecx]
	<B><FONT COLOR="#A020F0">inc</FONT></B> ecx
	<B><FONT COLOR="#A020F0">mov</FONT></B> [edx],al			<I><FONT COLOR="#B22222">; copy one byte to align source ptr
	inc edx
</FONT></I>	<B><FONT COLOR="#A020F0">test</FONT></B> al,al
	<B><FONT COLOR="#A020F0">jz</FONT></B> .ret
	<B><FONT COLOR="#A020F0">test</FONT></B> cl,3
	<B><FONT COLOR="#A020F0">jnz</FONT></B> .align
	<B><FONT COLOR="#A020F0">mov</FONT></B> [esp+8],ebx			<I><FONT COLOR="#B22222">; ok save ebx as it may be used by gcc
	jmp short .start		; start is inside the loop.
</FONT></I><B><FONT COLOR="#0000FF">.loop:</FONT></B>	mov [edx],ebx
	<B><FONT COLOR="#A020F0">add</FONT></B> edx,byte 4
<B><FONT COLOR="#0000FF">.start:</FONT></B>	mov eax,[ecx]			<I><FONT COLOR="#B22222">; get dword and search for a null byte
	lea ebx,[eax+0xfefefeff]
</FONT></I>	<B><FONT COLOR="#A020F0">not</FONT></B> eax
	<B><FONT COLOR="#A020F0">and</FONT></B> eax,ebx
	<B><FONT COLOR="#A020F0">sub</FONT></B> ebx,0xfefefeff		<I><FONT COLOR="#B22222">; restore ebx to dword read
	add ecx,byte 4
</FONT></I>	<B><FONT COLOR="#A020F0">test</FONT></B> eax,0x80808080		<I><FONT COLOR="#B22222">; one of the byte is null?
	jz .loop
</FONT></I><B><FONT COLOR="#0000FF">.final:</FONT></B>	mov [edx],bl			<I><FONT COLOR="#B22222">; search thorugh ebx itself
	ror ebx,8			; slow but compact
</FONT></I>	<B><FONT COLOR="#A020F0">inc</FONT></B> edx
	<B><FONT COLOR="#A020F0">test</FONT></B> ebx,0xff000000
	<B><FONT COLOR="#A020F0">jnz</FONT></B> .final
	<B><FONT COLOR="#A020F0">mov</FONT></B> ebx,[esp+8]			<I><FONT COLOR="#B22222">; restore ebx value
.ret:	mov eax,[esp+4]			; strcpy should return dest
</FONT></I>	<B><FONT COLOR="#A020F0">ret
</FONT></B>
</PRE>
<HR>
<ADDRESS>Generated by <A HREF="http://www.iki.fi/~mtr/genscript/">GNU Enscript 1.6.5.90</A>.</ADDRESS>
</BODY>
</HTML>
